<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MURAIN â€” å‡ºè²¨å–®åˆ—å° (v3)</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 1rem; background-color: #f9f9f9; }
        .controls { max-width: 600px; margin: 1rem auto; background: #fff; border-radius: 8px; padding: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        button { font-size: 1.1rem; padding: 12px 20px; border: none; background-color: #007aff; color: white; border-radius: 8px; cursor: pointer; width: 100%; }
        button:disabled { background-color: #ccc; }
        #status { margin-top: 1rem; font-weight: bold; }
        
        /* --- ç†±æ„Ÿæ‡‰æ¨™ç±¤æ¨£å¼ (Q6) --- */
        #labels-container { margin-top: 2rem; }
        .label {
            width: 10cm; /* ç†±æ„Ÿæ‡‰æ¨™ç±¤å¯¬åº¦ */
            height: 15cm; /* ç†±æ„Ÿæ‡‰æ¨™ç±¤é«˜åº¦ */
            border: 1px dashed #999;
            background: #fff;
            padding: 10px;
            box-sizing: border-box;
            margin: 1rem auto;
            page-break-after: always; /* åˆ—å°æ™‚è‡ªå‹•åˆ†é  */
            overflow: hidden;
        }
        .label h3 { margin-top: 0; border-bottom: 2px solid #000; padding-bottom: 5px; }
        .label .section { margin-bottom: 10px; }
        .label .section strong { font-size: 1.2rem; display: block; }
        .label .section span { font-size: 1.1rem; }
        .label .gift-notes { border-top: 1px solid #ccc; padding-top: 10px; margin-top: 10px; background: #fdfdea; }
        
        /* åˆ—å°æ™‚ï¼Œåªé¡¯ç¤ºæ¨™ç±¤ */
        @media print {
            body { margin: 0; background-color: #fff; }
            .controls { display: none; }
            #labels-container { margin: 0; }
            .label { border: none; margin: 0; page-break-after: always; }
        }
    </style>
</head>
<body>
    <div class="controls">
        <h2>å‡ºè²¨å–®åˆ—å° (Q6)</h2>
        <div class="form-group">
            <label for="op_key">ä¸»æ’­å¯†ç¢¼ (OP Key)</label>
            <input type="password" id="op_key" placeholder="è«‹è¼¸å…¥å¯†ç¢¼ä»¥è¼‰å…¥è¨‚å–®">
        </div>
        <button id="loadBtn">è¼‰å…¥å¾…å‡ºè²¨è¨‚å–®</button>
        <p id="status"></p>
    </div>

    <div id="labels-container">
        </div>

    <script>
        const API_ENDPOINT = 'https://murain-api.smile650170703.workers.dev';

        document.getElementById('loadBtn').addEventListener('click', async () => {
            const btn = document.getElementById('loadBtn');
            const status = document.getElementById('status');
            const op_key = document.getElementById('op_key').value;
            const container = document.getElementById('labels-container');
            
            if (!op_key) {
                status.textContent = 'è«‹è¼¸å…¥ä¸»æ’­å¯†ç¢¼';
                status.style.color = 'red';
                return;
            }

            btn.disabled = true;
            status.textContent = 'è¼‰å…¥ä¸­...';
            container.innerHTML = ''; // æ¸…ç©º

            try {
                // å‘¼å« v3 æ–°å¢çš„ /admin/print-labels API
                const res = await fetch(`${API_ENDPOINT}/admin/print-labels`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ op_key: op_key })
                });
                
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                if (!data.orders || data.orders.length === 0) {
                    status.textContent = 'æ²’æœ‰æ‰¾åˆ°å¾…å‡ºè²¨çš„è¨‚å–®ã€‚';
                    status.style.color = 'green';
                    return;
                }
                
                status.textContent = `è¼‰å…¥æˆåŠŸï¼å…± ${data.orders.length} ç­†è¨‚å–®ã€‚`;
                status.style.color = 'green';
                
                // å°‡è¨‚å–®è³‡æ–™å‹•æ…‹ç”¢ç”Ÿ HTML æ¨™ç±¤
                data.orders.forEach(order => {
                    let shipping = {};
                    try {
                        shipping = JSON.parse(order.shipping_info || '{}');
                    } catch(e) {}
                    
                    const label = document.createElement('div');
                    label.className = 'label';
                    
                    // (v3) é¡¯ç¤ºè¨‚å–®ç‹€æ…‹ (å¾…å‡ºè²¨/å¾…ä»˜è¨‚é‡‘)
                    let statusText = 'ä¸æ˜';
                    if (order.status === 'paid') statusText = 'âœ… å·²ä»˜æ¬¾ (éƒµå¯„)';
                    if (order.status === 'awaiting_cod_shipment') statusText = 'ğŸ“¦ 7-11 è²¨åˆ°ä»˜æ¬¾';
                    if (order.status === 'awaiting_deposit_proof') statusText = 'âš ï¸ å¾…ä»˜è¨‚é‡‘ (è«‹å‹¿å‡ºè²¨)';

                    label.innerHTML = `
                        <h3>è¨‚å–®ï¼š${order.order_id}</h3>
                        <div class="section">
                            <strong>ç‹€æ…‹ï¼š${statusText}</strong>
                        </div>
                        <div class="section">
                            <strong>æ”¶ä»¶äººï¼š</strong>
                            <span>${shipping.name || 'N/A'} (${shipping.phone || 'N/A'})</span>
                        </div>
                        <div class="section">
                            <strong>å¯„é€ï¼š(${order.payment_method || 'N/A'})</strong>
                            <span>${shipping.store_name || ''}</span>
                            <span>${shipping.store_address || shipping.address || 'N/A'}</span>
                        </div>
                        <div class="section gift-notes">
                            <strong>ä¸»æ’­å‚™è¨» (Q3)ï¼š</strong>
                            <span>${order.gift_notes || '(ç„¡)'}</span>
                        </div>
                        <div class="section">
                            <strong>ç™¼ç¥¨ (Q-ECPay)ï¼š</strong>
                            <span>${order.invoice_status || 'N/A'}: ${order.invoice_no || ''}</span>
                        </div>
                    `;
                    container.appendChild(label);
                });

            } catch (err) {
                console.error('è¼‰å…¥è¨‚å–®å¤±æ•—:', err);
                status.textContent = `è¼‰å…¥å¤±æ•—: ${err.message}`;
                status.style.color = 'red';
            } finally {
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>