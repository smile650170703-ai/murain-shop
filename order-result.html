<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MURAIN — 訂單結果 (v6.1)</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 2rem auto; max-width: 600px; padding: 1rem; background-color: #f9f9f9; text-align: center; }
        .container { background: #fff; border-radius: 8px; padding: 2rem; }
        h1 { color: #28a745; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container" id="result-container">
        </div>

    <script>
  // ===== 設定（測試用） =====
  const API_ENDPOINT = 'https://murain-api.smile650170703.workers.dev';

  const urlParams = new URLSearchParams(window.location.search);
  const container = document.getElementById('result-container');

  // 讀取 url 參數（order_id, cart_token, status, Status 等金流常見欄位）
  const qOrderId = urlParams.get('order_id') || urlParams.get('MerTradeNo') || urlParams.get('TradeNo') || null;
  const qCartToken = urlParams.get('cart_token') || urlParams.get('TradeNo') || null;
  const qStatus = urlParams.get('status') || urlParams.get('Status') || null;

  // 用來 call 後端 admin/dashboard（取得 orders list），比較 order_id
  async function fetchOrderFromAdmin(order_id) {
    try {
      const body = { op_key: OP_KEY };
      const res = await fetch(`${API_ENDPOINT}/admin/dashboard`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!data.ok || !Array.isArray(data.orders)) return null;
      return data.orders.find(o => String(o.order_id) === String(order_id)) || null;
    } catch (e) {
      console.warn('[fetchOrderFromAdmin] error', e);
      return null;
    }
  }

  // 如果我們只有 cart_token，嘗試用 /cart/{token} 直接抓
  async function fetchOrderByCartToken(cart_token) {
    try {
      const res = await fetch(`${API_ENDPOINT}/cart/${encodeURIComponent(cart_token)}`);
      if (!res.ok) return null;
      const data = await res.json();
      return { order_id: data.order_id, status: data.status, total_amount: data.total_amount, items: data.items || [] };
    } catch (e) {
      console.warn('[fetchOrderByCartToken] error', e);
      return null;
    }
  }

  // render 主流程
  (async function showResult() {
    // 1) 先嘗試由 URL 直接顯示最基本狀態（若有）
    if (qStatus === 'SUCCESS' || qStatus === 'SUCCESS' || qStatus === 'PAID' || qStatus === 'awaiting_shipping_info') {
      // 金流直接成功或我們已知狀態為已付款
      container.innerHTML = `
        <h1>🎉 付款成功</h1>
        <p>訂單編號：<strong>${qOrderId || 'N/A'}</strong></p>
        <p>請點此前往填寫物流：</p>
        <p><a id="shipping-link" href="#">前往填寫物流資訊</a></p>
      `;
      document.getElementById('shipping-link').href = `shipping.html?cart_token=${encodeURIComponent(qCartToken || '')}&method=PAID`;
      return;
    }

    // 2) 嘗試以 cart_token 取得 order (若有 cart_token)
    let order = null;
    if (qCartToken) {
      order = await fetchOrderByCartToken(qCartToken);
    }

    // 3) 若沒有 order 或沒有 order_id，嘗試用 order_id 呼叫 admin/dashboard 搜尋
    if ((!order || !order.order_id) && qOrderId) {
      const adminOrder = await fetchOrderFromAdmin(qOrderId);
      if (adminOrder) {
        // 可能 adminOrder 包含 cart_token（或沒有），我們先組一個簡單物件
        order = {
          order_id: adminOrder.order_id,
          status: adminOrder.status,
          total_amount: adminOrder.total_amount,
          streamer_name: adminOrder.streamer_name || '',
          cart_token: adminOrder.cart_token || qCartToken || ''
        };
      }
    }

    // 4) 最終顯示（如果拿不到任何 order）
    if (!order) {
      container.innerHTML = `
        <h1 class="error">查詢結果</h1>
        <p>訂單編號：<strong>${qOrderId || 'N/A'}</strong></p>
        <p>狀態：<strong>${qStatus || '未知'}</strong></p>
        <p>※ 若需要進一步查詢，請回到結帳頁或提供訂單編號給客服。</p>
        <p><a href="checkout.html?cart_token=${encodeURIComponent(qCartToken || '')}">回到結帳頁</a></p>
      `;
      return;
    }

    // 5) 有 order 的情況：根據 order.status 顯示不同畫面，並提供前往填寫物流連結（優先用 cart_token）
    const cartTokenToUse = order.cart_token || qCartToken || '';
    const st = (order.status || 'unknown').toLowerCase();

    if (st === 'awaiting_cod_shipment' || st === 'awaiting_deposit_proof') {
      container.innerHTML = `
        <h1>👍 訂單已確認</h1>
        <p>訂單編號：<strong>${order.order_id}</strong></p>
        <p>狀態：${order.status}</p>
        <p>若要填寫物流請點：</p>
        <p><a href="shipping.html?cart_token=${encodeURIComponent(cartTokenToUse)}&method=COD">前往填寫物流 (貨到付款 / 訂金)</a></p>
      `;
      return;
    } else if (st === 'paid' || st === 'awaiting_shipping_info' || qStatus === 'SUCCESS') {
      container.innerHTML = `
        <h1>🎉 付款成功</h1>
        <p>訂單編號：<strong>${order.order_id}</strong></p>
        <p>總金額：${order.total_amount || 'N/A'}</p>
        <p><a href="shipping.html?cart_token=${encodeURIComponent(cartTokenToUse)}&method=PAID">前往填寫物流 (已付款)</a></p>
      `;
      return;
    } else {
      container.innerHTML = `
        <h1>查詢結果</h1>
        <p>訂單編號：<strong>${order.order_id}</strong></p>
        <p>狀態：<strong>${order.status}</strong></p>
        <p>如需協助請聯絡客服，或回到 <a href="checkout.html?cart_token=${encodeURIComponent(cartTokenToUse)}">結帳頁</a></p>
      `;
      return;
    }

  })();
</script>

</body>
</html> 

