<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MURAIN — 訂單結果</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Arial;margin:0;background:#fafafa;color:#222}
    .wrap{max-width:900px;margin:32px auto;padding:20px}
    .card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
    h1{margin:0 0 8px}
    .muted{color:#666;font-size:14px}
    .summary{margin-top:14px}
    .row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f0f0f0}
    .status-paid{color:green;font-weight:700}
    .status-await{color:orange;font-weight:700}
    .debug{margin-top:12px;padding:10px;background:#fafafa;border-radius:8px;font-family:monospace;white-space:pre-wrap;font-size:13px}
    .btn{display:inline-block;padding:10px 14px;border-radius:8px;border:1px solid #e6e6e6;background:#fff;color:#333;text-decoration:none;margin-top:12px}
  </style>
</head>
<body>
  <main class="wrap">
    <div class="card">
      <h1>訂單結果</h1>
      <div class="muted">此頁會顯示付款後的訂單狀態。建議你的金流 ReturnURL 包含 <code>?cart_token=...</code>（或若無，請透過客服提供訂單編號）。</div>

      <div id="content" class="summary">
        <div id="statusLine" class="row"><div>讀取中…</div><div></div></div>
        <div id="itemsArea"></div>
        <div id="totalRow" class="row"><div>合計</div><div id="total">NT$ 0</div></div>
        <div id="help" style="margin-top:10px" class="muted">如果此頁沒有顯示訂單，請確認你的 ReturnURL 是否包含 cart_token，或聯絡客服。</div>
        <a id="backBtn" class="btn" href="/">回到商店首頁</a>
      </div>

      <div id="debug" class="debug" style="display:none"></div>
    </div>
  </main>

<script>
(async function(){
  const API_BASE = ''; // relative
  const qs = new URLSearchParams(location.search);
  const cartToken = qs.get('cart_token') || qs.get('token') || null;
  const orderId = qs.get('order_id') || qs.get('MerTradeNo') || null;

  function fmt(n){ return 'NT$ ' + Number(n||0).toLocaleString(); }
  function showDebug(o){ const d = document.getElementById('debug'); d.style.display='block'; d.textContent = (typeof o === 'string' ? o : JSON.stringify(o, null,2)); }

  async function apiFetch(path, opts={}) {
    const url = (path.startsWith('http') ? path : (API_BASE + path));
    try {
      const res = await fetch(url, opts);
      const text = await res.text();
      try { return { ok: res.ok, status: res.status, data: text ? JSON.parse(text) : {} }; }
      catch(e) {
        try { return { ok: res.ok, status: res.status, data: Object.fromEntries(new URLSearchParams(text)) }; } catch(_) { return { ok: res.ok, status: res.status, data: text }; }
      }
    } catch(e) { return { ok:false, error: e.message }; }
  }

  const statusLine = document.getElementById('statusLine');
  const itemsArea = document.getElementById('itemsArea');
  const totalEl = document.getElementById('total');

  if (!cartToken && !orderId) {
    statusLine.innerHTML = '<div>找不到 cart_token 或 order_id</div><div></div>';
    showDebug('請讓你的金流回傳 ReturnURL 包含 ?cart_token=<token> 或訪問此頁並帶 ?cart_token=<token>');
    return;
  }

  if (cartToken) {
    statusLine.innerHTML = '<div>使用 cart_token 讀取訂單</div><div></div>';
    const r = await apiFetch(`/cart/${encodeURIComponent(cartToken)}`, { method: 'GET' });
    if (!r.ok) {
      statusLine.innerHTML = `<div>讀取失敗（HTTP ${r.status || '??'}）</div><div></div>`;
      showDebug(r.data || r.error || r);
      return;
    }
    const payload = r.data;
    const items = Array.isArray(payload.items) ? payload.items : (payload.items ? Object.values(payload.items) : []);
    itemsArea.innerHTML = '';
    for (const it of (items || [])) {
      const div = document.createElement('div');
      div.className = 'row';
      div.innerHTML = `<div>${it.name || it.sku || '商品' } x ${it.qty}</div><div>${fmt(it.subtotal || (it.qty*(it.unit_price_final||it.unit_price_base||0)))}</div>`;
      itemsArea.appendChild(div);
    }
    totalEl.textContent = fmt(payload.total_amount || 0);
    const st = (payload.status || '').toLowerCase();
    const statusText = (st.includes('paid') || st.includes('awaiting_shipping_info') || st.includes('awaiting_payment')) ?
        (st.includes('paid') ? '<span class="status-paid">已付款</span>' : '<span class="status-await">等待付款/待出貨</span>')
        : `<span>${payload.status}</span>`;
    statusLine.innerHTML = `<div>訂單 ${payload.order_id}</div><div>${statusText}</div>`;
    showDebug(payload);
    return;
  }

  statusLine.innerHTML = `<div>訂單 ${orderId}</div><div>無 cart_token，請至後台查詢或聯絡客服</div>`;
  showDebug({ note: 'No cart_token present. Backend should include cart_token in ReturnURL.' });
})();
</script>
</body>
</html>
