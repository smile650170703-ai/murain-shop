<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MURAIN ??è¨‚å–®çµæ? (v6.1)</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 2rem auto; max-width: 600px; padding: 1rem; background-color: #f9f9f9; text-align: center; }
        .container { background: #fff; border-radius: 8px; padding: 2rem; }
        h1 { color: #28a745; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container" id="result-container">
        </div>

    <script>
  // ===== è¨­å?ï¼ˆæ¸¬è©¦ç”¨ï¼?=====
  const API_ENDPOINT = 'https://murain-api.smile650170703.workers.dev';

  const urlParams = new URLSearchParams(window.location.search);
  const container = document.getElementById('result-container');

  // è®€??url ?ƒæ•¸ï¼ˆorder_id, cart_token, status, Status ç­‰é?æµå¸¸è¦‹æ?ä½ï?
  const qOrderId = urlParams.get('order_id') || urlParams.get('MerTradeNo') || urlParams.get('TradeNo') || null;
  const qCartToken = urlParams.get('cart_token') || urlParams.get('TradeNo') || null;
  const qStatus = urlParams.get('status') || urlParams.get('Status') || null;

  // ?¨ä? call å¾Œç«¯ admin/dashboardï¼ˆå?å¾?orders listï¼‰ï?æ¯”è? order_id
  async function fetchOrderFromAdmin(order_id) {
    try {
      const body = { op_key: OP_KEY };
      const res = await fetch(`${API_ENDPOINT}/admin/dashboard`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!data.ok || !Array.isArray(data.orders)) return null;
      return data.orders.find(o => String(o.order_id) === String(order_id)) || null;
    } catch (e) {
      console.warn('[fetchOrderFromAdmin] error', e);
      return null;
    }
  }

  // å¦‚æ??‘å€‘åª??cart_tokenï¼Œå?è©¦ç”¨ /cart/{token} ?´æ¥??
  async function fetchOrderByCartToken(cart_token) {
    try {
      const res = await fetch(`${API_ENDPOINT}/cart/${encodeURIComponent(cart_token)}`);
      if (!res.ok) return null;
      const data = await res.json();
      return { order_id: data.order_id, status: data.status, total_amount: data.total_amount, items: data.items || [] };
    } catch (e) {
      console.warn('[fetchOrderByCartToken] error', e);
      return null;
    }
  }

  // render ä¸»æ?ç¨?
  (async function showResult() {
    // 1) ?ˆå?è©¦ç”± URL ?´æ¥é¡¯ç¤º?€?ºæœ¬?€?‹ï??¥æ?ï¼?
    if (qStatus === 'SUCCESS' || qStatus === 'SUCCESS' || qStatus === 'PAID' || qStatus === 'awaiting_shipping_info') {
      // ?‘æ??´æ¥?å??–æ??‘å·²?¥ç??‹ç‚ºå·²ä?æ¬?
      container.innerHTML = `
        <h1>?? ä»˜æ¬¾?å?</h1>
        <p>è¨‚å–®ç·¨è?ï¼?strong>${qOrderId || 'N/A'}</strong></p>
        <p>è«‹é?æ­¤å?å¾€å¡«å¯«?©æ?ï¼?/p>
        <p><a id="shipping-link" href="#">?å?å¡«å¯«?©æ?è³‡è?</a></p>
      `;
      document.getElementById('shipping-link').href = `shipping.html?cart_token=${encodeURIComponent(qCartToken || '')}&method=PAID`;
      return;
    }

    // 2) ?—è©¦ä»?cart_token ?–å? order (?¥æ? cart_token)
    let order = null;
    if (qCartToken) {
      order = await fetchOrderByCartToken(qCartToken);
    }

    // 3) ?¥æ???order ?–æ???order_idï¼Œå?è©¦ç”¨ order_id ?¼å« admin/dashboard ?œå?
    if ((!order || !order.order_id) && qOrderId) {
      const adminOrder = await fetchOrderFromAdmin(qOrderId);
      if (adminOrder) {
        // ?¯èƒ½ adminOrder ?…å« cart_tokenï¼ˆæ?æ²’æ?ï¼‰ï??‘å€‘å?çµ„ä??‹ç°¡?®ç‰©ä»?
        order = {
          order_id: adminOrder.order_id,
          status: adminOrder.status,
          total_amount: adminOrder.total_amount,
          streamer_name: adminOrder.streamer_name || '',
          cart_token: adminOrder.cart_token || qCartToken || ''
        };
      }
    }

    // 4) ?€çµ‚é¡¯ç¤ºï?å¦‚æ??¿ä??°ä»»ä½?orderï¼?
    if (!order) {
      container.innerHTML = `
        <h1 class="error">?¥è©¢çµæ?</h1>
        <p>è¨‚å–®ç·¨è?ï¼?strong>${qOrderId || 'N/A'}</strong></p>
        <p>?€?‹ï?<strong>${qStatus || '?ªçŸ¥'}</strong></p>
        <p>???¥é?è¦é€²ä?æ­¥æŸ¥è©¢ï?è«‹å??°ç?å¸³é??–æ?ä¾›è??®ç·¨?Ÿçµ¦å®¢æ???/p>
        <p><a href="checkout.html?cart_token=${encodeURIComponent(qCartToken || '')}">?åˆ°çµå¸³??/a></p>
      `;
      return;
    }

    // 5) ??order ?„æ?æ³ï??¹æ? order.status é¡¯ç¤ºä¸å??«é¢ï¼Œä¸¦?ä??å?å¡«å¯«?©æ????ï¼ˆå„ª?ˆç”¨ cart_tokenï¼?
    const cartTokenToUse = order.cart_token || qCartToken || '';
    const st = (order.status || 'unknown').toLowerCase();

    if (st === 'awaiting_cod_shipment' || st === 'awaiting_deposit_proof') {
      container.innerHTML = `
        <h1>?? è¨‚å–®å·²ç¢ºèª?/h1>
        <p>è¨‚å–®ç·¨è?ï¼?strong>${order.order_id}</strong></p>
        <p>?€?‹ï?${order.status}</p>
        <p>?¥è?å¡«å¯«?©æ?è«‹é?ï¼?/p>
        <p><a href="shipping.html?cart_token=${encodeURIComponent(cartTokenToUse)}&method=COD">?å?å¡«å¯«?©æ? (è²¨åˆ°ä»˜æ¬¾ / è¨‚é?)</a></p>
      `;
      return;
    } else if (st === 'paid' || st === 'awaiting_shipping_info' || qStatus === 'SUCCESS') {
      container.innerHTML = `
        <h1>?? ä»˜æ¬¾?å?</h1>
        <p>è¨‚å–®ç·¨è?ï¼?strong>${order.order_id}</strong></p>
        <p>ç¸½é?é¡ï?${order.total_amount || 'N/A'}</p>
        <p><a href="shipping.html?cart_token=${encodeURIComponent(cartTokenToUse)}&method=PAID">?å?å¡«å¯«?©æ? (å·²ä?æ¬?</a></p>
      `;
      return;
    } else {
      container.innerHTML = `
        <h1>?¥è©¢çµæ?</h1>
        <p>è¨‚å–®ç·¨è?ï¼?strong>${order.order_id}</strong></p>
        <p>?€?‹ï?<strong>${order.status}</strong></p>
        <p>å¦‚é??”åŠ©è«‹è¯çµ¡å®¢?ï??–å???<a href="checkout.html?cart_token=${encodeURIComponent(cartTokenToUse)}">çµå¸³??/a></p>
      `;
      return;
    }

  })();
</script>

</body>
</html>
