<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>MURAIN — 訂單完成</title>
<style>
  *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC",Roboto}
  body{margin:0;background:#020617;color:#e2e8f0}
  .wrap{max-width:720px;margin:0 auto;padding:24px 16px 40px}
  h1{margin:0 0 12px;font-size:22px}
  .card{background:rgba(15,23,42,.96);border:1px solid rgba(148,163,184,.35);border-radius:18px;padding:18px;box-shadow:0 18px 45px rgba(0,0,0,.65);margin-top:12px}
  .muted{font-size:13px;color:#94a3b8;margin-top:4px}
  .highlight{font-size:18px;font-weight:600;margin:8px 0}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:14px}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid rgba(148,163,184,.7);margin-right:4px}
  .btn{margin-top:16px;width:100%;padding:12px 14px;border-radius:999px;border:none;background:#e2e8f0;color:#020617;font-size:15px;font-weight:600}
  .btn.secondary{background:transparent;color:#e2e8f0;border:1px solid rgba(148,163,184,.7)}
  .section-title{font-size:14px;font-weight:600;margin-top:12px;margin-bottom:4px}
  .notice{font-size:13px;line-height:1.6;margin-top:6px}
  .center{text-align:center}
  .spinner{display:inline-block;width:18px;height:18px;border-radius:50%;border:2px solid rgba(148,163,184,.6);border-top-color:#e2e8f0;animation:spin 1s linear infinite;margin-right:6px;vertical-align:-3px}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="wrap">
  <h1>訂單已送出</h1>
  <div class="card" id="baseCard">
    <div id="basicInfo">
      <div>感謝您的訂購，系統已收到訂單。</div>
      <div class="highlight mono" id="orderLine">訂單編號：—</div>
      <div class="muted" id="amountLine">訂單金額：—</div>
    </div>

    <div id="loadingBlock" class="notice" style="margin-top:12px;">
      <span class="spinner"></span> 正在確認您的付款方式，請稍候…
    </div>

    <!-- 這裡依 payment_method 顯示不同區塊 -->
    <div id="codBlock" class="notice" style="display:none;">
      <span class="tag">7-11 貨到付款</span>
      <div class="section-title">後續流程說明</div>
      <div>商品備貨完成後，我們會寄出 7-11 貨到付款包裹，請留意簡訊／通知，並於門市取件付款。</div>
    </div>

    <div id="depositPartialBlock" class="notice" style="display:none;">
      <span class="tag">新客 — 訂金 1000 元</span>
      <div class="section-title">匯款資訊</div>
      <div>銀行代號：<span class="mono">822 中國信託商業銀行</span></div>
      <div>匯款帳號：<span class="mono">222540458194</span></div>
      <div class="section-title">匯款提醒</div>
      <div>請於期限內匯款 <b>1000 元訂金</b>，並保留匯款憑證。尾款將於 7-11 取貨時收取。</div>
    </div>

    <div id="depositFullBlock" class="notice" style="display:none;">
      <span class="tag">新客 — 全額匯款</span>
      <div class="section-title">匯款資訊</div>
      <div>銀行代號：<span class="mono">822 中國信託商業銀行</span></div>
      <div>匯款帳號：<span class="mono">222540458194</span></div>
      <div class="section-title">匯款提醒</div>
      <div>請於期限內完成<b>全額匯款</b>，我們會於入帳後安排出貨，並以訊息通知您。</div>
    </div>

    <div id="depositOldBlock" class="notice" style="display:none;">
      <span class="tag">舊客 — 匯款</span>
      <div class="section-title">匯款＆出貨</div>
      <div>請依照直播或客服提供的匯款帳號完成匯款，款項確認後將為您出貨。</div>
    </div>

    <div id="paidBlock" class="notice" style="display:none;">
      <span class="tag">線上付款金流</span>
      <div id="paidText">即將為您連線到付款頁面，請勿關閉視窗…</div>
      <button class="btn" id="paidGoBtn" style="display:none;">前往付款頁面</button>
    </div>

    <div id="zcBlock" class="notice" style="display:none;">
      <span class="tag">無卡零角</span>
      <div id="zcText">即將為您連線到無卡分期頁面，請勿關閉視窗…</div>
      <button class="btn" id="zcGoBtn" style="display:none;">前往分期頁面</button>
    </div>

    <button class="btn secondary" onclick="history.back()">返回上一頁</button>
  </div>

  <div class="center muted" style="margin-top:10px;">若畫面長時間無反應，請截圖訂單編號並私訊官方 LINE 客服。</div>
</div>

<script>
  const API=(window.API_BASE||'https://api.murain.tw').replace(/\/$/,'');
  const qs=new URLSearchParams(location.search);
  const orderId=qs.get('order_id')||'';
  const total=qs.get('total')||'';

  const byId=id=>document.getElementById(id);
  const show=id=>{ byId(id).style.display='block'; };
  const hide=id=>{ byId(id).style.display='none'; };

  // 基本資訊先顯示（就算後端掛了也看得到）
  if(orderId){
    byId('orderLine').textContent='訂單編號：'+orderId;
  }
  if(total){
    const n=Number(total)||0;
    byId('amountLine').textContent='訂單金額：NT$ '+n.toLocaleString();
  }

  async function loadOrderAndRoute(){
    if(!orderId){
      byId('loadingBlock').textContent='找不到訂單編號，請回到上一頁重新下單或聯繫客服。';
      return;
    }
    try{
      const r=await fetch(`${API}/orders/detail?order_id=${encodeURIComponent(orderId)}`);
      if(!r.ok){
        byId('loadingBlock').textContent='暫時無法取得訂單資訊，但您的訂單已送出。如有疑問請截圖訂單編號並聯繫客服。';
        return;
      }
      const j=await r.json();
      const o=j.order||j;  // 看你後端回傳格式，可自行調整
      const pm=(o.payment_method||'').toLowerCase();

      // 拿到 payment_method 之後就可以決定顯示哪一塊
      hide('loadingBlock');

      // 7-11 貨到付款
      if(pm === 'cod_711'){
        show('codBlock');
        return;
      }

      // 新客 — 訂金 or 全額
      if(pm === 'deposit_partial'){
        show('depositPartialBlock');
        return;
      }
      if(pm === 'deposit_full'){
        show('depositFullBlock');
        return;
      }

      // 舊客匯款
      if(pm === 'deposit_old'){
        show('depositOldBlock');
        return;
      }

      // 線上付款：信用卡一次 / 分期 / LinePay / AF
      if(pm.startsWith('paid_')){
        show('paidBlock');
        const payUrl=o.payuni && o.payuni.pay_url;
        if(payUrl){
          // 2 秒後自動跳
          setTimeout(()=>{ location.href=payUrl; }, 2000);
          const btn=byId('paidGoBtn');
          btn.style.display='block';
          btn.onclick=()=>{ location.href=payUrl; };
          byId('paidText').textContent='若沒有自動跳轉，請點擊下方按鈕前往付款頁面完成付款。';
        }else{
          byId('paidText').textContent='已收到線上付款訂單，請依照直播／客服提供的付款連結完成付款。';
        }
        return;
      }

      // 無卡零角方案
      if(pm.startsWith('zero_card_')){
        show('zcBlock');
        const zUrl=o.zerocard && o.zerocard.pay_url;
        if(zUrl){
          setTimeout(()=>{ location.href=zUrl; }, 2000);
          const btn=byId('zcGoBtn');
          btn.style.display='block';
          btn.onclick=()=>{ location.href=zUrl; };
          byId('zcText').textContent='若沒有自動跳轉，請點擊下方按鈕前往無卡分期頁面完成申請。';
        }else{
          byId('zcText').textContent='已收到無卡分期訂單，請依照客服說明完成後續流程。';
        }
        return;
      }

      // 其他未知付款方式
      byId('loadingBlock').textContent='訂單已送出，目前付款方式：'+(pm||'未指定')+'。如有疑問請聯繫客服。';

    }catch(e){
      console.error(e);
      byId('loadingBlock').textContent='暫時無法取得訂單資訊，但您的訂單已送出。如有疑問請截圖訂單編號並聯繫客服。';
    }
  }

  loadOrderAndRoute();
</script>
</body>
</html>
