<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>XUYUAN | 訂單完成</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-color: #050505;
      --card-bg: #111;
      --text-main: #fff;
      --text-muted: #888;
      --gold-primary: #D4AF37; 
      --gold-light: #F3E5AB;
      --border-color: rgba(255, 255, 255, 0.1);
      --font-serif: 'Playfair Display', serif;
      --font-sans: 'Lato', system-ui, -apple-system, sans-serif;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
    }

    /* --- 品牌 Logo --- */
    .brand {
      font-family: var(--font-serif);
      font-size: 24px;
      letter-spacing: 0.2em;
      color: var(--gold-primary);
      margin-bottom: 40px;
      text-transform: uppercase;
    }

    /* --- 訂單卡片 --- */
    .receipt-card {
      width: 100%;
      max-width: 400px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      padding: 40px 30px;
      text-align: center;
      position: relative;
      border-radius: 2px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    /* 頂部裝飾線 */
    .receipt-card::before {
      content: '';
      position: absolute; top: 0; left: 50%; transform: translateX(-50%);
      width: 60px; height: 2px; background: var(--gold-primary);
    }

    .success-icon {
      font-size: 40px; color: var(--gold-primary); margin-bottom: 20px;
      display: inline-block;
      text-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
    }

    .title {
      font-family: var(--font-sans);
      font-size: 26px; color: #fff; margin-bottom: 8px;
      font-weight: 400; letter-spacing: 0.05em;
    }
    .subtitle {
      font-size: 12px; color: var(--text-muted); letter-spacing: 0.1em;
      text-transform: uppercase; margin-bottom: 30px;
    }

    /* 分隔線 */
    .divider {
      height: 1px; background: var(--border-color); width: 100%; margin: 20px 0;
    }

    /* 訂單資訊 */
    .info-row {
      display: flex; justify-content: space-between; align-items: baseline;
      margin-bottom: 12px;
    }
    .info-label {
      font-size: 13px; color: #888; letter-spacing: 0.05em;
    }
    
    /* [修改重點] 訂單編號值：改為標準字體 */
    .info-val {
      font-family: var(--font-sans); /* 改為標準字體 */
      font-weight: 700;              /* 加粗 */
      font-size: 16px; color: #eee;
      letter-spacing: 0.02em;
    }
    
    /* [修改重點] 金額值：改為標準字體 */
    .highlight-val {
      font-family: var(--font-sans); /* 改為標準字體 */
      font-weight: 700;              /* 加粗 */
      color: var(--gold-light); font-size: 20px;
    }

    /* 提示訊息 */
    .note-box {
      margin-top: 30px;
      background: rgba(255,255,255,0.03);
      padding: 16px;
      border-radius: 4px;
    }
    .note-text {
      font-size: 13px; color: #888; line-height: 1.6; text-align: left;
    }

    /* 按鈕 */
    .btn-home {
      display: inline-block;
      margin-top: 40px;
      padding: 14px 40px;
      border: 1px solid var(--gold-primary);
      color: var(--gold-primary);
      background: transparent;
      font-size: 14px; letter-spacing: 0.1em;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
    }
    .btn-home:hover {
      background: var(--gold-primary);
      color: #000;
    }

    /* 錯誤狀態 */
    .error-state { color: var(--text-muted); font-size: 13px; line-height: 1.6; }

  </style>
</head>
<body>

  <div class="brand">XUYUAN</div>

  <div class="receipt-card">
    <div id="okBlock">
      <div class="success-icon">✓</div>
      <h1 class="title">感謝您的購買</h1>
      <div class="subtitle" id="statusSubtitle">訂單已成立</div>

      <div class="divider"></div>

      <div class="info-row">
        <span class="info-label">訂單編號</span>
        <span class="info-val" id="orderIdText">--</span>
      </div>
      
      <div class="info-row">
        <span class="info-label">訂單金額</span>
        <span class="info-val highlight-val" id="amountText">--</span>
      </div>

      <div class="divider"></div>

      <div class="note-box">
        <div class="note-text">
          ● 系統已收到您的訂單。<br>
          ● 請截圖保存此頁面，或記下訂單編號。<br>
          ● 出貨進度請至官方 LINE 查詢。<br>
          ● 若有任何問題，歡迎私訊客服。
        </div>
      </div>
    </div>

    <div id="errorBlock" class="error-state" style="display:none;">
      <div class="success-icon" style="color:#666;">!</div>
      <h1 class="title" style="font-size:20px;">訂單資訊讀取中</h1>
      <p style="margin-top:10px;">
        目前無法顯示訂單編號。<br>
        若您剛完成付款，請稍待系統入帳通知，<br>
        或直接至官方 LINE 確認訂單狀態。
      </p>
    </div>

    <button id="backLineBtn" class="btn-home">返回官方 LINE</button>
    <!-- 顯示自動跳轉提示 -->
    <div id="autoRedirectMsg" style="margin-top:10px; font-size:12px; color:#666; display:none;">
      3 秒後自動返回...
    </div>
  </div>

<script>
  // ✅ 統一版：結帳結果頁（COD/匯款/面交/PayUNI/ZeroCard 都回來這裡）
  // - PayUNI：由 Worker /payuni/return 302 回來，帶 status + channel=payuni
  // - ZeroCard：由 0Card 付款頁回來 display_url，帶 status=PENDING + channel=zero_card（並自動輪詢更新）
  // - COD/匯款/面交：前端 checkout 直接導到這頁（只有 order_id / total）

  const API = (window.API_BASE || 'https://api.murain.tw').replace(/\/+$/, '');

  const qs = new URLSearchParams(location.search);
  const orderId = (qs.get('order_id') || '').trim();
  const total = (qs.get('total') || '').trim();
  const channel = (qs.get('channel') || '').trim().toLowerCase(); // payuni / zero_card / ...
  const statusRaw = (qs.get('status') || '').trim().toUpperCase(); // SUCCESS / FAILED / PENDING / ...
  const msg = (qs.get('message') || '').trim();

  const orderIdText = document.getElementById('orderIdText');
  const amountText = document.getElementById('amountText');
  const okBlock = document.getElementById('okBlock');
  const errorBlock = document.getElementById('errorBlock');
  const subtitleEl = document.getElementById('statusSubtitle');
  const redirectMsg = document.getElementById('autoRedirectMsg');

  function setSubtitle(text) {
    if (subtitleEl) subtitleEl.textContent = text;
  }

  function setNote(html) {
    const note = okBlock && okBlock.querySelector && okBlock.querySelector('.note-text');
    if (note) note.innerHTML = html;
  }

  function normalizeStatus(s) {
    const v = String(s || '').toUpperCase();
    if (!v) return '';
    if (v === '1' || v === 'SUCCESS' || v === 'PAID' || v === 'OK') return 'SUCCESS';
    if (v === '0' || v === 'FAIL' || v === 'FAILED' || v === 'ERROR') return 'FAILED';
    if (v === 'PENDING' || v === 'WAIT' || v === 'PROCESSING') return 'PENDING';
    return v;
  }

  function applyUiByStatus(st) {
    const s = normalizeStatus(st);

    if (!orderId) {
      // 無單號
      if (okBlock) okBlock.style.display = 'none';
      if (errorBlock) errorBlock.style.display = 'block';
      if (redirectMsg) redirectMsg.style.display = 'none';
      return;
    }

    // 有單號
    if (okBlock) okBlock.style.display = '';
    if (errorBlock) errorBlock.style.display = 'none';

    // 訂單編號
    if (orderIdText) orderIdText.textContent = '#' + orderId;

    // 金額
    if (amountText) {
      if (total) {
        const n = Number(total) || 0;
        amountText.textContent = 'NT$ ' + n.toLocaleString();
      } else {
        amountText.textContent = '待確認';
      }
    }

    if (s === 'SUCCESS') {
      setSubtitle('付款成功');
      // 成功：保留原本 note，不用改
    } else if (s === 'FAILED') {
      setSubtitle('付款失敗');
      setNote(
        '● 付款未完成，訂單尚未成立付款狀態。<br>' +
        '● 請返回官方 LINE 讓我們協助確認，或重新嘗試付款。' +
        (msg ? ('<br>● 原因：' + msg) : '')
      );
    } else if (s === 'PENDING') {
      setSubtitle('審核中');
      setNote(
        '● 系統已收到您的申請，目前審核中。<br>' +
        '● 審核完成後，此頁會自動更新結果。<br>' +
        '● 同時我們也會在官方 LINE 通知您。'
      );
    } else {
      // COD/匯款/面交：訂單成立
      setSubtitle('訂單已成立');
      // 原 note 保留
    }
  }

  async function fetchOrderStatus() {
    if (!orderId) return null;
    try {
      const r = await fetch(`${API}/order/status?order_id=${encodeURIComponent(orderId)}`, { method: 'GET' });
      const j = await r.json().catch(() => ({}));
      if (!r.ok || !j || !j.ok) return null;
      return j;
    } catch (e) {
      return null;
    }
  }

  // ✅ 初始 UI（先用 querystring）
  applyUiByStatus(statusRaw);

  // ✅ ZeroCard（或 status=PENDING）才輪詢：審核中 → 自動更新成 SUCCESS/FAILED
  (function startPollingIfNeeded() {
    const s = normalizeStatus(statusRaw);
    const needPoll = (channel === 'zero_card') || (s === 'PENDING');
    if (!needPoll || !orderId) return;

    let tries = 0;
    const maxTries = 60; // 約 3~5 分鐘（視間隔）
    const fastEveryMs = 2000;
    const slowEveryMs = 5000;

    async function tick() {
      tries += 1;

      const info = await fetchOrderStatus();
      if (info) {
        const ps = String(info.pay_status || '').toLowerCase();
        // paid_ok / failed / (其他視為 pending)
        if (ps === 'paid_ok') {
          applyUiByStatus('SUCCESS');
          return;
        }
        if (ps === 'failed') {
          // 可把失敗原因帶回來
          applyUiByStatus('FAILED');
          return;
        }

        // 還沒結果 → 維持 PENDING
        applyUiByStatus('PENDING');
      }

      if (tries >= maxTries) return;

      const every = (tries <= 10) ? fastEveryMs : slowEveryMs;
      setTimeout(tick, every);
    }

    // 先跑一次
    tick();
  })();

  // 回到官方 LINE 按鈕
  const lineBtn = document.getElementById('backLineBtn');
  if (lineBtn) {
    const lineUrl = 'https://line.me/R/ti/p/@cc0857';
    lineBtn.addEventListener('click', () => {
      if (typeof liff !== 'undefined' && liff.isInClient && liff.isInClient()) {
        liff.closeWindow();
      } else {
        location.href = lineUrl;
      }
    });
  }
</script>

</body>
</html>
