<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MURAIN â€” è¨‚å–®çµæœ (v6.1)</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 2rem auto; max-width: 600px; padding: 1rem; background-color: #f9f9f9; text-align: center; }
        .container { background: #fff; border-radius: 8px; padding: 2rem; }
        h1 { color: #28a745; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container" id="result-container">
        </div>

    <script>
  // ===== è¨­å®šï¼ˆæ¸¬è©¦ç”¨ï¼‰ =====
  const API_ENDPOINT = 'https://murain-api.smile650170703.workers.dev';

  const urlParams = new URLSearchParams(window.location.search);
  const container = document.getElementById('result-container');

  // è®€å– url åƒæ•¸ï¼ˆorder_id, cart_token, status, Status ç­‰é‡‘æµå¸¸è¦‹æ¬„ä½ï¼‰
  const qOrderId = urlParams.get('order_id') || urlParams.get('MerTradeNo') || urlParams.get('TradeNo') || null;
  const qCartToken = urlParams.get('cart_token') || urlParams.get('TradeNo') || null;
  const qStatus = urlParams.get('status') || urlParams.get('Status') || null;

  // ç”¨ä¾† call å¾Œç«¯ admin/dashboardï¼ˆå–å¾— orders listï¼‰ï¼Œæ¯”è¼ƒ order_id
  async function fetchOrderFromAdmin(order_id) {
    try {
      const body = { op_key: OP_KEY };
      const res = await fetch(`${API_ENDPOINT}/admin/dashboard`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!data.ok || !Array.isArray(data.orders)) return null;
      return data.orders.find(o => String(o.order_id) === String(order_id)) || null;
    } catch (e) {
      console.warn('[fetchOrderFromAdmin] error', e);
      return null;
    }
  }

  // å¦‚æœæˆ‘å€‘åªæœ‰ cart_tokenï¼Œå˜—è©¦ç”¨ /cart/{token} ç›´æ¥æŠ“
  async function fetchOrderByCartToken(cart_token) {
    try {
      const res = await fetch(`${API_ENDPOINT}/cart/${encodeURIComponent(cart_token)}`);
      if (!res.ok) return null;
      const data = await res.json();
      return { order_id: data.order_id, status: data.status, total_amount: data.total_amount, items: data.items || [] };
    } catch (e) {
      console.warn('[fetchOrderByCartToken] error', e);
      return null;
    }
  }

  // render ä¸»æµç¨‹
  (async function showResult() {
    // 1) å…ˆå˜—è©¦ç”± URL ç›´æ¥é¡¯ç¤ºæœ€åŸºæœ¬ç‹€æ…‹ï¼ˆè‹¥æœ‰ï¼‰
    if (qStatus === 'SUCCESS' || qStatus === 'SUCCESS' || qStatus === 'PAID' || qStatus === 'awaiting_shipping_info') {
      // é‡‘æµç›´æ¥æˆåŠŸæˆ–æˆ‘å€‘å·²çŸ¥ç‹€æ…‹ç‚ºå·²ä»˜æ¬¾
      container.innerHTML = `
        <h1>ğŸ‰ ä»˜æ¬¾æˆåŠŸ</h1>
        <p>è¨‚å–®ç·¨è™Ÿï¼š<strong>${qOrderId || 'N/A'}</strong></p>
        <p>è«‹é»æ­¤å‰å¾€å¡«å¯«ç‰©æµï¼š</p>
        <p><a id="shipping-link" href="#">å‰å¾€å¡«å¯«ç‰©æµè³‡è¨Š</a></p>
      `;
      document.getElementById('shipping-link').href = `shipping.html?cart_token=${encodeURIComponent(qCartToken || '')}&method=PAID`;
      return;
    }

    // 2) å˜—è©¦ä»¥ cart_token å–å¾— order (è‹¥æœ‰ cart_token)
    let order = null;
    if (qCartToken) {
      order = await fetchOrderByCartToken(qCartToken);
    }

    // 3) è‹¥æ²’æœ‰ order æˆ–æ²’æœ‰ order_idï¼Œå˜—è©¦ç”¨ order_id å‘¼å« admin/dashboard æœå°‹
    if ((!order || !order.order_id) && qOrderId) {
      const adminOrder = await fetchOrderFromAdmin(qOrderId);
      if (adminOrder) {
        // å¯èƒ½ adminOrder åŒ…å« cart_tokenï¼ˆæˆ–æ²’æœ‰ï¼‰ï¼Œæˆ‘å€‘å…ˆçµ„ä¸€å€‹ç°¡å–®ç‰©ä»¶
        order = {
          order_id: adminOrder.order_id,
          status: adminOrder.status,
          total_amount: adminOrder.total_amount,
          streamer_name: adminOrder.streamer_name || '',
          cart_token: adminOrder.cart_token || qCartToken || ''
        };
      }
    }

    // 4) æœ€çµ‚é¡¯ç¤ºï¼ˆå¦‚æœæ‹¿ä¸åˆ°ä»»ä½• orderï¼‰
    if (!order) {
      container.innerHTML = `
        <h1 class="error">æŸ¥è©¢çµæœ</h1>
        <p>è¨‚å–®ç·¨è™Ÿï¼š<strong>${qOrderId || 'N/A'}</strong></p>
        <p>ç‹€æ…‹ï¼š<strong>${qStatus || 'æœªçŸ¥'}</strong></p>
        <p>â€» è‹¥éœ€è¦é€²ä¸€æ­¥æŸ¥è©¢ï¼Œè«‹å›åˆ°çµå¸³é æˆ–æä¾›è¨‚å–®ç·¨è™Ÿçµ¦å®¢æœã€‚</p>
        <p><a href="checkout.html?cart_token=${encodeURIComponent(qCartToken || '')}">å›åˆ°çµå¸³é </a></p>
      `;
      return;
    }

    // 5) æœ‰ order çš„æƒ…æ³ï¼šæ ¹æ“š order.status é¡¯ç¤ºä¸åŒç•«é¢ï¼Œä¸¦æä¾›å‰å¾€å¡«å¯«ç‰©æµé€£çµï¼ˆå„ªå…ˆç”¨ cart_tokenï¼‰
    const cartTokenToUse = order.cart_token || qCartToken || '';
    const st = (order.status || 'unknown').toLowerCase();

    if (st === 'awaiting_cod_shipment' || st === 'awaiting_deposit_proof') {
      container.innerHTML = `
        <h1>ğŸ‘ è¨‚å–®å·²ç¢ºèª</h1>
        <p>è¨‚å–®ç·¨è™Ÿï¼š<strong>${order.order_id}</strong></p>
        <p>ç‹€æ…‹ï¼š${order.status}</p>
        <p>è‹¥è¦å¡«å¯«ç‰©æµè«‹é»ï¼š</p>
        <p><a href="shipping.html?cart_token=${encodeURIComponent(cartTokenToUse)}&method=COD">å‰å¾€å¡«å¯«ç‰©æµ (è²¨åˆ°ä»˜æ¬¾ / è¨‚é‡‘)</a></p>
      `;
      return;
    } else if (st === 'paid' || st === 'awaiting_shipping_info' || qStatus === 'SUCCESS') {
      container.innerHTML = `
        <h1>ğŸ‰ ä»˜æ¬¾æˆåŠŸ</h1>
        <p>è¨‚å–®ç·¨è™Ÿï¼š<strong>${order.order_id}</strong></p>
        <p>ç¸½é‡‘é¡ï¼š${order.total_amount || 'N/A'}</p>
        <p><a href="shipping.html?cart_token=${encodeURIComponent(cartTokenToUse)}&method=PAID">å‰å¾€å¡«å¯«ç‰©æµ (å·²ä»˜æ¬¾)</a></p>
      `;
      return;
    } else {
      container.innerHTML = `
        <h1>æŸ¥è©¢çµæœ</h1>
        <p>è¨‚å–®ç·¨è™Ÿï¼š<strong>${order.order_id}</strong></p>
        <p>ç‹€æ…‹ï¼š<strong>${order.status}</strong></p>
        <p>å¦‚éœ€å”åŠ©è«‹è¯çµ¡å®¢æœï¼Œæˆ–å›åˆ° <a href="checkout.html?cart_token=${encodeURIComponent(cartTokenToUse)}">çµå¸³é </a></p>
      `;
      return;
    }

  })();
</script>

</body>
</html>