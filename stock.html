/**
 * MURAIN æ•´åˆç‰ˆå¾Œç«¯ (å«å…§éƒ¨åº«å­˜æŸ¥è©¢ç¶²é )
 * å¯†ç¢¼é è¨­ï¼š8888
 * ç¶²å€ï¼šapi.murain.tw/stock
 */

// --- é€™è£¡é–‹å§‹æ˜¯åŸæœ¬çš„å¾Œç«¯é‚è¼¯ (æˆ‘ä¿ç•™äº†æ‚¨æ‰€æœ‰çš„åŠŸèƒ½) ---
// (é€™éƒ¨åˆ†åŒ…å«æ‚¨åŸæœ¬çš„ Airtable é€£æ¥ã€è¨‚å–®è™•ç†ã€Flex å¡ç‰‡ç­‰)

// [æ­¤è™•çœç•¥æ‚¨åŸæœ¬æª”æ¡ˆä¸­çš„æ•¸åƒè¡Œä»£ç¢¼ï¼Œå¯¦éš›æ“ä½œæ™‚è«‹ä¿ç•™æ‚¨æª”æ¡ˆä¸­ fetch ä¹‹å‰çš„å…¨éƒ¨è¨­å®š]

export default {
  async fetch(request, env, ctx) {
    const { pathname, searchParams } = new URL(request.url);
    const origin = request.headers.get("Origin") || "";

    // ğŸŒŸ æ–°å¢ï¼šåº«å­˜æŸ¥è©¢ç¶²é è·¯ç”±
    if (pathname === '/stock') {
      return new Response(stockHtml, {
        headers: { 
          'Content-Type': 'text/html;charset=UTF-8',
          'Access-Control-Allow-Origin': '*' 
        }
      });
    }

    // --- ä»¥ä¸‹æ˜¯æ‚¨åŸæœ¬å°±æœ‰çš„è·¯ç”±åˆ¤æ–· ---
    if (pathname === '/ping') return new Response("pong");
    
    // ... (åŸæœ¬çš„ /public/products, /cart/add, /checkout ç­‰åˆ¤æ–·) ...
    // [è«‹ç¢ºä¿åŸæœ¬æª”æ¡ˆä¸­æ‰€æœ‰çš„ if (pathname === ...) åˆ¤æ–·éƒ½é‚„åœ¨]

    // å¦‚æœéƒ½æ²’æœ‰å°åˆ°è·¯å¾‘ï¼Œæœ€å¾Œæœƒè·‘é€™è¡Œ
    return new Response(JSON.stringify({ ok:false, error:"not_found" }), { 
      status: 404,
      headers: { "Content-Type": "application/json", "Access-Control-Allow-Origin": "*" }
    });
  }
};

// ğŸŒŸ é€™è£¡å°±æ˜¯è¦æŠŠ HTML ç¶²é ä»£ç¢¼è²¼åœ¨æª”æ¡ˆæœ€æœ«ç«¯ ğŸŒŸ
const stockHtml = `
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MURAIN å…§éƒ¨åº«å­˜æŸ¥è©¢</title>
    <style>
        :root { --primary: #1a1a1a; --accent: #c5a059; --bg: #f9f9f9; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 20px auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .header { text-align: center; border-bottom: 2px solid var(--accent); margin-bottom: 20px; padding-bottom: 10px; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--primary); color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .low { color: #d9534f; font-weight: bold; background: #fff1f0; padding: 2px 6px; border-radius: 4px; }
        #auth-screen { text-align: center; margin-top: 100px; }
        .btn { padding: 12px 25px; background: var(--accent); border: none; color: white; border-radius: 6px; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>
    <div id="auth-box">
        <div id="auth-screen">
            <h2 style="letter-spacing:2px;">MURAIN å…§éƒ¨ç³»çµ±</h2>
            <p style="color:#666;">è«‹è¼¸å…¥æŸ¥è©¢å¯†ç¢¼</p>
            <input type="password" id="pw" placeholder="å¯†ç¢¼" style="width: 250px; text-align:center;">
            <br>
            <button class="btn" onclick="check()">é€²å…¥ç³»çµ±</button>
        </div>
    </div>

    <div class="container" id="main" style="display:none;">
        <div class="header">
            <h2>ğŸ“¦ åº«å­˜å³æ™‚æŸ¥è©¢</h2>
            <small style="color:#999;">è³‡æ–™ä¾†æºï¼šAirtable é›²ç«¯åº«å­˜</small>
        </div>
        <input type="text" id="search" placeholder="è¼¸å…¥ç”¢å“åç¨±æˆ– SKU æœå°‹...">
        <div id="msg" style="text-align:center; padding: 20px; color: #999;">æ­£åœ¨é€£ç·šè‡³è³‡æ–™åº«...</div>
        <table id="list" style="display:none;">
            <thead><tr><th>SKU</th><th>ç”¢å“åç¨±</th><th style="text-align:right;">åº«å­˜</th></tr></thead>
            <tbody id="body"></tbody>
        </table>
    </div>

    <script>
        const PASS = "8888"; // ğŸ’¡ å¯†ç¢¼è¨­åœ¨é€™è£¡
        let allData = [];

        function check() {
            if(document.getElementById('pw').value === PASS) {
                document.getElementById('auth-box').style.display = 'none';
                document.getElementById('main').style.display = 'block';
                load();
            } else { alert('å¯†ç¢¼éŒ¯èª¤'); }
        }

        async function load() {
            try {
                // ç›´æ¥æŠ“å–å¾Œç«¯çš„ç”¢å“æ¥å£
                const res = await fetch('/public/products?limit=1000');
                const json = await res.json();
                if(json.ok) {
                    allData = json.items;
                    render(allData);
                    document.getElementById('msg').style.display = 'none';
                    document.getElementById('list').style.display = 'table';
                }
            } catch(e) { document.getElementById('msg').innerText = 'è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªå¾Œç«¯ç‹€æ…‹'; }
        }

        function render(items) {
            const b = document.getElementById('body');
            b.innerHTML = items.map(p => \`
                <tr>
                    <td style="font-family: monospace; color:#666;">\${p.sku || '-'}</td>
                    <td style="font-weight:bold;">\${p.title || p.name}</td>
                    <td style="text-align:right;"><span class="\${p.stock <= 3 ? 'low' : ''}">\${p.stock ?? 0}</span></td>
                </tr>
            \`).join('');
        }

        document.getElementById('search').addEventListener('input', (e) => {
            const k = e.target.value.toLowerCase();
            render(allData.filter(p => (p.sku||'').toLowerCase().includes(k) || (p.title||'').toLowerCase().includes(k)));
        });
    </script>
</body>
</html>
\`;
