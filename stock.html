<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>庫存查詢系統</title>

  <!-- 建議加：不要被搜尋引擎收錄（不影響功能） -->
  <meta name="robots" content="noindex, nofollow">

  <style>
    :root {
      --bg-color: #0d0e12;
      --card-bg: #16181d;
      --header-bg: rgba(18, 20, 25, 0.95);
      --primary: #d4af37;
      --primary-hover: #f1c40f;
      --text-main: #e0e0e0;
      --text-muted: #94a3b8;
      --border-color: #2d3139;
      --input-bg: #1e2128;
      --success: #4ade80;
      --warning: #fbbf24;
      --danger: #f87171;
    }

    body {
      margin: 0;
      font-family: "Inter", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: var(--bg-color);
      color: var(--text-main);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--header-bg);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border-color);
      padding: 16px 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }

    h1 {
      margin: 0 0 16px;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.5px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h1::before {
      content: "";
      width: 4px;
      height: 20px;
      background: var(--primary);
      border-radius: 2px;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    input, button, select {
      font-size: 14px;
      transition: all 0.2s ease;
    }

    input, select {
      background: var(--input-bg);
      color: var(--text-main);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px 14px;
      outline: none;
    }

    input:focus, select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
      background: #252932;
    }

    button {
      background: var(--primary);
      border: 0;
      color: #000;
      font-weight: 700;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    button:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
    }

    button:active { transform: translateY(0); }

    button.secondary {
      background: #2d3139;
      color: var(--text-main);
      border: 1px solid var(--border-color);
    }

    button.secondary:hover {
      background: #3d424d;
      border-color: #4d5361;
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }

    main {
      max-width: 1300px;
      margin: 0 auto;
      padding: 20px;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 20px;
      margin-top: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    }

    .muted { color: var(--text-muted); font-size: 13px; }
    .small { font-size: 12px; }

    .table-container { overflow-x: auto; }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 10px;
    }

    th {
      background: rgba(255,255,255,0.02);
      color: var(--text-muted);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 1px;
      padding: 14px 12px;
      border-bottom: 2px solid var(--border-color);
      text-align: left;
    }

    td {
      padding: 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 14px;
    }

    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(255,255,255,0.03); }

    .right { text-align: right; }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.05);
    }

    .ok   { border-color: rgba(74, 222, 128, 0.4); color: var(--success); background: rgba(74, 222, 128, 0.1); }
    .low  { border-color: rgba(251, 191, 36, 0.4); color: var(--warning); background: rgba(251, 191, 36, 0.1); }
    .zero { border-color: rgba(248, 113, 113, 0.4); color: var(--danger);  background: rgba(248, 113, 113, 0.1); }

    .err  { color: var(--danger);  background: rgba(248, 113, 113, 0.1); border: 1px solid rgba(248, 113, 113, 0.2); padding: 12px; border-radius: 8px; }
    .good { color: var(--success); background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.2); padding: 12px; border-radius: 8px; }

    label {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      user-select: none;
    }

    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--primary);
    }

    @media (max-width: 768px) {
      .row { flex-direction: column; align-items: stretch; }
      input, select, button { width: 100%; }
      header { position: relative; }
    }
  </style>
</head>
<body>

<header>
  <h1>庫存查詢系統 <small style="font-size: 12px; color: var(--text-muted); font-weight: normal;"></small></h1>

  <!-- ✅ 已移除 API Base 欄位：固定打 https://api.murain.tw -->
  <div class="row">
    <input id="op" type="password" style="flex: 1; min-width: 150px" placeholder="OP_KEY (網頁密碼)" />
    <input id="q" type="text" style="flex: 2; min-width: 200px" placeholder="搜尋 SKU / 關鍵字（至少 2 碼，例如 A0、A08）" />
    <button id="btnSearch">搜尋</button>
    <button id="btnAll" class="secondary">全部庫存</button>
  </div>

  <div class="row" style="margin-top: 16px; justify-content: space-between;">
    <div style="display: flex; gap: 20px;">
      <label class="muted"><input id="onlyStock" type="checkbox" checked /> 只看庫存 &gt; 0</label>
      <label class="muted">顯示上限：
        <select id="limit">
          <option value="500">500</option>
          <option value="1000">1000</option>
          <option value="2000" selected>2000</option>
          <option value="5000">5000</option>
        </select>
      </label>
    </div>
    <div style="display: flex; align-items: center; gap: 12px;">
      <span id="stat" class="muted"></span>
      <button id="btnCSV" class="secondary" style="padding: 6px 12px; font-size: 12px;">匯出 CSV</button>
    </div>
  </div>
</header>

<main>
  <div id="msg" class="card muted">系統就緒，請輸入密碼後開始查詢。</div>

  <div class="card" style="padding: 0; overflow: hidden;">
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th style="width:180px">SKU 商品編號</th>
<th>商品名稱</th>
<th style="width:160px">庫存位置</th>
<th class="right" style="width:140px">在庫數量</th>
<th class="right" style="width:120px">建議售價</th>
<th style="width:100px; text-align: center;">上架狀態</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
  </div>
</main>

<script>
  // ✅ 固定後端：不再顯示/允許修改
  const DEFAULT_API = "https://api.murain.tw";

  const $ = (id)=>document.getElementById(id);

  const opEl = $("op"), qEl = $("q");
  const onlyStockEl = $("onlyStock"), limitEl = $("limit");
  const tb = $("tb"), msg = $("msg"), stat = $("stat");

  opEl.value = localStorage.getItem("stock_op") || "";
  qEl.value  = localStorage.getItem("stock_q")  || "";

  let rows = [];

  function setMsg(type, text){
    msg.className = "card " + (type==="err" ? "err" : type==="good" ? "good" : "muted");
    msg.textContent = text;
  }

  function normApi(){
    return DEFAULT_API;
  }

  function normOp(){
    const v = (opEl.value || "").trim();
    localStorage.setItem("stock_op", v);
    return v;
  }

  function badgeStock(n){
    const v = Number(n||0)||0;
    if (v<=0) return `<span class="badge zero">缺貨 (0)</span>`;
    if (v<=2) return `<span class="badge low">低庫存 (${v})</span>`;
    return `<span class="badge ok">充足 (${v})</span>`;
  }

  function money(n){
    const v = Number(n||0);
    if (!Number.isFinite(v)) return "-";
    return "NT$ " + Math.round(v).toLocaleString("zh-TW");
  }

  function esc(s){
    return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }

  async function fetchList(q){
    const api = normApi();
    const op  = normOp();
    if (!op) throw new Error("請先輸入 OP_KEY（網頁密碼）");

    const in_stock = onlyStockEl.checked ? "1" : "0";
    const limit = String(limitEl.value || "2000");

    const url =
      `${api}/op/stock/search?op_key=${encodeURIComponent(op)}&in_stock=${in_stock}&limit=${encodeURIComponent(limit)}`
      + (q ? `&q=${encodeURIComponent(q)}` : "");

    const r = await fetch(url, { method:"GET" });
    const data = await r.json().catch(()=> ({}));
    if (!r.ok || !data.ok) {
      const err = data?.error ? `${data.error}` : `HTTP ${r.status}`;
      throw new Error(err + (data?.detail ? `\n${data.detail}` : ""));
    }
    return data;
  }

  function render(){
    tb.innerHTML = rows.map(r=>`
      <tr>
        <td><code style="color:var(--primary); font-weight:600">${esc(r.sku||"-")}</code></td>
<td style="font-weight:500">${esc(r.name||"-")}</td>
<td>${esc(r.location || "-")}</td>
<td class="right">${badgeStock(r.stock)}</td>
        <td class="right" style="font-family: monospace; font-size: 15px;">${esc(money(r.price))}</td>
        <td style="text-align: center;">${r.active ? `<span class="badge ok">銷售中</span>` : `<span class="badge">已下架</span>`}</td>
      </tr>
    `).join("");
    stat.textContent = `顯示：${rows.length} 筆資料`;
  }

  async function run(q){
    localStorage.setItem("stock_q", q || "");
    setMsg("muted", "連線中，請稍候...");
    stat.textContent = "讀取中...";

    const data = await fetchList(q);
    rows = Array.isArray(data.items) ? data.items : [];
    render();
    setMsg("good", `查詢成功：共 ${data.count} 筆記錄 (最後更新時間：${data.updated_at || "-"})`);
  }

  // ✅ 搜尋：至少 2 碼（支援 A08 這種短碼）
  $("btnSearch").addEventListener("click", async ()=>{
    try{
      const q = (qEl.value || "").trim();
      if (q.length < 2) return setMsg("err", "請輸入至少 2 碼再搜尋（例如 A0、A08）");
      await run(q);
    }catch(e){
      setMsg("err", String(e?.message || e));
      stat.textContent = "";
    }
  });

  // ✅ 全部庫存（保留）
  $("btnAll").addEventListener("click", async ()=>{
    try{
      await run("");
    }catch(e){
      setMsg("err", String(e?.message || e));
      stat.textContent = "";
    }
  });

  // ✅ 勾選「只看庫存>0」時，自動重查（同樣用 >=2 判斷）
  onlyStockEl.addEventListener("change", ()=> {
    const q = (qEl.value || "").trim();
    if (q.length >= 2) run(q).catch(()=>{});
    else run("").catch(()=>{});
  });

  // CSV 匯出（保留 BOM，Excel 不亂碼）
  $("btnCSV").addEventListener("click", ()=>{
    if (!rows.length) return setMsg("err", "目前沒有資料可供匯出");
    const lines = [
      ["sku","name","stock","price","active"].join(","),
      ...rows.map(r=>[
        `"${String(r.sku||"").replace(/"/g,'""')}"`,
        `"${String(r.name||"").replace(/"/g,'""')}"`,
        String(Number(r.stock||0)||0),
        String(Number(r.price||0)||0),
        r.active ? "1" : "0"
      ].join(","))
    ].join("\n");

    const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), lines], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `庫存匯出_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
    setMsg("good", `匯出成功：已下載 ${rows.length} 筆資料至 CSV。`);
  });

  // 初始：不強制自動載入（避免手機一開就大量查詢）
  (async ()=>{
    try{
      if (!opEl.value.trim()) throw new Error("need op_key");
      setMsg("muted", "已記住 OP_KEY，可直接按「全部庫存」或輸入關鍵字搜尋。");
    } catch {
      setMsg("muted", "請輸入 OP_KEY（網頁密碼），再按「全部庫存」或輸入關鍵字搜尋。");
    }
  })();
</script>
</body>
</html>
