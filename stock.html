<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>庫存查詢（五碼模糊搜尋）</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI","Noto Sans TC","Microsoft JhengHei",sans-serif;background:#0b0c10;color:#eaeaea}
    header{position:sticky;top:0;z-index:10;background:#090a0d;border-bottom:1px solid #222;padding:14px 16px}
    h1{margin:0 0 10px;font-size:18px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,button,select{
      background:#12131a;color:#eaeaea;border:1px solid #2a2b34;border-radius:10px;
      padding:10px 12px;outline:none
    }
    input:focus,select:focus{border-color:#d4af37;box-shadow:0 0 0 3px rgba(212,175,55,.15)}
    button{background:#d4af37;border:0;color:#101015;font-weight:800;cursor:pointer}
    button.secondary{background:#1b1c25;color:#eaeaea;border:1px solid #2a2b34;font-weight:700}
    button:disabled{opacity:.55;cursor:not-allowed}
    main{max-width:1200px;margin:0 auto;padding:16px}
    .card{background:#0f1016;border:1px solid #22232b;border-radius:14px;padding:14px;margin-top:12px}
    .muted{color:#9aa0a6;font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #1e1f28;padding:10px 8px;font-size:13px;vertical-align:top}
    th{color:#cfcfcf;text-align:left}
    tr:hover td{background:#0c0d12}
    .right{text-align:right}
    .badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid #2a2b34;color:#d7d7d7}
    .ok{border-color:rgba(70,200,120,.35);color:#b8f7cf}
    .low{border-color:rgba(255,200,60,.35);color:#ffe6a0}
    .zero{border-color:rgba(255,90,90,.35);color:#ffb3b3}
    .err{color:#ffb3b3;white-space:pre-wrap}
    .good{color:#b8f7cf;white-space:pre-wrap}
    .small{font-size:12px}
  </style>
</head>
<body>
<header>
  <h1>庫存查詢（五碼模糊搜尋 / OP）</h1>
  <div class="row">
    <input id="api" type="text" style="min-width:260px" placeholder="API Base" />
    <input id="op" type="password" style="min-width:180px" placeholder="OP_KEY（網頁密碼）" />
    <input id="q" type="text" style="min-width:260px" placeholder="輸入任意五碼/關鍵字（例如 12345）" />
    <button id="btnSearch">搜尋</button>
    <button id="btnAll" class="secondary">全部庫存</button>

    <label class="muted small"><input id="onlyStock" type="checkbox" checked />只看庫存&gt;0</label>
    <label class="muted small">上限：
      <select id="limit">
        <option value="500">500</option>
        <option value="1000">1000</option>
        <option value="2000" selected>2000</option>
        <option value="5000">5000</option>
      </select>
    </label>
    <button id="btnCSV" class="secondary">匯出 CSV</button>
    <span id="stat" class="muted"></span>
  </div>

  <div class="muted" style="margin-top:8px">
    來源：<span class="badge">GET /op/stock/search</span>（只新增查詢，不影響原本結帳/付款）
  </div>
</header>

<main>
  <div id="msg" class="card muted">準備就緒。</div>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th style="width:160px">SKU</th>
          <th>名稱</th>
          <th class="right" style="width:90px">庫存</th>
          <th class="right" style="width:120px">價格</th>
          <th style="width:90px">上架</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>
  </div>
</main>

<script>
  const DEFAULT_API = "https://api.murain.tw";
  const $ = (id)=>document.getElementById(id);

  const apiEl = $("api"), opEl = $("op"), qEl = $("q");
  const onlyStockEl = $("onlyStock"), limitEl = $("limit");
  const tb = $("tb"), msg = $("msg"), stat = $("stat");

  apiEl.value = localStorage.getItem("stock_api") || DEFAULT_API;
  opEl.value  = localStorage.getItem("stock_op")  || "";
  qEl.value   = localStorage.getItem("stock_q")   || "";

  let rows = [];

  function setMsg(type, text){
    msg.className = "card " + (type==="err" ? "err" : type==="good" ? "good" : "muted");
    msg.textContent = text;
  }

  function normApi(){
    const v = (apiEl.value || "").trim().replace(/\/+$/,"") || DEFAULT_API;
    localStorage.setItem("stock_api", v);
    return v;
  }

  function normOp(){
    const v = (opEl.value || "").trim();
    localStorage.setItem("stock_op", v);
    return v;
  }

  function badgeStock(n){
    const v = Number(n||0)||0;
    if (v<=0) return `<span class="badge zero">0</span>`;
    if (v<=2) return `<span class="badge low">${v}</span>`;
    return `<span class="badge ok">${v}</span>`;
  }

  function money(n){
    const v = Number(n||0);
    if (!Number.isFinite(v)) return "-";
    return "NT$ " + Math.round(v).toLocaleString("zh-TW");
  }

  function esc(s){
    return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }

  async function fetchList(q){
    const api = normApi();
    const op  = normOp();
    if (!op) throw new Error("請先輸入 OP_KEY（網頁密碼）");

    const in_stock = onlyStockEl.checked ? "1" : "0";
    const limit = String(limitEl.value || "2000");

    const url =
      `${api}/op/stock/search?op_key=${encodeURIComponent(op)}&in_stock=${in_stock}&limit=${encodeURIComponent(limit)}`
      + (q ? `&q=${encodeURIComponent(q)}` : "");

    const r = await fetch(url, { method:"GET" });
    const data = await r.json().catch(()=> ({}));
    if (!r.ok || !data.ok) {
      const err = data?.error ? `${data.error}` : `HTTP ${r.status}`;
      throw new Error(err + (data?.detail ? `\n${data.detail}` : ""));
    }
    return data;
  }

  function render(){
    tb.innerHTML = rows.map(r=>`
      <tr>
        <td><b>${esc(r.sku||"-")}</b></td>
        <td>${esc(r.name||"-")}</td>
        <td class="right">${badgeStock(r.stock)}</td>
        <td class="right">${esc(money(r.price))}</td>
        <td>${r.active ? `<span class="badge ok">是</span>` : `<span class="badge">否</span>`}</td>
      </tr>
    `).join("");
    stat.textContent = `顯示：${rows.length} 筆`;
  }

  async function run(q){
    localStorage.setItem("stock_q", q || "");
    setMsg("muted", "查詢中…");
    stat.textContent = "查詢中…";

    const data = await fetchList(q);
    rows = Array.isArray(data.items) ? data.items : [];
    render();
    setMsg("good", `完成：${data.count} 筆（updated_at=${data.updated_at || "-"})`);
  }

  $("btnSearch").addEventListener("click", async ()=>{
    try{
      const q = (qEl.value || "").trim();
      if (q.length < 5) return setMsg("err", "請輸入至少 5 碼（例如 12345）");
      await run(q);
    }catch(e){
      setMsg("err", String(e?.message || e));
      stat.textContent = "";
    }
  });

  $("btnAll").addEventListener("click", async ()=>{
    try{
      await run(""); // q 空＝全部
    }catch(e){
      setMsg("err", String(e?.message || e));
      stat.textContent = "";
    }
  });

  onlyStockEl.addEventListener("change", ()=> {
    const q = (qEl.value || "").trim();
    if (q.length >= 5) run(q).catch(()=>{});
    else run("").catch(()=>{});
  });

  $("btnCSV").addEventListener("click", ()=>{
    if (!rows.length) return setMsg("err", "沒有資料可匯出");
    const lines = [
      ["sku","name","stock","price","active"].join(","),
      ...rows.map(r=>[
        `"${String(r.sku||"").replace(/"/g,'""')}"`,
        `"${String(r.name||"").replace(/"/g,'""')}"`,
        String(Number(r.stock||0)||0),
        String(Number(r.price||0)||0),
        r.active ? "1" : "0"
      ].join(","))
    ].join("\n");

    const blob = new Blob([lines], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "stock_search_export.csv";
    a.click();
    URL.revokeObjectURL(a.href);
    setMsg("good", `已匯出 CSV（${rows.length} 筆）。`);
  });

  // 初始：若 q 已有 5 碼 → 先搜尋；否則先載全部（若未輸入 OP_KEY 就提示）
  (async ()=>{
    try{
      const q = (qEl.value || "").trim();
      if (!opEl.value.trim()) throw new Error("need op_key");
      if (q.length >= 5) await run(q);
      else await run("");
    } catch {
      setMsg("muted", "請先輸入 OP_KEY（網頁密碼），再按「全部庫存」或輸入五碼搜尋。");
    }
  })();
</script>
</body>
</html>
