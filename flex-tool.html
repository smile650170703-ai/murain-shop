import requests
import json

def send_payment_confirmation(user_id, customer_name, order_id, amount, liff_url):
    """
    發送「付款確認」的高級 Flex Message
    
    參數:
    user_id: 客人的 LINE User ID (不是名稱，是 U 開頭的那串 ID)
    customer_name: 客人姓名 (e.g. "陳小姐")
    order_id: 訂單編號 (e.g. "OD123456789")
    amount: 金額 (e.g. "5,000")
    liff_url: 您的購物車 LIFF 連結
    """
    
    # 您的 LINE Channel Access Token (請從 LINE Developers 後台取得)
    LINE_CHANNEL_ACCESS_TOKEN = 'YOUR_CHANNEL_ACCESS_TOKEN'

    headers = {
        'Content-Type': 'application/json',
        'Authorization': f'Bearer {LINE_CHANNEL_ACCESS_TOKEN}'
    }

    # 這裡就是您剛剛選取的那段 JSON (Flex Message 排版代碼)
    # 我已經把變數部分用 f-string {變數} 替換好了
    flex_content = {
      "type": "bubble",
      "body": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "PAYMENT CONFIRMED",
            "weight": "bold",
            "color": "#2B5F48",
            "size": "xs",
            "letterSpacing": "2px"
          },
          {
            "type": "text",
            "text": "付款確認 / 審核通過",
            "weight": "bold",
            "size": "xl",
            "margin": "md",
            "color": "#111111"
          },
          {
            "type": "text",
            "text": f"Dear {customer_name}，恭喜您！您的訂單已完成付款確認。",
            "size": "sm",
            "color": "#666666",
            "margin": "md",
            "wrap": True
          },
          {
            "type": "box",
            "layout": "vertical",
            "margin": "lg",
            "paddingAll": "lg",
            "backgroundColor": "#F0F5F2",
            "cornerRadius": "md",
            "contents": [
              {
                "type": "box",
                "layout": "baseline",
                "spacing": "sm",
                "contents": [
                  {
                    "type": "text",
                    "text": "訂單編號",
                    "color": "#888888",
                    "size": "sm",
                    "flex": 2
                  },
                  {
                    "type": "text",
                    "text": order_id,
                    "wrap": True,
                    "color": "#333333",
                    "size": "sm",
                    "flex": 4
                  }
                ]
              },
              {
                "type": "box",
                "layout": "baseline",
                "spacing": "sm",
                "margin": "sm",
                "contents": [
                  {
                    "type": "text",
                    "text": "確認金額",
                    "color": "#888888",
                    "size": "sm",
                    "flex": 2
                  },
                  {
                    "type": "text",
                    "text": f"NT$ {amount}",
                    "wrap": True,
                    "color": "#2B5F48",
                    "size": "md",
                    "flex": 4,
                    "weight": "bold"
                  }
                ]
              }
            ]
          }
        ]
      },
      "footer": {
        "type": "box",
        "layout": "vertical",
        "spacing": "sm",
        "contents": [
          {
            "type": "button",
            "style": "primary",
            "height": "sm",
            "action": {
              "type": "uri",
              "label": "查看訂單詳情",
              "uri": liff_url
            },
            "color": "#2B5F48"
          }
        ]
      }
    }

    # 組合發送 Payload
    payload = {
        "to": user_id,
        "messages": [
            {
                "type": "flex",
                "altText": "【MURAIN】您的訂單付款已確認", # 這是聊天列表顯示的預覽文字
                "contents": flex_content
            }
        ]
    }

    # 發送請求到 LINE API
    try:
        response = requests.post(
            'https://api.line.me/v2/bot/message/push',
            headers=headers,
            data=json.dumps(payload)
        )
        response.raise_for_status()
        print("訊息發送成功！")
    except requests.exceptions.RequestException as e:
        print(f"發送失敗: {e}")
        if response.content:
            print(f"錯誤詳情: {response.text}")

# --- 使用範例 ---
if __name__ == "__main__":
    # 這裡填入真實數據測試
    send_payment_confirmation(
        user_id="U1234567890abcdef...", # 填入測試用的 User ID
        customer_name="陳小姐",
        order_id="OD1764831785892",
        amount="5,000",
        liff_url="https://liff.line.me/YOUR-APP-ID?token=..."
    )
