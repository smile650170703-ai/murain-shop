<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MURAIN — 訂單列表 / 待出貨</title>
<style>
  *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC",Roboto}
  body{margin:0;background:#0b1222;color:#e2e8f0}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  h1{margin:0 0 8px;font-size:22px}
  .muted{font-size:13px;color:#9ca3af}
  .card{background:rgba(15,23,42,.95);border-radius:16px;padding:14px;border:1px solid rgba(148,163,184,.35);box-shadow:0 18px 40px rgba(0,0,0,.55);margin-top:12px}
  label{display:block;font-size:13px;margin:8px 2px 4px}
  input,select,button{border-radius:10px;border:1px solid #1e293b;padding:8px 10px;font-size:14px;background:rgba(15,23,42,.9);color:#e2e8f0}
  input:focus,select:focus{outline:2px solid #38bdf8;outline-offset:1px;border-color:#38bdf8}
  button{cursor:pointer;border:none;background:#38bdf8;color:#0f172a;font-weight:600;padding:9px 14px}
  button.secondary{background:transparent;color:#e2e8f0;border:1px solid #38bdf8}
  button:disabled{opacity:.6;cursor:not-allowed}
  .filter-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
  .btn-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .table-wrap{overflow:auto;max-height:520px;border-radius:12px;border:1px solid #1e293b;margin-top:6px}
  table{width:100%;border-collapse:collapse;font-size:13px;min-width:800px}
  thead{background:rgba(15,23,42,.9);position:sticky;top:0;z-index:1}
  th,td{padding:6px 8px;border-bottom:1px solid rgba(30,64,175,.3);text-align:left;white-space:nowrap}
  th{font-weight:600;font-size:12px;color:#cbd5f5}
  tr:nth-child(even) td{background:rgba(15,23,42,.85)}
  tr:hover td{background:rgba(30,64,175,.5)}
  .num{text-align:right}
  .status-badge{display:inline-flex;align-items:center;border-radius:999px;padding:2px 8px;font-size:11px;border:1px solid rgba(148,163,184,.7);background:rgba(15,23,42,.8)}
  .status-submitted{border-color:#f97316}
  .status-paid{border-color:#22c55e}
  .status-shipped{border-color:#38bdf8}
  .status-cancelled{border-color:#f87171}
  .pill{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;background:rgba(15,23,42,.9);border:1px solid rgba(148,163,184,.6);font-size:11px}
  .summary-row{margin-top:8px;font-size:13px;display:flex;justify-content:space-between;gap:16px;flex-wrap:wrap}
  .summary-row span{white-space:nowrap}
  a.link{color:#38bdf8;text-decoration:none}
  a.link:hover{text-decoration:underline}
</style>
</head>
<body>
<div class="wrap">
  <h1>訂單列表 / 待出貨</h1>
  <div class="muted">．輸入後台密碼 OP_KEY，依日期 / 狀態載入訂單，可一鍵匯出 Excel（CSV）。</div>

  <div class="card">
    <div class="filter-grid">
      <div>
        <label>後台密碼（OP_KEY）</label>
        <input id="op_key" type="password" placeholder="與 Worker 環境變數 OP_KEY 相同" />
      </div>
      <div>
        <label>起始日期（date_from，含）</label>
        <input id="date_from" type="date" />
      </div>
      <div>
        <label>結束日期（date_to，含）</label>
        <input id="date_to" type="date" />
      </div>
      <div>
        <label>狀態（status）</label>
        <select id="status">
          <option value="">全部</option>
          <option value="submitted">submitted（已送出）</option>
          <option value="paid">paid（已付款）</option>
          <option value="shipped">shipped（已出貨）</option>
          <option value="cancelled">cancelled（取消）</option>
        </select>
      </div>
    </div>
    <div class="btn-row">
      <button onclick="loadOrders()">載入訂單</button>
      <button class="secondary" id="exportBtn" onclick="exportCSV()" disabled>匯出 Excel（CSV）</button>
    </div>
    <div id="summary" class="summary-row" style="margin-top:6px;"></div>
    <div id="msg" class="muted" style="margin-top:4px;"></div>
  </div>

  <div class="card">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>訂單時間</th>
            <th>訂單編號</th>
            <th>直播主</th>
            <th>客戶類型</th>
            <th>狀態</th>
            <th>付款方式</th>
            <th class="num">金額</th>
            <th>物流單號</th>
            <th class="num">運費</th>
            <th>備註</th>
            <th>動作</th>
          </tr>
        </thead>
        <tbody id="ordersBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const API = (window.API_BASE || 'https://api.murain.tw').replace(/\/$/,'');
let ORDERS_CACHE = [];

function $(sel){ return document.querySelector(sel); }

function money(n){
  n = Number(n) || 0;
  return n.toLocaleString('zh-TW', { minimumFractionDigits: 0 });
}

function statusClass(st){
  if (!st) return 'status-badge';
  return 'status-badge status-' + st;
}

function escapeCSV(v){
  if (v == null) return '';
  const s = String(v);
  if (/[",\n]/.test(s)){
    return '"' + s.replace(/"/g,'""') + '"';
  }
  return s;
}

async function loadOrders(){
  const op_key = $('#op_key').value.trim();
  const date_from = $('#date_from').value;
  const date_to   = $('#date_to').value;
  const status    = $('#status').value;
  const msgBox = $('#msg');
  const bodyEl = $('#ordersBody');
  const exportBtn = $('#exportBtn');
  msgBox.textContent = '';
  bodyEl.innerHTML = '';
  exportBtn.disabled = true;
  ORDERS_CACHE = [];

  if (!op_key){
    msgBox.textContent = '請先輸入後台密碼 OP_KEY。';
    return;
  }

  const params = new URLSearchParams();
  params.set('op_key', op_key);
  if (date_from) params.set('date_from', date_from);
  if (date_to) params.set('date_to', date_to);
  if (status) params.set('status', status);

  try{
    msgBox.textContent = '載入中…';
    const r = await fetch(API + '/admin/orders?' + params.toString());
    const j = await r.json();
    if (!r.ok || !j.ok){
      msgBox.textContent = '載入失敗：' + (j && j.error ? j.error : r.status);
      return;
    }

    const orders = j.orders || [];
    ORDERS_CACHE = orders;
    renderOrders(orders);
    exportBtn.disabled = orders.length === 0;
    msgBox.textContent = orders.length ? '' : '查無符合條件的訂單。';
  } catch(e){
    console.error(e);
    msgBox.textContent = '連線錯誤：' + e;
  }
}

function renderOrders(list){
  const bodyEl = $('#ordersBody');
  bodyEl.innerHTML = '';
  let sum = 0;
  let countSubmitted = 0, countPaid = 0, countShipped = 0, countCancelled = 0;

  for (const o of list){
    sum += Number(o.total_amount || 0);

    if (o.status === 'submitted') countSubmitted++;
    else if (o.status === 'paid') countPaid++;
    else if (o.status === 'shipped') countShipped++;
    else if (o.status === 'cancelled') countCancelled++;

    const tr = document.createElement('tr');

    const tdTime = document.createElement('td');
    tdTime.textContent = (o.created_at || '').replace('T',' ').replace(/\.\d+Z?$/,'');
    tr.appendChild(tdTime);

    const tdId = document.createElement('td');
    tdId.textContent = o.order_id || '';
    tr.appendChild(tdId);

    const tdStreamer = document.createElement('td');
    tdStreamer.textContent = o.streamer_name || '';
    tr.appendChild(tdStreamer);

    const tdType = document.createElement('td');
    tdType.innerHTML = o.customer_type ? '<span class="pill">' + o.customer_type + '</span>' : '';
    tr.appendChild(tdType);

    const tdStatus = document.createElement('td');
    const spanSt = document.createElement('span');
    spanSt.className = statusClass(o.status);
    spanSt.textContent = o.status || '';
    tdStatus.appendChild(spanSt);
    tr.appendChild(tdStatus);

    const tdPay = document.createElement('td');
    tdPay.textContent = o.payment_method || '';
    tr.appendChild(tdPay);

    const tdTotal = document.createElement('td');
    tdTotal.className = 'num';
    tdTotal.textContent = money(o.total_amount || 0);
    tr.appendChild(tdTotal);

    const tdTrack = document.createElement('td');
    tdTrack.textContent = o.tracking_no || '';
    tr.appendChild(tdTrack);

    const tdShipFee = document.createElement('td');
    tdShipFee.className = 'num';
    tdShipFee.textContent = o.shipping_fee ? money(o.shipping_fee) : '';
    tr.appendChild(tdShipFee);

    const tdNote = document.createElement('td');
    tdNote.textContent = o.note || '';
    tr.appendChild(tdNote);

    const tdAct = document.createElement('td');
    const aShip = document.createElement('a');
    aShip.href = 'admin_ship.html?order_id=' + encodeURIComponent(o.order_id || '');
    aShip.className = 'link';
    aShip.target = '_blank';
    aShip.textContent = '出貨＋LINE';
    tdAct.appendChild(aShip);
    tr.appendChild(tdAct);

    bodyEl.appendChild(tr);
  }

  const sumEl = $('#summary');
  const totalOrders = list.length;
  sumEl.innerHTML = totalOrders ? (
    '<span>筆數：' + totalOrders + '（submitted: ' + countSubmitted +
    ' / paid: ' + countPaid + ' / shipped: ' + countShipped + ' / cancelled: ' + countCancelled + '）</span>' +
    '<span>合計金額：NT$ ' + money(sum) + '</span>'
  ) : '';
}

function exportCSV(){
  if (!ORDERS_CACHE.length){
    alert('目前沒有資料可以匯出。');
    return;
  }
  const rows = [];
  rows.push([
    'order_id','created_at','status','payment_method','total_amount',
    'streamer_name','customer_type','tracking_no','shipping_fee','note'
  ]);

  for (const o of ORDERS_CACHE){
    rows.push([
      o.order_id || '',
      o.created_at || '',
      o.status || '',
      o.payment_method || '',
      o.total_amount || 0,
      o.streamer_name || '',
      o.customer_type || '',
      o.tracking_no || '',
      o.shipping_fee || 0,
      (o.note || '').replace(/\r?\n/g, ' ')
    ]);
  }

  const csv = rows.map(r => r.map(escapeCSV).join(',')).join('\r\n');
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const now = new Date();
  const ts = now.toISOString().replace(/[:T]/g,'-').slice(0,16);
  a.href = url;
  a.download = 'murain_orders_' + ts + '.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
