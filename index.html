<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>MURAIN | Ê≤êÈõ®Á≤æÂìÅ‰ª£Ë≥º</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="description" content="MURAIN - ÁæéÂúãÁ≤æÂìÅ‰ª£Ë≥º COACH, MK, TB ËàáÂ∞àÊ•≠Ê≤ôÈæçÈ´ÆÂìÅ">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

  <style>
    /* --- Ê†∏ÂøÉËÆäÊï∏ --- */
    :root {
      --bg-color: #0a0a0a;
      --card-bg: #141414;
      --modal-bg: #1a1a1a;
      --text-main: #f0f0f0;
      --text-muted: #888888;
      --gold-primary: #D4AF37; 
      --gold-light: #F3E5AB;
      --border-color: rgba(255, 255, 255, 0.1);
      --nav-height: 56px;
      --font-serif: 'Playfair Display', serif;
      --font-sans: 'Lato', sans-serif;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      padding-bottom: calc(90px + env(safe-area-inset-bottom));
      overflow-x: hidden;
    }

    /* --- Â∞éË¶ΩÂàó (ÂçáÁ¥öÁâàÔºöÂê´ÊúÉÂì°ËàáÂõûÈ•ãÊåâÈàï) --- */
    .navbar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border-color);
      height: var(--nav-height);
      display: grid;
      grid-template-columns: 40px 1fr 40px; /* Â∑¶‰∏≠Âè≥‰ΩàÂ±Ä */
      align-items: center;
      padding: 0 16px;
    }
    
    .nav-icon-btn {
      background: transparent;
      border: none;
      color: var(--gold-primary);
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      width: 40px; height: 40px;
    }

    .brand-logo {
      font-family: var(--font-serif);
      font-size: 22px;
      letter-spacing: 0.15em;
      font-weight: 600;
      background: linear-gradient(135deg, var(--gold-light), var(--gold-primary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-transform: uppercase;
      text-align: center;
    }

    /* --- ‰∏ªË¶ñË¶∫ Hero --- */
    .hero-section {
      position: relative;
      height: 42vh;
      min-height: 320px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      background: linear-gradient(to bottom, rgba(0,0,0,0.3), var(--bg-color)), 
                  url('https://images.unsplash.com/photo-1483985988355-763728e1935b?q=80&w=2940&auto=format&fit=crop'); 
      background-size: cover;
      background-position: center 30%;
    }

    .hero-content {
      position: relative;
      z-index: 2;
      padding: 20px;
      max-width: 90%;
    }

    .hero-label {
      font-size: 10px;
      letter-spacing: 0.2em;
      color: var(--gold-light);
      text-transform: uppercase;
      margin-bottom: 8px;
      font-weight: 700;
    }

    .hero-title {
      font-family: var(--font-serif);
      font-size: 2.5rem;
      margin: 0 0 16px;
      font-weight: 500;
      color: #fff;
      line-height: 1.1;
      text-shadow: 0 2px 15px rgba(0,0,0,0.6);
    }

    .hero-desc-box {
      display: inline-block;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 16px;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(4px);
      border-radius: 99em;
    }

    .hero-subtitle {
      font-size: 0.8rem;
      letter-spacing: 0.05em;
      color: rgba(255,255,255,0.9);
      line-height: 1.4;
    }

    /* --- ÂìÅÁâåÁâÜ --- */
    .brand-scroll-wrapper {
      position: sticky;
      top: var(--nav-height);
      z-index: 90;
      background: rgba(10, 10, 10, 0.98);
      border-bottom: 1px solid transparent;
      transition: border-color 0.3s;
      padding: 16px 0 12px;
    }
    .brand-scroll-wrapper.stuck { border-bottom-color: var(--border-color); }

    .brand-list {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding: 0 16px;
      scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
    }
    .brand-list::-webkit-scrollbar { display: none; }

    .brand-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      min-width: 64px;
      flex-shrink: 0;
    }

    .brand-avatar {
      width: 58px;
      height: 58px;
      border-radius: 50%;
      background: linear-gradient(145deg, #1e1e1e, #111);
      border: 1px solid rgba(255,255,255,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    
    .brand-text-logo {
      font-family: var(--font-serif);
      font-size: 10px;
      font-weight: 700;
      color: var(--gold-light);
      text-align: center;
      line-height: 1.1;
      letter-spacing: 0.05em;
      padding: 4px;
    }

    .brand-name-label {
      font-size: 10px;
      color: var(--text-muted);
      letter-spacing: 0.05em;
      max-width: 70px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 500;
      transition: color 0.3s;
    }

    .brand-item.active .brand-avatar {
      border-color: var(--gold-primary);
      box-shadow: 0 0 0 2px var(--bg-color), 0 0 0 4px var(--gold-primary);
      background: #000;
    }
    .brand-item.active .brand-name-label {
      color: var(--gold-primary);
      font-weight: 700;
    }

    .brand-item.all-btn .brand-avatar {
      background: var(--gold-primary);
      border-color: var(--gold-primary);
    }
    .brand-item.all-btn .brand-text-logo {
      color: #000;
      font-size: 12px;
      font-weight: 800;
    }
    .brand-item.all-btn.active .brand-avatar {
      box-shadow: 0 0 0 2px var(--bg-color), 0 0 0 4px #fff;
    }

    /* --- ÂïÜÂìÅÂàóË°® --- */
    .container { max-width: 100%; padding: 0 12px; }
    .product-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding-bottom: 20px;
    }
    @media(min-width: 768px) {
      .container { padding: 0 24px; max-width: 1200px; margin: 0 auto; }
      .product-grid { gap: 24px; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); }
    }

    .product-card {
      background: var(--card-bg);
      border-radius: 6px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .img-wrapper {
      position: relative;
      width: 100%;
      padding-top: 100%;
      background: #1a1a1a;
      cursor: pointer;
    }

    .img-wrapper img {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }

    .detail-hint {
      position: absolute;
      bottom: 8px; right: 8px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 11px;
      pointer-events: none;
      backdrop-filter: blur(4px);
    }

    .card-info {
      padding: 12px 10px;
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .p-brand {
      font-size: 10px;
      color: var(--gold-primary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .p-title {
      font-size: 13px;
      line-height: 1.4;
      margin-bottom: 8px;
      font-weight: 400;
      color: #e0e0e0;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 2.8em;
    }

    .p-meta {
      display: flex;
      align-items: baseline;
      gap: 6px;
      margin-top: auto;
      flex-wrap: wrap;
    }

    .price-curr { font-family: var(--font-serif); font-size: 16px; color: #fff; font-weight: 600; }
    .price-orig { font-size: 11px; color: #666; text-decoration: line-through; }

    .btn-add-cart {
      margin-top: 12px;
      width: 100%; height: 38px;
      display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text-main); font-size: 12px;
      text-transform: uppercase; cursor: pointer;
      border-radius: 4px; transition: 0.2s;
    }
    .btn-add-cart:active { background: var(--gold-primary); color: #000; border-color: var(--gold-primary); }

    /* --- ÂïÜÂìÅË©≥ÊÉÖ Modal --- */
    .detail-modal {
      display: none;
      position: fixed; z-index: 2000;
      left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.8);
      backdrop-filter: blur(5px);
      align-items: flex-end;
      animation: fadeIn 0.3s ease;
    }
    @media(min-width: 768px) { .detail-modal { align-items: center; justify-content: center; } }
    
    .detail-modal.active { display: flex; }

    .detail-content {
      background: var(--modal-bg);
      width: 100%; max-width: 600px;
      height: 90vh;
      border-radius: 16px 16px 0 0;
      display: flex; flex-direction: column;
      position: relative;
      box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
      overflow: hidden;
      animation: slideUp 0.3s ease;
    }
    @media(min-width: 768px) {
      .detail-content { height: auto; max-height: 85vh; border-radius: 16px; }
    }
    @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }

    .detail-close {
      position: absolute; top: 12px; right: 12px;
      width: 32px; height: 32px;
      background: rgba(0,0,0,0.6); border-radius: 50%;
      color: #fff; font-size: 20px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; z-index: 20;
    }

    .detail-scroll-area {
      flex: 1; overflow-y: auto;
      padding-bottom: 20px;
    }

    /* Áï´ÂªäËº™Êí≠ */
    .detail-gallery {
      position: relative;
      width: 100%;
      aspect-ratio: 1 / 1; 
      background: #000;
      overflow: hidden;
    }
    .detail-main-img {
      width: 100%; height: 100%;
      object-fit: contain; 
      display: block;
      transition: opacity 0.3s ease;
    }
    
    .gallery-nav {
      position: absolute; top: 50%; transform: translateY(-50%);
      width: 40px; height: 40px;
      background: rgba(0,0,0,0.3);
      color: #fff; font-size: 20px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; border-radius: 50%;
      z-index: 10;
      user-select: none;
    }
    .gallery-nav.prev { left: 10px; }
    .gallery-nav.next { right: 10px; }
    .gallery-nav:active { background: rgba(255,255,255,0.2); }

    .gallery-dots {
      position: absolute; bottom: 12px; left: 0; right: 0;
      display: flex; justify-content: center; gap: 6px;
      z-index: 10;
    }
    .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: rgba(255,255,255,0.3); transition: 0.3s;
      cursor: pointer;
    }
    .dot.active { background: #fff; transform: scale(1.2); }

    .detail-info { padding: 20px; }
    .d-brand { color: var(--gold-primary); font-size: 12px; font-weight: 700; margin-bottom: 6px; letter-spacing: 0.1em; }
    .d-title { font-size: 18px; line-height: 1.4; margin-bottom: 12px; color: #fff; }
    .d-price { font-family: var(--font-serif); font-size: 24px; color: #fff; margin-bottom: 20px; }
    
    .d-section-title {
      font-size: 13px; color: var(--text-muted);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 8px; margin-bottom: 12px; margin-top: 24px;
      text-transform: uppercase; letter-spacing: 0.1em;
    }
    
    .d-description {
      font-size: 14px; line-height: 1.6; color: #ddd;
      white-space: pre-line;
    }

    .detail-actions {
      padding: 16px; border-top: 1px solid rgba(255,255,255,0.1);
      background: var(--modal-bg);
    }
    .btn-detail-add {
      width: 100%; padding: 14px; border: none; border-radius: 99em;
      background: linear-gradient(135deg, var(--gold-light), var(--gold-primary));
      color: #000; font-weight: 700; font-size: 14px; cursor: pointer;
    }

    /* --- Â∫ïÈÉ®Êá∏ÊµÆÁµêÂ∏≥Ê¢ù --- */
    .checkout-bar {
      position: fixed; bottom: 20px; left: 12px; right: 12px;
      bottom: calc(20px + env(safe-area-inset-bottom));
      max-width: 600px; margin: 0 auto;
      background: rgba(30, 30, 30, 0.95);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 99em;
      padding: 6px 6px 6px 20px;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
      z-index: 999;
      transform: translateY(150%);
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .checkout-bar.visible { transform: translateY(0); }
    .cart-actions { display: flex; align-items: center; gap: 12px; }
    .cart-count-badge {
      background: #fff; color: #000; font-weight: 800; font-size: 12px;
      height: 22px; min-width: 22px; padding: 0 6px; border-radius: 99em;
      display: flex; align-items: center; justify-content: center;
    }
    .btn-clear {
      background: transparent; border: 1px solid rgba(255,255,255,0.2);
      color: var(--text-muted); width: 32px; height: 32px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 14px;
    }
    .btn-checkout {
      background: linear-gradient(135deg, var(--gold-light), var(--gold-primary));
      border: none; padding: 0 24px; height: 44px;
      border-radius: 99em; color: #111; font-weight: 700;
      font-size: 13px; letter-spacing: 0.05em; cursor: pointer;
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2);
      display: flex; align-items: center; gap: 6px;
    }

    .toast-container {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: rgba(255,255,255,0.95); color: #111;
      padding: 16px 24px; border-radius: 12px;
      text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.8);
      z-index: 10000; opacity: 0; pointer-events: none;
      transition: all 0.2s ease; min-width: 160px;
    }
    .toast-container.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    .toast-icon { font-size: 28px; margin-bottom: 4px; display: block; }
    .toast-msg { font-size: 14px; font-weight: 600; }

    .loading-spinner {
      border: 2px solid rgba(255,255,255,0.1);
      border-top: 2px solid var(--gold-primary);
      border-radius: 50%; width: 30px; height: 30px;
      animation: spin 0.8s linear infinite; margin: 40px auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty-state { text-align: center; padding: 60px 0; color: var(--text-muted); font-size: 13px; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
  </style>
</head>
<body>

  <!-- Â∞éË¶ΩÂàóÔºöÂ∑¶ÈÇäÂ•ΩË©ïÊåâÈàï„ÄÅ‰∏≠Èñì Logo„ÄÅÂè≥ÈÇäÊúÉÂì°ÊåâÈàï -->
  <nav class="navbar">
    <button class="nav-icon-btn" onclick="openFeedbackPage()" title="È°ßÂÆ¢Â•ΩË©ï">
      ‚ô•
    </button>
    
    <div class="brand-logo">MURAIN</div>
    
    <button class="nav-icon-btn" onclick="openMemberLogin()" title="ÊúÉÂì°/LINE">
      üë§
    </button>
  </nav>

  <!-- ‰∏ªË¶ñË¶∫ -->
  <section class="hero-section">
    <div class="hero-content">
      <div class="hero-label">OFFICIAL ONLINE STORE</div>
      <h1 class="hero-title">Boutique<br>& Salon</h1>
      <div class="hero-desc-box">
        <div class="hero-subtitle">ÁæéÂúãÁ≤æÂìÅ‰ª£Ë≥ºÔºéCOACHÔºéMKÔºéTB<br>Â∞àÊ•≠È´ÆÂªäÈ´ÆÂìÅÂö¥ÈÅ∏</div>
      </div>
    </div>
  </section>

  <div id="brandBarWrapper" class="brand-scroll-wrapper">
    <div id="brandList" class="brand-list"></div>
  </div>

  <div class="container">
    <div id="loading" class="loading-spinner"></div>
    <div id="productList" class="product-grid"></div>
    <div id="emptyTip" class="empty-state" style="display:none;">ÁõÆÂâçÊö´ÁÑ°ÂïÜÂìÅÔºåË´ãÁ®çÂæåÂÜç‰æÜ</div>
  </div>

  <div class="checkout-bar" id="checkoutBar">
    <div class="cart-actions">
      <button class="btn-clear" id="clearCartBtn" title="Ê∏ÖÁ©∫Ë≥ºÁâ©Ëªä">üóëÔ∏è</button>
      <div class="cart-info">
        <span class="cart-count-badge" id="cartCount">0</span>
      </div>
    </div>
    <button class="btn-checkout" id="checkoutBtn">
      <span>ÂâçÂæÄÁµêÂ∏≥</span>
      <span>&rarr;</span>
    </button>
  </div>

  <div id="toast" class="toast-container">
    <span class="toast-icon">‚ú®</span>
    <div id="toastMsg" class="toast-msg">Â∑≤Âä†ÂÖ•Ë≥ºÁâ©Ëªä</div>
  </div>

  <!-- ÂïÜÂìÅË©≥ÊÉÖ Modal (ÁÑ°Ë©ïË´ñÂçÄ) -->
  <div id="productDetailModal" class="detail-modal">
    <div class="detail-content">
      <div class="detail-close" onclick="closeDetail()">√ó</div>
      
      <div class="detail-scroll-area">
        <div class="detail-gallery">
          <!-- Â∑¶Âè≥ÁÆ≠È†≠ -->
          <div class="gallery-nav prev" onclick="prevImage(event)">‚ùÆ</div>
          <div class="gallery-nav next" onclick="nextImage(event)">‚ùØ</div>
          
          <img id="detailImg" class="detail-main-img" src="" alt="">
          <div class="gallery-dots" id="galleryDots"></div>
        </div>
        
        <div class="detail-info">
          <div id="detailBrand" class="d-brand">BRAND</div>
          <div id="detailTitle" class="d-title">Title</div>
          <div id="detailPrice" class="d-price">NT$ 0</div>

          <div class="d-section-title">ÂïÜÂìÅ‰ªãÁ¥π Description</div>
          <div id="detailDesc" class="d-description"></div>
          
          <!-- Ë©ïË´ñÂçÄÂ∑≤ÁßªÈô§ -->
        </div>
      </div>

      <div class="detail-actions">
        <button class="btn-detail-add" id="detailAddBtn">Âä†ÂÖ•Ë≥ºÁâ©Ëªä ADD TO BAG</button>
      </div>
    </div>
  </div>

<script>
  const API_BASE      = 'https://api.murain.tw';
  const PRODUCT_API   = API_BASE + '/public/products';
  const CART_KEY      = 'MURAIN_WEB_CART_TOKEN';
  const LIFF_CHECKOUT = 'https://liff.line.me/2008430261-KLwoQjm4';
  
  // Ë´ãÂ∞áÊ≠§ËôïÊõøÊèõÁÇ∫ÊÇ®ÁöÑÂÆòÊñπ LINE ÈÄ£Áµê (‰æãÂ¶Ç https://line.me/R/ti/p/@YourID)
  const LINE_OFFICIAL_URL = 'https://line.me/'; 

  /* --- Mock Data --- */
  const mockProducts = [
    { 
      sku: 'C001', 
      brand:'COACH', 
      title: 'COACH Tabby 26 Á∂ìÂÖ∏CÂ≠óËÇ©ËÉåÂåÖ - Â•∂Ëå∂Ëâ≤', 
      price: 8800, 
      list_price: 16800, 
      category: 'BOUTIQUE', 
      image: 'https://images.unsplash.com/photo-1598532163257-ae3c6b2524b6?auto=format&fit=crop&q=80&w=600',
      images: [
        'https://images.unsplash.com/photo-1598532163257-ae3c6b2524b6?auto=format&fit=crop&q=80&w=600',
        'https://images.unsplash.com/photo-1591561954557-26941169b49e?auto=format&fit=crop&q=80&w=600'
      ],
      description: "Á∂ìÂÖ∏ Tabby Á≥ªÂàóÔºåÊé°Áî®ÊããÂÖâÈµùÂçµÁü≥È°ÜÁ≤íÁöÆÈù©Ë£Ω‰Ωú„ÄÇ\nÈôÑÂÖ©Ê¢ùÂèØÊãÜÂç∏ËÇ©Â∏∂ÔºåÂèØÊâãÊèê„ÄÅËÇ©ËÉåÊàñÊñúËÉå„ÄÇ"
    },
    { 
      sku: 'M001', 
      brand:'HAIR CARE', 
      title: 'Ê•µËá¥‰øÆË≠∑Êë©Ê¥õÂì•È´ÆÊ≤π 100ml (salonÁâà)', 
      price: 1280, 
      list_price: 1580, 
      category: 'HAIR', 
      image: 'https://images.unsplash.com/photo-1522337360788-8b13dee7a37e?auto=format&fit=crop&q=80&w=600',
      description: "ÈáùÂ∞çÂèóÊêçÈ´ÆË≥™Ë®≠Ë®àÔºåÂØåÂê´Á∂≠ÁîüÁ¥†EËàáËÑÇËÇ™ÈÖ∏„ÄÇ\nÁû¨ÈñìÂê∏Êî∂‰∏çÊ≤πËÜ©ÔºåÊîπÂñÑÊØõË∫ÅÂàÜÂ≤îÔºåËÆìÁßÄÈ´ÆÊÅ¢Âæ©ÂÖâÊæ§„ÄÇ"
    },
    { sku: 'K001', brand:'MICHAEL KORS', title: 'MK Èò≤ÂàÆÁöÆÈù©ÊªøÁâàÊâòÁâπÂåÖ - Ê∑±Ëóç', price: 4200, list_price: 12000, category: 'BOUTIQUE', image: 'https://images.unsplash.com/photo-1584917865442-de89df76afd3?auto=format&fit=crop&q=80&w=600', description: 'ËÄêÁî®Èò≤ÂàÆÁâõÁöÆÔºå‰∏äÁè≠ÊóèÈ¶ñÈÅ∏ÔºåÂèØË£ùA4Êñá‰ª∂„ÄÇ' },
    { sku: 'M002', brand:'HAIR CARE', title: 'Ê∑±Â±§‰øùÊøïÁ≤æÊ≤πÊ¥óÈ´ÆÁ≤æ 500ml', price: 880, list_price: 1080, category: 'HAIR', image: 'https://images.unsplash.com/photo-1556228720-1957be919424?auto=format&fit=crop&q=80&w=600', description: 'ÁÑ°ÁüΩÈùàÈÖçÊñπÔºåÊ∫´ÂíåÊ∏ÖÊΩîÈ†≠ÁöÆ„ÄÇ' },
    { sku: 'T001', brand:'TORY BURCH', title: 'TB Kira Chevron Áõ∏Ê©üÂåÖ - ÈªëËâ≤', price: 9500, list_price: 18500, category: 'BOUTIQUE', image: 'https://images.unsplash.com/photo-1548036328-c9fa89d128fa?auto=format&fit=crop&q=80&w=600', description: 'ÁæäÁöÆÊùêË≥™ÔºåË≥™ÊÑüÊ•µ‰Ω≥„ÄÇ' },
    { sku: 'KS01', brand:'KATE SPADE', title: 'Kate Spade Â∞ºÈæçÂæåËÉåÂåÖ - ÈªëËâ≤', price: 3800, list_price: 8800, category: 'BOUTIQUE', image: 'https://images.unsplash.com/photo-1605733513597-a8f8341084e6?auto=format&fit=crop&q=80&w=600', description: 'Ëºï‰æøÈò≤ÊΩëÊ∞¥ÔºåÊóÖÈÅäÂøÖÂÇô„ÄÇ' },
  ];

  let allItems  = [];
  let cartCount = 0;
  let cartToken = '';
  let isDemoMode = false;
  let currentDetailProduct = null; 
  let currentImgIdx = 0;
  let currentProductImages = [];

  const $ = (id) => document.getElementById(id);
  
  function showToast(msg, icon = '‚ú®') {
    const el = $('toast');
    $('toastMsg').textContent = msg;
    el.querySelector('.toast-icon').textContent = icon;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 1500);
  }

  /* --- Êñ∞Â¢ûÔºöÊúÉÂì°ËàáÂõûÈ•ãÈ†ÅÈù¢Ë∑≥ËΩâ --- */
  window.openMemberLogin = function() {
    // ÈÄôË£°Áõ¥Êé•Ë∑≥ËΩâÂà∞ÂÆòÊñπ LINEÔºåËß£Ê±∫ÂÆ¢‰∫∫‰∏çÁü•ÈÅìÊúâÊ≤íÊúâÂä†Â•ΩÂèãÁöÑÂïèÈ°å
    // ÈÄ≤ÂÖ• LINE ÂæåÔºåÂ¶ÇÊûúÊ≤íÂä†Â•ΩÂèãÊúÉÈ°ØÁ§∫Âä†ÂÖ•ÊåâÈàïÔºåÂ∑≤Âä†Â•ΩÂèãÂâáÊúÉÈÄ≤ÂÖ•ËÅäÂ§©ÂÆ§
    window.location.href = LINE_OFFICIAL_URL;
  }

  window.openFeedbackPage = function() {
    // Êú™‰æÜÂèØ‰ª•ÈÄ£ÁµêÂà∞Áç®Á´ãÁöÑÂ•ΩË©ïÁâÜÁ∂≤È†ÅÔºåÊàñ Instagram
    alert('Âç≥Â∞áÂâçÂæÄ„ÄåÈ°ßÂÆ¢Â•ΩË©ïË¶ãË≠â„ÄçÂ∞àÂçÄ (ÁØÑ‰æã)');
    // window.location.href = 'https://your-feedback-page.com'; 
  }

  /* --- ÂïÜÂìÅË©≥ÊÉÖ Modal ÈÇèËºØ (Â∑≤ÁßªÈô§Ë©ïË´ñ) --- */
  window.openProductDetail = function(product, event) {
    if(event) event.stopPropagation();
    currentDetailProduct = product;
    
    // Ë≥áÊñôÂ°´ÂÖÖ
    $('detailBrand').textContent = product.brand || 'MURAIN';
    $('detailTitle').textContent = product.title || product.sku;
    $('detailPrice').textContent = 'NT$ ' + (Number(product.price)).toLocaleString();
    $('detailDesc').textContent = product.description || 'Êö´ÁÑ°ÂïÜÂìÅ‰ªãÁ¥π';

    // ÂúñÁâáË®≠ÂÆö
    currentProductImages = product.images && product.images.length ? product.images : [product.image];
    currentImgIdx = 0;
    updateGalleryImage();

    $('detailAddBtn').onclick = () => {
        handleAddToCart(product.sku, product.price);
        closeDetail();
    };

    $('productDetailModal').classList.add('active');
    document.body.style.overflow = 'hidden';
  };

  window.closeDetail = function() {
    $('productDetailModal').classList.remove('active');
    document.body.style.overflow = '';
  };

  /* --- Áï´ÂªäËº™Êí≠ÊéßÂà∂ --- */
  function updateGalleryImage() {
    const imgEl = $('detailImg');
    const dotsEl = $('galleryDots');
    
    // Ë®≠ÂÆöÂúñÁâá
    imgEl.style.opacity = 0; // Ê∑°Âá∫
    setTimeout(() => {
        imgEl.src = currentProductImages[currentImgIdx];
        imgEl.style.opacity = 1; // Ê∑°ÂÖ•
    }, 150);

    // Ë®≠ÂÆöÈªûÈªû
    dotsEl.innerHTML = '';
    if (currentProductImages.length > 1) {
        currentProductImages.forEach((_, idx) => {
            const d = document.createElement('div');
            d.className = 'dot' + (idx === currentImgIdx ? ' active' : '');
            d.onclick = () => {
                currentImgIdx = idx;
                updateGalleryImage();
            };
            dotsEl.appendChild(d);
        });
        // È°ØÁ§∫ÁÆ≠È†≠
        document.querySelectorAll('.gallery-nav').forEach(el => el.style.display = 'flex');
    } else {
        // Èö±ËóèÁÆ≠È†≠
        document.querySelectorAll('.gallery-nav').forEach(el => el.style.display = 'none');
    }
  }

  window.prevImage = function(e) {
    if(e) e.stopPropagation();
    if (currentProductImages.length <= 1) return;
    currentImgIdx--;
    if (currentImgIdx < 0) currentImgIdx = currentProductImages.length - 1;
    updateGalleryImage();
  }

  window.nextImage = function(e) {
    if(e) e.stopPropagation();
    if (currentProductImages.length <= 1) return;
    currentImgIdx++;
    if (currentImgIdx >= currentProductImages.length) currentImgIdx = 0;
    updateGalleryImage();
  }

  /* --- Ê∏ÖÁ©∫Ë≥ºÁâ©Ëªä --- */
  function clearCart() {
    if(confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫Ë≥ºÁâ©ËªäÂóéÔºü')) {
      cartToken = '';
      localStorage.removeItem(CART_KEY);
      cartCount = 0;
      updateCartUI(0);
      showToast('Ë≥ºÁâ©ËªäÂ∑≤Ê∏ÖÁ©∫', 'üóëÔ∏è');
    }
  }

  async function jfetch(url, opt){
    try {
      const r = await fetch(url, Object.assign({ headers: { 'content-type': 'application/json' }}, opt || {}));
      if (!r.ok) throw new Error(r.statusText);
      const txt = await r.text();
      try { return JSON.parse(txt); } catch { return { raw: txt }; }
    } catch(e) {
      console.warn("Fetch Error", e);
      return { ok: false, error: e.message };
    }
  }

  function setCartToken(t){
    cartToken = t || '';
    try { localStorage.setItem(CART_KEY, cartToken); } catch(e){}
  }

  function updateCartUI(count){
    cartCount = count;
    $('cartCount').textContent = String(cartCount);
    const bar = $('checkoutBar');
    if (cartCount > 0) bar.classList.add('visible');
    else bar.classList.remove('visible');
  }

  async function restoreCartFromStorage(){
    let saved = '';
    try { saved = localStorage.getItem(CART_KEY) || ''; } catch(e){}
    if (!saved) return;
    try {
        const r = await fetch(`${API_BASE}/cart/${encodeURIComponent(saved)}`);
        if (r.ok) {
            const j = await r.json();
            if (Array.isArray(j.items)) {
                setCartToken(saved);
                let c = 0;
                j.items.forEach(it => c += Number(it.qty || 0));
                updateCartUI(c);
            }
        }
    } catch(e) {}
  }

  async function ensureCart(){
    if (cartToken) return cartToken;
    if (isDemoMode) return 'DEMO_TOKEN';
    let saved = '';
    try { saved = localStorage.getItem(CART_KEY) || ''; } catch(e){}
    if (saved) { setCartToken(saved); return cartToken; }

    const res = await jfetch(API_BASE + '/cart/create', {
      method: 'POST',
      body: JSON.stringify({ streamer_name: 'ÂÆòÁ∂≤', customer_type: 'web' })
    });
    
    if (res && res.cart_token) {
      setCartToken(res.cart_token);
      updateCartUI(0);
      return cartToken;
    } else {
      isDemoMode = true;
      return 'DEMO_TOKEN';
    }
  }

  async function fetchProducts(){
    const loader = $('loading');
    const grid = $('productList');
    const empty = $('emptyTip');
    try {
      loader.style.display = 'block';
      grid.innerHTML = '';
      const res = await fetch(PRODUCT_API);
      if (!res.ok) throw new Error("API Error");
      const json = await res.json();
      allItems = json.items || [];
    } catch (err) {
      console.log("Using Mock Data");
      allItems = mockProducts;
      isDemoMode = true;
    } finally {
        loader.style.display = 'none';
        if (allItems.length > 0) {
            renderBrandIcons(allItems);
            renderProducts(allItems);
            empty.style.display = 'none';
        } else {
            empty.style.display = 'block';
        }
    }
  }

  function renderBrandIcons(list){
    const wrapper = $('brandBarWrapper');
    const listEl = $('brandList');
    listEl.innerHTML = '';
    
    const brands = Array.from(new Set(list.map(it => it.brand || '').filter(Boolean)));
    
    const createItem = (label, isAll, filterFn) => {
      const item = document.createElement('div');
      item.className = `brand-item ${isAll ? 'all-btn active' : ''}`;
      
      const avatar = document.createElement('div');
      avatar.className = 'brand-avatar';
      
      const textLogo = document.createElement('div');
      textLogo.className = 'brand-text-logo';
      textLogo.textContent = label; 

      avatar.appendChild(textLogo);
      
      const nameLabel = document.createElement('span');
      nameLabel.className = 'brand-name-label';
      nameLabel.textContent = isAll ? 'ÂÖ®ÈÉ®' : label;

      item.appendChild(avatar);
      item.appendChild(nameLabel);
      
      item.onclick = () => {
        listEl.querySelectorAll('.brand-item').forEach(b => b.classList.remove('active'));
        item.classList.add('active');
        renderProducts(filterFn ? list.filter(filterFn) : list);
      };
      
      listEl.appendChild(item);
    };

    createItem('ALL', true, null);
    brands.forEach(b => {
      createItem(b, false, (it) => it.brand === b);
    });

    window.addEventListener('scroll', () => {
        if (window.scrollY > 10) wrapper.classList.add('stuck');
        else wrapper.classList.remove('stuck');
    });
  }

  function renderProducts(list){
    const wrap = $('productList');
    wrap.innerHTML = '';
    list.forEach(p => {
      const priceFmt = (Number(p.price || 0)).toLocaleString();
      const listPrice = Number(p.list_price || 0);
      const card = document.createElement('div');
      card.className = 'product-card';
      
      const imgUrl = p.image || ''; 
      const bgStyle = imgUrl ? `src="${imgUrl}"` : 'style="display:none"';
      const noImg = imgUrl ? '' : '<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#333;">MURAIN</div>';
      const brandHtml = p.brand ? `<div class="p-brand">${p.brand}</div>` : '';

      card.innerHTML = `
        <div class="img-wrapper">
          <img ${bgStyle} loading="lazy" alt="${p.title}">
          ${noImg}
          <div class="detail-hint">Êü•ÁúãË©≥ÊÉÖ</div>
        </div>
        <div class="card-info">
          <div>
            ${brandHtml}
            <div class="p-title">${p.title || p.sku}</div>
            <div class="p-meta">
              <span class="price-curr">NT$ ${priceFmt}</span>
              ${listPrice > p.price ? `<span class="price-orig">NT$ ${listPrice.toLocaleString()}</span>` : ''}
            </div>
          </div>
          <button class="btn-add-cart">Âä†ÂÖ•Ë≥ºÁâ©Ëªä</button>
        </div>
      `;
      
      card.querySelector('.img-wrapper').onclick = (e) => window.openProductDetail(p, e);
      card.querySelector('.btn-add-cart').onclick = (e) => {
          e.stopPropagation();
          handleAddToCart(p.sku, p.price);
      };

      wrap.appendChild(card);
    });
  }

  async function handleAddToCart(sku, price){
    if (!sku) return;
    showToast('ËôïÁêÜ‰∏≠...', '‚è≥');
    try {
      const token = await ensureCart();
      if (isDemoMode) {
          setTimeout(() => {
            cartCount++;
            updateCartUI(cartCount);
            showToast('Â∑≤Âä†ÂÖ•Ë≥ºÁâ©Ëªä', '‚ú®');
          }, 300);
          return;
      }
      const res = await jfetch(API_BASE + '/cart/add', {
        method: 'POST',
        body: JSON.stringify({ cart_token: token, sku: sku, qty: 1 })
      });

      if (res && res.items) {
        let c = 0;
        res.items.forEach(it => c += Number(it.qty || 0));
        updateCartUI(c);
        showToast('Â∑≤Âä†ÂÖ•Ë≥ºÁâ©Ëªä', '‚ú®');
      } else {
        cartCount++;
        updateCartUI(cartCount);
        showToast('Â∑≤Âä†ÂÖ•Ë≥ºÁâ©Ëªä (Ê®°Êì¨)', '‚ú®');
      }
    } catch(e) {
      showToast('ÈÄ£Á∑öÈåØË™§', '‚ö†Ô∏è');
    }
  }

  async function goCheckout(){
    if (!cartToken) await restoreCartFromStorage();
    if (isDemoMode || cartToken === 'DEMO_TOKEN') {
        alert('ÁõÆÂâçÁÇ∫ÊºîÁ§∫Ê®°ÂºèÔºåÁÑ°Ê≥ïË∑≥ËΩâÁµêÂ∏≥„ÄÇ');
        return;
    }
    if (!cartToken || cartCount <= 0) {
      showToast('Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ', 'üõí');
      return;
    }
    location.href = `${LIFF_CHECKOUT}?cart_token=${encodeURIComponent(cartToken)}`;
  }

  window.addEventListener('DOMContentLoaded', async () => {
    await restoreCartFromStorage();
    await fetchProducts();
    $('checkoutBtn').addEventListener('click', goCheckout);
    $('clearCartBtn').addEventListener('click', clearCart);
  });
</script>

</body>
</html>
