<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>MURAIN ä¸€é å¼å•†åŸ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #111;
      --card-bg: #1d1d1d;
      --text: #f7f7f7;
      --accent: #d4af37;
      --muted: #999;
      --border: #333;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: radial-gradient(circle at top, #222 0, #050505 55%);
      color: var(--text);
      min-height: 100vh;
    }
    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px 12px 80px;
    }
    .header {
      padding: 12px 4px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .brand {
      font-size: 20px;
      letter-spacing: 0.2em;
    }
    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.25);
      text-transform: uppercase;
    }
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
    }
    .product-card {
      background: rgba(0,0,0,0.7);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.06);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 220px;
    }
    .product-img-wrap {
      position: relative;
      padding-top: 70%;
      background: linear-gradient(135deg, #333, #111);
      overflow: hidden;
    }
    .product-img-wrap img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .product-body {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1;
    }
    .product-title {
      font-size: 14px;
      font-weight: 600;
      min-height: 2.8em;
    }
    .product-desc {
      font-size: 11px;
      color: var(--muted);
      max-height: 4.2em;
      overflow: hidden;
    }
    .price-row {
      display: flex;
      align-items: baseline;
      gap: 6px;
      margin-top: 4px;
    }
    .price-main {
      font-size: 15px;
      font-weight: 700;
      color: var(--accent);
    }
    .price-old {
      font-size: 11px;
      text-decoration: line-through;
      color: var(--muted);
    }
    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
      padding-top: 6px;
    }
    .pill {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--muted);
    }
    .btn {
      border: none;
      cursor: pointer;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      background: linear-gradient(135deg, #d4af37, #f5e2a0);
      color: #111;
    }
    .btn:active {
      transform: scale(0.97);
    }
    .footer-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 8px 16px 10px;
      background: rgba(5,5,5,0.95);
      border-top: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .footer-text {
      font-size: 11px;
      color: var(--muted);
    }
    .btn-primary {
      border-radius: 999px;
      padding: 8px 16px;
      border: none;
      background: linear-gradient(135deg, #f5e2a0, #d4af37);
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      cursor: pointer;
      color: #111;
    }
    .badge-cart {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
    }
    .empty-tip {
      font-size: 13px;
      color: var(--muted);
      padding: 20px 4px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <div>
        <div class="brand">MURAIN</div>
        <div style="font-size:11px;color:#aaa;margin-top:2px;">æ²é›¨ç²¾å“ï½œé«®å“ & ç²¾å“åš´é¸</div>
      </div>
      <div class="badge">ONLINE BOUTIQUE</div>
    </header>
    <div id="categoryBar" style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px;">
  <!-- é€™è£¡æœƒç”¨ JS å¡åˆ†é¡æŒ‰éˆ• -->
</div>

    <div id="productList" class="product-grid"></div>
    <div id="emptyTip" class="empty-tip" style="display:none;">
      ç›®å‰æ²’æœ‰ä¸Šæ¶çš„å•†å“ã€‚è«‹ç¨å¾Œå†ä¾†é€›é€› ğŸ–¤
    </div>
  </div>

  <div class="footer-bar">
    <div class="footer-text">
      <div>é¸å¥½å•†å“å¾Œï¼Œä¸€éµå¸¶ä½ åˆ°çµå¸³é å®Œæˆä»˜æ¬¾ã€‚</div>
      <div class="badge-cart">ğŸ›’ è³¼ç‰©è»Šå“é …ï¼š<span id="cartCount">0</span></div>
    </div>
    <button class="btn-primary" id="checkoutBtn">å‰å¾€çµå¸³</button>
  </div>

  <script>
  const API_BASE      = 'https://api.murain.tw';
  const PRODUCT_API   = API_BASE + '/public/products';
  const CART_KEY      = 'MURAIN_WEB_CART_TOKEN';
  const LIFF_CHECKOUT = 'https://liff.line.me/2008430261-KLwoQjm4';

  let allItems  = [];   // å…¨éƒ¨å•†å“
  let cartCount = 0;    // é¡¯ç¤ºç”¨
  let cartToken = '';   // å¾ API / localStorage å–å¾—

  // ---------- å°å·¥å…· ----------

  function $(id){ return document.getElementById(id); }

  async function jfetch(url, opt){
    const r   = await fetch(url, Object.assign({
      headers: { 'content-type': 'application/json' }
    }, opt || {}));
    const txt = await r.text();
    try { return JSON.parse(txt); } catch { return { raw: txt }; }
  }

  function setCartToken(t){
    cartToken = t || '';
    try { localStorage.setItem(CART_KEY, cartToken); } catch(e){}
  }

  function updateCartCountFromItems(items){
    let c = 0;
    (items || []).forEach(it => {
      c += Number(it.qty || 0);
    });
    cartCount = c;
    const el = $('cartCount');
    if (el) el.textContent = String(cartCount);
  }

  async function restoreCartFromStorage(){
    let saved = '';
    try { saved = localStorage.getItem(CART_KEY) || ''; } catch(e){}
    if (!saved) return;

    try{
      const r = await fetch(`${API_BASE}/cart/${encodeURIComponent(saved)}`);
      const j = await r.json();
      if (!r.ok || !Array.isArray(j.items)) {
        // æ‰¾ä¸åˆ°é€™å€‹ cartï¼Œå°±ç•¶ä½œå¤±æ•ˆ
        try { localStorage.removeItem(CART_KEY); } catch(e){}
        return;
      }
      setCartToken(saved);
      updateCartCountFromItems(j.items || []);
    }catch(e){
      console.warn('restoreCart error', e);
    }
  }

  async function ensureCart(){
    if (cartToken) return cartToken;

    // å…ˆå˜—è©¦é‚„åŸ
    let saved = '';
    try { saved = localStorage.getItem(CART_KEY) || ''; } catch(e){}
    if (saved) {
      try{
        const r = await fetch(`${API_BASE}/cart/${encodeURIComponent(saved)}`);
        const j = await r.json();
        if (r.ok && Array.isArray(j.items)) {
          setCartToken(saved);
          updateCartCountFromItems(j.items || []);
          return cartToken;
        }
      }catch(e){
        console.warn('check saved cart error', e);
      }
    }

    // æ²’æœ‰çš„è©±å°±æ–°å»ºä¸€å€‹ã€Œå®˜ç¶²ã€ç”¨è³¼ç‰©è»Š
    const res = await jfetch(API_BASE + '/cart/create', {
      method: 'POST',
      body: JSON.stringify({
        streamer_name: 'å®˜ç¶²',
        customer_type: 'web'
      })
    });
    if (!res || res.ok !== true || !res.cart_token) {
      throw new Error('å»ºç«‹è³¼ç‰©è»Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚');
    }
    setCartToken(res.cart_token);
    updateCartCountFromItems([]);
    return cartToken;
  }

  // ---------- è®€å•†å“ ----------

  async function fetchProducts(){
    try {
      const res  = await fetch(PRODUCT_API);
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'error');

      allItems = json.items || [];
      renderCategoryBar(allItems);
      renderProducts(allItems);

      if (!allItems.length) {
        const tip = $('emptyTip');
        if (tip) tip.style.display = 'block';
      }
    } catch (err) {
      console.error(err);
      const tip = $('emptyTip');
      if (tip) {
        tip.style.display = 'block';
        tip.textContent   = 'è®€å–å•†å“å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚';
      }
    }
  }

  // ---------- åˆ†é¡ bar ----------

  function renderCategoryBar(list){
    const bar = $('categoryBar');
    if (!bar) return;
    bar.innerHTML = '';

    const cats = Array.from(
      new Set(list.map(it => it.category || '').filter(Boolean))
    );

    const makeBtn = (label, catValue) => {
      const btn = document.createElement('button');
      btn.className = 'pill';
      btn.textContent = label;
      btn.addEventListener('click', () => {
        const active = bar.querySelector('.pill-active');
        if (active) active.classList.remove('pill-active');
        btn.classList.add('pill-active');

        if (!catValue) {
          renderProducts(allItems);
        } else {
          renderProducts(allItems.filter(it => (it.category || '') === catValue));
        }
      });
      return btn;
    };

    const allBtn = makeBtn('å…¨éƒ¨', '');
    allBtn.classList.add('pill-active');
    bar.appendChild(allBtn);

    cats.forEach(cat => {
      bar.appendChild(makeBtn(cat, cat));
    });
  }

  // ---------- å•†å“å¡ç‰‡ ----------

  function renderProducts(list){
    const wrap = $('productList');
    if (!wrap) return;
    wrap.innerHTML = '';

    if (!list.length) {
      const tip = $('emptyTip');
      if (tip) tip.style.display = 'block';
      return;
    } else {
      const tip = $('emptyTip');
      if (tip) tip.style.display = 'none';
    }

    list.forEach(p => {
      const card = document.createElement('div');
      card.className = 'card';

      const img = document.createElement('div');
      img.className = 'card-image';
      if (p.image) {
        img.style.backgroundImage = `url(${p.image})`;
        img.style.backgroundSize = 'cover';
        img.style.backgroundPosition = 'center';
      } else {
        img.innerHTML = '<span style="color:#666;font-size:11px;">No Image</span>';
      }

      const body = document.createElement('div');
      body.className = 'card-body';

      const title = document.createElement('div');
      title.className = 'card-title';
      title.textContent = p.title || p.sku;

      const desc = document.createElement('div');
      desc.className = 'card-desc';
      desc.textContent = p.description || '';

      const priceRow = document.createElement('div');
      priceRow.className = 'price-row';

      const price = document.createElement('div');
      price.className = 'price';
      price.textContent = 'NT$ ' + (Number(p.price || 0)).toLocaleString();

      const old = document.createElement('div');
      old.className = 'price-old';
      if (p.list_price && p.list_price > p.price) {
        old.textContent = 'NT$ ' + (Number(p.list_price || 0)).toLocaleString();
      } else {
        old.textContent = '';
      }
      priceRow.appendChild(price);
      priceRow.appendChild(old);

      const footer = document.createElement('div');
      footer.className = 'card-footer';

      const sku = document.createElement('div');
      sku.className = 'pill';
      sku.textContent = p.sku || '';

      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = 'åŠ å…¥è³¼ç‰©è»Š';
      btn.addEventListener('click', () => handleAddToCart(p.sku, p.price));

      footer.appendChild(sku);
      footer.appendChild(btn);

      body.appendChild(title);
      body.appendChild(desc);
      body.appendChild(priceRow);
      body.appendChild(footer);

      card.appendChild(img);
      card.appendChild(body);
      wrap.appendChild(card);
    });
  }

  // ---------- åŠ å…¥è³¼ç‰©è»Š ----------

  async function handleAddToCart(sku, price){
    if (!sku) return;
    try{
      const token = await ensureCart();
      const res = await jfetch(API_BASE + '/cart/add', {
        method: 'POST',
        body: JSON.stringify({
          cart_token: token,
          sku: sku,
          qty: 1
          // åƒ¹æ ¼ä¸å¸¶ï¼Œå¾Œç«¯æœƒç”¨ Products çš„ WebPrice
        })
      });

      if (!res || res.ok !== true) {
        alert('åŠ å…¥è³¼ç‰©è»Šå¤±æ•—ï¼š' + (res && res.error ? res.error : ''));
        return;
      }

      updateCartCountFromItems(res.items || []);

      alert('å·²åŠ å…¥è³¼ç‰©è»Šã€‚\n\nä¸‹ä¸€æ­¥è«‹é»å³ä¸‹è§’ã€Œå‰å¾€çµå¸³ã€ï¼Œåœ¨ LINE ä¸­å®Œæˆçµå¸³ã€‚');
    }catch(e){
      console.error(e);
      alert('åŠ å…¥è³¼ç‰©è»Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚');
    }
  }

  // ---------- å‰å¾€çµå¸³ï¼ˆæ‰“é–‹ LIFF é ï¼‰ ----------

  async function goCheckout(){
    try{
      if (!cartToken) {
        await restoreCartFromStorage();
      }

      if (!cartToken || cartCount <= 0) {
        alert('è«‹å…ˆé¸æ“‡å•†å“ï¼Œå†å‰å¾€çµå¸³ã€‚');
        return;
      }

      const url = `${LIFF_CHECKOUT}?cart_token=${encodeURIComponent(cartToken)}`;
      location.href = url;
    }catch(e){
      console.error(e);
      alert('ç„¡æ³•å‰å¾€çµå¸³ï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚');
    }
  }

  // ---------- åˆå§‹åŒ– ----------

  window.addEventListener('DOMContentLoaded', async () => {
    await restoreCartFromStorage();   // å…ˆæŠŠèˆŠè³¼ç‰©è»Šå¸¶å›ä¾†ï¼ˆå¦‚æœæœ‰ï¼‰
    await fetchProducts();            // å†è¼‰å•†å“

    const btn = $('checkoutBtn');
    if (btn) {
      btn.addEventListener('click', goCheckout);
    }
  });
</script>


</body>
</html>
