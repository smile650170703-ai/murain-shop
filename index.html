<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>MURAIN | æ²é›¨ç²¾å“ä»£è³¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="description" content="MURAIN - ç¾åœ‹ç²¾å“ä»£è³¼ COACH, MK, TB èˆ‡å°ˆæ¥­æ²™é¾é«®å“">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

  <style>
    /* --- æ ¸å¿ƒè®Šæ•¸ --- */
    :root {
      --bg-color: #0a0a0a;
      --card-bg: #141414;
      --text-main: #f0f0f0;
      --text-muted: #888888;
      --gold-primary: #D4AF37; 
      --gold-light: #F3E5AB;
      --border-color: rgba(255, 255, 255, 0.1);
      --nav-height: 56px;
      --font-serif: 'Playfair Display', serif;
      --font-sans: 'Lato', sans-serif;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      padding-bottom: calc(90px + env(safe-area-inset-bottom));
      overflow-x: hidden;
    }

    /* --- å°è¦½åˆ— --- */
    .navbar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border-color);
      height: var(--nav-height);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .brand-logo {
      font-family: var(--font-serif);
      font-size: 22px;
      letter-spacing: 0.15em;
      font-weight: 600;
      background: linear-gradient(135deg, var(--gold-light), var(--gold-primary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-transform: uppercase;
    }

    /* --- ä¸»è¦–è¦º Hero --- */
    .hero-section {
      position: relative;
      height: 38vh;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      background: linear-gradient(to bottom, rgba(0,0,0,0.4), var(--bg-color)), 
                  url('https://images.unsplash.com/photo-1483985988355-763728e1935b?q=80&w=2940&auto=format&fit=crop'); 
      background-size: cover;
      background-position: center 30%;
    }

    .hero-content {
      position: relative;
      z-index: 2;
      padding: 20px;
      max-width: 90%;
    }

    .hero-title {
      font-family: var(--font-serif);
      font-size: 2.2rem;
      margin: 0 0 12px;
      font-weight: 500;
      color: #fff;
      text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }

    .hero-subtitle {
      font-size: 0.85rem;
      letter-spacing: 0.1em;
      line-height: 1.6;
      color: rgba(255,255,255,0.9);
      text-transform: uppercase;
      border-top: 1px solid rgba(255,255,255,0.3);
      padding-top: 12px;
      display: inline-block;
    }

    /* --- æ–°ç‰ˆå“ç‰Œç‰† (IG Story Style) --- */
    .brand-scroll-wrapper {
      position: sticky;
      top: var(--nav-height);
      z-index: 90;
      background: rgba(10, 10, 10, 0.98); /* ç¨å¾®æ·±ä¸€é»é¿å…å¹²æ“¾ */
      border-bottom: 1px solid transparent;
      transition: border-color 0.3s;
      padding: 16px 0 12px;
    }
    .brand-scroll-wrapper.stuck { border-bottom-color: var(--border-color); }

    .brand-list {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding: 0 16px;
      scrollbar-width: none; /* Firefox */
      -webkit-overflow-scrolling: touch;
    }
    .brand-list::-webkit-scrollbar { display: none; }

    .brand-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      min-width: 64px; /* ç¢ºä¿æŒ‰éˆ•ä¸æœƒå¤ªæ“  */
      flex-shrink: 0;
    }

    /* åœ“å½¢å¾½ç«  */
    .brand-avatar {
      width: 58px;
      height: 58px;
      border-radius: 50%;
      background: linear-gradient(145deg, #1e1e1e, #111);
      border: 1px solid rgba(255,255,255,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    
    /* å“ç‰Œæ–‡å­— (Logo) */
    .brand-text-logo {
      font-family: var(--font-serif);
      font-size: 10px;
      font-weight: 700;
      color: var(--gold-light);
      text-align: center;
      line-height: 1.1;
      letter-spacing: 0.05em;
      padding: 4px;
    }

    /* å“ç‰Œåç¨± (ä¸‹æ–¹å°å­—) */
    .brand-name-label {
      font-size: 10px;
      color: var(--text-muted);
      letter-spacing: 0.05em;
      max-width: 70px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 500;
      transition: color 0.3s;
    }

    /* æ¿€æ´»ç‹€æ…‹ (Active) */
    .brand-item.active .brand-avatar {
      border-color: var(--gold-primary);
      box-shadow: 0 0 0 2px var(--bg-color), 0 0 0 4px var(--gold-primary); /* IGé¢¨å…‰åœˆ */
      background: #000;
    }
    .brand-item.active .brand-name-label {
      color: var(--gold-primary);
      font-weight: 700;
    }

    /* "ALL" æŒ‰éˆ•ç‰¹æ®Šæ¨£å¼ */
    .brand-item.all-btn .brand-avatar {
      background: var(--gold-primary);
      border-color: var(--gold-primary);
    }
    .brand-item.all-btn .brand-text-logo {
      color: #000;
      font-size: 12px;
      font-weight: 800;
    }
    .brand-item.all-btn.active .brand-avatar {
      box-shadow: 0 0 0 2px var(--bg-color), 0 0 0 4px #fff; /* ç™½è‰²å…‰åœˆ */
    }

    /* --- å•†å“åˆ—è¡¨ --- */
    .container {
      max-width: 100%;
      padding: 0 12px;
    }

    .product-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding-bottom: 20px;
    }
    
    @media(min-width: 768px) {
      .container { padding: 0 24px; max-width: 1200px; margin: 0 auto; }
      .product-grid { gap: 24px; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); }
    }

    /* --- å•†å“å¡ç‰‡ --- */
    .product-card {
      background: var(--card-bg);
      border-radius: 6px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .img-wrapper {
      position: relative;
      width: 100%;
      padding-top: 100%; /* 1:1 */
      background: #1a1a1a;
      cursor: zoom-in;
    }

    .img-wrapper img {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }

    .zoom-hint {
      position: absolute;
      bottom: 8px; right: 8px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      border-radius: 4px;
      padding: 4px;
      pointer-events: none;
      opacity: 0.7;
      font-size: 12px;
    }

    .card-info {
      padding: 12px 10px;
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .p-brand {
      font-size: 10px;
      color: var(--gold-primary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .p-title {
      font-size: 13px;
      line-height: 1.4;
      margin-bottom: 8px;
      font-weight: 400;
      color: #e0e0e0;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 2.8em;
    }

    .p-meta {
      display: flex;
      align-items: baseline;
      gap: 6px;
      margin-top: auto;
      flex-wrap: wrap;
    }

    .price-curr {
      font-family: var(--font-serif);
      font-size: 16px;
      color: #fff;
      font-weight: 600;
    }

    .price-orig {
      font-size: 11px;
      color: #666;
      text-decoration: line-through;
    }

    .btn-add-cart {
      margin-top: 12px;
      width: 100%;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text-main);
      font-size: 12px;
      text-transform: uppercase;
      cursor: pointer;
      border-radius: 4px;
      transition: 0.2s;
    }
    
    .btn-add-cart:active {
      background: var(--gold-primary);
      color: #000;
      border-color: var(--gold-primary);
    }

    /* --- åœ–ç‰‡æ”¾å¤§ Modal --- */
    .img-modal {
      display: none; 
      position: fixed; 
      z-index: 2000; 
      left: 0; top: 0;
      width: 100%; height: 100%; 
      background-color: rgba(0,0,0,0.95); 
      justify-content: center;
      align-items: center;
      padding: 20px;
      animation: fadeIn 0.2s ease;
    }
    .img-modal.active { display: flex; }
    .modal-content {
      max-width: 100%; max-height: 90vh;
      object-fit: contain;
      border-radius: 4px;
      box-shadow: 0 0 30px rgba(0,0,0,0.5);
    }
    .modal-close {
      position: absolute; top: 20px; right: 20px;
      color: #fff; font-size: 30px; font-weight: bold;
      cursor: pointer; z-index: 2001;
      width: 40px; height: 40px;
      display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
    }

    /* --- åº•éƒ¨æ‡¸æµ®çµå¸³æ¢ --- */
    .checkout-bar {
      position: fixed;
      bottom: 20px;
      left: 12px; right: 12px;
      bottom: calc(20px + env(safe-area-inset-bottom));
      max-width: 600px; margin: 0 auto;
      background: rgba(30, 30, 30, 0.95);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 99em;
      padding: 6px 6px 6px 20px;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
      z-index: 999;
      transform: translateY(150%);
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .checkout-bar.visible { transform: translateY(0); }

    .cart-actions { display: flex; align-items: center; gap: 12px; }
    .cart-count-badge {
      background: #fff; color: #000;
      font-weight: 800; font-size: 12px;
      height: 22px; min-width: 22px;
      padding: 0 6px; border-radius: 99em;
      display: flex; align-items: center; justify-content: center;
    }
    .btn-clear {
      background: transparent; border: 1px solid rgba(255,255,255,0.2);
      color: var(--text-muted); width: 32px; height: 32px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 14px;
    }
    .btn-checkout {
      background: linear-gradient(135deg, var(--gold-light), var(--gold-primary));
      border: none; padding: 0 24px; height: 44px;
      border-radius: 99em; color: #111; font-weight: 700;
      font-size: 13px; letter-spacing: 0.05em; cursor: pointer;
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2);
      display: flex; align-items: center; gap: 6px;
    }

    /* --- Toast & Loading --- */
    .toast-container {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: rgba(255,255,255,0.95); color: #111;
      padding: 16px 24px; border-radius: 12px;
      text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.8);
      z-index: 10000; opacity: 0; pointer-events: none;
      transition: all 0.2s ease; min-width: 160px;
    }
    .toast-container.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    .toast-icon { font-size: 28px; margin-bottom: 4px; display: block; }
    .toast-msg { font-size: 14px; font-weight: 600; }

    .loading-spinner {
      border: 2px solid rgba(255,255,255,0.1);
      border-top: 2px solid var(--gold-primary);
      border-radius: 50%; width: 30px; height: 30px;
      animation: spin 0.8s linear infinite; margin: 40px auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty-state { text-align: center; padding: 60px 0; color: var(--text-muted); font-size: 13px; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
  </style>
</head>
<body>

  <!-- å°è¦½åˆ— -->
  <nav class="navbar">
    <div class="brand-logo">MURAIN</div>
  </nav>

  <!-- ä¸»è¦–è¦º -->
  <section class="hero-section">
    <div class="hero-content">
      <h1 class="hero-title">Boutique & Salon</h1>
      <div class="hero-subtitle">ç¾åœ‹ä»£è³¼ï¼COACHï¼MKï¼TB<br>å°ˆæ¥­é«®å»Šé«®å“åš´é¸</div>
    </div>
  </section>

  <!-- æ–°ç‰ˆ IG é¢¨å“ç‰Œç‰† -->
  <div id="brandBarWrapper" class="brand-scroll-wrapper">
    <div id="brandList" class="brand-list">
      <!-- JS ç”Ÿæˆ -->
    </div>
  </div>

  <div class="container">
    <div id="loading" class="loading-spinner"></div>
    <div id="productList" class="product-grid"></div>
    
    <div id="emptyTip" class="empty-state" style="display:none;">
      ç›®å‰æš«ç„¡å•†å“ï¼Œè«‹ç¨å¾Œå†ä¾†
    </div>
  </div>

  <!-- åº•éƒ¨æ‡¸æµ®çµå¸³æ¢ -->
  <div class="checkout-bar" id="checkoutBar">
    <div class="cart-actions">
      <button class="btn-clear" id="clearCartBtn" title="æ¸…ç©ºè³¼ç‰©è»Š">ğŸ—‘ï¸</button>
      <div class="cart-info">
        <span class="cart-count-badge" id="cartCount">0</span>
      </div>
    </div>
    <button class="btn-checkout" id="checkoutBtn">
      <span>å‰å¾€çµå¸³</span>
      <span>&rarr;</span>
    </button>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast-container">
    <span class="toast-icon">âœ¨</span>
    <div id="toastMsg" class="toast-msg">å·²åŠ å…¥è³¼ç‰©è»Š</div>
  </div>

  <!-- åœ–ç‰‡æ”¾å¤§ Modal -->
  <div id="imgModal" class="img-modal" onclick="closeImage()">
    <span class="modal-close">&times;</span>
    <img class="modal-content" id="modalImg">
  </div>

<script>
  /* --- Config --- */
  const API_BASE      = 'https://api.murain.tw';
  const PRODUCT_API   = API_BASE + '/public/products';
  const CART_KEY      = 'MURAIN_WEB_CART_TOKEN';
  const LIFF_CHECKOUT = 'https://liff.line.me/2008430261-KLwoQjm4';

  /* --- Mock Data --- */
  const mockProducts = [
    { sku: 'C001', brand:'COACH', title: 'COACH Tabby 26 ç¶“å…¸Cå­—è‚©èƒŒåŒ… - å¥¶èŒ¶è‰²', price: 8800, list_price: 16800, category: 'BOUTIQUE', image: 'https://images.unsplash.com/photo-1598532163257-ae3c6b2524b6?auto=format&fit=crop&q=80&w=600' },
    { sku: 'M001', brand:'HAIR CARE', title: 'æ¥µè‡´ä¿®è­·æ‘©æ´›å“¥é«®æ²¹ 100ml (salonç‰ˆ)', price: 1280, list_price: 1580, category: 'HAIR', image: 'https://images.unsplash.com/photo-1522337360788-8b13dee7a37e?auto=format&fit=crop&q=80&w=600' },
    { sku: 'K001', brand:'MICHAEL KORS', title: 'MK é˜²åˆ®çš®é©æ»¿ç‰ˆæ‰˜ç‰¹åŒ… - æ·±è—', price: 4200, list_price: 12000, category: 'BOUTIQUE', image: 'https://images.unsplash.com/photo-1584917865442-de89df76afd3?auto=format&fit=crop&q=80&w=600' },
    { sku: 'M002', brand:'HAIR CARE', title: 'æ·±å±¤ä¿æ¿•ç²¾æ²¹æ´—é«®ç²¾ 500ml', price: 880, list_price: 1080, category: 'HAIR', image: 'https://images.unsplash.com/photo-1556228720-1957be919424?auto=format&fit=crop&q=80&w=600' },
    { sku: 'T001', brand:'TORY BURCH', title: 'TB Kira Chevron ç›¸æ©ŸåŒ… - é»‘è‰²', price: 9500, list_price: 18500, category: 'BOUTIQUE', image: 'https://images.unsplash.com/photo-1548036328-c9fa89d128fa?auto=format&fit=crop&q=80&w=600' },
    { sku: 'KS01', brand:'KATE SPADE', title: 'Kate Spade å°¼é¾å¾ŒèƒŒåŒ… - é»‘è‰²', price: 3800, list_price: 8800, category: 'BOUTIQUE', image: 'https://images.unsplash.com/photo-1605733513597-a8f8341084e6?auto=format&fit=crop&q=80&w=600' },
    { sku: 'MJ01', brand:'MARC JACOBS', title: 'MJ Snapshot ç›¸æ©ŸåŒ… - æ’è‰²æ¬¾', price: 7800, list_price: 14500, category: 'BOUTIQUE', image: 'https://images.unsplash.com/photo-1591561954557-26941169b49e?auto=format&fit=crop&q=80&w=600' },
    { sku: 'M003', brand:'HAIR CARE', title: 'çµ²æ»‘æŸ”é †è›‹ç™½è­·é«®è†œ (å—æé«®å°ˆç”¨)', price: 1450, list_price: 1800, category: 'HAIR', image: 'https://images.unsplash.com/photo-1571781565036-d3f7527f636b?auto=format&fit=crop&q=80&w=600' },
  ];

  let allItems  = [];
  let cartCount = 0;
  let cartToken = '';
  let isDemoMode = false;

  const $ = (id) => document.getElementById(id);
  
  function showToast(msg, icon = 'âœ¨') {
    const el = $('toast');
    $('toastMsg').textContent = msg;
    el.querySelector('.toast-icon').textContent = icon;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 1500);
  }

  /* --- åœ–ç‰‡æ”¾å¤§ --- */
  window.openImage = function(src, event) {
    if(event) event.stopPropagation();
    const modal = $('imgModal');
    const img = $('modalImg');
    img.src = src;
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
  }
  window.closeImage = function() {
    $('imgModal').classList.remove('active');
    document.body.style.overflow = '';
  }

  /* --- æ¸…ç©ºè³¼ç‰©è»Š --- */
  function clearCart() {
    if(confirm('ç¢ºå®šè¦æ¸…ç©ºè³¼ç‰©è»Šå—ï¼Ÿ')) {
      cartToken = '';
      localStorage.removeItem(CART_KEY);
      cartCount = 0;
      updateCartUI(0);
      showToast('è³¼ç‰©è»Šå·²æ¸…ç©º', 'ğŸ—‘ï¸');
    }
  }

  async function jfetch(url, opt){
    try {
      const r = await fetch(url, Object.assign({ headers: { 'content-type': 'application/json' }}, opt || {}));
      if (!r.ok) throw new Error(r.statusText);
      const txt = await r.text();
      try { return JSON.parse(txt); } catch { return { raw: txt }; }
    } catch(e) {
      console.warn("Fetch Error", e);
      return { ok: false, error: e.message };
    }
  }

  function setCartToken(t){
    cartToken = t || '';
    try { localStorage.setItem(CART_KEY, cartToken); } catch(e){}
  }

  function updateCartUI(count){
    cartCount = count;
    $('cartCount').textContent = String(cartCount);
    const bar = $('checkoutBar');
    if (cartCount > 0) bar.classList.add('visible');
    else bar.classList.remove('visible');
  }

  async function restoreCartFromStorage(){
    let saved = '';
    try { saved = localStorage.getItem(CART_KEY) || ''; } catch(e){}
    if (!saved) return;
    try {
        const r = await fetch(`${API_BASE}/cart/${encodeURIComponent(saved)}`);
        if (r.ok) {
            const j = await r.json();
            if (Array.isArray(j.items)) {
                setCartToken(saved);
                let c = 0;
                j.items.forEach(it => c += Number(it.qty || 0));
                updateCartUI(c);
            }
        }
    } catch(e) {}
  }

  async function ensureCart(){
    if (cartToken) return cartToken;
    if (isDemoMode) return 'DEMO_TOKEN';
    let saved = '';
    try { saved = localStorage.getItem(CART_KEY) || ''; } catch(e){}
    if (saved) { setCartToken(saved); return cartToken; }

    const res = await jfetch(API_BASE + '/cart/create', {
      method: 'POST',
      body: JSON.stringify({ streamer_name: 'å®˜ç¶²', customer_type: 'web' })
    });
    
    if (res && res.cart_token) {
      setCartToken(res.cart_token);
      updateCartUI(0);
      return cartToken;
    } else {
      isDemoMode = true;
      return 'DEMO_TOKEN';
    }
  }

  async function fetchProducts(){
    const loader = $('loading');
    const grid = $('productList');
    const empty = $('emptyTip');
    try {
      loader.style.display = 'block';
      grid.innerHTML = '';
      const res = await fetch(PRODUCT_API);
      if (!res.ok) throw new Error("API Error");
      const json = await res.json();
      allItems = json.items || [];
    } catch (err) {
      console.log("Using Mock Data");
      allItems = mockProducts;
      isDemoMode = true;
    } finally {
        loader.style.display = 'none';
        if (allItems.length > 0) {
            renderBrandIcons(allItems);
            renderProducts(allItems);
            empty.style.display = 'none';
        } else {
            empty.style.display = 'block';
        }
    }
  }

  /* --- æ–°ç‰ˆï¼šç”Ÿæˆåœ“å½¢å“ç‰Œåœ–ç¤º --- */
  function renderBrandIcons(list){
    const wrapper = $('brandBarWrapper');
    const listEl = $('brandList');
    listEl.innerHTML = '';
    
    const brands = Array.from(new Set(list.map(it => it.brand || '').filter(Boolean)));
    
    // å»ºç«‹å–®å€‹å“ç‰Œ Item
    const createItem = (label, isAll, filterFn) => {
      const item = document.createElement('div');
      item.className = `brand-item ${isAll ? 'all-btn active' : ''}`;
      
      // åœ“å½¢
      const avatar = document.createElement('div');
      avatar.className = 'brand-avatar';
      
      // å…§éƒ¨æ–‡å­— (å¦‚æœä¹‹å¾Œæœ‰ Logo URL å¯ä»¥æ”¹æˆ img)
      const textLogo = document.createElement('div');
      textLogo.className = 'brand-text-logo';
      // å¦‚æœå“ç‰Œåå¤ªé•·ï¼Œå¯ä»¥è€ƒæ…®æ–·è¡Œï¼Œé€™è£¡ç°¡å–®åšç¸®æ”¾
      textLogo.textContent = label; 

      avatar.appendChild(textLogo);
      
      // ä¸‹æ–¹åç¨±
      const nameLabel = document.createElement('span');
      nameLabel.className = 'brand-name-label';
      nameLabel.textContent = isAll ? 'å…¨éƒ¨' : label;

      item.appendChild(avatar);
      item.appendChild(nameLabel);
      
      item.onclick = () => {
        // ç§»é™¤å…¶ä»– Active
        listEl.querySelectorAll('.brand-item').forEach(b => b.classList.remove('active'));
        item.classList.add('active');
        renderProducts(filterFn ? list.filter(filterFn) : list);
      };
      
      listEl.appendChild(item);
    };

    // 1. ALL
    createItem('ALL', true, null);

    // 2. Brands
    brands.forEach(b => {
      createItem(b, false, (it) => it.brand === b);
    });

    // æ»¾å‹•æ•ˆæœ
    window.addEventListener('scroll', () => {
        if (window.scrollY > 10) wrapper.classList.add('stuck');
        else wrapper.classList.remove('stuck');
    });
  }

  function renderProducts(list){
    const wrap = $('productList');
    wrap.innerHTML = '';
    list.forEach(p => {
      const priceFmt = (Number(p.price || 0)).toLocaleString();
      const listPrice = Number(p.list_price || 0);
      const card = document.createElement('div');
      card.className = 'product-card';
      
      const imgUrl = p.image || ''; 
      const bgStyle = imgUrl ? `src="${imgUrl}"` : 'style="display:none"';
      const noImg = imgUrl ? '' : '<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#333;">MURAIN</div>';
      const brandHtml = p.brand ? `<div class="p-brand">${p.brand}</div>` : '';

      card.innerHTML = `
        <div class="img-wrapper" onclick="openImage('${imgUrl}', event)">
          <img ${bgStyle} loading="lazy" alt="${p.title}">
          ${noImg}
          <div class="zoom-hint">ğŸ”</div>
        </div>
        <div class="card-info">
          <div>
            ${brandHtml}
            <div class="p-title">${p.title || p.sku}</div>
            <div class="p-meta">
              <span class="price-curr">NT$ ${priceFmt}</span>
              ${listPrice > p.price ? `<span class="price-orig">NT$ ${listPrice.toLocaleString()}</span>` : ''}
            </div>
          </div>
          <button class="btn-add-cart" onclick="handleAddToCart('${p.sku}', ${p.price})">åŠ å…¥è³¼ç‰©è»Š</button>
        </div>
      `;
      wrap.appendChild(card);
    });
  }

  async function handleAddToCart(sku, price){
    if (!sku) return;
    showToast('è™•ç†ä¸­...', 'â³');
    try {
      const token = await ensureCart();
      if (isDemoMode) {
          setTimeout(() => {
            cartCount++;
            updateCartUI(cartCount);
            showToast('å·²åŠ å…¥è³¼ç‰©è»Š', 'âœ¨');
          }, 300);
          return;
      }
      const res = await jfetch(API_BASE + '/cart/add', {
        method: 'POST',
        body: JSON.stringify({ cart_token: token, sku: sku, qty: 1 })
      });

      if (res && res.items) {
        let c = 0;
        res.items.forEach(it => c += Number(it.qty || 0));
        updateCartUI(c);
        showToast('å·²åŠ å…¥è³¼ç‰©è»Š', 'âœ¨');
      } else {
        cartCount++;
        updateCartUI(cartCount);
        showToast('å·²åŠ å…¥è³¼ç‰©è»Š (æ¨¡æ“¬)', 'âœ¨');
      }
    } catch(e) {
      showToast('é€£ç·šéŒ¯èª¤', 'âš ï¸');
    }
  }

  async function goCheckout(){
    if (!cartToken) await restoreCartFromStorage();
    if (isDemoMode || cartToken === 'DEMO_TOKEN') {
        alert('ç›®å‰ç‚ºæ¼”ç¤ºæ¨¡å¼ï¼Œç„¡æ³•è·³è½‰çµå¸³ã€‚');
        return;
    }
    if (!cartToken || cartCount <= 0) {
      showToast('è³¼ç‰©è»Šæ˜¯ç©ºçš„', 'ğŸ›’');
      return;
    }
    location.href = `${LIFF_CHECKOUT}?cart_token=${encodeURIComponent(cartToken)}`;
  }

  window.addEventListener('DOMContentLoaded', async () => {
    await restoreCartFromStorage();
    await fetchProducts();
    $('checkoutBtn').addEventListener('click', goCheckout);
    $('clearCartBtn').addEventListener('click', clearCart);
  });
</script>

</body>
</html>
