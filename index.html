<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MURAIN ??Ë≥?Æ∂?ãÂñÆ v5.1</title>
    <style>
        body { font-family: system-ui, sans-serif; display: grid; place-items: center; min-height: 90vh; background-color: #f4f4f5; }
        .container { background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 2rem 3rem; width: 90%; max-width: 500px; }
        h1 { margin-top: 0; color: #333; text-align: center; }
        button { font-size: 1.1rem; padding: 12px 20px; border: none; background-color: #007aff; color: white; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; width: 100%; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; }
        .btn-deposit { background-color: #ffc107; color: black; } /* (v5) */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        #status, #cart-link { margin-top: 1rem; font-weight: bold; text-align: center; word-break: break-all; }
        .hidden { display: none; }
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .op-field { border-left: 3px solid #007aff; padding-left: 10px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>?¥Êí≠‰∏ªÈ??ÆÁ≥ªÁµ?(v5.1)</h1>

        <div id="step1">
            <div class="form-group">
                <label for="streamer_name">‰∏ªÊí≠?çÁ®± (Q4)</label>
                <input type="text" id="streamer_name" placeholder="Ë´ãËº∏?•ÊÇ®?ÑÂ?Á®?>
            </div>
            <button id="createCartBtn">1. Âª∫Á? [‰∏Ä?¨ÂÆ¢‰∫∫] ÁµêÂ∏≥??/button>
            <button id="createDepositBtn" class="btn-deposit">1. Âª∫Á? [?∞ÂÆ¢Ë®ÇÈ?] ÁµêÂ∏≥??/button>
            <p id="status1"></p>
        </div>

        <div id="step2" class="hidden">
            <h3 id="cart-title">Ë≥ºÁâ©Ëª?(OD...)</h3>
            <div class="form-group">
                <label for="barcode">?ÜÂ? Barcode</label>
                <input type="text" id="barcode" placeholder="Ëº∏ÂÖ•?ÜÂ? Barcode...">
            </div>
            <div class="two-col">
                <div class="form-group">
                    <label for="qty">?∏È?</label>
                    <input type="number" id="qty" value="1" min="1">
                </div>
                <div class="form-group">
                    <label for="op_key">‰∏ªÊí≠ÂØÜÁ¢º (OP Key)</label>
                    <input type="password" id="op_key" placeholder="(?∏Â°´)">
                </div>
            </div>
            <div class="form-group op-field hidden" id="override_field">
                <label for="override_price">Ë¶ÜÂØ´?πÊ†º (Â°?0 = Ë¥àÂ?)</label>
                <input type="number" id="override_price" placeholder="Ëº∏ÂÖ•Ê≠§Â??Å„ÄåÂñÆ?π„Ä?..">
            </div>
            <button id="addItemBtn">2. ?†ÂÖ•?ÜÂ?</button>
            <p id="status2"></p>
            
            <hr style="border:0; border-top: 1px solid #eee; margin: 2rem 0;">

            <div class="form-group">
                <label for="gift_notes">Ë¥àÂ?/Ë®ÇÂñÆ?ôË®ª (Q3)</label>
                <textarea id="gift_notes" rows="3" placeholder="(?∏Â°´) Ëº∏ÂÖ•Ë¥àÂ?Ë≥áË??ñË??ÆÂ?Ë®?.."></textarea>
            </div>
            <button id="saveNotesBtn">?≤Â??ôË®ª</button>
            <p id="status3"></p>
        </div>
        
        <div id="step3" class="hidden">
            <h3>??ÁµêÂ∏≥???Â∑≤Áî¢??/h3>
            <p>Ë´ãË?Ë£ΩÊ≠§????≥ÈÄÅÁµ¶ÂÆ¢‰∫∫Ôº?/p>
            <input type="text" id="cart-link" readonly>
            <button id="copyBtn">Ë§áË£Ω???</button>
        </div>
    </div>

    <script>
        const API_ENDPOINT = 'https://murain-api.smile650170703.workers.dev';
        let CURRENT_CART_TOKEN = null;

        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const status1 = document.getElementById('status1');
        const status2 = document.getElementById('status2');
        const status3 = document.getElementById('status3');
        const opKeyInput = document.getElementById('op_key');
        const overrideField = document.getElementById('override_field');

        opKeyInput.addEventListener('input', () => {
            if (opKeyInput.value.trim() !== '') {
                overrideField.classList.remove('hidden');
            } else {
                overrideField.classList.add('hidden');
            }
        });

        // --- (v5) Ê≠•È?‰∏ÄÔºöÂª∫Á´ãË≥º?©Ë? (?±Áî®?ΩÂ?) ---
        async function createCart(customerType) {
            const btn1 = document.getElementById('createCartBtn');
            const btn2 = document.getElementById('createDepositBtn');
            btn1.disabled = true;
            btn2.disabled = true;
            status1.textContent = 'Âª∫Á?‰∏?..';
            
            const streamerName = document.getElementById('streamer_name').value;
            if (!streamerName) {
                 status1.textContent = 'Ë´ãÂ?Ëº∏ÂÖ•‰∏ªÊí≠?çÁ®±';
                 status1.style.color = 'red';
                 btn1.disabled = false;
                 btn2.disabled = false;
                 return;
            }

            try {
                // (v5) ?ºÂè´ÂæåÁ´Ø /cart/create APIÔºå‰∏¶?≥ÈÄÅÈ???
                const res = await fetch(`${API_ENDPOINT}/cart/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        streamer_name: streamerName, // (Q4)
                        customer_type: customerType  // (Q5)
                    })
                });
                
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                CURRENT_CART_TOKEN = data.cart_token;
                document.getElementById('cart-title').textContent = `Ë≥ºÁâ©Ëª?(${data.order_id})`;
                step1.classList.add('hidden');
                step2.classList.remove('hidden');
                step3.classList.remove('hidden');
                
                // (v5) È°ØÁ§∫?åÊ≠£Á¢∫„ÄçÁ?ÁµêÂ∏≥??? (checkout ??shipping)
                document.getElementById('cart-link').value = (new URL(data.share_url, window.location.href)).href;

            } catch (err) {
                status1.textContent = `Âª∫Á?Â§±Ê?: ${err.message}`;
                status1.style.color = 'red';
                btn1.disabled = false;
                btn2.disabled = false;
            }
        }
        
        // (v5) Á∂ÅÂ??©ÂÄã‰??åÁ?Âª∫Á??âÈ?
        document.getElementById('createCartBtn').addEventListener('click', () => createCart('OLD')); // ?äÂÆ¢
        document.getElementById('createDepositBtn').addEventListener('click', () => createCart('DEPOSIT')); // ?∞ÂÆ¢Ë®ÇÈ?


        // --- Ê≠•È?‰∫åÔ??†ÂÖ•?ÜÂ? (v4) ---
        document.getElementById('addItemBtn').addEventListener('click', async () => {
            const btn = document.getElementById('addItemBtn');
            const barcode = document.getElementById('barcode').value;
            const qty = parseInt(document.getElementById('qty').value, 10);
            const op_key = document.getElementById('op_key').value;
            let payload = { barcode: barcode, qty: qty };
            if (!barcode || qty < 1) { status2.textContent = 'Ë´ãËº∏?•Ê≠£Á¢∫Á? Barcode ?åÊï∏??; status2.style.color = 'red'; return; }
            if (op_key) {
                payload.op_key = op_key;
                const price = document.getElementById('override_price').value;
                if (price !== '') { payload.override_price = parseInt(price, 10); }
            }
            btn.disabled = true;
            status2.textContent = '?†ÂÖ•‰∏?..';
            try {
                const res = await fetch(`${API_ENDPOINT}/cart/${CURRENT_CART_TOKEN}/add`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                status2.textContent = `?†ÂÖ•?êÂ?Ôº?Á∏ΩÈ?È°? ${data.total_amount})`;
                status2.style.color = 'green';
                document.getElementById('barcode').value = '';
                document.getElementById('qty').value = 1;
                document.getElementById('override_price').value = '';
            } catch (err) {
                status2.textContent = `?†ÂÖ•Â§±Ê?: ${err.message}`;
                status2.style.color = 'red';
            } finally {
                btn.disabled = false;
            }
        });
        
        // --- ?≤Â??ôË®ª (v4) ---
        document.getElementById('saveNotesBtn').addEventListener('click', async () => {
            const btn = document.getElementById('saveNotesBtn');
            const op_key = document.getElementById('op_key').value;
            const gift_notes = document.getElementById('gift_notes').value;
            if (!op_key) { status3.textContent = '?≤Â??ôË®ª?ÄË¶Å‰∏ª?≠Â?Á¢?; status3.style.color = 'red'; return; }
            btn.disabled = true;
            status3.textContent = '?≤Â??ôË®ª‰∏?..';
            try {
                const res = await fetch(`${API_ENDPOINT}/cart/${CURRENT_CART_TOKEN}/update-notes`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ cart_token: CURRENT_CART_TOKEN, gift_notes, op_key })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                status3.textContent = '?ôË®ª?≤Â??êÂ?Ôº?;
                status3.style.color = 'green';
            } catch (err) {
                status3.textContent = `?≤Â?Â§±Ê?: ${err.message}`;
                status3.style.color = 'red';
            } finally {
                btn.disabled = false;
            }
        });
        
        // --- Ë§áË£Ω??? ---
        document.getElementById('copyBtn').addEventListener('click', () => {
             document.getElementById('cart-link').select();
             document.execCommand('copy');
             alert('Â∑≤Ë?Ë£ΩÁ?Â∏≥ÈÄ??Ôº?);
        });

    </script>
</body>
</html>
