<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>XUYUAN | ç²¾å“ä»£è³¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="description" content="XUYUAN - ç¾åœ‹ç²¾å“ä»£è³¼ COACH, MK, TB èˆ‡å°ˆæ¥­æ²™é¾é«®å“">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">

  <style>
    /* --- æ¥µç°¡æ ¸å¿ƒè®Šæ•¸ --- */
    :root {
      --bg-color: #050505;
      --card-bg: #111;
      --modal-bg: #141414;
      --text-main: #fff;
      --text-muted: #888;
      --gold-primary: #D4AF37; 
      --gold-light: #F3E5AB;
      --border-color: rgba(255, 255, 255, 0.08);
      --nav-height: 60px;
      --font-serif: 'Playfair Display', serif;
      --font-sans: 'Lato', sans-serif;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      padding-bottom: calc(90px + env(safe-area-inset-bottom));
      overflow-x: hidden;
    }

    /* --- æ¥µç°¡å°è¦½åˆ— --- */
    .navbar {
      position: fixed; /* æ”¹ç‚º fixed è®“å®ƒæµ®åœ¨ Hero ä¸Šé¢ */
      top: 0; left: 0; right: 0;
      z-index: 100;
      background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); /* æ¼¸å±¤é€æ˜ */
      height: var(--nav-height);
      display: grid;
      grid-template-columns: 40px 1fr 40px;
      align-items: center;
      padding: 0 20px;
      transition: background 0.3s;
    }
    /* æ»¾å‹•å¾Œè®Šå¯¦è‰²èƒŒæ™¯ */
    .navbar.scrolled {
      background: rgba(5, 5, 5, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-color);
    }
    
    .nav-icon-btn {
      background: transparent; border: none;
      color: #fff; font-size: 18px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      opacity: 0.8; transition: opacity 0.2s;
    }
    .nav-icon-btn:hover { opacity: 1; }

    .brand-logo {
      font-family: var(--font-serif);
      font-size: 20px;
      letter-spacing: 0.2em; /* åŠ å¤§å­—è· */
      font-weight: 500;
      color: #fff;
      text-transform: uppercase;
      text-align: center;
    }

    /* --- æ¥µç°¡å¥¢è¯ Hero Section --- */
    .hero-section {
      position: relative;
      height: 60vh; /* æ‹‰é«˜è¦–è¦ºæ¯”ä¾‹ */
      min-height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      /* èƒŒæ™¯åœ–ï¼šæ›´æ·±é‚ƒçš„é®ç½© */
      background: linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(5,5,5,1)), 
                  url('https://images.unsplash.com/photo-1483985988355-763728e1935b?q=80&w=2940&auto=format&fit=crop'); 
      background-size: cover;
      background-position: center 30%;
    }

    .hero-content {
      position: relative;
      z-index: 2;
      padding: 20px;
      max-width: 800px;
      margin-top: 20px;
    }

    /* å°æ¨™é¡Œï¼šç²¾ç·»ã€é‡‘è‰²ã€å…¨å¤§å¯« */
    .hero-label {
      font-size: 11px;
      letter-spacing: 0.3em;
      color: var(--gold-primary);
      text-transform: uppercase;
      margin-bottom: 16px;
      font-weight: 400;
      opacity: 0.9;
    }

    /* ä¸»æ¨™é¡Œï¼šå„ªé›…è¥¯ç·šé«” */
    .hero-title {
      font-family: var(--font-serif);
      font-size: 3.5rem; /* æ›´å¤§æ°£ */
      margin: 0 0 20px;
      font-weight: 400; /* ä¸ç”¨ç²—é«”ï¼Œå±•ç¾å„ªé›… */
      color: #fff;
      line-height: 1.1;
      font-style: italic; /* ç¾©å¤§åˆ©æ–œé«”æ›´æœ‰ç²¾å“æ„Ÿ */
    }
    
    /* å‰¯æ¨™é¡Œï¼šä¹¾æ·¨çš„ç„¡è¥¯ç·šé«” */
    .hero-subtitle {
      font-size: 13px;
      letter-spacing: 0.1em;
      color: rgba(255,255,255,0.7);
      line-height: 1.8;
      font-weight: 300;
      max-width: 400px;
      margin: 0 auto;
    }
    
    /* åˆ†éš”ç·š */
    .hero-divider {
      width: 40px; height: 1px;
      background: var(--gold-primary);
      margin: 20px auto;
      opacity: 0.6;
    }

    /* --- å“ç‰Œç‰† (å¾®èª¿èƒŒæ™¯è‰²) --- */
    .brand-scroll-wrapper {
      position: sticky;
      top: var(--nav-height);
      z-index: 90;
      background: rgba(5, 5, 5, 0.98); /* èˆ‡èƒŒæ™¯è‰²ä¸€è‡´ */
      border-bottom: 1px solid transparent;
      transition: border-color 0.3s;
      padding: 10px 0 16px; /* èª¿æ•´é–“è· */
    }
    .brand-scroll-wrapper.stuck { border-bottom-color: var(--border-color); }

    .brand-list {
      display: flex; gap: 18px;
      overflow-x: auto; padding: 0 20px;
      scrollbar-width: none; -webkit-overflow-scrolling: touch;
    }
    .brand-list::-webkit-scrollbar { display: none; }

    .brand-item {
      display: flex; flex-direction: column; align-items: center;
      gap: 8px; cursor: pointer; min-width: 60px; flex-shrink: 0;
    }

    /* ç¬¬äºŒæ’ï¼šå°åˆ†é¡åˆ— */
.subcat-row{
  margin-top: 10px;
  padding-top: 6px;
  padding-bottom: 2px;
  border-top: 1px solid rgba(255,255,255,0.06);
}

.subcat-row .brand-avatar{
  width: 46px;
  height: 46px;
}

.subcat-row .brand-text-logo{
  font-size: 8px;
}

.subcat-row .brand-name-label{
  font-size: 10px;
}

    /* å“ç‰Œåœ“åœˆï¼šæ›´ç´°çš„é‚Šæ¡† */
    .brand-avatar {
      width: 56px; height: 56px;
      border-radius: 50%;
      background: #111;
      border: 1px solid rgba(255,255,255,0.1);
      display: flex; align-items: center; justify-content: center;
      transition: all 0.3s ease;
    }
    .brand-text-logo {
      font-family: var(--font-serif);
      font-size: 9px; font-weight: 600;
      color: #aaa; text-align: center; letter-spacing: 0.05em;
    }
    .brand-name-label {
      font-size: 10px; color: #666; letter-spacing: 0.05em;
      max-width: 70px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }

    .brand-item.active .brand-avatar {
      border-color: var(--gold-primary);
      background: #000;
      box-shadow: 0 0 0 1px var(--gold-primary); /* æ¥µç´°é›™åœˆæ•ˆæœ */
    }
    .brand-item.active .brand-text-logo { color: var(--gold-primary); }
    .brand-item.active .brand-name-label { color: var(--gold-primary); }

    /* ALL æŒ‰éˆ• */
    .brand-item.all-btn .brand-avatar { border-color: var(--gold-primary); color: var(--gold-primary); }
    .brand-item.all-btn .brand-text-logo { color: var(--gold-primary); font-size: 11px; }
    .brand-item.all-btn.active .brand-avatar { background: var(--gold-primary); }
    .brand-item.all-btn.active .brand-text-logo { color: #000; }

    /* --- å•†å“åˆ—è¡¨ --- */
    .container { max-width: 1000px; margin: 0 auto; padding: 0 16px; }
    .product-grid {
      display: grid; grid-template-columns: repeat(2, 1fr);
      gap: 16px; row-gap: 32px; /* å¢åŠ è¡Œè·ï¼Œå‘¼å¸æ„Ÿ */
      padding-bottom: 40px;
    }
    @media(min-width: 768px) {
      .product-grid { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 30px; }
    }

    /* æ¥µç°¡å•†å“å¡ç‰‡ (å»é™¤é‚Šæ¡†èˆ‡èƒŒæ™¯è‰²ï¼Œå‡¸é¡¯åœ–ç‰‡) */
    .product-card {
      background: transparent;
      overflow: visible;
      display: flex; flex-direction: column;
    }

    .img-wrapper {
      position: relative; width: 100%; padding-top: 110%; /* ç¨å¾®é•·ä¸€é»çš„æ¯”ä¾‹æ›´æ™‚å°š */
      background: #111; margin-bottom: 12px;
      overflow: hidden;
    }
    .img-wrapper img {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%; object-fit: cover;
      transition: transform 0.6s ease;
    }
    /* åœ–ç‰‡æ‡¸æµ®å¾®æ”¾å¤§ */
    /* .img-wrapper:active img { transform: scale(1.03); } */

    .card-info { display: flex; flex-direction: column; flex: 1; }

    .p-brand {
      font-size: 10px; color: var(--gold-primary);
      text-transform: uppercase; letter-spacing: 0.1em;
      margin-bottom: 4px; opacity: 0.8;
    }
    .p-title {
      font-size: 13px; line-height: 1.5; margin-bottom: 6px;
      font-weight: 300; color: #ddd; letter-spacing: 0.02em;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }
    .p-price {
      font-family: var(--font-serif); font-size: 15px; color: #fff; letter-spacing: 0.05em;
    }

    /* éš±è—åŸç”ŸæŒ‰éˆ•ï¼Œé»æ“Šåœ–ç‰‡é€²å…¥è©³æƒ… */
    
    /* --- è©³æƒ… Modal (ç°¡ç´„ç‰ˆ) --- */
    .detail-modal {
      display: none; position: fixed; z-index: 2000;
      left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.9);
      backdrop-filter: blur(8px);
      align-items: flex-end;
      animation: fadeIn 0.3s ease;
    }
    @media(min-width: 768px) { .detail-modal { align-items: center; justify-content: center; } }
    .detail-modal.active { display: flex; }

    .detail-content {
      background: #111; width: 100%; max-width: 500px;
      height: 85vh; border-radius: 20px 20px 0 0;
      display: flex; flex-direction: column; position: relative;
      box-shadow: 0 -10px 50px rgba(0,0,0,0.8);
      animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @media(min-width: 768px) { .detail-content { height: auto; max-height: 80vh; border-radius: 4px; } }
    @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }

    .detail-close {
      position: absolute; top: 16px; right: 16px;
      width: 30px; height: 30px;
      color: #fff; font-size: 24px; font-weight: 300;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; z-index: 20; opacity: 0.7;
    }

    .detail-scroll-area { flex: 1; overflow-y: auto; }

    .detail-gallery {
      position: relative; width: 100%; aspect-ratio: 1/1;
      background: #000;
    }
    .detail-main-img { width: 100%; height: 100%; object-fit: contain; display: block; }
    
    /* ç°¡ç´„ç®­é ­ */
    .gallery-nav {
      position: absolute; top: 50%; transform: translateY(-50%);
      width: 44px; height: 100%;
      color: #fff; font-size: 24px; font-weight: 100;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; z-index: 10; opacity: 0; transition: opacity 0.2s;
    }
    .detail-gallery:hover .gallery-nav { opacity: 1; }
    .gallery-nav.prev { left: 0; background: linear-gradient(to right, rgba(0,0,0,0.5), transparent); }
    .gallery-nav.next { right: 0; background: linear-gradient(to left, rgba(0,0,0,0.5), transparent); }

    .gallery-dots {
      position: absolute; bottom: 16px; left: 0; right: 0;
      display: flex; justify-content: center; gap: 8px; z-index: 10;
    }
    .dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: rgba(255,255,255,0.2); transition: 0.3s;
    }
    .dot.active { background: #fff; transform: scale(1.2); }

    .detail-info { padding: 30px 24px; }
    .d-brand { font-size: 11px; letter-spacing: 0.15em; color: var(--gold-primary); text-transform: uppercase; margin-bottom: 8px; }
    .d-title { font-family: var(--font-serif); font-size: 22px; line-height: 1.3; color: #fff; margin-bottom: 12px; }
    .d-price { font-family: var(--font-serif); font-size: 20px; color: #ccc; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
    .d-desc { font-size: 13px; line-height: 1.8; color: #aaa; white-space: pre-line; letter-spacing: 0.03em; }

    .detail-actions {
      padding: 20px 24px; border-top: 1px solid rgba(255,255,255,0.05);
      background: #111;
    }
    .btn-detail-add {
      width: 100%; padding: 16px; border: none; border-radius: 2px;
      background: #fff; color: #000;
      font-size: 12px; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase;
      cursor: pointer; transition: background 0.2s;
    }
    .btn-detail-add:active { background: #ddd; }

    /* --- åº•éƒ¨çµå¸³æ¢ (æ¥µç°¡æ‡¸æµ®) --- */
    .checkout-bar {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150%);
      width: calc(100% - 40px); max-width: 400px;
      background: rgba(20, 20, 20, 0.9);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 99em;
      padding: 8px 8px 8px 24px;
      display: flex; justify-content: space-between; align-items: center;
      z-index: 99; transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    .checkout-bar.visible { transform: translateX(-50%) translateY(0); }

    .cart-info { font-size: 12px; letter-spacing: 0.05em; color: #fff; }
    .btn-clear { background: none; border: none; color: #666; font-size: 14px; margin-right: 12px; cursor: pointer; }
    .btn-checkout {
      background: var(--gold-primary); color: #000;
      border: none; padding: 10px 24px; border-radius: 99em;
      font-size: 11px; font-weight: 700; letter-spacing: 0.1em;
      text-transform: uppercase; cursor: pointer;
    }

    /* Toast */
    .toast {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
      background: rgba(255,255,255,0.95); color: #000;
      padding: 16px 32px; border-radius: 4px;
      font-size: 13px; letter-spacing: 0.05em; font-weight: 500;
      opacity: 0; pointer-events: none; z-index: 10000;
      transition: all 0.3s;
    }
    .toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }

    /* Loading */
    .loader {
      width: 100%; text-align: center; padding: 40px; color: #444;
      font-family: var(--font-serif); letter-spacing: 0.2em; font-size: 12px;
    }
    .empty { text-align: center; padding: 60px 0; color: #444; font-size: 12px; letter-spacing: 0.1em; }

  </style>
</head>
<body>

  <!-- å°è¦½åˆ— -->
  <nav class="navbar" id="navbar">
    <button class="nav-icon-btn" onclick="openFeedbackPage()" title="é¡§å®¢å¥½è©•">â™¥</button>
    <div class="brand-logo">XUYUAN</div>
    <button class="nav-icon-btn" onclick="openMemberLogin()" title="æœƒå“¡ä¸­å¿ƒ">ğŸ‘¤</button>
  </nav>

  <!-- ä¸»è¦–è¦º (æ¥µç°¡å¥¢è¯ç‰ˆ) -->
  <section class="hero-section">
    <div class="hero-content">
      <div class="hero-label">OFFICIAL BOUTIQUE</div>
      <h1 class="hero-title">Timeless<br>Elegance</h1>
      <div class="hero-divider"></div>
      <div class="hero-subtitle">
        COACH Â· MICHAEL KORS Â· TORY BURCH<br>
        ç¾åœ‹ç²¾å“ä»£è³¼ & å°ˆæ¥­é«®å“
      </div>
    </div>
  </section>

  <!-- å“ç‰Œç‰† -->
  <div id="brandBarWrapper" class="brand-scroll-wrapper">
  <div id="brandList" class="brand-list"></div>
  <div id="subcatList" class="brand-list subcat-row" style="display:none;"></div>
</div>

  <div class="container">
    <div id="loading" class="loader">è¼‰å…¥ä¸­...</div>
    <div id="productList" class="product-grid"></div>
    <div id="emptyTip" class="empty" style="display:none;">å³å°‡ä¸Šæ¶</div>
  </div>

  <!-- çµå¸³æ¢ -->
  <div class="checkout-bar" id="checkoutBar">
    <div style="display:flex;align-items:center;">
      <button class="btn-clear" id="clearCartBtn">âœ•</button>
      <span class="cart-info">è³¼ç‰©è»Š (<span id="cartCount">0</span>)</span>
    </div>
    <button class="btn-checkout" id="checkoutBtn">å‰å¾€çµå¸³</button>
  </div>

  <div id="toast" class="toast">å·²åŠ å…¥è³¼ç‰©è»Š</div>

  <!-- è©³æƒ… Modal -->
  <div id="productDetailModal" class="detail-modal">
    <div class="detail-content">
      <div class="detail-close" onclick="closeDetail()">âœ•</div>
      <div class="detail-scroll-area">
        <div class="detail-gallery">
          <div class="gallery-nav prev" onclick="prevImage(event)">â€¹</div>
          <div class="gallery-nav next" onclick="nextImage(event)">â€º</div>
          <img id="detailImg" class="detail-main-img" src="" alt="">
          <div class="gallery-dots" id="galleryDots"></div>
        </div>
        <div class="detail-info">
          <div id="detailBrand" class="d-brand">BRAND</div>
          <div id="detailTitle" class="d-title">Product Title</div>
          <div id="detailPrice" class="d-price">NT$ 0</div>
          <div id="detailDesc" class="d-desc"></div>
        </div>
      </div>
      <div class="detail-actions">
        <button class="btn-detail-add" id="detailAddBtn">åŠ å…¥è³¼ç‰©è»Š</button>
      </div>
    </div>
  </div>

<script>
  const API_BASE      = 'https://api.murain.tw';
  const PRODUCT_API   = API_BASE + '/public/products';
  const CART_KEY      = 'MURAIN_WEB_CART_TOKEN';
  const LIFF_CHECKOUT = 'https://liff.line.me/2008430261-KLwoQjm4';
  const LINE_OFFICIAL_URL = 'https://line.me/'; // æ›¿æ›æ‚¨çš„é€£çµ

  /* --- Mock Data (ä¸­æ–‡ç‰ˆ) --- */
  const mockProducts = [
    { 
      sku: 'C001', 
      brand:'COACH', 
      title: 'COACH Tabby 26 ç¶“å…¸Cå­—è‚©èƒŒåŒ… - å¥¶èŒ¶è‰²', 
      price: 8800, 
      list_price: 16800, 
      category: 'BOUTIQUE', 
      image: 'https://images.unsplash.com/photo-1598532163257-ae3c6b2524b6?auto=format&fit=crop&q=80&w=600',
      images: [
        'https://images.unsplash.com/photo-1598532163257-ae3c6b2524b6?auto=format&fit=crop&q=80&w=600',
        'https://images.unsplash.com/photo-1591561954557-26941169b49e?auto=format&fit=crop&q=80&w=600'
      ],
      description: "ç¶“å…¸ Tabby ç³»åˆ—ï¼Œæ¡ç”¨æ‹‹å…‰éµåµçŸ³é¡†ç²’çš®é©è£½ä½œã€‚\né™„å…©æ¢å¯æ‹†å¸è‚©å¸¶ï¼Œå¯æ‰‹æã€è‚©èƒŒæˆ–æ–œèƒŒã€‚"
    },
    { 
      sku: 'M001', 
      brand:'HAIR CARE', 
      title: 'æ¥µè‡´ä¿®è­·æ‘©æ´›å“¥é«®æ²¹ 100ml (salonç‰ˆ)', 
      price: 1280, 
      list_price: 1580, 
      category: 'HAIR', 
      image: 'https://images.unsplash.com/photo-1522337360788-8b13dee7a37e?auto=format&fit=crop&q=80&w=600',
      description: "é‡å°å—æé«®è³ªè¨­è¨ˆï¼Œå¯Œå«ç¶­ç”Ÿç´ Eèˆ‡è„‚è‚ªé…¸ã€‚\nç¬é–“å¸æ”¶ä¸æ²¹è†©ï¼Œæ”¹å–„æ¯›èºåˆ†å²”ï¼Œè®“ç§€é«®æ¢å¾©å…‰æ¾¤ã€‚"
    },
    { sku: 'K001', brand:'MICHAEL KORS', title: 'MK é˜²åˆ®çš®é©æ»¿ç‰ˆæ‰˜ç‰¹åŒ… - æ·±è—', price: 4200, list_price: 12000, category: 'BOUTIQUE', image: 'https://images.unsplash.com/photo-1584917865442-de89df76afd3?auto=format&fit=crop&q=80&w=600', description: 'è€ç”¨é˜²åˆ®ç‰›çš®ï¼Œä¸Šç­æ—é¦–é¸ï¼Œå¯è£A4æ–‡ä»¶ã€‚' },
    { sku: 'M002', brand:'HAIR CARE', title: 'æ·±å±¤ä¿æ¿•ç²¾æ²¹æ´—é«®ç²¾ 500ml', price: 880, list_price: 1080, category: 'HAIR', image: 'https://images.unsplash.com/photo-1556228720-1957be919424?auto=format&fit=crop&q=80&w=600', description: 'ç„¡çŸ½éˆé…æ–¹ï¼Œæº«å’Œæ¸…æ½”é ­çš®ã€‚' },
    { sku: 'T001', brand:'TORY BURCH', title: 'TB Kira Chevron ç›¸æ©ŸåŒ… - é»‘è‰²', price: 9500, list_price: 18500, category: 'BOUTIQUE', image: 'https://images.unsplash.com/photo-1548036328-c9fa89d128fa?auto=format&fit=crop&q=80&w=600', description: 'ç¾Šçš®æè³ªï¼Œè³ªæ„Ÿæ¥µä½³ã€‚' },
    { sku: 'KS01', brand:'KATE SPADE', title: 'Kate Spade å°¼é¾å¾ŒèƒŒåŒ… - é»‘è‰²', price: 3800, list_price: 8800, category: 'BOUTIQUE', image: 'https://images.unsplash.com/photo-1605733513597-a8f8341084e6?auto=format&fit=crop&q=80&w=600', description: 'è¼•ä¾¿é˜²æ½‘æ°´ï¼Œæ—…éŠå¿…å‚™ã€‚' },
  ];

  let allItems  = [];
  let cartCount = 0;
  let cartToken = '';
  let isDemoMode = false;
  let currentImgIdx = 0;
  let currentProductImages = [];

  const $ = (id) => document.getElementById(id);
  
  // Navbar æ»¾å‹•æ•ˆæœ
  window.addEventListener('scroll', () => {
    const nav = $('navbar');
    if(window.scrollY > 50) nav.classList.add('scrolled');
    else nav.classList.remove('scrolled');
    
    // å“ç‰Œç‰†å¸é ‚æ•ˆæœ
    const bar = $('brandBarWrapper');
    if(window.scrollY > window.innerHeight * 0.4) bar.classList.add('stuck');
    else bar.classList.remove('stuck');
  });

  function showToast(msg) {
    const el = $('toast');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 2000);
  }

  window.openMemberLogin = function() { window.location.href = LINE_OFFICIAL_URL; }
  window.openFeedbackPage = function() { alert('å³å°‡å‰å¾€ã€Œé¡§å®¢å¥½è©•ã€å°ˆå€'); }

  /* --- Detail Modal --- */
  window.openProductDetail = function(product) {
    $('detailBrand').textContent = formatBrandLine(product) || 'XUYUAN';
    $('detailTitle').textContent = product.title || product.sku;
    $('detailPrice').textContent = 'NT$ ' + (Number(product.price)).toLocaleString();
    $('detailDesc').textContent = product.description || '';

    currentProductImages = product.images && product.images.length ? product.images : [product.image];
    currentImgIdx = 0;
    updateGalleryImage();

    $('detailAddBtn').onclick = () => {
        handleAddToCart(product.sku, product.price);
        closeDetail();
    };
    $('productDetailModal').classList.add('active');
    document.body.style.overflow = 'hidden';
  };

  window.closeDetail = function() {
    $('productDetailModal').classList.remove('active');
    document.body.style.overflow = '';
  };

  function updateGalleryImage() {
    const imgEl = $('detailImg');
    const dotsEl = $('galleryDots');
    imgEl.style.opacity = 0;
    setTimeout(() => {
        imgEl.src = currentProductImages[currentImgIdx];
        imgEl.style.opacity = 1;
    }, 150);

    dotsEl.innerHTML = '';
    if (currentProductImages.length > 1) {
        currentProductImages.forEach((_, idx) => {
            const d = document.createElement('div');
            d.className = 'dot' + (idx === currentImgIdx ? ' active' : '');
            dotsEl.appendChild(d);
        });
    }
  }

  window.prevImage = function(e) {
    e.stopPropagation();
    if (currentProductImages.length <= 1) return;
    currentImgIdx--; if(currentImgIdx < 0) currentImgIdx = currentProductImages.length - 1;
    updateGalleryImage();
  }
  window.nextImage = function(e) {
    e.stopPropagation();
    if (currentProductImages.length <= 1) return;
    currentImgIdx++; if(currentImgIdx >= currentProductImages.length) currentImgIdx = 0;
    updateGalleryImage();
  }

  function clearCart() {
    if(confirm('ç¢ºå®šè¦æ¸…ç©ºè³¼ç‰©è»Šå—ï¼Ÿ')) {
      cartToken = ''; localStorage.removeItem(CART_KEY);
      cartCount = 0; updateCartUI(0); showToast('è³¼ç‰©è»Šå·²æ¸…ç©º');
    }
  }

  /* --- Core Logic --- */
  async function jfetch(url, opt){
    try {
      const r = await fetch(url, Object.assign({ headers: {'content-type':'application/json'}}, opt));
      if (!r.ok) throw new Error(r.statusText);
      const txt = await r.text();
      try { return JSON.parse(txt); } catch { return { raw: txt }; }
    } catch(e) { return { ok: false }; }
  }

  function setCartToken(t){ cartToken = t || ''; try { localStorage.setItem(CART_KEY, cartToken); } catch(e){} }

  function updateCartUI(count){
    cartCount = count;
    $('cartCount').textContent = String(cartCount);
    const bar = $('checkoutBar');
    if (cartCount > 0) bar.classList.add('visible'); else bar.classList.remove('visible');
  }

  async function restoreCart(){
    let saved = localStorage.getItem(CART_KEY);
    if(saved) {
        setCartToken(saved);
        // Optional: verify with API
        try {
            const r = await fetch(`${API_BASE}/cart/${encodeURIComponent(saved)}`);
            if(r.ok) {
                const j = await r.json();
                let c = 0; j.items.forEach(i => c += i.qty);
                updateCartUI(c);
            }
        } catch(e){}
    }
  }

  async function ensureCart(){
    if (cartToken) return cartToken;
    if (isDemoMode) return 'DEMO';
    
    const res = await jfetch(API_BASE + '/cart/create', {
        method: 'POST', body: JSON.stringify({ streamer_name: 'å®˜ç¶²', customer_type: 'web' })
    });
    if (res && res.cart_token) {
        setCartToken(res.cart_token); return cartToken;
    }
    isDemoMode = true; return 'DEMO';
  }

  async function fetchProducts(){
    const loader = $('loading'); const grid = $('productList');
    loader.style.display = 'block'; grid.innerHTML = '';
    
    try {
      const res = await fetch(PRODUCT_API);
      const json = await res.json();
      allItems = json.items || [];
    } catch (err) {
      allItems = mockProducts; isDemoMode = true;
    } finally {
        loader.style.display = 'none';
        if (allItems.length > 0) {
            renderCategoryTabs(allItems);
renderProducts(applyCategoryFilter(allItems));
        } else $('emptyTip').style.display = 'block';
    }
  }

  // ===== Category (å¤§åˆ†é¡) -> Subcategory (å°åˆ†é¡) tabs =====
let selectedCat = "ALL";
let selectedSub = "ALL";

// å®‰å…¨å–å­—ä¸²
function pickText(v){
  if (v == null) return "";
  // airtable å¯èƒ½æœƒçµ¦é™£åˆ—/ç‰©ä»¶
  if (Array.isArray(v)) return String(v[0] ?? "").trim();
  if (typeof v === "object") return String(v.name || v.code || "").trim();
  return String(v).trim();
}

// å¤§åˆ†é¡ï¼šå„ªå…ˆ category
function getItemCategory(it){
  return pickText(it?.category || it?.cat || it?.main_category || it?.main_cat);
}

// å°åˆ†é¡ï¼šå„ªå…ˆ sub_categoryï¼Œæ²’æœ‰å°±ç”¨ brand ç•¶å‚™æ´ï¼ˆä½ æƒ³ã€Œåˆ†é¡â†’å“ç‰Œã€æœƒå‰›å¥½ç¬¦åˆï¼‰
function getItemSubcategory(it){
  return pickText(it?.sub_category || it?.subcategory || it?.subcat || it?.sub_cat || it?.brand);
}

// é¡¯ç¤ºç”¨ï¼šå¤§åˆ†é¡æ–‡å­—ï¼ˆä½ å¯è‡ªè¡Œæ”¹ï¼‰
function catLabel(code){
  const c = pickText(code);
  const m = {
    BOUTIQUE: "ç²¾å“åŒ…è¢‹",
    HAIR: "é«®å“",
    BEAUTY: "ç¾å¦ä¿é¤Š",
    ACCESSORY: "é…ä»¶"
  };
  return m[c] || c;
}

// å•†å“å¡ç‰‡/è©³æƒ…ï¼šé¡¯ç¤ºã€Œåˆ†é¡ â†’ å“ç‰Œ/å°åˆ†é¡ã€
function formatBrandLine(p){
  const c = catLabel(getItemCategory(p));
  const s = getItemSubcategory(p); // å¯èƒ½æ˜¯ brand æˆ– sub_category
  return [c, s].filter(Boolean).join(" â†’ ");
}

function applyCategoryFilter(list){
  return (list || []).filter(it => {
    const c = getItemCategory(it);
    const s = getItemSubcategory(it);

    if (selectedCat !== "ALL" && c !== selectedCat) return false;
    // åªæœ‰é¸äº†æŸå€‹å¤§åˆ†é¡ï¼Œæ‰å…è¨±ç¯©å°åˆ†é¡
    if (selectedCat !== "ALL" && selectedSub !== "ALL" && s !== selectedSub) return false;

    return true;
  });
}

function renderCategoryTabs(list){
  const catEl  = $("brandList");
  const subEl  = $("subcatList");
  catEl.innerHTML = "";
  if (subEl) subEl.innerHTML = "";

  // ç®—å‡ºæœ‰å“ªäº›å¤§åˆ†é¡
  const cats = Array.from(new Set(
    (list || []).map(it => getItemCategory(it)).filter(Boolean)
  ));

  const makeBtn = (parentEl, key, label, isActive, onClick) => {
    const item = document.createElement("div");
    item.className = "brand-item";
    if (key === "ALL") item.classList.add("all-btn");
    if (isActive) item.classList.add("active");

    item.innerHTML = `
      <div class="brand-avatar"><div class="brand-text-logo">${key}</div></div>
      <span class="brand-name-label">${label}</span>
    `;

    item.onclick = () => {
      // åªæ¸…è‡ªå·±é€™ä¸€æ’çš„ active
      parentEl.querySelectorAll(".brand-item").forEach(b => b.classList.remove("active"));
      item.classList.add("active");
      onClick && onClick();
    };

    parentEl.appendChild(item);
  };

  // --- ç¬¬ä¸€æ’ï¼šå¤§åˆ†é¡ ---
  makeBtn(catEl, "ALL", "å…¨éƒ¨", selectedCat === "ALL", () => {
    selectedCat = "ALL";
    selectedSub = "ALL";
    if (subEl) { subEl.style.display = "none"; subEl.innerHTML = ""; }
    renderProducts(applyCategoryFilter(list));
  });

  cats.forEach(c => {
    makeBtn(catEl, c, catLabel(c), selectedCat === c, () => {
      selectedCat = c;
      selectedSub = "ALL";
      renderSubTabs(list);
      renderProducts(applyCategoryFilter(list));
    });
  });

  // åˆå§‹åŒ–ç¬¬äºŒæ’
  renderSubTabs(list);
}

function renderSubTabs(list){
  const subEl = $("subcatList");
  if (!subEl) return;

  // æ²’é¸å¤§åˆ†é¡æ™‚ï¼Œä¸é¡¯ç¤ºç¬¬äºŒæ’
  if (selectedCat === "ALL") {
    subEl.style.display = "none";
    subEl.innerHTML = "";
    return;
  }

  // ç®—å‡ºè©²å¤§åˆ†é¡åº•ä¸‹çš„å°åˆ†é¡ï¼ˆsub_category æˆ– brandï¼‰
  const subs = Array.from(new Set(
    (list || [])
      .filter(it => getItemCategory(it) === selectedCat)
      .map(it => getItemSubcategory(it))
      .filter(Boolean)
  ));

  // æ²’æœ‰å°åˆ†é¡å°±ä¸é¡¯ç¤º
  if (!subs.length) {
    subEl.style.display = "none";
    subEl.innerHTML = "";
    return;
  }

  subEl.style.display = "";
  subEl.innerHTML = "";

  const makeBtn = (key, label) => {
    const item = document.createElement("div");
    item.className = "brand-item";
    if (key === "ALL") item.classList.add("all-btn");
    if (selectedSub === key) item.classList.add("active");

    item.innerHTML = `
      <div class="brand-avatar"><div class="brand-text-logo">${key}</div></div>
      <span class="brand-name-label">${label}</span>
    `;

    item.onclick = () => {
      subEl.querySelectorAll(".brand-item").forEach(b => b.classList.remove("active"));
      item.classList.add("active");
      selectedSub = key;
      renderProducts(applyCategoryFilter(list));
    };

    subEl.appendChild(item);
  };

  makeBtn("ALL", "å…¨éƒ¨",);
  subs.forEach(s => makeBtn(s, s));
}

  function renderBrandIcons(list){
  const listEl = $('brandList'); listEl.innerHTML = '';

  // âœ… æ”¹æˆç”¨ã€Œåˆ†é¡ã€ç”Ÿé¸é …
  const cats = Array.from(new Set(
    list.map(it => String(it.category || '').trim()).filter(Boolean)
  ));

  const catLabel = (c) => {
    // ä½ å¯ä¾è‡ªå·±è³‡æ–™åº«åˆ†é¡ç¢¼èª¿æ•´
    const m = {
      BOUTIQUE: 'ç²¾å“åŒ…æ¬¾',
      HAIR: 'é«®å“',
      BEAUTY: 'ç¾å¦ä¿é¤Š',
      ACCESSORY: 'é£¾å“é…ä»¶'
    };
    return m[c] || c;
  };

  const addBtn = (key, label, fn) => {
    const item = document.createElement('div');
    item.className = 'brand-item';
    if(key === 'ALL') item.classList.add('all-btn', 'active');

    item.innerHTML = `
      <div class="brand-avatar"><div class="brand-text-logo">${key}</div></div>
      <span class="brand-name-label">${label}</span>
    `;

    item.onclick = () => {
      document.querySelectorAll('.brand-item').forEach(b => b.classList.remove('active'));
      item.classList.add('active');
      renderProducts(fn ? list.filter(fn) : list);
    };

    listEl.appendChild(item);
  };

  addBtn('ALL', 'å…¨éƒ¨', null);
  cats.forEach(c => addBtn(c, catLabel(c), i => String(i.category || '').trim() === c));
}

  function renderProducts(list){
    const wrap = $('productList'); wrap.innerHTML = '';
    list.forEach(p => {
      const card = document.createElement('div'); card.className = 'product-card';
      const img = p.image || '';
      
      card.innerHTML = `
        <div class="img-wrapper">
            <img src="${img}" loading="lazy" alt="${p.title}">
        </div>
        <div class="card-info">
            <div class="p-brand">${formatBrandLine(p)}</div>
            <div class="p-title">${p.title}</div>
            <div class="p-price">NT$ ${(p.price).toLocaleString()}</div>
        </div>
      `;
      card.onclick = () => openProductDetail(p);
      wrap.appendChild(card);
    });
  }

  async function handleAddToCart(sku, qty){
    showToast('åŠ å…¥ä¸­...');
    const token = await ensureCart();
    if(isDemoMode) {
        setTimeout(() => { cartCount++; updateCartUI(cartCount); showToast('å·²åŠ å…¥è³¼ç‰©è»Š'); }, 300);
        return;
    }
    const res = await jfetch(API_BASE + '/cart/add', {
        method: 'POST', body: JSON.stringify({ cart_token: token, sku, qty: 1 })
    });
    if(res && res.items) {
        let c = 0; res.items.forEach(i => c += i.qty);
        updateCartUI(c); showToast('å·²åŠ å…¥è³¼ç‰©è»Š');
    }
  }

  async function goCheckout(){
    if(!cartToken) await restoreCart();
    if(isDemoMode) { alert('ç›®å‰ç‚ºæ¼”ç¤ºæ¨¡å¼'); return; }
    if(!cartToken || cartCount <= 0) { showToast('è³¼ç‰©è»Šæ˜¯ç©ºçš„'); return; }
    location.href = `${LIFF_CHECKOUT}?cart_token=${encodeURIComponent(cartToken)}`;
  }

  window.addEventListener('DOMContentLoaded', async () => {
    await restoreCart();
    await fetchProducts();
    $('checkoutBtn').onclick = goCheckout;
    $('clearCartBtn').onclick = clearCart;
  });
</script>
</body>
</html>
