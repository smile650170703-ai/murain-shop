<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MURAIN — 賣家開單 v5.1</title>
    <style>
        body { font-family: system-ui, sans-serif; display: grid; place-items: center; min-height: 90vh; background-color: #f4f4f5; }
        .container { background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 2rem 3rem; width: 90%; max-width: 500px; }
        h1 { margin-top: 0; color: #333; text-align: center; }
        button { font-size: 1.1rem; padding: 12px 20px; border: none; background-color: #007aff; color: white; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; width: 100%; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; }
        .btn-deposit { background-color: #ffc107; color: black; } /* (v5) */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        #status, #cart-link { margin-top: 1rem; font-weight: bold; text-align: center; word-break: break-all; }
        .hidden { display: none; }
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .op-field { border-left: 3px solid #007aff; padding-left: 10px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>直播主開單系統 (v5.1)</h1>

        <div id="step1">
            <div class="form-group">
                <label for="streamer_name">主播名稱 (Q4)</label>
                <input type="text" id="streamer_name" placeholder="請輸入您的名稱">
            </div>
            <button id="createCartBtn">1. 建立 [一般客人] 結帳單</button>
            <button id="createDepositBtn" class="btn-deposit">1. 建立 [新客訂金] 結帳單</button>
            <p id="status1"></p>
        </div>

        <div id="step2" class="hidden">
            <h3 id="cart-title">購物車 (OD...)</h3>
            <div class="form-group">
                <label for="barcode">商品 Barcode</label>
                <input type="text" id="barcode" placeholder="輸入商品 Barcode...">
            </div>
            <div class="two-col">
                <div class="form-group">
                    <label for="qty">數量</label>
                    <input type="number" id="qty" value="1" min="1">
                </div>
                <div class="form-group">
                    <label for="op_key">主播密碼 (OP Key)</label>
                    <input type="password" id="op_key" placeholder="(選填)">
                </div>
            </div>
            <div class="form-group op-field hidden" id="override_field">
                <label for="override_price">覆寫價格 (填 0 = 贈品)</label>
                <input type="number" id="override_price" placeholder="輸入此商品「單價」...">
            </div>
            <button id="addItemBtn">2. 加入商品</button>
            <p id="status2"></p>
            
            <hr style="border:0; border-top: 1px solid #eee; margin: 2rem 0;">

            <div class="form-group">
                <label for="gift_notes">贈品/訂單備註 (Q3)</label>
                <textarea id="gift_notes" rows="3" placeholder="(選填) 輸入贈品資訊或訂單備註..."></textarea>
            </div>
            <button id="saveNotesBtn">儲存備註</button>
            <p id="status3"></p>
        </div>
        
        <div id="step3" class="hidden">
            <h3>✅ 結帳連結已產生</h3>
            <p>請複製此連結傳送給客人：</p>
            <input type="text" id="cart-link" readonly>
            <button id="copyBtn">複製連結</button>
        </div>
    </div>

    <script>
        const API_ENDPOINT = 'https://murain-api.smile650170703.workers.dev';
        let CURRENT_CART_TOKEN = null;

        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const status1 = document.getElementById('status1');
        const status2 = document.getElementById('status2');
        const status3 = document.getElementById('status3');
        const opKeyInput = document.getElementById('op_key');
        const overrideField = document.getElementById('override_field');

        opKeyInput.addEventListener('input', () => {
            if (opKeyInput.value.trim() !== '') {
                overrideField.classList.remove('hidden');
            } else {
                overrideField.classList.add('hidden');
            }
        });

        // --- (v5) 步驟一：建立購物車 (共用函式) ---
        async function createCart(customerType) {
            const btn1 = document.getElementById('createCartBtn');
            const btn2 = document.getElementById('createDepositBtn');
            btn1.disabled = true;
            btn2.disabled = true;
            status1.textContent = '建立中...';
            
            const streamerName = document.getElementById('streamer_name').value;
            if (!streamerName) {
                 status1.textContent = '請先輸入主播名稱';
                 status1.style.color = 'red';
                 btn1.disabled = false;
                 btn2.disabled = false;
                 return;
            }

            try {
                // (v5) 呼叫後端 /cart/create API，並傳送類型
                const res = await fetch(`${API_ENDPOINT}/cart/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        streamer_name: streamerName, // (Q4)
                        customer_type: customerType  // (Q5)
                    })
                });
                
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                CURRENT_CART_TOKEN = data.cart_token;
                document.getElementById('cart-title').textContent = `購物車 (${data.order_id})`;
                step1.classList.add('hidden');
                step2.classList.remove('hidden');
                step3.classList.remove('hidden');
                
                // (v5) 顯示「正確」的結帳連結 (checkout 或 shipping)
                document.getElementById('cart-link').value = (new URL(data.share_url, window.location.href)).href;

            } catch (err) {
                status1.textContent = `建立失敗: ${err.message}`;
                status1.style.color = 'red';
                btn1.disabled = false;
                btn2.disabled = false;
            }
        }
        
        // (v5) 綁定兩個不同的建立按鈕
        document.getElementById('createCartBtn').addEventListener('click', () => createCart('OLD')); // 舊客
        document.getElementById('createDepositBtn').addEventListener('click', () => createCart('DEPOSIT')); // 新客訂金


        // --- 步驟二：加入商品 (v4) ---
        document.getElementById('addItemBtn').addEventListener('click', async () => {
            const btn = document.getElementById('addItemBtn');
            const barcode = document.getElementById('barcode').value;
            const qty = parseInt(document.getElementById('qty').value, 10);
            const op_key = document.getElementById('op_key').value;
            let payload = { barcode: barcode, qty: qty };
            if (!barcode || qty < 1) { status2.textContent = '請輸入正確的 Barcode 和數量'; status2.style.color = 'red'; return; }
            if (op_key) {
                payload.op_key = op_key;
                const price = document.getElementById('override_price').value;
                if (price !== '') { payload.override_price = parseInt(price, 10); }
            }
            btn.disabled = true;
            status2.textContent = '加入中...';
            try {
                const res = await fetch(`${API_ENDPOINT}/cart/${CURRENT_CART_TOKEN}/add`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                status2.textContent = `加入成功！(總金額: ${data.total_amount})`;
                status2.style.color = 'green';
                document.getElementById('barcode').value = '';
                document.getElementById('qty').value = 1;
                document.getElementById('override_price').value = '';
            } catch (err) {
                status2.textContent = `加入失敗: ${err.message}`;
                status2.style.color = 'red';
            } finally {
                btn.disabled = false;
            }
        });
        
        // --- 儲存備註 (v4) ---
        document.getElementById('saveNotesBtn').addEventListener('click', async () => {
            const btn = document.getElementById('saveNotesBtn');
            const op_key = document.getElementById('op_key').value;
            const gift_notes = document.getElementById('gift_notes').value;
            if (!op_key) { status3.textContent = '儲存備註需要主播密碼'; status3.style.color = 'red'; return; }
            btn.disabled = true;
            status3.textContent = '儲存備註中...';
            try {
                const res = await fetch(`${API_ENDPOINT}/cart/${CURRENT_CART_TOKEN}/update-notes`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ cart_token: CURRENT_CART_TOKEN, gift_notes, op_key })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                status3.textContent = '備註儲存成功！';
                status3.style.color = 'green';
            } catch (err) {
                status3.textContent = `儲存失敗: ${err.message}`;
                status3.style.color = 'red';
            } finally {
                btn.disabled = false;
            }
        });
        
        // --- 複製連結 ---
        document.getElementById('copyBtn').addEventListener('click', () => {
             document.getElementById('cart-link').select();
             document.execCommand('copy');
             alert('已複製結帳連結！');
        });

    </script>
</body>
</html> 
