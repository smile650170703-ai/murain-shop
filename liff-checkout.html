<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>XUYUAN | çµå¸³</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />

  <!-- å¼•å…¥å“ç‰Œå­—é«” -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    /* --- æ ¸å¿ƒè®Šæ•¸ (èˆ‡å®˜ç¶²çµ±ä¸€) --- */
    :root {
      --bg-color: #050505;
      --card-bg: #111;
      --input-bg: #1a1a1a;
      --text-main: #fff;
      --text-muted: #888;
      --gold-primary: #D4AF37; 
      --gold-light: #F3E5AB;
      --border-color: rgba(255, 255, 255, 0.1);
      --danger: #ef4444;
      --font-serif: 'Playfair Display', serif;
      --font-sans: 'Lato', 'Noto Sans TC', sans-serif; /* åŠ å…¥ä¸­æ–‡å­—é«”æ”¯æ´ */
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      padding-bottom: calc(100px + env(safe-area-inset-bottom)); /* é¿é–‹åº•éƒ¨æŒ‰éˆ• */
    }

    .page {
      max-width: 640px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    /* --- Header --- */
    .header {
      text-align: center;
      margin-bottom: 40px;
      position: relative;
    }
    .brand {
      font-family: var(--font-serif);
      font-size: 24px;
      letter-spacing: 0.15em;
      color: var(--gold-primary);
      margin-bottom: 4px;
    }
    .page-title {
      font-size: 13px;
      letter-spacing: 0.2em;
      color: var(--text-muted);
      text-transform: uppercase;
      font-weight: 500;
    }

    /* --- å¡ç‰‡å€å¡Š --- */
    .section-card {
      margin-bottom: 40px;
    }
    .section-header {
      font-size: 13px;
      letter-spacing: 0.1em;
      color: var(--gold-primary);
      text-transform: uppercase;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
      font-weight: 500;
    }

    /* --- è¡¨å–®å…ƒç´  --- */
    label {
      display: block;
      font-size: 13px;
      color: #ccc;
      margin-bottom: 8px;
      margin-top: 16px;
    }
    label:first-child { margin-top: 0; }

    input, select, textarea {
      width: 100%;
      padding: 14px 12px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      background: var(--input-bg);
      color: #fff;
      font-size: 15px;
      font-family: var(--font-sans);
      transition: border-color 0.3s;
      -webkit-appearance: none; /* ç§»é™¤ iOS é è¨­æ¨£å¼ */
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--gold-primary);
    }
    input[readonly], textarea[readonly] {
      background: #0f0f0f;
      color: var(--gold-light);
      border-color: transparent;
      font-family: var(--font-sans);   /* æ”¹æˆ Lato / Noto Sans (æ¨™æº–é»‘é«”) */
  font-weight: 700;                /* åŠ ç²—ï¼Œè®“é‡‘é¡æ›´æ˜é¡¯ */
  letter-spacing: 0.05em;          /* ç¨å¾®åŠ å¯¬ä¸€é»é»é–“è· */
      font-size: 16px;
      letter-spacing: 0.05em;
    }
    textarea { min-height: 80px; resize: vertical; line-height: 1.6; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    /* --- Tabs (ä»˜æ¬¾æ–¹å¼) --- */
    .input-inline{ display:flex; align-items:center; gap:10px; }
.input-inline input{ flex:1; min-width:0; }
.inline-muted{ white-space:nowrap; margin:0; }
    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      overflow-x: auto;
      padding-bottom: 4px;
      scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar { display: none; }

    .tab {
      flex: 1;
      min-width: 100px;
      padding: 12px 0;
      text-align: center;
      font-size: 13px;
      border: 1px solid var(--border-color);
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.3s;
      font-family: var(--font-sans);
    }
    .tab.active {
      border-color: var(--gold-primary);
      color: var(--gold-primary);
      background: rgba(212, 175, 55, 0.05);
      font-weight: 500;
    }

    /* --- Radio Pill (åœ“è§’é¸é …) --- */
    .radio-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px; }
    .radio-pill {
      padding: 10px 16px;
      border: 1px solid var(--border-color);
      border-radius: 99em;
      font-size: 13px;
      color: #aaa;
      cursor: pointer;
      display: flex; align-items: center; gap: 6px;
      transition: all 0.2s;
    }
    .radio-pill:has(input:checked) {
      border-color: var(--gold-primary);
      color: #fff;
      background: rgba(212, 175, 55, 0.1);
    }
    .radio-pill input { width: auto; margin: 0; -webkit-appearance: auto; accent-color: var(--gold-primary); }

    /* --- è¼”åŠ©æ–‡å­— --- */
    .hint { font-size: 12px; color: var(--text-muted); margin-top: 6px; line-height: 1.5; }
    .muted { font-size: 12px; color: #666; margin-top: 4px; }

    .pill {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 4px 10px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border-color);
      font-size: 12px; color: #ccc;
      margin-right: 6px; margin-bottom: 6px;
    }
    /* åŒ¯æ¬¾å¸³è™Ÿï¼šæ¨™æº–æ•¸å­—å­—é«” + å¯è¤‡è£½ */
.pill-copy {
  display: flex;
  align-items: center;
  gap: 10px;
}

.pill-val {
  color: var(--gold-primary);
  font-family: var(--font-sans);   /* âœ… æ¨™æº–æ•¸å­—å­—é«” */
  font-weight: 700;
  letter-spacing: 0.08em;
  font-variant-numeric: tabular-nums;
  margin-left: 2px;
}

.pill-copy-btn {
  margin-left: auto;
  border: 1px solid var(--border-color);
  background: rgba(255,255,255,0.06);
  color: #e6e6e6;
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 999px;
  cursor: pointer;
  font-family: var(--font-sans);
}

.pill-copy-btn:active {
  transform: translateY(1px);
}

    .pill-copy > span:first-child {
  font-family: var(--font-sans);
  color: #ccc;
  letter-spacing: 0.02em;
}
    /* ä¸€èˆ¬ pill å…§çš„é‡‘è‰²æ–‡å­—ç”¨è—è¡“å­—ï¼›ä½† pill-copy ä¾‹å¤– */
.pill:not(.pill-copy) span {
  color: var(--gold-primary);
  font-family: var(--font-serif);
}

    /* --- åº•éƒ¨å›ºå®šæŒ‰éˆ• --- */
    .bottom-bar {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(10px);
      padding: 16px 20px calc(16px + env(safe-area-inset-bottom));
      border-top: 1px solid var(--border-color);
      z-index: 100;
      display: flex; justify-content: center;
    }
    .btn-submit {
      width: 100%; max-width: 640px;
      padding: 14px;
      border: none; border-radius: 2px;
      background: var(--gold-primary);
      color: #000;
      font-size: 14px; font-weight: 700; letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary {
      background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted);
      font-size: 12px; padding: 8px 12px; width: auto; display: inline-block; margin-top: 8px; cursor: pointer;
    }

    /* è³¼ç‰©é‡‘æç¤º */
    .credit-hint {
      display: flex; justify-content: space-between;
      font-size: 11px; color: var(--text-muted); margin-top: 6px;
    }
    .credit-val { color: var(--gold-primary); }

  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

<div class="page">
  <div class="header">
    <div class="brand">XUYUAN</div>
    <div class="page-title">çµå¸³</div>
  </div>

  <!-- 1. è¨‚å–®é‡‘é¡ -->
  <div class="section-card">
    <div class="section-header">è¨‚å–®å…§å®¹</div>

    <label>å•†å“å°è¨ˆ (NT$)</label>
    <input id="subtotal" readonly />

    <label>å•†å“æ˜ç´°</label>
    <textarea id="itemsText" readonly></textarea>

    <label>æ‡‰ä»˜é‡‘é¡ (æœªæ‰£é™¤è³¼ç‰©é‡‘)</label>
    <input id="total" readonly />

    <label>ä½¿ç”¨è³¼ç‰©é‡‘æŠ˜æŠµ</label>
    <input id="credit_input" type="number" min="0" step="1" placeholder="è¼¸å…¥æŠ˜æŠµé‡‘é¡" />
    <div class="credit-hint">
      <span>ä¸æ‰¾é›¶ã€ä¸å…Œç¾</span>
      <span id="credit_available">å¯ç”¨é¤˜é¡ï¼šNT$ 0</span>
    </div>
    <div class="muted" id="credit_msg"></div>

    <label style="color:var(--gold-primary); margin-top:20px;">å¯¦éš›ä»˜æ¬¾é‡‘é¡</label>
    <input id="total_after_credit" readonly style="border-color:var(--gold-primary); color:var(--gold-primary);" />

    <label>è¨‚å–®å‚™è¨» (é¸å¡«)</label>
    <textarea id="note" placeholder="ä¾‹å¦‚ï¼šé€ç¦®ç”¨éœ€é™„ç´™è¢‹ï¼ˆç„¡å‚™è¨»ä¸æä¾›ï¼‰..."></textarea>
  </div>

  <!-- 2. ä»˜æ¬¾èˆ‡é…é€ -->
  <div class="section-card">
    <div class="section-header">ä»˜æ¬¾èˆ‡é‹é€æ–¹å¼</div>

    <div class="tabs" id="payTabs">
      <button class="tab active" data-pay="COD">è²¨åˆ° / é¢äº¤</button>
      <button class="tab" data-pay="PAID">ç·šä¸Šä»˜æ¬¾</button>
      <button class="tab" data-pay="DEPOSIT">ATM åŒ¯æ¬¾</button>
      <button class="tab" data-pay="ZEROCARD">ç„¡å¡åˆ†æœŸ</button>
    </div>

    <!-- COD -->
    <div id="paneCOD">
      <div class="radio-row">
        <label class="radio-pill">
          <input type="radio" name="codType" value="711" checked />
          7-11 è²¨åˆ°ä»˜æ¬¾
        </label>
        <label class="radio-pill">
          <input type="radio" name="codType" value="meetup" />
          é¢äº¤ / åˆ°åº—è‡ªå–
        </label>
      </div>
      
      <div class="row">
        <div><label>å§“å *</label><input id="cod_name" required /></div>
        <div><label>é›»è©± *</label><input id="cod_phone" required /></div>
      </div>
      <label>Email *</label>
      <input id="cod_email" required type="email" />

      <div id="cod711Extra">
        <div class="row">
          <div><label>7-11 é–€å¸‚ä»£è™Ÿ</label><input id="cod_store_id" required /></div>
          <div><label>é–€å¸‚åç¨±</label><input id="cod_store_name" required /></div>
        </div>
        <label>é–€å¸‚åœ°å€</label>
        <input id="cod_store_addr" required />
        <button class="btn-secondary" id="mapCOD">é–‹å•Ÿ 7-11 åœ°åœ–</button>
      </div>
      <div id="codMeetHint" class="hint" hidden>ç¾å ´æ ¸å°è³‡æ–™ï¼Œè«‹æ”œå¸¶æ‰‹æ©Ÿã€‚</div>
    </div>

    <!-- PAID -->
    <div id="panePAID" hidden>
  </div>

  <div style="margin-bottom: 15px;">
    <label>ä»˜æ¬¾æ–¹å¼ *</label>
    <select id="paid_channel">
      <option value="card_once">ä¿¡ç”¨å¡ (ä¸€æ¬¡ä»˜æ¸…)</option>
      <option value="card_inst">ä¿¡ç”¨å¡ (åˆ†æœŸ 0 åˆ©ç‡)</option>
      <option value="linepay">LINE Pay</option>
      <option value="af">AF å…ˆäº«å¾Œä»˜</option>
    </select>
  </div>

  <div id="cardInstBox" style="margin-bottom: 15px;">
    <label>åˆ†æœŸæœŸæ•¸ *</label>
    <select id="inst_months">
      <option value="3">3 æœŸ (0 åˆ©ç‡)</option>
      <option value="6">6 æœŸ (0 åˆ©ç‡)</option>
      <option value="9">9 æœŸ (0 åˆ©ç‡)</option>
    </select>
  </div>

  <div style="margin-bottom: 15px;">
    <label>å–è²¨æ–¹å¼ *</label>
    <select id="paid_ship_method">
      <option value="711">7-11 å–è²¨</option>
      <option value="post">éƒµå¯„</option>
      <option value="meetup">é¢äº¤ / è‡ªå–</option>
    </select>
  </div>

  <div id="paidShip711" class="mt-2">
    <div class="muted" style="color: #666; font-size: 0.9em; margin-bottom: 5px;">
      0å…ƒåŒ…è£¹éœ€å¡«å¯«è­‰ä»¶çœŸå¯¦å§“å
    </div>
    
    <div class="row">
      <div><label>å§“å *</label><input id="ship_name_paid" required placeholder="è«‹å¡«çœŸå¯¦å§“å" /></div>
      <div><label>é›»è©± *</label><input id="ship_phone_paid" required /></div>
    </div>
    
    <label>Email *</label>
    <input id="paid_email" type="email" required placeholder="æ¥æ”¶è¨‚å–®é€šçŸ¥ç”¨" />

    <div class="row mt-2">
      <div><label>é–€å¸‚ä»£è™Ÿ *</label><input id="ship_store_id_paid" required /></div>
      <div><label>é–€å¸‚åç¨± *</label><input id="ship_store_name_paid" required /></div>
    </div>
    
    <label>é–€å¸‚åœ°å€ *</label>
    <input id="ship_store_addr_paid" required />
    
    <button class="btn-secondary" id="mapPAID" style="margin-top: 8px;">é–‹å•Ÿ 7-11 é–€å¸‚åœ°åœ–</button>
  </div>

  <div id="paidShipPost" hidden class="mt-2">
    <div class="muted" style="color: #666; font-size: 0.9em; margin-bottom: 5px;">
      éƒµæ”¿æŠ•éä¸æœƒäº‹å…ˆé›»è©±é€£çµ¡ï¼Œè«‹ç¢ºèªè©²åœ°å€æœ‰äººå¯æ”¶ä»¶
    </div>

    <div class="row">
      <div><label>å§“å *</label><input id="paid_post_name" required /></div>
      <div><label>é›»è©± *</label><input id="paid_post_phone" required /></div>
    </div>

    <label>Email *</label>
    <input id="paid_post_email" type="email" required />

    <div class="row mt-2">
       <div style="flex: 1;"><label>éƒµéå€è™Ÿ</label><input id="paid_post_zip" /></div>
    </div>
    
    <label>æ”¶ä»¶åœ°å€ *</label>
    <input id="paid_post_addr" required />
  </div>

  <div id="paidShipMeetup" hidden class="mt-2">
    <div class="row">
      <div><label>å§“å *</label><input id="paid_meet_name" required /></div>
      <div><label>é›»è©± *</label><input id="paid_meet_phone" required /></div>
    </div>
    
    <label>Email *</label>
    <input id="paid_meet_email" type="email" required />
  </div>
    
</div>
    <!-- DEPOSIT -->
    <div id="paneDEPOSIT" hidden>
      <div class="pill">
  éŠ€è¡Œï¼š<span>éƒµå±€ (700)</span>
</div>

<div class="pill pill-copy">
  <span>å¸³è™Ÿï¼š</span>
  <span id="bankAccount" class="pill-val">01912890973712</span>
  <button type="button" class="pill-copy-btn" id="copyBankAccount">ä¸€éµè¤‡è£½</button>
</div>

      <div class="radio-row" style="margin-top:16px;">
        <label class="radio-pill">
          <input type="radio" name="depType" value="new_full" checked />
          åŒ¯æ¬¾å…¨é¡
        </label>
        <label class="radio-pill">
          <input type="radio" name="depType" value="old" />
          åŒ¯æ¬¾å®šé‡‘ (ä¿ç•™)
        </label>
      </div>

      <!-- åŒ¯æ¬¾å®šé‡‘ (ä¿ç•™) -->
      <div id="depOldPane" hidden>
    
    <div class="section-title" style="margin-bottom: 15px; font-weight: 600; color: #333;">
        ğŸ’¡ åŒ¯æ¬¾å®šé‡‘ï¼ˆå…¥å¸³å¾Œå¯ç‚ºæ‚¨ä¿ç•™å•†å“æœ€é•· 1 å€‹æœˆï¼‰
    </div>

    <div style="margin-bottom: 10px;">
        <label>å–è²¨æ–¹å¼</label>
        <select id="dep_old_method">
            <option value="711">7-11 å–è²¨</option>
            <option value="post">éƒµå¯„</option>
        </select>
    </div>

    <div class="row">
        <div><label>å§“å</label><input id="dep_old_name" required /></div>
        <div><label>é›»è©±</label><input id="dep_old_phone" required /></div>
    </div>
    
    <label>Email</label><input id="dep_old_email" type="email" />

    <div id="dep_old_box_711" style="margin-top: 10px;">
        <div class="row">
            <div><label>é–€å¸‚ä»£è™Ÿ</label><input id="dep_old_store_id" required /></div>
            <div><label>é–€å¸‚åç¨±</label><input id="dep_old_store_name" required /></div>
        </div>
        <label>é–€å¸‚åœ°å€</label><input id="dep_old_store_addr" required />
        <button class="btn-secondary" id="mapDepOld" style="margin-top: 5px;">é–‹å•Ÿ 7-11 åœ°åœ–</button>
    </div>

    <div id="dep_old_box_post" hidden style="margin-top: 10px;">
        <label>éƒµéå€è™Ÿ</label><input id="dep_old_post_zip" />
        <label>æ”¶ä»¶åœ°å€</label><input id="dep_old_post_addr" required />
    </div>

    <div style="margin-top: 15px;">
        <label>å¸³è™Ÿå¾Œäº”ç¢¼</label><input id="dep_old_last5" required />
    </div>

    <div id="dep_old_deposit_fields">
        <label>åŒ¯æ¬¾å®šé‡‘é‡‘é¡</label><input id="dep_old_amount" />
        
        <label>ä¿ç•™åˆ°æœŸæ—¥ï¼ˆæœ€å¤š 1 å€‹æœˆå…§ï¼‰</label>
        <input id="dep_old_hold_until" type="date" />
    </div>

    <div class="hint-box" style="margin-top: 25px; background-color: #f8f9fa; padding: 15px; border-radius: 6px; font-size: 0.85em; color: #666; line-height: 1.6;">
        <div style="font-weight: bold; margin-bottom: 5px; color: #444;">æ³¨æ„äº‹é …ï¼š</div>
        <ul style="margin: 0; padding-left: 20px;">
            <li>å®šé‡‘å…¥å¸³å¾Œå¯ç‚ºæ‚¨ä¿ç•™å•†å“æœ€é•· 1 å€‹æœˆã€‚</li>
            <li>ä¸€èˆ¬åŒ…æ¬¾å®šé‡‘ NT$ 1,000ï¼›Tory Burch ç­‰æŒ‡å®šå“ç‰Œå®šé‡‘ NT$ 2,000ã€‚</li>
            <li>
                <span style="color: #c88a35; font-weight: bold;">âš ï¸ è«‹å‹™å¿…ç¢ºèªæ”¶ä»¶è³‡æ–™æ­£ç¢º</span>ï¼Œ
                è‹¥ä¹‹å¾Œæœ‰ã€Œå®šé‡‘ï¼å°¾æ¬¾ã€ä»˜æ¬¾ï¼Œç³»çµ±å°‡æ²¿ç”¨æœ¬æ¬¡è¨­å®šï¼Œä¸å¦è¡Œè©¢å•ã€‚
            </li>
            <li>é€¾æœŸè¦–åŒæ£„æ¨™ï¼Œå®šé‡‘ä¸é€€é‚„ã€å•†å“ä¸å†ä¿ç•™ã€‚</li>
        </ul>
    </div>

</div>

      <!-- åŒ¯æ¬¾å…¨é¡ -->
      <div id="depNewFullPane">
        <div class="row">
          <div><label>å§“å</label><input id="dep_new_full_name" required /></div>
          <div><label>é›»è©±</label><input id="dep_new_full_phone" required /></div>
        </div>
        <label>Email</label><input id="dep_new_full_email" type="email" />
        <label>å–è²¨æ–¹å¼</label>
        <select id="dep_new_full_method">
          <option value="711">7-11 å–è²¨</option>
          <option value="post">éƒµå¯„</option>
          <option value="meetup">é¢äº¤</option>
        </select>

        <div id="depNewFull711">
          <div class="muted">0å…ƒåŒ…è£¹éœ€å¡«å¯«çœŸå¯¦å§“å</div>
          <div class="row">
            <div><label>é–€å¸‚ä»£è™Ÿ</label><input id="dep_new_full_store_id" required /></div>
            <div><label>é–€å¸‚åç¨±</label><input id="dep_new_full_store_name" required /></div>
          </div>
          <label>é–€å¸‚åœ°å€</label><input id="dep_new_full_store_addr" required />
          <button class="btn-secondary" id="mapDepNewFull">é–‹å•Ÿ 7-11 åœ°åœ–</button>
        </div>
        <div class="muted">ä¸­è¯éƒµæ”¿æŠ•éä¸æœƒäº‹å…ˆé›»è©±é€£çµ¡ï¼Œè«‹ç¢ºèªæœ‰äººå¯æ”¶ä»¶ã€‚</div>

        <div id="depNewFullPost" hidden>
          <label>éƒµéå€è™Ÿ</label><input id="dep_new_full_post_zip" />
          <label>æ”¶ä»¶åœ°å€</label><input id="dep_new_full_post_addr" required />
        </div>

        <div id="depNewFullMeetup" hidden>
          <div class="row">
            <div><label>å§“å</label><input id="dep_new_full_meet_name" required /></div>
            <div><label>é›»è©±</label><input id="dep_new_full_meet_phone" required /></div>
          </div>
          <label>Email</label><input id="dep_new_full_meet_email" type="email" />
        </div>

        <label>å¸³è™Ÿå¾Œäº”ç¢¼</label><input id="dep_new_full_last5" required />
        <input id="dep_new_full_amount" type="hidden" />
      </div>
    </div>

    <!-- ZEROCARD -->
    <div id="paneZEROCARD" hidden>
      <div class="row">
        <div>
          <label>æœŸæ•¸</label>
          <select id="zc_months">
            <option value="3">3 æœŸ (0åˆ©ç‡)</option>
            <option value="6">6 æœŸ</option>
            <option value="9">9 æœŸ</option>
            <option value="12">12 æœŸ</option>
            <option value="18">18 æœŸ</option>
            <option value="24">24 æœŸ</option>
          </select>
        </div>
        <div>
          <label>æ¯æœŸè©¦ç®—</label>
          <input id="zc_each" readonly />
        </div>
      </div>

      <label>å–è²¨æ–¹å¼</label>
      <select id="zc_ship_method">
        <option value="711">7-11 å–è²¨</option>
        <option value="post">éƒµå¯„</option>
        <option value="meetup">é¢äº¤</option>
      </select>

      <div id="zcShip711">
        <div class="row">
          <div><label>å§“å</label><input id="ship_name_zc" required /></div>
          <div><label>é›»è©±</label><input id="ship_phone_zc" required /></div>
        </div>
        <label>Email</label><input id="zc_email" type="email" />
        <div class="row">
          <div><label>é–€å¸‚ä»£è™Ÿ</label><input id="ship_store_id_zc" required /></div>
          <div><label>é–€å¸‚åç¨±</label><input id="ship_store_name_zc" required /></div>
        </div>
        <label>é–€å¸‚åœ°å€</label><input id="ship_store_addr_zc" required />
        <button class="btn-secondary" id="mapZC">é–‹å•Ÿ 7-11 åœ°åœ–</button>
      </div>

      <div id="zcShipPost" hidden>
        <div class="row">
          <div><label>å§“å</label><input id="zc_post_name" required /></div>
          <div><label>é›»è©±</label><input id="zc_post_phone" required /></div>
        </div>
        <label>Email</label><input id="zc_post_email" type="email" />
        <label>éƒµéå€è™Ÿ</label><input id="zc_post_zip" />
        <label>æ”¶ä»¶åœ°å€</label><input id="zc_post_addr" required />
      </div>

      <div id="zcShipMeetup" hidden>
        <div class="row">
          <div><label>å§“å</label><input id="zc_meet_name" required /></div>
          <div><label>é›»è©±</label><input id="zc_meet_phone" required /></div>
        </div>
        <label>Email</label><input id="zc_meet_email" type="email" />
      </div>
    </div>
  </div>

  <div class="bottom-bar">
    <button class="btn-submit" id="submitBtn">ç¢ºèªé€å‡ºè¨‚å–®</button>
  </div>
</div>

 <script>
/* ===== è¨­å®š ===== */
const API=(window.API_BASE||'https://api.murain.tw').replace(/\/$/,'');
const RATE_TABLE={3:0,6:4.0,9:5.5,12:6.5,18:9.0,24:11.5};
let CART_TOTAL_RAW = 0;   // çœŸå¯¦é‡‘é¡ï¼ˆæ•¸å­—ï¼‰
 let AVAILABLE_CREDIT = 0; // æœƒå“¡å¯ç”¨è³¼ç‰©é‡‘
let CREDIT_USED = 0;      // æœ¬æ¬¡å¯¦éš›æœ‰æŠ˜æŠµçš„è³¼ç‰©é‡‘

// ===== LIFF è¨­å®š =====
const LIFF_ID = "2008430261-KLwoQjm4";

let LINE_PROFILE = null;
let MEMBER_INFO  = null;

// æ›´æ–°è³¼ç‰©é‡‘ UI
function updateCreditUIFromMember(info){
  let credit = 0;
  if (info) {
    if (typeof info.credit === "number") {
      credit = info.credit;
    } else if (info.member && typeof info.member.credit === "number") {
      credit = info.member.credit;
    }
  }

  AVAILABLE_CREDIT = credit;

  // æ›´æ–°ã€Œå¯ç”¨é¤˜é¡ï¼šNT$ xxxã€
  const el = document.getElementById('credit_available');
  if (el) {
    el.textContent = "å¯ç”¨é¤˜é¡ï¼šNT$ " + credit.toLocaleString();
  }

  // è®“ã€ŒæŠ˜æŠµå¾Œå¯¦éš›ä»˜æ¬¾é‡‘é¡ã€ä¸€èµ·é‡æ–°è¨ˆç®—
  updateCreditAndTotal();
}

async function initLiffAndMember() {
  if (!window.liff) return;

  await liff.init({ liffId: LIFF_ID });

  if (!liff.isLoggedIn() && liff.getOS() === 'web') {
    try {
      saveCheckoutState();
    } catch (e) {
      console.warn('saveCheckoutState before liff.login failed', e);
    }
    liff.login();
    return;
  }

  const profile = await liff.getProfile();
  LINE_PROFILE = profile;

  try {
    const r = await fetch(`${API}/line/member-info?user_id=${encodeURIComponent(profile.userId)}`);
    const j = await r.json();
    if (j && j.ok) {
      MEMBER_INFO = j;
      applyMemberInfoToForm(j);
    }
  } catch (e) {
    console.log('member-info error', e);
  }
}
// ========= æœƒå“¡è³‡æ–™ â†’ å„ä»˜æ¬¾/å‡ºè²¨æ¬„ä½é å¡« =========
function applyMemberInfoToForm(info) {
  if (!info) return;

  updateCreditUIFromMember(info);

  const name      = info.name  || "";
  const phone     = info.phone || "";
  const email     = info.email || "";
  const storeId   = info.storeId   || "";
  const storeName = info.storeName || "";
  const storeAddr = info.storeAddr || "";
  const shipZip   = info.shipZip  || "";
  const shipAddr  = info.shipAddr || "";

  function fillIfEmpty(selector, val) {
    if (!val) return;
    const el = document.querySelector(selector);
    if (el && !el.value) {
      el.value = val;
    }
  }

  [
    '#cod_name',
    '#ship_name_paid',
    '#paid_post_name',
    '#paid_meet_name',
    '#dep_old_name',
    '#dep_new_full_name',
    '#dep_new_full_meet_name',
    '#ship_name_zc',
    '#zc_post_name',
    '#zc_meet_name'
  ].forEach(sel => fillIfEmpty(sel, name));

  [
    '#cod_phone',
    '#ship_phone_paid',
    '#paid_post_phone',
    '#paid_meet_phone',
    '#dep_old_phone',
    '#dep_new_full_phone',
    '#dep_new_full_meet_phone',
    '#ship_phone_zc',
    '#zc_post_phone',
    '#zc_meet_phone'
  ].forEach(sel => fillIfEmpty(sel, phone));

  [
    '#cod_email',
    '#paid_email',
    '#paid_post_email',
    '#paid_meet_email',
    '#dep_old_email',
    '#dep_new_full_email',
    '#dep_new_full_meet_email',
    '#zc_email',
    '#zc_post_email',
    '#zc_meet_email'
  ].forEach(sel => fillIfEmpty(sel, email));

  [
    '#cod_store_id',
    '#ship_store_id_paid',
    '#dep_old_store_id',
    '#dep_new_full_store_id',
    '#ship_store_id_zc'
  ].forEach(sel => fillIfEmpty(sel, storeId));

  [
    '#cod_store_name',
    '#ship_store_name_paid',
    '#dep_old_store_name',
    '#dep_new_full_store_name',
    '#ship_store_name_zc'
  ].forEach(sel => fillIfEmpty(sel, storeName));

  [
    '#cod_store_addr',
    '#ship_store_addr_paid',
    '#dep_old_store_addr',
    '#dep_new_full_store_addr',
    '#ship_store_addr_zc'
  ].forEach(sel => fillIfEmpty(sel, storeAddr));

  [
    '#paid_post_zip',
    '#dep_old_post_zip',
    '#dep_new_full_post_zip',
    '#zc_post_zip'
  ].forEach(sel => fillIfEmpty(sel, shipZip));

  [
    '#paid_post_addr',
    '#dep_old_post_addr',
    '#dep_new_full_post_addr',
    '#zc_post_addr'
  ].forEach(sel => fillIfEmpty(sel, shipAddr));
}

/* ===== å·¥å…· ===== */
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>[...r.querySelectorAll(s)];
const money=n=>'NT$ '+Number(n||0).toLocaleString();

const qs = new URLSearchParams(location.search);
let cartToken = qs.get('cart_token') || '';

if (!cartToken) {
  try {
    cartToken = localStorage.getItem('murain_cart_token') || '';
  } catch (e) {
    console.warn('localStorage read error', e);
  }
} else {
  try {
    localStorage.setItem('murain_cart_token', cartToken);
  } catch (e) {
    console.warn('localStorage write error', e);
  }
}

const customer   = (qs.get('customer')||'old').toLowerCase();
const initialMode=(qs.get('mode')||'').toUpperCase();
const tailOf     = qs.get('tail_of') || '';

function setTotal(v){
  CART_TOTAL_RAW = Number(v || 0);
  const sub = document.querySelector('#subtotal');
  const tot = document.querySelector('#total');
  const txt = money(CART_TOTAL_RAW);
  if (sub) sub.value = txt;
  if (tot) tot.value = txt;
  updateCreditAndTotal();
}

/* ===== Tabs ===== */
const tabs=$$('#payTabs .tab');
tabs.forEach(t=>t.addEventListener('click',()=>{
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const kt=t.dataset.pay;
  ['COD','PAID','DEPOSIT','ZEROCARD'].forEach(x=>$('#pane'+x).hidden=(x!==kt));
}));

/* ===== PAID ===== */
function updatePaidChannelBox(){
  const ch = $('#paid_channel').value;
  $('#cardInstBox').hidden = (ch !== 'card_inst');
}
$('#paid_channel').addEventListener('change', updatePaidChannelBox);
$('#paid_ship_method').addEventListener('change', updatePaidShip);

function updatePaidShip(){
  const m = $('#paid_ship_method').value;
  $('#paidShip711').hidden = (m !== '711');
  $('#paidShipPost').hidden = (m !== 'post');
  const meet = $('#paidShipMeetup');
  if (meet) meet.hidden = (m !== 'meetup');
}
// ===== CODï¼šè²¨åˆ° / é¢äº¤ åˆ‡æ› =====
const codTypeRadios = document.querySelectorAll('input[name="codType"]');

function refreshCodType() {
  const checked = document.querySelector('input[name="codType"]:checked');
  const v = checked ? checked.value : '711';
  const box711 = document.querySelector('#cod711Extra');
  const meetHint = document.querySelector('#codMeetHint');
  if (box711) box711.hidden = (v !== '711');
  if (meetHint) meetHint.hidden = (v !== 'meetup');
}

if (codTypeRadios.length) {
  codTypeRadios.forEach(r => r.addEventListener('change', refreshCodType));
  refreshCodType();
}
/* ===== DEPOSITï¼šåˆ‡æ› Pane ===== */
$('#dep_new_full_method').addEventListener('change', () => {
  const m = $('#dep_new_full_method').value;
  $('#depNewFull711').hidden = (m !== '711');
  $('#depNewFullPost').hidden = (m !== 'post');
  const meet = $('#depNewFullMeetup');
  if (meet) meet.hidden = (m !== 'meetup');
});

const depOldMethod  = $('#dep_old_method');
const depOldBox711  = $('#dep_old_box_711');
const depOldBoxPost = $('#dep_old_box_post');

function updateDepOldShip(){
  if (!depOldMethod) return;
  const m = depOldMethod.value;
  if (depOldBox711)  depOldBox711.hidden  = (m !== '711');
  if (depOldBoxPost) depOldBoxPost.hidden = (m !== 'post');
}

if (depOldMethod) {
  depOldMethod.addEventListener('change', updateDepOldShip);
  updateDepOldShip();
}

const depTypeRadios     = document.querySelectorAll('input[name="depType"]');
const depOldPane        = document.querySelector('#depOldPane');
const depNewFullPane    = document.querySelector('#depNewFullPane');
const depOldDepositBox  = document.querySelector('#dep_old_deposit_fields');
const depOldAmount      = document.querySelector('#dep_old_amount');
const depOldHoldUntil   = document.querySelector('#dep_old_hold_until');

function refreshDepType() {
  const checked   = document.querySelector('input[name="depType"]:checked');
  const v         = checked ? checked.value : 'new_full';
  const isDeposit = (v === 'old');

  if (depOldPane && depNewFullPane) {
    depOldPane.hidden     = !isDeposit;
    depNewFullPane.hidden =  isDeposit;
  }

  if (depOldDepositBox) depOldDepositBox.hidden = !isDeposit;
  if (depOldAmount)     depOldAmount.required   = isDeposit;
  if (depOldHoldUntil)  depOldHoldUntil.required= isDeposit;
}

if (depTypeRadios.length) {
  depTypeRadios.forEach(r => r.addEventListener('change', refreshDepType));
  refreshDepType();
}

/* ===== ZEROCARD ===== */
function calcZC(){
  const months = Number($('#zc_months').value || 3);

  // â˜… ç”¨æŠ˜æŠµå¾Œå¯¦éš›åˆ†æœŸé‡‘é¡
  const base = Math.max((CART_TOTAL_RAW || 0) - CREDIT_USED, 0);

  const rate  = (RATE_TABLE[months] || 0) / 100;
  const total = Math.round(base * (1 + rate));
  const each  = Math.round(total / months);

  $('#zc_each').value = money(each) + ' Ã— ' + months + ' æœŸ';
}
$('#zc_months').addEventListener('change',calcZC);
$('#zc_ship_method').addEventListener('change',updateZcShip);

function updateZcShip(){
  const m = $('#zc_ship_method').value;
  $('#zcShip711').hidden = (m !== '711');
  $('#zcShipPost').hidden = (m !== 'post');
  const meet = $('#zcShipMeetup');
  if (meet) meet.hidden = (m !== 'meetup');
}

/* ===== è³¼ç‰©è»Šè¼‰å…¥ ===== */
async function loadCart(){
  if (!cartToken) {
    console.warn('missing cart_token');
    return;
  }
  try {
    const r = await fetch(`${API}/cart/${cartToken}`);
    const j = await r.json();

    if (!r.ok || !j.items) {
      throw new Error('cart_api_error');
    }

    const items = j.items || [];
    const total = Number(j.total_amount || 0);
    CART_TOTAL_RAW = total;

    const detail = items.map(it => 
      `${it.name || it.sku} x ${it.qty}ï¼ˆNT$${Number(it.price || 0)}ï¼‰`
    ).join('\n');

    const detailBox = document.querySelector('#itemsText');
    if (detailBox) detailBox.value = detail;

    setTotal(total);
    calcZC();
  } catch (e) {
    console.error('loadCart error', e);
    alert('è®€å–è³¼ç‰©è»Šå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚');
  }
}

/* ===== 7-11 åœ°åœ– ===== */
function open711(src) {
  saveCheckoutState();
  const qs2 = new URLSearchParams(location.search);
  qs2.set('src', src);
  const url = `${API}/cvs/map?${qs2.toString()}`;
  window.location.href = url;
}

function applyStoreFromURL(){
  const qs2 = new URLSearchParams(location.search);
  const src = (qs2.get('store_src') || '').toLowerCase();
  const id   = qs2.get('store_id')    || '';
  const name = qs2.get('store_name') || '';
  const addr = qs2.get('store_addr') || '';
  if (!src || !id) return;

  const fill = (a,b,c)=>{ setFieldValue(a,id); setFieldValue(b,name); setFieldValue(c,addr); };

  switch (src) {
    case 'cod':       fill('#cod_store_id', '#cod_store_name', '#cod_store_addr'); break;
    case 'paid':      fill('#ship_store_id_paid', '#ship_store_name_paid', '#ship_store_addr_paid'); break;
    case 'dep_old':   fill('#dep_old_store_id', '#dep_old_store_name', '#dep_old_store_addr'); break;
    case 'dep_new_f': fill('#dep_new_full_store_id', '#dep_new_full_store_name', '#dep_new_full_store_addr'); break;
    case 'zc':        fill('#ship_store_id_zc', '#ship_store_name_zc', '#ship_store_addr_zc'); break;
  }
}
// ===== è³¼ç‰©é‡‘æŠ˜æŠµè¨ˆç®— =====
function updateCreditAndTotal() {
  const input = document.querySelector('#credit_input');
  const after = document.querySelector('#total_after_credit');
  const msgEl = document.querySelector('#credit_msg');

  let used = 0;
  if (input && input.value !== '') {
    used = Math.floor(Number(input.value) || 0);
  }
  if (used < 0) used = 0;

  const maxUse = Math.min(AVAILABLE_CREDIT, CART_TOTAL_RAW);
  if (used > maxUse) used = maxUse;

  CREDIT_USED = used;

  if (input) {
    if (input.value !== '') {
      input.value = String(used);
    }
  }

  if (msgEl) {
    if (CART_TOTAL_RAW <= 0) {
      msgEl.textContent = '';
    } else if (AVAILABLE_CREDIT <= 0) {
      msgEl.textContent = 'ç›®å‰ç„¡å¯ç”¨è³¼ç‰©é‡‘ã€‚';
    } else if (CREDIT_USED > 0) {
      msgEl.textContent = `æœ¬æ¬¡å°‡æŠ˜æŠµ NT$ ${CREDIT_USED.toLocaleString()}ï¼Œå¯¦éš›ä»˜æ¬¾é‡‘é¡å¦‚ä¸‹ã€‚`;
    } else {
      msgEl.textContent = 'è‹¥ä¸ä½¿ç”¨è³¼ç‰©é‡‘ï¼Œå¯å°‡æ­¤æ¬„ä½ç•™ç©ºã€‚';
    }
  }

  const pay = Math.max(CART_TOTAL_RAW - CREDIT_USED, 0);
  if (after) after.value = money(pay);
  try { calcZC(); } catch (e) {}
}

// ç¶å®šè³¼ç‰©é‡‘è¼¸å…¥äº‹ä»¶
const creditInputEl = document.querySelector('#credit_input');
if (creditInputEl) {
  creditInputEl.addEventListener('input', updateCreditAndTotal);
}

function setFieldValue(sel, val){
  const el = document.querySelector(sel);
  if (!el) return false;
  el.value = val || '';
  try {
    el.dispatchEvent(new Event('input', {bubbles:true}));
    el.dispatchEvent(new Event('change', {bubbles:true}));
  } catch(e){}
  return true;
}

function normalizeStorePayload(ev){
  const d = ev && ev.data;
  if (!d) return null;

  if (d.type === '711_store' && d.data) {
    const p = d.data;
    return {
      ok: !!p.ok,
      src: p.src || '',
      id:   p.id   || p.cvs_code || p.store_id || p.CVSStoreID || p.STOREID || '',
      name: p.name || p.cvs_name || p.store_name || p.CVSStoreName || p.STORENAME || '',
      addr: p.addr || p.cvs_addr || p.store_address || p.CVSAddress || p.STOREADDRESS || ''
    };
  }

  if (d.type === 'cvs_selected') {
    return {
      ok: true,
      src: d.src || '',
      id:   d.cvs_code || d.id || d.store_id || d.CVSStoreID || d.STOREID || '',
      name: d.cvs_name || d.name || d.store_name || d.CVSStoreName || d.STORENAME || '',
      addr: d.cvs_addr || d.addr || d.store_address || d.CVSAddress || d.STOREADDRESS || ''
    };
  }

  return null;
}

window.addEventListener('message', (ev)=>{
  const p = normalizeStorePayload(ev);
  if (!p || !p.ok) return;
  const src = (p.src || '').toLowerCase();
  const fill = (a,b,c)=>{ setFieldValue(a, p.id); setFieldValue(b, p.name); setFieldValue(c, p.addr); };
  switch (src) {
    case 'cod':        fill('#cod_store_id', '#cod_store_name', '#cod_store_addr'); break;
    case 'paid':       fill('#ship_store_id_paid', '#ship_store_name_paid', '#ship_store_addr_paid'); break;
    case 'dep_old':    fill('#dep_old_store_id', '#dep_old_store_name', '#dep_old_store_addr'); break;
    case 'dep_new_f':  fill('#dep_new_full_store_id', '#dep_new_full_store_name', '#dep_new_full_store_addr'); break;
    case 'zc':         fill('#ship_store_id_zc', '#ship_store_name_zc', '#ship_store_addr_zc'); break;
  }
});

/* checkout ç‹€æ…‹æš«å­˜ */
const CHECKOUT_STATE_KEY = 'murain_checkout_state_v1';

function saveCheckoutState() {
  const state = {};
  document.querySelectorAll('input, select, textarea').forEach(el => {
    const key = el.id || el.name;
    if (!key) return;

    if (el.type === 'radio' || el.type === 'checkbox') {
      if (!state[key]) state[key] = {};
      state[key][el.value] = el.checked;
    } else {
      state[key] = el.value;
    }
  });
  try {
    localStorage.setItem(CHECKOUT_STATE_KEY, JSON.stringify(state));
  } catch (e) {
    console.warn('saveCheckoutState failed', e);
  }
}

function restoreCheckoutState() {
  let raw = null;
  try {
    raw = localStorage.getItem(CHECKOUT_STATE_KEY);
  } catch (e) {
    console.warn('restoreCheckoutState getItem failed', e);
  }
  if (!raw) return;

  let state;
  try {
    state = JSON.parse(raw);
  } catch {
    return;
  }

  document.querySelectorAll('input, select, textarea').forEach(el => {
    const key = el.id || el.name;
    if (!key || !(key in state)) return;

    if (el.type === 'radio' || el.type === 'checkbox') {
      const map = state[key];
      if (map && typeof map === 'object') {
        el.checked = !!map[el.value];
      }
    } else {
      el.value = state[key];
    }
  });
}

function clearCheckoutState() {
  try {
    localStorage.removeItem(CHECKOUT_STATE_KEY);
  } catch (e) {}
}

/* ç¶å®šæ‰€æœ‰ 7-11 åœ°åœ–æŒ‰éˆ• */
$('#mapCOD').addEventListener('click',e=>{e.preventDefault();open711('cod');});
$('#mapPAID').addEventListener('click',e=>{e.preventDefault();open711('paid');});
$('#mapDepOld').addEventListener('click',e=>{e.preventDefault();open711('dep_old');});
$('#mapDepNewFull').addEventListener('click',e=>{e.preventDefault();open711('dep_new_f');});
$('#mapZC').addEventListener('click',e=>{e.preventDefault();open711('zc');});

/* ===== é€å‡º ===== */
function required(v){ return v && String(v).trim().length>0; }

document.getElementById('submitBtn').addEventListener('click',async(e)=>{
  e.preventDefault();
  if(!cartToken){ alert('ç¼ºå°‘ cart_tokenï¼Œè«‹ç”±æ­£ç¢ºçµå¸³é€£çµé€²å…¥'); return; }

  const subtotal = CART_TOTAL_RAW;
  if(!subtotal){ alert('é‡‘é¡ç‚º 0ï¼Œè«‹ç¢ºèªè³¼ç‰©è»Šå…§å®¹'); return; }

  const note = $('#note').value || '';
  const shipping_info = { customer_type: customer, note };

   // è³¼ç‰©é‡‘é©—è­‰
  const creditInput = document.getElementById('credit_input');
  let creditUsed = 0;
  if (creditInput && creditInput.value) {
    creditUsed = Number(creditInput.value);
    if (!Number.isFinite(creditUsed) || creditUsed < 0) {
      alert('è³¼ç‰©é‡‘ä½¿ç”¨é‡‘é¡è«‹å¡«ã€Œ0 ä»¥ä¸Šçš„æ•¸å­—ã€ï¼Œè‹¥ä¸ä½¿ç”¨å¯ç•™ç©ºã€‚');
      return;
    }
  }
  let maxCredit = 0;
  if (MEMBER_INFO) {
    if (typeof MEMBER_INFO.credit === 'number') {
      maxCredit = MEMBER_INFO.credit;
    } else if (MEMBER_INFO.member && typeof MEMBER_INFO.member.credit === 'number') {
      maxCredit = MEMBER_INFO.member.credit;
    }
  }
  if (creditUsed > maxCredit) {
    alert('è³¼ç‰©é‡‘ä½¿ç”¨é‡‘é¡ä¸å¯è¶…éå¯ç”¨é¤˜é¡ï¼ˆNT$ ' + maxCredit.toLocaleString() + 'ï¼‰ã€‚');
    return;
  }
  if (creditUsed > subtotal) {
    alert('è³¼ç‰©é‡‘ä½¿ç”¨é‡‘é¡ä¸å¯è¶…éæœ¬æ¬¡æ‡‰ä»˜é‡‘é¡ã€‚');
    return;
  }

 //â“¸ æ‰€æœ‰æª¢æŸ¥éƒ½é€šéä¹‹å¾Œï¼Œå†å¯«é€² shipping_info
if (creditUsed > 0) {
  shipping_info.credit_used = creditUsed;
}

  // LIFF profile / LINE ç¶å®š
  if (LINE_PROFILE && LINE_PROFILE.userId) {
    shipping_info.line = {
      user_id: LINE_PROFILE.userId,
      display_name: LINE_PROFILE.displayName || ""
    };
  } else {
    const uidInput = document.getElementById('line_user_id');
    const nameInput = document.getElementById('line_display_name');
    const uid = uidInput ? uidInput.value : '';
    const name = nameInput ? nameInput.value : '';
    if (uid) {
      shipping_info.line = {
        user_id: uid,
        display_name: name
      };
    }
  }

  if (!shipping_info.line || !shipping_info.line.user_id) {
    alert('è«‹å…ˆåœ¨ LINE å®˜æ–¹å¸³è™Ÿä¸­é–‹å•Ÿé€™å€‹çµå¸³é ï¼Œå®Œæˆ LINE æœƒå“¡ç¶å®šå¾Œå†é€å‡ºè¨‚å–®');
    return;
  }

 let depTypeSelected = null;  // â­ æ–°å¢é€™è¡Œ 
 let payment_method = '';
  let ship = null;

  const activeTab = [...tabs].find(t=>t.classList.contains('active'))?.dataset.pay || 'COD';

  // ===== CODï¼šè²¨åˆ° / é¢äº¤ =====
  if (activeTab === 'COD') {
    const codType = (document.querySelector('input[name="codType"]:checked')?.value || '711');

    const name  = $('#cod_name').value;
    const phone = $('#cod_phone').value;
    const emailCod = ($('#cod_email').value || '').trim();

    if (![name, phone, emailCod].every(required)) {
      alert('è«‹å¡«å®Œå§“åã€é›»è©±èˆ‡ Email');
      return;
    }

    if (codType === '711') {
      const id    = $('#cod_store_id').value;
      const sname = $('#cod_store_name').value;
      const addr  = $('#cod_store_addr').value;

      if (![id, sname, addr].every(required)) {
        alert('è«‹å¡«å®Œ 7-11 è²¨åˆ°ä»˜æ¬¾çš„é–€å¸‚è³‡æ–™');
        return;
      }

      // ä¿æŒåŸæœ¬çš„ payment_methodï¼Œé¿å…å¾Œç«¯å£æ‰
      payment_method = 'cod_711';
      ship = {
        type: '711',
        name,
        phone,
        email: emailCod,
        store: { id, name: sname, addr }
      };
    } else if (codType === 'meetup') {
      // æ–°å¢ï¼šé¢äº¤ç¾é‡‘
      payment_method = 'meetup_cash';
      ship = {
        type: 'meetup',
        name,
        phone,
        email: emailCod
      };
    }
  }

  // ===== PAID =====
  if (activeTab === 'PAID') {
    const channel    = $('#paid_channel').value;
    const shipMethod = $('#paid_ship_method').value;

    payment_method = `paid_${channel}`;
    if (channel === 'card_inst') {
      payment_method += `_${$('#inst_months').value}`;
    }

    if (shipMethod === '711') {
      const name  = $('#ship_name_paid').value;
      const phone = $('#ship_phone_paid').value;
      const id    = $('#ship_store_id_paid').value;
      const sname = $('#ship_store_name_paid').value;
      const addr  = $('#ship_store_addr_paid').value;
      const emailPaid = ($('#paid_email').value || '').trim();

      if (![name, phone, id, sname, addr, emailPaid].every(required)) {
        alert('è«‹å¡«å®Œ 7-11 æ”¶ä»¶è³‡æ–™ï¼ˆå« Emailï¼‰');
        return;
      }

      ship = {
        type: '711',
        name,
        phone,
        email: emailPaid,
        store: { id, name: sname, addr }
      };
    } else if (shipMethod === 'post') {
      const name  = $('#paid_post_name').value;
      const phone = $('#paid_post_phone').value;
      const zip   = $('#paid_post_zip').value;
      const addr  = $('#paid_post_addr').value;
      const emailPost = ($('#paid_post_email').value || '').trim();

      if (![name, phone, addr, emailPost].every(required)) {
        alert('è«‹å¡«å®Œéƒµå¯„è³‡æ–™ï¼ˆå« Emailï¼‰');
        return;
      }

      ship = {
        type: 'post',
        name,
        phone,
        email: emailPost,
        post: { zip, addr }
      };
    } else if (shipMethod === 'meetup') {
      const name  = $('#paid_meet_name').value;
      const phone = $('#paid_meet_phone').value;
      const emailMeet = ($('#paid_meet_email').value || '').trim();

      if (![name, phone, emailMeet].every(required)) {
        alert('è«‹å¡«å®Œé¢äº¤è¯çµ¡è³‡æ–™ï¼ˆå« Emailï¼‰');
        return;
      }

      ship = {
        type: 'meetup',
        name,
        phone,
        email: emailMeet
      };
    } else {
      alert('è«‹å…ˆé¸æ“‡å–è²¨æ–¹å¼');
      return;
    }
  }

  // ===== DEPOSIT =====
 if (activeTab === 'DEPOSIT') {
  const depType = $('input[name="depType"]:checked').value; // new_full / old

  // â˜… è¨‚é‡‘ä¿ç•™ç›®å‰ä¸æ”¯æ´ä½¿ç”¨è³¼ç‰©é‡‘
  if (depType === 'old' && creditUsed > 0) {
    alert('ã€ŒåŒ¯æ¬¾å®šé‡‘ï¼ˆä¿ç•™ï¼‰ã€ç›®å‰ä¸æ”¯æ´ä½¿ç”¨è³¼ç‰©é‡‘æŠ˜æŠµï¼Œè«‹å…ˆæŠŠè³¼ç‰©é‡‘æ¬„ä½æ¸…ç©ºï¼Œæˆ–æ”¹ç”¨åŒ¯æ¬¾å…¨é¡ / å…¶ä»–ä»˜æ¬¾æ–¹å¼ã€‚');
    return;
  }

    // åŒ¯æ¬¾è¨‚é‡‘ï¼ˆä¿ç•™ï¼‰
    if (depType === 'old') {
      const method   = $('#dep_old_method').value;
      const name     = $('#dep_old_name').value;
      const phone    = $('#dep_old_phone').value;
      const amount   = $('#dep_old_amount').value;
      const last5    = $('#dep_old_last5').value;
      const hold     = $('#dep_old_hold_until').value;
      const emailOld = ($('#dep_old_email').value || '').trim();

      if (![name, phone, amount, last5, hold, emailOld].every(required)) {
        alert('è«‹å¡«å®Œã€ŒåŒ¯æ¬¾å®šé‡‘ï¼ˆä¿ç•™ 1 å€‹æœˆï¼‰ã€æ¬„ä½ï¼ˆå« Emailã€åŒ¯æ¬¾é‡‘é¡ã€å¸³è™Ÿå¾Œäº”ç¢¼ã€ä¿ç•™åˆ°æœŸæ—¥ï¼‰');
        return;
      }

      const today   = new Date(); today.setHours(0,0,0,0);
      const maxDate = new Date(); maxDate.setDate(maxDate.getDate() + 31); maxDate.setHours(0,0,0,0);
      const holdDate = hold ? new Date(hold) : null;

      if (!holdDate || holdDate < today || holdDate > maxDate) {
        alert('ä¿ç•™åˆ°æœŸæ—¥è«‹é¸æ“‡ã€Œä»Šå¤©èµ· 1 å€‹æœˆå…§ã€çš„æ—¥æœŸ');
        return;
      }

      if (method === '711') {
        const id    = $('#dep_old_store_id').value;
        const sname = $('#dep_old_store_name').value;
        const addr  = $('#dep_old_store_addr').value;

        if (![id, sname, addr].every(required)) {
          alert('è«‹å¡«å®Œ 7-11 æ”¶ä»¶è³‡æ–™');
          return;
        }

        ship = {
          type: '711',
          name,
          phone,
          email: emailOld,
          store: { id, name: sname, addr },
          deposit: {
            type: 'old',
            amount,
            last5,
            hold_until: hold
          }
        };
      } else if (method === 'post') {
        const zip  = $('#dep_old_post_zip').value;
        const addr = $('#dep_old_post_addr').value;

        if (![addr].every(required)) {
          alert('è«‹å¡«å®Œéƒµå¯„æ”¶ä»¶è³‡æ–™');
          return;
        }

        ship = {
          type: 'post',
          name,
          phone,
          email: emailOld,
          post: { zip, addr },
          deposit: {
            type: 'old',
            amount,
            last5,
            hold_until: hold
          }
        };
      } else {
        alert('è«‹å…ˆé¸æ“‡å–è²¨æ–¹å¼');
        return;
      }

      payment_method = 'deposit_old';
    }

    // åŒ¯æ¬¾å…¨é¡
    else if (depType === 'new_full') {
  const method    = $('#dep_new_full_method').value;   // 711 / post / meetup
  const emailNewF = ($('#dep_new_full_email').value || '').trim();
  const last5     = $('#dep_new_full_last5').value;

  // â˜… æŠ˜æŠµå¾Œå¯¦éš›è¦åŒ¯çš„é‡‘é¡ï¼ˆæœ€ä½ 0ï¼‰
  const payAmount = Math.max((CART_TOTAL_RAW || 0) - creditUsed, 0);

  const depNewFullAmountInput = $('#dep_new_full_amount');
  if (depNewFullAmountInput) {
    depNewFullAmountInput.value = payAmount;
  }

  if (method === '711') {
        const name   = $('#dep_new_full_name').value;
        const phone  = $('#dep_new_full_phone').value;
        const id     = $('#dep_new_full_store_id').value;
        const sname  = $('#dep_new_full_store_name').value;
        const addr   = $('#dep_new_full_store_addr').value;

        if (![name, phone, id, sname, addr, last5, emailNewF].every(required)) {
          alert('è«‹å¡«å®ŒåŒ¯æ¬¾å…¨é¡ï¼ˆ7-11ï¼‰æ¬„ä½ï¼ˆå« Emailã€å¸³è™Ÿå¾Œäº”ç¢¼ï¼‰');
          return;
        }

        payment_method = 'deposit_new_full_711';
    ship = {
      type: '711',
      name,
      phone,
      email: emailNewF,
      store: { id, name: sname, addr },
      deposit: { type: 'new_full', method: '711', amount: payAmount, last5 }
    };
  } else if (method === 'post') {
        const name   = $('#dep_new_full_name').value;
        const phone  = $('#dep_new_full_phone').value;
        const zip    = $('#dep_new_full_post_zip').value;
        const addr   = $('#dep_new_full_post_addr').value;

        if (![name, phone, addr, last5, emailNewF].every(required)) {
          alert('è«‹å¡«å®ŒåŒ¯æ¬¾å…¨é¡ï¼ˆéƒµå¯„ï¼‰æ¬„ä½ï¼ˆå« Emailã€å¸³è™Ÿå¾Œäº”ç¢¼ï¼‰');
          return;
        }

        payment_method = 'deposit_new_full_post';
    ship = {
      type: 'post',
          name,
          phone,
          email: emailNewF,
          post: { zip, addr },
          deposit: { type: 'new_full', method: 'post', amount: payAmount, last5 }
    };
  } else if (method === 'meetup') {
        const name   = $('#dep_new_full_meet_name').value;
        const phone  = $('#dep_new_full_meet_phone').value;
        const emailMeet = ($('#dep_new_full_meet_email').value || '').trim();

        if (![name, phone, last5, emailMeet].every(required)) {
          alert('è«‹å¡«å®ŒåŒ¯æ¬¾å…¨é¡ï¼ˆé¢äº¤ï¼‰æ¬„ä½ï¼ˆå« Emailã€å¸³è™Ÿå¾Œäº”ç¢¼ï¼‰');
          return;
        }

        payment_method = 'deposit_new_full_meetup';
    ship = {
      type: 'meetup',
          name,
          phone,
          email: emailMeet,
          deposit: { type: 'new_full', method: 'meetup', amount: payAmount, last5 }
    };
  } else {
    alert('è«‹å…ˆé¸æ“‡åŒ¯æ¬¾å…¨é¡çš„å–è²¨æ–¹å¼');
    return;
  }
}
   }    // â† â˜…â˜…â˜… æ–°å¢é€™ä¸€è¡Œï¼šé—œé–‰ if (activeTab === 'DEPOSIT')


  // ===== ZEROCARDï¼ˆä¸­ç§Ÿç„¡å¡é›¶è§’ï¼‰ =====
  if (activeTab === 'ZEROCARD') {
    const months = $('#zc_months').value;
    payment_method = `zero_card_${months}`;

    const shipMethod = $('#zc_ship_method').value;

    if (shipMethod === '711') {
      const name  = $('#ship_name_zc').value;
      const phone = $('#ship_phone_zc').value;
      const id    = $('#ship_store_id_zc').value;
      const sname = $('#ship_store_name_zc').value;
      const addr  = $('#ship_store_addr_zc').value;
      const emailZc = ($('#zc_email').value || '').trim();

      if (![name, phone, id, sname, addr, emailZc].every(required)) {
        alert('è«‹å¡«å®Œ 7-11 æ”¶ä»¶è³‡æ–™ï¼ˆå« Emailï¼‰');
        return;
      }

      ship = {
        type: '711',
        name,
        phone,
        email: emailZc,
        store: { id, name: sname, addr }
      };
    } else if (shipMethod === 'post') {
      const name  = $('#zc_post_name').value;
      const phone = $('#zc_post_phone').value;
      const zip   = $('#zc_post_zip').value;
      const addr  = $('#zc_post_addr').value;
      const emailZcPost = ($('#zc_post_email').value || '').trim();

      if (![name, phone, addr, emailZcPost].every(required)) {
        alert('è«‹å¡«å®Œéƒµå¯„è³‡æ–™ï¼ˆå« Emailï¼‰');
        return;
      }

      ship = {
        type: 'post',
        name,
        phone,
        email: emailZcPost,
        post: { zip, addr }
      };
    } else if (shipMethod === 'meetup') {
      const name  = $('#zc_meet_name').value;
      const phone = $('#zc_meet_phone').value;
      const emailMeet = ($('#zc_meet_email').value || '').trim();

      if (![name, phone, emailMeet].every(required)) {
        alert('è«‹å¡«å®Œé¢äº¤è¯çµ¡è³‡æ–™ï¼ˆå« Emailï¼‰');
        return;
      }

      ship = {
        type: 'meetup',
        name,
        phone,
        email: emailMeet
      };
    } else {
      alert('è«‹å…ˆé¸æ“‡å–è²¨æ–¹å¼');
      return;
    }
  }

  if(!payment_method || !ship){
    alert('è«‹å…ˆé¸æ“‡ä»˜æ¬¾æ–¹å¼ï¼Œä¸¦å¡«å®Œå¿…è¦æ¬„ä½');
    return;
  }

  shipping_info.ship = ship;
  const isZeroCard = payment_method.startsWith('zero_card_');

  try{
    $('#submitBtn').disabled = true;

    const payload = { cart_token: cartToken, payment_method, shipping_info };

    const r = await fetch(`${API}/checkout`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    if (!r.ok || !j.ok) {
      const msg = j.message || j.error || 'é€å‡ºå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡';
      throw new Error(msg);
    }

    try {
  if (j.next_url) {
    const v = String(j.next_url);
    sessionStorage.setItem("MEETUP_NEXT_URL", v);
    localStorage.setItem("MEETUP_NEXT_URL", v);
  }
} catch (e) {} 

    clearCheckoutState();
    try {
      localStorage.removeItem('MURAIN_WEB_CART_TOKEN');
    } catch (e) {}

    // PayUni
    if (payment_method && payment_method.startsWith('paid_')) {
      try {
        const pr = await fetch(`${API}/payuni/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order_id: j.order_id })
        });

        const up = await pr.json();
        console.log('payuni start resp', up);

        if (!pr.ok || !up.ok) {
          alert('ç·šä¸Šåˆ·å¡å•Ÿå‹•å¤±æ•—ï¼š' + (up.error || up.message || ''));
          return;
        }

        const f = document.createElement('form');
        f.method = 'POST';
        f.action = up.url;

        ['MerID', 'Version', 'EncryptInfo', 'HashInfo'].forEach(k => {
          const input = document.createElement('input');
          input.type  = 'hidden';
          input.name  = k;
          input.value = up[k];
          f.appendChild(input);
        });

        document.body.appendChild(f);
        f.submit();
        return;
      } catch (e) {
        console.error('payuni error', e);
        alert('ç·šä¸Šåˆ·å¡å•Ÿå‹•å¤±æ•—ï¼ˆç¶²è·¯æˆ–ç¨‹å¼éŒ¯èª¤ï¼‰');
        return;
      }
    }

    // ZeroCard
    if (isZeroCard) {
      try {
        const zr = await fetch(`${API}/zero-card/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order_id: j.order_id })
        });

        const z = await zr.json();
        console.log('zero-card start resp', z);

        if (!zr.ok || !z.ok) {
          alert('ä¸­ç§Ÿç„¡å¡å•Ÿå‹•å¤±æ•—ï¼š' + (z.error || z.message || ''));
          return;
        }

        location.href = z.payment_url;
        return;
      } catch (e) {
        console.error('zero-card error', e);
        alert('ä¸­ç§Ÿç„¡å¡å•Ÿå‹•å¤±æ•—ï¼ˆç¶²è·¯æˆ–ç¨‹å¼éŒ¯èª¤ï¼‰');
        return;
      }
    }

    const payTotal = Math.max(subtotal - creditUsed, 0);
const url = `/order-result.html?order_id=${encodeURIComponent(j.order_id)}&total=${encodeURIComponent(payTotal)}`;
    try{
      location.href = url;
    }catch(e){
      alert(`ä¸‹å–®æˆåŠŸï¼è¨‚å–®ç·¨è™Ÿï¼š${j.order_id}`);
    }

  }catch(e){
    console.error(e);
    alert(e.message || 'é€å‡ºå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡');
  }finally{
    $('#submitBtn').disabled = false;
  }
});

   async function copyToClipboard(text) {
  const t = String(text || '').trim();
  if (!t) return false;

  try {
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(t);
      return true;
    }
  } catch (e) {}

  // fallbackï¼ˆLINE å…§å»ºç€è¦½å™¨/éƒ¨åˆ†æ‰‹æ©Ÿæ›´ç©©ï¼‰
  try {
    const ta = document.createElement('textarea');
    ta.value = t;
    ta.setAttribute('readonly', '');
    ta.style.position = 'fixed';
    ta.style.opacity = '0';
    document.body.appendChild(ta);
    ta.select();
    ta.setSelectionRange(0, ta.value.length);
    const ok = document.execCommand('copy');
    document.body.removeChild(ta);
    return ok;
  } catch (e) {
    return false;
  }
}

(function bindCopyBankAccount(){
  const btn = document.getElementById('copyBankAccount');
  const el  = document.getElementById('bankAccount');
  if (!btn || !el) return;

  btn.addEventListener('click', async () => {
    const raw = el.textContent || el.value || '';
    const ok = await copyToClipboard(raw);

    const old = btn.textContent;
    btn.textContent = ok ? 'å·²è¤‡è£½ âœ“' : 'è¤‡è£½å¤±æ•—';
    setTimeout(() => (btn.textContent = old), 1200);
  });
})();

// ===== é é¢åˆå§‹åŒ– =====
(async () => {
  if (window.liff) {
    try {
      await initLiffAndMember();
    } catch (e) {
      console.log('LIFF init error (ignore on web)', e);
    }
  }

  restoreCheckoutState();
  applyStoreFromURL();

  if (initialMode) {
    document.querySelector(`.tab[data-pay="${initialMode}"]`)?.click();
  } else {
    document.querySelector('.tab[data-pay="COD"]')?.click();
  }

  updatePaidChannelBox();
  updatePaidShip();
  refreshDepType();
  updateZcShip();

  await loadCart();
  applyStoreFromURL();
})();
</script>
</body>
</html>
