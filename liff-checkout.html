<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>XUYUAN | çµå¸³</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />

  <!-- å¼•å…¥å“ç‰Œå­—é«” -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    /* --- æ ¸å¿ƒè®Šæ•¸ --- */
    :root {
      --bg-color: #050505;
      --card-bg: #121212;
      --input-bg: rgba(255, 255, 255, 0.03); /* æ›´é€šé€çš„è¼¸å…¥æ¡†èƒŒæ™¯ */
      --text-main: #fff;
      --text-muted: #888;
      --gold-primary: #D4AF37; 
      --gold-light: #F3E5AB;
      --gold-dim: rgba(212, 175, 55, 0.4);
      --border-color: rgba(255, 255, 255, 0.12);
      --danger: #ef4444;
      --font-serif: 'Playfair Display', serif; /* è‹±æ–‡è¥¯ç·šé«” */
      --font-sans: 'Lato', 'Noto Sans TC', sans-serif; /* ä¸­æ–‡ä¸»è¦å­—é«” */
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      padding-bottom: calc(100px + env(safe-area-inset-bottom));
      background-image: radial-gradient(circle at top right, rgba(20,20,20,1) 0%, rgba(5,5,5,1) 40%); /* å¾®ç´°èƒŒæ™¯å±¤æ¬¡ */
    }

    .page {
      max-width: 640px;
      margin: 0 auto;
      padding: 40px 24px;
    }

    /* --- Header --- */
    .header {
      text-align: center;
      margin-bottom: 50px;
    }
    .brand {
      font-family: var(--font-serif);
      font-size: 28px;
      letter-spacing: 0.15em;
      background: linear-gradient(to right, #D4AF37, #F3E5AB, #D4AF37);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
      font-weight: 600;
    }
    .page-title {
      font-size: 14px;
      letter-spacing: 0.2em;
      color: var(--text-muted);
      text-transform: uppercase;
      font-weight: 500;
    }

    /* --- å¡ç‰‡å€å¡Š --- */
    .section-card {
      margin-bottom: 50px;
    }
    .section-header {
      font-family: var(--font-sans);
      font-size: 15px;
      letter-spacing: 0.1em;
      color: var(--gold-light);
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 12px;
      font-weight: 500;
    }

    /* --- è¡¨å–®å…ƒç´ å„ªåŒ– --- */
    label {
      display: block;
      font-size: 13px;
      color: #999;
      margin-bottom: 8px;
      margin-top: 20px;
      letter-spacing: 0.02em;
    }
    label:first-child { margin-top: 0; }

    input, select, textarea {
      width: 100%;
      padding: 14px 16px;
      border-radius: 2px; /* æ›´éŠ³åˆ©çš„åœ“è§’ */
      border: 1px solid var(--border-color);
      background: var(--input-bg);
      color: #fff;
      font-size: 15px;
      font-family: var(--font-sans);
      transition: all 0.3s ease;
      -webkit-appearance: none;
    }

    /* âœ… ä¿®æ­£ï¼šè®“å®šé‡‘åŒæ„å‹¾é¸æ¡†æ¢å¾©å¯è¦–çš„ã€Œæ‰“å‹¾ã€å¤–è§€ */
    #dep_old_agree{
      -webkit-appearance: checkbox;
      appearance: checkbox;
      padding: 0;
      width: 18px;
      height: 18px;
      accent-color: var(--gold-primary);
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--gold-dim);
      background: rgba(255,255,255,0.06);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    input::placeholder, textarea::placeholder {
      color: #444;
    }

    /* --- æ–°å¢ï¼šç¸®å°åŒ¯æ¬¾æ¬„ä½çš„æç¤ºæ–‡å­— --- */
    #dep_old_last5::placeholder, 
    #dep_old_amount::placeholder,
    #dep_new_full_last5::placeholder{
      font-size: 12px;       /* å­—è®Šå° */
      letter-spacing: 0.5px; /* å¾®èª¿å­—è· */
      opacity: 0.7;          /* ç¨å¾®é€æ˜æ›´æœ‰è³ªæ„Ÿ */
    }

    /* å”¯è®€æ¬„ä½ç‰¹åˆ¥æ¨£å¼ */
    input[readonly], textarea[readonly] {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.05);
      color: var(--gold-light);
      font-weight: 500;
      letter-spacing: 0.05em;
    }
     
    /* é‡‘é¡å¤§å­—é¡¯ç¤º */
    #total, #total_after_credit {
        font-family: var(--font-serif);
        font-size: 18px;
        font-weight: 400;
        letter-spacing: 0.05em;
    }

    textarea { min-height: 80px; resize: vertical; line-height: 1.6; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    /* ä¸‰æ¬„ç”¨ï¼ˆä¾‹å¦‚è£•å¯Œ 7-11 é‚£æ’ï¼šæ”¶ä»¶äºº/é›»è©±/Emailï¼‰ */
.row3 { 
  display: grid; 
  grid-template-columns: repeat(3, 1fr); 
  gap: 16px; 
}

/* æ‰‹æ©Ÿæ™‚è‡ªå‹•è®Šå–®æ¬„ */
@media (max-width: 520px){
  .row3 { grid-template-columns: 1fr; }
}

    /* ========================================= */
    /* === æ ¸å¿ƒä¿®æ”¹ï¼šæ”¹ç‚º Grid ç¶²æ ¼ç‹€ä»˜æ¬¾é¸å–® === */
    /* ========================================= */
    .tabs {
  display: grid;
  /* æ‰‹æ©Ÿä¸Šé è¨­ 3 åˆ— (é¡ä¼¼ä¹å®®æ ¼/è¨ˆç®—æ©Ÿ) */
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 32px;

  /* ç§»é™¤èˆŠæœ‰çš„åº•éƒ¨ç·šæ¢èˆ‡æ²å‹• */
  border-bottom: none;
  padding-bottom: 0;
  overflow: visible;
}

/* ç•¶è¢å¹•éå¸¸å° (iPhone SE ç­‰) æ™‚ï¼Œæ”¹ç‚º 2 åˆ—ä»¥é˜²æ–‡å­—æ“ å£“ */
@media (max-width: 360px) {
  .tabs { grid-template-columns: repeat(2, 1fr); }
}

    .tab {
      /* æŒ‰éˆ•æœ¬é«” */
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      
      padding: 14px 8px;
      min-height: 70px; /* å¢åŠ é«˜åº¦ï¼Œå¥½æŒ‰ä¸”åƒ App åœ–ç¤º */
      
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-color);
      border-radius: 8px; /* åœ“è§’å¡ç‰‡æ„Ÿ */
      
      color: #888;
      font-size: 13px;
      font-family: var(--font-sans);
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    /* ç§»é™¤èˆŠçš„åº•éƒ¨å…‰æ¢å‹•ç•« */
    .tab::after { display: none; }

    /* æ»‘é¼ æ‡¸åœ */
    .tab:hover {
      border-color: rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.05);
    }

    /* é¸ä¸­ç‹€æ…‹ (Active) */
    .tab.active {
      color: #fff;
      border-color: var(--gold-primary);
      background: rgba(212, 175, 55, 0.12); /* æ·¡é‡‘è‰²èƒŒæ™¯ */
      box-shadow: 0 4px 15px rgba(0,0,0,0.5); /* æµ®èµ·é™°å½± */
      font-weight: 500;
    }
    /* æ‰‹æ©Ÿ/LINE å…§åµŒï¼šè¡¨å–®æ”¹ä¸€æ¬„æ›´å¥½å¡« */
@media (max-width: 520px){
  .page{ padding: 28px 16px; }
  .row{ grid-template-columns: 1fr; }   /* åŸæœ¬å…©æ¬„ -> ä¸€æ¬„ */
  input, select, textarea{ font-size: 16px; } /* iOS é¿å…è‡ªå‹•æ”¾å¤§ */
  .agree{ align-items: flex-start; }
}
    
    /* ç•¶è¢å¹•éå¸¸å° (iPhone SE ç­‰) æ™‚ï¼Œæ”¹ç‚º 2 åˆ—ä»¥é˜²æ–‡å­—æ“ å£“ */
    @media (max-width: 360px) {
      .tabs {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    /* ========================================= */


    /* --- é«˜ç´š Radio Pill (é¸é …æŒ‰éˆ•) --- */
    .radio-row { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
        gap: 12px; 
        margin-bottom: 24px; 
    }
     
    .radio-pill {
      padding: 16px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: linear-gradient(145deg, rgba(30,30,30,0.5), rgba(10,10,10,0.5));
      font-size: 14px;
      color: #888;
      cursor: pointer;
      display: flex; 
      align-items: center; 
      justify-content: center; /* æ–‡å­—ç½®ä¸­ */
      gap: 8px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
     
    .radio-pill:hover {
        border-color: rgba(255,255,255,0.2);
    }

    .radio-pill:has(input:checked) {
      border-color: var(--gold-primary);
      color: #fff;
      background: rgba(212, 175, 55, 0.08); /* éå¸¸æ·¡çš„é‡‘è‰²èƒŒæ™¯ */
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
     
    /* éš±è—åŸç”Ÿ radioï¼Œæ”¹ç”¨æ¨£å¼ */
    .radio-pill input { 
        position: absolute; 
        opacity: 0; 
        width: 0; height: 0; 
    }
     
    /* é¸ä¸­æ™‚çš„å°è£é£¾é» (å¯é¸) */
    .radio-pill:has(input:checked)::before {
        content: '';
        position: absolute;
        top: 6px; right: 6px;
        width: 4px; height: 4px;
        background: var(--gold-primary);
        border-radius: 50%;
        box-shadow: 0 0 6px var(--gold-primary);
    }

    /* --- é»‘é‡‘é¢¨æ ¼åŒ¯æ¬¾å¡ç‰‡ (å–ä»£åŸæœ¬çš„ pill) --- */
    .bank-card {
        background: linear-gradient(135deg, #1a1a1a 0%, #050505 100%);
        border: 1px solid rgba(212, 175, 55, 0.3);
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 24px;
        position: relative;
        overflow: hidden;
    }
    /* å¡ç‰‡èƒŒæ™¯è£é£¾ */
    .bank-card::before {
        content: 'XUYUAN';
        position: absolute;
        bottom: -10px; right: -10px;
        font-family: var(--font-serif);
        font-size: 60px;
        color: rgba(255,255,255,0.03);
        font-weight: 700;
        pointer-events: none;
    }
     
    .bank-info-row {
        display: flex; justify-content: space-between; align-items: flex-end;
    }
    .bank-label {
        font-size: 11px; color: #666; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 4px;
    }
    .bank-val {
        font-family: var(--font-sans); 
        font-size: 18px; 
        color: var(--gold-primary);
        letter-spacing: 0.05em;
        font-weight: 500;
    }
    .account-number {
        font-family: 'Lato', sans-serif; /* æ•¸å­—ç”¨ç„¡è¥¯ç·šé«”è¼ƒæ˜“è®€ */
        font-size: 22px;
        color: #fff;
        letter-spacing: 0.1em;
        margin-top: 12px;
        font-variant-numeric: tabular-nums;
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
     
    .btn-copy-gold {
        margin-top: 16px;
        width: 100%;
        background: rgba(212, 175, 55, 0.1);
        border: 1px solid rgba(212, 175, 55, 0.4);
        color: var(--gold-light);
        padding: 10px;
        font-size: 13px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }
    .btn-copy-gold:active {
        background: var(--gold-primary);
        color: #000;
    }

    /* --- è¼”åŠ©èˆ‡æç¤º --- */
    .credit-hint {
      display: flex; justify-content: space-between;
      font-size: 11px; color: var(--text-muted); margin-top: 8px;
    }
    .credit-val { color: var(--gold-primary); }
    .muted { font-size: 12px; color: #666; margin-top: 6px; font-style: italic; }

    .warning-text {
      font-size: 12px;
      color: #aaa;
      margin-top: 6px;
      display: flex; align-items: center; gap: 8px;
      background: rgba(255,255,255,0.02);
      padding: 8px 12px;
      border-radius: 4px;
    }
    .warning-text::before {
      content: '!';
      display: inline-flex; justify-content: center; align-items: center;
      min-width: 16px; height: 16px;
      background: var(--text-muted); color: #000;
      border-radius: 50%;
      font-size: 11px; font-weight: bold;
    }

    /* --- æ³¨æ„äº‹é …æ¡† (Premium Notice) --- */
    .premium-notice {
      margin-top: 24px;
      padding: 20px;
      border: 1px solid rgba(212, 175, 55, 0.2);
      background: linear-gradient(180deg, rgba(20,20,20,0.8), rgba(10,10,10,0.9));
      position: relative;
    }
    .premium-notice::before {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 1px;
      background: linear-gradient(90deg, transparent, var(--gold-primary), transparent);
    }
    .notice-title {
      color: var(--gold-primary);
      font-family: var(--font-sans);
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      text-align: center;
    }
    .notice-list {
      margin: 0; padding-left: 18px;
      font-size: 12px; color: #999; line-height: 1.8;
    }

    /* --- é¢äº¤å€å¡Š --- */
    .meetup-box {
      margin-top: 16px;
      padding: 20px;
      border: 1px dashed rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.02);
      border-radius: 4px;
    }
    .meetup-box .meetup-title {
      color: var(--gold-light);
      font-size: 13px;
      margin-bottom: 12px;
      font-weight: 500;
      letter-spacing: 0.05em;
    }

    /* --- åº•éƒ¨å›ºå®šæŒ‰éˆ• --- */
    .bottom-bar {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: rgba(5, 5, 5, 0.9);
      backdrop-filter: blur(12px);
      padding: 16px 24px calc(16px + env(safe-area-inset-bottom));
      border-top: 1px solid rgba(255,255,255,0.05);
      z-index: 100;
      display: flex; justify-content: center;
      box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
    }
    .btn-submit {
      width: 100%; max-width: 640px;
      padding: 16px;
      border: none; border-radius: 2px;
      background: linear-gradient(135deg, #D4AF37, #B8860B);
      color: #000;
      font-size: 15px; font-weight: 700; letter-spacing: 0.2em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.25);
    }
    .btn-submit:active { transform: scale(0.98); }
    .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
     
    .btn-secondary {
      background: transparent; 
      border: 1px solid #444; 
      color: #888;
      font-size: 13px; padding: 10px 16px; width: auto; 
      display: inline-block; margin-top: 12px; cursor: pointer;
      transition: all 0.2s;
    }
    .btn-secondary:hover { border-color: #fff; color: #fff; }

    /* ===== YUFU å°æ¨£å¼ï¼ˆæœ€å°è£œé½Šï¼‰ ===== */
    .note{
      font-size:12px;
      color:#aaa;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 10px 12px;
      margin-bottom: 14px;
    }
    .box{
      margin-top: 14px;
      padding: 14px;
      border: 1px dashed rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.02);
      border-radius: 4px;
    }
    .agree{
      display:flex;
      gap:10px;
      align-items:flex-start;
      margin-top: 12px;
      color:#ddd;
      font-size: 13px;
      line-height: 1.5;
    }
    .agree input[type="checkbox"]{
      -webkit-appearance: checkbox;
      appearance: checkbox;
      width: 18px;
      height: 18px;
      accent-color: var(--gold-primary);
      margin-top: 2px;
    }
    .btn{
      width:100%;
      margin-top: 10px;
      background: rgba(212, 175, 55, 0.10);
      border: 1px solid rgba(212, 175, 55, 0.35);
      color: var(--gold-light);
      padding: 10px;
      font-size: 13px;
      border-radius: 4px;
      cursor:pointer;
      letter-spacing: .08em;
    }
    /* âœ… :has() ä¸æ”¯æ´æ™‚çš„å‚™æ´ï¼šç”¨ JS åŠ  class */
    .radio-pill.is-checked {
      border-color: var(--gold-primary);
      color: #fff;
      background: rgba(212, 175, 55, 0.08);
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    .radio-pill.is-checked::before{
      content: '';
      position: absolute;
      top: 6px; right: 6px;
      width: 4px; height: 4px;
      background: var(--gold-primary);
      border-radius: 50%;
      box-shadow: 0 0 6px var(--gold-primary);
    }
    .btn:active{ background: var(--gold-primary); color:#000; }
    /* éš±è—å…ƒç´  */
    [hidden] { display: none !important; }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

<div class="page">
  <div class="header">
    <div class="brand">XUYUAN</div>
    <div class="page-title">çµå¸³</div>
  </div>

  <!-- 1. è¨‚å–®é‡‘é¡ -->
  <div class="section-card">
    <div class="section-header">è¨‚å–®å…§å®¹</div>

    <label>å•†å“å°è¨ˆ</label>
    <input id="subtotal" readonly />

    <label>å•†å“æ˜ç´°</label>
    <textarea id="itemsText" readonly></textarea>

    <label>æ‡‰ä»˜é‡‘é¡ (æœªæ‰£é™¤è³¼ç‰©é‡‘)</label>
    <input id="total" readonly />

    <label>ä½¿ç”¨è³¼ç‰©é‡‘æŠ˜æŠµ</label>
    <input id="credit_input" type="number" min="0" step="1" placeholder="è¼¸å…¥æŠ˜æŠµé‡‘é¡" />
    <div class="credit-hint">
      <span>ä¸å¯å…Œç¾</span>
      <span id="credit_available">å¯ç”¨é¤˜é¡ï¼šNT$ 0</span>
    </div>
    <div class="muted" id="credit_msg"></div>

    <label style="color:var(--gold-primary); margin-top:24px;">å¯¦éš›ä»˜æ¬¾é‡‘é¡</label>
    <input id="total_after_credit" readonly style="border-color:var(--gold-primary); color:var(--gold-primary); background:rgba(212,175,55,0.05);" />

    <label>è¨‚å–®å‚™è¨» (é¸å¡«)</label>
    <textarea id="note" placeholder="ä¾‹å¦‚ï¼šé€ç¦®ç”¨éœ€é™„ç´™è¢‹..."></textarea>
  </div>

  <!-- 2. ä»˜æ¬¾èˆ‡é…é€ -->
  <div class="section-card">
    <div class="section-header">ä»˜æ¬¾èˆ‡é‹é€æ–¹å¼</div>

    <!-- å„ªåŒ–å¾Œçš„ Grid Tabs (ç¶²æ ¼é¸å–®) -->
    <div class="tabs" id="payTabs">
      <button type="button" class="tab active" data-pay="COD">è²¨åˆ° / é¢äº¤</button>
      <button type="button" class="tab" data-pay="PAID">ç·šä¸Šä»˜æ¬¾</button>
<button type="button" class="tab" data-pay="DEPOSIT">ATM åŒ¯æ¬¾</button>
<button type="button" class="tab" data-pay="ZEROCARD">ç„¡å¡åˆ†æœŸ</button>
<button type="button" class="tab" data-pay="YUFU">è£•å¯Œåˆ†æœŸ</button>
    </div>

    <!-- COD -->
    <div id="paneCOD">
      <div class="radio-row">
        <label class="radio-pill">
          <input type="radio" name="codType" value="711" checked />
          7-11 è²¨åˆ°ä»˜æ¬¾
        </label>
        <label class="radio-pill">
          <input type="radio" name="codType" value="meetup" />
          é¢äº¤ / è‡ªå–
        </label>
      </div>

      <div class="row">
        <div><label>å§“å *</label><input id="cod_name" required /></div>
        <div><label>é›»è©± *</label><input id="cod_phone" required /></div>
      </div>
      <label>Email *</label>
      <input id="cod_email" required type="email" />

      <div id="cod711Extra">
        <div class="row">
          <div><label>7-11 é–€å¸‚ä»£è™Ÿ</label><input id="cod_store_id" required /></div>
          <div><label>é–€å¸‚åç¨±</label><input id="cod_store_name" required /></div>
        </div>
        <label>é–€å¸‚åœ°å€</label>
        <input id="cod_store_addr" required />
        <button class="btn-secondary" id="mapCOD">é–‹å•Ÿ 7-11 åœ°åœ–</button>
      </div>
      <!-- âœ… åªçµ¦ 7-11 è²¨åˆ°ä»˜æ¬¾çœ‹çš„åŒæ„å‹¾ -->
<label class="agree" id="cod711AgreeWrap" style="display:none;">
  <input id="cod711_agree" type="checkbox" />
  æˆ‘å·²é–±è®€ä¸¦åŒæ„ï¼š7-11 è²¨åˆ°ä»˜æ¬¾è«‹å‹™å¿…å–è²¨ï¼Œè‹¥æƒ¡æ„æ£„æ¨™éœ€æ”¯ä»˜é‹è²»åŠç›¸é—œè²»ç”¨ã€‚
</label>
      <div id="codMeetHint" class="hint" hidden style="margin-top:10px; color:#666;">* ç¾å ´æ ¸å°è³‡æ–™ï¼Œè«‹æ”œå¸¶æ‰‹æ©Ÿã€‚</div>

      <div class="meetup-box" id="cod_meetup_box" hidden>
        <div class="meetup-title">é ç´„é¢äº¤è³‡è¨Š</div>
        <label>åœ°é»</label>
        <input id="cod_meetup_place" readonly value="å°å—å¸‚ä½³é‡Œå€ç¾©æ°‘è¡—339è™Ÿ" />

        <div class="row">
          <div>
            <label>æ—¥æœŸ</label>
            <input id="cod_meetup_date" type="date" />
          </div>
          <div>
            <label>æ™‚é–“</label>
            <select id="cod_meetup_time">
              <option value="">é¸æ“‡æ™‚é–“</option>
              <option value="10:00">10:00</option>
              <option value="11:00">11:00</option>
              <option value="12:00">12:00</option>
              <option value="13:00">13:00</option>
              <option value="14:00">14:00</option>
              <option value="15:00">15:00</option>
              <option value="16:00">16:00</option>
            </select>
          </div>
        </div>
        <div class="muted">é€±ä¸€ï½é€±äº” 10:00ï½16:00ï¼ˆå‡æ—¥ä¸é–‹æ”¾ï¼‰</div>
      </div>
    </div>

    <!-- PAID -->
    <div id="panePAID" hidden>
      <label>ä»˜æ¬¾æ–¹å¼</label>
      <select id="paid_channel">
        <option value="card_once">ä¿¡ç”¨å¡ (ä¸€æ¬¡ä»˜æ¸…)</option>
        <option value="card_inst">ä¿¡ç”¨å¡ (åˆ†æœŸ 0 åˆ©ç‡)</option>
        <option value="linepay">LINE Pay</option>
        <option value="af">AF å…ˆäº«å¾Œä»˜</option>
      </select>

      <div id="cardInstBox">
        <label>åˆ†æœŸæœŸæ•¸</label>
        <select id="inst_months">
          <option value="3">3 æœŸ (0 åˆ©ç‡)</option>
          <option value="6">6 æœŸ (0 åˆ©ç‡)</option>
          <option value="9">9 æœŸ (0 åˆ©ç‡)</option>
        </select>
      </div>

      <label>å–è²¨æ–¹å¼</label>
      <select id="paid_ship_method">
        <option value="711">7-11 è¶…å•†å–è²¨</option>
        <option value="post">ä¸­è¯éƒµæ”¿</option>
        <option value="meetup">é¢äº¤ / è‡ªå–</option>
      </select>

      <div id="paidShip711">
        <div class="warning-text">0å…ƒåŒ…è£¹éœ€å¡«å¯«çœŸå¯¦å§“åï¼Œå–ä»¶éœ€å‡ºç¤ºè­‰ä»¶ã€‚</div>
        <div class="row">
          <div><label>å§“å</label><input id="ship_name_paid" required /></div>
          <div><label>é›»è©±</label><input id="ship_phone_paid" required /></div>
        </div>
        <label>Email</label><input id="paid_email" type="email" />
        <div class="row">
          <div><label>é–€å¸‚ä»£è™Ÿ</label><input id="ship_store_id_paid" required /></div>
          <div><label>é–€å¸‚åç¨±</label><input id="ship_store_name_paid" required /></div>
        </div>
        <label>é–€å¸‚åœ°å€</label><input id="ship_store_addr_paid" required />
        <button class="btn-secondary" id="mapPAID">é–‹å•Ÿ 7-11 åœ°åœ–</button>
      </div>

      <div id="paidShipPost" hidden>
        <div class="warning-text">éƒµæ”¿æŠ•éä¸æœƒé›»è©±é€£çµ¡ï¼Œè«‹ç¢ºèªæœ‰äººæ”¶ä»¶ã€‚</div>
        <div class="row">
          <div><label>å§“å</label><input id="paid_post_name" required /></div>
          <div><label>é›»è©±</label><input id="paid_post_phone" required /></div>
        </div>
        <label>Email</label><input id="paid_post_email" type="email" />
        <label>éƒµéå€è™Ÿ</label><input id="paid_post_zip" />
        <label>æ”¶ä»¶åœ°å€</label><input id="paid_post_addr" required />
      </div>

      <div id="paidShipMeetup" hidden>
        <div class="row">
          <div><label>å§“å</label><input id="paid_meet_name" required /></div>
          <div><label>é›»è©±</label><input id="paid_meet_phone" required /></div>
        </div>
        <label>Email</label><input id="paid_meet_email" type="email" />

        <div class="meetup-box" id="paid_meetup_box">
            <div class="meetup-title">é ç´„é¢äº¤è³‡è¨Š</div>
            <label>åœ°é»</label>
            <input id="paid_meetup_place" readonly value="å°å—å¸‚ä½³é‡Œå€ç¾©æ°‘è¡—339è™Ÿ" />
     
            <div class="row">
              <div>
                <label>æ—¥æœŸ</label>
                <input id="paid_meetup_date" type="date" />
              </div>
              <div>
                <label>æ™‚é–“</label>
                <select id="paid_meetup_time">
                  <option value="">é¸æ“‡æ™‚é–“</option>
                  <option value="10:00">10:00</option>
                  <option value="11:00">11:00</option>
                  <option value="12:00">12:00</option>
                  <option value="13:00">13:00</option>
                  <option value="14:00">14:00</option>
                  <option value="15:00">15:00</option>
                  <option value="16:00">16:00</option>
                </select>
              </div>
            </div>
            <div class="muted">é€±ä¸€ï½é€±äº” 10:00ï½16:00ï¼ˆå‡æ—¥ä¸é–‹æ”¾ï¼‰</div>
        </div>
      </div>
    </div>

    <!-- DEPOSIT -->
    <div id="paneDEPOSIT" hidden>
      
      <!-- å…¨æ–°è¨­è¨ˆçš„åŒ¯æ¬¾å¡ç‰‡ (ä¸­æ–‡ç‰ˆ) -->
      <div class="bank-card">
        <div class="bank-info-row">
            <div>
                <div class="bank-label">éŠ€è¡Œä»£ç¢¼</div>
                <div class="bank-val">700 éƒµå±€</div>
            </div>
            <div>
                <div class="bank-label" style="text-align:right;">å¹£åˆ¥</div>
                <div class="bank-val" style="text-align:right;">TWD</div>
            </div>
        </div>
        <div class="account-number" id="bankAccount">01912890973712</div>
        <button type="button" class="btn-copy-gold" id="copyBankAccount">ä¸€éµè¤‡è£½å¸³è™Ÿ</button>
      </div>

      <div class="radio-row" style="margin-top:16px;">
        <label class="radio-pill">
          <input type="radio" name="depType" value="new_full" checked />
          åŒ¯æ¬¾å…¨é¡
        </label>
        <label class="radio-pill">
          <input type="radio" name="depType" value="old" />
          åŒ¯æ¬¾å®šé‡‘ (ä¿ç•™)
        </label>
      </div>

      <!-- åŒ¯æ¬¾å®šé‡‘ (ä¿ç•™) -->
      <div id="depOldPane" hidden>
        <div class="hint" style="margin: 6px 0 14px; color:#aaa; font-style:italic;">
          * å®šé‡‘å…¥å¸³å¾Œå¯ç‚ºæ‚¨ä¿ç•™å•†å“ 1 å€‹æœˆ
        </div>
        <label>å–è²¨æ–¹å¼</label>
        <select id="dep_old_method">
          <option value="711">7-11 è¶…å•†å–è²¨</option>
          <option value="post">ä¸­è¯éƒµæ”¿</option>
        </select>
        <div class="row">
          <div><label>å§“å</label><input id="dep_old_name" required /></div>
          <div><label>é›»è©±</label><input id="dep_old_phone" required /></div>
        </div>
        <label>Email</label><input id="dep_old_email" type="email" />

        <div id="dep_old_box_711">
          <div class="row">
            <div><label>é–€å¸‚ä»£è™Ÿ</label><input id="dep_old_store_id" required /></div>
            <div><label>é–€å¸‚åç¨±</label><input id="dep_old_store_name" required /></div>
          </div>
          <label>é–€å¸‚åœ°å€</label><input id="dep_old_store_addr" required />
          <button class="btn-secondary" id="mapDepOld">é–‹å•Ÿ 7-11 åœ°åœ–</button>
        </div>

        <div id="dep_old_box_post" hidden>
          <label>éƒµéå€è™Ÿ</label><input id="dep_old_post_zip" />
          <label>æ”¶ä»¶åœ°å€</label><input id="dep_old_post_addr" required />
        </div>

        <label style="color:var(--gold-primary);">å¡«å¯«åŒ¯æ¬¾è³‡æ–™</label>
        <div class="row">
    <div>
        <label>æ‚¨çš„å¸³è™Ÿå¾Œäº”ç¢¼</label>
        <input id="dep_old_last5" required placeholder="è«‹å…ˆå®ŒæˆåŒ¯æ¬¾å†å¡«å¯«" />
    </div>
    <div>
        <label>å®šé‡‘é‡‘é¡</label>
        <input id="dep_old_amount" placeholder="å¡«å¯«æ‚¨å¯¦éš›åŒ¯å‡ºçš„é‡‘é¡" />
    </div>
</div>
<label>ä¿ç•™åˆ°æœŸæ—¥</label><input id="dep_old_hold_until" type="date" />

        <div class="premium-notice">
          <!-- âœ… å®šé‡‘åŒæ„å‹¾é¸ï¼ˆè­‰æ“šé»ï¼‰ -->
<label style="margin-top:16px;">
  <span style="display:flex; gap:10px; align-items:flex-start; line-height:1.5;">
    <input id="dep_old_agree" type="checkbox" style="width:18px; height:18px; margin-top:2px;" />
    <span style="color:#ddd;">
      æˆ‘å·²é–±è®€ä¸¦åŒæ„ï¼š<span style="color:var(--gold-primary);">é€¾æœŸè¦–åŒæ£„æ¨™ï¼Œå®šé‡‘ä¸é€€é‚„ã€‚</span>
    </span>
  </span>
</label>
<div class="muted" style="margin-top:6px;">
  * ç‚ºä¿éšœé›™æ–¹æ¬Šç›Šï¼Œé€å‡ºè¨‚é‡‘è¨‚å–®å‰éœ€å‹¾é¸åŒæ„ã€‚
</div>
          <div class="notice-title">æ³¨æ„äº‹é …</div>
<ul class="notice-list">
  <li>
    å°¾æ¬¾æ”¯ä»˜æ–¹å¼åƒ…æä¾›ï¼šå…¨è³¼ç‰©é‡‘ã€7-11 è²¨åˆ°ä»˜æ¬¾ã€åŒ¯æ¬¾ã€ç·šä¸Šæ”¯ä»˜ï¼ˆä¿¡ç”¨å¡ä¸€æ¬¡ä»˜ã€ä¿¡ç”¨å¡ 3/6 æœŸé›¶åˆ©ç‡ã€LINE PAYã€AFTEE å…ˆäº«å¾Œä»˜ï¼‰ã€‚
  </li>
  <li>å®šé‡‘å…¥å¸³å¾Œå¯ç‚ºæ‚¨ä¿ç•™å•†å“æœ€é•· 1 å€‹æœˆã€‚</li>
  <li>ä¸€èˆ¬åŒ…æ¬¾å®šé‡‘ NT$ 1,000ï¼›æŒ‡å®šå“ç‰Œå®šé‡‘ NT$ 2,000ã€‚</li>
  <li>è«‹å‹™å¿…ç¢ºèªæ”¶ä»¶è³‡æ–™æ­£ç¢ºã€‚</li>
  <li>é€¾æœŸè¦–åŒæ£„æ¨™ï¼Œå®šé‡‘ä¸é€€é‚„ã€‚</li>
          </ul>
        </div>
      </div>

      <!-- åŒ¯æ¬¾å…¨é¡ -->
      <div id="depNewFullPane">
        <div class="row">
          <div><label>å§“å</label><input id="dep_new_full_name" required /></div>
          <div><label>é›»è©±</label><input id="dep_new_full_phone" required /></div>
        </div>
        <label>Email</label><input id="dep_new_full_email" type="email" />
        <label>å–è²¨æ–¹å¼</label>
        <select id="dep_new_full_method">
          <option value="711">7-11 è¶…å•†å–è²¨</option>
          <option value="post">ä¸­è¯éƒµæ”¿</option>
          <option value="meetup">é¢äº¤</option>
        </select>

        <div id="depNewFull711">
          <div class="warning-text">0å…ƒåŒ…è£¹éœ€å¡«å¯«çœŸå¯¦å§“åã€‚</div>
          <div class="row">
            <div><label>é–€å¸‚ä»£è™Ÿ</label><input id="dep_new_full_store_id" required /></div>
            <div><label>é–€å¸‚åç¨±</label><input id="dep_new_full_store_name" required /></div>
          </div>
          <label>é–€å¸‚åœ°å€</label><input id="dep_new_full_store_addr" required />
          <button class="btn-secondary" id="mapDepNewFull">é–‹å•Ÿ 7-11 åœ°åœ–</button>
        </div>

        <div id="depNewFullPost" hidden>
          <div class="warning-text">éƒµæ”¿æŠ•éä¸æœƒäº‹å…ˆé›»è©±é€£çµ¡ã€‚</div>
          <label>éƒµéå€è™Ÿ</label><input id="dep_new_full_post_zip" />
          <label>æ”¶ä»¶åœ°å€</label><input id="dep_new_full_post_addr" required />
        </div>

        <div id="depNewFullMeetup" hidden>
          <div class="row">
            <div><label>å§“å</label><input id="dep_new_full_meet_name" required /></div>
            <div><label>é›»è©±</label><input id="dep_new_full_meet_phone" required /></div>
          </div>
          <label>Email</label><input id="dep_new_full_meet_email" type="email" />

          <div class="meetup-box" id="depnew_meetup_box">
            <div class="meetup-title">é ç´„é¢äº¤è³‡è¨Š</div>
            <label>åœ°é»</label>
            <input id="depnew_meetup_place" readonly value="å°å—å¸‚ä½³é‡Œå€ç¾©æ°‘è¡—339è™Ÿ" />
     
            <div class="row">
              <div>
                <label>æ—¥æœŸ</label>
                <input id="depnew_meetup_date" type="date" />
              </div>
              <div>
                <label>æ™‚é–“</label>
                <select id="depnew_meetup_time">
                  <option value="">é¸æ“‡æ™‚é–“</option>
                  <option value="10:00">10:00</option>
                  <option value="11:00">11:00</option>
                  <option value="12:00">12:00</option>
                  <option value="13:00">13:00</option>
                  <option value="14:00">14:00</option>
                  <option value="15:00">15:00</option>
                  <option value="16:00">16:00</option>
                </select>
              </div>
            </div>
            <div class="muted">é€±ä¸€ï½é€±äº” 10:00ï½16:00ï¼ˆå‡æ—¥ä¸é–‹æ”¾ï¼‰</div>
          </div>
        </div>

        <label style="color:var(--gold-primary); margin-top:20px;">å¡«å¯«åŒ¯æ¬¾è³‡æ–™</label>
        <label>æ‚¨çš„å¸³è™Ÿå¾Œäº”ç¢¼</label>

<input id="dep_new_full_last5" required placeholder="è«‹å…ˆå®ŒæˆåŒ¯æ¬¾ï¼Œå†å¡«å¯«æœ«5ç¢¼" />

<input id="dep_new_full_amount" type="hidden" />
      </div>
    </div>

    <!-- ZEROCARD -->
    <div id="paneZEROCARD" hidden>
      <div class="row">
        <div>
          <label>æœŸæ•¸</label>
          <select id="zc_months">
            <option value="3">3 æœŸ (0åˆ©ç‡)</option>
            <option value="6">6 æœŸ</option>
            <option value="9">9 æœŸ</option>
            <option value="12">12 æœŸ</option>
            <option value="18">18 æœŸ</option>
            <option value="24">24 æœŸ</option>
          </select>
        </div>
        <div>
          <label>æ¯æœŸè©¦ç®—</label>
          <input id="zc_each" readonly />
        </div>
      </div>

      <div class="warning-text">
        å¯¦éš›æ ¸å‡†èˆ‡æœŸæ•¸ï¼Œä»¥ä¸­ç§Ÿç„¡å¡é›¶è§’å¯©æ ¸çµæœç‚ºæº–ã€‚
      </div>

      <label>å–è²¨æ–¹å¼</label>
      <select id="zc_ship_method">
        <option value="711">7-11 è¶…å•†å–è²¨</option>
        <option value="post">ä¸­è¯éƒµæ”¿</option>
        <option value="meetup">é¢äº¤</option>
      </select>

      <div id="zcShip711">
        <div class="warning-text">0å…ƒåŒ…è£¹éœ€å¡«å¯«çœŸå¯¦å§“åã€‚</div>
        <div class="row">
          <div><label>å§“å</label><input id="ship_name_zc" required /></div>
          <div><label>é›»è©±</label><input id="ship_phone_zc" required /></div>
        </div>
        <label>Email</label><input id="zc_email" type="email" />
        <div class="row">
          <div><label>é–€å¸‚ä»£è™Ÿ</label><input id="ship_store_id_zc" required /></div>
          <div><label>é–€å¸‚åç¨±</label><input id="ship_store_name_zc" required /></div>
        </div>
        <label>é–€å¸‚åœ°å€</label><input id="ship_store_addr_zc" required />
        <button class="btn-secondary" id="mapZC">é–‹å•Ÿ 7-11 åœ°åœ–</button>
      </div>

      <div id="zcShipPost" hidden>
        <div class="warning-text">éƒµæ”¿æŠ•éä¸æœƒäº‹å…ˆé›»è©±é€£çµ¡ã€‚</div>
        <div class="row">
          <div><label>å§“å</label><input id="zc_post_name" required /></div>
          <div><label>é›»è©±</label><input id="zc_post_phone" required /></div>
        </div>
        <label>Email</label><input id="zc_post_email" type="email" />
        <label>éƒµéå€è™Ÿ</label><input id="zc_post_zip" />
        <label>æ”¶ä»¶åœ°å€</label><input id="zc_post_addr" required />
      </div>

      <div id="zcShipMeetup" hidden>
        <div class="row">
          <div><label>å§“å</label><input id="zc_meet_name" required /></div>
          <div><label>é›»è©±</label><input id="zc_meet_phone" required /></div>
        </div>
        <label>Email</label><input id="zc_meet_email" type="email" />

        <div class="meetup-box" id="zc_meetup_box">
            <div class="meetup-title">é ç´„é¢äº¤è³‡è¨Š</div>
            <label>åœ°é»</label>
            <input id="zc_meetup_place" readonly value="å°å—å¸‚ä½³é‡Œå€ç¾©æ°‘è¡—339è™Ÿ" />
     
            <div class="row">
              <div>
                <label>æ—¥æœŸ</label>
                <input id="zc_meetup_date" type="date" />
              </div>
              <div>
                <label>æ™‚é–“</label>
                <select id="zc_meetup_time">
                  <option value="">é¸æ“‡æ™‚é–“</option>
                  <option value="10:00">10:00</option>
                  <option value="11:00">11:00</option>
                  <option value="12:00">12:00</option>
                  <option value="13:00">13:00</option>
                  <option value="14:00">14:00</option>
                  <option value="15:00">15:00</option>
                  <option value="16:00">16:00</option>
                </select>
              </div>
            </div>
            <div class="muted">é€±ä¸€ï½é€±äº” 10:00ï½16:00ï¼ˆå‡æ—¥ä¸é–‹æ”¾ï¼‰</div>
        </div>
      </div>
    </div>
  <div id="paneYUFU" hidden>

  <div class="row">
    <div class="field">
      <label>é¸æ“‡æœŸæ•¸</label>
      <select id="yufu_months">
        <option value="3">3 æœŸï¼ˆé›¶åˆ©ç‡ï¼‰</option>
        <option value="6">6 æœŸ</option>
        <option value="9">9 æœŸ</option>
        <option value="12">12 æœŸ</option>
        <option value="24">24 æœŸ</option>
        <option value="36">36 æœŸ</option>
      </select>
    </div>

    <div class="field">
      <label>è©¦ç®—æœˆä»˜ï¼ˆä¼°ç®—ï¼‰</label>
      <input id="yufu_monthly" type="text" readonly placeholder="æœƒè‡ªå‹•è©¦ç®—" />
    </div>
  </div>

  <!-- âœ… è·Ÿä¸­ç§Ÿä¸€æ¨£ï¼šç”¨ warning-textï¼Œæ”¾åœ¨ row ä¸‹é¢ -->
  <div class="warning-text">
    å¯¦éš›æ ¸å‡†èˆ‡æœŸæ•¸ï¼Œä»¥è£•å¯Œåˆ†æœŸå¯©æ ¸çµæœï¼ˆç°¡è¨Šï¼‰ç‚ºæº–ã€‚
  </div>
    <div id="yufu_rate_note" class="note" style="margin-top:10px;"></div>

  <!-- å¯„é€æ–¹å¼ -->
  <div class="field">
    <label>å¯„é€æ–¹å¼</label>
    <select id="yufu_ship_method">
      <option value="">è«‹é¸æ“‡</option>
      <option value="711">7-11 è¶…å•†å–è²¨</option>
      <option value="post">ä¸­è¯éƒµæ”¿</option>
      <option value="meetup">é¢äº¤</option>
    </select>
  </div>

  <!-- 7-11 -->
  <div id="yufuShip711" class="box" style="display:none;">
    <div class="warning-text">0å…ƒåŒ…è£¹éœ€å¡«å¯«çœŸå¯¦å§“åã€‚</div>
    <div class="row3">
      <div class="field">
        <label>æ”¶ä»¶äºº</label>
        <input id="ship_name_yufu" type="text" placeholder="æ”¶ä»¶äººå§“å" />
      </div>
      <div class="field">
        <label>é›»è©±</label>
        <input id="ship_phone_yufu" type="text" placeholder="é›»è©±" />
      </div>
      <div class="field">
        <label>Email</label>
        <input id="yufu_email" type="email" placeholder="Email" />
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>é–€å¸‚ä»£è™Ÿ</label>
        <input id="ship_store_id_yufu" type="text" readonly placeholder="è«‹é»é¸åœ°åœ–æŒ‘é–€å¸‚" />
      </div>
      <div class="field">
        <label>é–€å¸‚åç¨±</label>
        <input id="ship_store_name_yufu" type="text" readonly />
      </div>
    </div>

    <div class="field">
      <label>é–€å¸‚åœ°å€</label>
      <input id="ship_store_addr_yufu" type="text" readonly />
    </div>

    <button id="mapYUFU" type="button" class="btn">é¸æ“‡ 7-11 é–€å¸‚</button>
  </div>

  <!-- éƒµå¯„ -->
  <div id="yufuShipPost" class="box" style="display:none;">
    <div class="warning-text">éƒµæ”¿æŠ•éä¸æœƒäº‹å…ˆé›»è©±é€£çµ¡ã€‚</div>
    <div class="row3">
      <div class="field">
        <label>æ”¶ä»¶äºº</label>
        <input id="yufu_post_name" type="text" placeholder="æ”¶ä»¶äººå§“å" />
      </div>
      <div class="field">
        <label>é›»è©±</label>
        <input id="yufu_post_phone" type="text" placeholder="é›»è©±" />
      </div>
      <div class="field">
        <label>Email</label>
        <input id="yufu_post_email" type="email" placeholder="Email" />
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>éƒµéå€è™Ÿï¼ˆå¯ä¸å¡«ï¼‰</label>
        <input id="yufu_post_zip" type="text" placeholder="ä¾‹å¦‚ 722" />
      </div>
      <div class="field" style="flex:2;">
        <label>åœ°å€</label>
        <input id="yufu_post_addr" type="text" placeholder="ç¸£å¸‚å€/è¡—é“/è™Ÿ/æ¨“" />
      </div>
    </div>
  </div>

  <!-- é¢äº¤ -->
  <div id="yufuShipMeet" class="box" style="display:none;">
    <div class="row3">
      <div class="field">
        <label>è¯çµ¡äºº</label>
        <input id="yufu_meet_name" type="text" placeholder="å§“å" />
      </div>
      <div class="field">
        <label>é›»è©±</label>
        <input id="yufu_meet_phone" type="text" placeholder="é›»è©±" />
      </div>
      <div class="field">
        <label>Email</label>
        <input id="yufu_meet_email" type="email" placeholder="Email" />
      </div>
    </div>

    <div class="field">
  <label>é¢äº¤åœ°é»</label>
  <input id="yufu_meetup_place" readonly value="å°å—å¸‚ä½³é‡Œå€ç¾©æ°‘è¡—339è™Ÿ" />
</div>

<div class="row">
  <div class="field">
    <label>é¢äº¤æ—¥æœŸ</label>
    <input id="yufu_meetup_date" type="date" />
  </div>

  <div class="field">
    <label>é¢äº¤æ™‚é–“</label>
    <select id="yufu_meetup_time">
      <option value="">è«‹é¸æ“‡</option>
      <option value="10:00">10:00</option>
      <option value="11:00">11:00</option>
      <option value="12:00">12:00</option>
      <option value="13:00">13:00</option>
      <option value="14:00">14:00</option>
      <option value="15:00">15:00</option>
      <option value="16:00">16:00</option>
    </select>
  </div>
</div>

    <div class="muted">é€±ä¸€ï½é€±äº” 10:00ï½16:00ï¼ˆå‡æ—¥ä¸é–‹æ”¾ï¼‰</div>
  </div>

 <!-- ç”³è«‹è³‡æ–™ -->
<div class="box">
  <div class="note"><b>è£•å¯Œç”³è«‹è³‡æ–™ï¼ˆå¿…å¡«ï¼‰</b></div>

  <div class="row">
    <div class="field">
      <label>å§“å</label>
      <input id="yufu_apply_name" type="text" placeholder="ç”³è«‹äººå§“å" />
    </div>
    <div class="field">
      <label>èº«åˆ†è­‰è™Ÿ</label>
      <input id="yufu_apply_id" type="text" placeholder="èº«åˆ†è­‰è™Ÿ" />
    </div>
  </div>

  <!-- âœ… æœ¬äººé–€è™Ÿ + Emailï¼ˆåŒä¸€æ’ï¼Œæ‰‹æ©Ÿæœƒè‡ªå‹•è®Šå–®æ¬„ï¼‰ -->
  <div class="row">
    <div class="field">
      <label>é›»è©±</label>
      <input id="yufu_apply_phone" type="text" placeholder="æœ¬äººé–€è™Ÿ" />
    </div>
    <div class="field">
      <label>Email</label>
      <input id="yufu_apply_email" type="email" placeholder="Email" />
    </div>
  </div>

  <!-- âœ… é›»è©±æ˜¯å¦æœ¬äººåä¸‹ï¼ˆä¸è¦æ”¾åœ¨ row è£¡ï¼Œæ‰ä¸æœƒæ“ çˆ†ï¼‰ -->
  <div class="field" style="margin-top:12px;">
    <label>é›»è©±æ˜¯å¦ç‚ºç”³è«‹äººæœ¬äººåä¸‹ï¼Ÿ</label>

    <div class="radio-row" style="margin: 8px 0 10px;">
      <label class="radio-pill">
        <input type="radio" name="yufu_phone_owner" value="yes" checked />
        æ˜¯ï¼ˆæœ¬äººé–€è™Ÿï¼‰
      </label>
      <label class="radio-pill">
        <input type="radio" name="yufu_phone_owner" value="no" />
        å¦ï¼ˆéæœ¬äººé–€è™Ÿï¼‰
      </label>
    </div>

    <div class="warning-text" id="yufuPhoneOwnerHint" hidden>
      è‹¥é›»è©±éæœ¬äººåä¸‹ï¼Œç·šä¸Šç”³è«‹é€šéå¾Œéœ€ä»¥ç´™æœ¬æ›è™Ÿå¯„é€æ–‡ä»¶ï¼åˆç´„ï¼Œè«‹å¡«å¯«æ›è™Ÿåœ°å€ã€‚
    </div>
  </div>

  <!-- âœ… éæœ¬äººé–€è™Ÿæ‰éœ€è¦ -->
  <div class="box" id="yufuPaperAddrBox" hidden>
    <div class="note"><b>æ›è™Ÿå¯„é€åœ°å€ï¼ˆéæœ¬äººé–€è™Ÿæ‰éœ€å¡«ï¼‰</b></div>

    <div class="row">
      <div class="field">
        <label>æ”¶ä»¶äººå§“å</label>
        <input id="yufu_paper_name" type="text" placeholder="æ”¶ä»¶äººå§“å" />
      </div>
      <div class="field">
        <label>é›»è©±</label>
        <input id="yufu_paper_phone" type="text" placeholder="å¯å¡«è¯çµ¡é›»è©±" />
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>éƒµéå€è™Ÿï¼ˆå¯ä¸å¡«ï¼‰</label>
        <input id="yufu_paper_zip" type="text" placeholder="ä¾‹å¦‚ 722" />
      </div>
      <div class="field" style="flex:2;">
        <label>æ›è™Ÿåœ°å€</label>
        <input id="yufu_paper_addr" type="text" placeholder="ç¸£å¸‚å€/è¡—é“/è™Ÿ/æ¨“" />
      </div>
    </div>

    <div class="muted">* å¯„é€æ–‡ä»¶é ˆæœ¬äººç°½åï¼Œå°‡å¯„åˆ°æ­¤æ›è™Ÿåœ°å€ã€‚</div>
  </div>

  <label class="agree">
    <input id="yufu_agree_privacy" type="checkbox" />
    æˆ‘åŒæ„æä¾›ä»¥ä¸Šè³‡æ–™ä¾›è£•å¯Œåˆ†æœŸå¯©æ ¸ä½¿ç”¨
  </label>

  <label class="agree">
    <input id="yufu_agree_rate" type="checkbox" />
    æˆ‘å·²é–±è®€åˆ†æœŸåˆ©ç‡èªªæ˜ï¼Œå¯¦éš›ä»¥è£•å¯Œç°¡è¨Šç‚ºæº–
  </label>
</div><!-- /boxï¼šè£•å¯Œç”³è«‹è³‡æ–™ -->
</div><!-- /paneYUFU -->

</div><!-- /section-cardï¼šä»˜æ¬¾èˆ‡é‹é€æ–¹å¼ -->
</div><!-- /page -->

<div class="bottom-bar">
  <button class="btn-submit" id="submitBtn">ç¢ºèªé€å‡ºè¨‚å–®</button>
</div>

<script>
  (function () {
  const isFromLiff = location.search.includes('liff.state');

  if (isFromLiff) {
    // ğŸš¨ å¾ LIFF å›ä¾†ï¼šé–æ­»æ‰€æœ‰ redirect
    sessionStorage.setItem('__from_liff_state', '1');

    // âœ… åªåœ¨ç¬¬ä¸€æ¬¡åšã€Œæ¸…ä¹¾æ·¨ç¶²å€ã€ï¼Œä¹‹å¾Œä¸å†å‹•
    if (!sessionStorage.getItem('__liff_url_cleaned')) {
      sessionStorage.setItem('__liff_url_cleaned', '1');

      // æŠŠ liff.state å¾ç¶²å€ç§»é™¤ï¼ˆåªåšä¸€æ¬¡ï¼‰
      const url = new URL(location.href);
      url.searchParams.delete('liff.state');
      url.searchParams.delete('liffState');

      history.replaceState(null, '', url.toString());
    }
  }
})();
  
   // ===============================
// å®‰å…¨ç”¨ï¼šé—œé–‰æ‰€æœ‰ requiredï¼ˆåªåœ¨é€å–®å‰ä½¿ç”¨ï¼‰
// ===============================
function _disableAllRequiredSafely() {
  document
    .querySelectorAll('input[required], select[required], textarea[required]')
    .forEach(el => {
      el.dataset._wasRequired = '1';
      el.required = false;
      el.disabled = true;
    });
}

// ===============================
// å®‰å…¨ç”¨ï¼šåªå•Ÿç”¨æŒ‡å®šæ¬„ä½
// ===============================
function _enableFields(ids) {
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.disabled = false;
    el.required = true;
  });
}

const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>[...r.querySelectorAll(s)];
const money=n=>'NT$ '+Number(n||0).toLocaleString();
/* ===== è¨­å®š ===== */
const API=(window.API_BASE||'https://api.murain.tw').replace(/\/$/,'');
const RATE_TABLE={3:0,6:4.0,9:5.5,12:6.5,18:9.0,24:11.5};

/* ===== é¢äº¤ï¼ˆæ”¶ä»¶è³‡æ–™ï¼‰è¨­å®š ===== */
const MEETUP_PLACE = 'å°å—å¸‚ä½³é‡Œå€ç¾©æ°‘è¡—339è™Ÿ';
const MEETUP_TIME_RANGE_HINT = 'é€±ä¸€ï½é€±äº” 10:00ï½16:00';
const MEETUP_WINDOW_DAYS = 7; // âœ… åªå…è¨± 7 å€‹å¯é¢äº¤å¹³æ—¥ï¼ˆä¸å«å…­æ—¥ï¼‰

function isMeetupWeekday(dateStr) {
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(dateStr || "").trim());
  if (!m) return false;

  const y  = Number(m[1]);
  const mo = Number(m[2]) - 1; // 0-based
  const d0 = Number(m[3]);

  // âœ… ç”¨ new Date(y, m, d) é¿å…æ‰‹æ©Ÿ/LINE è§£æ YYYY-MM-DDT00:00:00 å¤±æ•—
  const d = new Date(y, mo, d0);
  if (isNaN(d.getTime())) return false;

  // é˜²å‘†ï¼šé¿å… 2025-02-31 é€™ç¨®è¢«è‡ªå‹•é€²ä½
  if (d.getFullYear() !== y || d.getMonth() !== mo || d.getDate() !== d0) return false;

  const day = d.getDay(); // 0 Sun .. 6 Sat
  return day >= 1 && day <= 5;
}

function _nextWeekday(d) {
  while (d.getDay() === 0 || d.getDay() === 6) d.setDate(d.getDate() + 1);
  return d;
}

// âœ… å¾€å¾ŒåŠ ã€Œå¹³æ—¥ã€(ä¸å«å…­æ—¥)ï¼›addDays=0 ä»£è¡¨ä¸å¾€å¾ŒåŠ 
function _addWeekdays(date, addDays) {
  const d = new Date(date);
  let n = Number(addDays || 0) || 0;
  while (n > 0) {
    d.setDate(d.getDate() + 1);
    const day = d.getDay();
    if (day !== 0 && day !== 6) n--; // åªæ‰£é€±ä¸€ï½é€±äº”
  }
  return d;
}

function getMeetupInfo(prefix) {
  const dateEl = document.getElementById(prefix + "_meetup_date");
  const timeEl = document.getElementById(prefix + "_meetup_time");

  const dateStr = (dateEl && dateEl.value) ? String(dateEl.value).trim() : "";
  const timeStr = (timeEl && timeEl.value) ? String(timeEl.value).trim() : "";

  if (!dateStr || !timeStr) {
    alert("è«‹é¸æ“‡é¢äº¤æ—¥æœŸèˆ‡æ™‚é–“ï¼ˆ" + MEETUP_TIME_RANGE_HINT + "ï¼‰");
    return null;
  }

  if (!isMeetupWeekday(dateStr)) {
    alert("é¢äº¤æ—¥æœŸåƒ…é–‹æ”¾é€±ä¸€ï½é€±äº”ï¼ˆä¸å«å…­æ—¥ï¼‰ï¼Œè«‹é‡æ–°é¸æ“‡ã€‚");
    return null;
  }

  // âœ… å†ä¿éšªï¼šå¿…é ˆåœ¨ date input çš„ min/max ç¯„åœå…§
  if (dateEl && ((dateEl.min && dateStr < dateEl.min) || (dateEl.max && dateStr > dateEl.max))) {
    alert(`é¢äº¤æ—¥æœŸåƒ…é™ ${MEETUP_WINDOW_DAYS} å¤©å…§ï¼ˆä¸å«å…­æ—¥ï¼‰ï¼Œè«‹é‡æ–°é¸æ“‡ã€‚`);
    return null;
  }

  return {
    meetup_place: MEETUP_PLACE,
    meetup_time: dateStr + " " + timeStr
  };
}

function setMeetupMinDates() {
  try {
    const base = new Date();
    base.setHours(0, 0, 0, 0);

    // âœ… minï¼šä»Šå¤©èµ·ç®—ï¼Œä½†è‹¥ä»Šå¤©æ˜¯å…­æ—¥ â†’ è·³åˆ°ä¸‹å€‹é€±ä¸€
    const minD = _nextWeekday(new Date(base));

    // âœ… maxï¼šå¾€å¾Œæ•¸ã€ŒMEETUP_WINDOW_DAYS å€‹å¹³æ—¥ã€(å« min ç•¶ç¬¬ 1 å¤©)
    const maxD = _addWeekdays(minD, MEETUP_WINDOW_DAYS - 1);

    const min = ymdLocal(minD);
    const max = ymdLocal(maxD);

    ["cod", "paid", "depnew", "zc", "yufu"].forEach(p => {
      const el = document.getElementById(p + "_meetup_date");
      if (!el) return;

      el.min = min;
      el.max = max;

      // è‹¥å·²é¸çš„å€¼ä¸åˆæ³•å°±æ¸…æ‰
      const v = (el.value || "").slice(0, 10);
      if (v && (v < min || v > max || !isMeetupWeekday(v))) el.value = "";

      // âœ… é˜²é‡è¤‡ç¶å®šï¼ˆé¿å…ä½ ä¸€ç›´è·³æç¤ºï¼‰
      if (el.dataset.meetupBound === "1") return;
      el.dataset.meetupBound = "1";

      // âœ… ä½¿ç”¨è€…æ”¹æ—¥æœŸæ™‚ï¼Œç«‹åˆ»æ“‹æ‰å…­æ—¥/è¶…å‡ºç¯„åœ
      el.addEventListener("change", () => {
        const vv = (el.value || "").slice(0, 10);
        if (!vv) return;

        if (vv < el.min || vv > el.max) {
          alert(`é¢äº¤æ—¥æœŸåƒ…é™ ${MEETUP_WINDOW_DAYS} å¤©å…§ï¼ˆä¸å«å…­æ—¥ï¼‰ï¼Œè«‹é‡æ–°é¸æ“‡ã€‚`);
          el.value = "";
          return;
        }
        if (!isMeetupWeekday(vv)) {
          alert("é¢äº¤æ—¥æœŸåƒ…é–‹æ”¾é€±ä¸€ï½é€±äº”ï¼ˆä¸å«å…­æ—¥ï¼‰ï¼Œè«‹é‡æ–°é¸æ“‡ã€‚");
          el.value = "";
          return;
        }
      });
    });
  } catch (e) {}
}


let CART_TOTAL_RAW = 0;   // çœŸå¯¦é‡‘é¡ï¼ˆæ•¸å­—ï¼‰
 let AVAILABLE_CREDIT = 0; // æœƒå“¡å¯ç”¨è³¼ç‰©é‡‘
let CREDIT_USED = 0;      // æœ¬æ¬¡å¯¦éš›æœ‰æŠ˜æŠµçš„è³¼ç‰©é‡‘
   let CREDIT_READY = false; // âœ… è³¼ç‰©é‡‘é¤˜é¡æ˜¯å¦å·²è¼‰å…¥å®Œæˆ
  let CART_LOADED = false;

// ===== LIFF è¨­å®š =====
const LIFF_ID = "2008430261-KLwoQjm4";
   
var lineUserIdFromPay = ""; // âœ… å…ˆå®£å‘Šï¼Œé¿å… initLiffAndMember å…ˆç”¨åˆ°æ™‚çˆ† TDZ
let LINE_PROFILE = null;
let MEMBER_INFO  = null;

// æ›´æ–°è³¼ç‰©é‡‘ UIï¼ˆé¿å…ã€Œé–ƒä¸€ä¸‹åˆè®Š 0ã€ï¼‰
function updateCreditUIFromMember(info){
  // å…¼å®¹ä¸åŒæ¬„ä½åï¼šcredit / balance / member.credit...
  const candidates = [
  info?.credit,
  info?.balance,
  info?.member?.credit,
  info?.member?.balance
];

  let credit = 0;
  for (const v of candidates) {
    const n = Number(v);
    if (Number.isFinite(n)) { credit = Math.max(0, Math.floor(n)); break; }
  }

  // âœ… åªé˜²ã€Œmember-infoã€é‚£ç¨®ç¼ºæ¬„ä½é€ æˆçš„ 0ï¼›credit-balance å›ä¾†çš„ 0 è¦èƒ½çœŸçš„ç”Ÿæ•ˆ
if (credit === 0 && AVAILABLE_CREDIT > 0 && info && info._from === 'member-info') {
  return;
}

  AVAILABLE_CREDIT = credit;

  const el = document.getElementById('credit_available');
  if (el) el.textContent = "å¯ç”¨é¤˜é¡ï¼šNT$ " + credit.toLocaleString();

  // è®“æŠ˜æŠµå¾Œé‡‘é¡åŒæ­¥åˆ·æ–°
  updateCreditAndTotal();
}


async function initLiffAndMember() {
  if (!window.liff) return;

  await liff.init({ liffId: LIFF_ID });

  if (!liff.isLoggedIn()) {
  try { saveCheckoutState(); } catch (e) {}
  liff.login();
  return;
}

  let profile = null;
  let uidForApi = (typeof lineUserIdFromPay === 'string' && lineUserIdFromPay) ? lineUserIdFromPay : '';

  try {
    if (liff.isLoggedIn()) {
      profile = await liff.getProfile();
      LINE_PROFILE = profile;

      uidForApi = profile.userId || uidForApi;
    }
  } catch (e) {
    console.log('getProfile failed, fallback to user_id/localStorage', e);
  }

  // æœ€å¾Œä¿éšªï¼šå†ç”¨ localStorage è£œä¸€æ¬¡
  if (!uidForApi) {
    try { uidForApi = localStorage.getItem('murain_line_user_id') || ''; } catch (e) {}
  }

  // çœŸçš„æ²’æœ‰ user id å°±åªèƒ½æ”¾æ£„ï¼ˆç•«é¢æœƒæ˜¯ 0ï¼‰
  if (!uidForApi) return;
  LINE_PROFILE = profile;

  // âœ… å­˜èµ·ä¾†ï¼šå›è³¼ç‰©è»Š/é‡è©¦æ™‚æ›´ç©©
  try { localStorage.setItem('murain_line_user_id', uidForApi); } catch (e) {}

  // 1) æœƒå“¡è³‡æ–™ï¼ˆåå­—/é›»è©±/åœ°å€ï¼‰ç”¨ member-infoï¼ˆç…§èˆŠï¼‰
  try {
    const r = await fetch(`${API}/line/member-info?user_id=${encodeURIComponent(uidForApi)}`);
    const j = await r.json();
    console.log("member-info å›ä¾†é•·é€™æ¨£:", j); // âœ… æ”¾é€™
    if (j && j.ok) {
  j._from = 'member-info';
  MEMBER_INFO = j;
  applyMemberInfoToForm(j);
}
  } catch (e) {
    console.log('member-info error', e);
  }

  // 2) âœ… è³¼ç‰©é‡‘é¤˜é¡ï¼šç”¨ credit-balanceï¼ˆå”¯ä¸€çœŸç›¸ï¼‰
try {
  const b = await jfetch(`${API}/member/credit-balance?line_user_id=${encodeURIComponent(uidForApi)}`);

  if (!b || !b.ok) {
    console.log("credit-balance not ok", b);
    return;
  }

  // é˜²å‘†ï¼šé¿å…å›å‚³ç¼ºæ¬„ä½æ™‚æŠŠ UI è¦†è“‹æˆ 0
  const hasAny =
    (b.balance !== undefined) ||
    (b.credit  !== undefined) ||
    (b.total   !== undefined);

  if (!hasAny) {
    console.log("credit-balance missing fields, skip update", b);
    return;
  }

  const balRaw = Number(b.balance ?? b.credit ?? b.total);
  const c = Math.max(0, Math.floor(Number.isFinite(balRaw) ? balRaw : 0));

  // åˆä½µå› MEMBER_INFO
  MEMBER_INFO = Object.assign({}, MEMBER_INFO || {}, { credit: c });

  // æ›´æ–° UI / å…¨åŸŸ AVAILABLE_CREDIT
  updateCreditUIFromMember({ credit: c, _from: "credit-balance" });
  CREDIT_READY = true;
updateCreditAndTotal(); // âœ… è®“ 500 åœ¨ã€Œé¤˜é¡å·²çŸ¥ã€å¾Œå†é‡æ–°è¨ˆç®—ä¸€æ¬¡

} catch (e) {
  console.log("credit-balance error", e);
}
}
// ========= æœƒå“¡è³‡æ–™ â†’ å„ä»˜æ¬¾/å‡ºè²¨æ¬„ä½é å¡« =========
function applyMemberInfoToForm(info) {
  if (!info) return;

  const src = info.member || info.data || info;   // âœ… å…¼å®¹å¸¸è¦‹åŒ…æ³•
  updateCreditUIFromMember(Object.assign({_from: info._from || 'member-info'}, src));

  const name       = src.name  || "";
  const phone      = src.phone || "";
  const email      = src.email || "";
  const storeId    = src.storeId   || "";
  const storeName = src.storeName || "";
  const storeAddr = src.storeAddr || "";
  const shipZip    = src.shipZip   || "";
  const shipAddr   = src.shipAddr || "";

  function fillIfEmpty(selector, val) {
    if (!val) return;
    const el = document.querySelector(selector);
    if (el && !el.value) {
      el.value = val;
    }
  }

  [
    '#cod_name',
    '#ship_name_paid',
    '#paid_post_name',
    '#paid_meet_name',
    '#dep_old_name',
    '#dep_new_full_name',
    '#dep_new_full_meet_name',
    '#ship_name_zc',
    '#ship_name_yufu',
'#yufu_post_name',
'#yufu_meet_name',
'#yufu_apply_name',
    '#yufu_paper_name',
    '#zc_post_name',
    '#zc_meet_name'
  ].forEach(sel => fillIfEmpty(sel, name));

  [
    '#cod_phone',
    '#ship_phone_paid',
    '#paid_post_phone',
    '#paid_meet_phone',
    '#dep_old_phone',
    '#dep_new_full_phone',
    '#dep_new_full_meet_phone',
    '#ship_phone_zc',
    '#ship_phone_yufu',
'#yufu_post_phone',
'#yufu_meet_phone',
'#yufu_apply_phone',
    '#yufu_paper_phone',
    '#zc_post_phone',
    '#zc_meet_phone'
  ].forEach(sel => fillIfEmpty(sel, phone));

  [
    '#cod_email',
    '#paid_email',
    '#paid_post_email',
    '#paid_meet_email',
    '#dep_old_email',
    '#dep_new_full_email',
    '#dep_new_full_meet_email',
    '#yufu_email',
'#yufu_post_email',
'#yufu_meet_email',
'#yufu_apply_email',
    '#zc_email',
    '#zc_post_email',
    '#zc_meet_email'
  ].forEach(sel => fillIfEmpty(sel, email));

  [
  '#cod_store_id',
  '#ship_store_id_paid',
  '#dep_old_store_id',
  '#dep_new_full_store_id',
  '#ship_store_id_zc',
  '#ship_store_id_yufu' // âœ… è£•å¯Œ
].forEach(sel => fillIfEmpty(sel, storeId));

  [
  '#cod_store_name',
  '#ship_store_name_paid',
  '#dep_old_store_name',
  '#dep_new_full_store_name',
  '#ship_store_name_zc',
  '#ship_store_name_yufu' // âœ… è£•å¯Œ
].forEach(sel => fillIfEmpty(sel, storeName));

  [
  '#cod_store_addr',
  '#ship_store_addr_paid',
  '#dep_old_store_addr',
  '#dep_new_full_store_addr',
  '#ship_store_addr_zc',
  '#ship_store_addr_yufu' // âœ… è£•å¯Œ
].forEach(sel => fillIfEmpty(sel, storeAddr));

  [
    '#paid_post_zip',
  '#dep_old_post_zip',
  '#dep_new_full_post_zip',
  '#zc_post_zip',
  '#yufu_post_zip',
  '#yufu_paper_zip'
].forEach(sel => fillIfEmpty(sel, shipZip));

  [
    '#paid_post_addr',
  '#dep_old_post_addr',
  '#dep_new_full_post_addr',
  '#zc_post_addr',
  '#yufu_post_addr',
  '#yufu_paper_addr'
].forEach(sel => fillIfEmpty(sel, shipAddr));
}

/* ===== å·¥å…· ===== */
   async function jfetch(url, opt) {
  const r = await fetch(url, Object.assign({
    headers: { 'content-type': 'application/json' }
  }, opt || {}));
  const txt = await r.text();
  try { return JSON.parse(txt); } catch { return { ok:false, raw:txt }; }
}

// âœ… å…¼å®¹ LIFFï¼šæŠŠ liff.state å…§çš„ ?a=b åƒæ•¸ã€Œåˆä½µã€å› qs
function getQS() {
  const outer = new URLSearchParams(location.search || "");

  // LIFF æœƒæŠŠä½ åŸæœ¬çš„ ?cart_token=... åŒ…é€² liff.state
  const st = outer.get("liff.state") || outer.get("liffState") || "";
  if (st) {
    try {
      const decoded = decodeURIComponent(st);
      const inner = new URLSearchParams(decoded.startsWith("?") ? decoded.slice(1) : decoded);

      // inner çš„ key è‹¥ outer æ²’æœ‰ï¼Œå°±è£œé€² outerï¼ˆé¿å…è¦†è“‹ä½ æœ¬ä¾†å°±æœ‰çš„åƒæ•¸ï¼‰
      for (const [k, v] of inner.entries()) {
        if (!outer.has(k)) outer.set(k, v);
      }
    } catch (e) {
      console.warn("parse liff.state failed", e);
    }
  }

  return outer;
}

  // ===== Retry prefill (pm + ship_b64) â€” only prefill, no flow change =====
function b64urlDecodeToString(b64url) {
  try {
    const b64 = String(b64url || "")
      .replace(/-/g, "+")
      .replace(/_/g, "/")
      .padEnd(Math.ceil(String(b64url || "").length / 4) * 4, "=");
    const jsonStr = decodeURIComponent(escape(atob(b64)));
    return jsonStr;
  } catch (e) {
    console.log("b64url decode error", e);
    return "";
  }
}

function applyRetryPrefillFromQS(qs) {
  qs = qs || getQS(); // âœ… å¤–é¢æœ‰å‚³å°±ç”¨å¤–é¢çš„ï¼Œæ²’æœ‰æ‰è‡ªå·±æŠ“

  // âœ… ä»˜æ¬¾æ–¹å¼é é¸
  const pm = String(qs.get("pm") || "").trim();
  if (pm) {
    try { window.__prefill_payment_method = pm; } catch (e) {}
  }

  // âœ… æ”¶ä»¶è³‡è¨Šå›å¡«
  const shipB64 = String(qs.get("ship_b64") || "").trim();
  if (shipB64) {
    const raw = b64urlDecodeToString(shipB64);
    if (raw) {
      try {
        const shipInfo = JSON.parse(raw);
        const ship = shipInfo.ship || shipInfo.shipping || {};
        const store = ship.store || ship.cvs || {};

        if (ship.name && document.querySelector("#name"))  document.querySelector("#name").value = ship.name;
        if (ship.phone && document.querySelector("#phone")) document.querySelector("#phone").value = ship.phone;
        if (ship.email && document.querySelector("#email")) document.querySelector("#email").value = ship.email;
        if (ship.addr && document.querySelector("#addr"))   document.querySelector("#addr").value = ship.addr;

        if (store.store_id && document.querySelector("#store_id")) document.querySelector("#store_id").value = store.store_id;
        if (store.store_name && document.querySelector("#store_name")) document.querySelector("#store_name").value = store.store_name;
        if (store.store_addr && document.querySelector("#store_addr")) document.querySelector("#store_addr").value = store.store_addr;

        window.__prefill_shipping_info = shipInfo;
      } catch (e) {
        console.log("ship_b64 parse error", e);
      }
    }
  }
}

const qs = getQS();
applyRetryPrefillFromQS(qs);

let cartToken = qs.get("cart_token") || "";

if (!cartToken) {
  try {
    cartToken = localStorage.getItem("murain_cart_token") || "";
  } catch (e) {
    console.warn("localStorage read error", e);
  }
} else {
  try {
    localStorage.setItem("murain_cart_token", cartToken);
  } catch (e) {
    console.warn("localStorage write error", e);
  }
}

   /* ===== PayReturn/PayFail å›ä¾†ç”¨çš„åƒæ•¸ï¼ˆåŠ åœ¨ cartToken é€™æ®µå¾Œé¢ï¼‰ ===== */
const from = qs.get('from') || '';
const statusFromPay = qs.get('status') || '';
const orderIdFromPay = qs.get('order_id') || '';

const creditUsedFromPay = Math.max(0, Number(qs.get('credit_used') || 0) || 0);
const lockCreditFromPay =
  (qs.get('lock_credit') === '1') ||
  (from === 'payreturn') ||
  (from === 'payfail') ||
  (from === 'paynotify_fail');

// è®“ã€Œå›è³¼ç‰©è»Šã€ä¹Ÿèƒ½æ‰¾å›æœƒå“¡è³‡æ–™ï¼šå„ªå…ˆç”¨ URL çš„ user_idï¼Œæ²’æœ‰å°±ç”¨ localStorage
lineUserIdFromPay = qs.get('user_id') || '';
if (!lineUserIdFromPay) {
  try { lineUserIdFromPay = localStorage.getItem('murain_line_user_id') || ''; } catch (e) {}
} else {
  try { localStorage.setItem('murain_line_user_id', lineUserIdFromPay); } catch (e) {}
}

const initialMode=(qs.get('mode')||'').toUpperCase();
const tailOf      = qs.get('tail_of') || '';

function setTotal(v){
  CART_TOTAL_RAW = Number(v || 0);
  const sub = document.querySelector('#subtotal');
  const tot = document.querySelector('#total');
  const txt = money(CART_TOTAL_RAW);
  if (sub) sub.value = txt;
  if (tot) tot.value = txt;
  updateCreditAndTotal();
    // â˜… å›ä¾†æ™‚æŠŠ credit_used å¡«å›å»ï¼Œä¸¦é–ä½
  if (lockCreditFromPay) {
    const used = Math.max(0, Math.floor(Number(creditUsedFromPay || 0) || 0));
    CREDIT_USED = used;                  // åŒæ­¥å…¨åŸŸ
    lockCreditUI(used, orderIdFromPay);  // âœ… æœƒé–ä½ #credit_input
    updateCreditAndTotal();      
    // âœ… å†ä¿éšªä¸€æ¬¡ï¼šç¢ºä¿ input æœ‰å€¼
    const ci = document.getElementById('credit_input');
    if (ci) ci.value = String(used);
  }
  }


/* ===== Tabs ===== */
const tabs=$$('#payTabs .tab');
tabs.forEach(t=>t.addEventListener('click',()=>{
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const kt=t.dataset.pay;
  ['COD','PAID','DEPOSIT','ZEROCARD','YUFU'].forEach(x=>$('#pane'+x).hidden=(x!==kt));
}));

// âœ… C1) ç”¨ pm åˆ‡åˆ°æ­£ç¢º Tabï¼ˆåªåˆ‡ Tabï¼Œä¸å‹•å…¶ä»–ï¼‰
(function preselectPayTab(){
  const pm = String(window.__prefill_payment_method || "").trim();
  if (!pm) return;

  const p = pm.toLowerCase();
  let key = "PAID";
  if (p.includes("zero") || p.includes("zerocard")) key = "ZEROCARD";
  else if (p.includes("yufu")) key = "YUFU";
  else if (p.includes("deposit") || p.startsWith("dep")) key = "DEPOSIT";
  else if (p.includes("cod")) key = "COD";

  const tab = Array.from(tabs).find(t => String(t.dataset.pay || "").toUpperCase() === key);
  if (tab) tab.click();
})();

/* ===== PAID ===== */
function updatePaidChannelBox(){
  const ch = $('#paid_channel').value;
  $('#cardInstBox').hidden = (ch !== 'card_inst');
}
$('#paid_channel').addEventListener('change', updatePaidChannelBox);
$('#paid_ship_method').addEventListener('change', updatePaidShip);

  // âœ… C2) è‹¥ pm æ˜¯ paid_...ï¼ŒåŒæ­¥ #paid_channel / #inst_monthsï¼ˆåªåšä¸€æ¬¡ï¼‰
(function preselectPaidChannel(){
  const pm = String(window.__prefill_payment_method || "").trim();
  if (!pm) return;

  const p = pm.toLowerCase();
  if (!p.startsWith("paid_")) return;

  const paidChannel = document.getElementById("paid_channel");
  if (!paidChannel) return;

  let channel = "";
  let months  = "";

  if (p === "paid_card_once") channel = "card_once";
  else if (p === "paid_linepay") channel = "linepay";
  else if (p === "paid_aftee_direct") channel = "af";
  else {
    const m = p.match(/^paid_card_inst_(\d+)$/);
    if (m) { channel = "card_inst"; months = m[1]; }
  }

  if (channel) {
    paidChannel.value = channel;
    paidChannel.dispatchEvent(new Event("change", { bubbles: true }));
    // ä½ çš„ updatePaidChannelBox æœƒæŠŠ cardInstBox é¡¯ç¤º/éš±è—
    if (typeof updatePaidChannelBox === "function") updatePaidChannelBox();
  }

  if (channel === "card_inst" && months) {
    const inst = document.getElementById("inst_months");
    if (inst) {
      inst.value = months;
      inst.dispatchEvent(new Event("change", { bubbles: true }));
    }
  }

  // âœ… å…¨éƒ¨å¥—å®Œå†æ¸…æ‰ï¼Œé¿å…å¾Œé¢æµç¨‹åˆè¢«è¦†è“‹
  delete window.__prefill_payment_method;
})();

function updatePaidShip(){
  const m = $('#paid_ship_method').value;
  $('#paidShip711').hidden = (m !== '711');
  $('#paidShipPost').hidden = (m !== 'post');
  const meet = $('#paidShipMeetup');
  if (meet) meet.hidden = (m !== 'meetup');
}
// ===== CODï¼šè²¨åˆ° / é¢äº¤ åˆ‡æ› =====
const codTypeRadios = document.querySelectorAll('input[name="codType"]');

function refreshCodType() {
  const checked = document.querySelector('input[name="codType"]:checked');
  const v = checked ? checked.value : '711';
  const box711 = document.querySelector('#cod711Extra');
  const meetHint = document.querySelector('#codMeetHint');
  const meetBox = document.querySelector('#cod_meetup_box');
  if (box711) box711.hidden = (v !== '711');
  if (meetHint) meetHint.hidden = (v !== 'meetup');
  if (meetBox) meetBox.hidden = (v !== 'meetup');
  // âœ… é¡¯ç¤º/éš±è— 7-11 è²¨åˆ°ä»˜æ¬¾åŒæ„å‹¾é¸
  const agreeWrap = document.getElementById('cod711AgreeWrap');
  const agreeBox  = document.getElementById('cod711_agree');
  if (agreeWrap) agreeWrap.style.display = (v === '711') ? 'flex' : 'none';
  if (v !== '711' && agreeBox) agreeBox.checked = false;
}

if (codTypeRadios.length) {
  codTypeRadios.forEach(r => r.addEventListener('change', refreshCodType));
  refreshCodType();
}
/* ===== DEPOSITï¼šåˆ‡æ› Pane ===== */
$('#dep_new_full_method').addEventListener('change', () => {
  const m = $('#dep_new_full_method').value;
  $('#depNewFull711').hidden = (m !== '711');
  $('#depNewFullPost').hidden = (m !== 'post');
  const meet = $('#depNewFullMeetup');
  if (meet) meet.hidden = (m !== 'meetup');
});

const depOldMethod  = $('#dep_old_method');
const depOldBox711  = $('#dep_old_box_711');
const depOldBoxPost = $('#dep_old_box_post');

function updateDepOldShip(){
  if (!depOldMethod) return;
  const m = depOldMethod.value;
  if (depOldBox711)  depOldBox711.hidden  = (m !== '711');
  if (depOldBoxPost) depOldBoxPost.hidden = (m !== 'post');
}

if (depOldMethod) {
  depOldMethod.addEventListener('change', updateDepOldShip);
  updateDepOldShip();
}

const depTypeRadios     = document.querySelectorAll('input[name="depType"]');
const depOldPane        = document.querySelector('#depOldPane');
const depNewFullPane    = document.querySelector('#depNewFullPane');
const depOldAmount      = document.querySelector('#dep_old_amount');
const depOldHoldUntil   = document.querySelector('#dep_old_hold_until');

   function ymdLocal(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function applyDepOldHoldLimit(){
  if (!depOldHoldUntil) return;

  const today = new Date();
  today.setHours(0,0,0,0);

  const maxD = new Date(today);
  maxD.setDate(maxD.getDate() + 30); // â† 30 å¤©å…§ï¼ˆè¦ 1 å€‹æœˆå¯æ”¹ 31ï¼‰

  depOldHoldUntil.min = ymdLocal(today);
  depOldHoldUntil.max = ymdLocal(maxD);

  const v = (depOldHoldUntil.value || "").slice(0,10);
  if (v && (v < depOldHoldUntil.min || v > depOldHoldUntil.max)) {
    depOldHoldUntil.value = "";
  }
}

// é é¢è¼‰å…¥å°±å¥—ç”¨ä¸€æ¬¡
applyDepOldHoldLimit();

   // âœ… ä½¿ç”¨è€…æ‰‹å‹•æ”¹æ—¥æœŸæ™‚ä¹Ÿç«‹åˆ»å¥—ç”¨é™åˆ¶ï¼ˆé¿å…é¸åˆ°è¶…é 30 å¤©ï¼‰
if (depOldHoldUntil) {
  depOldHoldUntil.addEventListener('change', applyDepOldHoldLimit);
}

// åˆ‡æ›åˆ°ã€ŒåŒ¯æ¬¾å®šé‡‘ã€æ™‚ä¹Ÿå†å¥—ç”¨ä¸€æ¬¡
if (depTypeRadios.length) {
  depTypeRadios.forEach(r => r.addEventListener('change', applyDepOldHoldLimit)); // Fixed syntax error here
}

function refreshDepType() {
  const checked   = document.querySelector('input[name="depType"]:checked');
  const v         = checked ? checked.value : 'new_full';
  const isDeposit = (v === 'old');

  if (depOldPane && depNewFullPane) {
    depOldPane.hidden     = !isDeposit;
    depNewFullPane.hidden =  isDeposit;
  }

  if (depOldAmount)     depOldAmount.required   = isDeposit;
  if (depOldHoldUntil)  depOldHoldUntil.required= isDeposit;
}

if (depTypeRadios.length) {
  depTypeRadios.forEach(r => r.addEventListener('change', refreshDepType));
  refreshDepType();
}

/* ===== ZEROCARD ===== */
function calcZC(){
  const months = Number($('#zc_months').value || 3);

  // â˜… ç”¨æŠ˜æŠµå¾Œå¯¦éš›åˆ†æœŸé‡‘é¡
  const base = Math.max((CART_TOTAL_RAW || 0) - CREDIT_USED, 0);

  const rate  = (RATE_TABLE[months] || 0) / 100;
  const total = Math.round(base * (1 + rate));
  const each  = Math.round(total / months);

  $('#zc_each').value = money(each) + ' Ã— ' + months + ' æœŸ';
}
$('#zc_months').addEventListener('change',calcZC);
$('#zc_ship_method').addEventListener('change',updateZcShip);

function updateZcShip(){
  const m = $('#zc_ship_method').value;
  $('#zcShip711').hidden = (m !== '711');
  $('#zcShipPost').hidden = (m !== 'post');
  const meet = $('#zcShipMeetup');
  if (meet) meet.hidden = (m !== 'meetup');
}

   // ===== YUFUï¼šè£•å¯Œåˆ†æœŸï¼ˆæ–°å¢ï¼‰ =====
// ä½ å¯è‡ªè¡Œèª¿æ•´åˆ©ç‡ï¼…ï¼ˆç¤ºæ„å€¼ï¼‰
const YUFU_RATE_TABLE = {
  3:  0.0,  // é›¶åˆ©ç‡
  6:  2.9,
  9:  4.2,
  12: 5.5,
  24: 10.8,
  36: 14.5
};

function calcYUFU(){
  const months = Number(document.getElementById('yufu_months')?.value || 0);

  // âœ… ç”¨å…¨åŸŸè³¼ç‰©è»Šé‡‘é¡ï¼ˆæŠ˜æŠµå¾Œï¼‰è©¦ç®—
  const base   = Math.max(0, Math.round((CART_TOTAL_RAW || 0) - (CREDIT_USED || 0)));

  const rate   = Number(YUFU_RATE_TABLE[months] ?? 0);
  const total  = Math.max(0, Math.round(base * (1 + rate/100)));
  const perMon = months ? Math.ceil(total / months) : 0;

  const el = document.getElementById('yufu_monthly');
  if (el) el.value = months ? `${money(perMon)} x ${months} æœŸ` : '';

  const note = document.getElementById('yufu_rate_note');
  if (note){
    note.textContent =
      months === 3
        ? `3 æœŸé›¶åˆ©ç‡ï¼›ä»¥æŠ˜æŠµå¾Œé‡‘é¡ ${money(base)} è©¦ç®—ã€‚å¯¦éš›ä»¥è£•å¯Œç°¡è¨Šç‚ºæº–ã€‚`
        : `${months} æœŸåˆ©ç‡ç´„ ${rate}%ï¼›ä»¥æŠ˜æŠµå¾Œé‡‘é¡ ${money(base)} è©¦ç®—ã€‚å¯¦éš›ä»¥è£•å¯Œç°¡è¨Šç‚ºæº–ã€‚`;
  }
}

function updateYufuShip(){
  const m = (document.getElementById('yufu_ship_method')?.value || '');
  const s711  = document.getElementById('yufuShip711');
  const spost = document.getElementById('yufuShipPost');
  const smeet = document.getElementById('yufuShipMeet');
  if (s711)  s711.style.display  = (m === '711')    ? '' : 'none';
  if (spost) spost.style.display = (m === 'post')  ? '' : 'none';
  if (smeet) smeet.style.display = (m === 'meetup')? '' : 'none';
}

// äº‹ä»¶
document.getElementById('yufu_months')?.addEventListener('change', calcYUFU);
document.getElementById('yufu_ship_method')?.addEventListener('change', updateYufuShip);

  // âœ… C3) è£œå®Œï¼šæŠŠ pm å¥—åˆ°ã€Œé PAIDã€çš„ UIï¼ˆCOD / DEPOSIT / ZEROCARD / YUFUï¼‰
(function preselectNonPaidFromPM(){
  const pm = String(window.__prefill_payment_method || "").trim();
  if (!pm) return;

  const p = pm.toLowerCase();

  // å°å·¥å…·ï¼šé» Tab
  const clickTab = (key) => {
    try {
      const tab = Array.from(document.querySelectorAll('#payTabs .tab'))
        .find(t => String(t.dataset.pay || '').toUpperCase() === String(key || '').toUpperCase());
      if (tab) tab.click();
    } catch (e) {}
  };

  // å°å·¥å…·ï¼šè¨­ select + è§¸ç™¼ change
  const setSelect = (id, val) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.value = String(val);
    el.dispatchEvent(new Event('change', { bubbles: true }));
  };

  // å°å·¥å…·ï¼šè¨­ radio + è§¸ç™¼ change
  const setRadio = (name, val) => {
    const el = document.querySelector(`input[name="${name}"][value="${val}"]`);
    if (!el) return;
    el.checked = true;
    el.dispatchEvent(new Event('change', { bubbles: true }));
  };

  // --- CODï¼ˆå«é¢äº¤ç¾é‡‘ï¼‰ ---
  if (p.includes('cod') || p.includes('meetup')) {
    clickTab('COD');
    // ä½ çš„ codType æ˜¯ 711 / meetupï¼ˆæª”æ¡ˆå…§å°±æ˜¯é€™æ¨£ï¼‰
    setRadio('codType', p.includes('meetup') ? 'meetup' : '711');
    try { refreshCodType(); } catch(e) {}
    delete window.__prefill_payment_method;
    return;
  }

  // --- DEPOSITï¼ˆåŒ¯æ¬¾å®šé‡‘/å…¨é¡åŒ¯æ¬¾ï¼‰ ---
  if (p.includes('deposit') || p.startsWith('dep')) {
    clickTab('DEPOSIT');
    // ä½ çš„ depType æ˜¯ old / new_fullï¼ˆæª”æ¡ˆå…§å°±æ˜¯é€™æ¨£ï¼‰
    setRadio('depType', (p === 'deposit_old') ? 'old' : 'new_full');
    try { refreshDepType(); } catch(e) {}
    try { applyDepOldHoldLimit(); } catch(e) {}
    delete window.__prefill_payment_method;
    return;
  }

  // --- ZEROCARDï¼ˆç„¡å¡åˆ†æœŸï¼šzero_card_3/6/9/12...ï¼‰ ---
  if (p.includes('zero') || p.includes('zerocard')) {
    clickTab('ZEROCARD');
    const m = p.match(/(\d+)\s*$/) || p.match(/zero_card_(\d+)/);
    const months = m ? (m[1] || m[0]) : '';
    if (months) setSelect('zc_months', months);
    try { calcZC(); } catch(e) {}
    try { updateZcShip(); } catch(e) {}
    delete window.__prefill_payment_method;
    return;
  }

  // --- YUFUï¼ˆè£•å¯Œåˆ†æœŸï¼šyufu_inst_3/6/9/12/24/36...ï¼‰ ---
  if (p.includes('yufu')) {
    clickTab('YUFU');
    const m = p.match(/(\d+)\s*$/) || p.match(/yufu_inst_(\d+)/);
    const months = m ? (m[1] || m[0]) : '';
    if (months) setSelect('yufu_months', months);
    try { calcYUFU(); } catch(e) {}
    try { updateYufuShip(); } catch(e) {}
    delete window.__prefill_payment_method;
    return;
  }

  // paid_ ä¸åœ¨é€™è£¡è™•ç†ï¼šäº¤çµ¦ä½ åŸæœ¬ C2ï¼ˆpreselectPaidChannelï¼‰
})

/* ===== è³¼ç‰©è»Šè¼‰å…¥ ===== */
async function loadCart(){
  if (!cartToken) {
    console.warn('missing cart_token');
    return;
  }
  try {
    const r = await fetch(`${API}/cart/${cartToken}`);
    const j = await r.json();
    

    if (!r.ok || !j || j.ok === false) {
  throw new Error(j?.error || j?.message || 'cart_api_error');
}
if (!Array.isArray(j.items)) {
  throw new Error('cart_items_missing');
}

    const items = j.items || [];
    const total = Number(j.total_amount || 0);
    CART_TOTAL_RAW = total;

    const detail = items.map(it => 
      `${it.name || it.sku} x ${it.qty}ï¼ˆNT$${Number(it.price || 0)}ï¼‰`
    ).join('\n');

    const detailBox = document.querySelector('#itemsText');
    if (detailBox) detailBox.value = detail;

    setTotal(total);
    calcZC();

CART_LOADED = true; // âœ… åŠ åœ¨é€™è£¡
  } catch (e) {
    console.error('loadCart error', e);
    alert('è®€å–è³¼ç‰©è»Šå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚');
  }
}

/* ===== 7-11 åœ°åœ– ===== */
function open711(src) {
  saveCheckoutState();
  // âœ…ã€æ–°å¢ã€‘è¨˜ä½ä½¿ç”¨è€…è¼¸å…¥çš„è³¼ç‰©é‡‘ï¼ˆ7-11 è·³è½‰å‰ï¼‰
  try {
    const ci = document.getElementById('credit_input');
    if (ci && ci.value !== '') {
      sessionStorage.setItem('murain_credit_used', String(ci.value));
    }
  } catch(e) {}

  
  // âœ… åŠ é€™æ®µï¼šçµ¦ message listener / applyStoreFromURL ç•¶å‚™æ´
  try { sessionStorage.setItem('murain_store_src', String(src).toLowerCase()); } catch (e) {}

  const qs2 = getQS();                 // âœ… åƒå¾—åˆ° liff.state å…§åƒæ•¸
qs2.delete("liff.state");
qs2.delete("liffState");
if (cartToken) qs2.set("cart_token", cartToken); // âœ… ä¿éšªè£œä¸Š
  const activeTab = document.querySelector('#payTabs .tab.active')?.dataset?.pay || '';
  if (activeTab) qs2.set('mode', activeTab);
  else qs2.delete('mode');

  qs2.set('src', String(src).toLowerCase());

  // âœ… store_src çµ¦å‰ç«¯å›å¡«ç”¨ï¼ˆçŸ¥é“è¦å›å¡«åˆ°å“ªä¸€çµ„æ¬„ä½ï¼‰
  qs2.set('store_src', String(src).toLowerCase());

  qs2.delete('customer');

 // ğŸš¨ LIFF å›ä¾†æ™‚ï¼Œä¸è‡ªå‹•å°å» cvs map
if (!sessionStorage.getItem('__from_liff_state')) {
  if (!sessionStorage.getItem('__cvs_redirected')) {
    sessionStorage.setItem('__cvs_redirected', '1');
    const url = `${API}/cvs/map?${qs2.toString()}`;
    window.location.href = url;
  }
}
function applyStoreFromURL(){
  // âœ… ç”¨ getQS() æ‰åƒå¾—åˆ° LIFF çš„ liff.state å…§åƒæ•¸
  const qs2 = getQS();
  let src = (qs2.get('store_src') || '').toLowerCase();

  // âœ… è‹¥å¾Œç«¯æ²’ä¿ç•™ store_srcï¼Œå°±ç”¨ sessionStorage çš„å‚™æ´
  if (!src) {
    try { src = (sessionStorage.getItem('murain_store_src') || '').toLowerCase(); } catch(e){}
  }

  const id =
    qs2.get('store_id') || qs2.get('cvs_code') || qs2.get('CVSStoreID') || qs2.get('STOREID') || '';
  const name =
    qs2.get('store_name') || qs2.get('cvs_name') || qs2.get('CVSStoreName') || qs2.get('STORENAME') || '';
  const addr =
    qs2.get('store_addr') || qs2.get('cvs_addr') || qs2.get('CVSAddress') || qs2.get('STOREADDRESS') || '';

  if (!src || !id) return;

  const fill = (a,b,c)=>{ setFieldValue(a,id); setFieldValue(b,name); setFieldValue(c,addr); };

  // âœ… é¸ä¸€æ¬¡é–€å¸‚ â†’ å…¨åˆ†é åŒæ­¥åŒä¸€å®¶
  const targets = [
    ['#cod_store_id',               '#cod_store_name',               '#cod_store_addr'],
    ['#ship_store_id_paid',         '#ship_store_name_paid',         '#ship_store_addr_paid'],
    ['#ship_store_id_yufu',         '#ship_store_name_yufu',         '#ship_store_addr_yufu'],
    ['#dep_old_store_id',           '#dep_old_store_name',           '#dep_old_store_addr'],
    ['#dep_new_full_store_id',      '#dep_new_full_store_name',      '#dep_new_full_store_addr'],
    ['#dep_new_partial_store_id',   '#dep_new_partial_store_name',   '#dep_new_partial_store_addr'],
    ['#ship_store_id_zc',           '#ship_store_name_zc',           '#ship_store_addr_zc'],
  ];
  targets.forEach(([a,b,c]) => fill(a,b,c));
  try { saveCheckoutState(); } catch(e){}
try { sessionStorage.setItem('murain_skip_restore_once','1'); } catch(e){}

  // âœ… å›ä¾†åˆ‡å›ä½ å‰›å‰›çš„åˆ†é ï¼ˆmode å„ªå…ˆï¼‰
  const mode = (qs2.get('mode') || '').toUpperCase().trim();
  if (mode) {
    document.querySelector(`#payTabs .tab[data-pay="${mode}"]`)?.click();
  } else {
    const tabMap = { cod:'COD', paid:'PAID', yufu:'YUFU', dep_old:'DEPOSIT', dep_new_f:'DEPOSIT', zc:'ZEROCARD' };
    const kt = tabMap[src];
    if (kt) document.querySelector(`#payTabs .tab[data-pay="${kt}"]`)?.click();
  }

  // âœ… âœ… æ ¸å¿ƒï¼šå›å¡«å®Œã€Œç«‹åˆ»å­˜èµ·ä¾†ã€â†’ ä¸‹ä¸€æ¬¡é–‹çµå¸³å°±ä¸æœƒè·³å›èˆŠé–€å¸‚
  try { saveCheckoutState(); } catch(e){}

  // âœ… å¯é¸ä½†å¼·çƒˆå»ºè­°ï¼šæŠŠ URL çš„ store_* æ¸…æ‰ï¼Œé¿å…é‡æ•´æ™‚åˆé‡è¦†å¥—ç”¨èˆŠåƒæ•¸
  try {
    const clean = new URLSearchParams(location.search);
    ['store_id','store_name','store_addr','store_src','cvs_code','cvs_name','cvs_addr','CVSStoreID','CVSStoreName','CVSAddress','STOREID','STORENAME','STOREADDRESS'].forEach(k=>clean.delete(k));
    history.replaceState({}, '', location.pathname + (clean.toString() ? `?${clean.toString()}` : ''));
  } catch(e){}
}
// ===== è³¼ç‰©é‡‘æŠ˜æŠµè¨ˆç®— =====
function updateCreditAndTotal() {
  const input = document.querySelector('#credit_input');
  const after = document.querySelector('#total_after_credit');
  const msgEl = document.querySelector('#credit_msg');

  let used = 0;
  if (input && input.value !== '') {
    used = Math.floor(Number(input.value) || 0);
  }
  if (!Number.isFinite(used) || used < 0) used = 0;

  // âœ… é¤˜é¡å°šæœªè¼‰å…¥å®Œæˆæ™‚ï¼šå…ˆä¸è¦ç”¨ AVAILABLE_CREDIT å¤¾æ‰ä½¿ç”¨é¡ï¼Œé¿å… 500 è¢«æ´—æˆ 0
  let maxUse;
  if (!CREDIT_READY) {
    maxUse = Math.max(0, CART_TOTAL_RAW);
  } else {
    maxUse = Math.min(Math.max(0, AVAILABLE_CREDIT), Math.max(0, CART_TOTAL_RAW));
  }
  if (used > maxUse) used = maxUse;

  CREDIT_USED = used;

  // âœ… CREDIT_READY å‰ä¸è¦è¦†å¯« inputï¼ˆé¿å…å‰› restore çš„ 500 è¢«æ”¹æˆ 0ï¼‰
  if (input && CREDIT_READY) {
    if (input.value !== '') input.value = String(used);
  }

  if (msgEl) {
    if (CART_TOTAL_RAW <= 0) {
      msgEl.textContent = '';
    } else if (AVAILABLE_CREDIT <= 0) {
      msgEl.textContent = 'ç›®å‰ç„¡å¯ç”¨è³¼ç‰©é‡‘ã€‚';
    } else if (CREDIT_USED > 0) {
      msgEl.textContent = `æœ¬æ¬¡å°‡æŠ˜æŠµ NT$ ${CREDIT_USED.toLocaleString()}ï¼Œå¯¦éš›ä»˜æ¬¾é‡‘é¡å¦‚ä¸‹ã€‚`;
    } else {
      msgEl.textContent = 'è‹¥ä¸ä½¿ç”¨è³¼ç‰©é‡‘ï¼Œå¯å°‡æ­¤æ¬„ä½ç•™ç©ºã€‚';
    }
  }

  const pay = Math.max((CART_TOTAL_RAW || 0) - (CREDIT_USED || 0), 0);
  if (after) after.value = money(pay);

  try { calcZC(); } catch (e) {}
  try { calcYUFU(); } catch (e) {}
}

// ===== è³¼ç‰©é‡‘è¼¸å…¥ï¼šå³æ™‚é‡ç®—ï¼ˆèª å¯¦ä»¥ AVAILABLE_CREDIT ç‚ºæº–ï¼‰=====
try {
  const _ci = document.getElementById('credit_input');
  if (_ci) {
    _ci.addEventListener('input', updateCreditAndTotal);
    _ci.addEventListener('blur',  updateCreditAndTotal);
  }
} catch (e) {}

function lockCreditUI(used, orderId) {
  try {
    // ä½ è‹¥æœ‰è³¼ç‰©é‡‘ inputï¼Œå¸¸è¦‹ id/name æˆ‘éƒ½å…¼å®¹æŠ“
    const el =
  document.querySelector("#credit_input") ||   // âœ… ä½ çš„æª”æ¡ˆå¯¦éš›ä½¿ç”¨çš„æ˜¯é€™å€‹
      document.querySelector("#creditUsed") ||
      document.querySelector("#credit_used") ||
      document.querySelector("input[name='credit_used']") ||
      document.querySelector("input[data-role='credit_used']");

    if (el) {
      el.value = String(used || 0);
      // ä¸å†é–æ­»è¼¸å…¥æ¡†ï¼šå¾Œç«¯å·²æ¡ç”¨ã€Œå¤±æ•—å³å–æ¶ˆ + é€€æ¬¾ã€ï¼Œè®“å®¢äººå¯è‡ªç”±èª¿æ•´æ˜¯å¦ä½¿ç”¨è³¼ç‰©é‡‘
      // el.disabled = true;
      // el.setAttribute("readonly","readonly");
}

    // ä½ å¦‚æœæœ‰é¡¯ç¤ºæ–‡å­—å€å¡Šï¼Œå°±æ›´æ–°æç¤ºï¼ˆæ²’æœ‰ä¹Ÿä¸æœƒå£ï¼‰
    const hint =
      document.querySelector("#credit_msg") ||          // âœ… ä½ çœŸæ­£ç”¨çš„
      document.querySelector("#creditLockHint") ||
      document.querySelector("[data-credit-lock-hint]");

    const msg = `å·²å¸¶å…¥ä¸Šæ¬¡ä½¿ç”¨çš„è³¼ç‰©é‡‘é‡‘é¡ï¼ˆå¯è‡ªè¡Œèª¿æ•´ï¼‰ã€‚${orderId ? "è¨‚å–®ï¼š" + orderId : ""}`;

    if (hint) {
      hint.textContent = msg;
      hint.style.display = "";
    } else {
      // æ²’æœ‰æç¤ºå®¹å™¨å°±å…ˆä¸å¼·åˆ¶æ’ DOMï¼Œé¿å…ç ´ç‰ˆ
      console.log("[credit lock]", msg);
    }

    // è‹¥ä½ æœ‰ç¸½é‡‘é¡é‡ç®—å‡½å¼ï¼Œé€™è£¡å¯ä»¥é †ä¾¿å‘¼å«ï¼ˆæœ‰å°±ç”¨ã€æ²’æœ‰å°±è·³éï¼‰
    if (typeof updateCreditAndTotal === "function") updateCreditAndTotal();
  } catch (e) {
    console.log("lockCreditUI error", e);
  }
}

function setFieldValue(sel, val){
  const el = document.querySelector(sel);
  if (!el) return false;
  el.value = val || '';
  try {
    el.dispatchEvent(new Event('input', {bubbles:true}));
    el.dispatchEvent(new Event('change', {bubbles:true}));
  } catch(e){}
  return true;
}

function normalizeStorePayload(ev){
  const d = ev && ev.data;
  if (!d) return null;

  if (d.type === '711_store' && d.data) {
    const p = d.data;
    return {
      ok: !!p.ok,
      src: p.src || '',
      id:   p.id   || p.cvs_code || p.store_id || p.CVSStoreID || p.STOREID || '',
      name: p.name || p.cvs_name || p.store_name || p.CVSStoreName || p.STORENAME || '',
      addr: p.addr || p.cvs_addr || p.store_address || p.CVSAddress || p.STOREADDRESS || ''
    };
  }

  if (d.type === 'cvs_selected') {
    return {
      ok: true,
      src: d.src || '',
      id:   d.cvs_code || d.id || d.store_id || d.CVSStoreID || d.STOREID || '',
      name: d.cvs_name || d.name || d.store_name || d.CVSStoreName || d.STORENAME || '',
      addr: d.cvs_addr || d.addr || d.store_address || d.CVSAddress || d.STOREADDRESS || ''
    };
  }

  return null;
}

window.addEventListener('message', (ev)=>{
  const p = normalizeStorePayload(ev);
  if (!p || !p.ok) return;

  let src = (p.src || '').toLowerCase();

  try {
    const real = (sessionStorage.getItem('murain_store_src') || '').toLowerCase();
    if (real === 'yufu' && src === 'paid') src = 'yufu';
  } catch(e){}

  const fill = (a,b,c)=>{ setFieldValue(a, p.id); setFieldValue(b, p.name); setFieldValue(c, p.addr); };

  const targets = [
    ['#cod_store_id',               '#cod_store_name',               '#cod_store_addr'],
    ['#ship_store_id_paid',         '#ship_store_name_paid',         '#ship_store_addr_paid'],
    ['#ship_store_id_yufu',         '#ship_store_name_yufu',         '#ship_store_addr_yufu'],
    ['#dep_old_store_id',           '#dep_old_store_name',           '#dep_old_store_addr'],
    ['#dep_new_full_store_id',      '#dep_new_full_store_name',      '#dep_new_full_store_addr'],
    ['#dep_new_partial_store_id',   '#dep_new_partial_store_name',   '#dep_new_partial_store_addr'],
    ['#ship_store_id_zc',           '#ship_store_name_zc',           '#ship_store_addr_zc'],
  ];

  targets.forEach(([a,b,c]) => fill(a,b,c));
  try { saveCheckoutState(); } catch(e){}
try { sessionStorage.setItem('murain_skip_restore_once','1'); } catch(e){}

  // âœ… å›ä¾†åˆ‡å›ä½ å‰›å‰›çš„åˆ†é ï¼ˆmode å„ªå…ˆï¼‰
  const mode = (getQS().get('mode') || '').toUpperCase().trim(); // âœ… å»ºè­°ä¸€èµ·æ”¹
  if (mode) {
    document.querySelector(`#payTabs .tab[data-pay="${mode}"]`)?.click();
  }
});

/* checkout ç‹€æ…‹æš«å­˜ */
const CHECKOUT_STATE_KEY = 'murain_checkout_state_v1';

  function _pendingKey(token){ return `murain_pending_pay_cart_${token}`; }

function markCartPendingPay(token, orderId, paymentMethod){
  if (!token || !orderId) return;
  try{
    localStorage.setItem(_pendingKey(token), JSON.stringify({
      order_id: String(orderId),
      payment_method: String(paymentMethod || ''),
      at: Date.now()
    }));
  }catch(e){}
}

function getPendingPay(token){
  if (!token) return null;
  try{
    const raw = localStorage.getItem(_pendingKey(token));
    if (!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}

function clearPendingPay(token){
  if (!token) return;
  // âœ… æ­£ç¢º keyï¼šèˆ‡ markCartPendingPay / getPendingPay å®Œå…¨ä¸€è‡´
  try { localStorage.removeItem(_pendingKey(token)); } catch(e){}

  // âœ… ç›¸å®¹èˆŠç‰ˆéŒ¯èª¤ keyï¼ˆä½ ä¹‹å‰ç”¨éçš„ï¼‰
  try { localStorage.removeItem(`murain_pending_pay_${token}`); } catch(e){}
}

  // âœ… é˜²é‡è¤‡çµå–®ï¼ˆå‰ç«¯é–ï¼‰ï¼šåŒä¸€å€‹ cart_token æˆåŠŸçµå–®å¾Œï¼ŒBack/é‡æ•´ç›´æ¥æ“‹æ‰
function _coKey(token){ return `murain_checked_out_cart_${token}`; }

function markCartCheckedOut(token, orderId, netAmount){
  if (!token || !orderId) return;
  try{
    localStorage.setItem(_coKey(token), JSON.stringify({
      order_id: String(orderId),
      net_amount: Number(netAmount || 0) || 0,
      at: Date.now()
    }));
  }catch(e){}
}

function getCheckedOutInfo(token){
  if (!token) return null;
  try{
    const raw = localStorage.getItem(_coKey(token));
    if (!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}

// âœ… è‹¥é€™å€‹ cart_token ä¹‹å‰å·²æˆåŠŸçµå–® â†’ ç›´æ¥å°å»çµæœé ï¼ˆæˆ–è‡³å°‘ç¦ç”¨é€å‡ºï¼‰
function guardAlreadyCheckedOut(token){
  const info = getCheckedOutInfo(token);
  if (!info || !info.order_id) return false;

  // ä½ è‹¥æƒ³çµ¦ã€Œå¼·åˆ¶é‡é–‹ã€æ©Ÿåˆ¶ï¼Œå¯ç”¨ ?force=1 ç•¥é
  const qs = new URLSearchParams(location.search);
  if (qs.get("force") === "1") return false;

  const btn = document.getElementById("submitBtn");
  if (btn) btn.disabled = true;

  alert(`æ­¤è³¼ç‰©è»Šå·²å®Œæˆçµå–®ï¼ˆè¨‚å–®ï¼š${info.order_id}ï¼‰ã€‚å°‡å¸¶ä½ å‰å¾€è¨‚å–®é ã€‚`);

  // å¤šæ•¸ order-result å…¶å¯¦åªéœ€è¦ order_idï¼Œtotal å¯ä¸å¸¶
  const url = `/order-result.html?order_id=${encodeURIComponent(info.order_id)}`;
  try { location.replace(url); } catch(e){ location.href = url; }
  return true;
}

function saveCheckoutState() {
   // ğŸ”’ã€é—œéµä¿è­·ã€‘æœ‰ cartToken ä½†è³¼ç‰©è»Šå°šæœªè¼‰å…¥å®Œæˆ â†’ ç¦æ­¢å­˜ç©ºç‹€æ…‹
  if (cartToken && !CART_LOADED) {
    return;
  }
  const state = {};
  document.querySelectorAll('input, select, textarea').forEach(el => {
    const key = el.id || el.name;
    if (!key) return;

    if (el.type === 'radio' || el.type === 'checkbox') {
      if (!state[key]) state[key] = {};
      state[key][el.value] = el.checked;
    } else {
      state[key] = el.value;
    }
  });

  state.__activeTab = ([...document.querySelectorAll('#payTabs .tab')]
  .find(t => t.classList.contains('active'))?.dataset?.pay) || '';
  try {
    localStorage.setItem(CHECKOUT_STATE_KEY, JSON.stringify(state));
  } catch (e) {
    console.warn('saveCheckoutState failed', e);
  }
}

function restoreCheckoutState() {
   try {
    if (sessionStorage.getItem('murain_skip_restore_once') === '1') {
      sessionStorage.removeItem('murain_skip_restore_once');
      return;
    }
  } catch(e){}
  let raw = null;
  try { raw = localStorage.getItem(CHECKOUT_STATE_KEY); } catch (e) {}
  if (!raw) return;

  let state;
  try { state = JSON.parse(raw); } catch { return; }

  // 1) å…ˆå›å¡«æ‰€æœ‰æ¬„ä½
  document.querySelectorAll('input, select, textarea').forEach(el => {
    const key = el.id || el.name;
    if (!key || !(key in state)) return;

    if (el.type === 'radio' || el.type === 'checkbox') {
      const map = state[key];
      if (map && typeof map === 'object') el.checked = !!map[el.value];
    } else {
      el.value = state[key];
    }
  });

  // 2) âœ… æŠŠé ç±¤åˆ‡å›å»ï¼ˆé¿å…å›ä¾†çœ‹èµ·ä¾†è®Š CODï¼‰
  const kt = String(state.__activeTab || '').toUpperCase().trim();
  if (kt) {
    const tab = document.querySelector(`#payTabs .tab[data-pay="${kt}"]`);
    if (tab) tab.click(); // ä½ åŸæœ¬ tabs click å·²ç¶“æœƒè™•ç† hidden åˆ‡æ› :contentReference[oaicite:6]{index=6}
  }

  // 3) âœ… å†è·‘ä¸€æ¬¡ UI é¡¯ç¤ºåˆ‡æ›ï¼ˆé–€å¸‚/å¯„é€å€å¡Šæ‰æœƒæ­£ç¢ºé¡¯ç¤ºï¼‰
  try { updatePaidChannelBox(); } catch(e){}
  try { updatePaidShip(); } catch(e){}
  try { updateZcShip(); } catch(e){}
  try { updateYufuShip(); } catch(e){}
  try { calcYUFU(); } catch(e){}
  try { refreshCodType(); } catch(e){} // ä½ æª”æ¡ˆè£¡æœ‰ :contentReference[oaicite:7]{index=7}
}

function clearCheckoutState() {
  try {
    localStorage.removeItem(CHECKOUT_STATE_KEY);
  } catch (e) {}
}

/* ç¶å®šæ‰€æœ‰ 7-11 åœ°åœ–æŒ‰éˆ• */
$('#mapCOD').addEventListener('click',e=>{e.preventDefault();open711('cod');});
$('#mapPAID').addEventListener('click',e=>{e.preventDefault();open711('paid');});
$('#mapDepOld').addEventListener('click',e=>{e.preventDefault();open711('dep_old');});
$('#mapDepNewFull').addEventListener('click',e=>{e.preventDefault();open711('dep_new_f');});
$('#mapZC').addEventListener('click',e=>{e.preventDefault();open711('zc');});
   const mapY = document.getElementById('mapYUFU');
if (mapY) mapY.addEventListener('click', e=>{ e.preventDefault(); open711('yufu'); });

/* ===== é€å‡º ===== */
function required(v){ return v && String(v).trim().length>0; }

document.getElementById('submitBtn').addEventListener('click',async(e)=>{
  e.preventDefault();
  if(!cartToken){ alert('ç¼ºå°‘ cart_tokenï¼Œè«‹ç”±æ­£ç¢ºçµå¸³é€£çµé€²å…¥'); return; }

  const subtotal = CART_TOTAL_RAW;
  if(!subtotal){ alert('é‡‘é¡ç‚º 0ï¼Œè«‹ç¢ºèªè³¼ç‰©è»Šå…§å®¹'); return; }

  const note = $('#note').value || '';
  const shipping_info = { note };

  // âœ… è‹¥ä½¿ç”¨è€…æœ‰è¼¸å…¥è³¼ç‰©é‡‘ï¼Œä½†é¤˜é¡é‚„æ²’è¼‰å…¥å®Œæˆï¼Œå…ˆé˜»æ­¢é€å‡ºé¿å…è¢«ç•¶æˆ 0
if (!CREDIT_READY) {
  const v = (document.getElementById('credit_input')?.value || '').trim();
  if (v !== '') {
    alert('è³¼ç‰©é‡‘é¤˜é¡è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™ 1 ç§’å†é€å‡ºï¼ˆé¿å…è¢«åˆ¤å®šç‚º 0ï¼‰ã€‚');
    return;
  }
}

    // ===== è³¼ç‰©é‡‘é©—è­‰ï¼ˆä»¥ AVAILABLE_CREDIT ç‚ºæº–ï¼‰=====
  const creditInput = document.getElementById('credit_input');

  let creditUsed = 0;
  if (creditInput && creditInput.value !== '') {
    creditUsed = Math.floor(Number(creditInput.value) || 0);
    if (!Number.isFinite(creditUsed) || creditUsed < 0) {
      alert('è³¼ç‰©é‡‘ä½¿ç”¨é‡‘é¡è«‹å¡«ã€Œ0 ä»¥ä¸Šçš„æ•´æ•¸ã€ï¼Œè‹¥ä¸ä½¿ç”¨å¯ç•™ç©ºã€‚');
      return;
    }
  }

  const maxCredit = Math.max(0, Math.floor(Number(AVAILABLE_CREDIT || 0) || 0));

  if (creditUsed > maxCredit) {
    alert('è³¼ç‰©é‡‘ä½¿ç”¨é‡‘é¡ä¸å¯è¶…éå¯ç”¨é¤˜é¡ï¼ˆNT$ ' + maxCredit.toLocaleString() + 'ï¼‰ã€‚');
    return;
  }
  if (creditUsed > subtotal) {
    alert('è³¼ç‰©é‡‘ä½¿ç”¨é‡‘é¡ä¸å¯è¶…éæœ¬æ¬¡æ‡‰ä»˜é‡‘é¡ã€‚');
    return;
  }

  // âœ… æ‰€æœ‰æª¢æŸ¥é€šéæ‰å¯«å…¥ï¼ˆè®“å¾Œç«¯çœŸçš„æ‰£ï¼‰
  if (creditUsed > 0) {
    shipping_info.credit_used = creditUsed;
  } else {
    // ä¿éšªï¼šä¸è¦å¸¶ 0 éå»
    if (shipping_info.credit_used !== undefined) delete shipping_info.credit_used;
  }

  // LIFF profile / LINE ç¶å®š
  if (LINE_PROFILE && LINE_PROFILE.userId) {
  shipping_info.line = {
    user_id: LINE_PROFILE.userId,
    display_name: LINE_PROFILE.displayName || ""
  };
} else {
  // âœ… æœ€å°ä¿®æ­£ï¼šç”¨ payfail/payreturn å¸¶å›ä¾†çš„ user_idï¼ˆæˆ– localStorageï¼‰ç•¶å‚™æ´
  let uid = (typeof lineUserIdFromPay === "string" ? lineUserIdFromPay : "") || "";
  uid = String(uid).trim();

  if (!uid) {
    try { uid = String(localStorage.getItem("murain_line_user_id") || "").trim(); } catch (e) {}
  }

  // display_name æ²’æ‹¿åˆ°ä¹Ÿæ²’é—œä¿‚ï¼Œçµ¦ç©ºå­—ä¸²å³å¯
  const dn =
    (MEMBER_INFO && (MEMBER_INFO.display_name || MEMBER_INFO.name || MEMBER_INFO.member?.name)) || "";

  if (uid) {
    shipping_info.line = { user_id: uid, display_name: String(dn || "") };
  }
}

  if (!shipping_info.line || !shipping_info.line.user_id) {
    alert('è«‹å…ˆåœ¨ LINE å®˜æ–¹å¸³è™Ÿä¸­é–‹å•Ÿé€™å€‹çµå¸³é ï¼Œå®Œæˆ LINE æœƒå“¡ç¶å®šå¾Œå†é€å‡ºè¨‚å–®');
    return;
  }

 let payment_method = '';
  let ship = null;

  const activeTab = [...tabs].find(t=>t.classList.contains('active'))?.dataset.pay || 'COD';

  // ===== CODï¼šè²¨åˆ° / é¢äº¤ =====
  if (activeTab === 'COD') {
    const codType = (document.querySelector('input[name="codType"]:checked')?.value || '711');

    const name  = $('#cod_name').value;
    const phone = $('#cod_phone').value;
    const emailCod = ($('#cod_email').value || '').trim();

    if (![name, phone, emailCod].every(required)) {
      alert('è«‹å¡«å®Œå§“åã€é›»è©±èˆ‡ Email');
      return;
    }

    if (codType === '711') {
      const id    = $('#cod_store_id').value;
      const sname = $('#cod_store_name').value;
      const addr  = $('#cod_store_addr').value;

      if (![id, sname, addr].every(required)) {
        alert('è«‹å¡«å®Œ 7-11 è²¨åˆ°ä»˜æ¬¾çš„é–€å¸‚è³‡æ–™');
        return;
      }

      // âœ… 7-11 è²¨åˆ°ä»˜æ¬¾ï¼šåŒæ„æ¢æ¬¾ï¼ˆè­‰æ“šé»å¯«å…¥è¨‚å–®ï¼‰
const codAgreeEl = document.getElementById('cod711_agree');
if (!codAgreeEl || !codAgreeEl.checked) {
  alert('è«‹å…ˆå‹¾é¸åŒæ„ï¼š7-11 è²¨åˆ°ä»˜æ¬¾å–è²¨æé†’ï¼Œæ‰èƒ½é€å‡ºè¨‚å–®ã€‚');
  return;
}

shipping_info.cod711_agree = true;
shipping_info.cod711_agree_text =
  "7-11 è²¨åˆ°ä»˜æ¬¾è«‹å‹™å¿…å–è²¨ï¼Œè‹¥æ£„æ¨™/æ‹’æ”¶å¯èƒ½é™åˆ¶å¾ŒçºŒä¸‹å–®æˆ–è²¨åˆ°ä»˜æ¬¾æ¬Šé™ã€‚";
shipping_info.cod711_agree_at = new Date().toISOString();

      // ä¿æŒåŸæœ¬çš„ payment_methodï¼Œé¿å…å¾Œç«¯å£æ‰
      payment_method = 'cod_711';
      ship = {
        type: '711',
        name,
        phone,
        email: emailCod,
        store: { id, name: sname, addr }
      };
      
    } else if (codType === 'meetup') {
      // æ–°å¢ï¼šé¢äº¤ç¾é‡‘
      const mi = getMeetupInfo('cod');
      if (!mi) return;

      payment_method = 'meetup_cash';
      ship = {
        type: 'meetup',
        name,
        phone,
        email: emailCod,
        meetup_place: mi.meetup_place,
        meetup_time: mi.meetup_time
      };
    }

  }

  // ===== PAID =====
  if (activeTab === 'PAID') {
    const channel     = $('#paid_channel').value;
    const shipMethod = $('#paid_ship_method').value;

    if (channel === 'card_once') {
  payment_method = 'paid_card_once';
} else if (channel === 'card_inst') {
  const n = String($('#inst_months').value || '3').trim();
  payment_method = `paid_card_inst_${n}`;
} else if (channel === 'linepay') {
  payment_method = 'paid_linepay';
} else if (channel === 'af') {
  // ä½ ä¹‹å‰èªª AFTEE è¦ç”¨ aftee_direct çš„ mode
  payment_method = 'paid_aftee_direct'; // AFTEE å…ˆäº«å¾Œä»˜ï¼ˆPayUNI Mode: aftee_directï¼‰
} else {
  payment_method = '';
}

    if (shipMethod === '711') {
      const name  = $('#ship_name_paid').value;
      const phone = $('#ship_phone_paid').value;
      const id    = $('#ship_store_id_paid').value;
      const sname = $('#ship_store_name_paid').value;
      const addr  = $('#ship_store_addr_paid').value;
      const emailPaid = ($('#paid_email').value || '').trim();

      if (![name, phone, id, sname, addr, emailPaid].every(required)) {
        alert('è«‹å¡«å®Œ 7-11 æ”¶ä»¶è³‡æ–™ï¼ˆå« Emailï¼‰');
        return;
      }

      ship = {
        type: '711',
        name,
        phone,
        email: emailPaid,
        store: { id, name: sname, addr }
      };
    } else if (shipMethod === 'post') {
      const name  = $('#paid_post_name').value;
      const phone = $('#paid_post_phone').value;
      const zip   = $('#paid_post_zip').value;
      const addr  = $('#paid_post_addr').value;
      const emailPost = ($('#paid_post_email').value || '').trim();

      if (![name, phone, addr, emailPost].every(required)) {
        alert('è«‹å¡«å®Œéƒµå¯„è³‡æ–™ï¼ˆå« Emailï¼‰');
        return;
      }

      ship = {
        type: 'post',
        name,
        phone,
        email: emailPost,
        post: { zip, addr }
      };
      
      
    } else if (shipMethod === 'meetup') {
  const name  = $('#paid_meet_name').value;
  const phone = $('#paid_meet_phone').value;
  const emailMeet = ($('#paid_meet_email').value || '').trim();

  if (![name, phone, emailMeet].every(required)) {
    alert('è«‹å¡«å®Œé¢äº¤è¯çµ¡è³‡æ–™ï¼ˆå« Emailï¼‰');
    return;
  }

  const mi = getMeetupInfo('paid');
  if (!mi) return;

  ship = {
    type: 'meetup',
    name,
    phone,
    email: emailMeet,

    // âœ… å»ºè­°åŒæ™‚é€å…©å¥— keyï¼Œé¿å…ä½ å¾Œç«¯/èˆŠç‰ˆè®€ä¸åŒæ¬„ä½è€Œé¡¯ç¤ºä¸åˆ°
    meet_place: mi.meetup_place,
    meet_time: mi.meetup_time,
    meetup_place: mi.meetup_place,
    meetup_time: mi.meetup_time
  };
} else {

      alert('è«‹å…ˆé¸æ“‡å–è²¨æ–¹å¼');
      return;
    }
  }
// ===== DEPOSITï¼šATM åŒ¯æ¬¾ï¼ˆå…¨é¡ï¼‰/ åŒ¯æ¬¾å®šé‡‘ï¼ˆä¿ç•™ï¼‰=====
  if (activeTab === 'DEPOSIT') {

    const depType = (document.querySelector('input[name="depType"]:checked')?.value || 'new_full');

    // --- åŒ¯æ¬¾å®šé‡‘ï¼ˆä¿ç•™ï¼‰ ---
    if (depType === 'old') {

      // âœ… å¾Œç«¯æ˜ç¢ºæœ‰é‡å° deposit_old åšè¦å‰‡ï¼ˆä¸å¯ç”¨è³¼ç‰©é‡‘ / ä¸é–‹æ”¾é¢äº¤ï¼‰
      payment_method = 'deposit_old';

      // âœ… å®šé‡‘ï¼šå¿…é ˆå‹¾é¸åŒæ„ï¼ˆè­‰æ“šé»ï¼‰
const agreeEl = document.getElementById('dep_old_agree');
if (!agreeEl || !agreeEl.checked) {
  alert('é€å‡ºå‰è«‹å‹¾é¸åŒæ„ï¼šé€¾æœŸè¦–åŒæ£„æ¨™ï¼Œå®šé‡‘ä¸é€€é‚„ã€‚');
  return;
}

      shipping_info.deposit_agree = true;
shipping_info.deposit_agree_text = "é€¾æœŸè¦–åŒæ£„æ¨™ï¼Œå®šé‡‘ä¸é€€é‚„ã€‚";
shipping_info.deposit_agree_at = new Date().toISOString();

      // âœ… å‰ç«¯å…ˆæ“‹ï¼Œé¿å…é€å‡ºå»æ‰è¢«å¾Œç«¯æ‰“å›ä¾†
      if (creditUsed > 0) {
        alert('åŒ¯æ¬¾å®šé‡‘ï¼ˆä¿ç•™ï¼‰ä¸å¯ä½¿ç”¨è³¼ç‰©é‡‘ï¼Œè«‹å°‡è³¼ç‰©é‡‘æŠ˜æŠµæ”¹ç‚º 0 æˆ–ç•™ç©ºã€‚');
        return;
      }

      const shipMethod = ($('#dep_old_method')?.value || '711');

      const name  = ($('#dep_old_name')?.value || '').trim();
      const phone = ($('#dep_old_phone')?.value || '').trim();
      const email = ($('#dep_old_email')?.value || '').trim();

      const last5     = ($('#dep_old_last5')?.value || '').trim();
      const holdUntil = ($('#dep_old_hold_until')?.value || '').trim();
      const amtRaw    = ($('#dep_old_amount')?.value || '').trim();

      if (![name, phone, email, last5].every(required)) {
        alert('è«‹å¡«å®ŒåŒ¯æ¬¾å®šé‡‘çš„å§“åã€é›»è©±ã€Emailã€å¸³è™Ÿå¾Œäº”ç¢¼');
        return;
      }
      if (!holdUntil) {
        alert('è«‹é¸æ“‡ä¿ç•™åˆ°æœŸæ—¥');
        return;
      }

      // å®šé‡‘é‡‘é¡å¯ç•™ç©ºï¼›æœ‰å¡«å°±å¿…é ˆæ˜¯ >=0 æ•¸å­—
      let depAmount = 0;
      if (amtRaw) {
        depAmount = Number(amtRaw);
        if (!Number.isFinite(depAmount) || depAmount < 0) {
          alert('å®šé‡‘é‡‘é¡è«‹å¡« 0 ä»¥ä¸Šçš„æ•¸å­—ï¼ˆå¯ç•™ç©ºï¼‰');
          return;
        }
      }

      if (shipMethod === '711') {
        const id    = ($('#dep_old_store_id')?.value || '').trim();
        const sname = ($('#dep_old_store_name')?.value || '').trim();
        const addr  = ($('#dep_old_store_addr')?.value || '').trim();

        if (![id, sname, addr].every(required)) {
          alert('è«‹å¡«å®ŒåŒ¯æ¬¾å®šé‡‘çš„ 7-11 é–€å¸‚è³‡æ–™');
          return;
        }

        ship = {
          type: '711',
          name, phone, email,
          store: { id, name: sname, addr },
          deposit: {
            type: 'old',
            last5,
            amount: depAmount,
            hold_until: holdUntil
          }
        };

      } else if (shipMethod === 'post') {
        const zip  = ($('#dep_old_post_zip')?.value || '').trim();
        const addr = ($('#dep_old_post_addr')?.value || '').trim();

        if (![addr].every(required)) {
          alert('è«‹å¡«å®ŒåŒ¯æ¬¾å®šé‡‘çš„éƒµå¯„åœ°å€');
          return;
        }

        ship = {
          type: 'post',
          name, phone, email,
          post: { zip, addr },
          deposit: {
            type: 'old',
            last5,
            amount: depAmount,
            hold_until: holdUntil
          }
        };

      } else {
        alert('è«‹é¸æ“‡å–è²¨æ–¹å¼');
        return;
      }
    }

    // --- åŒ¯æ¬¾å…¨é¡ ---
    else {

      // âœ… è®“å¾Œç«¯ isDepositOnly åˆ¤æ–·ç‚ºã€Œéå®šé‡‘ã€ï¼Œå¯ä½¿ç”¨è³¼ç‰©é‡‘ï¼ˆç¬¦åˆä½ ç¾åœ¨å¾Œç«¯è¨­è¨ˆï¼‰
      payment_method = 'deposit_new_full';

      const shipMethod = ($('#dep_new_full_method')?.value || '711');

      const name0  = ($('#dep_new_full_name')?.value || '').trim();
      const phone0 = ($('#dep_new_full_phone')?.value || '').trim();
      const email0 = ($('#dep_new_full_email')?.value || '').trim();
      const last5  = ($('#dep_new_full_last5')?.value || '').trim();

      if (![name0, phone0, email0, last5].every(required)) {
        alert('è«‹å¡«å®ŒåŒ¯æ¬¾å…¨é¡çš„å§“åã€é›»è©±ã€Emailã€å¸³è™Ÿå¾Œäº”ç¢¼');
        return;
      }

      if (shipMethod === '711') {
        const id    = ($('#dep_new_full_store_id')?.value || '').trim();
        const sname = ($('#dep_new_full_store_name')?.value || '').trim();
        const addr  = ($('#dep_new_full_store_addr')?.value || '').trim();

        if (![id, sname, addr].every(required)) {
          alert('è«‹å¡«å®ŒåŒ¯æ¬¾å…¨é¡çš„ 7-11 é–€å¸‚è³‡æ–™');
          return;
        }

        ship = {
          type: '711',
          name: name0,
          phone: phone0,
          email: email0,
          store: { id, name: sname, addr },
          deposit: { type: 'new_full', last5 }
        };

      } else if (shipMethod === 'post') {
        const zip  = ($('#dep_new_full_post_zip')?.value || '').trim();
        const addr = ($('#dep_new_full_post_addr')?.value || '').trim();

        if (![addr].every(required)) {
          alert('è«‹å¡«å®ŒåŒ¯æ¬¾å…¨é¡çš„éƒµå¯„åœ°å€');
          return;
        }

        ship = {
          type: 'post',
          name: name0,
          phone: phone0,
          email: email0,
          post: { zip, addr },
          deposit: { type: 'new_full', last5 }
        };

      } else if (shipMethod === 'meetup') {

        // ä½ çš„é¢äº¤æ—¥æœŸ/æ™‚é–“å‰ç¶´æ˜¯ depnew_
        const mi = getMeetupInfo('depnew');
        if (!mi) return;

        // meetup æ¬„ä½æœ‰å¡«å°±ç”¨ï¼Œæ²’å¡«å°±æ²¿ç”¨ä¸Šé¢çš„å§“åé›»è©±email
        const name  = ($('#dep_new_full_meet_name')?.value || name0).trim();
        const phone = ($('#dep_new_full_meet_phone')?.value || phone0).trim();
        const email = ($('#dep_new_full_meet_email')?.value || email0).trim();

        if (![name, phone, email].every(required)) {
          alert('è«‹å¡«å®ŒåŒ¯æ¬¾å…¨é¡é¢äº¤è¯çµ¡è³‡æ–™ï¼ˆå« Emailï¼‰');
          return;
        }

        ship = {
          type: 'meetup',
          name, phone, email,
          meet_place: mi.meetup_place,
          meet_time: mi.meetup_time,
          meetup_place: mi.meetup_place,
          meetup_time: mi.meetup_time,
          deposit: { type: 'new_full', last5 }
        };

      } else {
        alert('è«‹é¸æ“‡å–è²¨æ–¹å¼');
        return;
      }
    }
  }
  // ===== ZEROCARDï¼šç„¡å¡åˆ†æœŸ =====
if (activeTab === 'ZEROCARD') {

  const months = $('#zc_months').value;
  payment_method = `zero_card_${months}`;

  const shipMethod = $('#zc_ship_method').value;

  if (shipMethod === '711') {
    const name  = $('#ship_name_zc').value;
    const phone = $('#ship_phone_zc').value;
    const email = ($('#zc_email').value || '').trim();
    const id    = $('#ship_store_id_zc').value;
    const sname = $('#ship_store_name_zc').value;
    const addr  = $('#ship_store_addr_zc').value;

    if (![name, phone, email, id, sname, addr].every(required)) {
      alert('è«‹å¡«å®Œç„¡å¡åˆ†æœŸ 7-11 æ”¶ä»¶è³‡æ–™');
      return;
    }

    ship = {
      type: '711',
      name,
      phone,
      email,
      store: { id, name: sname, addr }
    };

  } else if (shipMethod === 'post') {

    const name  = $('#zc_post_name').value;
    const phone = $('#zc_post_phone').value;
    const email = ($('#zc_post_email').value || '').trim();
    const zip   = $('#zc_post_zip').value;
    const addr  = $('#zc_post_addr').value;

    if (![name, phone, email, addr].every(required)) {
      alert('è«‹å¡«å®Œç„¡å¡åˆ†æœŸ éƒµå¯„è³‡æ–™');
      return;
    }

    ship = {
      type: 'post',
      name,
      phone,
      email,
      post: { zip, addr }
    };

  } else if (shipMethod === 'meetup') {

    const name  = $('#zc_meet_name').value;
    const phone = $('#zc_meet_phone').value;
    const email = ($('#zc_meet_email').value || '').trim();

    if (![name, phone, email].every(required)) {
      alert('è«‹å¡«å®Œç„¡å¡åˆ†æœŸ é¢äº¤è¯çµ¡è³‡æ–™');
      return;
    }

    const mi = getMeetupInfo('zc');
    if (!mi) return;

    ship = {
      type: 'meetup',
      name,
      phone,
      email,

      // åŒæ™‚çµ¦å…©å¥— keyï¼Œé¿å…å¾Œç«¯æˆ–å¡ç‰‡è®€ä¸åˆ°
      meet_place: mi.meetup_place,
      meet_time: mi.meetup_time,
      meetup_place: mi.meetup_place,
      meetup_time: mi.meetup_time
    };

  } else {
    alert('è«‹é¸æ“‡å–è²¨æ–¹å¼');
    return;
  }
}

  // ===== YUFUï¼šè£•å¯Œåˆ†æœŸï¼ˆæ–°å¢ï¼‰ =====
if (activeTab === 'YUFU') {

  const months = $('#yufu_months').value;
  payment_method = `yufu_inst_${months}`;

  const shipMethod = $('#yufu_ship_method').value;

  if (shipMethod === '711') {
    const name  = $('#ship_name_yufu').value;
    const phone = $('#ship_phone_yufu').value;
    const email = ($('#yufu_email').value || '').trim();
    const id    = $('#ship_store_id_yufu').value;
    const sname = $('#ship_store_name_yufu').value;
    const addr  = $('#ship_store_addr_yufu').value;

    if (![name, phone, email, id, sname, addr].every(required)) {
      alert('è«‹å¡«å®Œè£•å¯Œåˆ†æœŸ 7-11 æ”¶ä»¶è³‡æ–™');
      return;
    }

    ship = { type:'711', name, phone, email, store:{ id, name:sname, addr } };

  } else if (shipMethod === 'post') {

    const name  = $('#yufu_post_name').value;
    const phone = $('#yufu_post_phone').value;
    const email = ($('#yufu_post_email').value || '').trim();
    const zip   = $('#yufu_post_zip').value;
    const addr  = $('#yufu_post_addr').value;

    if (![name, phone, email, addr].every(required)) {
      alert('è«‹å¡«å®Œè£•å¯Œåˆ†æœŸ éƒµå¯„è³‡æ–™');
      return;
    }

    ship = { type:'post', name, phone, email, post:{ zip, addr } };

  } else if (shipMethod === 'meetup') {

    const name  = $('#yufu_meet_name').value;
    const phone = $('#yufu_meet_phone').value;
    const email = ($('#yufu_meet_email').value || '').trim();

    if (![name, phone, email].every(required)) {
      alert('è«‹å¡«å®Œè£•å¯Œåˆ†æœŸ é¢äº¤è¯çµ¡è³‡æ–™');
      return;
    }

    const mi = getMeetupInfo('yufu');
    if (!mi) return;

    ship = {
      type:'meetup',
      name, phone, email,
      meet_place: mi.meetup_place,
      meet_time: mi.meetup_time,
      meetup_place: mi.meetup_place,
      meetup_time: mi.meetup_time
    };

  } else {
    alert('è«‹é¸æ“‡å–è²¨æ–¹å¼');
    return;
  }

  // ç”³è«‹è³‡æ–™ï¼ˆå¿…å¡«ï¼‰
  const aName  = ($('#yufu_apply_name').value || '').trim();
  const aId    = ($('#yufu_apply_id').value || '').trim();
  const aPhone = ($('#yufu_apply_phone').value || '').trim();
  const aEmail = ($('#yufu_apply_email').value || '').trim();
  // âœ… æ–°å¢ï¼šé›»è©±æ˜¯å¦æœ¬äººåä¸‹ + æ›è™Ÿåœ°å€ï¼ˆæ¢ä»¶ï¼‰
const phoneOwner = (document.querySelector('input[name="yufu_phone_owner"]:checked')?.value || 'yes');

const paperName = ($('#yufu_paper_name')?.value || '').trim();
const paperPhone = ($('#yufu_paper_phone')?.value || '').trim();
const paperZip = ($('#yufu_paper_zip')?.value || '').trim();
const paperAddr = ($('#yufu_paper_addr')?.value || '').trim();

if (phoneOwner === 'no') {
  if (![paperName, paperPhone, paperAddr].every(required)) {
    alert('é›»è©±éæœ¬äººåä¸‹æ™‚ï¼Œè«‹å¡«å¯«æ›è™Ÿå¯„é€åœ°å€ï¼ˆæ”¶ä»¶äººå§“åã€æ›è™Ÿåœ°å€ï¼‰ã€‚');
    return;
  }
}

  const agree1 = !!document.getElementById('yufu_agree_privacy')?.checked;
  const agree2 = !!document.getElementById('yufu_agree_rate')?.checked;

  if (![aName, aId, aPhone, aEmail].every(required)) {
    alert('è«‹å¡«å®Œè£•å¯Œåˆ†æœŸç”³è«‹è³‡æ–™ï¼ˆå§“å/èº«åˆ†è­‰/æœ¬äººé–€è™Ÿ/Emailï¼‰');
    return;
  }
  if (!agree1 || !agree2) {
    alert('è«‹å‹¾é¸åŒæ„äº‹é …å¾Œå†é€å‡º');
    return;
  }

  // å¯«å…¥å¾Œç«¯è¦çœ‹çš„ç´”æ–‡å­—ï¼ˆä½ å·²æ–°å¢ installment_apply_text æ¬„ä½ï¼‰
  const m = Number(months || 0);
  const rate = Number(YUFU_RATE_TABLE?.[m] ?? 0);
  const base = Math.max(0, Math.round((subtotal || 0) - (Number(shipping_info?.credit_used || creditUsed || 0) || 0)));
  const total = Math.max(0, Math.round(base * (1 + rate/100)));
  const perMon = m ? Math.ceil(total / m) : 0;

  shipping_info.installment_apply_text =
`ã€è£•å¯Œåˆ†æœŸç”³è«‹è³‡æ–™ã€‘
æœŸæ•¸ï¼š${m} æœŸ
è©¦ç®—ï¼š${money(perMon)} x ${m}ï¼ˆåˆ©ç‡ç´„ ${rate}%ï¼›ä»¥æŠ˜æŠµå¾Œé‡‘é¡ ${money(base)} è©¦ç®—ï¼Œå¯¦éš›ä»¥è£•å¯Œç°¡è¨Šç‚ºæº–ï¼‰
å§“åï¼š${aName}
èº«åˆ†è­‰ï¼š${aId}
æœ¬äººé–€è™Ÿï¼š${aPhone}
Emailï¼š${aEmail}
é›»è©±æ˜¯å¦æœ¬äººåä¸‹ï¼š${phoneOwner === 'yes' ? 'æ˜¯' : 'å¦'}
${phoneOwner === 'no' ? `æ›è™Ÿå¯„é€ï¼š${paperName}ï¼Œ${paperPhone ? paperPhone + 'ï¼Œ' : ''}${paperZip ? paperZip + 'ï¼Œ' : ''}${paperAddr}` : ''}`;

  // ä¹Ÿä¸€èµ·å­˜çµæ§‹åŒ–ï¼ˆæœªä¾†ä½ è‹¥è¦åš InstallmentApplications è¡¨æœƒæ›´å¥½æ¥ï¼‰
  shipping_info.installment_apply = {
  provider: 'yufu',
  months: m,
  rate_percent: rate,
  base_amount: base,
  monthly_est: perMon,
  applicant: {
    name: aName,
    id: aId,
    phone: aPhone,
    email: aEmail,
    phone_owner: phoneOwner
  },
  paper_addr: (phoneOwner === 'no')
    ? { name: paperName, phone: paperPhone, zip: paperZip, addr: paperAddr }
    : null
};

  if(!payment_method || !ship){
    alert('è«‹å…ˆé¸æ“‡ä»˜æ¬¾æ–¹å¼ï¼Œä¸¦å¡«å®Œå¿…è¦æ¬„ä½');
    return;
  }

  shipping_info.ship = ship;

  try{
    $('#submitBtn').disabled = true;

    console.log('[CHECKOUT] payment_method=', payment_method);

    const payload = { cart_token: cartToken, payment_method, shipping_info };
    console.log("[CHECKOUT payload]", JSON.stringify(payload, null, 2));
console.log("[CHECKOUT credit]", { AVAILABLE_CREDIT, CREDIT_USED, input: document.getElementById("credit_input")?.value });

    const r = await fetch(`${API}/checkout`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await r.json();
if (!r.ok || !j.ok) {
  const msg = j.message || j.error || 'é€å‡ºå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡';
  throw new Error(msg);
}

// âœ… æ”¿ç­–1ï¼šå»ºå–®å¾Œé–å®šè³¼ç‰©é‡‘ï¼ˆå¾Œç«¯è‹¥å› locked/reusedï¼Œå°±ä»¥å‰ç«¯é¡¯ç¤ºä¹Ÿé–ï¼‰
const serverCreditUsed = Math.max(0, Math.floor(Number(j.credit_used ?? shipping_info?.credit_used ?? 0) || 0));
const serverNetAmount  = Math.max(0, Math.round(Number(j.net_amount ?? (subtotal - serverCreditUsed)) || 0));

// è®“å¾Œé¢é¡¯ç¤º / result é é‡‘é¡ç”¨ã€Œå¾Œç«¯ç®—å¥½çš„ã€é¿å…ä¸ä¸€è‡´
const payTotal = serverNetAmount;

// âœ… è‹¥å¾Œç«¯è¡¨ç¤ºé€™ç­†æ˜¯æ²¿ç”¨/é–å®šï¼Œå°±æŠŠè³¼ç‰©é‡‘ UI é–ä½
if (j.locked || j.reused) {
  // 1) åŒæ­¥å› shipping_infoï¼ˆé¿å…ä½ å¾Œé¢åˆç”¨èˆŠå€¼ç®—ï¼‰
  if (shipping_info && typeof shipping_info === "object") {
    shipping_info.credit_used = serverCreditUsed;
  }

  // 2) é– UIï¼ˆä¸‹é¢ç¬¬2é»æˆ‘çµ¦ä½  helperï¼‰
  lockCreditUI(serverCreditUsed, j.order_id);
}

// âœ… æ³¨æ„ï¼šç·šä¸Šæ”¯ä»˜ / é›¶å¡ã€Œä¸è¦å…ˆæ¸…æ‰ cart_tokenã€
// ä¸ç„¶ payuni/start æˆ– zero-card/start å¤±æ•—æ™‚ï¼Œå®¢äººå›ä¸å»é‡è©¦

// ===== ç·šä¸Š/é›¢ç·šåˆ¤æ–· =====
const isZeroCard  = String(payment_method || "").startsWith("zero_card_");
const isPaid      = String(payment_method || "").startsWith("paid_");
const isOnlinePay = isPaid || isZeroCard;

// âœ… ç·šä¸Šä»˜æ¬¾ / é›¶å¡ï¼šå…ˆè¨˜éŒ„ pendingï¼ˆè‹¥ä½ æœ‰é€™å€‹ helper å°±ç”¨ï¼Œæ²’æœ‰ä¹Ÿä¸æœƒç‚¸ï¼‰
if (isOnlinePay) {
  try {
    if (typeof markCartPendingPay === "function") {
      markCartPendingPay(cartToken, j.order_id, payment_method);
    }
  } catch (e) {}
}

// âœ… 1) PayUniï¼ˆç·šä¸Šä»˜æ¬¾ï¼‰â€” å¿…é ˆåœ¨é›¢ç·šåˆ†æ”¯å¤–
if (isPaid) {
  try {
    const payMode =
      (payment_method === "paid_aftee_direct") ? "upp" :
      (payment_method === "paid_linepay")      ? "upp" :
      (payment_method.startsWith("paid_card_inst_")) ? "card_inst" :
      "card_once";

    const instMonths = payment_method.startsWith("paid_card_inst_")
      ? Number(payment_method.split("_").pop() || 3)
      : null;

    const pr = await fetch(`${API}/payuni/start`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        order_id: j.order_id,
        mode: payMode,
        inst_months: instMonths
      })
    });

    const up = await pr.json().catch(() => ({}));

    if (!pr.ok || !up.ok) {
      alert("ç·šä¸Šåˆ·å¡å•Ÿå‹•å¤±æ•—ï¼š" + (up.error || up.message || "è«‹ç¨å¾Œå†è©¦"));
      return;
    }

    // âœ… ç”¨ POST form è·³è½‰ PayUni
    const f = document.createElement("form");
    f.method = "POST";
    f.action = up.url;

    ["MerID", "Version", "EncryptInfo", "HashInfo"].forEach(k => {
      const input = document.createElement("input");
      input.type  = "hidden";
      input.name  = k;
      input.value = up[k] || "";
      f.appendChild(input);
    });

    document.body.appendChild(f);
    f.submit();
    return; // âœ… ç·šä¸Šä¸€å®šè¦ returnï¼Œé¿å…è·‘åˆ°é›¢ç·šæ¸… token / result
  } catch (e) {
    console.error("payuni error", e);
    alert("ç·šä¸Šåˆ·å¡å•Ÿå‹•å¤±æ•—ï¼ˆç¶²è·¯æˆ–ç¨‹å¼éŒ¯èª¤ï¼‰");
    return;
  }
}

// âœ… 2) ZeroCard â€” å¿…é ˆåœ¨é›¢ç·šåˆ†æ”¯å¤–
if (isZeroCard) {
  try {
    const zr = await fetch(`${API}/zero-card/start`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ order_id: j.order_id })
    });

    const z = await zr.json().catch(() => ({}));

    if (!zr.ok || !z.ok) {
      alert("ä¸­ç§Ÿç„¡å¡å•Ÿå‹•å¤±æ•—ï¼š" + (z.error || z.message || "è«‹ç¨å¾Œå†è©¦"));
      return;
    }

    location.href = z.payment_url;
    return; // âœ… é›¶å¡ä¹Ÿä¸€å®šè¦ return
  } catch (e) {
    console.error("zero-card error", e);
    alert("ä¸­ç§Ÿç„¡å¡å•Ÿå‹•å¤±æ•—ï¼ˆç¶²è·¯æˆ–ç¨‹å¼éŒ¯èª¤ï¼‰");
    return;
  }
}

// âœ… 3) åªæœ‰é›¢ç·šæ‰åšï¼šæ¸… pendingã€é– cartã€æ¸… tokenã€å° result
if (!isOnlinePay) {
  try {
    if (typeof clearPendingPay === "function") clearPendingPay(cartToken);
  } catch (e) {}

  // âœ… ç”¨å¾Œç«¯ net_amount å„ªå…ˆï¼Œé¿å…å‰å¾Œç«¯é‡‘é¡ä¸ä¸€è‡´
  const serverCreditUsed = Math.max(0, Math.floor(Number(j.credit_used ?? shipping_info?.credit_used ?? 0) || 0));
  const serverNetAmount  = Math.max(0, Math.round(Number(j.net_amount ?? (subtotal - serverCreditUsed)) || 0));

  try {
    if (typeof markCartCheckedOut === "function") {
      markCartCheckedOut(cartToken, j.order_id, serverNetAmount);
    }
  } catch (e) {}

  try { if (typeof clearCheckoutState === "function") clearCheckoutState(); } catch (e) {}

  // æ¸… storageï¼ˆé¿å…æ‰“é–‹åˆè®€åˆ°èˆŠ cartï¼‰
  try { localStorage.removeItem("MURAIN_WEB_CART_TOKEN"); } catch (e) {}
  try { localStorage.removeItem("murain_cart_token"); } catch (e) {}
  try { sessionStorage.removeItem("MURAIN_WEB_CART_TOKEN"); } catch (e) {}
  try { sessionStorage.removeItem("murain_cart_token"); } catch (e) {}

  // æ¸… URL åƒæ•¸ cart_tokenï¼ˆé¿å…è¿”å›/é‡æ•´åˆå›åˆ°èˆŠè»Šï¼‰
  try {
    const u = new URL(location.href);
    u.searchParams.delete("cart_token");
    history.replaceState(null, "", u.toString());
  } catch (e) {}

  // åŒé è®Šæ•¸ä¹Ÿæ¸…ç©º
  cartToken = "";
}

// âœ… æœ€å¾Œï¼šåªæœ‰é›¢ç·šæ‰æœƒèµ°åˆ°é€™è£¡ï¼ˆç·šä¸Šéƒ½å·² returnï¼‰
const finalTotal = Number.isFinite(Number(j.net_amount))
  ? Number(j.net_amount)
  : Math.max(subtotal - (Number(shipping_info?.credit_used || 0) || 0), 0);

const url = `/order-result.html?order_id=${encodeURIComponent(j.order_id)}&total=${encodeURIComponent(finalTotal)}`;

try {
  location.href = url;
} catch (e) {
  alert(`ä¸‹å–®æˆåŠŸï¼è¨‚å–®ç·¨è™Ÿï¼š${j.order_id}`);
}

} catch (e) {
  console.error(e);
  alert(e.message || "é€å‡ºå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡");
} finally {
  try { $("#submitBtn").disabled = false; } catch (e) {}
}
}
// ===============================
// âœ… copyToClipboard + ç¶å®šã€Œè¤‡è£½åŒ¯æ¬¾å¸³è™Ÿã€æŒ‰éˆ•
// ===============================
async function copyToClipboard(text) {
  const t = String(text || "").trim();
  if (!t) return false;

  try {
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(t);
      return true;
    }
  } catch (e) {}

  // fallbackï¼ˆLINE å…§å»ºç€è¦½å™¨/éƒ¨åˆ†æ‰‹æ©Ÿæ›´ç©©ï¼‰
  try {
    const ta = document.createElement("textarea");
    ta.value = t;
    ta.setAttribute("readonly", "");
    ta.style.position = "fixed";
    ta.style.opacity = "0";
    document.body.appendChild(ta);
    ta.select();
    ta.setSelectionRange(0, ta.value.length);
    const ok = document.execCommand("copy");
    document.body.removeChild(ta);
    return ok;
  } catch (e) {
    return false;
  }
}

(function bindCopyBankAccount() {
  const btn = document.getElementById("copyBankAccount");
  const el  = document.getElementById("bankAccount");
  if (!btn || !el) return;

  btn.addEventListener("click", async () => {
    const raw = el.textContent || el.value || "";
    const ok = await copyToClipboard(raw);

    const old = btn.textContent;
    btn.textContent = ok ? "å·²è¤‡è£½ âœ“" : "è¤‡è£½å¤±æ•—";
    setTimeout(() => (btn.textContent = old), 1200);
  });
})();

// ===== é é¢åˆå§‹åŒ– =====
(async () => {
  if (!cartToken) {
  restoreCheckoutState();
}

  // âœ… å…ˆæ“‹ï¼šå·²çµå–®å°±ä¸å¿…å†åšä»»ä½•äº‹
  if (cartToken && guardAlreadyCheckedOut(cartToken)) return;

  // âœ… 7-11 åœ°åœ–å›å¡«ï¼ˆè¦åœ¨ loadCart å‰ï¼‰
  applyStoreFromURL();

  // âœ…ã€ä¿®æ­£ã€‘7-11 å›ä¾†å¾Œè£œå›è³¼ç‰©é‡‘è¼¸å…¥
try {
  const savedCredit = sessionStorage.getItem('murain_credit_used');
  if (savedCredit !== null) {
    const creditInput = document.getElementById('credit_input'); // âœ… æ­£ç¢º id
    if (creditInput) {
      creditInput.value = savedCredit;
      creditInput.dispatchEvent(new Event('input', { bubbles:true }));
    }
  }
} catch(e) {}

  // âœ… pending pay é˜²é‡è¤‡ï¼ˆå¦‚æœä½ æœ‰å¯«é€™å€‹ async guardï¼Œå°±è¦ awaitï¼‰
  if (cartToken) {
    const blocked = await guardPendingPay(cartToken);
    if (blocked) return;
  }

  // âœ… UI åˆå§‹ç‹€æ…‹å…ˆå¥—ä¸€æ¬¡ï¼ˆé¿å…ä¸€é€²ä¾†é¡¯ç¤ºéŒ¯ï¼‰
  try { updatePaidChannelBox(); } catch(e){}
  try { updatePaidShip(); } catch(e){}
  try { updateZcShip(); } catch(e){}
  try { updateYufuShip(); } catch(e){}
  try { calcYUFU(); } catch(e){}
  try { setMeetupMinDates(); } catch(e){}
  try { setupYufuPhoneOwner(); } catch(e){}

  // âœ… å†è¼‰å…¥æœƒå“¡/è³¼ç‰©è»Š
  try { await initLiffAndMember(); } catch(e){}
  try { await loadCart(); } catch(e){}
})();

 async function guardPendingPay(token){
  const info = getPendingPay(token);
  if (!info || !info.order_id) return false;

  const qs = new URLSearchParams(location.search);
  if (qs.get("force") === "1") return false;

  // âœ… åŒä¸€å€‹é é¢ session åªå…è¨±è‡ªå‹•é‡é€ä¸€æ¬¡ï¼ˆé¿å…é€£çºŒè‡ªå‹• submitï¼‰
  const onceKey = `pending_auto_once:${token}:${info.order_id}`;
  if (sessionStorage.getItem(onceKey) === "1") return false;

  // âœ… pending éä¹…å°±è¦–ç‚ºå¤±æ•ˆ
  const MAX_PENDING_MS = 2 * 60 * 60 * 1000;
  if (info.at && (Date.now() - Number(info.at) > MAX_PENDING_MS)) {
    clearPendingPay(token);
    return false;
  }

  const btn = document.getElementById("submitBtn");
  if (btn) btn.disabled = true;

  try {
    // âœ… (å»ºè­°) å…ˆè·Ÿå¾Œç«¯ç¢ºèªç‹€æ…‹ï¼Œé¿å…æœ¬æ©Ÿæ®˜ç•™é€ æˆç„¡é™çºŒä»˜
    try {
      const sr = await fetch(`${API}/order/status?order_id=${encodeURIComponent(info.order_id)}`);
      if (sr.ok) {
        const s = await sr.json();
        const st = String(s.pay_status || s.status || "").toLowerCase();
        if (["paid_ok","paid","success","cancelled","canceled","failed"].includes(st)) {
          clearPendingPay(token);
          return false;
        }
      }
    } catch(e){}

    const pm = String(info.payment_method || "");

    // 1) PayUniï¼ˆç·šä¸Šä»˜æ¬¾ï¼‰
    if (pm.startsWith("paid_")) {
      sessionStorage.setItem(onceKey, "1"); // âœ… åœ¨é€å‡ºå‰å°±å…ˆé–ä¸€æ¬¡

      const payMode =
        (pm === 'paid_aftee_direct') ? 'upp' :
        (pm === 'paid_linepay') ? 'upp' :
        (pm.startsWith('paid_card_inst_')) ? 'card_inst' :
        'card_once';

      const instMonths = pm.startsWith('paid_card_inst_')
        ? Number(pm.split('_').pop() || 3)
        : null;

      const pr = await fetch(`${API}/payuni/start`, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ order_id: info.order_id, mode: payMode, inst_months: instMonths })
      });
      const up = await pr.json();
      if (!pr.ok || !up.ok) throw new Error(up.error || up.message || 'payuni start failed');

      const f = document.createElement('form');
      f.method = 'POST';
      f.action = up.url;
      ['MerID','Version','EncryptInfo','HashInfo'].forEach(k=>{
        const i=document.createElement('input');
        i.type='hidden'; i.name=k; i.value=up[k];
        f.appendChild(i);
      });
      document.body.appendChild(f);
      f.submit();
      return true;
    }

    // âœ… å…¶ä»–ä»˜æ¬¾æ–¹å¼ä½ å¾Œé¢è¦æ¥çºŒï¼šzero_card / yufu / etc.
    // æ²’å‘½ä¸­å°±å›æ­£å¸¸æµç¨‹
    return false;

  } catch (e) {
    // âœ… å¤±æ•—æ™‚ä¸€å®šè¦è§£é–æŒ‰éˆ•ï¼Œä¸ç„¶æœƒå¡æ­»
    console.error("[guardPendingPay] resume failed:", e);
    // é€™è£¡ä¸è¦ clearPendingPayï¼Œé¿å…çœŸçš„åœ¨ã€Œè·³è½‰ä¸­ã€è¢«ä½ æ¸…æ‰
    return false;
  } finally {
    if (btn) btn.disabled = false;
  }
}
   // âœ… é˜²æ­¢ iOS/Safari ä¸Šä¸€é è¿”å›ï¼ˆBFCacheï¼‰æŒ‰éˆ•ç¶­æŒ disabled
window.addEventListener('pageshow', function () {
  const btn = document.getElementById('submitBtn');
  if (btn) btn.disabled = false;
});
   function setupYufuPhoneOwner() {
  const radios = document.querySelectorAll('input[name="yufu_phone_owner"]');
  const box  = document.getElementById('yufuPaperAddrBox');
  const hint = document.getElementById('yufuPhoneOwnerHint');

  const paperName  = document.getElementById('yufu_paper_name');
  const paperPhone = document.getElementById('yufu_paper_phone');
  const paperAddr  = document.getElementById('yufu_paper_addr');

  function apply() {
    const v = document.querySelector('input[name="yufu_phone_owner"]:checked')?.value || 'yes';
    const needPaper = (v === 'no');

    if (box)  box.hidden  = !needPaper;
    if (hint) hint.hidden = !needPaper;

    // ä½ é€å‡ºæ™‚é©—è­‰æ˜¯ï¼špaperName + paperPhone + paperAddr
    if (paperName)  paperName.required  = needPaper;
    if (paperPhone) paperPhone.required = needPaper;
    if (paperAddr)  paperAddr.required  = needPaper;
  }

  radios.forEach(r => r.addEventListener('change', apply));
  apply();
}

   // âœ… 7-11 è²¨åˆ°ä»˜æ¬¾ï¼šéœ€è¦å‹¾é¸åŒæ„æ‰å¯é€å‡º
(function setupCOD711AgreeGuard(){
  const wrap  = document.getElementById("cod711AgreeWrap");
  const agree = document.getElementById("cod711_agree");
  const btn   = document.getElementById("submitBtn");

  if (!wrap || !agree || !btn) return;

  function getCodType(){
    const r = document.querySelector('input[name="codType"]:checked');
    return r ? r.value : "";
  }

  function isPaneCODActive(){
    const pane = document.getElementById("paneCOD");
    return pane && !pane.hidden;
  }

  function refresh(){
    const cod711 = isPaneCODActive() && getCodType() === "711";
    wrap.style.display = cod711 ? "" : "none";
    if (!cod711) agree.checked = false;
  }

  document.addEventListener("change", (e) => {
    if (e.target && e.target.name === "codType") refresh();
  });

  document.addEventListener("click", (e) => {
    if (e.target && e.target.closest && e.target.closest("#payTabs")) refresh();
  });

  btn.addEventListener("click", (e) => {
    refresh();
    const need = isPaneCODActive() && getCodType() === "711";
    if (need && !agree.checked) {
      e.preventDefault();
      e.stopImmediatePropagation();
      alert("è«‹å…ˆå‹¾é¸åŒæ„ï¼š7-11 è²¨åˆ°ä»˜æ¬¾å–è²¨æé†’ï¼Œæ‰èƒ½é€å‡ºè¨‚å–®ã€‚");
    }
  }, true);

  refresh();
</script>
</body>
</html>
