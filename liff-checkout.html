<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>è³¼ç‰©è»Š â€” Cart</title>
<style>
  *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC",Roboto}
  body{margin:0;background:#0b1222;color:#e2e8f0}
  .wrap{max-width:720px;margin:0 auto;padding:16px 16px calc(env(safe-area-inset-bottom,0) + 90px)}
  h1{margin:0 0 8px;font-size:22px}
  .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.4);margin-top:12px}
  label{display:block;font-size:14px;margin:8px 2px 6px}
  input,select,textarea{width:100%;padding:14px 12px;border-radius:12px;border:1px solid rgba(148,163,184,.6);background:rgba(15,23,42,.8);color:#e2e8f0;font-size:15px}
  input:focus,select:focus,textarea:focus{outline:2px solid #38bdf8;outline-offset:1px;border-color:#38bdf8}
  textarea{min-height:80px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:720px){.row{grid-template-columns:1fr}}
  .tabs{display:grid;grid-template-columns:repeat(4,1fr);border-radius:999px;background:rgba(15,23,42,.9);padding:4px;margin:8px 0 4px}
  .tab{padding:10px 4px;text-align:center;font-size:14px;border-radius:999px;border:none;background:transparent;color:#9ca3af;cursor:pointer}
  .tab.active{background:#22d3ee;color:#0f172a;font-weight:600;box-shadow:0 8px 20px rgba(34,211,238,.25)}
  .btn{margin-top:16px;width:100%;padding:16px 14px;border-radius:999px;border:none;background:#22d3ee;color:#0f172a;font-size:16px;font-weight:600;cursor:pointer;box-shadow:0 14px 40px rgba(34,211,238,.35);position:fixed;left:0;right:0;bottom:0;max-width:720px;margin-left:auto;margin-right:auto}
  .btn:disabled{opacity:.5;cursor:not-allowed;box-shadow:none}
  .btn.secondary{position:static;width:auto;margin-top:12px;padding:10px 16px;border-radius:999px;background:transparent;color:#e5e7eb;border:1px solid rgba(148,163,184,.8);box-shadow:none;font-size:14px}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:rgba(15,23,42,.9);border:1px solid rgba(148,163,184,.7);font-size:12px;color:#cbd5f5;margin-top:4px}
  .pill span{font-weight:600;color:#f97316}
  .muted{font-size:13px;color:#94a3b8;margin-top:4px}
  .highlight{font-size:18px;font-weight:600;margin:8px 0}
  .section-title{font-size:14px;font-weight:600;color:#e5e7eb;margin-bottom:4px}
  .tag{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(34,197,94,.12);color:#bbf7d0;font-size:11px;margin-left:6px}
  .badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:999px;background:rgba(34,211,238,.1);color:#22d3ee;font-size:11px;margin-left:6px}
  .badge-dot{width:6px;height:6px;border-radius:999px;background:#22d3ee}
  .hint{font-size:12px;color:#9ca3af;margin-top:2px}
  .pill-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .text-right{text-align:right}
  .mt-4{margin-top:16px}
  .mt-2{margin-top:8px}
  .flex{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .radio-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .radio-pill{padding:7px 11px;border-radius:999px;border:1px solid rgba(148,163,184,.7);font-size:12px;color:#e5e7eb;cursor:pointer;display:inline-flex;align-items:center;gap:4px}
  .radio-pill input{width:auto;margin:0}
  .radio-pill.active{background:#22d3ee;color:#0f172a;border-color:#22d3ee}
  .label-small{font-size:12px;color:#9ca3af}
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="wrap">
  <h1>çµå¸³</h1>

  <div class="card">
    <div class="section-title">è¨‚å–®é‡‘é¡</div>
    <label>å•†å“å°è¨ˆï¼ˆNT$ï¼‰</label>
    <input id="subtotal" readonly />

    <div class="mt-4 section-title">å•†å“æ˜ç´°</div>
    <textarea id="itemsText" readonly></textarea>

    <div class="mt-4 section-title">æ‡‰ä»˜é‡‘é¡</div>
    <input id="total" readonly />

    <label class="mt-4">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
    <textarea id="note" placeholder="ä¾‹å¦‚ï¼šé€ç¦®éœ€é™„ç²¾å“æè¢‹â€¦"></textarea>
    <div class="hint">ğŸ’¡ æº«é¦¨æé†’ï¼šå¦‚ç‚ºé€ç¦®éœ€æ±‚éœ€é™„æè¢‹ï¼Œè«‹å‹™å¿…åœ¨æ­¤å¡«å¯«ã€‚</div>
</div>
    

  <div class="card">
    <div class="section-title">é¸æ“‡ä»˜æ¬¾ / å–è²¨æ–¹å¼</div>
    <div class="tabs" id="payTabs">
      <button class="tab active" data-pay="COD">7-11 è²¨åˆ°ä»˜æ¬¾</button>
      <button class="tab" data-pay="PAID">ç·šä¸Šä»˜æ¬¾</button>
      <button class="tab" data-pay="DEPOSIT">ATM åŒ¯æ¬¾</button>
      <button class="tab" data-pay="ZEROCARD">ç„¡å¡é›¶è§’</button>
    </div>
    <div class="muted">â£ï¸ ç‚ºä¿éšœäº¤æ˜“æ¬Šç›Šï¼Œã€Œè²¨åˆ°ä»˜æ¬¾ã€éœ€å®Œæˆ LINE ç¶å®š</div>

    <!-- COD: 7-11 è²¨åˆ°ä»˜æ¬¾ï¼ˆè€å®¢/ä¿¡ä»»å®¢äººï¼‰ -->
    <div id="paneCOD">
      <div class="section-title mt-4">7-11 æ”¶ä»¶è³‡æ–™</div>
      <div class="row">
        <div><label>å§“å *</label><input id="cod_name" required /></div>
        <div><label>é›»è©± *</label><input id="cod_phone" required /></div>
      </div>
      <label>Email *</label>
      <input id="cod_email" required type="email" placeholder="example@gmail.com" />
      <div class="row mt-2">
        <div><label>7-11 é–€å¸‚ä»£è™Ÿ *</label><input id="cod_store_id" required /></div>
        <div><label>7-11 é–€å¸‚åç¨± *</label><input id="cod_store_name" required /></div>
      </div>
      <label>7-11 é–€å¸‚åœ°å€ *</label>
      <input id="cod_store_addr" required />
      <button class="btn secondary" id="mapCOD">é–‹å•Ÿ 7-11 é–€å¸‚åœ°åœ–</button>
    </div>

    <!-- PAID: å¯ 7-11 æˆ– éƒµå¯„ -->
    <div id="panePAID" hidden>
      <label style="margin-top:8px">é¸æ“‡ç®¡é“</label>
      <select id="paid_channel">
        <option value="card_once">ä¿¡ç”¨å¡ ä¸€æ¬¡ä»˜ï¼ˆé›¶åˆ©ç‡ï¼‰</option>
        <option value="card_inst">ä¿¡ç”¨å¡ åˆ†æœŸï¼ˆ3/6/9 é›¶åˆ©ç‡ï¼‰</option>
        <option value="linepay">LINE Pay</option>
        <option value="af">AF å…ˆäº«å¾Œä»˜</option>
      </select>
      <div id="cardInstBox" class="mt-2">
        <label>åˆ†æœŸæœŸæ•¸</label>
        <select id="inst_months">
          <option value="3">3 æœŸï¼ˆ0 åˆ©ç‡ï¼‰</option>
          <option value="6">6 æœŸï¼ˆ0 åˆ©ç‡ï¼‰</option>
          <option value="9">9 æœŸï¼ˆ0 åˆ©ç‡ï¼‰</option>
        </select>
        <div class="hint">ï¼å¯¦éš›åˆ†æœŸé‡‘é¡èˆ‡è«‹æ¬¾ï¼Œä»¥éŠ€è¡Œåˆ·å¡å¸³å–®ç‚ºæº–ã€‚</div>
      </div>

      <div class="mt-4 section-title">å–è²¨æ–¹å¼</div>
      <select id="paid_ship_method">
        <option value="711">7-11 å–è²¨</option>
        <option value="post">éƒµå¯„ï¼ˆä¸­è¯éƒµæ”¿ï¼‰</option>
      </select>

      <!-- PAID + 7-11 -->
      <div id="paidShip711" class="mt-2">
       <div class="muted">0å…ƒåŒ…è£¹éœ€å¡«å¯«çœŸå¯¦å§“åã€‚</div>
        <div class="row">
          <div><label>å§“å *</label><input id="ship_name_paid" required /></div>
          <div><label>é›»è©± *</label><input id="ship_phone_paid" required /></div>
        </div>
        <label>Email *</label>
        <input id="paid_email" required type="email" placeholder="example@gmail.com" />
        <div class="row mt-2">
          <div><label>7-11 é–€å¸‚ä»£è™Ÿ *</label><input id="ship_store_id_paid" required /></div>
          <div><label>7-11 é–€å¸‚åç¨± *</label><input id="ship_store_name_paid" required /></div>
        </div>
        <label>7-11 é–€å¸‚åœ°å€ *</label>
        <input id="ship_store_addr_paid" required />
        <button class="btn secondary" id="mapPAID">é–‹å•Ÿ 7-11 é–€å¸‚åœ°åœ–</button>
      </div>

      <!-- PAID + éƒµå¯„ -->
      <div id="paidShipPost" class="mt-2" hidden>
       <div class="muted">ä¸­è¯éƒµæ”¿æŠ•éä¸æœƒäº‹å…ˆé›»è©±é€£çµ¡ï¼Œè«‹ç¢ºèªæœ‰äººå¯æ”¶ä»¶ã€‚</div>
        <div class="row">
          <div><label>å§“å *</label><input id="paid_post_name" required /></div>
          <div><label>é›»è©± *</label><input id="paid_post_phone" required /></div>
        </div>
        <label>Email *</label>
        <input id="paid_post_email" required type="email" placeholder="example@gmail.com" />
        <label>éƒµéå€è™Ÿ</label>
        <input id="paid_post_zip" />
        <label>æ”¶ä»¶åœ°å€ *</label>
        <input id="paid_post_addr" required placeholder="è«‹å¡«å¯«å®Œæ•´åœ°å€ï¼ˆç¸£å¸‚ã€å€ã€è·¯/è¡—ã€å··å¼„ã€æ¨“å±¤ï¼‰" />
      </div>
    </div>

    <!-- DEPOSIT: ATM åŒ¯æ¬¾ï¼ˆæ–°å®¢è¨‚é‡‘ / å°¾æ¬¾ï¼‰ -->
    <div id="paneDEPOSIT" hidden>
      <div class="section-title mt-2">åŒ¯æ¬¾è³‡è¨Š</div>
      <div class="pill-row">
        <div class="pill">éŠ€è¡Œï¼š<span>éƒµå±€ï¼ˆ700ï¼‰</span></div>
        <div class="pill">å¸³è™Ÿï¼š<span>01912890973712</span></div>
      </div>
      <div class="muted">å¯ç›´æ¥ä¸€éµè¤‡è£½å¸³è™Ÿè²¼åˆ° APPã€‚</div>

      <div class="mt-4 section-title">é¸æ“‡åŒ¯æ¬¾æ–¹å¼</div>
<div class="radio-row">
  <!-- å…ˆè®“å®¢äººçœ‹åˆ°ã€ŒåŒ¯æ¬¾å…¨é¡ã€ -->
  <label class="radio-pill">
    <input type="radio" name="depType" value="new_full" checked />
    åŒ¯æ¬¾å…¨é¡
  </label>
  <label class="radio-pill">
    <input type="radio" name="depType" value="old" />
    åŒ¯æ¬¾å®šé‡‘ - ä¿ç•™
  </label>
</div>


           <!-- è€å®¢è¨‚é‡‘ -->
      <div id="depOldPane" class="mt-3" hidden>
        <div class="section-title">ğŸ’¡ åŒ¯æ¬¾å®šé‡‘ (å…¥å¸³å¾Œå¯ç‚ºæ‚¨ ä¿ç•™å•†å“æœ€é•· 1 å€‹æœˆï¼‰</div>


        <!-- å–è²¨æ–¹å¼ -->
        <label>å–è²¨æ–¹å¼ *</label>
        <select id="dep_old_method">
          <option value="711">7-11 å–è²¨</option>
          <option value="post">éƒµå¯„ï¼ˆä¸­è¯éƒµæ”¿ï¼‰</option>
        </select>

        <!-- å…±ç”¨åŸºæœ¬è³‡æ–™ï¼ˆå…©ç¨®å–è²¨æ–¹å¼éƒ½ç”¨é€™çµ„ï¼‰ -->
        <div class="row mt-2">
          <div><label>å§“å *</label><input id="dep_old_name" required /></div>
          <div><label>é›»è©± *</label><input id="dep_old_phone" required /></div>
        </div>
        <label>Email *</label>
        <input id="dep_old_email" required type="email" placeholder="example@gmail.com" />

        <!-- 7-11 æ”¶ä»¶è³‡æ–™ -->
        <div id="dep_old_box_711" class="mt-2">
         <div class="muted">0å…ƒåŒ…è£¹éœ€å¡«å¯«çœŸå¯¦å§“åã€‚</div>
          <div class="row">
            <div><label>7-11 é–€å¸‚ä»£è™Ÿ *</label><input id="dep_old_store_id" required /></div>
            <div><label>7-11 é–€å¸‚åç¨± *</label><input id="dep_old_store_name" required /></div>
          </div>
          <label>7-11 é–€å¸‚åœ°å€ *</label>
          <input id="dep_old_store_addr" required />
          <button class="btn secondary" id="mapDepOld">é–‹å•Ÿ 7-11 é–€å¸‚åœ°åœ–</button>
        </div>

        <!-- éƒµå¯„æ”¶ä»¶è³‡æ–™ -->
        <div id="dep_old_box_post" class="mt-2" hidden>
         <div class="muted">ä¸­è¯éƒµæ”¿æŠ•éä¸æœƒäº‹å…ˆé›»è©±é€£çµ¡ï¼Œè«‹ç¢ºèªæœ‰äººå¯æ”¶ä»¶ã€‚</div>
          <label>éƒµéå€è™Ÿ</label>
          <input id="dep_old_post_zip" />
          <label>æ”¶ä»¶åœ°å€ *</label>
          <input id="dep_old_post_addr" required placeholder="è«‹å¡«å¯«å®Œæ•´åœ°å€ï¼ˆç¸£å¸‚ã€å€ã€è·¯/è¡—ã€å··å¼„ã€æ¨“å±¤ï¼‰" />
        </div>

        <!-- å…±ç”¨: åŒ¯æ¬¾è³‡è¨Šï¼ˆå…©ç¨®éƒ½è¦å¡«ï¼‰ -->
<label class="mt-3">åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼ *</label>
<input id="dep_old_last5" required />

<!-- åªæœ‰ã€ŒåŒ¯æ¬¾è¨‚é‡‘ã€è¦å¡«çš„æ¬„ä½ -->
<div id="dep_old_deposit_fields">
  <label class="mt-2">åŒ¯æ¬¾é‡‘é¡ï¼ˆå®šé‡‘ï¼‰ *</label>
  <input id="dep_old_amount" />

  <label class="mt-2">ä¿ç•™åˆ°æœŸæ—¥ï¼ˆæœ€å¤š 1 å€‹æœˆå…§ï¼‰ *</label>
  <input id="dep_old_hold_until" type="date" />
</div>

<div class="hint">
  ï¼å®šé‡‘å…¥å¸³å¾Œå¯ç‚ºæ‚¨ä¿ç•™å•†å“æœ€é•· 1 å€‹æœˆã€‚<br/>
  ï¼ä¸€èˆ¬åŒ…æ¬¾å®šé‡‘ NT$ 1,000ï¼›Tory Burch ç­‰æŒ‡å®šå“ç‰Œå®šé‡‘ NT$ 2,000ã€‚<br/>
  ï¼âš ï¸ æ”¶ä»¶è³‡æ–™è«‹å‹™å¿…å¡«å¯«æ­£ç¢ºï¼Œä¹‹å¾Œè‹¥æœ‰ã€Œå®šé‡‘ï¼å°¾æ¬¾ã€ä»˜æ¬¾ï¼Œ
    ç³»çµ±éƒ½æœƒæ²¿ç”¨æœ¬æ¬¡è¨­å®šçš„æ”¶ä»¶äººèˆ‡å–è²¨é–€å¸‚ / æ”¶ä»¶åœ°å€ï¼Œä¸å¦å¤–å†è©¢å•ã€‚<br/>
  ï¼é€¾æœŸè¦–åŒæ£„æ¨™ï¼Œå®šé‡‘ä¸é€€é‚„ã€å•†å“ä¸å†ä¿ç•™ã€‚
</div>
      </div>


      

      <!-- æ–°å®¢å…¨é¡åŒ¯æ¬¾ -->
      <div id="depNewFullPane" class="mt-3">
        <div class="section-title">7-11 / éƒµå¯„ æ”¶ä»¶è³‡æ–™</div>
        <div class="row">
          <div><label>å§“å *</label><input id="dep_new_full_name" required /></div>
          <div><label>é›»è©± *</label><input id="dep_new_full_phone" required /></div>
        </div>
        <label>Email *</label>
        <input id="dep_new_full_email" required type="email" placeholder="example@gmail.com" />
        <label>å–è²¨æ–¹å¼ *</label>
        <select id="dep_new_full_method">
          <option value="711">7-11 å–è²¨</option>
          <option value="post">éƒµå¯„ï¼ˆä¸­è¯éƒµæ”¿ï¼‰</option>
        </select>

        <div id="depNewFull711" class="mt-2">
         <div class="muted">0å…ƒåŒ…è£¹éœ€å¡«å¯«çœŸå¯¦å§“åã€‚</div>
          <div class="row">
            <div><label>7-11 é–€å¸‚ä»£è™Ÿ *</label><input id="dep_new_full_store_id" required /></div>
            <div><label>7-11 é–€å¸‚åç¨± *</label><input id="dep_new_full_store_name" required /></div>
          </div>
          <label>7-11 é–€å¸‚åœ°å€ *</label>
          <input id="dep_new_full_store_addr" required />
          <button class="btn secondary" id="mapDepNewFull">é–‹å•Ÿ 7-11 é–€å¸‚åœ°åœ–</button>
        </div>

        <div id="depNewFullPost" class="mt-2" hidden>
         <div class="muted">ä¸­è¯éƒµæ”¿æŠ•éä¸æœƒäº‹å…ˆé›»è©±é€£çµ¡ï¼Œè«‹ç¢ºèªæœ‰äººå¯æ”¶ä»¶ã€‚</div>
          <label>éƒµéå€è™Ÿ</label>
          <input id="dep_new_full_post_zip" />
          <label>æ”¶ä»¶åœ°å€ *</label>
          <input id="dep_new_full_post_addr" required />
        </div>

        <!-- åŒ¯æ¬¾å…¨é¡ï¼šé‡‘é¡ç”±ç³»çµ±è‡ªå‹•å¸¶å…¥ï¼Œåªè®“å®¢äººå¡«å¾Œäº”ç¢¼ -->
        <input id="dep_new_full_amount" type="hidden" />
        <label class="mt-2">åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼ *</label>
        <input id="dep_new_full_last5" required />
      </div>
    </div>

    <!-- ZEROCARDï¼šä¸­ç§Ÿç„¡å¡ -->
    <div id="paneZEROCARD" hidden>
      <div class="section-title mt-2">æœŸæ•¸èˆ‡æ¯æœŸè©¦ç®—</div>
      <div class="row">
        <div>
          <label>æœŸæ•¸</label>
          <select id="zc_months">
            <option value="3">3 æœŸï¼ˆ0 åˆ©ç‡ï¼‰</option>
            <option value="6">6 æœŸ</option>
            <option value="9">9 æœŸ</option>
            <option value="12">12 æœŸ</option>
            <option value="18">18 æœŸ</option>
            <option value="24">24 æœŸ</option>
          </select>
        </div>
        <div>
          <label>æ¯æœŸé‡‘é¡ï¼ˆè©¦ç®—ï¼‰</label>
          <input id="zc_each" readonly />
        </div>
      </div>
      <div class="hint">ï¼å¯¦éš›æ ¸å‡†èˆ‡æœŸæ•¸ï¼Œä»¥ä¸­ç§Ÿç„¡å¡é›¶è§’å¯©æ ¸çµæœç‚ºæº–ã€‚</div>

      <div class="mt-4 section-title">å–è²¨æ–¹å¼</div>
      <select id="zc_ship_method">
        <option value="711">7-11 å–è²¨</option>
        <option value="post">éƒµå¯„ï¼ˆä¸­è¯éƒµæ”¿ï¼‰</option>
      </select>

      <!-- ZC + 7-11 -->
      <div id="zcShip711" class="mt-2">
       <div class="muted">0å…ƒåŒ…è£¹éœ€å¡«å¯«çœŸå¯¦å§“åã€‚</div>
        <div class="row">
          <div><label>å§“å *</label><input id="ship_name_zc" required /></div>
          <div><label>é›»è©± *</label><input id="ship_phone_zc" required /></div>
        </div>
        <label>Email *</label>
        <input id="zc_email" required type="email" placeholder="example@gmail.com" />
        <div class="row mt-2">
          <div><label>7-11 é–€å¸‚ä»£è™Ÿ *</label><input id="ship_store_id_zc" required /></div>
          <div><label>7-11 é–€å¸‚åç¨± *</label><input id="ship_store_name_zc" required /></div>
        </div>
        <label>7-11 é–€å¸‚åœ°å€ *</label>
        <input id="ship_store_addr_zc" required />
        <button class="btn secondary" id="mapZC">é–‹å•Ÿ 7-11 é–€å¸‚åœ°åœ–</button>
      </div>

      <!-- ZC + éƒµå¯„ -->
      <div id="zcShipPost" class="mt-2" hidden>
       <div class="muted">ä¸­è¯éƒµæ”¿æŠ•éä¸æœƒäº‹å…ˆé›»è©±é€£çµ¡ï¼Œè«‹ç¢ºèªæœ‰äººå¯æ”¶ä»¶ã€‚</div>
        <div class="row">
          <div><label>å§“å *</label><input id="zc_post_name" required /></div>
          <div><label>é›»è©± *</label><input id="zc_post_phone" required /></div>
        </div>
        <label>Email *</label>
        <input id="zc_post_email" required type="email" placeholder="example@gmail.com" />
        <label>éƒµéå€è™Ÿ</label>
        <input id="zc_post_zip" />
        <label>æ”¶ä»¶åœ°å€ *</label>
        <input id="zc_post_addr" required />
      </div>

      <div class="mt-4 section-title">æé†’</div>
      <div class="muted">ï¼é»é¸ã€Œé€å‡ºã€å¾Œï¼Œè‡ªå‹•è·³è½‰åˆ°ä¸­ç§Ÿç„¡å¡é›¶è§’ä»˜æ¬¾é é¢ã€‚</div>
    </div>
  </div>

  <button class="btn" id="submitBtn">é€å‡º</button>
</div>
  
<script>
/* ===== è¨­å®š ===== */
const API=(window.API_BASE||'https://api.murain.tw').replace(/\/$/,'');
const RATE_TABLE={3:0,6:4.0,9:5.5,12:6.5,18:9.0,24:11.5};
const NEW_DEPOSIT_AMOUNT=1000;
let CART_TOTAL_RAW = 0;   // çœŸå¯¦é‡‘é¡ï¼ˆæ•¸å­—ï¼‰

 // ===== LIFF è¨­å®š =====
  const LIFF_ID = "2008430261-KLwoQjm4";

  let LINE_PROFILE = null;
  let MEMBER_INFO  = null;

  async function initLiffAndMember() {
  if (!window.liff) return;

  await liff.init({ liffId: LIFF_ID });

  // åªæœ‰åœ¨ã€Œä¸€èˆ¬ç€è¦½å™¨(web)ã€æ‰ä¸»å‹•å«å‡º LINE Login
  if (!liff.isLoggedIn() && liff.getOS() === 'web') {
    try {
      saveCheckoutState();  // å…ˆå­˜è¡¨å–®ï¼Œé¿å…ç™»å…¥å¾Œæ¬„ä½è®Šç©ºç™½
    } catch (e) {
      console.warn('saveCheckoutState before liff.login failed', e);
    }

    // ä¸æŒ‡å®š redirectUriï¼Œè®“ LIFF ç”¨å¾Œå°çš„ Callback URL
    liff.login();
    return;
  }

  // èµ°åˆ°é€™è£¡ä»£è¡¨ï¼šå·²ç¶“ç™»å…¥äº†ï¼ˆåŒ…å«åœ¨ LINE app è£¡é–‹ LIFF çš„ç‹€æ³ï¼‰
  const profile = await liff.getProfile();
  LINE_PROFILE = profile;

    // å‘å¾Œç«¯æ‹¿æœƒå“¡è³‡æ–™ï¼ˆLineMembers è£¡é‚£ç­†ï¼‰
    try {
      const r = await fetch(`${API}/line/member-info?user_id=${encodeURIComponent(profile.userId)}`);
      const j = await r.json();
      if (j.ok) {
        MEMBER_INFO = j;

        // â˜… é€™è£¡å¦‚æœä½ æƒ³é å¡«é›»è©± / emailï¼Œå°±å¡«åˆ°å°æ‡‰æ¬„ä½
        // ä¸‹é¢åªæ˜¯ç¯„ä¾‹ï¼Œid æ›æˆä½ å¯¦éš›çš„
        const phoneInput = document.querySelector('#cod_phone');
        if (phoneInput && j.phone) {
          phoneInput.value = j.phone;
          // phoneInput.readOnly = true; // æƒ³é–æ­»å°±æ‰“é–‹
        }

        const emailInput = document.querySelector('#cod_email');
        if (emailInput && j.email) {
          emailInput.value = j.email;
          // emailInput.readOnly = true;
        }
      }
    } catch (e) {
      console.log('member-info error', e);
    }
  }



/* ===== å·¥å…· ===== */
const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>[...r.querySelectorAll(s)];
const money=n=>'NT$ '+Number(n||0).toLocaleString();

// å…ˆçœ‹ URLï¼Œæœ‰å°±å­˜åˆ° localStorageï¼›æ²’æœ‰å°±å¾ localStorage é‚„åŸ
const qs = new URLSearchParams(location.search);
let cartToken = qs.get('cart_token') || '';

if (!cartToken) {
  try {
    cartToken = localStorage.getItem('murain_cart_token') || '';
  } catch (e) {
    console.warn('localStorage read error', e);
  }
} else {
  try {
    localStorage.setItem('murain_cart_token', cartToken);
  } catch (e) {
    console.warn('localStorage write error', e);
  }
}

const customer   = (qs.get('customer')||'old').toLowerCase();   // new | old
const initialMode=(qs.get('mode')||'').toUpperCase();           // COD/PAID/DEPOSIT/ZEROCARD
const tailOf     = qs.get('tail_of') || '';                     // å°¾æ¬¾å°æ‡‰çš„æ¯è¨‚å–® order_id

 
function setTotal(v){
  const sub = document.querySelector('#subtotal');
  const tot = document.querySelector('#total');
  const txt = money(v || 0);
  if (sub) sub.value = txt;
  if (tot) tot.value = txt;
}

/* ===== Tabs ===== */
const tabs=$$('#payTabs .tab'); tabs.forEach(t=>t.addEventListener('click',()=>{
  tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
  const kt=t.dataset.pay;
  ['COD','PAID','DEPOSIT','ZEROCARD'].forEach(x=>$('#pane'+x).hidden=(x!==kt));
}));

/* ===== PAID ===== */
function updatePaidChannelBox(){
  const ch = $('#paid_channel').value;
  $('#cardInstBox').hidden = (ch !== 'card_inst');
}
$('#paid_channel').addEventListener('change', updatePaidChannelBox);
$('#paid_ship_method').addEventListener('change', updatePaidShip);

 // ä¸€é€²é é¢å°±å…ˆå¥—ä¸€æ¬¡ï¼Œé è¨­ã€Œä¸€æ¬¡ä»˜ã€ä¸é¡¯ç¤ºåˆ†æœŸæ¬„ä½
$('#paid_channel').dispatchEvent(new Event('change'));
updatePaidShip();

function updatePaidShip(){
  const m=$('#paid_ship_method').value;
  $('#paidShip711').hidden=(m!=='711');
  $('#paidShipPost').hidden=(m!=='post');
}

/* ===== DEPOSITï¼šåˆ‡æ› Pane ===== */
$('#dep_new_full_method').addEventListener('change',()=>{
  const m=$('#dep_new_full_method').value;
  $('#depNewFull711').hidden=(m!=='711');
  $('#depNewFullPost').hidden=(m!=='post');
});
 // è€å®¢è¨‚é‡‘ï¼š7-11 / éƒµå¯„åˆ‡æ›
const depOldMethod  = $('#dep_old_method');
const depOldBox711  = $('#dep_old_box_711');
const depOldBoxPost = $('#dep_old_box_post');

function updateDepOldShip(){
  if (!depOldMethod) return;
  const m = depOldMethod.value;       // '711' or 'post'
  if (depOldBox711)  depOldBox711.hidden  = (m !== '711');
  if (depOldBoxPost) depOldBoxPost.hidden = (m !== 'post');
}

if (depOldMethod) {
  depOldMethod.addEventListener('change', updateDepOldShip);
  updateDepOldShip(); // é€²é é¢å…ˆè·‘ä¸€æ¬¡
}

 // --- åŒ¯æ¬¾æ–¹å¼ï¼šåŒ¯æ¬¾å…¨é¡ / åŒ¯æ¬¾è¨‚é‡‘ åˆ‡æ› ---
const depTypeRadios     = document.querySelectorAll('input[name="depType"]');
const depOldPane        = document.querySelector('#depOldPane');
const depNewFullPane    = document.querySelector('#depNewFullPane');
const depOldDepositBox  = document.querySelector('#dep_old_deposit_fields');
const depOldAmount      = document.querySelector('#dep_old_amount');
const depOldHoldUntil   = document.querySelector('#dep_old_hold_until');

function refreshDepType() {
  const checked   = document.querySelector('input[name="depType"]:checked');
  const v         = checked ? checked.value : 'new_full';
  const isDeposit = (v === 'old');   // value="old" æ˜¯ã€ŒåŒ¯æ¬¾è¨‚é‡‘ - ä¿ç•™ã€

  // Paneï¼šé¡¯ç¤ºå“ªä¸€å¡Š
  if (depOldPane && depNewFullPane) {
    depOldPane.hidden     = !isDeposit;  // åŒ¯æ¬¾è¨‚é‡‘æ‰é¡¯ç¤º
    depNewFullPane.hidden =  isDeposit;  // å…¶ä»–æƒ…æ³é¡¯ç¤ºåŒ¯æ¬¾å…¨é¡
  }

  // è¨‚é‡‘å°ˆç”¨æ¬„ä½ï¼šé‡‘é¡ï¼‹ä¿ç•™æ—¥æœŸ
  if (depOldDepositBox) {
    depOldDepositBox.hidden = !isDeposit;
  }
  if (depOldAmount) {
    depOldAmount.required = isDeposit;
  }
  if (depOldHoldUntil) {
    depOldHoldUntil.required = isDeposit;
  }
}

if (depTypeRadios.length) {
  depTypeRadios.forEach(r => {
    r.addEventListener('change', refreshDepType);
  });
  // ä¸€è¼‰å…¥å°±å…ˆè·‘ä¸€æ¬¡ï¼Œä¾é è¨­ radio ç‹€æ…‹æ±ºå®šé¡¯ç¤º
  refreshDepType();
}


/* ===== ZEROCARD ===== */
function calcZC(){
  const months=Number($('#zc_months').value||3);
  const base=CART_TOTAL_RAW || 0;
  const rate=(RATE_TABLE[months]||0)/100;
  const total=Math.round(base*(1+rate));
  const each=Math.round(total/months);
  $('#zc_each').value=money(each)+' Ã— '+months+' æœŸ';
}
$('#zc_months').addEventListener('change',calcZC);
$('#zc_ship_method').addEventListener('change',updateZcShip);

function updateZcShip(){
  const m=$('#zc_ship_method').value;
  $('#zcShip711').hidden=(m!=='711');
  $('#zcShipPost').hidden=(m!=='post');
}

 
/* ===== è³¼ç‰©è»Šè¼‰å…¥ ===== */
async function loadCart(){
  if (!cartToken) {
    console.warn('missing cart_token');
    return;
  }
  try {
    const r = await fetch(`${API}/cart/${cartToken}`);
    const j = await r.json();

    if (!r.ok || !j.items) {
      throw new Error('cart_api_error');
    }

    const items = j.items || [];
    const total = Number(j.total_amount || 0);
    CART_TOTAL_RAW = total;

    const detail = items.map(it =>
      `${it.name || it.sku} x ${it.qty}ï¼ˆNT$${Number(it.price || 0)}ï¼‰`
    ).join('\n');

    const detailBox = document.querySelector('#itemsText');
    if (detailBox) detailBox.value = detail;

    setTotal(total);
    calcZC();
  } catch (e) {
    console.error('loadCart error', e);
    alert('è®€å–è³¼ç‰©è»Šå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚');
  }
}

/* ===== 7-11 åœ°åœ–ï¼ˆB æ–¹æ¡ˆï¼šæ•´é è·³è½‰ï¼Œé  URL å¸¶è³‡æ–™ï¼‰ ===== */
function open711(src) {
  // â˜… å…ˆæŠŠæ•´å€‹è¡¨å–®ç‹€æ…‹å­˜èµ·ä¾†ï¼ˆä»˜æ¬¾æ–¹å¼ã€æœŸæ•¸ã€å§“åé›»è©±ã€email éƒ½æœƒè¨˜ä½ï¼‰
  saveCheckoutState();
  const qs2 = new URLSearchParams(location.search);
  qs2.set('src', src);
  const url = `${API}/cvs/map?${qs2.toString()}`;
  window.location.href = url;
}

// å¾ URL æŠŠ 7-11 é–€å¸‚è³‡æ–™å¸¶å›æ¬„ä½
function applyStoreFromURL(){
  const qs2 = new URLSearchParams(location.search);
  const src = (qs2.get('store_src') || '').toLowerCase();
  const id   = qs2.get('store_id')   || '';
  const name = qs2.get('store_name') || '';
  const addr = qs2.get('store_addr') || '';
  if (!src || !id) return;

  const fill = (a,b,c)=>{ setFieldValue(a,id); setFieldValue(b,name); setFieldValue(c,addr); };

  switch (src) {
    case 'cod':       fill('#cod_store_id', '#cod_store_name', '#cod_store_addr'); break;
    case 'paid':      fill('#ship_store_id_paid', '#ship_store_name_paid', '#ship_store_addr_paid'); break;
    case 'dep_old':   fill('#dep_old_store_id', '#dep_old_store_name', '#dep_old_store_addr'); break;
    case 'dep_new_f': fill('#dep_new_full_store_id', '#dep_new_full_store_name', '#dep_new_full_store_addr'); break;
    case 'zc':        fill('#ship_store_id_zc', '#ship_store_name_zc', '#ship_store_addr_zc'); break;
  }
}

// å°å·¥å…·ï¼šå¯«å€¼ä¸¦è§¸ç™¼äº‹ä»¶
function setFieldValue(sel, val){
  const el = document.querySelector(sel);
  if (!el) return false;
  el.value = val || '';
  try {
    el.dispatchEvent(new Event('input', {bubbles:true}));
    el.dispatchEvent(new Event('change', {bubbles:true}));
  } catch(e){}
  return true;
}

// ä¿ç•™ message ç‰ˆï¼ˆä¹‹å¾Œå¦‚æœè¦å›åˆ° popup ä¹Ÿèƒ½ç”¨ï¼‰
function normalizeStorePayload(ev){
  const d = ev && ev.data;
  if (!d) return null;

  if (d.type === '711_store' && d.data) {
    const p = d.data;
    return {
      ok: !!p.ok,
      src: p.src || '',
      id:   p.id   || p.cvs_code || p.store_id || p.CVSStoreID || p.STOREID || '',
      name: p.name || p.cvs_name || p.store_name || p.CVSStoreName || p.STORENAME || '',
      addr: p.addr || p.cvs_addr || p.store_address || p.CVSAddress || p.STOREADDRESS || ''
    };
  }

  if (d.type === 'cvs_selected') {
    return {
      ok: true,
      src: d.src || '',
      id:   d.cvs_code || d.id || d.store_id || d.CVSStoreID || d.STOREID || '',
      name: d.cvs_name || d.name || d.store_name || d.CVSStoreName || d.STORENAME || '',
      addr: d.cvs_addr || d.addr || d.store_address || d.CVSAddress || d.STOREADDRESS || ''
    };
  }

  return null;
}

window.addEventListener('message', (ev)=>{
  const p = normalizeStorePayload(ev);
  if (!p || !p.ok) return;
  const src = (p.src || '').toLowerCase();
  const fill = (a,b,c)=>{ setFieldValue(a, p.id); setFieldValue(b, p.name); setFieldValue(c, p.addr); };
  switch (src) {
    case 'cod':        fill('#cod_store_id', '#cod_store_name', '#cod_store_addr'); break;
    case 'paid':       fill('#ship_store_id_paid', '#ship_store_name_paid', '#ship_store_addr_paid'); break;
    case 'dep_old':    fill('#dep_old_store_id', '#dep_old_store_name', '#dep_old_store_addr'); break;
    case 'dep_new_f':  fill('#dep_new_full_store_id', '#dep_new_full_store_name', '#dep_new_full_store_addr'); break;
    case 'zc':         fill('#ship_store_id_zc', '#ship_store_name_zc', '#ship_store_addr_zc'); break;
  }
});
// ====== checkout ç‹€æ…‹æš«å­˜ï¼ˆé¿å…é¸å®Œ 7-11 å›ä¾†è³‡æ–™ä¸è¦‹ï¼‰ ======
const CHECKOUT_STATE_KEY = 'murain_checkout_state_v1';

function saveCheckoutState() {
  const state = {};
  document.querySelectorAll('input, select, textarea').forEach(el => {
    const key = el.id || el.name;
    if (!key) return;

    if (el.type === 'radio' || el.type === 'checkbox') {
      if (!state[key]) state[key] = {};
      state[key][el.value] = el.checked;
    } else {
      state[key] = el.value;
    }
  });
  try {
    localStorage.setItem(CHECKOUT_STATE_KEY, JSON.stringify(state));
  } catch (e) {
    console.warn('saveCheckoutState failed', e);
  }
}

function restoreCheckoutState() {
  let raw = null;
  try {
    raw = localStorage.getItem(CHECKOUT_STATE_KEY);
  } catch (e) {
    console.warn('restoreCheckoutState getItem failed', e);
  }
  if (!raw) return;

  let state;
  try {
    state = JSON.parse(raw);
  } catch {
    return;
  }

  document.querySelectorAll('input, select, textarea').forEach(el => {
    const key = el.id || el.name;
    if (!key || !(key in state)) return;

    if (el.type === 'radio' || el.type === 'checkbox') {
      const map = state[key];
      if (map && typeof map === 'object') {
        el.checked = !!map[el.value];
      }
    } else {
      el.value = state[key];
    }
  });
}

function clearCheckoutState() {
  try {
    localStorage.removeItem(CHECKOUT_STATE_KEY);
  } catch (e) {}
}


/* ç¶å®šæ‰€æœ‰ 7-11 åœ°åœ–æŒ‰éˆ• */
$('#mapCOD').addEventListener('click',e=>{e.preventDefault();open711('cod');});
$('#mapPAID').addEventListener('click',e=>{e.preventDefault();open711('paid');});
$('#mapDepOld').addEventListener('click',e=>{e.preventDefault();open711('dep_old');});
$('#mapDepNewFull').addEventListener('click',e=>{e.preventDefault();open711('dep_new_f');});
$('#mapZC').addEventListener('click',e=>{e.preventDefault();open711('zc');});

  // ===== é€å‡º =====
function required(v){ return v && String(v).trim().length>0; }

document.getElementById('submitBtn').addEventListener('click',async(e)=>{
  e.preventDefault();
  if(!cartToken){ alert('ç¼ºå°‘ cart_tokenï¼Œè«‹ç”±æ­£ç¢ºçµå¸³é€£çµé€²å…¥'); return; }

  const subtotal = CART_TOTAL_RAW;  // ç”¨å¾Œç«¯å›ä¾†çš„çœŸå¯¦é‡‘é¡
  if(!subtotal){ alert('é‡‘é¡ç‚º 0ï¼Œè«‹ç¢ºèªè³¼ç‰©è»Šå…§å®¹'); return; }

  const note = $('#note').value || '';
  const shipping_info = { customer_type: customer, note };

 // â˜… å¦‚æœæ˜¯å¾ LIFF é–‹çš„ï¼Œæœ‰æ‹¿åˆ° profileï¼Œå°±ä¸€èµ·å¡é€² shipping_info
if (LINE_PROFILE && LINE_PROFILE.userId) {
  shipping_info.line = {
    user_id: LINE_PROFILE.userId,
    display_name: LINE_PROFILE.displayName || ""
  };
} else {
    const uidInput = document.getElementById('line_user_id');
    const nameInput = document.getElementById('line_display_name');
    const uid = uidInput ? uidInput.value : '';
    const name = nameInput ? nameInput.value : '';
    if (uid) {
      shipping_info.line = {
        user_id: uid,
        display_name: name
      };
    }
  }
// â˜…â˜…â˜… æ²’æœ‰ LINE å°±ä¸çµ¦çµå¸³ï¼ˆä¸€å®šè¦åœ¨ LINE è£¡é–‹ï¼‰
  if (!shipping_info.line || !shipping_info.line.user_id) {
    alert('è«‹å…ˆåœ¨ LINE å®˜æ–¹å¸³è™Ÿä¸­é–‹å•Ÿé€™å€‹çµå¸³é ï¼Œå®Œæˆ LINE æœƒå“¡ç¶å®šå¾Œå†é€å‡ºè¨‚å–®');
    return;
  }
  let payment_method = '';
  let ship = null;

  // ç›®å‰é¸åˆ°å“ªå€‹åˆ†é ï¼ˆCOD / PAID / DEPOSIT / ZEROCARDï¼‰
  const activeTab = [...tabs].find(t=>t.classList.contains('active'))?.dataset.pay || 'COD';

  // ===== COD =====
  if(activeTab === 'COD'){
    const name  = $('#cod_name').value;
    const phone = $('#cod_phone').value;
    const id    = $('#cod_store_id').value;
    const sname = $('#cod_store_name').value;
    const addr  = $('#cod_store_addr').value;
    const emailCod = ($('#cod_email').value || '').trim();

    if(![name,phone,id,sname,addr,emailCod].every(required)) {
      alert('è«‹å¡«å®Œ COD å¿…å¡«æ¬„ä½ï¼ˆå« Emailï¼‰');
      return;
    }

    payment_method = 'cod_711';
    ship = {
      type:'711',
      name,
      phone,
      email: emailCod,
      store:{ id, name:sname, addr }
    };
  }

  // ===== PAID =====
  if(activeTab === 'PAID'){
    const channel    = $('#paid_channel').value;            // card_once / card_inst / linepay / af
    const shipMethod = $('#paid_ship_method').value;        // 711 / post

    payment_method = `paid_${channel}`;
    if(channel === 'card_inst'){
      payment_method += `_${$('#inst_months').value}`;      // paid_card_inst_3 / _6 / _9
    }

    if(shipMethod === '711'){
      const name  = $('#ship_name_paid').value;
      const phone = $('#ship_phone_paid').value;
      const id    = $('#ship_store_id_paid').value;
      const sname = $('#ship_store_name_paid').value;
      const addr  = $('#ship_store_addr_paid').value;
      const emailPaid = ($('#paid_email').value || '').trim();

      if(![name,phone,id,sname,addr,emailPaid].every(required)){
        alert('è«‹å¡«å®Œ 7-11 æ”¶ä»¶è³‡æ–™ï¼ˆå« Emailï¼‰');
        return;
      }

      ship = {
        type:'711',
        name,
        phone,
        email: emailPaid,
        store:{ id, name:sname, addr }
      };
    } else {
      const name  = $('#paid_post_name').value;
      const phone = $('#paid_post_phone').value;
      const zip   = $('#paid_post_zip').value;
      const addr  = $('#paid_post_addr').value;
      const emailPost = ($('#paid_post_email').value || '').trim();

      if(![name,phone,addr,emailPost].every(required)){
        alert('è«‹å¡«å®Œéƒµå¯„è³‡æ–™ï¼ˆå« Emailï¼‰');
        return;
      }

      ship = {
        type:'post',
        name,
        phone,
        email: emailPost,
        post:{ zip, addr }
      };
    }
  }

   // ===== DEPOSIT =====
  if (activeTab === 'DEPOSIT') {
    const depType = $('input[name="depType"]:checked').value; // new_full / old

    // --- â‘  åŒ¯æ¬¾è¨‚é‡‘ï¼ˆä¿ç•™ï¼‰ ---
    if (depType === 'old') {
      const method   = $('#dep_old_method').value;   // 711 / post
      const name     = $('#dep_old_name').value;
      const phone    = $('#dep_old_phone').value;
      const amount   = $('#dep_old_amount').value;
      const last5    = $('#dep_old_last5').value;
      const hold     = $('#dep_old_hold_until').value;
      const emailOld = ($('#dep_old_email').value || '').trim();

      // å…±ç”¨å¿…å¡«ï¼ˆä¸ç®¡ 7-11 é‚„æ˜¯éƒµå¯„ï¼‰
      if (![name, phone, amount, last5, hold, emailOld].every(required)) {
        alert('è«‹å¡«å®Œã€ŒåŒ¯æ¬¾å®šé‡‘ï¼ˆä¿ç•™ 1 å€‹æœˆï¼‰ã€æ¬„ä½ï¼ˆå« Emailã€åŒ¯æ¬¾é‡‘é¡ã€å¸³è™Ÿå¾Œäº”ç¢¼ã€ä¿ç•™åˆ°æœŸæ—¥ï¼‰');
        return;
      }

      // æª¢æŸ¥ä¿ç•™æ—¥æœŸï¼šä»Šå¤©èµ· 1 å€‹æœˆå…§
      const today   = new Date(); today.setHours(0,0,0,0);
      const maxDate = new Date(); maxDate.setDate(maxDate.getDate() + 31); maxDate.setHours(0,0,0,0);
      const holdDate = hold ? new Date(hold) : null;

      if (!holdDate || holdDate < today || holdDate > maxDate) {
        alert('ä¿ç•™åˆ°æœŸæ—¥è«‹é¸æ“‡ã€Œä»Šå¤©èµ· 1 å€‹æœˆå…§ã€çš„æ—¥æœŸ');
        return;
      }

      // ä¾å–è²¨æ–¹å¼çµ„ ship
      if (method === '711') {
        const id    = $('#dep_old_store_id').value;
        const sname = $('#dep_old_store_name').value;
        const addr  = $('#dep_old_store_addr').value;

        if (![id, sname, addr].every(required)) {
          alert('è«‹å¡«å®Œ 7-11 æ”¶ä»¶è³‡æ–™');
          return;
        }

        ship = {
          type: '711',
          name,
          phone,
          email: emailOld,
          store: { id, name: sname, addr },
          deposit: {
            type: 'old',
            amount,
            last5,
            hold_until: hold
          }
        };
      } else if (method === 'post') {
        const zip  = $('#dep_old_post_zip').value;
        const addr = $('#dep_old_post_addr').value;

        if (![addr].every(required)) {
          alert('è«‹å¡«å®Œéƒµå¯„æ”¶ä»¶è³‡æ–™');
          return;
        }

        ship = {
          type: 'post',
          name,
          phone,
          email: emailOld,
          post: { zip, addr },
          deposit: {
            type: 'old',
            amount,
            last5,
            hold_until: hold
          }
        };
      } else {
        alert('è«‹å…ˆé¸æ“‡å–è²¨æ–¹å¼');
        return;
      }

      // ä¿æŒåŸæœ¬ payment_methodï¼Œä¸ç”¨å‹•å¾Œç«¯
      payment_method = 'deposit_old';
    }

    // --- â‘¡ åŒ¯æ¬¾å…¨é¡ï¼šé‡‘é¡ç”¨ç³»çµ±å¸¶å…¥ï¼Œåªå¡«å¾Œäº”ç¢¼ ---
    else if (depType === 'new_full') {
      const method    = $('#dep_new_full_method').value;   // 711 / post
      const emailNewF = ($('#dep_new_full_email').value || '').trim();
      const amount    = CART_TOTAL_RAW || 0;  // å…¨é¡é‡‘é¡ç”±ç³»çµ±å¸¶å…¥

      // é †ä¾¿å¯«å›éš±è—æ¬„ä½ï¼Œä¹‹å¾Œåœ¨å¾Œå°çœ‹å¾—è¦‹
      const depNewFullAmountInput = $('#dep_new_full_amount');
      if (depNewFullAmountInput) {
        depNewFullAmountInput.value = amount;
      }

      if (method === '711') {
        const name   = $('#dep_new_full_name').value;
        const phone  = $('#dep_new_full_phone').value;
        const id     = $('#dep_new_full_store_id').value;
        const sname  = $('#dep_new_full_store_name').value;
        const addr   = $('#dep_new_full_store_addr').value;
        const last5  = $('#dep_new_full_last5').value;

        if (![name, phone, id, sname, addr, last5, emailNewF].every(required)) {
          alert('è«‹å¡«å®Œæ–°å®¢å…¨é¡åŒ¯æ¬¾ï¼ˆ7-11ï¼‰æ¬„ä½ï¼ˆå« Emailã€å¸³è™Ÿå¾Œäº”ç¢¼ï¼‰');
          return;
        }

        payment_method = 'deposit_new_full_711';
        ship = {
          type: '711',
          name,
          phone,
          email: emailNewF,
          store: { id, name: sname, addr },
          deposit: { type: 'new_full', method: '711', amount, last5 }
        };
      } else if (method === 'post') {
        const name   = $('#dep_new_full_name').value;
        const phone  = $('#dep_new_full_phone').value;
        const zip    = $('#dep_new_full_post_zip').value;
        const addr   = $('#dep_new_full_post_addr').value;
        const last5  = $('#dep_new_full_last5').value;

        if (![name, phone, addr, last5, emailNewF].every(required)) {
          alert('è«‹å¡«å®Œæ–°å®¢å…¨é¡åŒ¯æ¬¾ï¼ˆéƒµå¯„ï¼‰æ¬„ä½ï¼ˆå« Emailã€å¸³è™Ÿå¾Œäº”ç¢¼ï¼‰');
          return;
        }

        payment_method = 'deposit_new_full_post';
        ship = {
          type: 'post',
          name,
          phone,
          email: emailNewF,
          post: { zip, addr },
          deposit: { type: 'new_full', method: 'post', amount, last5 }
        };
      } else {
        alert('è«‹å…ˆé¸æ“‡åŒ¯æ¬¾å…¨é¡çš„å–è²¨æ–¹å¼');
        return;
      }
    }

    // depType æ ¹æœ¬æ²’é¸åˆ°ï¼ˆç†è«–ä¸Šä¸æœƒï¼Œä½†ä¿éšªï¼‰
    else {
      alert('è«‹å…ˆé¸æ“‡åŒ¯æ¬¾æ–¹å¼ï¼ˆåŒ¯æ¬¾å…¨é¡ / åŒ¯æ¬¾å®šé‡‘ï¼‰');
      return;
    }
  }


  // ===== ZEROCARDï¼ˆä¸­ç§Ÿç„¡å¡é›¶è§’ï¼‰ =====
  if(activeTab === 'ZEROCARD'){
    const months = $('#zc_months').value;       // 3 / 6 / 9 / 12 / 18 / 24
    payment_method = `zero_card_${months}`;

    if($('#zc_ship_method').value === '711'){
      const name  = $('#ship_name_zc').value;
      const phone = $('#ship_phone_zc').value;
      const id    = $('#ship_store_id_zc').value;
      const sname = $('#ship_store_name_zc').value;
      const addr  = $('#ship_store_addr_zc').value;
      const emailZc = ($('#zc_email').value || '').trim();

      if(![name,phone,id,sname,addr,emailZc].every(required)){
        alert('è«‹å¡«å®Œ 7-11 æ”¶ä»¶è³‡æ–™ï¼ˆå« Emailï¼‰');
        return;
      }

      ship = {
        type:'711',
        name,
        phone,
        email: emailZc,
        store:{ id, name:sname, addr }
      };
    } else {
      const name  = $('#zc_post_name').value;
      const phone = $('#zc_post_phone').value;
      const zip   = $('#zc_post_zip').value;
      const addr  = $('#zc_post_addr').value;
      const emailZcPost = ($('#zc_post_email').value || '').trim();

      if(![name,phone,addr,emailZcPost].every(required)){
        alert('è«‹å¡«å®Œéƒµå¯„è³‡æ–™ï¼ˆå« Emailï¼‰');
        return;
      }

      ship = {
        type:'post',
        name,
        phone,
        email: emailZcPost,
        post:{ zip, addr }
      };
    }
  }

  if(!payment_method || !ship){
    alert('è«‹å…ˆé¸æ“‡ä»˜æ¬¾æ–¹å¼ï¼Œä¸¦å¡«å®Œå¿…è¦æ¬„ä½');
    return;
  }

  shipping_info.ship = ship;
  const isZeroCard = payment_method.startsWith('zero_card_');

  try{
    $('#submitBtn').disabled = true;

    // 1) å…ˆå»ºç«‹è¨‚å–®
        const r = await fetch(`${API}/checkout`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ cart_token: cartToken, payment_method, shipping_info })
    });
    const j = await r.json();
    if (!r.ok || !j.ok) {
      const msg = j.message || j.error || 'é€å‡ºå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡';
      throw new Error(msg);
    }


    // â˜…â˜…â˜… ä¸‹å–®æˆåŠŸ â†’ æ¸…æ‰ localStorage æš«å­˜è³‡æ–™
    clearCheckoutState();

   // â˜… ä¸€é å¼å•†åŸè³¼ç‰©è»Šï¼šä¸‹å–®æˆåŠŸå¾Œï¼Œä¹ŸæŠŠ cart token æ¸…æ‰
    try {
      localStorage.removeItem('MURAIN_WEB_CART_TOKEN');
    } catch (e) {}

   // å¦‚æœæ˜¯ PayUniï¼ˆä¿¡ç”¨å¡ä¸€æ¬¡ / åˆ†æœŸ / LINE Pay / AFTEEï¼‰
if (payment_method && payment_method.startsWith('paid_')) {
  try {
    // â˜… å·²ç¶“åœ¨å‰é¢ /checkout å»ºç«‹å¥½è¨‚å–®ï¼Œé€™è£¡åªè¦ç”¨ order_id å»å« /payuni/start
    const pr = await fetch(`${API}/payuni/start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        order_id: j.order_id
      })
    });

    const up = await pr.json();
    console.log('payuni start resp', up);

    if (!pr.ok || !up.ok) {
      alert('ç·šä¸Šåˆ·å¡å•Ÿå‹•å¤±æ•—ï¼š' + (up.error || up.message || ''));
      return;
    }

    // å¾Œç«¯å›ä¾†çš„è³‡æ–™ï¼š{ ok:true, url, MerID, Version, EncryptInfo, HashInfo }
    const f = document.createElement('form');
    f.method = 'POST';
    f.action = up.url;   // https://api.payuni.com.tw/api/upp

    ['MerID', 'Version', 'EncryptInfo', 'HashInfo'].forEach(k => {
      const input = document.createElement('input');
      input.type  = 'hidden';
      input.name  = k;
      input.value = up[k];
      f.appendChild(input);
    });

    document.body.appendChild(f);
    f.submit();          // é€åˆ° PAYUNI ä»˜æ¬¾é 
    return;
  } catch (e) {
    console.error('payuni error', e);
    alert('ç·šä¸Šåˆ·å¡å•Ÿå‹•å¤±æ•—ï¼ˆç¶²è·¯æˆ–ç¨‹å¼éŒ¯èª¤ï¼‰');
    return;
  }
}


// ğŸ”¹ ZeroCardï¼šä¸­ç§Ÿç„¡å¡é›¶è§’ï¼Œå‘¼å« /zero-card/start æ‹¿ä»˜æ¬¾é ç¶²å€
if (isZeroCard) {
  try {
    const zr = await fetch(`${API}/zero-card/start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ order_id: j.order_id })
    });

    const z = await zr.json();
    console.log('zero-card start resp', z);

    if (!zr.ok || !z.ok) {
      alert('ä¸­ç§Ÿç„¡å¡å•Ÿå‹•å¤±æ•—ï¼š' + (z.error || z.message || ''));
      return;
    }

    // å¾å¾Œç«¯æ‹¿åˆ° payment_urlï¼Œå°åˆ°ä¸­ç§Ÿä»˜æ¬¾é 
    location.href = z.payment_url;
    return;
  } catch (e) {
    console.error('zero-card error', e);
    alert('ä¸­ç§Ÿç„¡å¡å•Ÿå‹•å¤±æ•—ï¼ˆç¶²è·¯æˆ–ç¨‹å¼éŒ¯èª¤ï¼‰');
    return;
  }
}


    // 3) å…¶ä»–ä»˜æ¬¾æ–¹å¼ â†’ ä¸€æ¨£è·³åˆ°è¨‚å–®å®Œæˆé 
const url = `/order-result.html?order_id=${encodeURIComponent(j.order_id)}&total=${encodeURIComponent(subtotal)}`;
try{
  location.href = url;
}catch(e){
  alert(`ä¸‹å–®æˆåŠŸï¼è¨‚å–®ç·¨è™Ÿï¼š${j.order_id}`);
}

  }catch(e){
    console.error(e);
    alert(e.message || 'é€å‡ºå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡');
  }finally{
    $('#submitBtn').disabled = false;
  }
});
 
// ===== é é¢åˆå§‹åŒ–ï¼šåˆ‡åˆ†é ã€è¼‰å…¥è³¼ç‰©è»Šã€å›å¡« 7-11 é–€å¸‚ =====
(async () => {
  if (window.liff) {
    try {
      await initLiffAndMember();
    } catch (e) {
      console.log('LIFF init error (ignore on web)', e);
    }
  }


  // 0. å…ˆé‚„åŸä¸Šä¸€æ¬¡çš„è¡¨å–®ç‹€æ…‹ï¼Œé¿å…é¸é–€å¸‚å›ä¾†è³‡æ–™ä¸è¦‹
  restoreCheckoutState();

  // 0.5 è‹¥æ˜¯å¾ 7-11 åœ°åœ–è·³å›ä¾†ï¼Œå„ªå…ˆæŠŠé€™æ¬¡é¸çš„é–€å¸‚å¯«é€²å»
  applyStoreFromURL();

  // 1. æ ¹æ“š URL çš„ mode åˆ‡æ›åˆ†é ï¼ˆä¾‹å¦‚ ?mode=ZEROCARDï¼‰
  if (initialMode) {
    document.querySelector(`.tab[data-pay="${initialMode}"]`)?.click();
  } else {
    document.querySelector('.tab[data-pay="COD"]')?.click();
  }

  // 2. æŠŠå„ç¨®é¸é …çš„é è¨­ç•«é¢è™•ç†å¥½
 updatePaidChannelBox(); // ç·šä¸Šä»˜æ¬¾ï¼šé è¨­ä¸€æ¬¡ä»˜å°±éš±è—åˆ†æœŸ
  updatePaidShip();     // ç·šä¸Šä»˜æ¬¾ 7-11 / éƒµå¯„ å“ªä¸€å¡Š
  refreshDepType();   // â¬… æŠŠåŸæœ¬çš„ updateDepositPane() æ”¹æˆé€™å€‹
  updateZcShip();       // ä¸­ç§Ÿ é¡¯ç¤º 7-11 / éƒµå¯„

  // 3. è®€è³¼ç‰©è»Šï¼Œå¡é€²ã€Œå•†å“æ˜ç´° / å°è¨ˆ / æ‡‰ä»˜é‡‘é¡ã€ï¼Œé †ä¾¿æ›´æ–°ä¸­ç§Ÿè©¦ç®—
  await loadCart();

  // 4. å†è·‘ä¸€æ¬¡ applyStoreFromURLï¼Œç¢ºä¿é–€å¸‚æœ‰è¢«å¯«é€²æ¬„ä½
  applyStoreFromURL();
})();


</script>
</body>
</html>
