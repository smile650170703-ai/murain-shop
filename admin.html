<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MURAIN ??ç®¡ç?å¾Œå° (v6.1 - Admin UI)</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background-color: #f9f9f9; }
    .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
    .login-box { max-width: 500px; margin: 2rem auto; background: #fff; border-radius: 8px; padding: 2rem; }
    .tabs { display: flex; border-bottom: 1px solid #ccc; flex-wrap: wrap; gap:6px; }
    .tab-link { padding: 1rem 1.5rem; cursor: pointer; border: none; background: #eee; font-size: 1rem; }
    .tab-link.active { background: #fff; border: 1px solid #ccc; border-bottom: 1px solid #fff; position: relative; top: 1px; }
    .tab-content { display: none; background: #fff; padding: 2rem; border: 1px solid #ccc; border-top: none; }
    .tab-content.active { display: block; }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; word-wrap: break-word; }
    th { background-color: #f4f4f4; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
    button { font-size: 1rem; padding: 10px 16px; border: none; background-color: #007aff; color: white; border-radius: 8px; cursor: pointer; margin-right: 10px; }
    button:disabled { background-color: #ccc; cursor: default; }
    .btn-secondary { background-color: #6c757d; }
    .btn-ship { background-color: #28a745; font-size: 0.9rem; padding: 8px 12px; }
    .btn-cancel { background-color: #dc3545; font-size: 0.9rem; padding: 8px 12px; }
    .btn-confirm { background-color: #ffc107; color: black; font-size: 0.9rem; padding: 8px 12px; }
    .btn-edit { background-color: #0dcaf0; color: black; font-size: 0.9rem; padding: 8px 12px; }
    #status { margin-top: 1rem; font-weight: bold; }
    .hidden { display: none; }
    .label { width: 10cm; height: 15cm; border: 1px dashed #999; padding: 10px; box-sizing: border-box; margin: 1rem auto; page-break-after: always; overflow: hidden; background: #fff; }
    .label h3 { margin-top: 0; border-bottom: 2px solid #000; padding-bottom: 5px; }
    .label .section { margin-bottom: 10px; }
    .label .section strong { font-size: 1.2rem; display: block; }
    .label .section span { font-size: 1.1rem; }
    .label .gift-notes { border-top: 1px solid #ccc; padding-top: 10px; margin-top: 10px; background: #fdfdea; }
    @media print { body { margin: 0; } .container, .login-box { display: none; } #shipping-labels { display: block !important; } .label { border: none; margin: 0; } .btn-ship, .btn-cancel, .btn-confirm, .btn-edit { display: none; } }

    /* small helpers */
    .flex { display:flex; gap:8px; align-items:center; }
    .muted { color:#666; font-size:0.9rem; }
    .small { font-size:0.9rem; padding:6px 10px; }
  </style>

  <!-- xlsx ?¨æ–¼ä¸Šå‚³Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>

  <!-- single login box only -->
  <div class="login-box" id="login-box">
      <h2>ç®¡ç?å¾Œå°</h2>
      <div class="form-group">
          <label for="op_key">è«‹è¼¸?¥ä¸»??ç®¡ç??¡å?ç¢?/label>
          <input type="password" id="op_key" placeholder="ç®¡ç?å¯†ç¢¼ (?»å…¥??">
      </div>
      <button id="loginBtn">?»å…¥</button>
      <p id="login-status"></p>
  </div>

  <div id="confirmModal" style="display:none; position:fixed; left:0;right:0;top:0;bottom:0;
       background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:9999;">
    <div style="background:#fff;padding:18px;border-radius:8px; width:420px; max-width:95%;">
      <h3 id="confirmTitle">è«‹è¼¸?¥ç®¡?†å?ç¢¼ç¢ºèª?/h3>
      <input id="confirmInput" type="password" placeholder="ç®¡ç?å¯†ç¢¼" style="width:100%; padding:8px; margin:8px 0;">
      <div style="font-size:0.9rem; color:#666; margin-bottom:8px;" id="confirmHint"></div>
      <div style="text-align:right;">
        <button id="confirmCancel" type="button" class="small btn-secondary">?–æ?</button>
        <button id="confirmOk" type="button" class="small">ç¢ºè?</button>
      </div>
    </div>
  </div>

  <div class="container hidden" id="admin-panel">
      <div class="tabs">
          <button class="tab-link active" data-tab="tab-dashboard">?€è¡¨æ¿ (è¨‚å–®)</button>
          <button class="tab-link" data-tab="tab-products">åº«å?ç®¡ç?</button>
          <button class="tab-link" data-tab="tab-shipping">?ºè²¨ç®¡ç? (?±æ???</button>
          <button class="tab-link" data-tab="tab-reports">ç¸½è??®å ±è¡?(Q6)</button>
      </div>

      <div id="tab-dashboard" class="tab-content active">
        <h2>?€è¡¨æ¿ (è¿?7 å¤©è???</h2>

<div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
  <label style="display:flex; align-items:center; gap:6px;">
    <input id="dashboard-select-all" type="checkbox" />
    <span class="muted">?¨é¸</span>
  </label>
  <button id="bulk-delete-btn" class="btn-cancel small" style="background:#8b0000;">?¹é??ªé™¤</button>
  <div class="muted">ï¼ˆå??¾é¸å·¦å´?…ç›®ï¼Œæ??•æ??ç¤ºè¼¸å…¥ç®¡ç?å¯†ç¢¼ï¼?/div>
</div>

        <button id="refresh-dashboard">?æ–°?´ç?</button>
        <div style="overflow-x: auto; margin-top: 12px;">
          <table id="dashboard-table">
            <thead>
  <tr>
    <th style="width:36px;"></th>
    <th>?¥æ?</th>
    <th>ä¸»æ’­</th>
    <th>è¨‚å–®??/th>
    <th>?€??/th>
    <th>å¾Œä?ç¢?/th>
    <th>?‘é?</th>
    <th>ä»˜æ¬¾?¹å?</th>
    <th>?‹è²»(Q5)</th>
    <th>?®è?(Q7)</th>
    <th>?™è¨»</th>
  </tr>
</thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="tab-products" class="tab-content">
          <h2>åº«å?ç®¡ç?</h2>
          <div class="flex" style="margin-bottom:8px;">
            <button id="refresh-products" class="small">?æ–°?´ç?åº«å?</button>
            <div class="muted">| ?¯æ´ CSV / XLSX ä¸Šå‚³</div>
          </div>

          <div style="margin-top:6px; display:flex; gap:8px; align-items:center;">
            <input type="file" id="inventory-file" accept=".xlsx,.xls,.csv" />
            <button id="upload-inventory-btn" class="btn-secondary small">ä¸€?µä???Excel (ä¸Šå‚³åº«å?)</button>
            <span class="muted">?¯æ´ .xlsx / .csv (ç¬¬ä?å¼µå·¥ä½œè¡¨)</span>
          </div>

          <div class="form-group" style="margin-top: 1rem; max-width: 400px;">
              <label for="product-search">?œå? Barcode</label>
              <input type="text" id="product-search" placeholder="è¼¸å…¥ Barcode ??Enter...">
          </div>
          <table id="products-table" style="margin-top:1rem;">
              <thead>
                  <tr><th>SKU</th><th>Barcode</th><th>?ç¨±</th><th>?®åƒ¹</th><th>åº«å?</th><th>?ç?</th></tr>
              </thead>
              <tbody></tbody>
          </table>

          <h3 style="margin-top:2rem;">?°å??†å? (Q5)</h3>
          <form id="new-product-form" style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div class="form-group"><label>SKU (?¯ä?)</label><input type="text" id="p_sku" required></div>
              <div class="form-group"><label>Barcode</label><input type="text" id="p_barcode"></div>
              <div class="form-group" style="grid-column: 1 / -1;"><label>?ç¨±</label><input type="text" id="p_name" required></div>
              <div class="form-group"><label>?®åƒ¹</label><input type="number" id="p_price_live" value="0"></div>
              <div class="form-group"><label>?æœ¬</label><input type="number" id="p_cost" value="0"></div>
              <div class="form-group"><label>åº«å?</label><input type="number" id="p_stock_on_hand" value="0"></div>
              <div class="form-group" style="align-self: end;"><button id="create-product-btn" type="submit" class="small">?°å??†å?</button></div>
          </form>
          <p id="product-status"></p>
      </div>

      <div id="tab-shipping" class="tab-content">
          <h2>?ºè²¨ç®¡ç? (?±æ??‰æ?ç±?</h2>
          <button id="load-shipping">è¼‰å…¥å¾…å‡ºè²¨è???/button>
          <button id="export-cod" class="btn-secondary small">?¯å‡º 7-11 è²¨ä? (CSV)</button>
          <button id="export-mail" class="btn-secondary small">?¯å‡º ?µå? (CSV)</button>
          <button id="batch-ship" class="btn-ship small">ä¸€?µæ?è¨˜ã€Œå‹¾?¸ã€ç‚ºå·²å‡ºè²?/button>
          <button id="export-zero-packages" class="btn-secondary small" style="background-color: #ffc107; color: black;">?¯å‡º 0 ?ƒå?è£?/button>
          <p style="margin-top:8px;" class="muted">(v6.1) ?é?ï¼šã€Œç?å¾…è???ä»˜æ¬¾?ç?è¨‚å–®ï¼Œè??³ã€Œå?è¡¨æ¿?ç¢ºèªã€‚ç¢ºèªå?ï¼Œè??®ç??‹è??ºã€Œç?å¾…å¡«å¯«ç‰©æµã€ï?å®¢äººå¡«å¯«å®Œç•¢å¾Œæ??ƒå‡º?¾åœ¨æ­¤è???/p>
          <div id="shipping-labels"></div>
      </div>

      <div id="tab-reports" class="tab-content">
          <h2>ç¸½è??®å ±è¡?(Q6)</h2>
          <div class="form-group" style="display: flex; gap: 1rem; align-items: flex-end;">
              <div><label>?‹å??¥æ?</label><input type="date" id="report-start"></div>
              <div><label>çµæ??¥æ?</label><input type="date" id="report-end"></div>
              <button id="load-report" class="small">è¼‰å…¥?±è¡¨</button>
              <button id="export-report" class="btn-secondary small">?¯å‡ºç¸½è¡¨ (CSV)</button>
          </div>
          <div style="overflow-x: auto;">
              <table id="report-table">
                  <thead>
                      <tr><th>?¥æ?</th><th>ä¸»æ’­</th><th>è¨‚å–®??/th><th>?€??/th><th>?‘é?</th><th>ä»˜æ¬¾?¹å?</th><th>?‹è²»</th><th>?®è?</th><th>?¼ç¥¨</th><th>?¶ä»¶äº?/th><th>?‹æ?</th><th>?°å?/?€å¸?/th></tr>
                  </thead>
                  <tbody></tbody>
              </table>
          </div>
      </div>
  </div>

  <form id="e-map-form" method="POST" action="https://emap.presco.com.tw/c2cemap.ashx" class="hidden">
      <input type="hidden" name="eshopid" value="870" /> <input type="hidden" name="servicetype" value="1" />
      <input type="hidden" name="url" id="e-map-callback-url" />
  </form>

<script>
/*
  å®Œæ•´ admin.htmlï¼ˆç°¡?–ç?ï¼‰ï?
  - è«‹ç¢ºä¿?API_ENDPOINT è¨­ç‚ºä½ ç? Worker URL
  - OP_KEY ?è¨­?ºç©ºå­—ä¸²ï¼ˆå??¨ï?ï¼Œä??¯åœ¨?¬åœ°æ¸¬è©¦?‚æ”¹??'88'
*/
document.addEventListener('DOMContentLoaded', () => {
  // ---------- ?ç½®ï¼ˆä?è¦æ”¹?™è£¡ï¼?----------
  const API_ENDPOINT = 'https://murain-api.smile650170703.workers.dev';
  let OP_KEY = ''; // <- ?ºå??¨ï??è¨­ç©ºã€‚æ¸¬è©¦æ??¯æ”¹??'88'ï¼Œä?ä¸Šç??è?æ¸…ç©º??
  // ---------------------------------------

  // --- ?ºæœ¬ helper
  function jfetch(endpoint, payload = {}) {
    if (!payload) payload = {};
    if (OP_KEY && !payload.op_key) payload.op_key = OP_KEY;
    return fetch(`${API_ENDPOINT}${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }).then(async res => {
      let data;
      try { data = await res.json(); } catch(e) { throw new Error('Non-JSON response'); }
      if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
      return data;
    });
  }

  function fmtDate(iso){ if(!iso) return ''; try { return new Date(iso).toLocaleString('zh-TW'); } catch(e){ return iso; } }
  function translateStatus(s){
    if(!s) return '';
    const map = { awaiting_payment:'å¾…ä?æ¬?, awaiting_deposit_proof:'å¾…ç¢ºèªè???, paid:'å·²ä?æ¬?, shipped:'å·²å‡ºè²?, cancelled:'å·²å?æ¶?, deleted:'å·²åˆª??, draft:'?‰ç¨¿' };
    return map[(s||'').toLowerCase()] || s;
  }

  // --- UI ?ƒä»¶
  const loginBtn = document.getElementById('loginBtn');
  const loginStatus = document.getElementById('login-status');
  const loginBox = document.getElementById('login-box');
  const adminPanel = document.getElementById('admin-panel');

  // debug quick diagnostic
  console.log('=== quick admin UI diagnostic ===');
  console.log('document.location:', location.href);
  console.log('API_ENDPOINT (should be worker):', API_ENDPOINT);
  console.log('OP_KEY (global?)', OP_KEY);

  // --- ?»å…¥
  if (loginBtn) {
    loginBtn.addEventListener('click', async () => {
      const key = document.getElementById('op_key').value.trim();
      if (!key) { loginStatus.textContent = 'è«‹è¼¸?¥å?ç¢?; return; }
      OP_KEY = key;
      loginStatus.textContent = '?»å…¥ä¸?..';
      try {
        await jfetch('/admin/dashboard', { op_key: key });
        loginStatus.textContent = '?»å…¥?å?';
        loginBox.classList.add('hidden');
        adminPanel.classList.remove('hidden');
        // è¨­å?ä»Šå¤©?ºå ±è¡¨æ—¥?Ÿé?è¨?
        const today = new Date().toISOString().split('T')[0];
        const rs = document.getElementById('report-start');
        const re = document.getElementById('report-end');
        if (rs) rs.value = today;
        if (re) re.value = today;
        loadDashboard();
      } catch (e) {
        console.error('[login error]', e);
        loginStatus.textContent = 'å¯†é‘°?¯èª¤?–ä¼º?å™¨?¡å???;
        OP_KEY = '';
      }
    });
  }

  // --- tabs
  document.querySelectorAll('.tab-link').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-link').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.dataset.tab;
      const target = document.getElementById(id);
      if (target) target.classList.add('active');
      if (id === 'tab-dashboard') loadDashboard();
      if (id === 'tab-products') loadProducts();
      if (id === 'tab-shipping') loadShipping();
      if (id === 'tab-reports') loadReport();
    });
  });

  // ================== DASHBOARD ==================
  document.getElementById('refresh-dashboard').addEventListener('click', loadDashboard);
  document.getElementById('dashboard-select-all').addEventListener('change', (e) => {
    const checked = e.target.checked;
    document.querySelectorAll('#dashboard-table tbody input[data-order-id]').forEach(cb => cb.checked = checked);
  });
  document.getElementById('bulk-delete-btn').addEventListener('click', async () => {
    const selected = Array.from(document.querySelectorAll('#dashboard-table tbody input[data-order-id]:checked')).map(i => i.dataset.orderId);
    if (!selected.length) { alert('è«‹å??¾é¸æ¬²åˆª?¤ç?è¨‚å–®'); return; }
    const pwd = prompt('è«‹è¼¸?¥ç®¡?†å?ç¢¼ä»¥ç¢ºè??ªé™¤ï¼ˆæ­¤?•ä??ƒé??Ÿé??™åº«å­˜ï?');
    if (!pwd) return;
    try {
      for (const id of selected) {
        await jfetch('/admin/delete-order', { op_key: pwd, order_id: id });
      }
      alert('å·²åˆª?¤é¸?–è???);
      loadDashboard();
    } catch (e) {
      console.error(e);
      alert('?ªé™¤å¤±æ?ï¼? + e.message);
    }
  });

  async function loadDashboard(){
    const tbody = document.querySelector('#dashboard-table tbody');
    if (tbody) tbody.innerHTML = '<tr><td colspan="12">è¼‰å…¥ä¸?..</td></tr>';
    try {
      const data = await jfetch('/admin/dashboard', {});
      const rows = (data.orders || []).filter(o => !['deleted'].includes((o.status||'').toLowerCase()));
      if (!rows.length) {
        if (tbody) tbody.innerHTML = '<tr><td colspan="12">æ²’æ?è¨‚å–®</td></tr>';
        return;
      }
      if (tbody) {
        tbody.innerHTML = rows.map(o => {
          return `<tr>
            <td><input type="checkbox" data-order-id="${o.order_id}"></td>
            <td>${fmtDate(o.created_at)}</td>
            <td>${o.streamer_name || ''}</td>
            <td>${o.order_id}</td>
            <td>${translateStatus(o.status)}</td>
            <td>${(o.deposit_proof || '').slice(-5)}</td>
            <td>${o.total_amount || 0}</td>
            <td>${o.payment_method || ''}</td>
            <td>${o.shipping_cost || 0}</td>
            <td>${o.tracking_number || ''}</td>
            <td>${o.gift_notes || ''}</td>
          </tr>`;
        }).join('');
      }
    } catch (e) {
      console.error('[loadDashboard]', e);
      if (tbody) tbody.innerHTML = `<tr><td colspan="12">è¼‰å…¥å¤±æ?: ${String(e.message||e)}</td></tr>`;
    }
  }

  // ================== PRODUCTS ==================
  document.getElementById('refresh-products').addEventListener('click', loadProducts);
  document.getElementById('upload-inventory-btn').addEventListener('click', onUploadInventory);
  document.getElementById('product-search').addEventListener('keydown', async (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const v = e.target.value.trim();
      if (!v) { loadProducts(); return; }
      try {
        // search by barcode
        const all = await jfetch('/admin/products', { action: 'search' });
        const found = (all.products || []).filter(p => (p.barcode||'').toString().includes(v) || (p.sku||'').toString().includes(v));
        renderProducts(found);
      } catch (err) { console.error(err); alert('?œå?å¤±æ?'); }
    }
  });

  document.getElementById('create-product-btn').addEventListener('click', async (e) => {
    e.preventDefault();
    const p = {
      sku: document.getElementById('p_sku').value.trim(),
      barcode: document.getElementById('p_barcode').value.trim(),
      name: document.getElementById('p_name').value.trim(),
      price_live: Number(document.getElementById('p_price_live').value||0),
      cost: Number(document.getElementById('p_cost').value||0),
      stock_on_hand: Number(document.getElementById('p_stock_on_hand').value||0)
    };
    if (!p.sku) { alert('è«‹è¼¸??SKU'); return; }
    try {
      await jfetch('/admin/products', { action: 'create', product: p });
      document.getElementById('product-status').textContent = '?°å??å?';
      loadProducts();
    } catch (e) {
      console.error(e); alert('?°å?å¤±æ?: ' + e.message);
    }
  });

  async function loadProducts(){
    const tbody = document.querySelector('#products-table tbody');
    if (tbody) tbody.innerHTML = '<tr><td colspan="7">è¼‰å…¥ä¸?..</td></tr>';
    try {
      const data = await jfetch('/admin/products', { action: 'search' });
      const prods = data.products || [];
      renderProducts(prods);
    } catch (e) {
      console.error('[loadProducts]', e);
      if (tbody) tbody.innerHTML = `<tr><td colspan="7">è¼‰å…¥å¤±æ?: ${String(e.message||e)}</td></tr>`;
    }
  }
  function renderProducts(list){
    const tbody = document.querySelector('#products-table tbody');
    if (!tbody) return;
    if (!list || !list.length) { tbody.innerHTML = '<tr><td colspan="7">æ²’æ??†å?</td></tr>'; return; }
    tbody.innerHTML = list.map(p => `<tr>
      <td>${p.sku}</td><td>${p.barcode||''}</td><td>${p.name||''}</td><td>${p.price_live||0}</td><td>${p.stock_on_hand||0}</td><td>${p.stock_reserved||0}</td>
    </tr>`).join('');
  }

  // ä¸Šå‚³ Excel/CSV (ä½¿ç”¨ xlsx lib)
  async function onUploadInventory(){
    const f = document.getElementById('inventory-file').files[0];
    if (!f) { alert('è«‹å??¸æ?æª”æ?'); return; }
    try {
      const buf = await f.arrayBuffer();
      const wb = XLSX.read(new Uint8Array(buf), { type: 'array' });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
      if (!json || !json.length) { alert('æª”æ?æ²’æ?è³‡æ?'); return; }
      // map to expected fields: sku, barcode, name, price_live, cost, stock_on_hand
      const rows = json.map(r => ({
        sku: (r.sku || r.SKU || r.Sku || r['?†å?ç·¨è?'] || '').toString(),
        barcode: r.barcode || r.BARCODE || r.Barcode || r['æ¢ç¢¼'] || '',
        name: r.name || r.NAME || r.Name || r['?ç¨±'] || '',
        price_live: Number(r.price_live || r.price || r['?®åƒ¹'] || 0),
        cost: Number(r.cost || r.Cost || r['?æœ¬'] || 0),
        stock_on_hand: Number(r.stock_on_hand || r.stock || r['åº«å?'] || 0)
      })).filter(x => x.sku);
      if (!rows.length) { alert('?¾ä??°æ???SKU'); return; }
      const confirmUpload = confirm(`å°‡ä???${rows.length} ç­†è??™ã€‚ç¢ºå®šï?`);
      if (!confirmUpload) return;
      const res = await jfetch('/admin/upload-inventory', { rows });
      alert('ä¸Šå‚³å®Œæ?ï¼Œè??? ' + (res.rows_processed||0));
      loadProducts();
    } catch (e) {
      console.error('[upload inventory]', e);
      alert('ä¸Šå‚³å¤±æ?: ' + e.message);
    }
  }

  // ================== SHIPPING (stub / minimal) ==================
  document.getElementById('load-shipping').addEventListener('click', loadShipping);
  async function loadShipping(){
    // ?®å??…ç¤ºç¯„ï??¼å« /admin/dashboard ??status ??awaiting_shipping_info ?„è??®ï??–ä?ä½ é?æ±‚æ”¹
    const labels = document.getElementById('shipping-labels');
    if (labels) labels.innerHTML = 'è¼‰å…¥ä¸?..';
    try {
      const data = await jfetch('/admin/dashboard', {});
      const orders = (data.orders || []).filter(o => (o.status||'').toLowerCase() === 'awaiting_shipping_info');
      if (!orders.length) { if (labels) labels.innerHTML = '<p>æ²’æ?å¾…å‡ºè²¨è???/p>'; return; }
      if (labels) labels.innerHTML = orders.map(o => `<div class="label"><h3>${o.order_id}</h3><div>?¶ä»¶äº? ${(o.shipping_info && o.shipping_info.name) || ''}</div><div>?‹è²»: ${o.shipping_cost||0}</div></div>`).join('');
    } catch (e) {
      console.error('[loadShipping]', e);
      if (labels) labels.innerHTML = '<p>è¼‰å…¥å¤±æ?: ' + e.message + '</p>';
    }
  }

  // ================== REPORTS ==================
  document.getElementById('load-report').addEventListener('click', loadReport);
  async function loadReport(){
    const start = document.getElementById('report-start').value;
    const end = document.getElementById('report-end').value;
    const tbody = document.querySelector('#report-table tbody');
    if (tbody) tbody.innerHTML = '<tr><td colspan="12">è¼‰å…¥ä¸?..</td></tr>';
    if (!start || !end) { if (tbody) tbody.innerHTML = '<tr><td colspan="12">è«‹é¸?‡æ—¥??/td></tr>'; return; }
    try {
      const res = await jfetch('/admin/export-orders', { start_date: start, end_date: end });
      const rows = res.orders || [];
      if (!rows.length) { if (tbody) tbody.innerHTML = '<tr><td colspan="12">æ²’æ?è³‡æ?</td></tr>'; return; }
      if (tbody) {
        tbody.innerHTML = rows.map(o => `<tr>
          <td>${fmtDate(o.created_at)}</td><td>${o.streamer_name||''}</td><td>${o.order_id}</td><td>${translateStatus(o.status)}</td><td>${o.total_amount||0}</td><td>${o.payment_method||''}</td><td>${o.shipping_cost||0}</td><td>${o.tracking_number||''}</td><td>${o.invoice_no||''}</td><td>${(o.shipping_info && o.shipping_info.name) || ''}</td><td>${(o.shipping_info && o.shipping_info.phone) || ''}</td><td>${(o.shipping_info && (o.shipping_info.address || o.shipping_info.store_name)) || ''}</td>
        </tr>`).join('');
      }
    } catch (e) {
      console.error('[loadReport]', e);
      if (tbody) tbody.innerHTML = `<tr><td colspan="12">è¼‰å…¥å¤±æ?: ${String(e.message||e)}</td></tr>`;
    }
  }

  // ================== ?²æ­¢?ªå?ç¾©éŒ¯èª?(stub safety) ==================
  // (?¥ä?å·²ç??¨åˆ¥?•å¯¦ä½œé€™ä??½å?ï¼Œå¯ä»¥ç§»?¤ä??¢ä???stub)
  window.loadProducts = window.loadProducts || loadProducts;
  window.loadShipping = window.loadShipping || loadShipping;
  window.loadReport = window.loadReport || loadReport;

  // ?ªå??µæ¸¬?¯å¦å·²ç™»?¥ï?å¦‚æ? OP_KEY ?å??‰å€¼ï?
  if (OP_KEY) {
    // ?—è©¦??OP_KEY é©—è?ä¸€æ¬?
    jfetch('/admin/dashboard', {}).then(() => {
      loginBox.classList.add('hidden');
      adminPanel.classList.remove('hidden');
      loadDashboard();
    }).catch(e => console.log('[auto-auth failed]', e.message||e));
  }
});
</script>

</body>
</html>
