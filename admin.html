<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MURAIN — 管理後台 (v6.1 - Admin UI) - Fixed</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background-color: #f9f9f9; }
    .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
    .login-box { max-width: 500px; margin: 2rem auto; background: #fff; border-radius: 8px; padding: 2rem; }
    .tabs { display: flex; border-bottom: 1px solid #ccc; flex-wrap: wrap; gap:6px; }
    .tab-link { padding: 1rem 1.5rem; cursor: pointer; border: none; background: #eee; font-size: 1rem; }
    .tab-link.active { background: #fff; border: 1px solid #ccc; border-bottom: 1px solid #fff; position: relative; top: 1px; }
    .tab-content { display: none; background: #fff; padding: 2rem; border: 1px solid #ccc; border-top: none; }
    .tab-content.active { display: block; }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; word-wrap: break-word; }
    th { background-color: #f4f4f4; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
    button { font-size: 1rem; padding: 10px 16px; border: none; background-color: #007aff; color: white; border-radius: 8px; cursor: pointer; margin-right: 10px; }
    button:disabled { background-color: #ccc; cursor: default; }
    .btn-secondary { background-color: #6c757d; }
    .btn-ship { background-color: #28a745; font-size: 0.9rem; padding: 8px 12px; }
    .btn-cancel { background-color: #dc3545; font-size: 0.9rem; padding: 8px 12px; }
    .btn-confirm { background-color: #ffc107; color: black; font-size: 0.9rem; padding: 8px 12px; }
    .btn-edit { background-color: #0dcaf0; color: black; font-size: 0.9rem; padding: 8px 12px; }
    #status { margin-top: 1rem; font-weight: bold; }
    .hidden { display: none; }
    .label { width: 10cm; height: 15cm; border: 1px dashed #999; padding: 10px; box-sizing: border-box; margin: 1rem auto; page-break-after: always; overflow: hidden; background: #fff; }
    .label h3 { margin-top: 0; border-bottom: 2px solid #000; padding-bottom: 5px; }
    .label .section { margin-bottom: 10px; }
    .label .section strong { font-size: 1.2rem; display: block; }
    .label .section span { font-size: 1.1rem; }
    .label .gift-notes { border-top: 1px solid #ccc; padding-top: 10px; margin-top: 10px; background: #fdfdea; }
    @media print { body { margin: 0; } .container, .login-box { display: none; } #shipping-labels { display: block !important; } .label { border: none; margin: 0; } .btn-ship, .btn-cancel, .btn-confirm, .btn-edit { display: none; } }

    /* small helpers */
    .flex { display:flex; gap:8px; align-items:center; }
    .muted { color:#666; font-size:0.9rem; }
    .small { font-size:0.9rem; padding:6px 10px; }
  </style>
  <!-- SheetJS for Excel parsing (kept as original) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>

  <!-- Login -->
  <div class="login-box" id="login-box">
      <h2>管理後台</h2>
      <div class="form-group">
          <label for="op_key">請輸入主播/管理員密碼</label>
          <input type="password" id="op_key" placeholder="管理密碼 (登入用)">
      </div>
      <button id="loginBtn">登入</button>
      <p id="login-status"></p>
  </div>

  <!-- Confirm Modal (共用) -->
  <div id="confirmModal" style="display:none; position:fixed; left:0;right:0;top:0;bottom:0;
       background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:9999;">
    <div style="background:#fff;padding:18px;border-radius:8px; width:420px; max-width:95%;">
      <h3 id="confirmTitle">請輸入管理密碼確認</h3>
      <input id="confirmInput" type="password" placeholder="管理密碼" style="width:100%; padding:8px; margin:8px 0;">
      <div style="font-size:0.9rem; color:#666; margin-bottom:8px;" id="confirmHint"></div>
      <div style="text-align:right;">
        <button id="confirmCancel" type="button" class="small btn-secondary">取消</button>
        <button id="confirmOk" type="button" class="small">確認</button>
      </div>
    </div>
  </div>

  <!-- Admin Panel -->
  <div class="container hidden" id="admin-panel">
      <div class="tabs">
          <button class="tab-link active" data-tab="tab-dashboard">儀表板 (訂單)</button>
          <button class="tab-link" data-tab="tab-products">庫存管理</button>
          <button class="tab-link" data-tab="tab-shipping">出貨管理 (熱感應)</button>
          <button class="tab-link" data-tab="tab-reports">總訂單報表 (Q6)</button>
      </div>

      <!-- Dashboard tab -->
      <div id="tab-dashboard" class="tab-content active">
        <h2>儀表板 (近 7 天訂單)</h2>
        <button id="refresh-dashboard">重新整理</button>
        <div style="overflow-x: auto; margin-top: 12px;">
          <table id="dashboard-table">
            <thead>
              <tr>
                <th>日期</th><th>主播</th><th>訂單號</th><th>狀態</th><th>後五碼</th>
                <th>金額</th><th>付款方式</th><th>運費(Q5)</th><th>單號(Q7)</th><th>備註</th><th>動作</th>
              </tr>
            </thead>
            <tbody><tr><td colspan="11">尚未載入（請先登入）</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- Products tab (kept) -->
      <div id="tab-products" class="tab-content">
          <h2>庫存管理</h2>
          <div class="flex" style="margin-bottom:8px;">
            <button id="refresh-products" class="small">重新整理庫存</button>
            <div class="muted">| 支援 CSV / XLSX 上傳</div>
          </div>
          <div style="margin-top:6px; display:flex; gap:8px; align-items:center;">
            <input type="file" id="inventory-file" accept=".xlsx,.xls,.csv" />
            <button id="upload-inventory-btn" class="btn-secondary small">一鍵上傳 Excel (上傳庫存)</button>
            <span class="muted">支援 .xlsx / .csv (第一張工作表)</span>
          </div>
          <div class="form-group" style="margin-top: 1rem; max-width: 400px;">
              <label for="product-search">搜尋 Barcode</label>
              <input type="text" id="product-search" placeholder="輸入 Barcode 按 Enter...">
          </div>
          <table id="products-table" style="margin-top:1rem;">
              <thead>
                  <tr><th>SKU</th><th>Barcode</th><th>名稱</th><th>售價</th><th>庫存</th><th>預留</th><th>操作</th></tr>
              </thead>
              <tbody></tbody>
          </table>
      </div>

      <!-- Shipping tab (kept) -->
      <div id="tab-shipping" class="tab-content">
          <h2>出貨管理 (熱感應標籤)</h2>
          <button id="load-shipping">載入待出貨訂單</button>
          <button id="export-cod" class="btn-secondary small">匯出 7-11 貨付 (CSV)</button>
          <button id="export-mail" class="btn-secondary small">匯出 郵寄 (CSV)</button>
          <button id="batch-ship" class="btn-ship small">一鍵標記「勾選」為已出貨</button>
          <button id="export-zero-packages" class="btn-secondary small" style="background-color: #ffc107; color: black;">匯出 0 元包裹</button>
          <div id="shipping-labels"></div>
      </div>

      <!-- Reports tab (kept) -->
      <div id="tab-reports" class="tab-content">
          <h2>總訂單報表 (Q6)</h2>
          <div class="form-group" style="display: flex; gap: 1rem; align-items: flex-end;">
              <div><label>開始日期</label><input type="date" id="report-start"></div>
              <div><label>結束日期</label><input type="date" id="report-end"></div>
              <button id="load-report" class="small">載入報表</button>
              <button id="export-report" class="btn-secondary small">匯出總表 (CSV)</button>
          </div>
          <div style="overflow-x: auto;">
              <table id="report-table">
                  <thead>
                      <tr><th>日期</th><th>主播</th><th>訂單號</th><th>狀態</th><th>金額</th><th>付款方式</th><th>運費</th><th>單號</th><th>發票</th><th>收件人</th><th>手機</th><th>地址/門市</th></tr>
                  </thead>
                  <tbody></tbody>
              </table>
          </div>
      </div>
  </div>

  <!-- e-map form (hidden) -->
  <form id="e-map-form" method="POST" action="https://emap.presco.com.tw/c2cemap.ashx" class="hidden">
      <input type="hidden" name="eshopid" value="870" /> <input type="hidden" name="servicetype" value="1" />
      <input type="hidden" name="url" id="e-map-callback-url" />
  </form>

<!-- Single script block (cleaned and robust) -->
<script>
/* ====== Configuration - change API_ENDPOINT if needed ====== */
const API_ENDPOINT = 'https://api.murain.tw'; // <- production backend; must include protocol
let OP_KEY = ''; // filled by login input (do NOT store real secrets in public files)

/* --- Helper: safe api call that checks HTTP status and content-type --- */
async function apiCall(endpoint, payload = {}) {
  if (!payload) payload = {};
  if (OP_KEY) payload.op_key = OP_KEY;
  const res = await fetch(API_ENDPOINT + endpoint, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    const txt = await res.text().catch(()=>'<no body>');
    console.error('API HTTP error', res.status, txt);
    throw new Error(`HTTP ${res.status}: ${txt}`);
  }

  const ct = (res.headers.get('content-type') || '').toLowerCase();
  if (!ct.includes('application/json')) {
    const txt = await res.text().catch(()=>'<no body>');
    console.warn('API returned non-JSON:', txt);
    throw new Error('Server did not return JSON (see console)');
  }

  const data = await res.json();
  if (data.error) throw new Error(data.error);
  return data;
}

/* --- Utilities --- */
function translateStatus(s) {
  const map = { draft:'草稿', awaiting_payment:'等待付款', awaiting_shipping_info:'等待填寫物流', awaiting_deposit_proof:'等待訂金', awaiting_cod_shipment:'待出貨', paid:'已付款', shipped:'已出貨', expired:'已過期', cancelled:'已取消' };
  return map[s] || s;
}
function fmt(iso){ if(!iso) return ''; try { return new Date(iso).toLocaleString(); } catch { return iso; } }

/* --- Dashboard: load & render --- */
async function loadDashboard() {
  const tbody = document.querySelector('#dashboard-table tbody');
  if (tbody) tbody.innerHTML = '<tr><td colspan="11">載入中…</td></tr>';
  try {
    const data = await apiCall('/admin/dashboard', {});
    const orders = data.orders || [];
    if (!orders.length) {
      if (tbody) tbody.innerHTML = '<tr><td colspan="11">近 7 天無訂單</td></tr>';
      return;
    }
    const rows = orders.map(o => {
      const depositLast5 = (o.deposit_proof || '').slice(-5);
      return `<tr data-order-id="${o.order_id}">
        <td>${fmt(o.created_at)}</td>
        <td>${o.streamer_name||''}</td>
        <td>${o.order_id}</td>
        <td>${translateStatus(o.status)}</td>
        <td>${depositLast5}</td>
        <td>${o.total_amount||0}</td>
        <td>${o.payment_method||''}</td>
        <td>${o.shipping_cost||0}</td>
        <td>${o.tracking_number||''}</td>
        <td>${o.gift_notes||''}</td>
        <td>
          ${(o.status==='awaiting_deposit_proof')?`<button class="btn-confirm small" data-id="${o.order_id}">✅ 確認訂金</button>`:''}
          ${(o.status!=='shipped'&&o.status!=='cancelled')?`<button class="btn-cancel small" data-id="${o.order_id}">取消訂單</button>`:''}
          <button class="btn-delete-order small" data-id="${o.order_id}" style="background:#dc3545;">刪除訂單</button>
        </td>
      </tr>`;
    }).join('');
    if (tbody) tbody.innerHTML = rows;
  } catch (e) {
    console.error('loadDashboard error', e);
    if (tbody) tbody.innerHTML = `<tr><td colspan="11">載入失敗: ${e.message}</td></tr>`;
    alert('載入訂單失敗（請看 Console）');
  }
}

/* --- Delete order --- */
async function deleteOrder(orderId) {
  if (!confirm(`確定刪除 ${orderId}？此操作無法回復`)) return;
  try {
    await apiCall('/admin/delete-order', { order_id: orderId });
    alert('刪除成功');
    await loadDashboard();
  } catch (e) { alert('刪除失敗: ' + e.message); console.error(e); }
}

/* --- Cancel order (calls backend cancel if exists) --- */
async function cancelOrder(orderId) {
  if (!confirm(`確定取消 ${orderId}？`)) return;
  try {
    await apiCall('/admin/cancel-order', { order_id: orderId });
    alert('已取消');
    await loadDashboard();
  } catch (e) { alert('取消失敗: ' + e.message); console.error(e); }
}

/* --- Event delegation for buttons --- */
document.addEventListener('click', (ev) => {
  const del = ev.target.closest('.btn-delete-order');
  if (del) { deleteOrder(del.dataset.id); return; }
  const cancelBtn = ev.target.closest('.btn-cancel');
  if (cancelBtn) { cancelOrder(cancelBtn.dataset.id); return; }
  const refresh = ev.target.closest('#refresh-dashboard');
  if (refresh) { loadDashboard(); return; }
});

/* --- Login flow --- */
document.getElementById('loginBtn')?.addEventListener('click', async () => {
  const v = document.getElementById('op_key').value.trim();
  if (!v) return alert('請輸入密碼');
  OP_KEY = v;
  try {
    // test call
    await apiCall('/admin/dashboard', {});
    document.getElementById('login-box').classList.add('hidden');
    document.getElementById('admin-panel').classList.remove('hidden');
    // set today's report dates
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('report-start').value = today;
    document.getElementById('report-end').value = today;
    await loadDashboard();
  } catch (e) {
    OP_KEY = '';
    alert('登入失敗: ' + e.message + '（請確認 op_key 與後端是否可連）');
  }
});

/* --- Tabs behavior --- */
document.querySelectorAll('.tab-link').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-link').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
    // optional: trigger load for tab
    if (btn.dataset.tab === 'tab-dashboard') loadDashboard();
  });
});

/* --- Init: if OP_KEY preset, auto load --- */
document.addEventListener('DOMContentLoaded', () => {
  if (OP_KEY) loadDashboard();
});
</script>

</body>
</html>
