<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MURAIN â€” ç®¡ç†å¾Œå° (v4)</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 0; background-color: #f9f9f9; }
        .container { max-width: 1200px; margin: 2rem auto; }
        .login-box { max-width: 500px; margin: 2rem auto; background: #fff; border-radius: 8px; padding: 2rem; }
        .tabs { display: flex; border-bottom: 1px solid #ccc; }
        .tab-link { padding: 1rem 1.5rem; cursor: pointer; border: none; background: #eee; font-size: 1rem; }
        .tab-link.active { background: #fff; border: 1px solid #ccc; border-bottom: 1px solid #fff; position: relative; top: 1px; }
        .tab-content { display: none; background: #fff; padding: 2rem; border: 1px solid #ccc; border-top: none; }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f4f4f4; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        button { font-size: 1rem; padding: 10px 16px; border: none; background-color: #007aff; color: white; border-radius: 8px; cursor: pointer; }
        button:disabled { background-color: #ccc; }
        #status { margin-top: 1rem; font-weight: bold; }
        .hidden { display: none; }
        .label { width: 10cm; height: 15cm; border: 1px dashed #999; padding: 10px; box-sizing: border-box; margin: 1rem auto; page-break-after: always; overflow: hidden; background: #fff; }
        .label h3 { margin-top: 0; border-bottom: 2px solid #000; padding-bottom: 5px; }
        .label .section { margin-bottom: 10px; }
        .label .section strong { font-size: 1.2rem; display: block; }
        .label .section span { font-size: 1.1rem; }
        .label .gift-notes { border-top: 1px solid #ccc; padding-top: 10px; margin-top: 10px; background: #fdfdea; }
        @media print { body { margin: 0; } .container, .login-box { display: none; } #shipping-labels { display: block !important; } .label { border: none; margin: 0; } }
    </style>
</head>
<body>

    <div class="login-box" id="login-box">
        <h2>ç®¡ç†å¾Œå°</h2>
        <div class="form-group">
            <label for="op_key">è«‹è¼¸å…¥ä¸»æ’­/ç®¡ç†å“¡å¯†ç¢¼</label>
            <input type="password" id="op_key">
        </div>
        <button id="loginBtn">ç™»å…¥</button>
        <p id="login-status"></p>
    </div>

    <div class="container hidden" id="admin-panel">
        <div class="tabs">
            <button class="tab-link active" data-tab="tab-dashboard">å„€è¡¨æ¿ (è¨‚å–®)</button>
            <button class="tab-link" data-tab="tab-products">åº«å­˜ç®¡ç†</button>
            <button class="tab-link" data-tab="tab-shipping">å‡ºè²¨ç®¡ç† (ç†±æ„Ÿæ‡‰)</button>
        </div>

        <div id="tab-dashboard" class="tab-content active">
            <h2>å„€è¡¨æ¿ (è¿‘ 24 å°æ™‚è¨‚å–®)</h2>
            <button id="refresh-dashboard">é‡æ–°æ•´ç†</button>
            <table id="dashboard-table">
                <thead>
                    <tr><th>è¨‚å–®è™Ÿ</th><th>ç‹€æ…‹</th><th>é‡‘é¡</th><th>ä»˜æ¬¾æ–¹å¼</th><th>å‚™è¨»</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="tab-products" class="tab-content">
            <h2>åº«å­˜ç®¡ç†</h2>
            <button id="refresh-products">é‡æ–°æ•´ç†åº«å­˜</button>
            <table id="products-table" style="margin-top:1rem;">
                <thead>
                    <tr><th>SKU</th><th>Barcode</th><th>åç¨±</th><th>å”®åƒ¹</th><th>åº«å­˜</th><th>é ç•™</th></tr>
                </thead>
                <tbody></tbody>
            </table>
            
            <h3 style="margin-top:2rem;">æ–°å¢å•†å“ (Q5)</h3>
            <form id="new-product-form" style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group"><label>SKU (å”¯ä¸€)</label><input type="text" id="p_sku" required></div>
                <div class="form-group"><label>Barcode</label><input type="text" id="p_barcode"></div>
                <div class="form-group" style="grid-column: 1 / -1;"><label>åç¨±</label><input type="text" id="p_name" required></div>
                <div class="form-group"><label>å”®åƒ¹</label><input type="number" id="p_price_live" value="0"></div>
                <div class="form-group"><label>æˆæœ¬</label><input type="number" id="p_cost" value="0"></div>
                <div class="form-group"><label>åº«å­˜</label><input type="number" id="p_stock_on_hand" value="0"></div>
                <div class="form-group" style="align-self: end;"><button type="submit">æ–°å¢å•†å“</button></div>
            </form>
            <p id="product-status"></p>
        </div>

        <div id="tab-shipping" class="tab-content">
            <h2>å‡ºè²¨ç®¡ç† (ç†±æ„Ÿæ‡‰æ¨™ç±¤)</h2>
            <button id="load-shipping">è¼‰å…¥å¾…å‡ºè²¨è¨‚å–®</button>
            <p>(è¼‰å…¥å¾Œï¼Œè«‹ä½¿ç”¨ç€è¦½å™¨çš„ã€Œåˆ—å°ã€åŠŸèƒ½ (Ctrl+P) ä¾†åˆ—å°æ¨™ç±¤)</p>
            <div id="shipping-labels">
                </div>
        </div>
    </div>

    <script>
        const API_ENDPOINT = 'https://murain-api.smile650170703.workers.dev';
        let OP_KEY = '';

        // --- ç™»å…¥é‚è¼¯ ---
        document.getElementById('loginBtn').addEventListener('click', () => {
            const key = document.getElementById('op_key').value;
            if (!key) {
                document.getElementById('login-status').textContent = 'è«‹è¼¸å…¥å¯†ç¢¼';
                return;
            }
            OP_KEY = key;
            document.getElementById('login-box').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            // è‡ªå‹•è¼‰å…¥å„€è¡¨æ¿
            loadDashboard();
        });

        // --- Tab åˆ‡æ›é‚è¼¯ ---
        document.querySelectorAll('.tab-link').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-link').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                button.classList.add('active');
                document.getElementById(button.dataset.tab).classList.add('active');
                
                // è‡ªå‹•è¼‰å…¥
                if (button.dataset.tab === 'tab-dashboard') loadDashboard();
                if (button.dataset.tab === 'tab-products') loadProducts();
                if (button.dataset.tab === 'tab-shipping') loadShipping();
            });
        });

        // --- å¾Œå° API å‘¼å« (v4) ---
        async function apiCall(endpoint, payload = {}) {
            payload.op_key = OP_KEY; // è‡ªå‹•å¸¶å…¥å¯†ç¢¼
            const res = await fetch(`${API_ENDPOINT}${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            return data;
        }
        
        async function apiCallGet(endpoint) {
             const res = await fetch(`${API_ENDPOINT}${endpoint}`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            return data;
        }

        // --- Q3: å„€è¡¨æ¿ ---
        document.getElementById('refresh-dashboard').addEventListener('click', loadDashboard);
        async function loadDashboard() {
            try {
                const data = await apiCall('/admin/dashboard');
                const tbody = document.getElementById('dashboard-table').getElementsByTagName('tbody')[0];
                tbody.innerHTML = ''; // æ¸…ç©º
                if (data.orders.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="5">è¿‘ 24 å°æ™‚ç„¡è¨‚å–®</td></tr>';
                }
                data.orders.forEach(o => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${o.order_id}</td>
                        <td>${o.status}</td>
                        <td>${o.total_amount}</td>
                        <td>${o.payment_method || ''}</td>
                        <td>${o.gift_notes || ''}</td>
                    `;
                });
            } catch (e) { alert('è¼‰å…¥è¨‚å–®å¤±æ•—: ' + e.message); }
        }

        // --- Q5: åº«å­˜ç®¡ç† ---
        document.getElementById('refresh-products').addEventListener('click', loadProducts);
        async function loadProducts() {
             try {
                // (v4) GET /admin/products (æˆ‘å€‘ v4 API è£¡ç”¨ GET)
                const res = await fetch(`${API_ENDPOINT}/admin/products`, {
                    method: 'GET', // GET ä¸éœ€ OP_KEY
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                
                const tbody = document.getElementById('products-table').getElementsByTagName('tbody')[0];
                tbody.innerHTML = '';
                if (data.products.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="6">è³‡æ–™åº«ä¸­æ²’æœ‰å•†å“</td></tr>';
                }
                data.products.forEach(p => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${p.sku}</td>
                        <td>${p.barcode}</td>
                        <td>${p.name}</td>
                        <td>${p.price_live}</td>
                        <td>${p.stock_on_hand}</td>
                        <td>${p.stock_reserved}</td>
                    `;
                });
            } catch (e) { alert('è¼‰å…¥åº«å­˜å¤±æ•—: ' + e.message); }
        }
        
        // Q5: æ–°å¢å•†å“
        document.getElementById('new-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const status = document.getElementById('product-status');
            try {
                const payload = {
                    sku: document.getElementById('p_sku').value,
                    barcode: document.getElementById('p_barcode').value,
                    name: document.getElementById('p_name').value,
                    price_live: parseInt(document.getElementById('p_price_live').value, 10),
                    cost: parseInt(document.getElementById('p_cost').value, 10),
                    stock_on_hand: parseInt(document.getElementById('p_stock_on_hand').value, 10)
                };
                if (!payload.sku || !payload.name) {
                    throw new Error('SKU å’Œåç¨±ç‚ºå¿…å¡«');
                }
                
                await apiCall('/admin/products', payload);
                status.textContent = 'æ–°å¢æˆåŠŸï¼';
                status.style.color = 'green';
                e.target.reset(); // æ¸…ç©ºè¡¨å–®
                loadProducts(); // é‡æ–°æ•´ç†åˆ—è¡¨
                
            } catch (e) { 
                status.textContent = 'æ–°å¢å¤±æ•—: ' + e.message;
                status.style.color = 'red';
            }
        });

        // --- Q6: å‡ºè²¨ç®¡ç† ---
        document.getElementById('load-shipping').addEventListener('click', loadShipping);
        async function loadShipping() {
            const btn = document.getElementById('load-shipping');
            const container = document.getElementById('shipping-labels');
            btn.disabled = true;
            container.innerHTML = '';
            
             try {
                const data = await apiCall('/admin/print-labels');
                if (!data.orders || data.orders.length === 0) {
                    container.innerHTML = '<h3>æ²’æœ‰æ‰¾åˆ°å¾…å‡ºè²¨çš„è¨‚å–®ã€‚</h3>';
                    return;
                }
                
                data.orders.forEach(order => {
                    let shipping = {};
                    try { shipping = JSON.parse(order.shipping_info || '{}'); } catch(e) {}
                    
                    let statusText = 'ä¸æ˜';
                    let shippingDest = 'N/A';
                    
                    if (order.status === 'awaiting_cod_shipment') { // 7-11 è²¨ä»˜
                         statusText = 'ğŸ“¦ 7-11 è²¨åˆ°ä»˜æ¬¾';
                         shippingDest = `${shipping.store_name || ''} (${shipping.store_address || 'åœ°å€æœªå¡«'})`;
                    } else if (order.status === 'awaiting_deposit_proof') { // å¾…ä»˜è¨‚é‡‘
                        statusText = `âš ï¸ å¾…ä»˜è¨‚é‡‘ (å¾Œäº”ç¢¼: ${order.deposit_proof || 'æœªå¡«'})`;
                        shippingDest = `${shipping.store_name || ''} (${shipping.store_address || 'åœ°å€æœªå¡«'})`;
                    } else if (order.status === 'paid') { // å·²ä»˜æ¬¾ (éƒµå¯„)
                        statusText = 'âœ… å·²ä»˜æ¬¾ (éƒµå¯„)';
                        shippingDest = `${shipping.address || 'åœ°å€æœªå¡«'}`;
                    }

                    const label = document.createElement('div');
                    label.className = 'label';
                    label.innerHTML = `
                        <h3>è¨‚å–®ï¼š${order.order_id}</h3>
                        <div class="section">
                            <strong>ç‹€æ…‹ï¼š${statusText}</strong>
                        </div>
                        <div class="section">
                            <strong>æ”¶ä»¶äººï¼š</strong>
                            <span>${shipping.name || 'N/A'} (${shipping.phone || 'N/A'})</span>
                        </div>
                        <div class="section">
                            <strong>å¯„é€ (${order.payment_method || 'N/A'})ï¼š</strong>
                            <span>${shippingDest}</span>
                        </div>
                        <div class="section gift-notes">
                            <strong>ä¸»æ’­å‚™è¨» (Q3)ï¼š</strong>
                            <span>${order.gift_notes || '(ç„¡)'}</span>
                        </div>
                        <div class="section">
                            <strong>ç™¼ç¥¨ (Q-ECPay)ï¼š</strong>
                            <span>${order.invoice_status || 'N/A'}: ${order.invoice_no || ''}</span>
                        </div>
                    `;
                    container.appendChild(label);
                });
             } catch (e) {
                alert('è¼‰å…¥å‡ºè²¨å–®å¤±æ•—: ' + e.message);
             } finally {
                btn.disabled = false;
             }
        }

    </script>
</body>
</html>