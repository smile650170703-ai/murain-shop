<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MURAIN â€” è¨‚å–®å¾Œå°ï¼ˆæ•´åˆç‰ˆï¼‰</title>
<style>
  *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC",Roboto}
  body{margin:0;background:#020617;color:#e2e8f0}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  h1{margin:0 0 6px;font-size:24px}

  /* æ–°ç‰ˆä¸Šæ–¹å·¥å…·åˆ—ï¼ˆå«å¿«é€Ÿ filter + æ—¥æœŸ/ç‹€æ…‹ + åŒ¯å‡ºï¼‰ */
  .toolbar-main{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:12px}
  .toolbar-left{flex:1;display:flex;flex-direction:column;gap:6px}
  .filter-group{display:flex;flex-wrap:wrap;gap:6px}
  .filter-btn{padding:7px 12px;border-radius:999px;border:1px solid rgba(148,163,184,.7);background:rgba(15,23,42,.9);color:#e5e7eb;font-size:13px;cursor:pointer}
  .filter-btn.active{background:#22d3ee;color:#0f172a;border-color:#22d3ee;box-shadow:0 8px 20px rgba(34,211,238,.35)}
  .small-btn{padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.7);background:transparent;color:#e5e7eb;font-size:12px;cursor:pointer}

  .filter-row{display:flex;flex-wrap:wrap;gap:6px;font-size:12px;align-items:flex-end;margin-top:2px}
  .filter-row .field{min-width:140px;flex:0 0 auto}
  .filter-row label{display:block;font-size:11px;margin:0 0 2px;color:#94a3b8}
  .filter-row input,
  .filter-row select{width:100%;padding:5px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.6);background:#020617;color:#e2e8f0;font-size:12px}

  .summary-row{font-size:12px;color:#cbd5f5;display:flex;flex-wrap:wrap;gap:10px;margin-top:2px}
  .summary-row span{white-space:nowrap}
  #msg{font-size:12px;color:#94a3b8;margin-top:2px}

  .layout{display:grid;grid-template-columns:minmax(0,0.9fr) minmax(0,1.1fr);gap:12px}
  @media (max-width:900px){.layout{grid-template-columns:1fr;}}

  .card{background:rgba(15,23,42,.95);border-radius:16px;border:1px solid rgba(148,163,184,.3);padding:10px;min-height:120px}
  #orderList{max-height:calc(100vh - 190px);overflow:auto}

  .order-row{padding:8px 10px;border-radius:12px;cursor:pointer;border:1px solid transparent;margin-bottom:6px;background:rgba(15,23,42,.95)}
  .order-row:hover{border-color:rgba(148,163,184,.8);background:rgba(15,23,42,1)}
  .order-row.active{border-color:#22d3ee;background:rgba(15,23,42,1);box-shadow:0 8px 20px rgba(34,211,238,.25)}

  .ord-top{display:flex;justify-content:space-between;align-items:center;gap:6px;font-size:13px}
  .ord-id{font-weight:600}
  .ord-amount{font-weight:600}
  .ord-sub{font-size:12px;color:#94a3b8;margin-top:3px}
  .badges{display:flex;flex-wrap:wrap;gap:4px;font-size:11px;margin-top:4px}
  .badge{padding:2px 7px;border-radius:999px;border:1px solid rgba(148,163,184,.7);background:rgba(15,23,42,1)}
  .badge.green{border-color:#22c55e;color:#bbf7d0;background:rgba(22,163,74,.2)}
  .badge.yellow{border-color:#eab308;color:#facc15;background:rgba(234,179,8,.15)}
  .badge.red{border-color:#f97373;color:#fecaca;background:rgba(220,38,38,.2)}
  .badge.blue{border-color:#38bdf8;color:#bae6fd;background:rgba(56,189,248,.2)}
  .muted{font-size:13px;color:#94a3b8}

  .detail-grid{display:grid;grid-template-columns:1.1fr 0.9fr;gap:10px}
  @media (max-width:900px){.detail-grid{grid-template-columns:1fr}}

  label{display:block;font-size:12px;margin:6px 0 3px;color:#cbd5f5}
  input,select,textarea{width:100%;padding:8px 9px;border-radius:10px;border:1px solid rgba(148,163,184,.6);background:#020617;color:#e2e8f0;font-size:13px}
  textarea{min-height:70px;resize:vertical}
  input:focus,select:focus,textarea:focus{outline:2px solid #38bdf8;outline-offset:1px;border-color:#38bdf8}
  .row{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
  .mt-2{margin-top:8px}
  .mt-3{margin-top:12px}
  .mt-4{margin-top:16px}
  .btn-primary{margin-top:8px;padding:10px 14px;border-radius:999px;border:none;background:#22d3ee;color:#0f172a;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 10px 30px rgba(34,211,238,.35)}
  .btn-secondary{margin-top:8px;padding:8px 12px;border-radius:999px;border:1px solid rgba(148,163,184,.7);background:transparent;color:#e5e7eb;font-size:13px;cursor:pointer}
  .section-title{font-size:13px;font-weight:600;color:#e5e7eb;margin-top:4px;margin-bottom:2px}
  .pill{display:inline-block;padding:3px 7px;border-radius:999px;background:rgba(15,23,42,1);border:1px solid rgba(148,163,184,.6);font-size:11px;color:#cbd5f5;margin-right:4px;margin-top:2px}
  .tag-small{font-size:11px;color:#94a3b8}
  .label-inline{display:flex;align-items:center;gap:5px;font-size:12px;margin-top:4px}
  .label-inline input[type="checkbox"]{width:auto}
  .error{color:#fecaca;font-size:13px;margin-top:4px}
</style>
</head>
<body>
<div class="wrap">
  <h1>è¨‚å–®å¾Œå°</h1>
  <div class="muted" style="margin-bottom:4px;">
    ä¸Šæ–¹ 4 é¡†æ˜¯å¿«é€Ÿåˆ†é¡ï¼›ä¸‹æ–¹å¯ä»¥ä¾ã€Œæ—¥æœŸï¼‹ç‹€æ…‹ã€è¼‰å…¥ä¸¦åŒ¯å‡º Excelã€‚
  </div>

  <div class="toolbar-main">
    <div class="toolbar-left">
      <div class="filter-group">
        <button class="filter-btn active" data-filter="all">å…¨éƒ¨è¨‚å–®</button>
        <button class="filter-btn" data-filter="pending_online">ç·šä¸Šä»˜æ¬¾å¾…ç¢ºèª</button>
        <button class="filter-btn" data-filter="ready_to_ship">å¾…å‡ºè²¨åˆ—å°</button>
        <button class="filter-btn" data-filter="deposit">ATM / è¨‚é‡‘</button>
      </div>

      <div class="filter-row">
        <div class="field">
          <label>èµ·å§‹æ—¥æœŸï¼ˆdate_fromï¼Œå«ï¼‰</label>
          <input id="date_from" type="date" />
        </div>
        <div class="field">
          <label>çµæŸæ—¥æœŸï¼ˆdate_toï¼Œå«ï¼‰</label>
          <input id="date_to" type="date" />
        </div>
        <div class="field">
          <label>ç‹€æ…‹ï¼ˆstatusï¼‰</label>
          <select id="status">
            <option value="">å…¨éƒ¨</option>
            <option value="submitted">submittedï¼ˆå·²é€å‡ºï¼‰</option>
            <option value="paid">paidï¼ˆå·²ä»˜æ¬¾ï¼‰</option>
            <option value="shipped">shippedï¼ˆå·²å‡ºè²¨ï¼‰</option>
            <option value="cancelled">cancelledï¼ˆå–æ¶ˆï¼‰</option>
          </select>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button class="small-btn" id="btnLoadByDate" type="button">ä¾æ—¥æœŸè¼‰å…¥</button>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button class="small-btn" id="btnQuickPaid" type="button">åªçœ‹å¾…å‡ºè²¨ï¼ˆpaidï¼‰</button>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button class="small-btn" id="exportBtn" type="button" disabled>åŒ¯å‡º Excelï¼ˆCSVï¼‰</button>
         </div>
        <div class="field">
          <label>&nbsp;</label>
          <button class="small-btn" id="btnRemindToday" type="button">ä»Šæ—¥å°¾æ¬¾æé†’</button>
        </div>
      </div>

      <div id="summary" class="summary-row"></div>
      <div id="msg"></div>
    </div>

    <div>
      <span id="opLabel" class="tag-small"></span>
      <button id="btnChangeKey" class="small-btn">æ›´æ›ç®¡ç†å¯†ç¢¼</button>
    </div>
  </div>

  <div class="layout">
    <div class="card" id="orderList">
      <div class="muted">è¼‰å…¥ä¸­â€¦</div>
    </div>

    <div class="card" id="orderDetail">
      <div class="muted">è«‹å¾å·¦é‚Šé»é¸ä¸€ç­†è¨‚å–®</div>
    </div>
  </div>
</div>

<script>
const API = (window.API_BASE || 'https://api.murain.tw').replace(/\/$/,'');
const STORAGE_KEY = 'MURAIN_ADMIN_OP_KEY';

let OP_KEY = localStorage.getItem(STORAGE_KEY) || '';
let currentFilter = 'all';
let currentOrders = [];
let currentRecord = null;

const $  = (s,r=document)=>r.querySelector(s);
const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));

function money(n){ return 'NT$ ' + Number(n||0).toLocaleString(); }
// è¨‚å–®ç‹€æ…‹è‹±æ–‡ä»£ç¢¼ â†’ ä¸­æ–‡
function displayOrderStatus(st){
  if (!st) return '';
  if (st === 'submitted') return 'å·²é€å‡ºï¼ˆæœªä»˜æ¬¾ï¼‰';
  if (st === 'paid')      return 'å·²ä»˜æ¬¾ï¼ˆå¾…å‡ºè²¨ï¼‰';
  if (st === 'shipped')   return 'å·²å‡ºè²¨';
  if (st === 'cancelled') return 'å·²å–æ¶ˆ';
  return st; // å…¶ä»–æœªçŸ¥ç‹€æ…‹å°±ç›´æ¥é¡¯ç¤ºåŸç¢¼
}

// ä»˜æ¬¾ç‹€æ…‹è‹±æ–‡ä»£ç¢¼ â†’ ä¸­æ–‡
function displayPayStatus(pay){
  if (!pay) return '';
  if (pay === 'paid_ok')                     return 'å·²æ”¶æ¬¾';
  if (pay === 'pending')                     return 'å¾…ä»˜æ¬¾';
  if (pay === 'deposit_ok' || pay === 'deposit') return 'å·²æ”¶è¨‚é‡‘';
  if (pay === 'unpaid')                      return 'æœªæ”¶æ¬¾';
  if (pay === 'failed')                      return 'å¤±æ•— / ä½œå»¢';
  return pay;
}

function displayPayStatus(ps){
  switch (ps) {
    case 'unpaid':  return 'æœªæ”¶æ¬¾';
    case 'pending': return 'å¾…ç¢ºèª';
    case 'paid_ok': return 'å·²æ”¶æ¬¾';
    case 'failed':  return 'å¤±æ•— / ä½œå»¢';
    default:        return ps || '';
  }
}
function parseShippingInfo(fields){
  try{
    return JSON.parse(fields.shipping_info || '{}') || {};
  }catch(e){
    return {};
  }
}
// ä»˜æ¬¾æ–¹å¼ä»£ç¢¼ â†’ ä¸­æ–‡åç¨±
function displayPaymentMethod(code){
  switch (code) {
    case 'cod_711':
      return '7-11 è²¨åˆ°ä»˜æ¬¾';
    case 'cod_post':
      return 'éƒµå±€è²¨åˆ°ä»˜æ¬¾';

    // ç·šä¸Šåˆ·å¡
    case 'paid_card_once':
      return 'ç·šä¸Šä»˜æ¬¾ï¼ä¿¡ç”¨å¡ä¸€æ¬¡ä»˜æ¸…';
    case 'paid_card_inst_3':
      return 'ç·šä¸Šä»˜æ¬¾ï¼ä¿¡ç”¨å¡ 3 æœŸ';
    case 'paid_card_inst_6':
      return 'ç·šä¸Šä»˜æ¬¾ï¼ä¿¡ç”¨å¡ 6 æœŸ';
    case 'paid_card_inst_9':
      return 'ç·šä¸Šä»˜æ¬¾ï¼ä¿¡ç”¨å¡ 9 æœŸ';

    // ä¸­ç§Ÿ / é›¶å¡åˆ†æœŸ
    case 'zero_card_3':
      return 'ä¸­ç§Ÿåˆ†æœŸ 3 æœŸ';
    case 'zero_card_6':
      return 'ä¸­ç§Ÿåˆ†æœŸ 6 æœŸ';
    case 'zero_card_9':
      return 'ä¸­ç§Ÿåˆ†æœŸ 9 æœŸ';
    case 'zero_card_12':
      return 'ä¸­ç§Ÿåˆ†æœŸ 12 æœŸ';
    case 'zero_card_18':
      return 'ä¸­ç§Ÿåˆ†æœŸ 18 æœŸ';
    case 'zero_card_24':
      return 'ä¸­ç§Ÿåˆ†æœŸ 24 æœŸ';

    // ATM / åŒ¯æ¬¾ï¼ˆè¨‚é‡‘ / å°¾æ¬¾ï¼‰
    case 'deposit_new_partial':
      return 'æ–°å®¢è¨‚é‡‘åŒ¯æ¬¾';
    case 'deposit_new_full':
      return 'æ–°å®¢å…¨é¡åŒ¯æ¬¾';
    case 'deposit_old_partial':
      return 'èˆŠå®¢è¨‚é‡‘åŒ¯æ¬¾';
    case 'deposit_old_full':
      return 'èˆŠå®¢å…¨é¡åŒ¯æ¬¾';

    case 'atm_full':
      return 'ATM å…¨é¡åŒ¯æ¬¾';
    case 'atm_deposit':
      return 'ATM è¨‚é‡‘åŒ¯æ¬¾';

    default:
      return code || '';
  }
}


function toDatetimeLocal(v){
  if(!v) return '';
  const d = new Date(v);
  if(isNaN(d.getTime())) return '';
  const pad = n => String(n).padStart(2,'0');
  return d.getFullYear() + '-' +
    pad(d.getMonth()+1) + '-' +
    pad(d.getDate()) + 'T' +
    pad(d.getHours()) + ':' +
    pad(d.getMinutes());
}

// CSV æ¬„ä½ escapeï¼ˆæ²¿ç”¨åŸ admin_ordersï¼‰
function escapeCSV(v){
  if (v == null) return '';
  const s = String(v);
  if (/[",\n]/.test(s)){
    return '"' + s.replace(/"/g,'""') + '"';
  }
  return s;
}

/* ===== OP_KEY é©—è­‰ ===== */
async function ensureOpKey(){
  $('#opLabel').textContent = OP_KEY ? 'å·²ç™»å…¥å¾Œå°' : 'å°šæœªç™»å…¥';
  while(!OP_KEY){
    const k = prompt('è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ (OP_KEY)');
    if(!k){ alert('æ²’æœ‰å¯†ç¢¼å°±ç„¡æ³•é€²å…¥å¾Œå°å–”'); continue; }
    try{
      const r = await fetch(`${API}/op/auth`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ op_key:k })
      });
      const j = await r.json();
      if(!r.ok || !j.ok){
        alert('å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡');
        continue;
      }
      OP_KEY = k;
      localStorage.setItem(STORAGE_KEY, OP_KEY);
      $('#opLabel').textContent = 'å·²ç™»å…¥å¾Œå°';
      break;
    }catch(e){
      console.error(e);
      alert('é©—è­‰å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  }
}

/* ===== ä¾ã€Œå¿«é€Ÿåˆ†é¡ filterã€è¼‰å…¥è¨‚å–®ï¼ˆåŸ admin.htmlï¼‰ ===== */
async function loadOrders(filter='all'){
  currentFilter = filter;
  const listEl = $('#orderList');
  listEl.innerHTML = '<div class="muted">è¼‰å…¥ä¸­â€¦</div>';
  $('#msg').textContent = '';

  try{
    const r = await fetch(
      `${API}/admin/orders?filter=${encodeURIComponent(filter)}&op_key=${encodeURIComponent(OP_KEY)}`
    );
    const j = await r.json();
    if(!r.ok || !j.ok){
      throw new Error(j.error || 'load_failed');
    }
    currentOrders = j.orders || j.records || [];
    renderOrderList();
  }catch(e){
    console.error(e);
    listEl.innerHTML = '<div class="error">è¼‰å…¥å¤±æ•—ï¼š' + (e.message || e) + '</div>';
    currentOrders = [];
    updateSummary();
  }
}

/* ===== ä¾ã€Œæ—¥æœŸ + statusã€è¼‰å…¥è¨‚å–®ï¼ˆåŸ admin_orders.html ç¸®å°ç‰ˆï¼‰ ===== */
async function loadOrdersByDate(){
  const listEl = $('#orderList');
  const msgEl  = $('#msg');
  listEl.innerHTML = '<div class="muted">è¼‰å…¥ä¸­â€¦</div>';
  msgEl.textContent = '';

  try{
    const params = new URLSearchParams();
    params.set('op_key', OP_KEY);
    const df = $('#date_from').value;
    const dt = $('#date_to').value;
    const st = $('#status').value;
    if (df) params.set('date_from', df);
    if (dt) params.set('date_to', dt);
    if (st) params.set('status', st);

    const r = await fetch(`${API}/admin/orders?` + params.toString());
    const j = await r.json();
    if (!r.ok || !j.ok){
      throw new Error(j.error || 'load_failed');
    }
    currentOrders = j.orders || j.records || [];
    renderOrderList();
    msgEl.textContent = currentOrders.length ? '' : 'æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„è¨‚å–®ã€‚';
  }catch(e){
    console.error(e);
    listEl.innerHTML = '<div class="error">è¼‰å…¥å¤±æ•—ï¼š' + (e.message || e) + '</div>';
    currentOrders = [];
    updateSummary();
  }
}

// å¿«é€Ÿï¼šåªçœ‹å¾…å‡ºè²¨ï¼ˆpaidï¼‰
async function quickPaid(){
  const sel = $('#status');
  if (sel) sel.value = 'paid';
  await loadOrdersByDate();
}

// æ›´æ–°ä¸‹æ–¹ summary + åŒ¯å‡ºæŒ‰éˆ•ç‹€æ…‹
function updateSummary(){
  const sumEl = $('#summary');
  const btnExport = $('#exportBtn');
  if (!sumEl || !btnExport) return;

  if (!currentOrders.length){
    sumEl.textContent = '';
    btnExport.disabled = true;
    return;
  }

  let sum = 0;
  let countSubmitted = 0, countPaid = 0, countShipped = 0, countCancelled = 0;

  for (const rec of currentOrders){
    const f = rec.fields || rec || {};
    sum += Number(f.total_amount || f.total || 0) || 0;
    const st = f.status || '';
    if (st === 'submitted') countSubmitted++;
    else if (st === 'paid') countPaid++;
    else if (st === 'shipped') countShipped++;
    else if (st === 'cancelled') countCancelled++;
  }

    const sumText = 'NT$ ' + (Number(sum)||0).toLocaleString('zh-TW',{minimumFractionDigits:0});
  sumEl.innerHTML =
    '<span>ç­†æ•¸ï¼š' + currentOrders.length +
    'ï¼ˆå·²é€å‡º: ' + countSubmitted +
    ' / å·²ä»˜æ¬¾: ' + countPaid +
    ' / å·²å‡ºè²¨: ' + countShipped +
    ' / å·²å–æ¶ˆ: ' + countCancelled + 'ï¼‰</span>' +
    '<span>åˆè¨ˆé‡‘é¡ï¼š' + sumText + '</span>';


  btnExport.disabled = false;
}

function exportCSV(){
  if (!ORDERS_CACHE.length){
    alert('ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºã€‚');
    return;
  }

  const rows = [];

  // æ¨™é¡Œåˆ—ï¼šåŠ ä¸Šã€Œè¨‚å–®ç‹€æ…‹ã€ã€Œä»˜æ¬¾ç‹€æ…‹ã€
  rows.push([
    'è¨‚å–®æ™‚é–“',
    'è¨‚å–®ç·¨è™Ÿ',
    'è¨‚å–®ç‹€æ…‹',
    'ä»˜æ¬¾ç‹€æ…‹',
    'ä»˜æ¬¾æ–¹å¼',
    'é‡‘é¡',
    'ç›´æ’­ä¸»',
    'å®¢æˆ¶é¡å‹',
    'ç‰©æµå–®è™Ÿ',
    'é‹è²»',
    'å‚™è¨»'
  ]);

  for (const o of ORDERS_CACHE){
    const created = (o.created_at || '')
      .replace('T',' ')
      .replace(/\.\d+Z?$/,'');

    rows.push([
      created,
      o.order_id || '',
      displayOrderStatus(o.status || ''),          // â† è¨‚å–®ç‹€æ…‹ï¼šä¸­æ–‡
      displayPayStatus(o.pay_status || ''),        // â† ä»˜æ¬¾ç‹€æ…‹ï¼šä¸­æ–‡
      displayPaymentMethod(o.payment_method || ''),// â† ä»˜æ¬¾æ–¹å¼ï¼šä¸­æ–‡
      Number(o.total_amount || 0),
      o.streamer_name || '',
      o.customer_type || '',
      o.tracking_no || '',
      Number(o.shipping_fee || 0),
      (o.note || '').replace(/\r?\n/g, ' ')
    ]);
  }

  const csv = rows
    .map(r => r.map(escapeCSV).join(','))
    .join('\r\n');

  // â˜… é‡é»ï¼šå‰é¢åŠ ä¸Š \ufeffï¼Œè®“ Excel ä¸æœƒè®Šäº‚ç¢¼
  const blob = new Blob(["\ufeff" + csv], {
    type: 'text/csv;charset=utf-8;'
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const now = new Date();
  const ts = now.toISOString().replace(/[:T]/g,'-').slice(0,16);

  a.href = url;
  a.download = 'murain_orders_' + ts + '.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}


function statusBadgePay(pay){
  if(!pay) return '';
  let cls = 'badge';
  let text = pay;
  if(pay === 'paid_ok'){ cls += ' green'; text = 'å·²æ”¶æ¬¾'; }
  else if(pay === 'pending'){ cls += ' yellow'; text = 'å¾…ç¢ºèª'; }
  else if(pay === 'unpaid'){ cls += ''; text = 'æœªæ”¶æ¬¾'; }
  else if(pay === 'failed'){ cls += ' red'; text = 'å¤±æ•—/ä½œå»¢'; }
  return `<span class="${cls}">${text}</span>`;
}
function displayPaymentMethod(pm){
  if (!pm) return '';
  if (pm === 'cod_711')          return '7-11 è²¨åˆ°ä»˜æ¬¾';
  if (pm === 'cod_post')         return 'éƒµå¯„è²¨åˆ°ä»˜æ¬¾';

  if (pm === 'paid_card_once')   return 'ç·šä¸Šä»˜æ¬¾ï¼ä¿¡ç”¨å¡ä¸€æ¬¡ä»˜æ¸…';
  if (pm && pm.startsWith('paid_card_inst_'))
    return 'ç·šä¸Šä»˜æ¬¾ï¼ä¿¡ç”¨å¡åˆ†æœŸ';
  if (pm === 'paid_linepay')     return 'ç·šä¸Šä»˜æ¬¾ï¼LINE Pay';
  if (pm === 'paid_af')          return 'ç·šä¸Šä»˜æ¬¾ï¼AFTEE å…ˆäº«å¾Œä»˜';

  if (pm && pm.startsWith('zero_card_'))
    return 'ä¸­ç§Ÿç„¡å¡åˆ†æœŸ';

  if (pm === 'atm_full_tail')    return 'å°¾æ¬¾ï¼ATM å…¨é¡åŒ¯æ¬¾';
  if (pm && pm.includes('atm'))  return 'ATM è½‰å¸³';
  if (pm && pm.includes('bank')) return 'éŠ€è¡ŒåŒ¯æ¬¾';

  return pm;
}

function statusBadgeShip(st){
  if(!st) return '';
  let cls = 'badge blue';
  let text = st;
  if(st === 'none'){ text = 'æœªè¨­å®š'; cls='badge'; }
  else if(st === 'ready_to_ship'){ text = 'å¾…å‡ºè²¨'; }
  else if(st === 'shipped'){ text = 'å·²å‡ºè²¨'; }
  else if(st === 'returned'){ text = 'é€€è²¨'; cls='badge red'; }
  else if(st === 'cancelled'){ text = 'å–æ¶ˆ'; cls='badge red'; }
  return `<span class="${cls}">${text}</span>`;
}

/* ===== å·¦å´åˆ—è¡¨æ¸²æŸ“ ===== */
function renderOrderList(){
  const listEl = $('#orderList');
  if(!currentOrders.length){
    listEl.innerHTML = '<div class="muted">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</div>';
    updateSummary();
    return;
  }

  const html = currentOrders.map(rec=>{
    const f = rec.fields || rec || {};

    const shipInfo = parseShippingInfo(f);
    const ship  = shipInfo.ship  || {};
    const store = ship.store     || {};
    const post  = ship.post      || {};

    let addr = '';
    if (ship.type === '711') {
      addr = `7-11 ${store.name || ''} (${store.id || ''}) ${store.addr || ''}`;
    } else if (ship.type === 'post') {
      addr = `éƒµå¯„ ${post.zip || ''} ${post.addr || ''}`;
    }

    const line2   = [ship.name, ship.phone, addr].filter(Boolean).join(' / ');
    const pay_b   = statusBadgePay(f.pay_status);
    const ship_b  = statusBadgeShip(f.ship_status);
    const method  = displayPaymentMethod(f.payment_method || '');
    const created = f.created_at     || '';
    const total   = money(f.total_amount || f.total || 0);

    const rowKey = f.order_id || rec.id || '';

    return `
      <div class="order-row" data-id="${rowKey}">
        <div class="ord-top">
          <div>
            <div class="ord-id">${f.order_id || '(ç„¡ç·¨è™Ÿ)'}</div>
            <div class="tag-small">${created}</div>
          </div>
          <div style="text-align:right">
            <div class="ord-amount">${total}</div>
            <div class="tag-small">${method}</div>
          </div>
        </div>
        <div class="ord-sub">${line2 || '&nbsp;'}</div>
        <div class="badges">
          ${pay_b}
          ${ship_b}
        </div>
      </div>
    `;
  }).join('');

  listEl.innerHTML = html;

  $$('#orderList .order-row').forEach(row=>{
    row.addEventListener('click', ()=>{
      $$('#orderList .order-row').forEach(x=>x.classList.remove('active'));
      row.classList.add('active');
      const key = row.getAttribute('data-id');
      selectOrder(key);
    });
  });

  if(currentRecord){
    const f = currentRecord.fields || currentRecord || {};
    const key = currentRecord.id || f.order_id || '';
    const row = $(`#orderList .order-row[data-id="${key}"]`);
    if(row){
      row.classList.add('active');
    }else{
      currentRecord = null;
      $('#orderDetail').innerHTML = '<div class="muted">è«‹å¾å·¦é‚Šé»é¸ä¸€ç­†è¨‚å–®</div>';
    }
  }

  updateSummary();
}

/* æ ¹æ“š key æ‰¾å‡ºè¨‚å–®ï¼ˆid æˆ– order_idï¼‰ */
function selectOrder(key){
  if(!key) return;
  const rec = currentOrders.find(x=>{
    if (x.id && String(x.id) === String(key)) return true;
    const f = x.fields || x || {};
    return f.order_id && String(f.order_id) === String(key);
  });
  if(!rec) return;
  renderDetail(rec);
}

/* ===== å‡ºè²¨é€šçŸ¥é è¨­æ–‡å­—ï¼ˆä¿ç•™åŸæœ¬ï¼‰ ===== */
function buildNoticeText(rec){
  const f = rec.fields || rec || {};
  const shipInfo = parseShippingInfo(f);
  const ship  = shipInfo.ship  || {};
  const store = ship.store     || {};
  const post  = ship.post      || {};
  const orderId = f.order_id || '';
  const total   = money(f.total_amount || f.total || 0);
  const name    = ship.name || 'è¦ªæ„›çš„å®¢äºº';

  let methodText = '';
  if(ship.type === '711'){
    methodText = `7-11 ${store.name || ''}ï¼ˆ${store.id || ''}ï¼‰`;
  }else if(ship.type === 'post'){
    methodText = `éƒµå¯„ ${post.zip || ''} ${post.addr || ''}`;
  }

  const today = new Date();
  const d = `${today.getFullYear()}/${today.getMonth()+1}/${today.getDate()}`;

  return `ã€MURAIN å‡ºè²¨é€šçŸ¥ã€‘

${name} æ‚¨å¥½ï½

æ‚¨çš„è¨‚å–® ${orderId} å·²æ–¼ ${d} å®‰æ’å‡ºè²¨ã€‚
å–è²¨æ–¹å¼ï¼š${methodText || 'â€”'}
æ‡‰ä»˜é‡‘é¡ï¼š${total}

åŒ…è£¹å¯„å‡ºå¾Œï¼Œå¯¦éš›åˆ°åº—/é€é”æ™‚é–“ä»ä»¥ç‰©æµç‚ºä¸»ï¼Œå¦‚æœ‰ä»»ä½•å•é¡Œéƒ½å¯ä»¥ç›´æ¥å›è¦†æ­¤è¨Šæ¯ï¼Œè¬è¬æ‚¨ğŸ’–`;
}

/* ===== å³å´è©³ç´°è³‡æ–™ ===== */
function renderDetail(rec){
  currentRecord = rec;
  const f   = rec.fields || rec || {};
  const dEl = $('#orderDetail');

  const shipInfo = parseShippingInfo(f);
  const ship  = shipInfo.ship  || {};
  const store = ship.store     || {};
  const post  = ship.post      || {};
  const note  = shipInfo.note  || '';

  const addrText = (()=>{
    if(ship.type === '711'){
      return `7-11 ${store.name || ''}ï¼ˆ${store.id || ''}ï¼‰\n${store.addr || ''}`;
    }
    if(ship.type === 'post'){
      return `${post.zip || ''} ${post.addr || ''}`;
    }
    return '';
  })();

  const itemsText = f.items_text || '';
  const total     = money(f.total_amount || f.total || 0);

  dEl.innerHTML = `
    <div class="detail-grid">
      <div>
        <div class="section-title">è¨‚å–® / å®¢æˆ¶è³‡è¨Š</div>
<div class="pill">è¨‚å–®ç·¨è™Ÿï¼š<span>${f.order_id || ''}</span></div>
<div class="pill">ä»˜æ¬¾æ–¹å¼ï¼š<span>${displayPaymentMethod(f.payment_method || '')}</span></div>
<div class="pill">æ‡‰ä»˜é‡‘é¡ï¼š<span>${total}</span></div>
<div class="pill">å»ºç«‹æ™‚é–“ï¼š<span>${f.created_at || ''}</span></div>

        <div class="mt-3">
          <div class="section-title">æ”¶ä»¶äºº / å–è²¨è³‡è¨Š</div>
          <label>æ”¶ä»¶äºº</label>
          <input id="d_ship_name" readonly value="${ship.name || ''}">
          <div class="row">
            <div>
              <label>é›»è©±</label>
              <input id="d_ship_phone" readonly value="${ship.phone || ''}">
            </div>
            <div>
              <label>Email</label>
              <input id="d_ship_email" readonly value="${ship.email || ''}">
            </div>
          </div>
          <label>å–è²¨æ–¹å¼ / åœ°å€</label>
          <textarea id="d_ship_addr" readonly>${addrText}</textarea>

          <label class="mt-2">å®¢æˆ¶å‚™è¨»</label>
          <textarea id="d_note" readonly>${note || ''}</textarea>

          <label class="mt-2">å•†å“æ˜ç´°</label>
          <textarea id="d_items_text" readonly>${itemsText}</textarea>
        </div>
      </div>

      <div>
        <div class="section-title">ä»˜æ¬¾ / å‡ºè²¨ç‹€æ…‹</div>
        <div class="row">
          <div>
            <label>ä»˜æ¬¾ç‹€æ…‹</label>
<select id="d_pay_status">
  <option value=""></option>
  <option value="unpaid"${f.pay_status==='unpaid'?' selected':''}>æœªæ”¶æ¬¾</option>
  <option value="pending"${f.pay_status==='pending'?' selected':''}>å¾…ç¢ºèª</option>
  <option value="paid_ok"${f.pay_status==='paid_ok'?' selected':''}>å·²æ”¶æ¬¾</option>
  <option value="failed"${f.pay_status==='failed'?' selected':''}>å¤±æ•— / ä½œå»¢</option>
</select>

          </div>
          <div>
            <label>å‡ºè²¨ç‹€æ…‹ (ship_status)</label>
            <select id="d_ship_status">
              <option value=""></option>
              <option value="none"${f.ship_status==='none'?' selected':''}>noneï¼ˆæœªè¨­å®šï¼‰</option>
              <option value="ready_to_ship"${f.ship_status==='ready_to_ship'?' selected':''}>ready_to_shipï¼ˆå¾…å‡ºè²¨ï¼‰</option>
              <option value="shipped"${f.ship_status==='shipped'?' selected':''}>shippedï¼ˆå·²å‡ºè²¨ï¼‰</option>
              <option value="returned"${f.ship_status==='returned'?' selected':''}>returnedï¼ˆé€€è²¨ï¼‰</option>
              <option value="cancelled"${f.ship_status==='cancelled'?' selected':''}>cancelledï¼ˆå–æ¶ˆï¼‰</option>
            </select>
          </div>
        </div>

        <div class="row mt-2">
          <div>
            <label>ç‰©æµå–®è™Ÿ (ship_tracking)</label>
            <input id="d_ship_tracking" value="${f.ship_tracking || f.tracking_no || ''}">
          </div>
          <div>
            <label>é‹è²» TWD (ship_fee)</label>
            <input id="d_ship_fee" type="number" step="1" value="${f.ship_fee || f.shipping_fee || ''}">
          </div>
        </div>

        <label class="mt-2">å‡ºè²¨æ™‚é–“ (ship_at)</label>
        <input id="d_ship_at" type="datetime-local" value="${toDatetimeLocal(f.ship_at)}">

        <label class="mt-3">è¨‚é‡‘ / åŒ¯æ¬¾è³‡è¨Š</label>
        <div class="row">
          <div>
            <label>è¨‚é‡‘é‡‘é¡ (deposit_amount)</label>
            <input id="d_deposit_amount" type="number" step="1" value="${f.deposit_amount || ''}">
          </div>
          <div>
            <label>åŒ¯æ¬¾å¾Œäº”ç¢¼ (deposit_last5)</label>
            <input id="d_deposit_last5" value="${f.deposit_last5 || ''}">
          </div>
        </div>

        <div class="row mt-2">
          <div>
            <label>è¨‚é‡‘åˆ°æœŸæ—¥ (deposit_expire_at)</label>
            <input id="d_deposit_expire_at" type="date" value="${(f.deposit_expire_at || '').slice(0,10)}">
          </div>
          <div>
            <label>ä¿ç•™åˆ° (hold_until)</label>
            <input id="d_hold_until" type="date" value="${(f.hold_until || '').slice(0,10)}">
          </div>
        </div>

        <div class="label-inline mt-2">
          <input id="d_deposit_received" type="checkbox" ${f.deposit_received ? 'checked':''}>
          <span>å·²æ”¶åˆ°è¨‚é‡‘ (deposit_received)</span>
        </div>
        <div class="label-inline">
          <input id="d_pay_notice_sent" type="checkbox" ${f.pay_notice_sent ? 'checked':''}>
          <span>å·²ç™¼å‡ºæ¬¾/ä¿ç•™é€šçŸ¥ (pay_notice_sent)</span>
        </div>

        <label class="mt-3">å…§éƒ¨å‚™è¨» (internal_note)</label>
        <textarea id="d_internal_note">${f.internal_note || ''}</textarea>

                <div class="mt-3 section-title">å‡ºè²¨é€šçŸ¥æ–‡å­—ï¼ˆé è¦½ï¼Œå¯è‡ªè¡Œä¿®æ”¹ï¼‰</div>
        <textarea id="d_notice_text">${buildNoticeText(rec)}</textarea>

        <button class="btn-primary" id="btnSaveAndShip">å„²å­˜å‡ºè²¨ / ä»˜æ¬¾è³‡è¨Š ï¼‹ æ¨™è¨˜å·²å‡ºè²¨ ï¼‹ ç™¼ LINE é€šçŸ¥</button>
        <button class="btn-secondary" id="btnConfirmPayOk">âœ… ç¢ºèªå·²æ”¶æ¬¾ï¼å¯©æ ¸é€šé ï¼‹ ç™¼ LINE</button>
        <button class="btn-secondary" id="btnMarkZcFail">âŒ ä¸­ç§Ÿå¯©æ ¸æœªé€šé ï¼‹ ç™¼ LINE</button>
        <button class="btn-secondary" id="btnCopyNotice">è¤‡è£½å‡ºè²¨é€šçŸ¥æ–‡å­—</button>
        <button class="btn-secondary" id="btnPrintOrder">åˆ—å°è¨‚è³¼å–®</button>
        <button class="btn small" id="btnSendTailLink">ç™¼å°¾æ¬¾çµå¸³é€£çµ + ç™¼ LINE</button>
        <button class="btn btn-sm btn-outline-secondary" id="btnExportOrders">åŒ¯å‡ºå…¨éƒ¨è¨‚å–®ï¼ˆä¸­æ–‡ï¼‰</button>
        <button class="btn btn-sm btn-outline-danger" id="btnCancelOrder">å–æ¶ˆè¨‚å–®ï¼ˆè£œå›åº«å­˜ï¼‰</button>
<div id="detailMsg" class="tag-small mt-2"></div>
      </div>
    </div>
  `;


   const btnSaveAndShip = $('#btnSaveAndShip');
if (btnSaveAndShip) {
  btnSaveAndShip.addEventListener('click', saveAndShipAndLine);
}

$('#btnCopyNotice').addEventListener('click', copyNotice);

 const btnTail = $('#btnSendTailLink');
if (btnTail) {
  btnTail.addEventListener('click', async () => {
    if (!currentRecord) {
      alert('å°šæœªé¸æ“‡è¨‚å–®');
      return;
    }
    const f = currentRecord.fields || currentRecord || {};
    const oid = f.order_id;
    if (!oid) {
      alert('é€™ç­†è³‡æ–™æ²’æœ‰ order_idï¼Œç„¡æ³•ç™¼å°¾æ¬¾é€£çµ');
      return;
    }

    if (!confirm(`è¦ç™¼é€ã€Œå°¾æ¬¾çµå¸³é€£çµ + LINE é€šçŸ¥ã€çµ¦è¨‚å–® ${oid} å—ï¼Ÿ`)) {
      return;
    }

    try {
      const r = await fetch(`${API}/admin/deposit/send-tail-link`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          op_key: OP_KEY,
          order_id: oid
        })
      });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok || !j.ok) {
        alert('ç™¼é€å¤±æ•—ï¼š' + (j.message || j.error || ('HTTP ' + r.status)));
        return;
      }
      alert('å·²ç™¼é€å°¾æ¬¾çµå¸³é€£çµä¸¦é€é LINE é€šçŸ¥å®¢äººã€‚');
    } catch (e) {
      console.error(e);
      alert('ç³»çµ±éŒ¯èª¤ï¼Œç™¼é€å¤±æ•—ã€‚');
    }
  });
}


  const btnPayOk = $('#btnConfirmPayOk');
  if (btnPayOk) btnPayOk.addEventListener('click', ()=>confirmPay('ok'));

  const btnZcFail = $('#btnMarkZcFail');
  if (btnZcFail) btnZcFail.addEventListener('click', ()=>confirmPay('zc_fail'));

 const btnPrint = $('#btnPrintOrder');
  if (btnPrint) btnPrint.addEventListener('click', printCurrentOrder);

const btnCancel = $('#btnCancelOrder');
if (btnCancel) btnCancel.addEventListener('click', cancelCurrentOrder);

 const btnExport = $('#btnExportOrders');
if (btnExport) {
  btnExport.addEventListener('click', () => {
    const url = `${API}/admin/orders/export?op_key=${encodeURIComponent(OP_KEY)}`;
    // é–‹æ–°è¦–çª—ï¼ç›´æ¥ä¸‹è¼‰
    window.open(url, '_blank');
  });
}

}
function renderDepositRemind(payload){
  const dEl = $('#orderDetail');
  if (!dEl) return;

  const list = payload.records || [];
  const date = payload.date || '';

  if (!list.length) {
    dEl.innerHTML = `
      <div class="section-title">ä»Šæ—¥å°¾æ¬¾æé†’ï¼ˆä¿ç•™åˆ°æœŸï¼‰</div>
      <p class="muted">ä»Šå¤©ï¼ˆ${date}ï¼‰æ²’æœ‰éœ€è¦æé†’å°¾æ¬¾çš„è¨‚å–®ã€‚</p>
    `;
    return;
  }

  const rows = list.map(r => `
    <tr>
      <td>${r.order_id || ''}</td>
      <td>${r.name || ''}</td>
      <td>${r.phone || ''}</td>
      <td style="text-align:right;">${r.amount || 0}</td>
      <td>${r.hold_until || ''}</td>
    </tr>
  `).join('');

  dEl.innerHTML = `
    <div class="section-title">ä»Šæ—¥å°¾æ¬¾æé†’ï¼ˆä¿ç•™åˆ°æœŸï¼š${date}ï¼‰</div>
    <p class="muted">
      å…± ${list.length} ç­†ã€Œä¿ç•™åˆ°ä»Šå¤©ã€ä¸”è¨‚é‡‘å·²æ”¶ã€å°¾æ¬¾æœªçµæ¸…çš„è¨‚å–®ã€‚<br>
      å»ºè­°é€ä¸€è¯ç¹«å®¢äººçµæ¸…å°¾æ¬¾ï¼Œæˆ–æ­é…å³ä¸‹è§’çš„ã€Œç™¼å°¾æ¬¾çµå¸³é€£çµ + ç™¼ LINEã€æŒ‰éˆ•ä¸€èµ·ä½¿ç”¨ã€‚
    </p>
    <div style="overflow:auto;">
      <table style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead>
          <tr>
            <th style="border-bottom:1px solid #334155;text-align:left;padding:4px 6px;">è¨‚å–®ç·¨è™Ÿ</th>
            <th style="border-bottom:1px solid #334155;text-align:left;padding:4px 6px;">å®¢æˆ¶å§“å</th>
            <th style="border-bottom:1px solid #334155;text-align:left;padding:4px 6px;">é›»è©±</th>
            <th style="border-bottom:1px solid #334155;text-align:right;padding:4px 6px;">å°¾æ¬¾é‡‘é¡</th>
            <th style="border-bottom:1px solid #334155;text-align:left;padding:4px 6px;">ä¿ç•™åˆ°</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>
    </div>
  `;
}

/* ===== å–æ¶ˆè¨‚å–®ï¼ˆè£œå›åº«å­˜ï¼‰ ===== */
async function cancelCurrentOrder() {
  if (!currentRecord) {
    alert('è«‹å…ˆåœ¨å·¦é‚Šé¸ä¸€å¼µè¨‚å–®');
    return;
  }

  const oid = currentRecord.fields.order_id;
  if (!oid) {
    alert('é€™ç­†è³‡æ–™æ²’æœ‰ order_idï¼Œç„¡æ³•å–æ¶ˆ');
    return;
  }

  if (!confirm(`ç¢ºå®šè¦å–æ¶ˆè¨‚å–® ${oid} ä¸¦è£œå›åº«å­˜å—ï¼Ÿ`)) {
    return;
  }

  try {
    const r = await fetch(API + "/admin/order/cancel", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        op_key: OP_KEY,
        order_id: oid
      })
    });
    const j = await r.json().catch(() => ({}));

    if (!r.ok || !j.ok) {
      alert("å–æ¶ˆå¤±æ•—ï¼š" + (j.message || j.error || ('HTTP ' + r.status)));
      return;
    }

    alert("å·²å–æ¶ˆè¨‚å–®ä¸¦è£œå›åº«å­˜ã€‚");
    // æœ€ç°¡å–®ï¼šæ•´é é‡è¼‰ï¼Œåˆ—è¡¨ / æ˜ç´°ä¸€èµ·æ›´æ–°
    location.reload();
  } catch (e) {
    console.error(e);
    alert("å–æ¶ˆè¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
  }
}

 
/* ===== å„²å­˜å³å´æ¬„ä½ ===== */
async function saveDetail(){
  if(!currentRecord) return;
  const msgEl = $('#detailMsg');
  msgEl.textContent = 'å„²å­˜ä¸­â€¦';

  const fields = {};
  fields.pay_status      = $('#d_pay_status').value || null;
  fields.ship_status     = $('#d_ship_status').value || null;
 // ç‰©æµå–®è™Ÿ / é‹è²» â†’ ç”¨ Orders çš„æ¬„ä½å
const tracking = $('#d_ship_tracking').value.trim();
fields.tracking_no = tracking || '';

const fee = $('#d_ship_fee').value.trim();
fields.shipping_fee = fee ? Number(fee) : null;


  const depAmt           = $('#d_deposit_amount').value.trim();
  fields.deposit_amount  = depAmt ? Number(depAmt) : null;
  fields.deposit_last5   = $('#d_deposit_last5').value.trim() || '';
  fields.deposit_expire_at = $('#d_deposit_expire_at').value || null;
  fields.hold_until        = $('#d_hold_until').value || null;
  fields.deposit_received  = $('#d_deposit_received').checked;
  fields.pay_notice_sent   = $('#d_pay_notice_sent').checked;
  fields.internal_note     = $('#d_internal_note').value || '';

  const shipAt = $('#d_ship_at').value;
  fields.ship_at = shipAt || null;

  const f = currentRecord.fields || currentRecord || {};
  const payload = {
    record_id: currentRecord.id || null,  // Airtable recIDï¼ˆæœ‰å°±ç”¨ï¼‰
    order_id : f.order_id || null,        // æˆ–ç”¨ order_id æ‰¾
    fields
  };

  try{
    const r = await fetch(`${API}/admin/order/update?op_key=${encodeURIComponent(OP_KEY)}`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    const j = await r.json();
    if(!r.ok || !j.ok){
      throw new Error(j.error || 'update_error');
    }
    msgEl.textContent = 'å·²å„²å­˜ âœ…';

    const keepF   = currentRecord.fields || currentRecord || {};
    const keepKey = currentRecord.id || keepF.order_id || '';
    await loadOrders(currentFilter);
    const found = currentOrders.find(x=>{
      if (x.id && x.id === keepKey) return true;
      const fx = x.fields || x || {};
      return fx.order_id && fx.order_id === keepKey;
    });
    if(found){
      renderDetail(found);
      const row = $(`#orderList .order-row[data-id="${keepKey}"]`);
      if(row) row.classList.add('active');
    }
  }catch(e){
    console.error(e);
    msgEl.textContent = 'å„²å­˜å¤±æ•—ï¼š' + (e.message || e);
  }
}


/* ===== ä¸€éµï¼šæ¨™è¨˜å‡ºè²¨ ï¼‹ LINE é€šçŸ¥ï¼ˆæ•´åˆ admin_ship_orderid ç‰ˆï¼‰ ===== */
async function shipAndLine(){
  if(!currentRecord) return;
  const msgEl = $('#detailMsg');
  const f = currentRecord.fields || currentRecord || {};
  const orderId = f.order_id;
  if (!orderId){
    alert('é€™ç­†è¨‚å–®æ²’æœ‰ order_idï¼Œç„¡æ³•å‡ºè²¨ã€‚');
    return;
  }

  const tracking = $('#d_ship_tracking').value.trim();
  const feeTxt   = $('#d_ship_fee').value.trim();
  let shipping_fee = null;
  if (feeTxt !== ''){
    const n = Number(feeTxt);
    if (isNaN(n) || n < 0){
      alert('é‹è²»è«‹è¼¸å…¥æ•¸å­—æˆ–ç•™ç©º');
      $('#d_ship_fee').focus();
      return;
    }
    shipping_fee = n;
  }

  const payload = { op_key: OP_KEY, order_id: orderId, tracking_no: tracking };
  if (shipping_fee !== null) payload.shipping_fee = shipping_fee;

  msgEl.textContent = 'å‡ºè²¨è™•ç†ä¸­ï¼ˆæœƒåŒæ™‚ç™¼é€ LINE é€šçŸ¥ï¼‰â€¦';

  try{
    const res = await fetch(API + '/admin/order/ship', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    const j = await res.json().catch(()=> ({}));
    if (!res.ok || !j.ok){
      throw new Error(j.error || ('HTTP ' + res.status));
    }
    msgEl.textContent = 'âœ… å·²æ¨™è¨˜å‡ºè²¨ä¸¦å˜—è©¦ç™¼é€ LINE é€šçŸ¥';

    // å‡ºè²¨å¾Œé‡æ–°è¼‰å…¥ç›®å‰ filter
    const keepKey = orderId;
    await loadOrders(currentFilter);
    const found = currentOrders.find(x=>{
      const fx = x.fields || x || {};
      return fx.order_id && String(fx.order_id) === String(keepKey);
    });
    if(found){
      renderDetail(found);
      const row = $(`#orderList .order-row[data-id="${keepKey}"]`);
      if(row) row.classList.add('active');
    }
  }catch(e){
    console.error(e);
    msgEl.textContent = 'âŒ å‡ºè²¨å¤±æ•—ï¼š' + (e.message || e);
  }
}
// ä¸€éµï¼šå…ˆå„²å­˜å‡ºè²¨ / ä»˜æ¬¾æ¬„ä½ï¼Œå†æ¨™è¨˜å‡ºè²¨ï¼‹ç™¼ LINE
async function saveAndShipAndLine() {
  if (!currentRecord) {
    alert('è«‹å…ˆåœ¨å·¦é‚Šé¸ä¸€ç­†è¨‚å–®');
    return;
  }

  const msgEl = $('#detailMsg');
  if (msgEl) msgEl.textContent = 'å„²å­˜å‡ºè²¨ / ä»˜æ¬¾è³‡æ–™ä¸­â€¦';

  // 1. å…ˆå„²å­˜å³å´å‡ºè²¨ / ä»˜æ¬¾æ¬„ä½
  await saveDetail();

  // å¦‚æœå„²å­˜æœ‰å¤±æ•—è¨Šæ¯ï¼Œå°±ä¸è¦å¾€ä¸‹å‡ºè²¨
  if (msgEl && msgEl.textContent.includes('å¤±æ•—')) {
    return;
  }

  // 2. å†å‡ºè²¨ï¼‹ç™¼ LINE é€šçŸ¥
  await shipAndLine();
}

 /* ===== ç¢ºèªæ”¶æ¬¾ / ä¸­ç§Ÿå¯©æ ¸ ï¼‹ ç™¼ LINE ===== */
async function confirmPay(mode){
  if (!currentRecord) return;
  const msgEl = $('#detailMsg');
  const f = currentRecord.fields || currentRecord || {};
  const orderId = f.order_id;
  if (!orderId){
    alert('é€™ç­†è¨‚å–®æ²’æœ‰ order_idï¼Œç„¡æ³•æ›´æ–°ä»˜æ¬¾ç‹€æ…‹ã€‚');
    return;
  }

  const depAmtTxt  = $('#d_deposit_amount').value.trim();
  const depLast5   = $('#d_deposit_last5').value.trim();
  const depAmt     = depAmtTxt ? Number(depAmtTxt) : null;

  const payload = {
    op_key: OP_KEY,
    order_id: orderId,
    mode: mode || 'ok',          // ok / zc_fail
    deposit_amount: depAmt,
    deposit_last5 : depLast5
  };

  msgEl.textContent = 'æ›´æ–°ä»˜æ¬¾ç‹€æ…‹ä¸­â€¦';

  try{
    const res = await fetch(API + '/admin/order/confirm-pay', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await res.json().catch(()=> ({}));
    if (!res.ok || !j.ok){
      throw new Error(j.error || ('HTTP ' + res.status));
    }

    msgEl.textContent = 'âœ… å·²æ›´æ–°ä»˜æ¬¾ç‹€æ…‹ä¸¦å˜—è©¦ç™¼é€ LINE é€šçŸ¥';

    const keepKey = orderId;
    await loadOrders(currentFilter);
    const found = currentOrders.find(x=>{
      const fx = x.fields || x || {};
      return fx.order_id && String(fx.order_id) === String(keepKey);
    });
    if (found){
      renderDetail(found);
      const row = $(`#orderList .order-row[data-id="${keepKey}"]`);
      if (row) row.classList.add('active');
    }
  }catch(e){
    console.error(e);
    msgEl.textContent = 'âŒ ä»˜æ¬¾ç‹€æ…‹æ›´æ–°å¤±æ•—ï¼š' + (e.message || e);
  }
}

/* ===== è¤‡è£½å‡ºè²¨é€šçŸ¥ ===== */
async function copyNotice(){
  const ta = $('#d_notice_text');
  if(!ta) return;
  const text = ta.value || '';
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(text);
    }else{
      ta.select();
      document.execCommand('copy');
      window.getSelection().removeAllRanges();
    }
    alert('å·²è¤‡è£½å‡ºè²¨é€šçŸ¥æ–‡å­—ï¼Œå¯ä»¥è²¼åˆ° LINE / Messengerã€‚');
  }catch(e){
    console.error(e);
    alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—è¤‡è£½ã€‚');
  }
}
/* ===== åˆ—å°ç›®å‰é€™ç­†è¨‚å–® ===== */
function printCurrentOrder(){
  if (!currentRecord){
    alert('è«‹å…ˆé¸ä¸€ç­†è¨‚å–®');
    return;
  }
  const f = currentRecord.fields || currentRecord || {};
  const shipInfo = parseShippingInfo(f) || {};
  const ship  = shipInfo.ship  || {};
  const store = ship.store     || {};
  const post  = ship.post      || {};

  let shipType = '';
  let shipAddr = '';
  if (ship.type === '711'){
    shipType = '7-11 è¶…å•†å–è²¨';
    shipAddr = `7-11 ${store.name || ''}ï¼ˆ${store.id || ''}ï¼‰\n${store.addr || ''}`;
  }else if (ship.type === 'post'){
    shipType = 'éƒµå¯„';
    shipAddr = `${post.zip || ''} ${post.addr || ''}`;
  }

  const itemsText = f.items_text || '';
  const total     = money(f.total_amount || f.total || 0);
  const orderId   = f.order_id || '';

  const html = `
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<title>è¨‚å–® ${orderId}</title>
<style>
  body{font-family:-apple-system,"Noto Sans TC";margin:20px;font-size:12px}
  h1{font-size:18px;margin-bottom:10px}
  table{border-collapse:collapse;width:100%;margin-top:10px}
  td,th{border:1px solid #000;padding:4px 6px;vertical-align:top}
  pre{white-space:pre-wrap;margin:0}
</style>
</head>
<body>
  <h1>MURAIN è¨‚å–®æ˜ç´°</h1>
  <table>
    <tr><th>è¨‚å–®ç·¨è™Ÿ</th><td>${orderId}</td></tr>
    <tr><th>å»ºç«‹æ™‚é–“</th><td>${f.created_at || ''}</td></tr>
    <tr><th>ä»˜æ¬¾æ–¹å¼</th><td>${f.payment_method || ''}</td></tr>
    <tr><th>æ‡‰ä»˜é‡‘é¡</th><td>${total}</td></tr>
    <tr><th>æ”¶ä»¶äºº</th><td>${ship.name || ''}</td></tr>
    <tr><th>é›»è©±</th><td>${ship.phone || ''}</td></tr>
    <tr><th>å‡ºè²¨æ–¹å¼</th><td>${shipType}</td></tr>
    <tr><th>å–è²¨é–€å¸‚ / åœ°å€</th><td><pre>${shipAddr}</pre></td></tr>
    <tr><th>ç‰©æµå–®è™Ÿ</th><td>${f.ship_tracking || f.tracking_no || ''}</td></tr>
    <tr><th>é‹è²»</th><td>${f.ship_fee ?? f.shipping_fee ?? ''}</td></tr>
    <tr><th>å®¢æˆ¶å‚™è¨»</th><td><pre>${(shipInfo.note || '').trim()}</pre></td></tr>
    <tr><th>å•†å“æ˜ç´°</th><td><pre>${itemsText}</pre></td></tr>
  </table>
</body>
</html>
  `;

  const w = window.open('', '_blank');
  w.document.open();
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}

/* ===== é é¢åˆå§‹åŒ– ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  // ä¸Šæ–¹å¿«é€Ÿåˆ†é¡æŒ‰éˆ•
  $$('.filter-btn').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      $$('.filter-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      await ensureOpKey();
      await loadOrders(btn.dataset.filter);
    });
  });

  // OP_KEY é‡è¨­
  $('#btnChangeKey').addEventListener('click', ()=>{
    localStorage.removeItem(STORAGE_KEY);
    OP_KEY = '';
    ensureOpKey().then(()=>loadOrders(currentFilter));
  });

  // é è¨­æŠŠæ—¥æœŸå¸¶æˆã€Œæœ¬æœˆ 1 è™Ÿ ~ ä»Šå¤©ã€
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  const first = yyyy + '-' + mm + '-01';
  const todayStr = yyyy + '-' + mm + '-' + dd;
  if ($('#date_from') && !$('#date_from').value) $('#date_from').value = first;
  if ($('#date_to') && !$('#date_to').value) $('#date_to').value = todayStr;

  // æ—¥æœŸè¼‰å…¥ / åªçœ‹ paid / åŒ¯å‡º
  const btnLoadByDate = $('#btnLoadByDate');
  if (btnLoadByDate){
    btnLoadByDate.addEventListener('click', async ()=>{
      await ensureOpKey();
      await loadOrdersByDate();
    });
  }
  const btnQuickPaid = $('#btnQuickPaid');
  if (btnQuickPaid){
    btnQuickPaid.addEventListener('click', async ()=>{
      $('#status').value = 'paid';
      await ensureOpKey();
      await loadOrdersByDate();
    });
  }
  const btnExport = $('#exportBtn');
  if (btnExport){
    btnExport.addEventListener('click', exportCSV);
  }
const btnRemindToday = $('#btnRemindToday');
if (btnRemindToday){
  btnRemindToday.addEventListener('click', async () =>{
    await ensureOpKey();
    try {
      const url = `${API}/admin/deposit/remind-today?op_key=${encodeURIComponent(OP_KEY)}`;
      const r = await fetch(url);
      const j = await r.json().catch(()=> ({}));

      if (!r.ok || !j.ok) {
        alert('è¼‰å…¥è¨‚é‡‘æé†’å¤±æ•—ï¼š' + (j.error || r.status));
        return;
      }
      renderDepositRemind(j);
    } catch (e) {
      console.error(e);
      alert('è¼‰å…¥è¨‚é‡‘æé†’æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
    }
  });
}
  await ensureOpKey();
  await loadOrders('all');
});
</script>
</body>
</html>
