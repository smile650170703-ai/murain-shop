<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MURAIN — 管理後台 (v6.1 - Admin UI)</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background-color: #f9f9f9; }
    .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
    .login-box { max-width: 500px; margin: 2rem auto; background: #fff; border-radius: 8px; padding: 2rem; }
    .tabs { display: flex; border-bottom: 1px solid #ccc; flex-wrap: wrap; gap:6px; }
    .tab-link { padding: 1rem 1.5rem; cursor: pointer; border: none; background: #eee; font-size: 1rem; }
    .tab-link.active { background: #fff; border: 1px solid #ccc; border-bottom: 1px solid #fff; position: relative; top: 1px; }
    .tab-content { display: none; background: #fff; padding: 2rem; border: 1px solid #ccc; border-top: none; }
    .tab-content.active { display: block; }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; word-wrap: break-word; }
    th { background-color: #f4f4f4; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
    button { font-size: 1rem; padding: 10px 16px; border: none; background-color: #007aff; color: white; border-radius: 8px; cursor: pointer; margin-right: 10px; }
    button:disabled { background-color: #ccc; cursor: default; }
    .btn-secondary { background-color: #6c757d; }
    .btn-ship { background-color: #28a745; font-size: 0.9rem; padding: 8px 12px; }
    .btn-cancel { background-color: #dc3545; font-size: 0.9rem; padding: 8px 12px; }
    .btn-confirm { background-color: #ffc107; color: black; font-size: 0.9rem; padding: 8px 12px; }
    .btn-edit { background-color: #0dcaf0; color: black; font-size: 0.9rem; padding: 8px 12px; }
    #status { margin-top: 1rem; font-weight: bold; }
    .hidden { display: none; }
    .label { width: 10cm; height: 15cm; border: 1px dashed #999; padding: 10px; box-sizing: border-box; margin: 1rem auto; page-break-after: always; overflow: hidden; background: #fff; }
    .label h3 { margin-top: 0; border-bottom: 2px solid #000; padding-bottom: 5px; }
    .label .section { margin-bottom: 10px; }
    .label .section strong { font-size: 1.2rem; display: block; }
    .label .section span { font-size: 1.1rem; }
    .label .gift-notes { border-top: 1px solid #ccc; padding-top: 10px; margin-top: 10px; background: #fdfdea; }
    @media print { body { margin: 0; } .container, .login-box { display: none; } #shipping-labels { display: block !important; } .label { border: none; margin: 0; } .btn-ship, .btn-cancel, .btn-confirm, .btn-edit { display: none; } }

    /* small helpers */
    .flex { display:flex; gap:8px; align-items:center; }
    .muted { color:#666; font-size:0.9rem; }
    .small { font-size:0.9rem; padding:6px 10px; }
  </style>

  <!-- SheetJS for Excel parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>

  <!-- Login -->
  <div class="login-box" id="login-box">
      <h2>管理後台</h2>
      <div class="form-group">
          <label for="op_key">請輸入主播/管理員密碼</label>
          <input type="password" id="op_key" placeholder="管理密碼 (登入用)">
      </div>
      <button id="loginBtn">登入</button>
      <p id="login-status"></p>
  </div>

  <!-- Confirm Modal (共用) -->
  <div id="confirmModal" style="display:none; position:fixed; left:0;right:0;top:0;bottom:0;
       background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:9999;">
    <div style="background:#fff;padding:18px;border-radius:8px; width:420px; max-width:95%;">
      <h3 id="confirmTitle">請輸入管理密碼確認</h3>
      <input id="confirmInput" type="password" placeholder="管理密碼" style="width:100%; padding:8px; margin:8px 0;">
      <div style="font-size:0.9rem; color:#666; margin-bottom:8px;" id="confirmHint"></div>
      <div style="text-align:right;">
        <button id="confirmCancel" type="button" class="small btn-secondary">取消</button>
        <button id="confirmOk" type="button" class="small">確認</button>
      </div>
    </div>
  </div>

  <!-- Admin Panel -->
  <div class="container hidden" id="admin-panel">
      <div class="tabs">
          <button class="tab-link active" data-tab="tab-dashboard">儀表板 (訂單)</button>
          <button class="tab-link" data-tab="tab-products">庫存管理</button>
          <button class="tab-link" data-tab="tab-shipping">出貨管理 (熱感應)</button>
          <button class="tab-link" data-tab="tab-reports">總訂單報表 (Q6)</button>
      </div>

      <!-- Replace your current <div id="tab-dashboard">...</div> with this block -->
<div id="tab-dashboard" class="tab-content active">
  <h2>儀表板 (近 7 天訂單)</h2>
  <button id="refresh-dashboard">重新整理</button>
  <div style="overflow-x: auto; margin-top: 12px;">
    <table id="dashboard-table">
      <thead>
        <tr>
          <th>日期</th>
          <th>主播</th>
          <th>訂單號</th>
          <th>狀態</th>
          <th>後五碼</th>
          <th>金額</th>
          <th>付款方式</th>
          <th>運費(Q5)</th>
          <th>單號(Q7)</th>
          <th>備註</th>
          <th>動作</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
/* Dashboard loader + delete/cancel handlers
   NOTE: uses op_key auth; change op_key value if needed.
*/
const ADMIN_AUTH = { op_key: '88' }; // <-- 把 '88' 換成你的 op_key（或改成 { password: '...' }）

<script>
/* === 請確認這邊指向你的後端 API 根 URL === */
const API_BASE = 'https://api.murain.tw'; // <- 必須帶 https://，避免向 Live Server 要求本機 API

/* 注意：ADMIN_AUTH 你原本有設定，這裡會使用它做 body 傳遞（測試 OK）。
   上線請不要把真正 secret 放到前端。 */
const ADMIN_AUTH_OBJ = typeof ADMIN_AUTH !== 'undefined' ? ADMIN_AUTH : { op_key: '88' };

/* 安全的 fetchDashboard：使用絕對 URL，處理非 JSON 與非 2xx */
async function fetchDashboard() {
  try {
    const res = await fetch(`${API_BASE}/admin/dashboard`, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(ADMIN_AUTH_OBJ)
    });

    // 非 2xx
    if (!res.ok) {
      const txt = await res.text().catch(()=>'<no body>');
      console.warn('dashboard load HTTP error', res.status, txt);
      alert('載入失敗: HTTP ' + res.status + '（請看 Console）');
      return [];
    }

    // 確認 content-type 是否為 JSON
    const ct = (res.headers.get('content-type') || '').toLowerCase();
    if (!ct.includes('application/json')) {
      const txt = await res.text().catch(()=>'<no body>');
      console.warn('dashboard response not json:', txt);
      alert('載入失敗：後端未回傳 JSON（請看 Console）');
      return [];
    }

    const j = await res.json();
    if (!j || !j.ok) {
      console.warn('dashboard load failed', j);
      alert('載入失敗: ' + (j && (j.error || JSON.stringify(j)) || 'unknown'));
      return [];
    }
    return j.orders || [];
  } catch (e) {
    console.error('fetchDashboard error', e);
    alert('載入儀表板發生錯誤（請看 Console）');
    return [];
  }
}

function formatDate(iso) {
  if (!iso) return '';
  try { return new Date(iso).toLocaleString(); } catch { return iso; }
}

function buildTableHTML(orders) {
  if (!Array.isArray(orders) || orders.length === 0) {
    return `<tbody><tr><td colspan="11">目前無訂單</td></tr></tbody>`;
  }
  const rows = (orders || []).map(o => {
    let si = {};
    try { si = JSON.parse(o.shipping_info || '{}'); } catch(e){}
    const recipient = si.name || '';
    const phone = si.phone || '';
    const addr = si.address || si.store_name || '';
    const orderDate = formatDate(o.created_at);
    const depositLast5 = (o.deposit_proof || '').slice(-5);
    const actions = `
      <button class="btn-cancel-order" data-order-id="${o.order_id}">取消訂單</button>
      <button class="btn-delete-order" data-order-id="${o.order_id}">刪除訂單</button>
    `;
    return `
      <tr data-order-id="${o.order_id}">
        <td>${orderDate}</td>
        <td>${o.streamer_name || ''}</td>
        <td>${o.order_id}</td>
        <td>${o.status || ''}</td>
        <td>${depositLast5 || ''}</td>
        <td>${o.total_amount ?? 0}</td>
        <td>${o.payment_method || ''}</td>
        <td>${o.shipping_cost ?? 0}</td>
        <td>${o.tracking_number || ''}</td>
        <td>${o.gift_notes || ''}</td>
        <td>${actions}</td>
      </tr>
    `;
  }).join('');
  return `<tbody>${rows}</tbody>`;
}

/* 刪除訂單（呼叫後端 /admin/delete-order，成功後重新載入表格） */
async function deleteOrder(order_id) {
  if (!confirm('確定要刪除 ' + order_id + ' 嗎？此操作無法回復')) return;
  try {
    const res = await fetch(`${API_BASE}/admin/delete-order`, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ...ADMIN_AUTH_OBJ, order_id })
    });
    const txt = await res.text().catch(()=>'<no body>');
    if (!res.ok) {
      console.error('delete-order failed', res.status, txt);
      alert('刪除失敗（請看 Console）');
      return;
    }
    // 成功後重新載入
    await loadAndRenderDashboard();
    alert('刪除成功');
  } catch (e) {
    console.error('deleteOrder error', e);
    alert('刪除發生錯誤（請看 Console）');
  }
}

/* 取消訂單（示範，實作可依你的 API 加改） */
async function cancelOrder(order_id) {
  if (!confirm('確定要取消 ' + order_id + ' 嗎？')) return;
  // 目前尚未 implement 後端 cancel endpoint；如果你有 /admin/cancel-order 可以改這裡成真正呼叫
  alert('取消功能尚未連後端，如要我加 /admin/cancel-order 我幫你寫。');
}

/* 讀取並渲染 */
async function loadAndRenderDashboard() {
  const btn = document.querySelector('#refresh-dashboard');
  if (btn) { btn.disabled = true; btn.textContent = '讀取中...'; }
  const orders = await fetchDashboard();
  const table = document.querySelector('#dashboard-table');
  if (table) {
    // 把 tbody 換掉
    table.querySelectorAll('tbody').forEach(n=>n.remove());
    table.insertAdjacentHTML('beforeend', buildTableHTML(orders));
  }
  if (btn) { btn.disabled = false; btn.textContent = '重新整理'; }
}

/* 事件委派（處理刪除/取消按鈕與重新整理按鈕） */
document.addEventListener('click', function(e){
  const del = e.target.closest('.btn-delete-order');
  if (del) {
    deleteOrder(del.dataset.orderId);
    return;
  }
  const cancel = e.target.closest('.btn-cancel-order');
  if (cancel) {
    cancelOrder(cancel.dataset.orderId);
    return;
  }
  if (e.target && e.target.id === 'refresh-dashboard') {
    loadAndRenderDashboard();
    return;
  }
});

/* 頁面載入時自動讀取 */
document.addEventListener('DOMContentLoaded', loadAndRenderDashboard);
</script>


async function loadAndRenderDashboard() {
  const table = document.getElementById('dashboard-table');
  if (!table) return;
  table.querySelector('tbody').innerHTML = '<tr><td colspan="11">載入中…</td></tr>';
  const orders = await fetchDashboard();
  // Filter out deleted status just in case
  const visible = (orders || []).filter(o => (o.status || '').toLowerCase() !== 'deleted');
  table.innerHTML = table.querySelector('thead') ? table.querySelector('thead').outerHTML + buildTableHTML(visible) : buildTableHTML(visible);
}

// Event delegation for delete/cancel
document.addEventListener('click', async (e) => {
  const del = e.target.closest('.btn-delete-order');
  if (del) {
    const orderId = del.dataset.orderId;
    if (!orderId) return alert('找不到 order_id');
    if (!confirm(`確定要刪除訂單 ${orderId}？此操作不可還原`)) return;
    try {
      const res = await fetch('/admin/delete-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...ADMIN_AUTH, order_id: orderId })
      });
      const j = await res.json();
      if (j.ok) {
        // reload to reflect removal
        await loadAndRenderDashboard();
      } else {
        alert('刪除失敗：' + (j.error || JSON.stringify(j)));
      }
    } catch (err) {
      console.error(err);
      alert('刪除發生錯誤，請看 console');
    }
    return;
  }

  const cancelBtn = e.target.closest('.btn-cancel-order');
  if (cancelBtn) {
    const orderId = cancelBtn.dataset.orderId;
    if (!orderId) return;
    if (!confirm(`確定取消訂單 ${orderId}？`)) return;
    try {
      // 若你的後端取消 endpoint 名稱不同（/admin/cancel-order）請改這裡
      const res = await fetch('/admin/cancel-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...ADMIN_AUTH, order_id: orderId })
      });
      const j = await res.json();
      if (j.ok) {
        await loadAndRenderDashboard();
      } else {
        alert('取消失敗：' + (j.error || JSON.stringify(j)));
      }
    } catch (err) {
      console.error(err);
      alert('取消發生錯誤，請看 console');
    }
    return;
  }
});

// bind refresh button
document.getElementById('refresh-dashboard')?.addEventListener('click', (ev) => {
  ev.preventDefault();
  loadAndRenderDashboard();
});

// auto load once DOM ready
window.addEventListener('DOMContentLoaded', loadAndRenderDashboard);
</script>


      <div id="tab-products" class="tab-content">
          <h2>庫存管理</h2>
          <div class="flex" style="margin-bottom:8px;">
            <button id="refresh-products" class="small">重新整理庫存</button>
            <div class="muted">| 支援 CSV / XLSX 上傳</div>
          </div>

          <!-- Upload control -->
          <div style="margin-top:6px; display:flex; gap:8px; align-items:center;">
            <input type="file" id="inventory-file" accept=".xlsx,.xls,.csv" />
            <button id="upload-inventory-btn" class="btn-secondary small">一鍵上傳 Excel (上傳庫存)</button>
            <span class="muted">支援 .xlsx / .csv (第一張工作表)</span>
          </div>

          <div class="form-group" style="margin-top: 1rem; max-width: 400px;">
              <label for="product-search">搜尋 Barcode</label>
              <input type="text" id="product-search" placeholder="輸入 Barcode 按 Enter...">
          </div>
          <table id="products-table" style="margin-top:1rem;">
              <thead>
                  <tr><th>SKU</th><th>Barcode</th><th>名稱</th><th>售價</th><th>庫存</th><th>預留</th><th>操作</th></tr>
              </thead>
              <tbody></tbody>
          </table>

          <h3 style="margin-top:2rem;">新增商品 (Q5)</h3>
          <form id="new-product-form" style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div class="form-group"><label>SKU (唯一)</label><input type="text" id="p_sku" required></div>
              <div class="form-group"><label>Barcode</label><input type="text" id="p_barcode"></div>
              <div class="form-group" style="grid-column: 1 / -1;"><label>名稱</label><input type="text" id="p_name" required></div>
              <div class="form-group"><label>售價</label><input type="number" id="p_price_live" value="0"></div>
              <div class="form-group"><label>成本</label><input type="number" id="p_cost" value="0"></div>
              <div class="form-group"><label>庫存</label><input type="number" id="p_stock_on_hand" value="0"></div>
              <div class="form-group" style="align-self: end;"><button type="submit" class="small">新增商品</button></div>
          </form>
          <p id="product-status"></p>
      </div>

      <div id="tab-shipping" class="tab-content">
          <h2>出貨管理 (熱感應標籤)</h2>
          <button id="load-shipping">載入待出貨訂單</button>
          <button id="export-cod" class="btn-secondary small">匯出 7-11 貨付 (CSV)</button>
          <button id="export-mail" class="btn-secondary small">匯出 郵寄 (CSV)</button>
          <button id="batch-ship" class="btn-ship small">一鍵標記「勾選」為已出貨</button>
          <button id="export-zero-packages" class="btn-secondary small" style="background-color: #ffc107; color: black;">匯出 0 元包裹</button>
          <p style="margin-top:8px;" class="muted">(v6.1) 提醒：「等待訂金/付款」的訂單，請至「儀表板」確認。確認後，訂單狀態變為「等待填寫物流」，客人填寫完畢後才會出現在此處。</p>
          <div id="shipping-labels"></div>
      </div>

      <div id="tab-reports" class="tab-content">
          <h2>總訂單報表 (Q6)</h2>
          <div class="form-group" style="display: flex; gap: 1rem; align-items: flex-end;">
              <div><label>開始日期</label><input type="date" id="report-start"></div>
              <div><label>結束日期</label><input type="date" id="report-end"></div>
              <button id="load-report" class="small">載入報表</button>
              <button id="export-report" class="btn-secondary small">匯出總表 (CSV)</button>
          </div>
          <div style="overflow-x: auto;">
              <table id="report-table">
                  <thead>
                      <tr><th>日期</th><th>主播</th><th>訂單號</th><th>狀態</th><th>金額</th><th>付款方式</th><th>運費</th><th>單號</th><th>發票</th><th>收件人</th><th>手機</th><th>地址/門市</th></tr>
                  </thead>
                  <tbody></tbody>
              </table>
          </div>
      </div>
  </div>

  <!-- e-map form (hidden) -->
  <form id="e-map-form" method="POST" action="https://emap.presco.com.tw/c2cemap.ashx" class="hidden">
      <input type="hidden" name="eshopid" value="870" /> <input type="hidden" name="servicetype" value="1" />
      <input type="hidden" name="url" id="e-map-callback-url" />
  </form>

<!-- ===================== JS ===================== -->
<script>
  const API_ENDPOINT = 'https://api.murain.tw';
  let OP_KEY = '';
  let CACHED_ORDERS = [];
  let CACHED_REPORT_ORDERS = [];

  /* --- Login --- */
  document.getElementById('loginBtn').addEventListener('click', async () => {
    const key = document.getElementById('op_key').value;
    const status = document.getElementById('login-status');
    if (!key) { status.textContent = '請輸入密碼'; return; }
    OP_KEY = key;
    status.textContent = '登入中...';
    try {
      // 以 admin/dashboard 簡單驗證
      await apiCall('/admin/dashboard', {});
      status.textContent = '登入成功';
      document.getElementById('login-box').classList.add('hidden');
      document.getElementById('admin-panel').classList.remove('hidden');
      loadDashboard();

      const today = new Date().toISOString().split('T')[0];
      document.getElementById('report-start').value = today;
      document.getElementById('report-end').value = today;
    } catch (e) {
      status.textContent = '密鑰錯誤或伺服器無回應';
      OP_KEY = '';
    }
  });

  /* --- Tabs --- */
  document.querySelectorAll('.tab-link').forEach(button => {
    button.addEventListener('click', () => {
      document.querySelectorAll('.tab-link').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      button.classList.add('active');
      const tabId = button.dataset.tab;
      document.getElementById(tabId).classList.add('active');
      if (tabId === 'tab-dashboard') loadDashboard();
      if (tabId === 'tab-products') loadProducts();
      if (tabId === 'tab-shipping') loadShipping();
      if (tabId === 'tab-reports') loadReport();
    });
  });

  /* --- apiCall (adds op_key automatically) --- */
  async function apiCall(endpoint, payload = {}) {
    // when calling admin endpoints via apiCall, we attach op_key for convenience
    if (!payload) payload = {};
    if (OP_KEY) payload.op_key = OP_KEY;
    const res = await fetch(`${API_ENDPOINT}${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!res.ok || data.error) {
      throw new Error(data.error || `Server error ${res.status}`);
    }
    return data;
  }

  /* --- helpers --- */
  function translateStatus(status) {
    const map = {
      'draft': '草稿 (未建立)', 'pending': '購物車 (未結帳)',
      'awaiting_payment': '等待付款 (金流)','awaiting_shipping_info': '等待填寫物流 (Q5)',
      'awaiting_deposit_proof': '等待訂金確認 (新客)','awaiting_cod_shipment': '待出貨 (貨付)',
      'paid': '已付款 (待出貨)','shipped': '已出貨 (Q3)','expired': '已過期 (棄標)','cancelled': '已取消 (Q3)'
    };
    return map[status] || status;
  }
  function formatDateTime(isoString) { if (!isoString) return ''; try { return new Date(isoString).toLocaleString('zh-TW'); } catch(e) { return isoString; } }

  /* ------------------- DASHBOARD ------------------- */
  document.getElementById('refresh-dashboard').addEventListener('click', loadDashboard);
  async function loadDashboard() {
    try {
      const data = await apiCall('/admin/dashboard', {});
      const tbody = document.getElementById('dashboard-table').getElementsByTagName('tbody')[0];
      tbody.innerHTML = '';
      if (!data.orders || data.orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11">近 7 天無訂單</td></tr>';
      } else {
        data.orders.forEach(o => {
          const row = tbody.insertRow();
          row.innerHTML = `
            <td>${formatDateTime(o.created_at)}</td>
            <td>${o.streamer_name || ''}</td>
            <td>${o.order_id}</td>
            <td>${translateStatus(o.status)}</td>
            <td>${o.deposit_proof || ''}</td>
            <td>${o.total_amount}</td>
            <td>${o.payment_method || ''}</td>
            <td>${o.shipping_cost || 0}</td>
            <td>${o.tracking_number || ''}</td>
            <td>${o.gift_notes || ''}</td>
            <td>
              ${(o.status === 'awaiting_deposit_proof') ? `<button class="btn-confirm small" data-orderid="${o.order_id}">✅ 確認訂金</button>` : ''}
              ${(o.status !== 'shipped' && o.status !== 'cancelled') ? `<button class="btn-cancel small" data-orderid="${o.order_id}">取消訂單</button>` : ''}
              <button class="btn-delete-order small" data-orderid="${o.order_id}" style="background:#dc3545; margin-top:6px;">刪除訂單</button>
            </td>
          `;
        });
      }
      addAdminButtonListeners();
    } catch (e) { alert('載入訂單失敗: ' + e.message); }
  }

  /* ------------------- PRODUCTS ------------------- */
  document.getElementById('refresh-products').addEventListener('click', () => loadProducts());
  async function loadProducts(barcode = null) {
    try {
      let payload = { action: 'search' };
      if (barcode) payload.barcode = barcode;
      const data = await apiCall('/admin/products', payload);
      const tbody = document.getElementById('products-table').getElementsByTagName('tbody')[0];
      tbody.innerHTML = '';
      if (!data.products || data.products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7">資料庫中沒有商品</td></tr>';
      } else {
        data.products.forEach(p => {
          const row = tbody.insertRow();
          row.innerHTML = `<td>${p.sku}</td><td>${p.barcode}</td><td>${p.name}</td><td>${p.price_live}</td><td>${p.stock_on_hand}</td><td>${p.stock_reserved}</td>
                           <td><button class="btn-delete-inv small" data-sku="${p.sku}" style="background:#dc3545;">刪除商品</button></td>`;
        });
      }
      addAdminButtonListeners(); // rebind
    } catch (e) { alert('載入庫存失敗: ' + e.message); }
  }
  document.getElementById('product-search').addEventListener('keypress', (e) => { if (e.key === 'Enter') loadProducts(e.target.value.trim()); });

  document.getElementById('new-product-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const status = document.getElementById('product-status');
    try {
      const payload = {
        action: 'create',
        product: {
          sku: document.getElementById('p_sku').value,
          barcode: document.getElementById('p_barcode').value,
          name: document.getElementById('p_name').value,
          price_live: parseInt(document.getElementById('p_price_live').value, 10),
          cost: parseInt(document.getElementById('p_cost').value, 10),
          stock_on_hand: parseInt(document.getElementById('p_stock_on_hand').value, 10)
        }
      };
      if (!payload.product.sku || !payload.product.name) throw new Error('SKU 和名稱為必填');
      await apiCall('/admin/products', payload);
      status.textContent = '新增成功！'; status.style.color = 'green';
      e.target.reset(); loadProducts();
    } catch (e) {
      status.textContent = '新增失敗: ' + e.message; status.style.color = 'red';
    }
  });

  /* ------------------- SHIPPING ------------------- */
  document.getElementById('load-shipping').addEventListener('click', loadShipping);
  async function loadShipping() {
    const btn = document.getElementById('load-shipping');
    const container = document.getElementById('shipping-labels');
    btn.disabled = true;
    container.innerHTML = '';
    CACHED_ORDERS = [];
    try {
      const data = await apiCall('/admin/print-labels', {});
      if (!data.orders || data.orders.length === 0) {
        container.innerHTML = '<h3>沒有找到「真正」待出貨的訂單。</h3>';
        btn.disabled = false;
        return;
      }
      CACHED_ORDERS = data.orders;
      data.orders.forEach(order => {
        let shipping = {}; try { shipping = JSON.parse(order.shipping_info || '{}'); } catch(e) {}
        const statusText = translateStatus(order.status);
        let shippingDest = 'N/A';
        if (order.payment_method && (order.payment_method.includes('7-11') || order.payment_method.includes('DEPOSIT'))) {
          shippingDest = `${shipping.store_name || ''} (${shipping.store_address || '地址未填'})`;
        } else if (order.payment_method === 'MAIL') {
          shippingDest = `${shipping.address || '地址未填'}`;
        }
        const label = document.createElement('div');
        label.className = 'label';
        label.innerHTML = `
          <input type="checkbox" class="ship-checkbox" data-orderid="${order.order_id}" style="float:right; width: 25px; height: 25px;">
          <h3>訂單：${order.order_id}</h3>
          <div class="section"> <strong>日期：${formatDateTime(order.created_at)}</strong> </div>
          <div class="section"> <strong>主播：${order.streamer_name || 'N/A'}</strong> </div>
          <div class="section"> <strong>狀態：${statusText} (運費: ${order.shipping_cost || 0})</strong> </div>
          <div class="section">
            <strong>收件人：</strong>
            <span>${shipping.name || 'N/A'} (${shipping.phone || 'N/A'})</span>
          </div>
          <div class="section">
            <strong>寄送 (${order.payment_method || 'N/A'})：</strong>
            <span>${shippingDest}</span>
          </div>
          <div class="section gift-notes">
            <strong>主播備註：</strong>
            <span>${order.gift_notes || '(無)'}</span>
          </div>
          <div class="section">
            <strong>發票：</strong>
            <span>${order.invoice_status || 'N/A'}: ${order.invoice_no || ''}</span>
          </div>

          <div class="section" style="border-top: 2px dashed #ccc; padding-top: 10px; margin-top: 15px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div class="form-group"><label>運費</label><input type="number" class="input-shipping-cost" data-orderid="${order.order_id}" value="${order.shipping_cost||''}"></div>
              <div class="form-group"><label>物流單號</label><input type="text" class="input-tracking" data-orderid="${order.order_id}" value="${order.tracking_number||''}"></div>
              <div class="form-group" style="grid-column: 1 / -1;"><label>物流類型</label>
                <select class="select-shipping-type" data-orderid="${order.order_id}">
                  <option value="" ${!order.shipping_type ? 'selected' : ''}>一般</option>
                  <option value="7-11_COD" ${order.shipping_type === '7-11_COD' ? 'selected' : ''}>7-11 貨付</option>
                  <option value="7-11_PAID" ${order.shipping_type === '7-11_PAID' ? 'selected' : ''}>7-11 (0元)</option>
                  <option value="MAIL" ${order.shipping_type === 'MAIL' ? 'selected' : ''}>郵局</option>
                </select>
              </div>
              <div class="form-group"><label>門市名稱</label><input type="text" class="input-pickup-store-name" data-orderid="${order.order_id}" value="${order.pickup_store?.store_name||''}"></div>
              <div class="form-group"><label>門市地址</label><input type="text" class="input-pickup-store-address" data-orderid="${order.order_id}" value="${order.pickup_store?.store_address||''}"></div>
            </div>
            <button class="btn-save-shipping small" data-orderid="${order.order_id}" style="background-color: #198754; font-size: 0.9rem; padding: 8px 12px; color: white; width: auto;">儲存物流</button>
            <button class="btn-notify-ship small" data-orderid="${order.order_id}" style="background-color: #0dcaf0; font-size: 0.9rem; padding: 8px 12px; color: black; width: auto;">重發通知</button>
          </div>
          <button class="btn-ship small" data-orderid="${order.order_id}" style="width: 100%; margin-top: 10px;">(儲存後) 標記為已出貨</button>
        `;
        container.appendChild(label);
      });
      addAdminButtonListeners();
    } catch (e) {
      alert('載入出貨單失敗: ' + e.message);
    } finally {
      btn.disabled = false;
    }
  }

  /* ------------------- REPORTS ------------------- */
  document.getElementById('load-report').addEventListener('click', () => loadReport());
  document.getElementById('export-report').addEventListener('click', () => exportReport());

  async function loadReport() {
    const btn = document.getElementById('load-report');
    btn.disabled = true;
    const tbody = document.getElementById('report-table').getElementsByTagName('tbody')[0];
    tbody.innerHTML = '<tr><td colspan="12">載入中...</td></tr>';
    CACHED_REPORT_ORDERS = [];
    try {
      const data = await apiCall('/admin/export-orders', {
        start_date: document.getElementById('report-start').value,
        end_date: document.getElementById('report-end').value
      });
      if (!data.orders || data.orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12">在此日期範圍內無訂單</td></tr>';
        return;
      }
      CACHED_REPORT_ORDERS = data.orders;
      tbody.innerHTML = '';
      data.orders.forEach(o => {
        let s = {}; try { s = JSON.parse(o.shipping_info || '{}'); } catch(e) {}
        const shippingDest = (o.payment_method === 'MAIL') ? s.address : s.store_name;
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${formatDateTime(o.created_at)}</td>
          <td>${o.streamer_name || ''}</td>
          <td>${o.order_id}</td>
          <td>${translateStatus(o.status)}</td>
          <td>${o.total_amount}</td>
          <td>${o.payment_method || ''}</td>
          <td>${o.shipping_cost || 0}</td>
          <td>${o.tracking_number || ''}</td>
          <td>${o.invoice_no || o.invoice_status || ''}</td>
          <td>${s.name || ''}</td>
          <td>${s.phone || ''}</td>
          <td>${shippingDest || ''}</td>
        `;
      });
    } catch (e) {
      tbody.innerHTML = `<tr><td colspan="12">載入失敗: ${e.message}</td></tr>`;
    } finally {
      btn.disabled = false;
    }
  }

  function exportReport() {
    if (CACHED_REPORT_ORDERS.length === 0) { alert('請先「載入報表」'); return; }
    let csvContent = "日期,主播,訂單號,狀態,總金額,付款方式,運費,包裹單號,發票號碼,收件人,手機,地址/門市,後五碼,贈品備註\n";
    CACHED_REPORT_ORDERS.forEach(o => {
      let s = {}; try { s = JSON.parse(o.shipping_info || '{}'); } catch(e) {}
      const shippingDest = (o.payment_method === 'MAIL') ? s.address : s.store_name;
      const row = [
        formatDateTime(o.created_at),
        o.streamer_name || '',
        o.order_id,
        translateStatus(o.status),
        o.total_amount || 0,
        o.payment_method || '',
        o.shipping_cost || 0,
        o.tracking_number || '',
        o.invoice_no || '',
        s.name || '',
        s.phone || '',
        (shippingDest || '').replace(/,/g, ' '),
        o.deposit_proof || '',
        (o.gift_notes || '').replace(/,/g, ' ')
      ];
      csvContent += row.join(',') + '\n';
    });
    const blob = new Blob([new Uint8Array([0xEF,0xBB,0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a"); const url = URL.createObjectURL(blob);
    link.setAttribute("href", url); link.setAttribute("download", `report_export_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link); link.click(); document.body.removeChild(link);
  }

  /* ================= Admin buttons: existing + new delete handlers ================= */
  function addAdminButtonListeners() {
    // mark shipped
    document.querySelectorAll('.btn-ship').forEach(button => {
      button.onclick = async (e) => {
        const btn = e.target; const order_id = btn.dataset.orderid;
        if (!confirm(`您確定要將訂單 ${order_id} 標記為「已出貨」嗎？`)) return;
        btn.disabled = true; btn.textContent = '標記中...';
        try {
          await apiCall('/admin/mark-as-shipped', { order_id });
          btn.closest('.label')?.remove();
        } catch (err) {
          alert('標記失敗: ' + err.message);
          btn.disabled = false; btn.textContent = '標記為已出貨';
        }
      };
    });

    // cancel
    document.querySelectorAll('.btn-cancel').forEach(button => {
      button.onclick = async (e) => {
        const btn = e.target; const order_id = btn.dataset.orderid;
        if (!confirm(`您確定要「取消」訂單 ${order_id} 嗎？`)) return;
        btn.disabled = true; btn.textContent = '取消中...';
        try {
          await apiCall('/admin/cancel-order', { order_id });
          loadDashboard();
        } catch (err) {
          alert('取消失敗: ' + err.message);
          btn.disabled = false; btn.textContent = '取消訂單';
        }
      };
    });

    // confirm deposit
    document.querySelectorAll('.btn-confirm').forEach(button => {
      button.onclick = async (e) => {
        const btn = e.target; const order_id = btn.dataset.orderid;
        if (!confirm(`您確定「已收到」訂單 ${order_id} 的訂金嗎？`)) return;
        btn.disabled = true; btn.textContent = '確認中...';
        try {
          await apiCall('/admin/confirm-deposit', { order_id });
          loadDashboard();
        } catch (err) {
          alert('確認失敗: ' + err.message);
          btn.disabled = false; btn.textContent = '✅ 確認訂金';
        }
      };
    });

    // save shipping
    document.querySelectorAll('.btn-save-shipping').forEach(button => {
      button.onclick = async (e) => {
        const btn = e.target; const id = btn.dataset.orderid;
        btn.disabled = true; btn.textContent = '儲存中...';
        try {
          const cost = document.querySelector(`.input-shipping-cost[data-orderid="${id}"]`).value;
          const tn = document.querySelector(`.input-tracking[data-orderid="${id}"]`).value;
          const type = document.querySelector(`.select-shipping-type[data-orderid="${id}"]`).value;
          const storeName = document.querySelector(`.input-pickup-store-name[data-orderid="${id}"]`).value;
          const storeAddr = document.querySelector(`.input-pickup-store-address[data-orderid="${id}"]`).value;
          const pickup_store = storeName ? { store_name: storeName, store_address: storeAddr } : {};
          await apiCall('/admin/update-shipping-details', { order_id: id, shipping_cost: cost, tracking_number: tn, shipping_type: type, pickup_store });
          alert('已更新運費/單號，並嘗試發送通知。');
          loadShipping();
        } catch (err) {
          alert('儲存失敗: ' + err.message);
          btn.disabled = false; btn.textContent = '儲存物流';
        }
      };
    });

    // notify ship
    document.querySelectorAll('.btn-notify-ship').forEach(button => {
      button.onclick = async (e) => {
        const btn = e.target; const order_id = btn.dataset.orderid;
        if (!confirm(`確定要為訂單 ${order_id} 重發「已寄出」通知嗎？`)) return;
        btn.disabled = true; btn.textContent = '通知中...';
        try {
          await apiCall('/admin/notify-shipment', { order_id });
          alert('通知已發送 (如果客戶有綁定 LINE)');
        } catch (err) {
          alert('通知失敗: ' + err.message);
        } finally {
          btn.disabled = false; btn.textContent = '重發通知';
        }
      };
    });

    // batch ship
    document.getElementById('batch-ship').onclick = async (e) => {
      const btn = e.target;
      const checkedBoxes = document.querySelectorAll('.ship-checkbox:checked');
      if (checkedBoxes.length === 0) { alert('請先勾選您要「批次標記出貨」的訂單'); return; }
      const order_ids = Array.from(checkedBoxes).map(cb => cb.dataset.orderid);
      if (!confirm(`您確定要將「${order_ids.length}」筆訂單全部標記為「已出貨」嗎？`)) return;
      btn.disabled = true; btn.textContent = '批次處理中...';
      try {
        await apiCall('/admin/batch-ship', { order_ids });
        alert(`成功標記 ${order_ids.length} 筆訂單為已出貨！`);
        loadShipping();
      } catch (err) { alert('批次標記失敗: ' + err.message); }
      finally { btn.disabled = false; btn.textContent = '一鍵標記「勾選」為已出貨'; }
    };

    /* ==== NEW: delete order / delete inventory handlers (open modal) ==== */
    document.querySelectorAll('.btn-delete-order').forEach(button => {
      button.onclick = (e) => {
        const id = e.target.dataset.orderid;
        showConfirmModal({ title: `刪除訂單 ${id}`, hint: '刪除後會釋放預留庫存，此操作無法復原！', action: 'delete-order', target: id });
      };
    });
    document.querySelectorAll('.btn-delete-inv').forEach(button => {
      button.onclick = (e) => {
        const sku = e.target.dataset.sku;
        showConfirmModal({ title: `刪除商品 ${sku}`, hint: '將嘗試 soft-delete (active=0)。請再次輸入密碼確認。', action: 'delete-inventory', target: sku });
      };
    });
  } // addAdminButtonListeners end

  /* ==================== Confirm Modal logic ==================== */
  function showConfirmModal(opts) {
    const modal = document.getElementById('confirmModal');
    document.getElementById('confirmTitle').textContent = opts.title || '請輸入管理密碼確認';
    document.getElementById('confirmHint').textContent = opts.hint || '';
    modal.dataset.action = opts.action || '';
    modal.dataset.target = opts.target || '';
    document.getElementById('confirmInput').value = '';
    modal.style.display = 'flex';
  }
  function hideConfirmModal() {
    const modal = document.getElementById('confirmModal');
    modal.style.display = 'none';
    delete modal.dataset.action; delete modal.dataset.target;
  }
  document.getElementById('confirmCancel').addEventListener('click', hideConfirmModal);
  document.getElementById('confirmOk').addEventListener('click', async () => {
    const modal = document.getElementById('confirmModal');
    const pwd = document.getElementById('confirmInput').value;
    const action = modal.dataset.action;
    const target = modal.dataset.target;
    if (!pwd) { alert('請輸入密碼'); return; }
    try {
      if (action === 'delete-order') {
        await performDeleteOrder(target, pwd);
        hideConfirmModal();
        loadDashboard();
      } else if (action === 'delete-inventory') {
        await performDeleteInventory(target, pwd);
        hideConfirmModal();
        loadProducts();
      } else {
        hideConfirmModal();
        alert('未知操作');
      }
    } catch (e) {
      alert('操作失敗: ' + (e.message || e));
    }
  });

  /* ==================== Delete / Upload functions (call backend) ==================== */
  async function performDeleteOrder(order_id, password) {
    const res = await fetch(`${API_ENDPOINT}/admin/delete-order`, {
      method: 'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ password, order_id })
    });
    const data = await res.json();
    if (!res.ok || data.error) throw new Error(data.error || 'delete-order failed');
    alert('已刪除訂單 ' + order_id);
    return data;
  }
  async function performDeleteInventory(sku, password) {
    const res = await fetch(`${API_ENDPOINT}/admin/delete-inventory`, {
      method: 'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ password, sku })
    });
    const data = await res.json();
    if (!res.ok || data.error) throw new Error(data.error || 'delete-inventory failed');
    alert(`SKU ${sku} 刪除完成 (${data.action || 'done'})`);
    return data;
  }

  /* ==================== Excel upload (SheetJS) ==================== */
  document.getElementById('upload-inventory-btn').addEventListener('click', async () => {
    const fi = document.getElementById('inventory-file');
    if (!fi.files || fi.files.length === 0) { alert('請先選擇 Excel 檔'); return; }
    const file = fi.files[0];
    try {
      await handleInventoryUpload(file);
      fi.value = '';
      loadProducts();
    } catch (e) {
      alert('上傳失敗: ' + (e.message || e));
    }
  });

  async function handleInventoryUpload(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = e.target.result;
          const workbook = XLSX.read(data, { type: 'binary' });
          const firstSheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[firstSheetName];
          const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
          if (!rows || rows.length === 0) return reject(new Error('解析不到任何資料'));
          const normalized = rows.map(r => {
            const lower = {};
            Object.keys(r).forEach(k => lower[k.trim().toLowerCase()] = r[k]);
            return {
              sku: String(lower.sku || lower['商品編號'] || lower['item sku'] || lower['code'] || '').trim(),
              barcode: String(lower.barcode || lower['條碼'] || '').trim() || null,
              name: String(lower.name || lower['名稱'] || lower['product'] || '').trim(),
              price_live: Number(lower.price_live || lower['售價'] || lower.price || 0),
              cost: Number(lower.cost || lower['成本'] || 0),
              stock_on_hand: Number(lower.stock_on_hand || lower['庫存'] || lower.stock || 0)
            };
          }).filter(r => r.sku);
          if (normalized.length === 0) return reject(new Error('沒有合法的 SKU 欄位'));
          const pwd = prompt('請輸入管理密碼（password/op_key）以送出上傳');
          if (!pwd) return reject(new Error('未輸入密碼'));
          const res = await fetch(`${API_ENDPOINT}/admin/upload-inventory`, {
            method: 'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ password: pwd, rows: normalized })
          });
          const json = await res.json();
          if (!res.ok || json.error) return reject(new Error(json.error || 'upload failed'));
          alert(`上傳完成 — 已處理 ${json.rows_processed || 0} 筆資料`);
          resolve(json);
        } catch (err) { reject(err); }
      };
      reader.onerror = (err) => reject(err);
      reader.readAsBinaryString(file);
    });
  }

  /* ------------------- CSV export helpers (COD / MAIL / zero packages) ------------------- */
  document.getElementById('export-cod').addEventListener('click', () => exportCSV('cod'));
  document.getElementById('export-mail').addEventListener('click', () => exportCSV('mail'));
  function exportCSV(type) {
    if (!CACHED_ORDERS || CACHED_ORDERS.length === 0) { alert('請先「載入待出貨訂單」'); return; }
    let csvContent = ""; let filteredOrders = [];
    if (type === 'cod') {
      csvContent = "取件人姓名,取件人手機,取件門市,溫層,商品名稱,訂單金額\n";
      filteredOrders = CACHED_ORDERS.filter(o => o.payment_method === '7-11_COD' || o.payment_method === 'DEPOSIT_COD');
      filteredOrders.forEach(o => {
        let s = {}; try { s = JSON.parse(o.shipping_info || '{}'); } catch(e) {}
        csvContent += [s.name || '', s.phone || '', s.store_name || '','常溫','商品一批', o.total_amount || 0].join(',') + '\n';
      });
    } else {
      csvContent = "收件人姓名,收件人手機,收件地址\n";
      filteredOrders = CACHED_ORDERS.filter(o => o.payment_method === 'MAIL' || o.payment_method === '7-11_PAID');
      filteredOrders.forEach(o => {
        let s = {}; try { s = JSON.parse(o.shipping_info || '{}'); } catch(e) {}
        const address = (o.payment_method === 'MAIL') ? (s.address || '') : `${s.store_name || ''} ${s.store_address || ''}`;
        csvContent += [s.name || '', s.phone || '', address.replace(/,/g, ' ')].join(',') + '\n';
      });
    }
    if (filteredOrders.length === 0) { alert(`沒有找到符合「${type}」類型的待出貨訂單`); return; }
    const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a"); const url = URL.createObjectURL(blob);
    link.setAttribute("href", url); link.setAttribute("download", `${type}_export_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link); link.click(); document.body.removeChild(link);
  }

  /* export-zero-packages (calls backend) */
  document.getElementById('export-zero-packages').addEventListener('click', async () => {
    try {
      const data = await apiCall('/admin/export-zero-packages', {});
      if (!data.csv) { alert('沒有 0 元包裹可匯出'); return; }
      const blob = new Blob([new Uint8Array([0xEF,0xBB,0xBF]), data.csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = 'zero-packages.csv';
      document.body.appendChild(link); link.click(); document.body.removeChild(link);
    } catch (e) { alert('匯出 0 元包裹失敗: ' + e.message); }
  });

  /* ==================== Misc quick test endpoints ==================== */
  // ping test (not used directly in UI but helpful)
  async function ping() { try { const r = await fetch(`${API_ENDPOINT}/ping`); return await r.json(); } catch(_) { return null; } }

  /* ==================== init: try to auto-login if OP_KEY blank? (no) ==================== */
  // (leave manual login for security)

</script>
</body>
</html>
