<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MURAIN â€” è¨‚å–®å¾Œå°</title>
<style>
  *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC",Roboto}
  body{margin:0;background:#020617;color:#e2e8f0}
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  h1{margin:0 0 12px;font-size:22px}
  .card{background:rgba(15,23,42,.95);border-radius:16px;border:1px solid rgba(148,163,184,.3);padding:16px;margin-top:12px;box-shadow:0 10px 30px rgba(0,0,0,.5)}
  label{display:block;font-size:13px;margin:6px 0 4px}
  input,select,textarea{width:100%;padding:9px 10px;border-radius:10px;border:1px solid rgba(148,163,184,.6);background:rgba(15,23,42,.9);color:#e2e8f0;font-size:14px}
  textarea{min-height:70px;resize:vertical}
  input:focus,select:focus,textarea:focus{outline:2px solid #38bdf8;outline-offset:1px;border-color:#38bdf8}
  .row{display:grid;grid-template-columns:1.3fr 1.7fr;gap:12px}
  @media (max-width:800px){.row{grid-template-columns:1fr}}
  .btn{border:none;border-radius:999px;padding:8px 14px;font-size:13px;font-weight:500;cursor:pointer}
  .btn-primary{background:#22d3ee;color:#0f172a;box-shadow:0 8px 24px rgba(34,211,238,.4)}
  .btn-secondary{background:transparent;color:#e5e7eb;border:1px solid rgba(148,163,184,.7)}
  .btn:disabled{opacity:.6;cursor:not-allowed;box-shadow:none}
  .flex{display:flex;align-items:center;gap:8px}
  .flex-between{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .mt-2{margin-top:8px}
  .mt-3{margin-top:12px}
  .mt-4{margin-top:16px}
  .muted{font-size:12px;color:#94a3b8}
  table{width:100%;border-collapse:collapse;font-size:13px;margin-top:8px}
  th,td{padding:6px 8px;border-bottom:1px solid rgba(30,41,59,.9);text-align:left;vertical-align:top}
  th{font-size:12px;color:#9ca3af}
  tr:hover{background:rgba(15,23,42,.8);cursor:pointer}
  .status-pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px}
  .st-submitted{background:rgba(34,197,94,.1);color:#bbf7d0}
  .st-shipped{background:rgba(34,211,238,.1);color:#67e8f9}
  .st-cancelled{background:rgba(248,113,113,.12);color:#fecaca}
  .st-draft,.st-pending{background:rgba(148,163,184,.15);color:#e5e7eb}
  .tag{display:inline-block;padding:2px 6px;border-radius:999px;background:rgba(15,23,42,.9);border:1px solid rgba(148,163,184,.5);font-size:11px;margin-left:4px}
  .mono{font-family:Menlo,Consolas,monospace;font-size:12px}
  .right{text-align:right}
  .no-print{}
  @media print{
    .no-print{display:none !important}
    body{background:#fff;color:#000}
    .wrap{max-width:none}
    .card{box-shadow:none;border:none;padding:0;margin:0}
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>è¨‚å–®å¾Œå°ï¼ˆMURAINï¼‰</h1>

  <!-- ç™»å…¥å€ï¼ˆOP_KEYï¼‰ -->
  <div class="card no-print" id="loginCard">
    <div class="flex-between">
      <div>
        <div style="font-size:14px;font-weight:600">å¾Œå°ç™»å…¥</div>
        <div class="muted">è¼¸å…¥ä½ åœ¨ Worker è¨­å®šçš„ OP_KEYï¼ˆä¾‹å¦‚ 88ï¼‰ï¼Œåƒ…è‡ªå·±ä½¿ç”¨ã€‚</div>
      </div>
    </div>
    <div class="mt-3" style="max-width:260px">
      <label>OP_KEY</label>
      <input id="opKeyInput" type="password" autocomplete="off" />
      <div class="mt-2 flex" style="gap:6px">
        <button class="btn btn-primary" id="loginBtn">ç™»å…¥</button>
        <button class="btn btn-secondary" id="clearKeyBtn">æ¸…é™¤è¨˜éŒ„</button>
      </div>
      <div class="muted mt-2" id="loginStatus"></div>
    </div>
  </div>

  <!-- è¨‚å–®åˆ—è¡¨ -->
  <div class="card" id="ordersCard" style="display:none">
    <div class="flex-between no-print">
      <div class="flex">
        <div style="font-size:14px;font-weight:600">è¨‚å–®åˆ—è¡¨</div>
        <span class="tag" id="orderCountTag">0 ç­†</span>
      </div>
      <div class="flex" style="gap:6px;flex-wrap:wrap;justify-content:flex-end">
        <label style="font-size:12px">ç‹€æ…‹</label>
        <select id="statusFilter" style="max-width:160px">
          <option value="all">å…¨éƒ¨</option>
          <option value="submitted" selected>submittedï¼ˆå®Œæˆçµå¸³ / å¾…å‡ºè²¨ï¼‰</option>
          <option value="ready">readyï¼ˆå¾…å‡ºè²¨ï¼‰</option>
          <option value="shipped">shippedï¼ˆå·²å‡ºè²¨ï¼‰</option>
          <option value="cancelled">cancelledï¼ˆå·²å–æ¶ˆï¼‰</option>
        </select>
        <label style="font-size:12px">èµ·</label>
        <input type="date" id="startDate" style="max-width:140px" />
        <label style="font-size:12px">è¿„</label>
        <input type="date" id="endDate" style="max-width:140px" />
        <button class="btn btn-secondary" id="refreshBtn">é‡æ–°æ•´ç†</button>
      </div>
    </div>

    <table id="orderTable">
      <thead>
        <tr>
          <th>è¨‚å–®ç·¨è™Ÿ / å»ºç«‹æ™‚é–“</th>
          <th>ä»˜æ¬¾æ–¹å¼</th>
          <th>æ”¶ä»¶äºº</th>
          <th>é‡‘é¡</th>
          <th>å‡ºè²¨ç‹€æ…‹ / é‹è²»</th>
        </tr>
      </thead>
      <tbody id="orderTbody"></tbody>
    </table>
    <div class="muted no-print">ï¼Šé»ä»»ä¸€åˆ—å¯åœ¨ä¸‹æ–¹æŸ¥çœ‹ / ç·¨è¼¯å‡ºè²¨è³‡è¨Šã€‚</div>
  </div>

  <!-- è©³ç´° / å‡ºè²¨è³‡è¨Š -->
  <div class="card" id="detailCard" style="display:none">
    <div class="flex-between">
      <div>
        <div style="font-size:14px;font-weight:600">è¨‚å–®è©³ç´° / å‡ºè²¨è³‡è¨Š</div>
        <div class="muted" id="detailTitle"></div>
      </div>
      <div class="no-print">
        <button class="btn btn-secondary" id="printBtn">åˆ—å°å‡ºè²¨å–®</button>
      </div>
    </div>

    <div class="mt-3 row">
      <div>
        <label>è¨‚å–®ç·¨è™Ÿ</label>
        <div class="mono" id="dOrderId"></div>

        <label class="mt-2">å»ºç«‹æ™‚é–“</label>
        <div class="mono" id="dCreatedAt"></div>

        <label class="mt-2">ä»˜æ¬¾æ–¹å¼</label>
        <div id="dPaymentMethod" class="mono"></div>

        <label class="mt-2">æ‡‰ä»˜é‡‘é¡</label>
        <div id="dTotal" class="mono"></div>

        <label class="mt-2">å‚™è¨»ï¼ˆå‰å°å¡«å¯«ï¼‰</label>
        <div id="dNote" class="mono"></div>
      </div>

      <div>
        <label>æ”¶ä»¶äºº</label>
        <div id="dShipName"></div>

        <label class="mt-2">é›»è©±</label>
        <div id="dShipPhone"></div>

        <label class="mt-2">Email</label>
        <div id="dShipEmail"></div>

        <label class="mt-2">å–è²¨æ–¹å¼ / åœ°å€</label>
        <div id="dShipAddr"></div>
      </div>
    </div>

    <!-- å•†å“æ˜ç´° -->
    <div class="mt-3">
      <label>å•†å“æ˜ç´°</label>
      <table>
        <thead>
          <tr>
            <th>å“å / SKU</th>
            <th>å–®åƒ¹</th>
            <th>æ•¸é‡</th>
            <th>å°è¨ˆ</th>
          </tr>
        </thead>
        <tbody id="itemsTbody"></tbody>
      </table>
    </div>

    <hr class="mt-3" style="border:none;border-top:1px solid rgba(30,41,59,.9)" />

    <div class="mt-2 row">
      <div>
        <label>å‡ºè²¨ç‹€æ…‹</label>
        <select id="shipStatus">
          <option value="">ï¼ˆæœªè¨­å®šï¼‰</option>
          <option value="submitted">submittedï¼ˆå¾…è™•ç†ï¼‰</option>
          <option value="ready">readyï¼ˆå¾…å‡ºè²¨ï¼‰</option>
          <option value="shipped">shippedï¼ˆå·²å‡ºè²¨ï¼‰</option>
          <option value="cancelled">cancelledï¼ˆå·²å–æ¶ˆï¼‰</option>
        </select>

        <label class="mt-2">ç‰©æµå–®è™Ÿ / æ‰˜é‹å–®è™Ÿ</label>
        <input id="shipNo" />

        <label class="mt-2">é‹è²»ï¼ˆTWDï¼‰</label>
        <input id="shipFee" type="number" step="1" />

        <label class="mt-2">å…§éƒ¨å‚™è¨»ï¼ˆå‡ºè²¨ / é€€è²¨ç­‰èªªæ˜ï¼‰</label>
        <textarea id="shipNote"></textarea>

        <div class="mt-2 flex no-print" style="gap:8px">
          <button class="btn btn-primary" id="saveShipBtn">å„²å­˜å‡ºè²¨è³‡è¨Š</button>
          <button class="btn btn-secondary" id="copyMsgBtn">è¤‡è£½å‡ºè²¨é€šçŸ¥æ–‡å­—</button>
        </div>
        <div class="muted mt-1" id="saveStatus"></div>
      </div>

      <div class="no-print">
        <label>å‡ºè²¨é€šçŸ¥æ–‡å­—ï¼ˆé è¦½ï¼‰</label>
        <textarea id="notifyPreview" readonly style="opacity:.9"></textarea>
        <div class="muted mt-1">ï¼Šé»ã€Œè¤‡è£½å‡ºè²¨é€šçŸ¥æ–‡å­—ã€å¯ç›´æ¥è²¼åˆ° å®˜æ–¹ LINE / ç§è¨Šã€‚</div>
      </div>
    </div>
  </div>
</div>

<script>
const API = (window.API_BASE || 'https://api.murain.tw').replace(/\/$/,'');
const $ = (s,r=document)=>r.querySelector(s);
const $$ = (s,r=document)=>[...r.querySelectorAll(s)];
const fmtMoney = n => 'NT$ ' + Number(n||0).toLocaleString();

let adminKey = '';
let orders = [];
let currentOrder = null;
let currentItems = [];

// è®€å– / å„²å­˜ OP_KEY
function loadKey(){
  try{
    const k = localStorage.getItem('murain_admin_op_key') || '';
    if(k){
      adminKey = k;
      $('#opKeyInput').value = k;
    }
  }catch(e){}
}
function saveKey(k){
  adminKey = k || '';
  try{
    if(k) localStorage.setItem('murain_admin_op_key', k);
    else localStorage.removeItem('murain_admin_op_key');
  }catch(e){}
}

// ç‹€æ…‹é¡¯ç¤º pill class
function statusClass(st){
  if(!st) return 'status-pill st-draft';
  const s = String(st).toLowerCase();
  if(s==='submitted') return 'status-pill st-submitted';
  if(s==='ready') return 'status-pill st-submitted';
  if(s==='shipped') return 'status-pill st-shipped';
  if(s==='cancelled') return 'status-pill st-cancelled';
  return 'status-pill st-draft';
}
function statusLabel(st){
  if(!st) return 'ï¼ˆæœªè¨­å®šï¼‰';
  const s = String(st).toLowerCase();
  if(s==='submitted') return 'submittedï¼ˆå¾…è™•ç†ï¼‰';
  if(s==='ready') return 'readyï¼ˆå¾…å‡ºè²¨ï¼‰';
  if(s==='shipped') return 'shippedï¼ˆå·²å‡ºè²¨ï¼‰';
  if(s==='cancelled') return 'cancelledï¼ˆå·²å–æ¶ˆï¼‰';
  return s;
}

// è§£æ shipping_info JSON
function parseShip(raw){
  let info = {};
  try{
    if(raw) info = JSON.parse(raw);
  }catch(e){}
  const ship = info.ship || {};
  const res = {
    type: ship.type || '',
    name: ship.name || '',
    phone: ship.phone || '',
    email: ship.email || '',
    addr: '',
    store: ship.store || null,
    post: ship.post || null,
    note: info.note || '',
    summary: ''
  };
  if(ship.type === '711' && ship.store){
    res.addr = `7-11 ${ship.store.name || ''}ï¼ˆ${ship.store.id || ''}ï¼‰${ship.store.addr || ''}`;
    res.summary = res.addr;
  }else if(ship.type === 'post' && ship.post){
    res.addr = `${ship.post.zip || ''} ${ship.post.addr || ''}`;
    res.summary = 'éƒµå¯„ï¼š' + res.addr;
  }
  return res;
}

async function loadOrders(){
  if(!adminKey){
    $('#loginStatus').textContent = 'è«‹å…ˆè¼¸å…¥ OP_KEY ç™»å…¥ã€‚';
    return;
  }
  $('#loginStatus').textContent = 'è®€å–è¨‚å–®ä¸­â€¦';
  $('#ordersCard').style.display = 'block';
  $('#detailCard').style.display = 'none';
  $('#orderTbody').innerHTML = '';
  $('#orderCountTag').textContent = '0 ç­†';

  const status = $('#statusFilter').value || 'all';
  const start = $('#startDate').value || '';
  const end   = $('#endDate').value || '';

  const url = new URL(API + '/admin/orders');
  url.searchParams.set('op_key', adminKey);
  url.searchParams.set('status', status);
  if(start) url.searchParams.set('start', start);
  if(end)   url.searchParams.set('end', end);

  try{
    const r = await fetch(url.toString());
    const j = await r.json();
    if(!r.ok || !j.ok){
      $('#loginStatus').textContent = 'è®€å–å¤±æ•—ï¼š' + (j.error || r.status);
      return;
    }
    orders = j.orders || [];
    $('#orderCountTag').textContent = orders.length + ' ç­†';

    const tb = $('#orderTbody');
    tb.innerHTML = '';

    orders.forEach(o=>{
      const tr = document.createElement('tr');
      tr.dataset.orderId = o.order_id || '';
      const ship = parseShip(o.shipping_info);
      const fee = Number(o.ship_fee || 0);
      const feeText = fee ? ('é‹è²»å·²ç™»è¨˜ï¼š' + fmtMoney(fee)) : 'é‹è²»æœªç™»è¨˜';
      tr.innerHTML = `
        <td>
          <div class="mono">${o.order_id || ''}</div>
          <div class="muted" style="font-size:11px">${o.created_at || ''}</div>
        </td>
        <td class="mono">${o.payment_method || ''}</td>
        <td>
          ${ship.name || ''}<br>
          <span class="muted" style="font-size:11px">${ship.summary || ''}</span>
        </td>
        <td class="right mono">${fmtMoney(o.total_amount)}</td>
        <td>
          <span class="${statusClass(o.ship_status || o.status)}">${statusLabel(o.ship_status || o.status)}</span>
          <div class="muted" style="font-size:11px;margin-top:2px">${feeText}</div>
        </td>
      `;
      tr.addEventListener('click', ()=>selectOrder(o.order_id));
      tb.appendChild(tr);
    });

    $('#loginStatus').textContent = 'å·²è¼‰å…¥ ' + orders.length + ' ç­†è¨‚å–®ã€‚';
  }catch(e){
    console.error(e);
    $('#loginStatus').textContent = 'è®€å–å¤±æ•—ï¼ˆç¶²è·¯æˆ–ç¨‹å¼éŒ¯èª¤ï¼‰';
  }
}

// æŠŠ detail API å›ä¾†çš„å•†å“æ˜ç´°ç•«åœ¨è¡¨æ ¼
function renderItemsTable(items){
  const tb = $('#itemsTbody');
  tb.innerHTML = '';
  items.forEach(it=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        ${it.name || ''}<br>
        <span class="mono muted">${it.sku || ''}</span>
      </td>
      <td class="mono right">${fmtMoney(it.price || 0)}</td>
      <td class="mono">${it.qty || 0}</td>
      <td class="mono right">${fmtMoney(it.subtotal || 0)}</td>
    `;
    tb.appendChild(tr);
  });
}

// å–å¾—å–®ç­†è©³ç´°ï¼ˆå«å•†å“æ˜ç´°ï¼‰
async function selectOrder(orderId){
  if(!orderId || !adminKey) return;
  $('#detailCard').style.display = 'block';
  $('#detailTitle').textContent = 'è®€å–ä¸­â€¦';

  const url = new URL(API + '/admin/order/detail');
  url.searchParams.set('op_key', adminKey);
  url.searchParams.set('order_id', orderId);

  try{
    const r = await fetch(url.toString());
    const j = await r.json();
    if(!r.ok || !j.ok){
      $('#detailTitle').textContent = 'è®€å–å¤±æ•—ï¼š' + (j.error || r.status);
      return;
    }
    currentOrder = j.order || {};
    currentItems = j.items || [];
    const o = currentOrder;
    const ship = parseShip(o.shipping_info);

    $('#detailTitle').textContent = (ship.name || '') + ' / ' + (ship.summary || '');
    $('#dOrderId').textContent = o.order_id || '';
    $('#dCreatedAt').textContent = o.created_at || '';
    $('#dPaymentMethod').textContent = o.payment_method || '';
    $('#dTotal').textContent = fmtMoney(o.total_amount || 0);
    $('#dNote').textContent = ship.note || '';

    $('#dShipName').textContent = ship.name || '';
    $('#dShipPhone').textContent = ship.phone || '';
    $('#dShipEmail').textContent = ship.email || '';
    $('#dShipAddr').textContent = ship.addr || '';

    $('#shipStatus').value = o.ship_status || '';
    $('#shipNo').value = o.ship_no || '';
    $('#shipFee').value = o.ship_fee || '';
    $('#shipNote').value = o.ship_note || '';

    renderItemsTable(currentItems);
    updateNotifyPreview();
    $('#saveStatus').textContent = '';
  }catch(e){
    console.error(e);
    $('#detailTitle').textContent = 'è®€å–å¤±æ•—ï¼ˆç¶²è·¯æˆ–ç¨‹å¼éŒ¯èª¤ï¼‰';
  }
}

// ç”¢ç”Ÿå‡ºè²¨é€šçŸ¥æ–‡å­—ï¼ˆçµ¦å®¢äººï¼‰
function buildNotifyText(){
  if(!currentOrder) return '';
  const ship = parseShip(currentOrder.shipping_info);
  const name = ship.name || 'è¦ªæ„›çš„é¡§å®¢';
  const amt = fmtMoney(currentOrder.total_amount || 0);
  const shipNo = $('#shipNo').value || '';
  const shipStatus = $('#shipStatus').value || '';
  const orderId = currentOrder.order_id || '';
  const shipLine =
    ship.type === '711'
      ? `å–è²¨æ–¹å¼ï¼š7-11 ${ship.store?.name || ''}ï¼ˆ${ship.store?.id || ''}ï¼‰\né–€å¸‚åœ°å€ï¼š${ship.store?.addr || ''}`
      : `å¯„é€æ–¹å¼ï¼šéƒµå¯„ï¼ˆä¸­è¯éƒµæ”¿ï¼‰\næ”¶ä»¶åœ°å€ï¼š${ship.addr || ''}`;

  let statusTxt = '';
  if(shipStatus === 'shipped') statusTxt = 'å·²ç‚ºæ‚¨å®‰æ’å‡ºè²¨ ğŸ';
  else if(shipStatus === 'ready') statusTxt = 'å·²ç‚ºæ‚¨æº–å‚™å¾…å‡ºè²¨ï¼Œå°‡ç›¡å¿«ç‚ºæ‚¨å¯„å‡º ğŸ™Œ';
  else statusTxt = 'è¨‚å–®å·²æˆç«‹ âœ…';

  const track = shipNo ? `\nç‰©æµå–®è™Ÿï¼š${shipNo}` : '';

  // å•†å“ç°¡çŸ­æ˜ç´°ï¼ˆé¿å…å¤ªé•·ï¼Œåªåˆ—å‰ 5 ç­†ï¼‰
  const lines = (currentItems || []).slice(0,5).map(it =>
    `ãƒ»${it.name || it.sku || ''} x ${it.qty || 0}`
  );
  const itemsBlock = lines.length ? `å•†å“æ˜ç´°ï¼š\n${lines.join('\n')}\n` : '';

  const note = $('#shipNote').value ? `\n\nå…§éƒ¨å‚™è¨»ï¼š${$('#shipNote').value}` : '';

  return [
    `[MURAIN å‡ºè²¨é€šçŸ¥]`,
    ``,
    `${name} æ‚¨å¥½ï½`,
    ``,
    `æ‚¨çš„è¨‚å–® ${orderId} ${statusTxt}`,
    shipLine,
    itemsBlock,
    `æ‡‰ä»˜é‡‘é¡ï¼š${amt}`,
    track,
    ``,
    `æœ‰ä»»ä½•å•é¡Œéƒ½å¯ä»¥éš¨æ™‚ç§è¨Š MURAIN å®˜æ–¹ LINE å–”ğŸ¥°`,
    note
  ].join('\n');
}

function updateNotifyPreview(){
  $('#notifyPreview').value = buildNotifyText();
}

// å„²å­˜å‡ºè²¨è³‡è¨Š
async function saveShipping(){
  if(!currentOrder || !adminKey) return;
  const body = {
    op_key: adminKey,
    order_id: currentOrder.order_id,
    ship_status: $('#shipStatus').value || '',
    ship_no: $('#shipNo').value || '',
    ship_fee: Number($('#shipFee').value || 0),
    ship_note: $('#shipNote').value || ''
  };
  $('#saveStatus').textContent = 'å„²å­˜ä¸­â€¦';
  try{
    const r = await fetch(API + '/admin/order/update', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    const j = await r.json();
    if(!r.ok || !j.ok){
      $('#saveStatus').textContent = 'å„²å­˜å¤±æ•—ï¼š' + (j.error || r.status);
      return;
    }
    currentOrder.ship_status = body.ship_status;
    currentOrder.ship_no = body.ship_no;
    currentOrder.ship_fee = body.ship_fee;
    currentOrder.ship_note = body.ship_note;
    updateNotifyPreview();
    $('#saveStatus').textContent = 'å·²å„²å­˜ âœ…';
    loadOrders(); // é‡æ–°åˆ·æ–°åˆ—è¡¨ï¼Œè®“ç‹€æ…‹ / é‹è²»é¡¯ç¤ºæ›´æ–°
  }catch(e){
    console.error(e);
    $('#saveStatus').textContent = 'å„²å­˜å¤±æ•—ï¼ˆç¶²è·¯æˆ–ç¨‹å¼éŒ¯èª¤ï¼‰';
  }
}

// ç¶å®šäº‹ä»¶
document.getElementById('loginBtn').addEventListener('click', ()=>{
  const k = $('#opKeyInput').value.trim();
  if(!k){ alert('è«‹å…ˆè¼¸å…¥ OP_KEY'); return; }
  saveKey(k);
  $('#loginStatus').textContent = 'å·²ç™»å…¥ï¼Œé–‹å§‹è®€å–è¨‚å–®â€¦';
  $('#ordersCard').style.display = 'block';
  loadOrders();
});
$('#clearKeyBtn').addEventListener('click', ()=>{
  saveKey('');
  $('#opKeyInput').value = '';
  $('#ordersCard').style.display = 'none';
  $('#detailCard').style.display = 'none';
  $('#loginStatus').textContent = 'å·²æ¸…é™¤ OP_KEYã€‚';
});
$('#refreshBtn').addEventListener('click', loadOrders);
$('#statusFilter').addEventListener('change', loadOrders);
$('#startDate').addEventListener('change', loadOrders);
$('#endDate').addEventListener('change', loadOrders);

$('#shipStatus').addEventListener('change', updateNotifyPreview);
$('#shipNo').addEventListener('input', updateNotifyPreview);
$('#shipFee').addEventListener('input', ()=>{});
$('#shipNote').addEventListener('input', updateNotifyPreview);
$('#saveShipBtn').addEventListener('click', saveShipping);
$('#copyMsgBtn').addEventListener('click', async ()=>{
  const txt = buildNotifyText();
  try{
    await navigator.clipboard.writeText(txt);
    $('#saveStatus').textContent = 'å·²è¤‡è£½å‡ºè²¨é€šçŸ¥æ–‡å­— âœ…';
  }catch(e){
    $('#saveStatus').textContent = 'è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½ã€‚';
  }
});
$('#printBtn').addEventListener('click', ()=>{ window.print(); });

// åˆå§‹åŒ–
loadKey();
if(adminKey){
  $('#loginStatus').textContent = 'å·²å¾ç€è¦½å™¨è®€å– OP_KEYï¼Œæº–å‚™è¼‰å…¥è¨‚å–®â€¦';
  $('#ordersCard').style.display = 'block';
  loadOrders();
}
</script>
</body>
</html>
