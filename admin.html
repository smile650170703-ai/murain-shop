<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MURAIN â€” è¨‚å–®å¾Œå°</title>
<style>
  *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC",Roboto}
  body{margin:0;background:#020617;color:#e2e8f0}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  h1{margin:0 0 12px;font-size:24px}
  .toolbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
  .filter-group{display:flex;flex-wrap:wrap;gap:6px}
  .filter-btn{padding:7px 12px;border-radius:999px;border:1px solid rgba(148,163,184,.7);background:rgba(15,23,42,.9);color:#e5e7eb;font-size:13px;cursor:pointer}
  .filter-btn.active{background:#22d3ee;color:#0f172a;border-color:#22d3ee;box-shadow:0 8px 20px rgba(34,211,238,.35)}
  .small-btn{padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.7);background:transparent;color:#e5e7eb;font-size:12px;cursor:pointer}
  .layout{display:grid;grid-template-columns:minmax(0,0.9fr) minmax(0,1.1fr);gap:12px}
  @media (max-width:900px){.layout{grid-template-columns:1fr;}}
  .card{background:rgba(15,23,42,.95);border-radius:16px;border:1px solid rgba(148,163,184,.3);padding:10px;min-height:120px}
  #orderList{max-height:calc(100vh - 170px);overflow:auto}
  .order-row{padding:8px 10px;border-radius:12px;cursor:pointer;border:1px solid transparent;margin-bottom:6px;background:rgba(15,23,42,.95)}
  .order-row:hover{border-color:rgba(148,163,184,.8);background:rgba(15,23,42,1)}
  .order-row.active{border-color:#22d3ee;background:rgba(15,23,42,1);box-shadow:0 8px 20px rgba(34,211,238,.25)}
  .ord-top{display:flex;justify-content:space-between;align-items:center;gap:6px;font-size:13px}
  .ord-id{font-weight:600}
  .ord-amount{font-weight:600}
  .ord-sub{font-size:12px;color:#94a3b8;margin-top:3px}
  .badges{display:flex;flex-wrap:wrap;gap:4px;font-size:11px;margin-top:4px}
  .badge{padding:2px 7px;border-radius:999px;border:1px solid rgba(148,163,184,.7);background:rgba(15,23,42,1)}
  .badge.green{border-color:#22c55e;color:#bbf7d0;background:rgba(22,163,74,.2)}
  .badge.yellow{border-color:#eab308;color:#facc15;background:rgba(234,179,8,.15)}
  .badge.red{border-color:#f97373;color:#fecaca;background:rgba(220,38,38,.2)}
  .badge.blue{border-color:#38bdf8;color:#bae6fd;background:rgba(56,189,248,.2)}
  .muted{font-size:13px;color:#94a3b8}
  .detail-grid{display:grid;grid-template-columns:1.1fr 0.9fr;gap:10px}
  @media (max-width:900px){.detail-grid{grid-template-columns:1fr}}
  label{display:block;font-size:12px;margin:6px 0 3px;color:#cbd5f5}
  input,select,textarea{width:100%;padding:8px 9px;border-radius:10px;border:1px solid rgba(148,163,184,.6);background:#020617;color:#e2e8f0;font-size:13px}
  textarea{min-height:70px;resize:vertical}
  input:focus,select:focus,textarea:focus{outline:2px solid #38bdf8;outline-offset:1px;border-color:#38bdf8}
  .row{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
  .mt-2{margin-top:8px}
  .mt-3{margin-top:12px}
  .mt-4{margin-top:16px}
  .btn-primary{margin-top:8px;padding:10px 14px;border-radius:999px;border:none;background:#22d3ee;color:#0f172a;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 10px 30px rgba(34,211,238,.35)}
  .btn-secondary{margin-top:8px;padding:8px 12px;border-radius:999px;border:1px solid rgba(148,163,184,.7);background:transparent;color:#e5e7eb;font-size:13px;cursor:pointer}
  .section-title{font-size:13px;font-weight:600;color:#e5e7eb;margin-top:4px;margin-bottom:2px}
  .pill{display:inline-block;padding:3px 7px;border-radius:999px;background:rgba(15,23,42,1);border:1px solid rgba(148,163,184,.6);font-size:11px;color:#cbd5f5;margin-right:4px;margin-top:2px}
  .tag-small{font-size:11px;color:#94a3b8}
  .label-inline{display:flex;align-items:center;gap:5px;font-size:12px;margin-top:4px}
  .label-inline input[type="checkbox"]{width:auto}
  .error{color:#fecaca;font-size:13px;margin-top:4px}
</style>
</head>
<body>
<div class="wrap">
  <h1>è¨‚å–®å¾Œå°</h1>
  <div class="toolbar">
    <div class="filter-group">
      <button class="filter-btn active" data-filter="all">å…¨éƒ¨è¨‚å–®</button>
      <button class="filter-btn" data-filter="pending_online">ç·šä¸Šä»˜æ¬¾å¾…ç¢ºèª</button>
      <button class="filter-btn" data-filter="ready_to_ship">å¾…å‡ºè²¨åˆ—å°</button>
      <button class="filter-btn" data-filter="deposit">ATM / è¨‚é‡‘</button>
    </div>
    <div>
      <span id="opLabel" class="tag-small"></span>
      <button id="btnChangeKey" class="small-btn">æ›´æ›ç®¡ç†å¯†ç¢¼</button>
    </div>
  </div>

  <div class="layout">
    <div class="card" id="orderList">
      <div class="muted">è¼‰å…¥ä¸­â€¦</div>
    </div>

    <div class="card" id="orderDetail">
      <div class="muted">è«‹å¾å·¦é‚Šé»é¸ä¸€ç­†è¨‚å–®</div>
    </div>
  </div>
</div>

<script>
const API = (window.API_BASE || 'https://api.murain.tw').replace(/\/$/,'');
const STORAGE_KEY = 'MURAIN_ADMIN_OP_KEY';

let OP_KEY = localStorage.getItem(STORAGE_KEY) || '';
let currentFilter = 'all';
let currentOrders = [];
let currentRecord = null;

const $ = (s,r=document)=>r.querySelector(s);
const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));

function money(n){ return 'NT$ ' + Number(n||0).toLocaleString(); }

function parseShippingInfo(fields){
  try{
    return JSON.parse(fields.shipping_info || '{}') || {};
  }catch(e){
    return {};
  }
}

function toDatetimeLocal(v){
  if(!v) return '';
  const d = new Date(v);
  if(isNaN(d.getTime())) return '';
  const pad = n => String(n).padStart(2,'0');
  return d.getFullYear() + '-' +
    pad(d.getMonth()+1) + '-' +
    pad(d.getDate()) + 'T' +
    pad(d.getHours()) + ':' +
    pad(d.getMinutes());
}

async function ensureOpKey(){
  $('#opLabel').textContent = OP_KEY ? 'å·²ç™»å…¥å¾Œå°' : 'å°šæœªç™»å…¥';
  while(!OP_KEY){
    const k = prompt('è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ (OP_KEY)');
    if(!k){ alert('æ²’æœ‰å¯†ç¢¼å°±ç„¡æ³•é€²å…¥å¾Œå°å–”'); continue; }
    try{
      const r = await fetch(`${API}/op/auth`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ op_key:k })
      });
      const j = await r.json();
      if(!r.ok || !j.ok){
        alert('å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡');
        continue;
      }
      OP_KEY = k;
      localStorage.setItem(STORAGE_KEY, OP_KEY);
      $('#opLabel').textContent = 'å·²ç™»å…¥å¾Œå°';
      break;
    }catch(e){
      console.error(e);
      alert('é©—è­‰å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  }
}

async function loadOrders(filter = 'all') {
  currentFilter = filter;
  const listEl = document.querySelector('#orderList');
  listEl.innerHTML = '<div class="muted">è¼‰å…¥ä¸­â€¦</div>';

  try {
    const r = await fetch(
      `${API}/admin/orders?filter=${encodeURIComponent(filter)}&op_key=${encodeURIComponent(OP_KEY)}`
    );
    const j = await r.json();
    if (!r.ok || !j.ok) {
      throw new Error(j.error || 'load_failed');
    }

    // å¾Œç«¯å›å‚³ { ok:true, orders:[...]}ï¼Œå¦‚æœæœªä¾†æ”¹æˆ records ä¹Ÿèƒ½ç›¸å®¹
    currentOrders = j.orders || j.records || [];
    renderOrderList();   // ç”¨ currentOrders ä¾†ç•«ç•«é¢
  } catch (e) {
    console.error(e);
    listEl.innerHTML = '<div class="error">è¼‰å…¥å¤±æ•—ï¼š' + (e.message || e) + '</div>';
  }
}



function statusBadgePay(pay){
  if(!pay) return '';
  let cls = 'badge';
  let text = pay;
  if(pay === 'paid_ok'){ cls += ' green'; text = 'å·²æ”¶æ¬¾'; }
  else if(pay === 'pending'){ cls += ' yellow'; text = 'å¾…ç¢ºèª'; }
  else if(pay === 'unpaid'){ cls += ''; text = 'æœªæ”¶æ¬¾'; }
  else if(pay === 'failed'){ cls += ' red'; text = 'å¤±æ•—/ä½œå»¢'; }
  return `<span class="${cls}">${text}</span>`;
}

function statusBadgeShip(st){
  if(!st) return '';
  let cls = 'badge blue';
  let text = st;
  if(st === 'none'){ text = 'æœªè¨­å®š'; cls='badge'; }
  else if(st === 'ready_to_ship'){ text = 'å¾…å‡ºè²¨'; }
  else if(st === 'shipped'){ text = 'å·²å‡ºè²¨'; }
  else if(st === 'returned'){ text = 'é€€è²¨'; cls='badge red'; }
  else if(st === 'cancelled'){ text = 'å–æ¶ˆ'; cls='badge red'; }
  return `<span class="${cls}">${text}</span>`;
}

function renderOrderList(){
  const listEl = $('#orderList');
  if(!currentOrders.length){
    listEl.innerHTML = '<div class="muted">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</div>';
    return;
  }

  const html = currentOrders.map(rec=>{
    const f = rec.fields || {};
    const shipInfo = parseShippingInfo(f);
    const ship = shipInfo.ship || {};
    const store = ship.store || {};
    const post = ship.post || {};
    let addr = '';
    if(ship.type === '711'){
      addr = `7-11 ${store.name || ''} (${store.id || ''}) ${store.addr || ''}`;
    }else if(ship.type === 'post'){
      addr = `éƒµå¯„ ${post.zip || ''} ${post.addr || ''}`;
    }
    const line2 = [ship.name, ship.phone, addr].filter(Boolean).join(' / ');
    const pay_b = statusBadgePay(f.pay_status);
    const ship_b = statusBadgeShip(f.ship_status);
    const method = f.payment_method || '';
    const created = f.created_at || '';
    const total = money(f.total_amount || f.total || 0);

    return `
      <div class="order-row" data-id="${rec.id}">
        <div class="ord-top">
          <div>
            <div class="ord-id">${f.order_id || '(ç„¡ç·¨è™Ÿ)'}</div>
            <div class="tag-small">${created}</div>
          </div>
          <div style="text-align:right">
            <div class="ord-amount">${total}</div>
            <div class="tag-small">${method}</div>
          </div>
        </div>
        <div class="ord-sub">${line2 || '&nbsp;'}</div>
        <div class="badges">
          ${pay_b}
          ${ship_b}
        </div>
      </div>
    `;
  }).join('');

  listEl.innerHTML = html;

  // ç¶å®šé»æ“Šé¸å–
  $$('#orderList .order-row').forEach(row=>{
    row.addEventListener('click', ()=>{
      $$('#orderList .order-row').forEach(x=>x.classList.remove('active'));
      row.classList.add('active');
      const id = row.getAttribute('data-id');
      selectOrder(id);
    });
  });

  // ä¿ç•™ç›®å‰é¸å–çš„é‚£ç­†
  if(currentRecord){
    const row = $(`#orderList .order-row[data-id="${currentRecord.id}"]`);
    if(row){
      row.classList.add('active');
    }else{
      currentRecord = null;
      $('#orderDetail').innerHTML = '<div class="muted">è«‹å¾å·¦é‚Šé»é¸ä¸€ç­†è¨‚å–®</div>';
    }
  }
}
function selectOrder(recordId) {
  const rec = currentOrders.find(x => x.id === recordId);
  if (!rec) return;
  renderDetail(rec);
}

function buildNoticeText(rec){
  const f = rec.fields || {};
  const shipInfo = parseShippingInfo(f);
  const ship = shipInfo.ship || {};
  const store = ship.store || {};
  const post = ship.post || {};
  const orderId = f.order_id || '';
  const total = money(f.total_amount || f.total || 0);
  const name = ship.name || 'è¦ªæ„›çš„å®¢äºº';

  let methodText = '';
  if(ship.type === '711'){
    methodText = `7-11 ${store.name || ''}ï¼ˆ${store.id || ''}ï¼‰`;
  }else if(ship.type === 'post'){
    methodText = `éƒµå¯„ ${post.zip || ''} ${post.addr || ''}`;
  }

  const today = new Date();
  const d = `${today.getFullYear()}/${today.getMonth()+1}/${today.getDate()}`;

  return `ã€MURAIN å‡ºè²¨é€šçŸ¥ã€‘

${name} æ‚¨å¥½ï½

æ‚¨çš„è¨‚å–® ${orderId} å·²æ–¼ ${d} å®‰æ’å‡ºè²¨ã€‚
å–è²¨æ–¹å¼ï¼š${methodText || 'â€”'}
æ‡‰ä»˜é‡‘é¡ï¼š${total}

åŒ…è£¹å¯„å‡ºå¾Œï¼Œå¯¦éš›åˆ°åº—/é€é”æ™‚é–“ä»ä»¥ç‰©æµç‚ºä¸»ï¼Œå¦‚æœ‰ä»»ä½•å•é¡Œéƒ½å¯ä»¥ç›´æ¥å›è¦†æ­¤è¨Šæ¯ï¼Œè¬è¬æ‚¨ğŸ’–`;
}

function renderDetail(rec){
  currentRecord = rec;
  const f = rec.fields || {};
  const dEl = $('#orderDetail');
  const shipInfo = parseShippingInfo(f);
  const ship = shipInfo.ship || {};
  const store = ship.store || {};
  const post = ship.post || {};
  const note = shipInfo.note || '';

  const addrText = (()=>{
    if(ship.type === '711'){
      return `7-11 ${store.name || ''}ï¼ˆ${store.id || ''}ï¼‰\n${store.addr || ''}`;
    }
    if(ship.type === 'post'){
      return `${post.zip || ''} ${post.addr || ''}`;
    }
    return '';
  })();

  const itemsText = f.items_text || '';
  const total = money(f.total_amount || f.total || 0);

  dEl.innerHTML = `
    <div class="detail-grid">
      <div>
        <div class="section-title">è¨‚å–® / å®¢æˆ¶è³‡è¨Š</div>
        <div class="pill">è¨‚å–®ç·¨è™Ÿï¼š<span>${f.order_id || ''}</span></div>
        <div class="pill">ä»˜æ¬¾æ–¹å¼ï¼š<span>${f.payment_method || ''}</span></div>
        <div class="pill">æ‡‰ä»˜é‡‘é¡ï¼š<span>${total}</span></div>
        <div class="pill">å»ºç«‹æ™‚é–“ï¼š<span>${f.created_at || ''}</span></div>

        <div class="mt-3">
          <div class="section-title">æ”¶ä»¶äºº / å–è²¨è³‡è¨Š</div>
          <label>æ”¶ä»¶äºº</label>
          <input id="d_ship_name" readonly value="${ship.name || ''}">
          <div class="row">
            <div>
              <label>é›»è©±</label>
              <input id="d_ship_phone" readonly value="${ship.phone || ''}">
            </div>
            <div>
              <label>Email</label>
              <input id="d_ship_email" readonly value="${ship.email || ''}">
            </div>
          </div>
          <label>å–è²¨æ–¹å¼ / åœ°å€</label>
          <textarea id="d_ship_addr" readonly>${addrText}</textarea>

          <label class="mt-2">å®¢æˆ¶å‚™è¨»</label>
          <textarea id="d_note" readonly>${note || ''}</textarea>

          <label class="mt-2">å•†å“æ˜ç´°</label>
          <textarea id="d_items_text" readonly>${itemsText}</textarea>
        </div>
      </div>

      <div>
        <div class="section-title">ä»˜æ¬¾ / å‡ºè²¨ç‹€æ…‹</div>
        <div class="row">
          <div>
            <label>ä»˜æ¬¾ç‹€æ…‹ (pay_status)</label>
            <select id="d_pay_status">
              <option value=""></option>
              <option value="unpaid"${f.pay_status==='unpaid'?' selected':''}>unpaidï¼ˆæœªæ”¶æ¬¾ï¼‰</option>
              <option value="pending"${f.pay_status==='pending'?' selected':''}>pendingï¼ˆå¾…ç¢ºèªï¼‰</option>
              <option value="paid_ok"${f.pay_status==='paid_ok'?' selected':''}>paid_okï¼ˆå·²æ”¶æ¬¾ï¼‰</option>
              <option value="failed"${f.pay_status==='failed'?' selected':''}>failedï¼ˆå¤±æ•—/ä½œå»¢ï¼‰</option>
            </select>
          </div>
          <div>
            <label>å‡ºè²¨ç‹€æ…‹ (ship_status)</label>
            <select id="d_ship_status">
              <option value=""></option>
              <option value="none"${f.ship_status==='none'?' selected':''}>noneï¼ˆæœªè¨­å®šï¼‰</option>
              <option value="ready_to_ship"${f.ship_status==='ready_to_ship'?' selected':''}>ready_to_shipï¼ˆå¾…å‡ºè²¨ï¼‰</option>
              <option value="shipped"${f.ship_status==='shipped'?' selected':''}>shippedï¼ˆå·²å‡ºè²¨ï¼‰</option>
              <option value="returned"${f.ship_status==='returned'?' selected':''}>returnedï¼ˆé€€è²¨ï¼‰</option>
              <option value="cancelled"${f.ship_status==='cancelled'?' selected':''}>cancelledï¼ˆå–æ¶ˆï¼‰</option>
            </select>
          </div>
        </div>

        <div class="row mt-2">
          <div>
            <label>ç‰©æµå–®è™Ÿ (ship_tracking)</label>
            <input id="d_ship_tracking" value="${f.ship_tracking || ''}">
          </div>
          <div>
            <label>é‹è²» TWD (ship_fee)</label>
            <input id="d_ship_fee" type="number" step="1" value="${f.ship_fee || ''}">
          </div>
        </div>

        <label class="mt-2">å‡ºè²¨æ™‚é–“ (ship_at)</label>
        <input id="d_ship_at" type="datetime-local" value="${toDatetimeLocal(f.ship_at)}">

        <label class="mt-3">è¨‚é‡‘ / åŒ¯æ¬¾è³‡è¨Š</label>
        <div class="row">
          <div>
            <label>è¨‚é‡‘é‡‘é¡ (deposit_amount)</label>
            <input id="d_deposit_amount" type="number" step="1" value="${f.deposit_amount || ''}">
          </div>
          <div>
            <label>åŒ¯æ¬¾å¾Œäº”ç¢¼ (deposit_last5)</label>
            <input id="d_deposit_last5" value="${f.deposit_last5 || ''}">
          </div>
        </div>

        <div class="row mt-2">
          <div>
            <label>è¨‚é‡‘åˆ°æœŸæ—¥ (deposit_expire_at)</label>
            <input id="d_deposit_expire_at" type="date" value="${(f.deposit_expire_at || '').slice(0,10)}">
          </div>
          <div>
            <label>ä¿ç•™åˆ° (hold_until)</label>
            <input id="d_hold_until" type="date" value="${(f.hold_until || '').slice(0,10)}">
          </div>
        </div>

        <div class="label-inline mt-2">
          <input id="d_deposit_received" type="checkbox" ${f.deposit_received ? 'checked':''}>
          <span>å·²æ”¶åˆ°è¨‚é‡‘ (deposit_received)</span>
        </div>
        <div class="label-inline">
          <input id="d_pay_notice_sent" type="checkbox" ${f.pay_notice_sent ? 'checked':''}>
          <span>å·²ç™¼å‡ºæ¬¾/ä¿ç•™é€šçŸ¥ (pay_notice_sent)</span>
        </div>

        <label class="mt-3">å…§éƒ¨å‚™è¨» (internal_note)</label>
        <textarea id="d_internal_note">${f.internal_note || ''}</textarea>

        <div class="mt-3 section-title">å‡ºè²¨é€šçŸ¥æ–‡å­—ï¼ˆé è¦½ï¼Œå¯è‡ªè¡Œä¿®æ”¹ï¼‰</div>
        <textarea id="d_notice_text">${buildNoticeText(rec)}</textarea>

        <button class="btn-primary" id="btnSaveDetail">å„²å­˜å‡ºè²¨ / ä»˜æ¬¾è³‡è¨Š</button>
        <button class="btn-secondary" id="btnCopyNotice">è¤‡è£½å‡ºè²¨é€šçŸ¥æ–‡å­—</button>
        <div id="detailMsg" class="tag-small mt-2"></div>
      </div>
    </div>
  `;

  $('#btnSaveDetail').addEventListener('click', saveDetail);
  $('#btnCopyNotice').addEventListener('click', copyNotice);
}

async function saveDetail(){
  if(!currentRecord) return;
  const f = currentRecord.fields || {};
  const msgEl = $('#detailMsg');
  msgEl.textContent = 'å„²å­˜ä¸­â€¦';

  const fields = {};

  fields.pay_status   = $('#d_pay_status').value || null;
  fields.ship_status  = $('#d_ship_status').value || null;
  fields.ship_tracking= $('#d_ship_tracking').value || '';
  const fee = $('#d_ship_fee').value.trim();
  fields.ship_fee     = fee ? Number(fee) : null;

  const depAmt = $('#d_deposit_amount').value.trim();
  fields.deposit_amount = depAmt ? Number(depAmt) : null;
  fields.deposit_last5  = $('#d_deposit_last5').value.trim() || '';
  fields.deposit_expire_at = $('#d_deposit_expire_at').value || null;
  fields.hold_until        = $('#d_hold_until').value || null;
  fields.deposit_received  = $('#d_deposit_received').checked;
  fields.pay_notice_sent   = $('#d_pay_notice_sent').checked;

  fields.internal_note = $('#d_internal_note').value || '';

  const shipAt = $('#d_ship_at').value;
  fields.ship_at = shipAt || null;

  try{
    const payload = {
      record_id: currentRecord.id,
      fields
    };
    const r = await fetch(`${API}/admin/order/update?op_key=${encodeURIComponent(OP_KEY)}`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    const j = await r.json();
    if(!r.ok || !j.ok){
      throw new Error(j.error || 'update_error');
    }
    msgEl.textContent = 'å·²å„²å­˜ âœ…';

    // é‡æ–°è¼‰å…¥åˆ—è¡¨ï¼Œä¿ç•™ç›®å‰é€™ä¸€ç­†
    const keepId = currentRecord.id;
    await loadOrders(currentFilter);
    const found = currentOrders.find(x=>x.id === keepId);
    if(found){
      renderDetail(found);
      const row = $(`#orderList .order-row[data-id="${keepId}"]`);
      if(row) row.classList.add('active');
    }
  }catch(e){
    console.error(e);
    msgEl.textContent = 'å„²å­˜å¤±æ•—ï¼š' + (e.message || e);
  }
}

async function copyNotice(){
  const ta = $('#d_notice_text');
  if(!ta) return;
  const text = ta.value || '';
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(text);
    }else{
      ta.select();
      document.execCommand('copy');
      window.getSelection().removeAllRanges();
    }
    alert('å·²è¤‡è£½å‡ºè²¨é€šçŸ¥æ–‡å­—ï¼Œå¯ä»¥è²¼åˆ° LINE / Messengerã€‚');
  }catch(e){
    console.error(e);
    alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—è¤‡è£½ã€‚');
  }
}

document.addEventListener('DOMContentLoaded', async ()=>{
  // åˆ‡æ› filter
  $$('.filter-btn').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      $$('.filter-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      await ensureOpKey();
      await loadOrders(btn.dataset.filter);
    });
  });

  $('#btnChangeKey').addEventListener('click', ()=>{
    localStorage.removeItem(STORAGE_KEY);
    OP_KEY = '';
    ensureOpKey().then(()=>loadOrders(currentFilter));
  });

  await ensureOpKey();
  await loadOrders('all');
});
</script>
</body>
</html>
