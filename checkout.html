<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>MURAIN — 結帳</title>
<style>
  *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC",Roboto}
  body{margin:0;background:#0b1222;color:#e2e8f0}
  .wrap{max-width:720px;margin:0 auto;padding:16px 16px calc(env(safe-area-inset-bottom,0) + 90px)}
  h1{margin:0 0 8px;font-size:22px}
  .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.4);margin-top:12px}
  label{display:block;font-size:14px;margin:8px 2px 6px}
  input,select,textarea{width:100%;padding:14px 12px;border-radius:12px;border:1px solid rgba(148,163,184,.6);background:rgba(15,23,42,.8);color:#e2e8f0;font-size:15px}
  input:focus,select:focus,textarea:focus{outline:2px solid #38bdf8;outline-offset:1px;border-color:#38bdf8}
  textarea{min-height:80px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:720px){.row{grid-template-columns:1fr}}
  .tabs{display:grid;grid-template-columns:repeat(4,1fr);border-radius:999px;background:rgba(15,23,42,.9);padding:4px;margin:8px 0 4px}
  .tab{padding:10px 4px;text-align:center;font-size:14px;border-radius:999px;border:none;background:transparent;color:#9ca3af;cursor:pointer}
  .tab.active{background:#22d3ee;color:#0f172a;font-weight:600;box-shadow:0 8px 20px rgba(34,211,238,.25)}
  .btn{margin-top:16px;width:100%;padding:16px 14px;border-radius:999px;border:none;background:#22d3ee;color:#0f172a;font-size:16px;font-weight:600;cursor:pointer;box-shadow:0 14px 40px rgba(34,211,238,.35);position:fixed;left:0;right:0;bottom:0;max-width:720px;margin-left:auto;margin-right:auto}
  .btn:disabled{opacity:.5;cursor:not-allowed;box-shadow:none}
  .btn.secondary{position:static;width:auto;margin-top:12px;padding:10px 16px;border-radius:999px;background:transparent;color:#e5e7eb;border:1px solid rgba(148,163,184,.8);box-shadow:none;font-size:14px}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:rgba(15,23,42,.9);border:1px solid rgba(148,163,184,.7);font-size:12px;color:#cbd5f5;margin-top:4px}
  .pill span{font-weight:600;color:#f97316}
  .muted{font-size:13px;color:#94a3b8;margin-top:4px}
  .highlight{font-size:18px;font-weight:600;margin:8px 0}
  .section-title{font-size:14px;font-weight:600;color:#e5e7eb;margin-bottom:4px}
  .tag{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(34,197,94,.12);color:#bbf7d0;font-size:11px;margin-left:6px}
  .badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:999px;background:rgba(34,211,238,.1);color:#22d3ee;font-size:11px;margin-left:6px}
  .badge-dot{width:6px;height:6px;border-radius:999px;background:#22d3ee}
  .hint{font-size:12px;color:#9ca3af;margin-top:2px}
  .pill-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .text-right{text-align:right}
  .mt-4{margin-top:16px}
  .mt-2{margin-top:8px}
  .flex{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .radio-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .radio-pill{padding:7px 11px;border-radius:999px;border:1px solid rgba(148,163,184,.7);font-size:12px;color:#e5e7eb;cursor:pointer;display:inline-flex;align-items:center;gap:4px}
  .radio-pill input{width:auto;margin:0}
  .radio-pill.active{background:#22d3ee;color:#0f172a;border-color:#22d3ee}
  .label-small{font-size:12px;color:#9ca3af}
</style>
</head>
<body>
<div class="wrap">
  <h1>結帳</h1>

  <div class="card">
    <div class="section-title">訂單金額</div>
    <label>商品小計（NT$）</label>
    <input id="subtotal" readonly />
    <div class="hint">．此金額會依購物車實際內容同步更新</div>

    <div class="mt-4 section-title">商品明細</div>
    <textarea id="itemsText" readonly></textarea>

    <div class="mt-4 section-title">應付金額</div>
    <input id="total" readonly />
    <div class="hint">．若有活動折扣，會已反映在應付金額中</div>

    <label class="mt-4">備註（選填）</label>
    <textarea id="note" placeholder="例如：希望週末送達、染髮前先幫我評估髮況…"></textarea>
    <div class="hint">．此頁一定要用結帳連結進入（帶 cart_token）。</div>
  </div>

  <div class="card">
    <div class="section-title">選擇付款 / 取貨方式</div>
    <div class="tabs" id="payTabs">
      <button class="tab active" data-pay="COD">7-11 貨到付款</button>
      <button class="tab" data-pay="PAID">線上付款</button>
      <button class="tab" data-pay="DEPOSIT">ATM 匯款</button>
      <button class="tab" data-pay="ZEROCARD">無卡零角</button>
    </div>
    <div class="muted">可依不同客人 / 不同活動，幫他選擇最適合的方式。</div>

    <!-- COD: 7-11 貨到付款（老客/信任客人） -->
    <div id="paneCOD">
      <div class="section-title mt-4">7-11 收件資料</div>
      <div class="row">
        <div><label>姓名 *</label><input id="cod_name" required /></div>
        <div><label>電話 *</label><input id="cod_phone" required /></div>
      </div>
      <label>Email *</label>
      <input id="cod_email" required type="email" placeholder="example@gmail.com" />
      <div class="row mt-2">
        <div><label>7-11 門市代號 *</label><input id="cod_store_id" required /></div>
        <div><label>7-11 門市名稱 *</label><input id="cod_store_name" required /></div>
      </div>
      <label>7-11 門市地址 *</label>
      <input id="cod_store_addr" required />
      <button class="btn secondary" id="mapCOD">開啟 7-11 門市地圖</button>
    </div>

    <!-- PAID: 可 7-11 或 郵寄 -->
    <div id="panePAID" hidden>
      <label style="margin-top:8px">選擇管道</label>
      <select id="paid_channel">
        <option value="card_once">信用卡 一次付（零利率）</option>
        <option value="card_inst">信用卡 分期（3/6/9 零利率）</option>
        <option value="linepay">LINE Pay</option>
        <option value="af">AF 先享後付</option>
      </select>
      <div id="cardInstBox" class="mt-2">
        <label>分期期數</label>
        <select id="inst_months">
          <option value="3">3 期（0 利率）</option>
          <option value="6">6 期（0 利率）</option>
          <option value="9">9 期（0 利率）</option>
        </select>
        <div class="hint">．實際分期金額與請款，以銀行刷卡帳單為準。</div>
      </div>

      <div class="mt-4 section-title">取貨方式</div>
      <select id="paid_ship_method">
        <option value="711">7-11 取貨</option>
        <option value="post">郵寄（中華郵政）</option>
      </select>

      <!-- PAID + 7-11 -->
      <div id="paidShip711" class="mt-2">
        <div class="row">
          <div><label>姓名 *</label><input id="ship_name_paid" required /></div>
          <div><label>電話 *</label><input id="ship_phone_paid" required /></div>
        </div>
        <label>Email *</label>
        <input id="paid_email" required type="email" placeholder="example@gmail.com" />
        <div class="row mt-2">
          <div><label>7-11 門市代號 *</label><input id="ship_store_id_paid" required /></div>
          <div><label>7-11 門市名稱 *</label><input id="ship_store_name_paid" required /></div>
        </div>
        <label>7-11 門市地址 *</label>
        <input id="ship_store_addr_paid" required />
        <button class="btn secondary" id="mapPAID">開啟 7-11 門市地圖</button>
      </div>

      <!-- PAID + 郵寄 -->
      <div id="paidShipPost" class="mt-2" hidden>
        <div class="row">
          <div><label>姓名 *</label><input id="paid_post_name" required /></div>
          <div><label>電話 *</label><input id="paid_post_phone" required /></div>
        </div>
        <label>Email *</label>
        <input id="paid_post_email" required type="email" placeholder="example@gmail.com" />
        <label>郵遞區號 *</label>
        <input id="paid_post_zip" required />
        <label>收件地址 *</label>
        <input id="paid_post_addr" required placeholder="請填寫完整地址（縣市、區、路/街、巷弄、樓層）" />
      </div>
    </div>

    <!-- DEPOSIT: ATM 匯款（新客訂金 / 尾款） -->
    <div id="paneDEPOSIT" hidden>
      <div class="section-title mt-2">匯款資訊</div>
      <div class="pill-row">
        <div class="pill">銀行：<span>中國信託商業銀行（822）</span></div>
        <div class="pill">帳號：<span>222540458194</span></div>
        <div class="pill">戶名：<span>潘羿如（MURAIN）</span></div>
      </div>
      <div class="muted">．客人匯款時，可直接一鍵複製帳號貼到 APP。</div>

      <div class="mt-4 section-title">選擇訂金類型</div>
      <div class="radio-row">
        <label class="radio-pill"><input type="radio" name="depType" value="old" checked /> 老客訂金 / 尾款</label>
        <label class="radio-pill"><input type="radio" name="depType" value="new_partial" /> 新客訂金（部分付款）</label>
        <label class="radio-pill"><input type="radio" name="depType" value="new_full" /> 新客全額匯款</label>
      </div>

      <!-- 老客訂金 -->
      <div id="depOldPane" class="mt-3">
        <div class="section-title">7-11 收件資料（尾款貨到付款）</div>
        <div class="row">
          <div><label>姓名 *</label><input id="dep_old_name" required /></div>
          <div><label>電話 *</label><input id="dep_old_phone" required /></div>
        </div>
        <label>Email *</label>
        <input id="dep_old_email" required type="email" placeholder="example@gmail.com" />
        <div class="row mt-2">
          <div><label>7-11 門市代號 *</label><input id="dep_old_store_id" required /></div>
          <div><label>7-11 門市名稱 *</label><input id="dep_old_store_name" required /></div>
        </div>
        <label>7-11 門市地址 *</label>
        <input id="dep_old_store_addr" required />
        <button class="btn secondary" id="mapDepOld">開啟 7-11 門市地圖</button>

        <label class="mt-3">匯款帳號後五碼 *</label>
        <input id="dep_old_last5" required />
      </div>

      <!-- 新客訂金（部分付款） -->
      <div id="depNewPartialPane" class="mt-3" hidden>
        <div class="section-title">7-11 收件資料（尾款貨到付款）</div>
        <div class="row">
          <div><label>姓名 *</label><input id="dep_new_partial_name" required /></div>
          <div><label>電話 *</label><input id="dep_new_partial_phone" required /></div>
        </div>
        <label>Email *</label>
        <input id="dep_new_partial_email" required type="email" placeholder="example@gmail.com" />
        <div class="row mt-2">
          <div><label>7-11 門市代號 *</label><input id="dep_new_partial_store_id" required /></div>
          <div><label>7-11 門市名稱 *</label><input id="dep_new_partial_store_name" required /></div>
        </div>
        <label>7-11 門市地址 *</label>
        <input id="dep_new_partial_store_addr" required />
        <button class="btn secondary" id="mapDepNewPartial">開啟 7-11 門市地圖</button>

        <label class="mt-3">匯款金額（訂金） *</label>
        <input id="dep_new_partial_amount" required placeholder="例如：1000" />
        <label class="mt-2">匯款帳號後五碼 *</label>
        <input id="dep_new_partial_last5" required />
      </div>

      <!-- 新客全額匯款 -->
      <div id="depNewFullPane" class="mt-3" hidden>
        <div class="section-title">7-11 / 郵寄 收件資料</div>
        <div class="row">
          <div><label>姓名 *</label><input id="dep_new_full_name" required /></div>
          <div><label>電話 *</label><input id="dep_new_full_phone" required /></div>
        </div>
        <label>Email *</label>
        <input id="dep_new_full_email" required type="email" placeholder="example@gmail.com" />
        <label>取貨方式 *</label>
        <select id="dep_new_full_method">
          <option value="711">7-11 取貨</option>
          <option value="post">郵寄（中華郵政）</option>
        </select>

        <div id="depNewFull711" class="mt-2">
          <div class="row">
            <div><label>7-11 門市代號 *</label><input id="dep_new_full_store_id" required /></div>
            <div><label>7-11 門市名稱 *</label><input id="dep_new_full_store_name" required /></div>
          </div>
          <label>7-11 門市地址 *</label>
          <input id="dep_new_full_store_addr" required />
          <button class="btn secondary" id="mapDepNewFull">開啟 7-11 門市地圖</button>
        </div>

        <div id="depNewFullPost" class="mt-2" hidden>
          <label>郵遞區號 *</label>
          <input id="dep_new_full_post_zip" required />
          <label>收件地址 *</label>
          <input id="dep_new_full_post_addr" required />
        </div>

        <label class="mt-3">匯款金額（全額） *</label>
        <input id="dep_new_full_amount" required />
        <label class="mt-2">匯款帳號後五碼 *</label>
        <input id="dep_new_full_last5" required />
      </div>
    </div>

    <!-- ZEROCARD：中租無卡 -->
    <div id="paneZEROCARD" hidden>
      <div class="section-title mt-2">期數與每期試算</div>
      <div class="row">
        <div>
          <label>期數</label>
          <select id="zc_months">
            <option value="3">3 期（0 利率，MURAIN 吸收手續費）</option>
            <option value="6">6 期</option>
            <option value="9">9 期</option>
            <option value="12">12 期</option>
            <option value="18">18 期</option>
            <option value="24">24 期</option>
          </select>
        </div>
        <div>
          <label>每期金額（試算）</label>
          <input id="zc_each" readonly />
        </div>
      </div>
      <div class="hint">．實際核准與期數，以中租無卡零角審核結果為準。</div>

      <div class="mt-4 section-title">取貨方式</div>
      <select id="zc_ship_method">
        <option value="711">7-11 取貨</option>
        <option value="post">郵寄（中華郵政）</option>
      </select>

      <!-- ZC + 7-11 -->
      <div id="zcShip711" class="mt-2">
        <div class="row">
          <div><label>姓名 *</label><input id="ship_name_zc" required /></div>
          <div><label>電話 *</label><input id="ship_phone_zc" required /></div>
        </div>
        <label>Email *</label>
        <input id="zc_email" required type="email" placeholder="example@gmail.com" />
        <div class="row mt-2">
          <div><label>7-11 門市代號 *</label><input id="ship_store_id_zc" required /></div>
          <div><label>7-11 門市名稱 *</label><input id="ship_store_name_zc" required /></div>
        </div>
        <label>7-11 門市地址 *</label>
        <input id="ship_store_addr_zc" required />
        <button class="btn secondary" id="mapZC">開啟 7-11 門市地圖</button>
      </div>

      <!-- ZC + 郵寄 -->
      <div id="zcShipPost" class="mt-2" hidden>
        <div class="row">
          <div><label>姓名 *</label><input id="zc_post_name" required /></div>
          <div><label>電話 *</label><input id="zc_post_phone" required /></div>
        </div>
        <label>Email *</label>
        <input id="zc_post_email" required type="email" placeholder="example@gmail.com" />
        <label>郵遞區號 *</label>
        <input id="zc_post_zip" required />
        <label>收件地址 *</label>
        <input id="zc_post_addr" required />
      </div>

      <div class="mt-4 section-title">提醒</div>
      <div class="muted">．點選「送出」後，會先建立訂單，再自動跳轉到中租無卡零角付款頁面。</div>
    </div>
  </div>

  <button class="btn" id="submitBtn">送出</button>
</div>

<script>
/* ===== 設定 ===== */
const API=(window.API_BASE||'https://api.murain.tw').replace(/\/$/,'');
const RATE_TABLE={3:0,6:4.0,9:5.5,12:6.5,18:9.0,24:11.5};
const NEW_DEPOSIT_AMOUNT=1000;
let CART_TOTAL_RAW = 0;   // 真實金額（數字）

/* ===== 工具 ===== */
const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>[...r.querySelectorAll(s)];
const money=n=>'NT$ '+Number(n||0).toLocaleString();
const qs=new URLSearchParams(location.search);
const cartToken=qs.get('cart_token')||'';
const customer=(qs.get('customer')||'old').toLowerCase();   // new | old
const initialMode=(qs.get('mode')||'').toUpperCase();       // COD/PAID/DEPOSIT/ZEROCARD

function setTotal(v){
  const sub = document.querySelector('#subtotal');
  const tot = document.querySelector('#total');
  const txt = money(v || 0);
  if (sub) sub.value = txt;
  if (tot) tot.value = txt;
}

/* ===== Tabs ===== */
const tabs=$$('#payTabs .tab'); tabs.forEach(t=>t.addEventListener('click',()=>{
  tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
  const kt=t.dataset.pay;
  ['COD','PAID','DEPOSIT','ZEROCARD'].forEach(x=>$('#pane'+x).hidden=(x!==kt));
}));

/* ===== PAID ===== */
$('#paid_channel').addEventListener('change',()=>{ $('#cardInstBox').hidden=($('#paid_channel').value!=='card_inst'); });
$('#paid_ship_method').addEventListener('change',updatePaidShip);

function updatePaidShip(){
  const m=$('#paid_ship_method').value;
  $('#paidShip711').hidden=(m!=='711');
  $('#paidShipPost').hidden=(m!=='post');
}

/* ===== DEPOSIT：切換 Pane ===== */
function updateDepositPane(){
  const v=$('input[name="depType"]:checked').value;
  $('#depOldPane').hidden=(v!=='old');
  $('#depNewPartialPane').hidden=(v!=='new_partial');
  $('#depNewFullPane').hidden=(v!=='new_full');
}
$$('input[name="depType"]').forEach(r=>r.addEventListener('change',updateDepositPane));
$('#dep_new_full_method').addEventListener('change',()=>{
  const m=$('#dep_new_full_method').value;
  $('#depNewFull711').hidden=(m!=='711');
  $('#depNewFullPost').hidden=(m!=='post');
});
function parseMoneyInput(v){
  return Number(String(v).replace(/[^\d.-]/g,'')) || 0;
}

/* ===== ZEROCARD ===== */
function calcZC(){
  const months = Number($('#zc_months').value || 3);
  const base   = parseMoneyInput($('#subtotal').value);  // 解析 NT$ 5,000 → 5000
  const rate   = (RATE_TABLE[months] || 0) / 100;
  const total  = Math.round(base * (1 + rate));
  const each   = Math.round(total / months);
  $('#zc_each').value = money(each) + ' × ' + months + ' 期 (約)';
}


/* ===== 購物車載入 ===== */
async function loadCart(){
  if (!cartToken) {
    console.warn('missing cart_token');
    return;
  }
  try {
    const r = await fetch(`${API}/cart/${cartToken}`);
    const j = await r.json();

    if (!r.ok || !j.items) {
      throw new Error('cart_api_error');
    }

    const items = j.items || [];
    const total = Number(j.total_amount || 0);
    CART_TOTAL_RAW = total;

    const detail = items.map(it =>
      `${it.name || it.sku} x ${it.qty}（NT$${Number(it.price || 0)}）`
    ).join('\n');

    const detailBox = document.querySelector('#itemsText');
    if (detailBox) detailBox.value = detail;

    setTotal(total);
    calcZC();
  } catch (e) {
    console.error('loadCart error', e);
    alert('讀取購物車失敗，請再試一次。');
  }
}

/* ===== 7-11 地圖（B 方案：整頁跳轉，靠 URL 帶資料） ===== */
function open711(src) {
  const qs2 = new URLSearchParams(location.search);
  qs2.set('src', src);
  const url = `${API}/cvs/map?${qs2.toString()}`;
  window.location.href = url;
}

// 從 URL 把 7-11 門市資料帶回欄位
function applyStoreFromURL(){
  const qs2 = new URLSearchParams(location.search);
  const src = (qs2.get('store_src') || '').toLowerCase();
  const id   = qs2.get('store_id')   || '';
  const name = qs2.get('store_name') || '';
  const addr = qs2.get('store_addr') || '';
  if (!src || !id) return;

  const fill = (a,b,c)=>{ setFieldValue(a,id); setFieldValue(b,name); setFieldValue(c,addr); };

  switch (src) {
    case 'cod':       fill('#cod_store_id', '#cod_store_name', '#cod_store_addr'); break;
    case 'paid':      fill('#ship_store_id_paid', '#ship_store_name_paid', '#ship_store_addr_paid'); break;
    case 'dep_old':   fill('#dep_old_store_id', '#dep_old_store_name', '#dep_old_store_addr'); break;
    case 'dep_new_p': fill('#dep_new_partial_store_id', '#dep_new_partial_store_name', '#dep_new_partial_store_addr'); break;
    case 'dep_new_f': fill('#dep_new_full_store_id', '#dep_new_full_store_name', '#dep_new_full_store_addr'); break;
    case 'zc':        fill('#ship_store_id_zc', '#ship_store_name_zc', '#ship_store_addr_zc'); break;
  }
}

// 小工具：寫值並觸發事件
function setFieldValue(sel, val){
  const el = document.querySelector(sel);
  if (!el) return false;
  el.value = val || '';
  try {
    el.dispatchEvent(new Event('input', {bubbles:true}));
    el.dispatchEvent(new Event('change', {bubbles:true}));
  } catch(e){}
  return true;
}

// 保留 message 版（之後如果要回到 popup 也能用）
function normalizeStorePayload(ev){
  const d = ev && ev.data;
  if (!d) return null;

  if (d.type === '711_store' && d.data) {
    const p = d.data;
    return {
      ok: !!p.ok,
      src: p.src || '',
      id:   p.id   || p.cvs_code || p.store_id || p.CVSStoreID || p.STOREID || '',
      name: p.name || p.cvs_name || p.store_name || p.CVSStoreName || p.STORENAME || '',
      addr: p.addr || p.cvs_addr || p.store_address || p.CVSAddress || p.STOREADDRESS || ''
    };
  }

  if (d.type === 'cvs_selected') {
    return {
      ok: true,
      src: d.src || '',
      id:   d.cvs_code || d.id || d.store_id || d.CVSStoreID || d.STOREID || '',
      name: d.cvs_name || d.name || d.store_name || d.CVSStoreName || d.STORENAME || '',
      addr: d.cvs_addr || d.addr || d.store_address || d.CVSAddress || d.STOREADDRESS || ''
    };
  }

  return null;
}

window.addEventListener('message', (ev)=>{
  const p = normalizeStorePayload(ev);
  if (!p || !p.ok) return;
  const src = (p.src || '').toLowerCase();
  const fill = (a,b,c)=>{ setFieldValue(a, p.id); setFieldValue(b, p.name); setFieldValue(c, p.addr); };
  switch (src) {
    case 'cod':        fill('#cod_store_id', '#cod_store_name', '#cod_store_addr'); break;
    case 'paid':       fill('#ship_store_id_paid', '#ship_store_name_paid', '#ship_store_addr_paid'); break;
    case 'dep_old':    fill('#dep_old_store_id', '#dep_old_store_name', '#dep_old_store_addr'); break;
    case 'dep_new_p':  fill('#dep_new_partial_store_id', '#dep_new_partial_store_name', '#dep_new_partial_store_addr'); break;
    case 'dep_new_f':  fill('#dep_new_full_store_id', '#dep_new_full_store_name', '#dep_new_full_store_addr'); break;
    case 'zc':         fill('#ship_store_id_zc', '#ship_store_name_zc', '#ship_store_addr_zc'); break;
  }
});

/* 綁定所有 7-11 地圖按鈕 */
$('#mapCOD').addEventListener('click',e=>{e.preventDefault();open711('cod');});
$('#mapPAID').addEventListener('click',e=>{e.preventDefault();open711('paid');});
$('#mapDepOld').addEventListener('click',e=>{e.preventDefault();open711('dep_old');});
$('#mapDepNewPartial').addEventListener('click',e=>{e.preventDefault();open711('dep_new_p');});
$('#mapDepNewFull').addEventListener('click',e=>{e.preventDefault();open711('dep_new_f');});
$('#mapZC').addEventListener('click',e=>{e.preventDefault();open711('zc');});

/* ===== 送出 ===== */
function required(v){ return v && String(v).trim().length>0; }

document.getElementById('submitBtn').addEventListener('click',async(e)=>{
  e.preventDefault();
  if(!cartToken){ alert('缺少 cart_token，請由正確結帳連結進入'); return; }

  const subtotal = CART_TOTAL_RAW;  // 用後端回來的真實金額
  if(!subtotal){ alert('金額為 0，請確認購物車內容'); return; }

  const note = $('#note').value || '';
  const shipping_info = { customer_type: customer, note };

  let payment_method = '';
  let ship = null;

  // 目前選到哪個分頁（COD / PAID / DEPOSIT / ZEROCARD）
  const activeTab = [...tabs].find(t=>t.classList.contains('active'))?.dataset.pay || 'COD';

  // ===== COD =====
  if(activeTab === 'COD'){
    const name  = $('#cod_name').value;
    const phone = $('#cod_phone').value;
    const id    = $('#cod_store_id').value;
    const sname = $('#cod_store_name').value;
    const addr  = $('#cod_store_addr').value;
    const emailCod = ($('#cod_email').value || '').trim();

    if(![name,phone,id,sname,addr,emailCod].every(required)) {
      alert('請填完 COD 必填欄位（含 Email）');
      return;
    }

    payment_method = 'cod_711';
    ship = {
      type:'711',
      name,
      phone,
      email: emailCod,
      store:{ id, name:sname, addr }
    };
  }

  // ===== PAID =====
  if(activeTab === 'PAID'){
    const channel    = $('#paid_channel').value;            // card_once / card_inst / linepay / af
    const shipMethod = $('#paid_ship_method').value;        // 711 / post

    payment_method = `paid_${channel}`;
    if(channel === 'card_inst'){
      payment_method += `_${$('#inst_months').value}`;      // paid_card_inst_3 / _6 / _9
    }

    if(shipMethod === '711'){
      const name  = $('#ship_name_paid').value;
      const phone = $('#ship_phone_paid').value;
      const id    = $('#ship_store_id_paid').value;
      const sname = $('#ship_store_name_paid').value;
      const addr  = $('#ship_store_addr_paid').value;
      const emailPaid = ($('#paid_email').value || '').trim();

      if(![name,phone,id,sname,addr,emailPaid].every(required)){
        alert('請填完 7-11 收件資料（含 Email）');
        return;
      }

      ship = {
        type:'711',
        name,
        phone,
        email: emailPaid,
        store:{ id, name:sname, addr }
      };
    } else {
      const name  = $('#paid_post_name').value;
      const phone = $('#paid_post_phone').value;
      const zip   = $('#paid_post_zip').value;
      const addr  = $('#paid_post_addr').value;
      const emailPost = ($('#paid_post_email').value || '').trim();

      if(![name,phone,zip,addr,emailPost].every(required)){
        alert('請填完郵寄資料（含 Email）');
        return;
      }

      ship = {
        type:'post',
        name,
        phone,
        email: emailPost,
        post:{ zip, addr }
      };
    }
  }

  // ===== DEPOSIT =====
  if(activeTab === 'DEPOSIT'){
    const depType = $('input[name="depType"]:checked').value;

    if(depType === 'old'){
      const name  = $('#dep_old_name').value;
      const phone = $('#dep_old_phone').value;
      const id    = $('#dep_old_store_id').value;
      const sname = $('#dep_old_store_name').value;
      const addr  = $('#dep_old_store_addr').value;
      const last5 = $('#dep_old_last5').value;
      const emailOld = ($('#dep_old_email').value || '').trim();

      if(![name,phone,id,sname,addr,last5,emailOld].every(required)){
        alert('請填完老客訂金欄位（含 Email）');
        return;
      }

      payment_method = 'deposit_old';
      ship = {
        type:'711',
        name,
        phone,
        email: emailOld,
        store:{ id, name:sname, addr },
        deposit:{ type:'old', last5 }
      };
    }

    if(depType === 'new_partial'){
      const name   = $('#dep_new_partial_name').value;
      const phone  = $('#dep_new_partial_phone').value;
      const id     = $('#dep_new_partial_store_id').value;
      const sname  = $('#dep_new_partial_store_name').value;
      const addr   = $('#dep_new_partial_store_addr').value;
      const amount = $('#dep_new_partial_amount').value;
      const last5  = $('#dep_new_partial_last5').value;
      const emailNewP = ($('#dep_new_partial_email').value || '').trim();

      if(![name,phone,id,sname,addr,amount,last5,emailNewP].every(required)){
        alert('請填完新客訂金（部分）欄位（含 Email）');
        return;
      }

      payment_method = 'deposit_new_partial';
      ship = {
        type:'711',
        name,
        phone,
        email: emailNewP,
        store:{ id, name:sname, addr },
        deposit:{ type:'new_partial', amount, last5 }
      };
    }

    if(depType === 'new_full'){
      const method   = $('#dep_new_full_method').value;   // 711 / post
      const emailNewF = ($('#dep_new_full_email').value || '').trim();

      if(method === '711'){
        const name   = $('#dep_new_full_name').value;
        const phone  = $('#dep_new_full_phone').value;
        const id     = $('#dep_new_full_store_id').value;
        const sname  = $('#dep_new_full_store_name').value;
        const addr   = $('#dep_new_full_store_addr').value;
        const amount = $('#dep_new_full_amount').value;
        const last5  = $('#dep_new_full_last5').value;

        if(![name,phone,id,sname,addr,amount,last5,emailNewF].every(required)){
          alert('請填完新客全額匯款（7-11）欄位（含 Email）');
          return;
        }

        payment_method = 'deposit_new_full_711';
        ship = {
          type:'711',
          name,
          phone,
          email: emailNewF,
          store:{ id, name:sname, addr },
          deposit:{ type:'new_full', method:'711', amount, last5 }
        };
      } else {
        const name   = $('#dep_new_full_name').value;
        const phone  = $('#dep_new_full_phone').value;
        const zip    = $('#dep_new_full_post_zip').value;
        const addr   = $('#dep_new_full_post_addr').value;
        const amount = $('#dep_new_full_amount').value;
        const last5  = $('#dep_new_full_last5').value;

        if(![name,phone,zip,addr,amount,last5,emailNewF].every(required)){
          alert('請填完新客全額匯款（郵寄）欄位（含 Email）');
          return;
        }

        payment_method = 'deposit_new_full_post';
        ship = {
          type:'post',
          name,
          phone,
          email: emailNewF,
          post:{ zip, addr },
          deposit:{ type:'new_full', method:'post', amount, last5 }
        };
      }
    }
  }

  // ===== ZEROCARD（中租無卡零角） =====
  if(activeTab === 'ZEROCARD'){
    const months = $('#zc_months').value;       // 3 / 6 / 9 / 12 / 18 / 24
    payment_method = `zero_card_${months}`;

    if($('#zc_ship_method').value === '711'){
      const name  = $('#ship_name_zc').value;
      const phone = $('#ship_phone_zc').value;
      const id    = $('#ship_store_id_zc').value;
      const sname = $('#ship_store_name_zc').value;
      const addr  = $('#ship_store_addr_zc').value;
      const emailZc = ($('#zc_email').value || '').trim();

      if(![name,phone,id,sname,addr,emailZc].every(required)){
        alert('請填完 7-11 收件資料（含 Email）');
        return;
      }

      ship = {
        type:'711',
        name,
        phone,
        email: emailZc,
        store:{ id, name:sname, addr }
      };
    } else {
      const name  = $('#zc_post_name').value;
      const phone = $('#zc_post_phone').value;
      const zip   = $('#zc_post_zip').value;
      const addr  = $('#zc_post_addr').value;
      const emailZcPost = ($('#zc_post_email').value || '').trim();

      if(![name,phone,zip,addr,emailZcPost].every(required)){
        alert('請填完郵寄資料（含 Email）');
        return;
      }

      ship = {
        type:'post',
        name,
        phone,
        email: emailZcPost,
        post:{ zip, addr }
      };
    }
  }

  if(!payment_method || !ship){
    alert('請先選擇付款方式，並填完必要欄位');
    return;
  }

  shipping_info.ship = ship;
  const isZeroCard = payment_method.startsWith('zero_card_');

  try{
    $('#submitBtn').disabled = true;

    // 1) 先建立訂單
    const r = await fetch(`${API}/checkout`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ cart_token: cartToken, payment_method, shipping_info })
    });
    const j = await r.json();
    if(!r.ok || !j.ok) throw new Error(j.error || 'checkout error');

    // 2) 如果是中租無卡，呼叫 /zero-card/start 取得付款網址，直接跳轉
    if (isZeroCard) {
      const zr = await fetch(`${API}/zero-card/start`, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ order_id: j.order_id })
      });
      const zj = await zr.json();
      if (!zr.ok || !zj.ok || !zj.payment_url) {
        console.error('zero-card/start error:', zj);
        throw new Error(zj.error || 'zero-card start error');
      }
      // 跳轉到中租的付款頁
      location.href = zj.payment_url;
      return;
    }

    // 3) 其他付款方式 → 一樣跳到訂單完成頁
    const url = `/order-result.html?order_id=${encodeURIComponent(j.order_id)}&total=${encodeURIComponent(j.total_amount)}`;
    try{
      location.href = url;
    }catch(e){
      alert(`下單成功！訂單編號：${j.order_id}`);
    }
  }catch(e){
    console.error(e);
    alert('送出失敗，請再試一次');
  }finally{
    $('#submitBtn').disabled = false;
  }
});

</script>
</body>
</html>
