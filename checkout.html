<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>MURAIN — 結帳</title>
<style>
  *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC",Roboto}
  body{margin:0;background:#0b1222;color:#e2e8f0}
  .wrap{max-width:720px;margin:0 auto;padding:16px 16px calc(env(safe-area-inset-bottom,0) + 90px)}
  h1{margin:0 0 8px;font-size:22px}
  .card{background:rgba(255,255,255,.06);border:1px solid rgba(248,250,252,.08);border-radius:18px;padding:16px 14px;box-shadow:0 10px 30px rgba(0,0,0,.4);margin-top:12px}
  label{display:block;font-size:14px;margin:8px 2px 6px}
  input,select,textarea{width:100%;padding:14px 12px;border-radius:12px;border:1px solid rgba(148,163,184,.6);background:rgba(15,23,42,.8);color:#e2e8f0;font-size:15px}
  input:focus,select:focus,textarea:focus{outline:2px solid #38bdf8;outline-offset:1px;border-color:#38bdf8}
  textarea{min-height:80px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:720px){.row{grid-template-columns:1fr}}
  .tabs{display:grid;grid-template-columns:repeat(4,1fr);border-radius:999px;background:rgba(15,23,42,.9);padding:4px;margin:8px 0 4px}
  .tab{padding:10px 4px;text-align:center;font-size:14px;border-radius:999px;border:none;background:transparent;color:#9ca3af;cursor:pointer}
  .tab.active{background:#22d3ee;color:#0f172a;font-weight:600;box-shadow:0 8px 20px rgba(34,211,238,.25)}
  .tab.disabled{opacity:.5;cursor:not-allowed}
  .btn{margin-top:16px;width:100%;padding:16px 14px;border-radius:999px;border:none;background:#22d3ee;color:#0f172a;font-size:16px;font-weight:600;cursor:pointer;box-shadow:0 10px 30px rgba(34,211,238,.45)}
  .btn.secondary{margin-top:8px;padding:10px 12px;font-size:14px;border-radius:999px;border:1px solid rgba(148,163,184,.7);background:rgba(15,23,42,.85);color:#e5e7eb;box-shadow:none}
  .btn:disabled{opacity:.6;cursor:not-allowed;box-shadow:none}
  .section-title{font-size:15px;font-weight:600;margin:6px 2px 8px;color:#e5e7eb}
  .muted{font-size:13px;color:#9ca3af;margin-top:4px;line-height:1.5}
  .hint{font-size:12px;color:#94a3b8;margin-top:2px;line-height:1.4}
  .pill-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .pill{padding:4px 10px;border-radius:999px;background:rgba(15,23,42,.9);border:1px solid rgba(148,163,184,.6);font-size:12px;color:#cbd5f5}
  .pill span{color:#e5e7eb;font-weight:500}
  .radio-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .radio-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.7);font-size:13px;cursor:pointer;background:rgba(15,23,42,.9)}
  .radio-pill input{width:auto;margin:0}
  .label-small{font-size:12px;color:#9ca3af;margin:6px 2px 2px}
  .tag{display:inline-block;font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.6);margin-left:6px;color:#e5e7eb}
  .total-box{font-size:20px;font-weight:700;color:#f97316;margin-top:4px}
  .total-box span{font-size:14px;font-weight:400;color:#cbd5f5;margin-left:4px}
  .zc-row{display:grid;grid-template-columns:2fr 1fr;gap:8px}
  @media(max-width:600px){.zc-row{grid-template-columns:1fr}}
  .zc-note{font-size:12px;color:#94a3b8;margin-top:4px;line-height:1.4}
  .zc-pill{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.5);margin-top:4px;color:#bfdbfe}
  .footer-fixed{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(to top,rgba(15,23,42,1),rgba(15,23,42,.98));padding:12px 16px env(safe-area-inset-bottom,0);box-shadow:0 -8px 30px rgba(0,0,0,.7);z-index:50}
  .footer-inner{max-width:720px;margin:0 auto;display:flex;align-items:center;gap:12px}
  .footer-inner .total{flex:1}
  .footer-inner .total .label{font-size:12px;color:#9ca3af}
  .footer-inner .total .value{font-size:18px;font-weight:700;color:#f97316}
  .footer-inner .total .value span{font-size:13px;font-weight:400;color:#cbd5f5;margin-left:4px}
  .footer-inner button{flex:0 0 160px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid rgba(148,163,184,.6);color:#e5e7eb;margin-left:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>MURAIN — 結帳</h1>
  <div class="muted">請協助客人確認收件資料與付款方式，送出後會建立正式訂單。</div>

  <div class="card">
    <div class="section-title">商品明細</div>
    <textarea id="itemsText" readonly></textarea>

    <div class="mt-4 section-title">應付金額</div>
    <input id="total" readonly />
    <div class="hint">．若有活動折扣，會已反映在應付金額中</div>

    <label class="mt-4">備註（選填）</label>
    <textarea id="note" placeholder="例如：希望週末送達、染髮前先幫我評估髮況…"></textarea>
    <div class="hint">．此頁一定要用結帳連結進入（帶 cart_token）。</div>
  </div>

  <div class="card">
    <div class="section-title">選擇付款 / 取貨方式</div>

    <div class="mt-2">
      <div class="label-small">客人身份</div>
      <div class="tabs" id="custTabs">
        <button type="button" class="tab" data-cust="new">新客人</button>
        <button type="button" class="tab" data-cust="old">老客人</button>
      </div>
      <div class="muted">新客 / 老客會影響可選的付款方式。</div>
    </div>

    <div class="tabs" id="payTabs">
      <button class="tab active" data-pay="COD">7-11 貨到付款</button>
      <button class="tab" data-pay="PAID">線上付款</button>
      <button class="tab" data-pay="DEPOSIT">ATM 匯款</button>
      <button class="tab" data-pay="ZEROCARD">無卡零角</button>
    </div>
    <div class="muted">可依不同客人 / 不同活動，幫他選擇最適合的方式。</div>

    <!-- COD: 7-11 貨到付款（老客/信任客人） -->
    <div id="paneCOD">
      <div class="section-title mt-4">7-11 收件資料</div>
      <div class="row">
        <div><label>姓名 *</label><input id="cod_name" required /></div>
        <div><label>電話 *</label><input id="cod_phone" required /></div>
      </div>
      <label>Email *</label>
      <input id="cod_email" required type="email" placeholder="example@gmail.com" />
      <div class="row mt-2">
        <div><label>7-11 門市代號 *</label><input id="cod_store_id" required /></div>
        <div><label>7-11 門市名稱 *</label><input id="cod_store_name" required /></div>
      </div>
      <label>7-11 門市地址 *</label>
      <input id="cod_store_addr" required />
      <button class="btn secondary" id="mapCOD">開啟 7-11 門市地圖</button>
    </div>

    <!-- PAID: 可 7-11 或 郵寄 -->
    <div id="panePAID" hidden>
      <label style="margin-top:8px">選擇管道</label>
      <select id="paid_channel">
        <option value="card_once">信用卡 一次付（零利率）</option>
        <option value="card_inst">信用卡 分期（3/6/9 零利率）</option>
        <option value="linepay">LINE Pay</option>
        <option value="af">AF 先享後付</option>
      </select>
      <div id="cardInstBox" class="mt-2">
        <label>分期期數</label>
        <select id="inst_months">
          <option value="3">3 期（0 利率）</option>
          <option value="6">6 期（0 利率）</option>
          <option value="9">9 期（0 利率）</option>
        </select>
        <div class="hint">．實際可分期期數以刷卡頁面為準。</div>
      </div>

      <div class="mt-3 section-title">取貨方式</div>
      <select id="paid_ship_method">
        <option value="711">7-11 取貨付款</option>
        <option value="post">郵寄（中華郵政）</option>
      </select>

      <!-- PAID + 7-11 -->
      <div id="paidShip711" class="mt-2">
        <div class="row">
          <div><label>姓名 *</label><input id="ship_name_paid" required /></div>
          <div><label>電話 *</label><input id="ship_phone_paid" required /></div>
        </div>
        <label>Email *</label>
        <input id="paid_email" required type="email" placeholder="example@gmail.com" />
        <div class="row mt-2">
          <div><label>7-11 門市代號 *</label><input id="ship_store_id_paid" required /></div>
          <div><label>7-11 門市名稱 *</label><input id="ship_store_name_paid" required /></div>
        </div>
        <label>7-11 門市地址 *</label>
        <input id="ship_store_addr_paid" required />
        <button class="btn secondary" id="mapPaid">開啟 7-11 門市地圖</button>
      </div>

      <!-- PAID + 郵寄 -->
      <div id="paidShipPost" class="mt-2" hidden>
        <div class="row">
          <div><label>姓名 *</label><input id="ship_name_post" required /></div>
          <div><label>電話 *</label><input id="ship_phone_post" required /></div>
        </div>
        <label>Email *</label>
        <input id="paid_email_post" required type="email" placeholder="example@gmail.com" />
        <label>郵遞區號 *</label>
        <input id="ship_zip_post" required placeholder="例如：106" />
        <label>詳細地址 *</label>
        <input id="ship_addr_post" required placeholder="例：台北市大安區…"/>
      </div>
    </div>

    <!-- DEPOSIT: ATM 匯款 -->
    <div id="paneDEPOSIT" hidden>
      <div class="section-title mt-3">匯款資訊</div>
      <div class="pill-row">
        <div class="pill">銀行：<span>中國信託商業銀行（822）</span></div>
        <div class="pill">帳號：<span>222540458194</span></div>
        <div class="pill">戶名：<span>潘羿如（MURAIN）</span></div>
      </div>
      <div class="muted">．客人匯款時，可直接一鍵複製帳號貼到 APP。</div>

      <div class="mt-4 section-title">選擇訂金類型</div>
      <div class="radio-row">
        <label class="radio-pill"><input type="radio" name="depType" value="old" checked /> 匯款定金保留一個月（老客）</label>
        <label class="radio-pill"><input type="radio" name="depType" value="new_partial" /> 匯款 1000（尾款 7-11 貨到付款）</label>
        <label class="radio-pill"><input type="radio" name="depType" value="new_full" /> 全額匯款</label>
      </div>

      <!-- 老客訂金 -->
      <div id="depOldPane" class="mt-3">
        <div class="section-title">7-11 收件資料（保留一個月）</div>
        <div class="row">
          <div><label>姓名 *</label><input id="dep_old_name" required /></div>
          <div><label>電話 *</label><input id="dep_old_phone" required /></div>
        </div>
        <label>Email *</label>
        <input id="dep_old_email" required type="email" placeholder="example@gmail.com" />
        <div class="row mt-2">
          <div><label>7-11 門市代號 *</label><input id="dep_old_store_id" required /></div>
          <div><label>7-11 門市名稱 *</label><input id="dep_old_store_name" required /></div>
        </div>
        <label>7-11 門市地址 *</label>
        <input id="dep_old_store_addr" required />
        <button class="btn secondary" id="mapDepOld">開啟 7-11 門市地圖</button>

        <label class="mt-3">匯款帳號後五碼 *</label>
        <input id="dep_old_last5" required />
        <div class="hint mt-1">．COACH 每顆訂金 1000 元，Tory Burch 每顆 2000 元，依商品數量自行計算匯款金額，尾款再另外結帳。</div>
      </div>

      <!-- 新客訂金（部分付款） -->
      <div id="depNewPartialPane" class="mt-3" hidden>
        <div class="section-title">7-11 收件資料（尾款貨到付款）</div>
        <div class="row">
          <div><label>姓名 *</label><input id="dep_new_partial_name" required /></div>
          <div><label>電話 *</label><input id="dep_new_partial_phone" required /></div>
        </div>
        <label>Email *</label>
        <input id="dep_new_partial_email" required type="email" placeholder="example@gmail.com" />
        <div class="row mt-2">
          <div><label>7-11 門市代號 *</label><input id="dep_new_partial_store_id" required /></div>
          <div><label>7-11 門市名稱 *</label><input id="dep_new_partial_store_name" required /></div>
        </div>
        <label>7-11 門市地址 *</label>
        <input id="dep_new_partial_store_addr" required />
        <button class="btn secondary" id="mapDepNewPartial">開啟 7-11 門市地圖</button>

        <label class="mt-3">訂金金額 *</label>
        <input id="dep_new_partial_amount" required placeholder="預設匯款 1000 元" />
        <label class="mt-3">匯款帳號後五碼 *</label>
        <input id="dep_new_partial_last5" required />
      </div>

      <!-- 新客全額匯款 -->
      <div id="depNewFullPane" class="mt-3" hidden>
        <div class="section-title">取貨方式</div>
        <select id="dep_new_full_method">
          <option value="711">7-11 取貨</option>
          <option value="post">郵寄（中華郵政）</option>
        </select>

        <!-- 新客全額 + 711 -->
        <div id="depNewFull711" class="mt-2">
          <div class="row">
            <div><label>姓名 *</label><input id="dep_new_full_name" required /></div>
            <div><label>電話 *</label><input id="dep_new_full_phone" required /></div>
          </div>
          <label>Email *</label>
          <input id="dep_new_full_email" required type="email" placeholder="example@gmail.com" />
          <div class="row mt-2">
            <div><label>7-11 門市代號 *</label><input id="dep_new_full_store_id" required /></div>
            <div><label>7-11 門市名稱 *</label><input id="dep_new_full_store_name" required /></div>
          </div>
          <label>7-11 門市地址 *</label>
          <input id="dep_new_full_store_addr" required />
          <button class="btn secondary" id="mapDepNewFull711">開啟 7-11 門市地圖</button>

          <label class="mt-3">匯款金額（全額） *</label>
          <input id="dep_new_full_amount_711" required />
          <label class="mt-3">匯款帳號後五碼 *</label>
          <input id="dep_new_full_last5_711" required />
        </div>

        <!-- 新客全額 + 郵寄 -->
        <div id="depNewFullPost" class="mt-2" hidden>
          <div class="row">
            <div><label>姓名 *</label><input id="dep_new_full_name_post" required /></div>
            <div><label>電話 *</label><input id="dep_new_full_phone_post" required /></div>
          </div>
          <label>Email *</label>
          <input id="dep_new_full_email" required type="email" placeholder="example@gmail.com" />
          <label>郵遞區號 *</label>
          <input id="dep_new_full_zip" required />
          <label>詳細地址 *</label>
          <input id="dep_new_full_addr" required />
          <label class="mt-3">匯款金額（全額） *</label>
          <input id="dep_new_full_amount_post" required />
          <label class="mt-3">匯款帳號後五碼 *</label>
          <input id="dep_new_full_last5_post" required />
        </div>
      </div>
    </div>

    <!-- ZEROCARD：中租零卡 -->
    <div id="paneZEROCARD" hidden>
      <div class="section-title mt-3">分期期數</div>
      <select id="zc_months">
        <option value="3">3 期</option>
        <option value="6">6 期</option>
        <option value="9">9 期</option>
        <option value="12">12 期</option>
        <option value="18">18 期</option>
        <option value="24">24 期</option>
      </select>
      <div class="zc-row mt-2">
        <div>
          <div class="label-small">每期金額（約）</div>
          <div class="total-box"><input id="zc_each" readonly /></div>
          <div class="zc-note">
            ．實際金額以中租審核為準，<br />
            ．本頁只是初步試算，方便你跟客人說明。
          </div>
        </div>
        <div>
          <div class="label-small">總金額（含手續費）</div>
          <input id="zc_total" readonly />
          <div class="zc-pill">手續費依期數不同，已包含在試算內。</div>
        </div>
      </div>

      <div class="mt-3 section-title">取貨方式</div>
      <select id="zc_ship_method">
        <option value="711">7-11 取貨</option>
        <option value="post">郵寄（中華郵政）</option>
      </select>

      <!-- ZC + 7-11 -->
      <div id="zcShip711" class="mt-2">
        <div class="row">
          <div><label>姓名 *</label><input id="ship_name_zc" required /></div>
          <div><label>電話 *</label><input id="ship_phone_zc" required /></div>
        </div>
        <label>Email *</label>
        <input id="zc_email" required type="email" placeholder="example@gmail.com" />
        <div class="row mt-2">
          <div><label>7-11 門市代號 *</label><input id="ship_store_id_zc" required /></div>
          <div><label>7-11 門市名稱 *</label><input id="ship_store_name_zc" required /></div>
        </div>
        <label>7-11 門市地址 *</label>
        <input id="ship_store_addr_zc" required />
        <button class="btn secondary" id="mapZc711">開啟 7-11 門市地圖</button>
      </div>

      <!-- ZC + 郵寄 -->
      <div id="zcShipPost" class="mt-2" hidden>
        <div class="row">
          <div><label>姓名 *</label><input id="ship_name_zc_post" required /></div>
          <div><label>電話 *</label><input id="ship_phone_zc_post" required /></div>
        </div>
        <label>Email *</label>
        <input id="zc_email_post" required type="email" placeholder="example@gmail.com" />
        <label>郵遞區號 *</label>
        <input id="ship_zip_zc_post" required />
        <label>詳細地址 *</label>
        <input id="ship_addr_zc_post" required />
      </div>
    </div>
  </div>
</div>

<div class="footer-fixed">
  <div class="footer-inner">
    <div class="total">
      <div class="label">應付金額</div>
      <div class="value" id="footerTotal">NT$ 0<span>（以上方為準）</span></div>
    </div>
    <button id="submitBtn">送出訂單</button>
  </div>
</div>

<script>
/* ===== 設定 ===== */
const API=(window.API_BASE||'https://api.murain.tw').replace(/\/$/,'');
const RATE_TABLE={3:0,6:4.0,9:5.5,12:6.5,18:9.0,24:11.5};
const NEW_DEPOSIT_AMOUNT=1000;
let CART_TOTAL_RAW = 0;   // 真實金額（數字）

// ===== LINE / LIFF 設定 =====
const LIFF_ID = "2008430261-kOeNLR9x";  // 栩願國際 Login 的 LIFF ID
let LINE_PROFILE = null;                // 之後存使用者的 LINE 資訊

/* ===== 工具 ===== */
const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>[...r.querySelectorAll(s)];
const money=n=>'NT$ '+Number(n||0).toLocaleString();
const qs=new URLSearchParams(location.search);
const cartToken=qs.get('cart_token')||'';
let customerType=(qs.get('customer')||'old').toLowerCase();   // new | old
const initialMode=(qs.get('mode')||'').toUpperCase();       // COD/PAID/DEPOSIT/ZEROCARD

function setTotal(v){
  const sub = document.querySelector('#subtotal');
  const tot = document.querySelector('#total');
  const txt = money(v || 0);
  if (sub) sub.value = txt;
  if (tot) tot.value = txt;
}

/* ===== Tabs ===== */
const tabs=$$('#payTabs .tab');
tabs.forEach(t=>t.addEventListener('click',()=>{
  if (t.dataset.disabled === '1') return;
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const kt=t.dataset.pay;
  ['COD','PAID','DEPOSIT','ZEROCARD'].forEach(x=>{
    const pane = $('#pane'+x);
    if (pane) pane.hidden = (x!==kt);
  });
}));

/* ===== 客人身份切換（新客 / 老客） ===== */
const custTabs = $$('#custTabs .tab');

function updateCustomerUI(){
  const isNew = (customerType === 'new');

  // 控制 COD 分頁（新客不能選 COD）
  const codTab  = $('#payTabs .tab[data-pay="COD"]');
  const codPane = $('#paneCOD');
  const paidTab = $('#payTabs .tab[data-pay="PAID"]');

  if (codTab) {
    if (isNew) {
      codTab.dataset.disabled = '1';
      codTab.classList.add('disabled');
      if (codTab.classList.contains('active')) {
        codTab.classList.remove('active');
        if (paidTab) {
          paidTab.classList.add('active');
          ['COD','PAID','DEPOSIT','ZEROCARD'].forEach(x=>{
            const pane = $('#pane'+x);
            if (pane) pane.hidden = (x!=='PAID');
          });
        }
      }
      if (codPane) codPane.hidden = true;
    } else {
      delete codTab.dataset.disabled;
      codTab.classList.remove('disabled');
    }
  }

  // 控制 ATM 匯款選項顯示
  const depOldLabel        = document.querySelector('.radio-row label:nth-child(1)');
  const depNewPartialLabel = document.querySelector('.radio-row label:nth-child(2)');
  const depNewFullLabel    = document.querySelector('.radio-row label:nth-child(3)');

  if (depOldLabel && depNewPartialLabel && depNewFullLabel) {
    if (isNew) {
      // 新客：只能用「匯款 1000」＋「全額匯款」
      depOldLabel.style.display        = 'none';
      depNewPartialLabel.style.display = '';
      depNewFullLabel.style.display    = '';

      const cur = document.querySelector('input[name="depType"]:checked');
      if (!cur || cur.value === 'old') {
        const np = document.querySelector('input[name="depType"][value="new_partial"]');
        if (np) {
          np.checked = true;
          if (typeof updateDepositPane === 'function') updateDepositPane();
        }
      }
    } else {
      // 老客：可以用「定金保留」＋「全額匯款」，不顯示新客 1000 那顆
      depOldLabel.style.display        = '';
      depNewPartialLabel.style.display = 'none';
      depNewFullLabel.style.display    = '';

      const cur = document.querySelector('input[name="depType"]:checked');
      if (!cur || cur.value === 'new_partial') {
        const od = document.querySelector('input[name="depType"][value="old"]');
        if (od) {
          od.checked = true;
          if (typeof updateDepositPane === 'function') updateDepositPane();
        }
      }
    }
  }

  // 更新「客人身份」按鈕樣式
  if (custTabs && custTabs.length) {
    custTabs.forEach(btn=>{
      const t = (btn.dataset.cust || 'old');
      btn.classList.toggle('active', t === customerType);
    });
  }
}

if (custTabs && custTabs.length) {
  custTabs.forEach(btn=>{
    btn.addEventListener('click',()=>{
      customerType = (btn.dataset.cust || 'old');
      if (customerType !== 'new' && customerType !== 'old') {
        customerType = 'old';
      }
      updateCustomerUI();
    });
  });
  if (customerType !== 'new' && customerType !== 'old') {
    customerType = 'old';
  }
  updateCustomerUI();
}

/* ===== PAID ===== */
$('#paid_channel').addEventListener('change',()=>{ $('#cardInstBox').hidden=($('#paid_channel').value!=='card_inst'); });
$('#paid_ship_method').addEventListener('change',updatePaidShip);

function updatePaidShip(){
  const m=$('#paid_ship_method').value;
  $('#paidShip711').hidden=(m!=='711');
  $('#paidShipPost').hidden=(m!=='post');
}

/* ===== DEPOSIT：切換 Pane ===== */
function updateDepositPane(){
  const v=$('input[name="depType"]:checked').value;
  $('#depOldPane').hidden=(v!=='old');
  $('#depNewPartialPane').hidden=(v!=='new_partial');
  $('#depNewFullPane').hidden=(v!=='new_full');
}
$$('input[name="depType"]').forEach(r=>r.addEventListener('change',updateDepositPane));
$('#dep_new_full_method').addEventListener('change',()=>{
  const m=$('#dep_new_full_method').value;
  $('#depNewFull711').hidden=(m!=='711');
  $('#depNewFullPost').hidden=(m!=='post');
});

/* ===== ZEROCARD ===== */
function parseMoneyInput(v){
  return Number(String(v).replace(/[^\d.-]/g,'')) || 0;
}
function calcZC(){
  const months = Number($('#zc_months').value || 3);
  const base   = CART_TOTAL_RAW || parseMoneyInput($('#subtotal')?.value || 0);
  const rate   = (RATE_TABLE[months] || 0) / 100;
  const total  = Math.round(base * (1 + rate));
  const each   = Math.round(total / months);
  $('#zc_each').value  = money(each);
  $('#zc_total').value = money(total);
}
$('#zc_months').addEventListener('change',calcZC);
$('#zc_ship_method').addEventListener('change',updateZcShip);

function updateZcShip(){
  const m=$('#zc_ship_method').value;
  $('#zcShip711').hidden=(m!=='711');
  $('#zcShipPost').hidden=(m!=='post');
}

/* ===== LINE / LIFF 綁定（保留後端支援，但目前畫面不顯示按鈕） ===== */
async function initLiffAndProfile() {
  if (!window.liff || !LIFF_ID) return;

  try {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      return;
    }

    const profile = await liff.getProfile();
    LINE_PROFILE = {
      userId: profile.userId,
      displayName: profile.displayName || "",
      pictureUrl: profile.pictureUrl || ""
    };
  } catch (e) {
    console.log("initLiff error", e);
  }
}

async function onClickLineBind() {
  if (!window.liff || !LIFF_ID) {
    alert("目前無法使用 LINE 綁定，請稍後再試。");
    return;
  }

  try {
    if (!liff.isLoggedIn()) {
      liff.login({ redirectUri: window.location.href });
      return;
    }

    const profile = await liff.getProfile();
    LINE_PROFILE = {
      userId: profile.userId,
      displayName: profile.displayName || "",
      pictureUrl: profile.pictureUrl || ""
    };
  } catch (e) {
    console.error(e);
    alert("LINE 綁定失敗，請稍後再試。");
  }
}

/* ===== 購物車載入 ===== */
async function loadCart(){
  if (!cartToken) {
    console.warn('missing cart_token');
    return;
  }
  try {
    const r = await fetch(`${API}/cart/${cartToken}`);
    const j = await r.json();

    if (!j.ok || !Array.isArray(j.items) || !j.items.length) {
      alert('購物車是空的，請先將商品加入購物車');
      return;
    }

    CART_TOTAL_RAW = j.summary?.total || 0;
    setTotal(CART_TOTAL_RAW);
    $('#footerTotal').textContent = money(CART_TOTAL_RAW) + '（以上方為準）';

    const lines = j.items.map(it=>{
      const name = it.name || it.sku || '';
      const qty  = it.qty  || 1;
      const price = it.price || 0;
      return `・${name} x ${qty}（NT$ ${price.toLocaleString()}）`;
    });
    $('#itemsText').value = lines.join('\n');
    calcZC();
  } catch(e){
    console.error(e);
    alert('讀取購物車失敗，請再試一次');
  }
}

/* ===== 7-11 門市地圖相關 ===== */
function openCvsMap(src){
  const qs2 = new URLSearchParams(location.search);
  qs2.set('src', src);
  const url = `${API}/cvs/map?${qs2.toString()}`;
  window.location.href = url;
}
$('#mapCOD').addEventListener('click',()=>openCvsMap('cod'));
$('#mapPaid').addEventListener('click',()=>openCvsMap('paid'));
$('#mapDepOld').addEventListener('click',()=>openCvsMap('dep_old'));
$('#mapDepNewPartial').addEventListener('click',()=>openCvsMap('dep_new_p'));
$('#mapDepNewFull711').addEventListener('click',()=>openCvsMap('dep_new_f'));
$('#mapZc711').addEventListener('click',()=>openCvsMap('zc_711'));

function setFieldValue(sel,val){
  const el=$(sel);
  if(el){ el.value=val||''; }
}

// 從 URL 把 7-11 門市資料帶回欄位
function applyStoreFromURL(){
  const qs2 = new URLSearchParams(location.search);
  const src = (qs2.get('store_src') || '').toLowerCase();
  const id   = qs2.get('store_id')   || '';
  const name = qs2.get('store_name') || '';
  const addr = qs2.get('store_addr') || '';
  if (!src || !id) return;

  const fill = (a,b,c)=>{ setFieldValue(a,id); setFieldValue(b,name); setFieldValue(c,addr); };

  switch (src) {
    case 'cod':        fill('#cod_store_id', '#cod_store_name', '#cod_store_addr'); break;
    case 'paid':       fill('#ship_store_id_paid', '#ship_store_name_paid', '#ship_store_addr_paid'); break;
    case 'dep_old':    fill('#dep_old_store_id', '#dep_old_store_name', '#dep_old_store_addr'); break;
    case 'dep_new_p':  fill('#dep_new_partial_store_id', '#dep_new_partial_store_name', '#dep_new_partial_store_addr'); break;
    case 'dep_new_f':  fill('#dep_new_full_store_id', '#dep_new_full_store_name', '#dep_new_full_store_addr'); break;
    case 'zc_711':     fill('#ship_store_id_zc', '#ship_store_name_zc', '#ship_store_addr_zc'); break;
  }
}

/* ===== 送出訂單 ===== */
document.getElementById('submitBtn').addEventListener('click',async(e)=>{
  e.preventDefault();
  if(!cartToken){ alert('缺少 cart_token，請由正確結帳連結進入'); return; }

  const subtotal = CART_TOTAL_RAW;  // 用後端回來的真實金額
  if(!subtotal){ alert('金額為 0，請確認購物車內容'); return; }

  const note = $('#note').value || '';
  const shipping_info = { customer_type: customerType, note };

  // 如果有綁定 LINE，把 profile 帶到 shipping_info
  if (LINE_PROFILE && LINE_PROFILE.userId) {
    shipping_info.line = {
      user_id: LINE_PROFILE.userId,
      display_name: LINE_PROFILE.displayName || ''
    };
  }

  let payment_method = '';
  let ship = null;

  const activeTab = document.querySelector('#payTabs .tab.active');
  const mode = activeTab ? activeTab.dataset.pay : 'COD';

  function required(v){ return v && String(v).trim()!==''; }

  if (mode === 'COD') {
    const name  = $('#cod_name').value;
    const phone = $('#cod_phone').value;
    const email = ($('#cod_email').value || '').trim();
    const id    = $('#cod_store_id').value;
    const sname = $('#cod_store_name').value;
    const addr  = $('#cod_store_addr').value;

    if (![name,phone,email,id,sname,addr].every(required)) {
      alert('請填完 7-11 貨到付款欄位（含 Email）');
      return;
    }

    payment_method = 'cod_711';
    ship = {
      type:'711',
      name,
      phone,
      email,
      store:{ id, name:sname, addr }
    };
  }

  if (mode === 'PAID') {
    const channel = $('#paid_channel').value;
    const shipMethod = $('#paid_ship_method').value;

    let paidPm = '';
    if (channel === 'card_once') paidPm = 'paid_card_once';
    if (channel === 'card_inst') paidPm = 'paid_card_inst_' + ($('#inst_months').value || '3');
    if (channel === 'linepay')  paidPm = 'paid_linepay';
    if (channel === 'af')       paidPm = 'paid_af';

    payment_method = paidPm;

    if (shipMethod === '711') {
      const name  = $('#ship_name_paid').value;
      const phone = $('#ship_phone_paid').value;
      const id    = $('#ship_store_id_paid').value;
      const sname = $('#ship_store_name_paid').value;
      const addr  = $('#ship_store_addr_paid').value;
      const emailPaid = ($('#paid_email').value || '').trim();

      if(![name,phone,id,sname,addr,emailPaid].every(required)){
        alert('請填完 7-11 收件資料（含 Email）');
        return;
      }

      ship = {
        type:'711',
        name,
        phone,
        email: emailPaid,
        store:{ id, name:sname, addr }
      };
    } else if (shipMethod === 'post') {
      const name  = $('#ship_name_post').value;
      const phone = $('#ship_phone_post').value;
      const zip   = $('#ship_zip_post').value;
      const addr  = $('#ship_addr_post').value;
      const emailPaidPost = ($('#paid_email_post').value || '').trim();

      if(![name,phone,zip,addr,emailPaidPost].every(required)){
        alert('請填完郵寄欄位（含 Email）');
        return;
      }

      ship = {
        type:'post',
        name,
        phone,
        email: emailPaidPost,
        post:{ zip, addr }
      };
    }
  }

  if (mode === 'DEPOSIT') {
    const depType = $('input[name="depType"]:checked').value;

    if (depType === 'old') {
      const name  = $('#dep_old_name').value;
      const phone = $('#dep_old_phone').value;
      const id    = $('#dep_old_store_id').value;
      const sname = $('#dep_old_store_name').value;
      const addr  = $('#dep_old_store_addr').value;
      const last5 = $('#dep_old_last5').value;
      const emailOld = ($('#dep_old_email').value || '').trim();

      if(![name,phone,id,sname,addr,last5,emailOld].every(required)){
        alert('請填完老客訂金欄位（含 Email）');
        return;
      }

      payment_method = 'deposit_old';
      ship = {
        type:'711',
        name,
        phone,
        email: emailOld,
        store:{ id, name:sname, addr },
        deposit:{ type:'old', last5 }
      };
    }

    if(depType === 'new_partial'){
      const name   = $('#dep_new_partial_name').value;
      const phone  = $('#dep_new_partial_phone').value;
      const id     = $('#dep_new_partial_store_id').value;
      const sname  = $('#dep_new_partial_store_name').value;
      const addr   = $('#dep_new_partial_store_addr').value;
      const amount = $('#dep_new_partial_amount').value;
      const last5  = $('#dep_new_partial_last5').value;
      const emailNewP = ($('#dep_new_partial_email').value || '').trim();

      if(![name,phone,id,sname,addr,amount,last5,emailNewP].every(required)){
        alert('請填完新客訂金（部分）欄位（含 Email）');
        return;
      }

      payment_method = 'deposit_new_partial';
      ship = {
        type:'711',
        name,
        phone,
        email: emailNewP,
        store:{ id, name:sname, addr },
        deposit:{ type:'new_partial', amount, last5 }
      };
    }

    if(depType === 'new_full'){
      const method   = $('#dep_new_full_method').value;   // 711 / post
      const emailNewF = ($('#dep_new_full_email').value || '').trim();

      if(method === '711'){
        const name   = $('#dep_new_full_name').value;
        const phone  = $('#dep_new_full_phone').value;
        const id     = $('#dep_new_full_store_id').value;
        const sname  = $('#dep_new_full_store_name').value;
        const addr   = $('#dep_new_full_store_addr').value;
        const amount = $('#dep_new_full_amount_711').value;
        const last5  = $('#dep_new_full_last5_711').value;

        if(![name,phone,id,sname,addr,amount,last5,emailNewF].every(required)){
          alert('請填完新客全額匯款（7-11）欄位（含 Email）');
          return;
        }

        payment_method = 'deposit_new_full_711';
        ship = {
          type:'711',
          name,
          phone,
          email: emailNewF,
          store:{ id, name:sname, addr },
          deposit:{ type:'new_full', method:'711', amount, last5 }
        };
      } else if (method === 'post') {
        const name   = $('#dep_new_full_name_post').value;
        const phone  = $('#dep_new_full_phone_post').value;
        const zip    = $('#dep_new_full_zip').value;
        const addr   = $('#dep_new_full_addr').value;
        const amount = $('#dep_new_full_amount_post').value;
        const last5  = $('#dep_new_full_last5_post').value;

        if(![name,phone,zip,addr,amount,last5,emailNewF].every(required)){
          alert('請填完新客全額匯款（郵寄）欄位（含 Email）');
          return;
        }

        payment_method = 'deposit_new_full_post';
        ship = {
          type:'post',
          name,
          phone,
          email: emailNewF,
          post:{ zip, addr },
          deposit:{ type:'new_full', method:'post', amount, last5 }
        };
      }
    }
  }

  if (mode === 'ZEROCARD') {
    const months = Number($('#zc_months').value || 3);
    const shipMethod = $('#zc_ship_method').value;
    const emailZc = ($('#zc_email').value || $('#zc_email_post').value || '').trim();

    payment_method = 'zero_card_' + months;

    if (shipMethod === '711') {
      const name  = $('#ship_name_zc').value;
      const phone = $('#ship_phone_zc').value;
      const id    = $('#ship_store_id_zc').value;
      const sname = $('#ship_store_name_zc').value;
      const addr  = $('#ship_store_addr_zc').value;

      if(![name,phone,emailZc,id,sname,addr].every(required)){
        alert('請填完中租 + 7-11 欄位（含 Email）');
        return;
      }

      ship = {
        type:'711',
        name,
        phone,
        email: emailZc,
        store:{ id, name:sname, addr },
        zc:{ months }
      };
    } else if (shipMethod === 'post') {
      const name  = $('#ship_name_zc_post').value;
      const phone = $('#ship_phone_zc_post').value;
      const zip   = $('#ship_zip_zc_post').value;
      const addr  = $('#ship_addr_zc_post').value;

      if(![name,phone,emailZc,zip,addr].every(required)){
        alert('請填完中租 + 郵寄欄位（含 Email）');
        return;
      }

      ship = {
        type:'post',
        name,
        phone,
        email: emailZc,
        post:{ zip, addr },
        zc:{ months }
      };
    }
  }

  if (!payment_method || !ship) {
    alert('請先選擇付款方式 / 填寫收件資料');
    return;
  }

  shipping_info.ship = ship;

  $('#submitBtn').disabled = true;
  $('#submitBtn').textContent = '送出中…';

  try{
    const r = await fetch(`${API}/checkout`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ cart_token: cartToken, payment_method, shipping_info })
    });
    const j = await r.json();
    if(!j.ok){
      alert('下單失敗：' + (j.error || '未知錯誤'));
      return;
    }

    alert(`下單成功！訂單編號：${j.order_id}`);

    if (payment_method.startsWith('paid_')) {
      const r2 = await fetch(`${API}/payuni/start`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ order_id:j.order_id })
      });
      const up = await r2.json();
      if (!up.ok) {
        alert('金流啟動失敗：' + (up.error || '未知錯誤'));
        return;
      }
      const f = document.createElement('form');
      f.method = 'POST';
      f.action = up.url;
      ['MerID','Version','EncryptInfo','HashInfo'].forEach(k => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = k;
        input.value = up[k];
        f.appendChild(input);
      });
      document.body.appendChild(f);
      f.submit();
      return;
    }

    if (payment_method.startsWith('zero_card_')) {
      const url = `${API}/zero-card/start?order_id=${encodeURIComponent(j.order_id)}`;
      try{
        location.href = url;
      }catch(e){
        alert(`下單成功！訂單編號：${j.order_id}`);
      }
      return;
    }

    try{
      location.href = `${location.pathname}?done=1&order_id=${encodeURIComponent(j.order_id)}`;
    }catch(e){
      alert(`下單成功！訂單編號：${j.order_id}`);
    }
  }catch(e){
    console.error(e);
    alert('送出失敗，請再試一次');
  }finally{
    $('#submitBtn').disabled = false;
  }
});

// ===== 頁面初始化：切分頁、載入購物車、回填 7-11 門市 =====
(async () => {
  if (typeof initLiffAndProfile === 'function') {
    initLiffAndProfile();
  }

  applyStoreFromURL();

  if (initialMode) {
    document.querySelector(`.tab[data-pay="${initialMode}"]`)?.click();
  } else {
    document.querySelector('.tab[data-pay="COD"]')?.click();
  }

  updatePaidShip();
  updateDepositPane();
  updateZcShip();

  await loadCart();
  applyStoreFromURL();
})();
</script>
</body>
</html>
