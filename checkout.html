<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MURAIN — 結帳 Checkout</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root{
      --bg:#fbfbfb; --card:#fff; --muted:#6b6b6b; --accent:#b76e79;
      --success:#1f8a3b; --danger:#d23f3f; --glass: rgba(0,0,0,0.04);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#222}
    .wrap{max-width:980px;margin:28px auto;padding:18px}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 18px var(--glass)}
    header h1{margin:0 0 6px;font-size:20px}
    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;gap:12px}
    .cart-list{margin-top:12px;border-top:1px solid #eee;padding-top:12px}
    .item{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px dashed #f0f0f0}
    .item:last-child{border-bottom:none}
    .item .title{font-size:15px}
    .item .qty{color:var(--muted);font-size:13px}
    .totals{margin-top:14px;display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:18px}
    .controls{margin-top:18px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    select,input,button,textarea{font-size:15px;padding:10px;border-radius:8px;border:1px solid #e6e6e6;background:#fff}
    button.primary{background:var(--accent);color:#fff;border:0;padding:10px 16px;border-radius:10px;cursor:pointer}
    button.secondary{background:#fff;border:1px solid #e6e6e6;color:#333;cursor:pointer}
    .hint{font-size:13px;color:#777}
    .error{color:var(--danger);margin-top:10px}
    .success{color:var(--success);margin-top:10px}
    .loading{opacity:0.7}
    .small{font-size:13px;color:#666}
    .debug{margin-top:12px;background:#fafafa;padding:10px;border-radius:8px;font-family:monospace;font-size:12px;white-space:pre-wrap;color:#333;border:1px dashed #eee}
    @media (max-width:600px){ .wrap{padding:12px} .totals{font-size:16px} }
  </style>
</head>
<body>
  <main class="wrap">
    <div class="card">
      <header>
        <h1>MURAIN — 結帳</h1>
        <div class="muted">請確認商品、運費與付款方式，然後按下一步前往付款。</div>
      </header>

      <div id="content" class="grid">
        <div id="cartArea" class="">
          <div class="muted small">訂單資訊</div>
          <div id="items" class="cart-list"></div>
          <div class="totals">
            <div>合計</div>
            <div id="totalAmount">NT$ 0</div>
          </div>
        </div>

        <div id="checkoutForm" class="">
          <div class="muted small" style="margin-bottom:8px">付款方式</div>
          <div class="controls">
            <select id="paymentMethod" aria-label="選擇付款方式">
              <option value="PAYUNI">線上刷卡 / 分期 (PayUni)</option>
              <option value="COD">超商取貨付款 (711 / 貨到付款)</option>
              <option value="DEPOSIT">先匯款（訂金）</option>
              <option value="MAIL">郵寄 / 匯款到帳</option>
            </select>
            <button id="payBtn" class="primary">前往付款</button>
            <button id="refreshBtn" class="secondary">重新載入購物車</button>
            <div id="statusMsg" class="hint"></div>
          </div>

          <div id="notes" class="muted small" style="margin-top:8px">
            若付款流程失敗，頁面會顯示伺服器回傳錯誤。請將錯誤訊息複製給工程師以便排查。
          </div>

          <div id="errorBox" class="error" role="alert" style="display:none"></div>
          <div id="successBox" class="success" style="display:none"></div>

          <div id="debugBox" class="debug" style="display:none"></div>
        </div>
      </div>
    </div>
  </main>

<script>
(async function(){
  // ==== CONFIG ====
  // IMPORTANT: use relative paths so this front-end can be hosted under the same domain.
  // Your Worker endpoints should be reachable at the same origin (e.g. Cloudflare Pages + Worker on same domain).
  // If your Worker is on a separate host (api.murain.tw), change API_BASE to that host.
  const API_BASE = ''; // relative root -> requests go to "/checkout", "/cart/{token}", "/payuni-return" etc.

  const FRONT_ORIGIN = location.origin.replace(/\/$/,''); // used for ReturnURL if needed

  // ==== UI refs ====
  const itemsEl = document.getElementById('items');
  const totalEl = document.getElementById('totalAmount');
  const payBtn = document.getElementById('payBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const paymentMethodEl = document.getElementById('paymentMethod');
  const statusMsg = document.getElementById('statusMsg');
  const errorBox = document.getElementById('errorBox');
  const successBox = document.getElementById('successBox');
  const debugBox = document.getElementById('debugBox');

  let cartToken = (new URL(location.href)).searchParams.get('cart_token') || (new URL(location.href)).searchParams.get('token') || null;
  if (!cartToken) {
    showError('找不到 cart_token。請確認你是從直播頁或商品連結前往此頁（URL 需包含 ?cart_token=...）。');
    return;
  }

  let currentOrder = null;
  let isSubmitting = false;

  function formatCurrency(n){ return 'NT$ ' + Number(n||0).toLocaleString(); }
  function showError(msg, dbg){ errorBox.style.display='block'; errorBox.textContent = String(msg || '錯誤'); if (dbg) showDebug(dbg); window.scrollTo(0,0); }
  function clearError(){ errorBox.style.display='none'; errorBox.textContent=''; }
  function showSuccess(msg){ successBox.style.display='block'; successBox.textContent = String(msg || '完成'); }
  function clearSuccess(){ successBox.style.display='none'; successBox.textContent=''; }
  function showDebug(o){ debugBox.style.display='block'; debugBox.textContent = (typeof o === 'string' ? o : JSON.stringify(o, null, 2)); }
  function clearDebug(){ debugBox.style.display='none'; debugBox.textContent=''; }

  async function apiFetch(path, opts = {}) {
    const url = (path.startsWith('http') ? path : (API_BASE + path));
    try {
      const res = await fetch(url, opts);
      const text = await res.text();
      let data;
      try { data = text ? JSON.parse(text) : {}; }
      catch(e){
        try { data = Object.fromEntries(new URLSearchParams(text)); } catch(_) { data = text; }
      }
      return { ok: res.ok, status: res.status, data, rawText: text };
    } catch (e) {
      return { ok:false, error: e.message, status: 0, data: null };
    }
  }

  async function loadCart() {
    clearError(); clearSuccess(); clearDebug();
    statusMsg.textContent = '載入中…';
    setLoading(true);

    const r = await apiFetch(`/cart/${encodeURIComponent(cartToken)}`, { method: 'GET' });
    setLoading(false);
    if (!r.ok) {
      showError('伺服器回應錯誤：' + (r.status || 'network error'), r.data || r.error || r.rawText);
      statusMsg.textContent = '載入失敗';
      return;
    }
    const payload = r.data;
    currentOrder = payload;
    itemsEl.innerHTML = '';
    const items = Array.isArray(payload.items) ? payload.items : (payload.items ? Array.from(Object.values(payload.items)) : []);
    if (!items || items.length === 0) {
      itemsEl.innerHTML = '<div class="muted">購物車內沒有商品 — 請先加入商品。</div>';
      totalEl.textContent = formatCurrency(payload.total_amount || 0);
      statusMsg.textContent = '購物車空';
      return;
    }
    for (const it of items) {
      const row = document.createElement('div'); row.className = 'item';
      row.innerHTML = `
        <div style="flex:1">
          <div class="title">${escapeHtml(it.name || it.sku || '品項')}</div>
          <div class="qty">數量: ${escapeHtml(String(it.qty || 1))} • 單價 ${formatCurrency(it.unit_price_final || it.unit_price_base || 0)}</div>
        </div>
        <div style="min-width:120px;text-align:right">${formatCurrency(it.subtotal || (it.qty*(it.unit_price_final||it.unit_price_base||0)))}</div>
      `;
      itemsEl.appendChild(row);
    }
    totalEl.textContent = formatCurrency(payload.total_amount || 0);
    statusMsg.textContent = `訂單 ${payload.order_id}（${payload.status}）`;
  }

  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  }

  function setLoading(flag){
    if (flag) {
      document.body.classList.add('loading');
      payBtn.disabled = true; refreshBtn.disabled = true;
    } else {
      document.body.classList.remove('loading');
      payBtn.disabled = false; refreshBtn.disabled = false;
    }
  }

  payBtn.addEventListener('click', async (ev) => {
    ev.preventDefault();
    if (isSubmitting) return;
    clearError(); clearSuccess(); clearDebug();

    const method = paymentMethodEl.value || 'PAYUNI';
    isSubmitting = true;
    setLoading(true);
    statusMsg.textContent = '建立結帳資料…';

    const body = { cart_token: cartToken, payment_method: method };
    const resp = await apiFetch('/checkout', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });

    setLoading(false);
    isSubmitting = false;

    if (!resp.ok) {
      showError('結帳 API 回傳錯誤: ' + (resp.status || 'network'), resp.data || resp.rawText || resp.error);
      return;
    }

    const data = resp.data;
    if (data && data.error) {
      showError('結帳失敗：' + (data.error || 'unknown'), data);
      return;
    }

    if (data && (data.submit_to || data.fields)) {
      showDebug({ note: '即將轉交至金流 Gateway', payload: data });
      statusMsg.textContent = '轉到金流頁面，請稍候…';
      try {
        submitToGateway(data.submit_to, data.fields);
      } catch (e) {
        showError('自動轉向金流失敗：' + e.message, data);
      }
      return;
    }

    if (data && data.fields && data.submit_to) {
      submitToGateway(data.submit_to, data.fields);
      return;
    }

    showDebug(data);
    showError('無法識別的結帳結果，請聯繫工程師。', data);
  });

  refreshBtn.addEventListener('click', async () => { await loadCart(); });

  function submitToGateway(actionUrl, fields){
    if (!actionUrl || !fields) throw new Error('missing gateway url or fields');
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = actionUrl;
    form.style.display = 'none';
    const fobj = (typeof fields === 'string') ? { Plain: fields } : fields;
    for (const [k, v] of Object.entries(fobj)) {
      const inp = document.createElement('input');
      inp.type = 'hidden';
      inp.name = k;
      inp.value = (v === null || typeof v === 'undefined') ? '' : String(v);
      form.appendChild(inp);
    }
    // Ensure gateway redirects back to order-result with cart_token
    const returnInput = document.createElement('input');
    returnInput.type = 'hidden';
    returnInput.name = 'ReturnURL';
    const desiredReturn = `${FRONT_ORIGIN}/order-result.html?cart_token=${encodeURIComponent(cartToken)}`;
    returnInput.value = desiredReturn;
    form.appendChild(returnInput);

    document.body.appendChild(form);
    setTimeout(()=>{ try { form.submit(); } catch(e) { throw e; } }, 200);
  }

  await loadCart();

})();
</script>
</body>
</html>
