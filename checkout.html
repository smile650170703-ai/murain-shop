<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>結帳 — MURAIN</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial; padding:24px; color:#222}
    .panel{max-width:900px;margin:36px auto;padding:20px;border:1px solid #eee;border-radius:8px;background:#fff}
    .muted{color:#666;font-size:0.95rem}
    .notice{padding:12px;border-radius:6px;background:#f6f8fa;border:1px solid #e3e8ee;margin-bottom:16px}
    .btn{display:inline-block;padding:10px 16px;border-radius:6px;background:#0b62ff;color:#fff;text-decoration:none}
  </style>
</head>
<body>
  <div class="panel">
    <h1>前往付款…</h1>
    <div id="status" class="muted">系統正在準備付款表單，準備完成將會自動跳轉。若沒有自動跳轉，請按下「手動前往付款」按鈕。</div>
    <div id="debug" style="margin-top:12px;"></div>
    <div style="margin-top:18px;">
      <a id="manual-btn" class="btn" href="#" style="display:none">手動前往付款</a>
    </div>
    <div style="margin-top:14px" class="muted">
      注意：此檔案會嘗試下列順序尋找 checkout 物件：<br>
      1) window.checkout（頁面上已有的全域物件）<br>
      2) &lt;script id="checkout-data"&gt;裡的 JSON（如果後端直接把 checkout JSON 放在頁面）<br>
      3) 嘗試用 URL query `cart_token` POST 到 <code>/checkout</code> 取得（如果頁面透過 query 傳 cart_token）<br>
      若都找不到，畫面會顯示錯誤與可複製的 debug JSON，方便你手動回傳給後端測試人員。
    </div>
  </div>

<script>
  // Create and submit a hidden form to the gateway (POST).
  function postToGateway(submitTo, fields) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = submitTo;
    form.style.display = 'none';
    for (const k in fields) {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = k;
      input.value = fields[k] == null ? '' : String(fields[k]);
      form.appendChild(input);
    }
    document.body.appendChild(form);
    // small delay to let DOM update for debug visibility
    setTimeout(()=> form.submit(), 250);
  }

  async function fetchCheckoutFromApi(cartToken) {
    try {
      const resp = await fetch('/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cart_token: cartToken, payment_method: localStorage.__preferred_payment_method || null })
      });
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const json = await resp.json();
      return json;
    } catch (e) {
      return { error: 'fetch_failed', reason: String(e) };
    }
  }

  function readQueryParam(name) {
    try {
      const u = new URL(location.href);
      return u.searchParams.get(name);
    } catch (e) {
      return null;
    }
  }

  function showDebug(msg) {
    const dbg = document.getElementById('debug');
    if (typeof msg === 'object') msg = JSON.stringify(msg, null, 2);
    dbg.innerText = msg;
  }

  async function tryAutoPost() {
    let checkout = null;
    // 1) check window.checkout
    if (window.checkout && typeof window.checkout === 'object') {
      checkout = window.checkout;
      document.getElementById('status').innerText = '發現 window.checkout，準備自動跳轉…';
    }

    // 2) check script#checkout-data
    if (!checkout) {
      const el = document.getElementById('checkout-data');
      if (el) {
        try {
          checkout = JSON.parse(el.textContent || el.innerText);
          document.getElementById('status').innerText = '從 <script id="checkout-data"> 取得 checkout 資料，準備自動跳轉…';
        } catch(e){}
      }
    }

    // 3) try fetch /checkout with cart_token from URL
    if (!checkout) {
      const cartToken = readQueryParam('cart_token') || readQueryParam('token') || null;
      if (cartToken) {
        document.getElementById('status').innerText = '使用 cart_token 向 /checkout 要付款資料…';
        const r = await fetchCheckoutFromApi(cartToken);
        if (r && (r.fields || r.submit_to)) {
          checkout = r;
          document.getElementById('status').innerText = '從 /checkout 取得付款資料，準備自動跳轉…';
        } else {
          showDebug(r);
        }
      }
    }

    if (!checkout || !checkout.submit_to || !checkout.fields) {
      document.getElementById('status').innerText = '找不到有效的付款資料 (checkout.submit_to / checkout.fields)。';
      showDebug({
        window_checkout: !!window.checkout,
        has_script_checkout_data: !!document.getElementById('checkout-data'),
        cart_token_in_url: readQueryParam('cart_token') || readQueryParam('token') || null,
        hint: '確認後端是否把 checkout JSON 放到頁面 (window.checkout 或 <script id="checkout-data">) 或讓 /checkout 接受 cart_token 的 POST 並回傳付款表單。'
      });
      // show manual button if fallback is available (submit_to present in debug JSON)
      const manual = document.getElementById('manual-btn');
      manual.style.display = 'inline-block';
      manual.onclick = function(e) {
        e.preventDefault();
        // if there is a JSON in debug place that contains submit_to and fields, allow manual post
        try {
          let candidate = window.checkout || (document.getElementById('checkout-data') && JSON.parse(document.getElementById('checkout-data').textContent));
          if (candidate && candidate.submit_to && candidate.fields) {
            postToGateway(candidate.submit_to, candidate.fields);
          } else {
            alert('沒有找到可用的付款資料，請檢查 debug 區塊。');
          }
        } catch(err) {
          alert('手動提交失敗：' + err);
        }
      };
      return;
    }

    // okay we have checkout.submit_to and checkout.fields
    // Bind manual button to same action (in case popup blocking or user wants to click)
    const manual = document.getElementById('manual-btn');
    manual.style.display = 'inline-block';
    manual.onclick = function(e) {
      e.preventDefault();
      postToGateway(checkout.submit_to, checkout.fields);
    };

    // Show masked debug (not exposing sensitive fields) for transparency
    const safeFields = {};
    for (const k in checkout.fields) {
      safeFields[k] = (String(checkout.fields[k]).length > 12) ? String(checkout.fields[k]).slice(0,8) + '…' : checkout.fields[k];
    }
    showDebug({ submit_to: checkout.submit_to, fields_preview: safeFields });

    // Auto-post now
    postToGateway(checkout.submit_to, checkout.fields);
  }

  document.addEventListener('DOMContentLoaded', tryAutoPost);
</script>

<!-- Optional: backend may inject checkout JSON here:
<script id="checkout-data" type="application/json">{"submit_to":"https://www.payuni.com.tw/UPP/Pay","fields":{"MerID":"GOGO1586942584","EncryptInfo":"...","HashInfo":"..."}}</script>
Or backend may set window.checkout = {...} before this script runs.
-->
</body>
</html>
