<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MURAIN — 結帳</title>
  <style>
    :root { --bg:#f7f7f8; --card:#fff; --txt:#222; --muted:#6b7280; --pri:#111; --pri2:#000; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial, "Noto Sans TC", "PingFang TC", sans-serif;background:var(--bg);color:var(--txt);}
    .wrap{max-width:820px;margin:24px auto;padding:0 16px;}
    .card{background:var(--card);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.05);padding:20px;margin-bottom:16px;}
    h1{font-size:20px;margin:0 0 8px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0}
    .col{flex:1 1 220px;min-width:220px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,select,button,textarea{width:100%;box-sizing:border-box;font-size:16px;border:1px solid #e5e7eb;border-radius:10px;padding:12px 12px;background:#fff}
    textarea{resize:vertical;min-height:90px}
    .btn{background:#111;color:#fff;border:none;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn-outline{background:#fff;border:1px solid #111;color:#111}
    .muted{color:var(--muted);font-size:12px}
    .bar{display:flex;gap:10px;flex-wrap:wrap}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .pill{display:inline-block;background:#111;color:#fff;border-radius:999px;padding:6px 10px;font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>結帳</h1>
    <div class="muted">* 此頁需要帶 <span class="mono">?cart_token=...</span> 開啟</div>
  </div>

  <!-- 訂購人 -->
  <div class="card">
    <h1>收件人資料</h1>
    <div class="row">
      <div class="col">
        <label>姓名</label>
        <input id="name" placeholder="請輸入收件人姓名" required />
      </div>
      <div class="col">
        <label>電話</label>
        <input id="phone" placeholder="09xx..." inputmode="tel" required />
      </div>
      <div class="col">
        <label>Email（可填 LINE 用戶ID 代替）</label>
        <input id="email" placeholder="user@example.com" inputmode="email" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>備註（選填）</label>
        <textarea id="note" placeholder="贈品或其他備註（選填）"></textarea>
      </div>
    </div>
  </div>

  <!-- 7-11 門市 -->
  <div class="card">
    <h1>取貨門市 — 7-ELEVEN</h1>
    <div class="bar">
      <button class="btn" id="btnCvs">選擇 7-11 門市</button>
      <span class="pill" id="cvsTag" style="display:none"></span>
    </div>
    <div class="row" style="margin-top:10px">
      <div class="col">
        <label>門市代號</label>
        <input id="cvs_id" readonly />
      </div>
      <div class="col">
        <label>門市名稱</label>
        <input id="cvs_name" readonly />
      </div>
      <div class="col">
        <label>門市地址</label>
        <input id="cvs_addr" readonly />
      </div>
    </div>
    <div class="muted">* 送出前必須選店；目前使用 ECPay 官方地圖。</div>
  </div>

  <!-- 付款 -->
  <div class="card">
    <h1>付款方式</h1>
    <div class="row">
      <div class="col">
        <select id="pay" aria-label="付款方式">
          <option value="bank_transfer">新客匯款（ATM/轉帳）</option>
          <option value="cod_711">7-11 貨到付款（老客）</option>
          <option value="online_pay">線上支付（PayUNI）</option>
        </select>
      </div>
      <div class="col">
        <label>應付總額（由主播頁計算）</label>
        <input id="total" class="mono" readonly placeholder="從購物車取得…" />
      </div>
    </div>
  </div>

  <!-- 送出 -->
  <div class="card">
    <div class="bar">
      <button class="btn" id="submitBtn">送出訂單</button>
      <button class="btn-outline" id="onlineBtn" type="button">線上支付</button>
    </div>
    <div class="muted" id="tip"></div>
  </div>
</div>

<script>
/* ===== 固定設定 ===== */
const API = 'https://api.murain.tw';
const PAYUNI_LINK = 'https://api.payuni.com.tw/api/uop/receive_info/2/1/GOGO1586942584/8UoSwkh2D82d9G9Vqm2m';

/* ===== 小工具 ===== */
const $ = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => [...r.querySelectorAll(s)];
const qs = new URLSearchParams(location.search);
const cartToken = qs.get('cart_token') || '';
function money(n){ return 'NT$ ' + (Number(n)||0).toLocaleString(); }
function toast(t){ $('#tip').textContent = t; }
async function post(url, data){
  const r = await fetch(url, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(data) });
  const txt = await r.text();
  try { return { ok:r.ok, status:r.status, data: JSON.parse(txt) }; }
  catch { return { ok:r.ok, status:r.status, data: txt }; }
}

/* ===== 7-11 門市地圖（ECPay） ===== */
const ECPAY_MAP_URL = 'https://logistics.ecpay.com.tw/Express/map';
const cvsParams = new URLSearchParams({
  MerchantID: '2000132',        // 測試商店（僅開地圖，不下物流單）
  LogisticsType: 'CVS',
  LogisticsSubType: 'UNIMARTC2C',
  IsCollection: 'N',
  Device: '0'
});
let cvsWin=null;
$('#btnCvs').addEventListener('click', ()=>{
  const url = `${ECPAY_MAP_URL}?${cvsParams.toString()}`;
  cvsWin = window.open(url, 'ecpay_cvs', 'width=1000,height=720');
});

/* 接收選店結果（ECPay 用 postMessage 回傳） */
function parseEcpayData(payload){
  if (!payload) return null;
  // 可能是字串 querystring / JSON / 物件；全部兜容
  try{
    if (typeof payload === 'string') {
      // 嘗試 JSON
      try { payload = JSON.parse(payload); }
      catch { // querystring
        const p = new URLSearchParams(payload);
        payload = Object.fromEntries(p.entries());
      }
    }
  }catch(e){}
  const id   = payload.CVSStoreID   || payload.StoreID   || payload.cvs_id   || payload.cvsid;
  const name = payload.CVSStoreName || payload.StoreName || payload.cvs_name || payload.cvsname;
  const addr = payload.CVSAddress   || payload.CVSStoreAddress || payload.Address || payload.cvs_addr || payload.cvsaddress;
  return (id && name) ? { id, name, addr: addr || '' } : null;
}
window.addEventListener('message', (ev)=>{
  // 只接受 ecpay logistics 網域
  try{
    const h = new URL(ev.origin).hostname;
    if (!/ecpay\.com\.tw$/.test(h)) return;
  }catch(e){ return; }

  const data = parseEcpayData(ev.data);
  if (!data) return;
  $('#cvs_id').value = data.id;
  $('#cvs_name').value = data.name;
  $('#cvs_addr').value = data.addr || '';
  $('#cvsTag').style.display = 'inline-block';
  $('#cvsTag').textContent = `${data.id}・${data.name}`;
  cvsWin && cvsWin.close();
});

/* ===== 初始化：讀購物車金額 ===== */
(async ()=>{
  if (!cartToken){ toast('缺少 cart_token'); $('#submitBtn').disabled = true; return; }
  try{
    const r = await fetch(`${API}/cart/${cartToken}`);
    const data = await r.json();
    const v = data && data.total_amount || 0;
    $('#total').value = money(v);
  }catch(e){ /* 不擋流程 */ }
})();

/* ===== 線上支付（直接導到你給的 PayUNI URL） ===== */
$('#onlineBtn').addEventListener('click', ()=>{
  window.open(PAYUNI_LINK, '_blank');
});

/* ===== 送出訂單 ===== */
$('#submitBtn').addEventListener('click', async ()=>{
  if (!cartToken){ alert('找不到購物車'); return; }

  const name  = $('#name').value.trim();
  const phone = $('#phone').value.trim();
  const email = $('#email').value.trim();
  const note  = $('#note').value.trim();
  const pay   = $('#pay').value;

  if (!name || !phone){ alert('請填寫姓名與電話'); return; }

  // 7-11 取貨必須有門市
  const store_id = $('#cvs_id').value.trim();
  const store_name = $('#cvs_name').value.trim();
  const store_addr = $('#cvs_addr').value.trim();
  if (!store_id){ alert('請先選擇 7-11 門市'); return; }

  // 線上支付只做導轉，不建單（如果要建單可改在這裡先 POST /checkout 再導頁）
  if (pay === 'online_pay'){
    window.open(PAYUNI_LINK, '_blank');
    return;
  }

  const shipping_info = {
    type: '711',
    store_id, store_name, store_address: store_addr,
    receiver_name: name, phone, email, note
  };

  toast('送出中…');
  const { ok, status, data } = await post(`${API}/checkout`, {
    cart_token: cartToken,
    payment_method: pay,         // bank_transfer / cod_711
    shipping_info
  });

  if (!ok){
    console.log(data);
    alert('送出失敗（' + status + '）');
    toast('送出失敗，請稍後再試');
    return;
  }
  // 成功 → 轉結果頁或提示
  const orderId = (data && data.order_id) ? data.order_id : '';
  toast('已收到訂單 ' + orderId);
  // 若你有 order-result.html 可用以下跳轉
  if (orderId) location.href = `./order-result.html?order_id=${encodeURIComponent(orderId)}`;
});
</script>
</body>
</html>
