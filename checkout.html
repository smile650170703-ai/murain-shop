<!DOCTYPE html>
<html lang="zh-Hant"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>MURAIN — 行動結帳（兩鍵版）</title>
<style>body{font-family:system-ui,'Noto Sans TC',sans-serif;margin:0;background:#fafafa}.wrap{max-width:560px;margin:0 auto;padding:1rem}.tabs{display:flex;gap:8px;position:sticky;top:0;background:#fafafa;padding:8px 0}.tab{flex:1;border:1px solid #ddd;border-radius:10px;padding:8px;text-align:center;cursor:pointer;background:#fff}.tab.active{background:#111;color:#fff}.box{background:#fff;border-radius:12px;padding:12px;box-shadow:0 4px 10px rgba(0,0,0,.06);margin-top:10px}label{display:block;margin:.5rem 0 .2rem}input{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px}button{width:100%;padding:12px;border:0;border-radius:10px;background:#111;color:#fff;font-size:1rem;margin-top:10px}.muted{color:#666;font-size:.9rem}.row{display:flex;gap:8px}.row>div{flex:1}.only-one{display:none}</style>
<script>window.API_BASE="https://api.murain.tw"</script>
</head>
<body><div class="wrap"><h1>行動結帳</h1><div class="muted" id="flowNote"></div>
<div class="tabs" id="tabs" style="display:none;"><div class="tab active" data-tab="cod">7-11 貨到付款</div><div class="tab" data-tab="pay">其他金流</div></div>
<div class="box only-one" id="box-new"><div class="muted">請先完成以下資料，我們將保留訂單。</div>
<label>姓名</label><input id="n_name" required /><label>電話</label><input id="n_phone" required /><label>7-11 門市（可填門市名或代號）</label><input id="n_store" required /><label>匯款帳號後五碼</label><input id="n_last5" required />
<div class="muted"><ul><li>匯款資訊：銀行代號 822（中信）</li><li>帳號：222540458194</li></ul></div><button id="btn-new">送出（保留訂單）</button></div>
<div class="box" id="box-cod" style="display:none;"><div class="muted">7-11 取貨付款，請填寫資料。</div>
<div class="row"><div><label>姓名</label><input id="c_name" required /></div><div><label>電話</label><input id="c_phone" required /></div></div>
<label>Email（必填，用於寄送通知）</label><input id="c_email" required /><label>7-11 門市（可填門市名或代號）</label><input id="c_store" required /><button id="btn-cod">送出（貨到付款）</button></div>
<div class="box" id="box-pay" style="display:none;"><div class="muted">此區示範「線上金流（PayUNI / 中租無卡）」的導轉。Demo 會模擬成功。</div><label>姓名</label><input id="p_name" required /><label>電話</label><input id="p_phone" required /><button id="btn-pay">前往付款（模擬）</button></div>
<div class="box"><div class="muted">訂單摘要</div><div id="summary"></div></div></div>
<script>
const API=(window.API_BASE||'').replace(/\/$/,'')||'';const params=new URLSearchParams(location.search);const CART_TOKEN=params.get('cart_token')||'';const FLOW=(params.get('flow')||'').toLowerCase();
async function get(u){const r=await fetch(API+u);return r.json();}
async function post(u,d){const r=await fetch(API+u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d||{})});return r.json();}
function setMode(){const note=document.getElementById('flowNote');const tabs=document.getElementById('tabs');const boxNew=document.getElementById('box-new');const boxCod=document.getElementById('box-cod');const boxPay=document.getElementById('box-pay');if(FLOW==='new'){note.textContent='此連結由主播指定為「新客匯款」流程。';tabs.style.display='none';boxNew.style.display='block';boxCod.style.display='none';boxPay.style.display='none';}else{note.textContent='此連結由主播指定為「老客 7-11 取貨付款」或「其他金流」流程。';tabs.style.display='flex';boxNew.style.display='none';boxCod.style.display='block';boxPay.style.display='none';}}
function switchTab(tab){document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');document.getElementById('box-cod').style.display=(tab==='cod')?'block':'none';document.getElementById('box-pay').style.display=(tab==='pay')?'block':'none';}
document.addEventListener('click',e=>{const t=e.target;if(t.classList.contains('tab')){switchTab(t.dataset.tab);}});
async function load(){if(!CART_TOKEN){alert('缺少 cart_token');return;}const data=await get('/cart/'+CART_TOKEN);if(data.error){alert(data.error);return;}const items=data.items||[];const html=items.map(i=>`<div style="display:flex;justify-content:space-between;"><div>${i.name} × ${i.qty}</div><div>NT$ ${(i.price*i.qty).toLocaleString()}</div></div>`).join('');const total=items.reduce((s,i)=>s+i.price*i.qty,0);document.getElementById('summary').innerHTML=html+`<hr><div style="display:flex;justify-content:space-between;font-weight:700;"><div>合計</div><div>NT$ ${total.toLocaleString()}</div></div>`;}
document.getElementById('btn-new')?.addEventListener('click',async ()=>{const name=document.getElementById('n_name').value.trim();const phone=document.getElementById('n_phone').value.trim();const store=document.getElementById('n_store').value.trim();const last5=document.getElementById('n_last5').value.trim();if(!name||!phone||!store||!last5){alert('請完整填寫');return;}const r=await post('/checkout',{cart_token:CART_TOKEN,payment_method:'bank_transfer',shipping:{name,phone,store,remit_last5:last5}});if(r.ok){location.href='./order-result.html?ok=1&order_id='+(r.order_id||'');}else alert(r.error||'發生錯誤');});
document.getElementById('btn-cod')?.addEventListener('click',async ()=>{const name=document.getElementById('c_name').value.trim();const phone=document.getElementById('c_phone').value.trim();const email=document.getElementById('c_email').value.trim();const store=document.getElementById('c_store').value.trim();if(!name||!phone||!email||!store){alert('請完整填寫');return;}const r=await post('/checkout',{cart_token:CART_TOKEN,payment_method:'cod_711',shipping:{name,phone,email,store}});if(r.ok){location.href='./order-result.html?ok=1&order_id='+(r.order_id||'');}else alert(r.error||'發生錯誤');});
document.getElementById('btn-pay')?.addEventListener('click',async ()=>{const name=document.getElementById('p_name').value.trim();const phone=document.getElementById('p_phone').value.trim();if(!name||!phone){alert('請完整填寫');return;}const r=await post('/checkout',{cart_token:CART_TOKEN,payment_method:'payuni_card',shipping:{name,phone}});if(r.redirect_url){location.href=r.redirect_url;}else if(r.ok){location.href='./order-result.html?ok=1&order_id='+(r.order_id||'');}else{alert(r.error||'發生錯誤');}});
setMode();load();</script></body></html>
