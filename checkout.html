<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MURAIN — 結帳</title>
  <style>
    body { margin:0; font-family: system-ui, 'Noto Sans TC', Arial; background:#f7f7fb; }
    .wrap { max-width: 960px; margin: 24px auto; padding:0 16px; }
    .card { background:#fff; border-radius:14px; box-shadow:0 6px 24px rgba(0,0,0,.06); padding:18px; margin-bottom:14px; }
    h2 { margin:0 0 12px; }
    .row { display:grid; grid-template-columns: repeat(12,1fr); gap:10px; }
    .col-3{grid-column:span 3} .col-4{grid-column:span 4} .col-6{grid-column:span 6} .col-12{grid-column:span 12}
    input, select, button, textarea { width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:10px; }
    button.btn { background:#111; color:#fff; border:none; cursor:pointer; }
    table { width:100%; border-collapse: collapse; }
    th,td { padding:10px; border-bottom:1px solid #eee; }
    td.right { text-align:right; }
    .mut { color:#777; font-size:.9rem; }
  </style>
  <script>window.API_BASE="https://api.murain.tw";</script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>購物車</h2>
      <table>
        <thead><tr><th>SKU</th><th>品名</th><th class="right">單價</th><th class="right">數量</th><th class="right">小計</th></tr></thead>
        <tbody id="lines"></tbody>
        <tfoot><tr><td colspan="5" class="right"><b>合計 NT$ <span id="total">0</span></b></td></tr></tfoot>
      </table>
    </div>

    <div class="card">
      <h2>付款方式</h2>
      <div class="row">
        <div class="col-6">
          <select id="pay">
            <option value="bank_transfer">ATM/匯款（新客）</option>
            <option value="cod_711">7-11 貨到付款（老客）</option>
          </select>
        </div>
      </div>
      <div class="mut">若為「匯款」，完成後請在下方填寫「後五碼」。</div>
    </div>

    <div class="card">
      <h2>收件資料</h2>
      <div class="row">
        <div class="col-4"><input id="name" placeholder="姓名" /></div>
        <div class="col-4"><input id="phone" placeholder="電話" /></div>
        <div class="col-4"><input id="email" placeholder="Email（可留空）" /></div>
        <div class="col-6"><input id="store" placeholder="7-11 門市（或留空改填地址）" /></div>
        <div class="col-6"><input id="addr" placeholder="寄送地址（選一種即可）" /></div>
        <div class="col-6"><input id="remit" placeholder="匯款帳號後五碼（匯款才需填）" /></div>
        <div class="col-12"><textarea id="note" placeholder="備註"></textarea></div>
        <div class="col-3"><button id="btnSubmit" class="btn">送出訂單</button></div>
      </div>
    </div>

    <div id="msg" class="wrap"></div>
  </div>

<script>
const API = window.API_BASE;
const params = new URLSearchParams(location.search);
const CART = params.get('cart_token') || '';
const PM   = params.get('pm') || '';

function $(q){return document.querySelector(q);}
const fmt = n => (n||0).toLocaleString();

window.addEventListener('load', () => {
  if(PM) $('#pay').value = PM;
  render();
});

async function render(){
  if(!CART) return;
  const r = await fetch(API + '/cart/' + CART);
  const d = await r.json();
  const tb = $('#lines'); tb.innerHTML='';
  (d.items||[]).forEach(i=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i.sku||''}</td><td>${i.name||''}</td><td class="right">NT$ ${(i.price||0).toLocaleString()}</td><td class="right">${i.qty||0}</td><td class="right">NT$ ${((i.price||0)*(i.qty||0)).toLocaleString()}</td>`;
    tb.appendChild(tr);
  });
  $('#total').textContent = (d.total||0).toLocaleString();
}

$('#btnSubmit').onclick = async () => {
  if(!CART) return alert('找不到購物車');
  const shipping = {
    name: $('#name').value.trim(),
    phone: $('#phone').value.trim(),
    email: $('#email').value.trim(),
    store: $('#store').value.trim(),
    address: $('#addr').value.trim(),
    remit_last5: $('#remit').value.trim(),
    note: $('#note').value.trim(),
  };
  if(!shipping.name || !shipping.phone) return alert('請填姓名與電話');
  const body = { cart_token: CART, payment_method: $('#pay').value, shipping };
  const r = await fetch(API + '/checkout', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
  const d = await r.json();
  if(!d.ok) return alert(d.error||'送出失敗');
  if(d.redirect_url) location.href = d.redirect_url; else { 
    $('#msg').textContent = '訂單建立完成：' + (d.order_id||'');
  }
};
</script>
</body>
</html>
