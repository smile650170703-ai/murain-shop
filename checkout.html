<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>MURAIN — 結帳</title>
<style>
  *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC",Roboto}
  body{margin:0;background:#0b1222;color:#e2e8f0}
  .wrap{max-width:720px;margin:0 auto;padding:16px 16px calc(env(safe-area-inset-bottom,0) + 90px)}
  h1{margin:0 0 8px;font-size:22px}
  .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.4);margin-top:12px}
  label{display:block;font-size:14px;margin:8px 2px 6px}
  input,select,textarea{width:100%;padding:14px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(2,6,23,.6);color:#e2e8f0}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:720px){.row{grid-template-columns:1fr}}
  .tabs{display:flex;gap:8px;overflow:auto}
  .tab{flex:1;min-width:140px;text-align:center;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.04);font-weight:800}
  .tab.active{background:#22d3ee;color:#0b1222;border-color:#22d3ee}
  .hr{height:1px;background:rgba(255,255,255,.12);margin:12px 0}
  .toolbar{position:fixed;left:0;right:0;bottom:0;padding:10px 14px calc(env(safe-area-inset-bottom,0) + 10px);display:flex;gap:10px;background:linear-gradient(0deg,rgba(11,18,34,.95),rgba(11,18,34,.6) 90%,transparent);backdrop-filter: blur(10px)}
  .btn{flex:1;border:0;border-radius:14px;padding:14px;font-weight:900;letter-spacing:.4px;cursor:pointer}
  .primary{background:#22d3ee;color:#0b1222}
  .secondary{background:transparent;color:#e2e8f0;border:1px solid rgba(255,255,255,.2)}
  .copy{border:1px dashed rgba(255,255,255,.25);padding:10px;border-radius:10px;display:flex;gap:8px;align-items:center;justify-content:space-between}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .muted{opacity:.75;font-size:12px}
  .list{margin-top:8px;font-size:13px;line-height:1.5}
</style>
</head>
<body>
<main class="wrap">
  <h1>結帳</h1>

  <div class="card">
  <div class="row">
    <div>
      <label>商品小計（NT$）</label>
      <input id="subtotal" type="number" min="0" step="1" readonly />
      <div id="itemsBox" class="list muted"></div>
    </div>
    <div>
      <label>應付金額</label>
      <input id="total" type="text" readonly />
    </div>
  </div>

  <!-- ⭐ 新增：Email 欄位（共用） -->
  

  <label>備註（選填）</label>
  <textarea id="note" placeholder="…"></textarea>
  <div class="muted">此頁一定要用結帳連結進入（帶 <code>cart_token</code>）。</div>
</div>


  <div class="card">
    <div class="tabs" id="payTabs">
      <button class="tab active" data-pay="COD">7-11 貨到付款</button>
      <button class="tab" data-pay="PAID">線上付款</button>
      <button class="tab" data-pay="DEPOSIT">ATM 匯款</button>
      <button class="tab" data-pay="ZEROCARD">無卡零角</button>
    </div>

    <!-- COD: 僅 7-11 -->
    <div id="paneCOD">
  <div class="row" style="margin-top:6px">
    <div><label>姓名 *</label><input id="cod_name" required /></div>
    <div><label>電話 *</label><input id="cod_phone" required /></div>
  </div>
  <div class="row">
    <div><label>Email *</label><input id="cod_email" type="email" required /></div>
    <div></div>
  </div>
  <div class="row">
    <div><label>7-11 門市代號 *</label><input id="cod_store_id" required /></div>
    <div><label>7-11 門市名稱 *</label><input id="cod_store_name" required /></div>
  </div>
  <label>7-11 門市地址 *</label>
  <input id="cod_store_addr" required />
  <button class="btn secondary" id="mapCOD">開啟 7-11 門市地圖</button>
</div>


    <!-- PAID: 可 7-11 或 郵寄 -->
    <div id="panePAID" hidden>
      <label style="margin-top:8px">選擇管道</label>
      <select id="paid_channel">
        <option value="card_once">信用卡 一次付（零利率）</option>
        <option value="card_inst">信用卡 分期（3/6/9 零利率）</option>
        <option value="linepay">LINE Pay</option>
        <option value="af">AF 先享後付</option>
      </select>
      <div id="cardInstBox" hidden>
        <label>分期期數（零利率）</label>
        <select id="inst_months">
          <option value="3">3</option>
          <option value="6">6</option>
          <option value="9">9</option>
        </select>
      </div>

      <div class="hr"></div>
      <div class="row">
        <div>
          <label>運送方式</label>
          <select id="paid_ship_method">
            <option value="711">7-11 取貨</option>
            <option value="post">中華郵政寄送</option>
          </select>
        </div>
        <div></div>
      </div>

      <div id="paid711">
  <div class="row">
    <div><label>姓名 *</label><input id="ship_name_paid" required /></div>
    <div><label>電話 *</label><input id="ship_phone_paid" required /></div>
  </div>
  <div class="row">
    <div><label>Email *</label><input id="ship_email_paid" type="email" required /></div>
    <div></div>
  </div>
  <div class="row">
    <div><label>7-11 門市代號 *</label><input id="ship_store_id_paid" required /></div>
    <div><label>7-11 門市名稱 *</label><input id="ship_store_name_paid" required /></div>
  </div>
  <label>7-11 門市地址 *</label>
  <input id="ship_store_addr_paid" required />
  <button class="btn secondary" id="mapPAID">開啟 7-11 門市地圖</button>
</div>


      <div id="paidPOST" hidden>
  <div class="row">
    <div><label>姓名 *</label><input id="paid_post_name" required /></div>
    <div><label>電話 *</label><input id="paid_post_phone" required /></div>
  </div>
  <div class="row">
    <div><label>Email *</label><input id="paid_post_email" type="email" required /></div>
    <div></div>
  </div>
  <div class="row">
    <div><label>郵遞區號 *</label><input id="paid_post_zip" required /></div>
    <div><label>郵寄地址 *</label><input id="paid_post_addr" required /></div>
  </div>
</div>

    </div>

    <!-- DEPOSIT: 新/舊 客製 -->
    <div id="paneDEPOSIT" hidden>
      <div id="newDeposit" hidden>
        <div class="row" style="margin-top:6px">
          <div><label>匯款後五碼 *</label><input id="dep_last5_new" required /></div>
          <div></div>
        </div>

        <label>方式</label>
        <select id="dep_new_mode">
          <option value="partial">支付 1000（尾款 7-11 貨到）</option>
          <option value="full">全額匯款</option>
        </select>

        <div id="dep_new_partial">
  <div class="hr"></div>
  <div class="row">
    <div><label>姓名 *</label><input id="dep_new_partial_name" required /></div>
    <div><label>電話 *</label><input id="dep_new_partial_phone" required /></div>
  </div>
  <div class="row">
    <div><label>Email *</label><input id="dep_new_partial_email" type="email" required /></div>
    <div></div>
  </div>
  <div class="row">
    <div><label>7-11 門市代號 *</label><input id="dep_new_partial_store_id" required /></div>
    <div><label>7-11 門市名稱 *</label><input id="dep_new_partial_store_name" required /></div>
  </div>
  <label>7-11 門市地址 *</label>
  <input id="dep_new_partial_store_addr" required />
  <button class="btn secondary" id="mapDEPnewP">開啟 7-11 門市地圖</button>
</div>


        <div id="dep_new_full" hidden>
          <div class="hr"></div>
          <div class="row">
            <div>
              <label>收件方式</label>
              <select id="dep_new_full_ship">
                <option value="711">7-11 取貨</option>
                <option value="post">中華郵政寄送</option>
              </select>
            </div>
            <div></div>
          </div>
          <div id="dep_new_full_711">
  <div class="row">
    <div><label>姓名 *</label><input id="dep_new_full_name" required /></div>
    <div><label>電話 *</label><input id="dep_new_full_phone" required /></div>
  </div>
  <div class="row">
    <div><label>Email *</label><input id="dep_new_full_email" type="email" required /></div>
    <div></div>
  </div>
  <div class="row">
    <div><label>7-11 門市代號 *</label><input id="dep_new_full_store_id" required /></div>
    <div><label>7-11 門市名稱 *</label><input id="dep_new_full_store_name" required /></div>
  </div>
  <label>7-11 門市地址 *</label>
  <input id="dep_new_full_store_addr" required />
  <button class="btn secondary" id="mapDEPnewF">開啟 7-11 門市地圖</button>
</div>

          <div id="dep_new_full_post" hidden>
  <div class="row">
    <div><label>收件人姓名 *</label><input id="dep_new_full_post_name" required /></div>
    <div><label>收件人電話 *</label><input id="dep_new_full_post_phone" required /></div>
  </div>
  <div class="row">
    <div><label>Email *</label><input id="dep_new_full_post_email" type="email" required /></div>
    <div></div>
  </div>
  <div class="row">
    <div><label>郵遞區號 *</label><input id="dep_new_full_post_zip" required /></div>
    <div><label>郵寄地址 *</label><input id="dep_new_full_post_addr" required /></div>
  </div>
</div>

        </div>
      </div>

      <div id="oldDeposit" hidden>
        <div class="copy">
          <div>
            郵局代號：<span class="mono">822</span>　　帳號：<span class="mono">222540458194</span>
          </div>
          <button id="copyBank" class="btn secondary" style="flex:0 0 auto">複製</button>
        </div>
        <div class="row" style="margin-top:10px">
          <div><label>匯款後五碼 *</label><input id="dep_last5_old" required /></div>
          <div></div>
        </div>
        <div class="row">
          <div>
            <label>收件方式</label>
            <select id="dep_old_ship">
              <option value="711">7-11 取貨</option>
              <option value="post">中華郵政寄送</option>
            </select>
          </div>
          <div></div>
        </div>
        <div id="dep_old_711">
  <div class="row">
    <div><label>姓名 *</label><input id="dep_old_name" required /></div>
    <div><label>電話 *</label><input id="dep_old_phone" required /></div>
  </div>
  <div class="row">
    <div><label>Email *</label><input id="dep_old_email" type="email" required /></div>
    <div></div>
  </div>
  <div class="row">
    <div><label>7-11 門市代號 *</label><input id="dep_old_store_id" required /></div>
    <div><label>7-11 門市名稱 *</label><input id="dep_old_store_name" required /></div>
  </div>
  <label>7-11 門市地址 *</label>
  <input id="dep_old_store_addr" required />
  <button class="btn secondary" id="mapDEPOld711">開啟 7-11 門市地圖</button>
</div>

        <div id="dep_old_post" hidden>
  <div class="row">
    <div><label>收件人姓名 *</label><input id="dep_old_post_name" required /></div>
    <div><label>收件人電話 *</label><input id="dep_old_post_phone" required /></div>
  </div>
  <div class="row">
    <div><label>Email *</label><input id="dep_old_post_email" type="email" required /></div>
    <div></div>
  </div>
  <div class="row">
    <div><label>郵遞區號 *</label><input id="dep_old_post_zip" required /></div>
    <div><label>郵寄地址 *</label><input id="dep_old_post_addr" required /></div>
  </div>
</div>

      </div>
    </div>

    <!-- ZEROCARD: 可 7-11 或 郵寄 -->
    <div id="paneZEROCARD" hidden>
      <div class="row">
        <div>
          <label>期數</label>
          <select id="zc_months">
            <option value="3">3</option><option value="6">6</option><option value="9">9</option>
            <option value="12">12</option><option value="18">18</option><option value="24">24</option>
          </select>
        </div>
        <div>
          <label>每期金額</label>
          <input id="zc_calc" readonly />
        </div>
      </div>

      <div class="hr"></div>
      <div class="row">
        <div>
          <label>運送方式</label>
          <select id="zc_ship_method">
            <option value="711">7-11 取貨</option>
            <option value="post">中華郵政寄送</option>
          </select>
        </div>
        <div></div>
      </div>

      <div id="zc711">
  <div class="row">
    <div><label>姓名 *</label><input id="ship_name_zc" required /></div>
    <div><label>電話 *</label><input id="ship_phone_zc" required /></div>
  </div>
  <div class="row">
    <div><label>Email *</label><input id="ship_email_zc" type="email" required /></div>
    <div></div>
  </div>
  <div class="row">
    <div><label>7-11 門市代號 *</label><input id="ship_store_id_zc" required /></div>
    <div><label>7-11 門市名稱 *</label><input id="ship_store_name_zc" required /></div>
  </div>
  <label>7-11 門市地址 *</label>
  <input id="ship_store_addr_zc" required />
  <button class="btn secondary" id="mapZC">開啟 7-11 門市地圖</button>
</div>


      <div id="zcPOST" hidden>
  <div class="row">
    <div><label>姓名 *</label><input id="zc_post_name" required /></div>
    <div><label>電話 *</label><input id="zc_post_phone" required /></div>
  </div>
  <div class="row">
    <div><label>Email *</label><input id="zc_post_email" type="email" required /></div>
    <div></div>
  </div>
  <div class="row">
    <div><label>郵遞區號 *</label><input id="zc_post_zip" required /></div>
    <div><label>郵寄地址 *</label><input id="zc_post_addr" required /></div>
  </div>
</div>

    </div>
  </div>

  <div class="toolbar">
    <button id="submitBtn" class="btn primary">送出</button>
  </div>
</main>

<script>
/* ===== 設定 ===== */
const API=(window.API_BASE||'https://api.murain.tw').replace(/\/$/,'');
const RATE_TABLE={3:0,6:4.0,9:5.5,12:6.5,18:9.0,24:11.5};
const NEW_DEPOSIT_AMOUNT=1000;

/* ===== 工具 ===== */
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>[...r.querySelectorAll(s)];
const money=n=>'NT$ '+Number(n||0).toLocaleString();
const qs=new URLSearchParams(location.search);
const cartToken=qs.get('cart_token')||'';
const customer=(qs.get('customer')||'old').toLowerCase();   // new | old
const initialMode=(qs.get('mode')||'').toUpperCase();       // COD/PAID/DEPOSIT/ZEROCARD
 const storeSrc =(qs.get('store_src')||'').toLowerCase();    // cod / paid / dep_old / dep_new_p / dep_new_f / zc
const storeId  =qs.get('store_id')  ||'';
const storeName=qs.get('store_name')||'';
const storeAddr=qs.get('store_addr')||'';
function setTotal(v){ $('#subtotal').value=Number(v||0); $('#total').value=money(v||0); }
function required(v){ return v && String(v).trim().length>0; }

/* ===== Tabs ===== */
const tabs=$$('#payTabs .tab');
tabs.forEach(t=>t.addEventListener('click',()=>{
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const k=t.dataset.pay;
  ['COD','PAID','DEPOSIT','ZEROCARD'].forEach(x=>$('#pane'+x).hidden=(x!==k));
  if(k==='DEPOSIT'){ initDepositPane(); }
  if(k==='PAID'){ $('#paid_ship_method').value='711'; updatePaidShip(); }
  if(k==='ZEROCARD'){ $('#zc_ship_method').value='711'; updateZcShip(); calcZC(); }
}));

/* ===== PAID ===== */
$('#paid_channel').addEventListener('change',()=>{
  $('#cardInstBox').hidden = ($('#paid_channel').value!=='card_inst');
});
$('#paid_ship_method').addEventListener('change',updatePaidShip);
function updatePaidShip(){
  const v=$('#paid_ship_method').value;
  $('#paid711').hidden=(v!=='711');
  $('#paidPOST').hidden=(v!=='post');
}

/* ===== DEPOSIT ===== */
function initDepositPane(){
  if(customer==='new'){
    $('#newDeposit').hidden=false;
    $('#oldDeposit').hidden=true;
    $('#dep_new_mode').value='partial';
    updateNewDepositMode();
  }else{
    $('#newDeposit').hidden=true;
    $('#oldDeposit').hidden=false;
    $('#dep_old_ship').value='711';
    updateOldShip();
  }
}
$('#dep_new_mode').addEventListener('change', updateNewDepositMode);
function updateNewDepositMode(){
  const v=$('#dep_new_mode').value;
  $('#dep_new_partial').hidden=(v!=='partial');
  $('#dep_new_full').hidden=(v!=='full');
  if(v==='full'){
    $('#dep_new_full_ship').value='711';
    updateNewFullShip();
  }
}
$('#dep_new_full_ship').addEventListener('change', updateNewFullShip);
function updateNewFullShip(){
  const v=$('#dep_new_full_ship').value;
  $('#dep_new_full_711').hidden=(v!=='711');
  $('#dep_new_full_post').hidden=(v!=='post');
}
$('#dep_old_ship').addEventListener('change', updateOldShip);
function updateOldShip(){
  const v=$('#dep_old_ship').value;
  $('#dep_old_711').hidden=(v!=='711');
  $('#dep_old_post').hidden=(v!=='post');
}

/* ===== ZEROCARD ===== */
$('#zc_months').addEventListener('change',calcZC);
$('#zc_ship_method').addEventListener('change',updateZcShip);
function calcZC(){
  const total=Number($('#subtotal').value||0);
  const m=Number($('#zc_months').value||3);
  const rate=(m===3)?0:(RATE_TABLE[m]||0);
  const gross=Math.round(total*(1+rate/100));
  const per=Math.ceil(gross/m);
  $('#zc_calc').value=`約 NT$ ${per.toLocaleString()} × ${m}（總計 NT$ ${gross.toLocaleString()}）`;
}
function updateZcShip(){
  const v=$('#zc_ship_method').value;
  $('#zc711').hidden=(v!=='711');
  $('#zcPOST').hidden=(v!=='post');
}

// 整頁跳轉版 7-11 地圖
function open711(src, mode){
  const params = new URLSearchParams();
  params.set('src', src);
  if (cartToken) params.set('cart_token', cartToken);
  if (customer)  params.set('customer', customer);
  if (mode)      params.set('mode', mode);
  else if (initialMode) params.set('mode', initialMode);

  location.href = `${API}/cvs/map?${params.toString()}`;
}

// （原本就有的 setFieldValue / normalizeStorePayload / window.addEventListener 可以保留，不用刪）
// 我們多一個：從網址帶回的門市 → 寫進對應欄位
function applyStoreFromQuery(){
  if (!storeSrc || !storeId) return;
  const id = storeId, name = storeName, addr = storeAddr;

  switch (storeSrc) {
    case 'cod':
      setFieldValue('#cod_store_id',   id);
      setFieldValue('#cod_store_name', name);
      setFieldValue('#cod_store_addr', addr);
      break;

    case 'paid':
      $('#paid_ship_method').value='711';
      updatePaidShip();
      setFieldValue('#ship_store_id_paid',   id);
      setFieldValue('#ship_store_name_paid', name);
      setFieldValue('#ship_store_addr_paid', addr);
      break;

    case 'dep_old':
      $('#dep_old_ship').value='711';
      updateOldShip();
      setFieldValue('#dep_old_store_id',   id);
      setFieldValue('#dep_old_store_name', name);
      setFieldValue('#dep_old_store_addr', addr);
      break;

    case 'dep_new_p': // 新客分期訂金（partial，7-11）
      $('#dep_new_mode').value='partial';
      updateNewDepositMode();
      setFieldValue('#dep_new_partial_store_id',   id);
      setFieldValue('#dep_new_partial_store_name', name);
      setFieldValue('#dep_new_partial_store_addr', addr);
      break;

    case 'dep_new_f': // 新客全額匯款（full，7-11）
      $('#dep_new_mode').value='full';
      updateNewDepositMode();
      $('#dep_new_full_ship').value='711';
      updateNewFullShip();
      setFieldValue('#dep_new_full_store_id',   id);
      setFieldValue('#dep_new_full_store_name', name);
      setFieldValue('#dep_new_full_store_addr', addr);
      break;

    case 'zc': // 無卡零角 7-11
      $('#zc_ship_method').value='711';
      updateZcShip();
      setFieldValue('#ship_store_id_zc',   id);
      setFieldValue('#ship_store_name_zc', name);
      setFieldValue('#ship_store_addr_zc', addr);
      break;

    default:
      // 沒有 src 就不動，或你也可以預設回填到 COD
      break;
  }
}

// 綁定所有地圖按鈕（現在多帶一個 mode，讓回來時自動切對的 tab）
$('#mapCOD').addEventListener('click',      ()=>open711('cod','COD'));
$('#mapPAID').addEventListener('click',     ()=>open711('paid','PAID'));
$('#mapDEPOld711').addEventListener('click',()=>open711('dep_old','DEPOSIT'));
$('#mapDEPnewP').addEventListener('click',  ()=>open711('dep_new_p','DEPOSIT'));
$('#mapDEPnewF').addEventListener('click',  ()=>open711('dep_new_f','DEPOSIT'));
$('#mapZC').addEventListener('click',       ()=>open711('zc','ZEROCARD'));

$('#copyBank').addEventListener('click', async()=>{
  try{ await navigator.clipboard.writeText('822 222540458194'); }catch(e){}
});

/* ===== 載入購物車 ===== */
async function loadCart(){
  if(!cartToken){
    alert('缺少 cart_token，請由正確結帳連結進入');
    return;
  }
  try{
    const r=await fetch(`${API}/cart/${cartToken}`);
    const j=await r.json();
    if(!r.ok) throw new Error(j.error||'cart error');
    setTotal(j.total_amount||0);
    const lines=(j.items||[]).map(it=>`• ${it.name||it.sku} × ${it.qty}　NT$ ${Number(it.subtotal||0).toLocaleString()}`);
    $('#itemsBox').textContent=lines.join('\n');
  }catch(e){
    console.error(e);
    alert('讀取購物車失敗，請重試');
  }
}

/* ===== 送出訂單（含無卡零角 → 中租） ===== */
$('#submitBtn').addEventListener('click', async()=>{
  if(!cartToken) return alert('缺少 cart_token');

  const activeTab=document.querySelector('.tab.active')?.dataset.pay || 'COD';
  let payment_method='';
  let ship={};
  const note=$('#note').value || '';

  // COD
  if(activeTab==='COD'){
    const name=$('#cod_name').value;
    const phone=$('#cod_phone').value;
    const email=$('#cod_email').value;
    const id=$('#cod_store_id').value;
    const sname=$('#cod_store_name').value;
    const addr=$('#cod_store_addr').value;
    if(![name,phone,email,id,sname,addr].every(required)){
      return alert('請填完 COD 必填欄位（含 Email）');
    }
    payment_method='cod_711';
    ship={ type:'711', name, phone, email, store:{id,name:sname,addr} };
  }

  // 線上付款
  if(activeTab==='PAID'){
    const channel=$('#paid_channel').value;
    const shipMethod=$('#paid_ship_method').value;
    payment_method=`paid_${channel}`;
    if(channel==='card_inst'){
      payment_method += `_${$('#inst_months').value}`;
    }
    if(shipMethod==='711'){
      const name=$('#ship_name_paid').value;
      const phone=$('#ship_phone_paid').value;
      const email=$('#ship_email_paid').value;
      const id=$('#ship_store_id_paid').value;
      const sname=$('#ship_store_name_paid').value;
      const addr=$('#ship_store_addr_paid').value;
      if(![name,phone,email,id,sname,addr].every(required)){
        return alert('請填完收件資料（含 Email）');
      }
      ship={ type:'711', name, phone, email, store:{id,name:sname,addr} };
    }else{
      const name=$('#paid_post_name').value;
      const phone=$('#paid_post_phone').value;
      const email=$('#paid_post_email').value;
      const zip=$('#paid_post_zip').value;
      const addr=$('#paid_post_addr').value;
      if(![name,phone,email,zip,addr].every(required)){
        return alert('請填完郵寄資料（含 Email）');
      }
      ship={ type:'post', name, phone, email, post:{zip,addr} };
    }
  }

  // ATM 匯款
  if(activeTab==='DEPOSIT'){
    if(customer==='new'){
      const last5=$('#dep_last5_new').value;
      if(!required(last5)) return alert('請填寫匯款後五碼');
      if($('#dep_new_mode').value==='partial'){
        const name=$('#dep_new_partial_name').value;
        const phone=$('#dep_new_partial_phone').value;
        const email=$('#dep_new_partial_email').value;
        const id=$('#dep_new_partial_store_id').value;
        const sname=$('#dep_new_partial_store_name').value;
        const addr=$('#dep_new_partial_store_addr').value;
        if(![name,phone,email,id,sname,addr].every(required)){
          return alert('請填完收件資料（含 Email）');
        }
        payment_method='deposit_partial';
        ship={
          type:'711',
          name,phone,email,
          store:{id,name:sname,addr},
          deposit:{type:'new_partial',last5,amount:NEW_DEPOSIT_AMOUNT}
        };
      }else{
        const fullShip=$('#dep_new_full_ship').value;
        payment_method='deposit_full';
        if(fullShip==='711'){
          const name=$('#dep_new_full_name').value;
          const phone=$('#dep_new_full_phone').value;
          const email=$('#dep_new_full_email').value;
          const id=$('#dep_new_full_store_id').value;
          const sname=$('#dep_new_full_store_name').value;
          const addr=$('#dep_new_full_store_addr').value;
          if(![name,phone,email,id,sname,addr].every(required)){
            return alert('請填完收件資料（含 Email）');
          }
          ship={
            type:'711',
            name,phone,email,
            store:{id,name:sname,addr},
            deposit:{type:'new_full',last5}
          };
        }else{
          const name=$('#dep_new_full_post_name').value;
          const phone=$('#dep_new_full_post_phone').value;
          const email=$('#dep_new_full_post_email').value;
          const zip=$('#dep_new_full_post_zip').value;
          const addr=$('#dep_new_full_post_addr').value;
          if(![name,phone,email,zip,addr].every(required)){
            return alert('請填完郵寄資料（含 Email）');
          }
          ship={
            type:'post',
            name,phone,email,
            post:{zip,addr},
            deposit:{type:'new_full',last5}
          };
        }
      }
    }else{
      const last5=$('#dep_last5_old').value;
      if(!required(last5)) return alert('請填寫匯款後五碼');
      payment_method='deposit_old';
      if($('#dep_old_ship').value==='711'){
        const name=$('#dep_old_name').value;
        const phone=$('#dep_old_phone').value;
        const email=$('#dep_old_email').value;
        const id=$('#dep_old_store_id').value;
        const sname=$('#dep_old_store_name').value;
        const addr=$('#dep_old_store_addr').value;
        if(![name,phone,email,id,sname,addr].every(required)){
          return alert('請填完 7-11 收件資料（含 Email）');
        }
        ship={
          type:'711',
          name,phone,email,
          store:{id,name:sname,addr},
          deposit:{type:'old',last5}
        };
      }else{
        const name=$('#dep_old_post_name').value;
        const phone=$('#dep_old_post_phone').value;
        const email=$('#dep_old_post_email').value;
        const zip=$('#dep_old_post_zip').value;
        const addr=$('#dep_old_post_addr').value;
        if(![name,phone,email,zip,addr].every(required)){
          return alert('請填完郵寄資料（含 Email）');
        }
        ship={
          type:'post',
          name,phone,email,
          post:{zip,addr},
          deposit:{type:'old',last5}
        };
      }
    }
  }

  // 無卡零角
  if(activeTab==='ZEROCARD'){
    const months=$('#zc_months').value;
    payment_method=`zero_card_${months}`;
    if($('#zc_ship_method').value==='711'){
      const name=$('#ship_name_zc').value;
      const phone=$('#ship_phone_zc').value;
      const email=$('#ship_email_zc').value;
      const id=$('#ship_store_id_zc').value;
      const sname=$('#ship_store_name_zc').value;
      const addr=$('#ship_store_addr_zc').value;
      if(![name,phone,email,id,sname,addr].every(required)){
        return alert('請填完 7-11 收件資料（含 Email）');
      }
      ship={ type:'711', name,phone,email, store:{id,name:sname,addr} };
    }else{
      const name=$('#zc_post_name').value;
      const phone=$('#zc_post_phone').value;
      const email=$('#zc_post_email').value;
      const zip=$('#zc_post_zip').value;
      const addr=$('#zc_post_addr').value;
      if(![name,phone,email,zip,addr].every(required)){
        return alert('請填完郵寄資料（含 Email）');
      }
      ship={ type:'post', name,phone,email, post:{zip,addr} };
    }
  }

  if(!payment_method){
    return alert('請先選擇付款方式');
  }

  const shipping_info={
    customer,
    note,
    ship,
    subtotal:Number($('#subtotal').value||0)
  };

  try{
    $('#submitBtn').disabled=true;
    // 1) 先建立訂單
    const r=await fetch(`${API}/checkout`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ cart_token:cartToken, payment_method, shipping_info })
    });
    const j=await r.json();
    if(!r.ok || j.error){
      throw new Error(j.error || `checkout error (${r.status})`);
    }

    // 2) 無卡零角 → 再叫 /zero-card/start 拿中租連結
    if(payment_method.startsWith('zero_card_')){
      try{
        const zr=await fetch(`${API}/zero-card/start`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ order_id:j.order_id })
        });
        const zj=await zr.json();
        if(zr.ok && zj && zj.payment_url){
          location.href=zj.payment_url;
          return;
        }else{
          console.error('ZeroCard start error',zj);
          alert('無卡零角啟動失敗，先回訂單完成頁。');
        }
      }catch(e){
        console.error('ZeroCard start error',e);
        alert('無卡零角連線失敗，先回訂單完成頁。');
      }
    }

    // 3) 其他付款方式 → 直接回完成頁
    const url=`/order-result.html?order_id=${encodeURIComponent(j.order_id)}&total=${encodeURIComponent(j.total_amount)}`;
    try{
      location.href=url;
    }catch(e){
      alert(`下單成功！訂單編號：${j.order_id}`);
    }
  }catch(e){
    console.error(e);
    alert('送出失敗：'+(e && e.message ? e.message : '請稍後再試一次'));
  }finally{
    $('#submitBtn').disabled=false;
  }
});

(async()=>{
  let m = initialMode;
  if (!m) {
    switch (storeSrc) {
      case 'paid':                 m = 'PAID'; break;
      case 'zc':                   m = 'ZEROCARD'; break;
      case 'dep_old':
      case 'dep_new_p':
      case 'dep_new_f':            m = 'DEPOSIT'; break;
      default:                     m = 'COD';
    }
  }

  document.querySelector(`.tab[data-pay="${m}"]`)?.click()
    || document.querySelector('.tab[data-pay="COD"]').click();

  updatePaidShip();
  updateOldShip();
  updateNewFullShip();
  updateZcShip();
  calcZC();

  await loadCart();
  applyStoreFromQuery();
})();

</script>
</body>
</html>
