<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MURAIN — 結帳</title>
  <style>
    body{font-family:system-ui,'Segoe UI',PingFang TC,Microsoft JhengHei,sans-serif;background:#f6f7fb;margin:0}
    .wrap{max-width:720px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.07);padding:18px;margin:16px 0}
    input,select,button{font-size:16px;padding:10px;border:1px solid #ddd;border-radius:10px}
    .btn{background:#111;color:#fff;border:none;padding:10px 16px;border-radius:10px;cursor:pointer}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .mono{font-family:ui-monospace,Consolas,monospace}
    .muted{color:#666}
  </style>
  <script>window.API_BASE="https://api.murain.tw";</script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>結帳資訊</h2>
    <div class="row">
      <select id="pm">
        <option value="bank_transfer">匯款（新客）</option>
        <option value="cod_711">7-11 貨到付款（老客 / 示範）</option>
      </select>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="name" placeholder="收件人姓名" style="flex:1">
      <input id="phone" placeholder="手機" style="flex:1">
    </div>
    <div class="row" style="margin-top:8px">
      <input id="email" placeholder="Email (可留空)" style="flex:1">
    </div>
    <div class="row" style="margin-top:8px">
      <input id="store" placeholder="7-11 門市名（若選 COD） / 郵寄地址（若匯款）" style="flex:1">
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btn_submit">送出訂單</button>
    </div>
    <p class="muted">CartToken：<span id="ct" class="mono"></span></p>
  </div>

  <div class="card" id="done" style="display:none">
    <h2>感謝下單！</h2>
    <p>訂單編號：<span id="oid" class="mono"></span></p>
    <p>金額：<span id="amt" class="mono"></span></p>
  </div>
</div>

<script>
const API = window.API_BASE;
const q = new URLSearchParams(location.search);
const CART = q.get('cart_token')||'';
const PM0 = q.get('pm')||'bank_transfer';
document.getElementById('pm').value = PM0;
document.getElementById('ct').textContent = CART || '(缺少 cart_token)';

document.getElementById('btn_submit').onclick = async () => {
  if(!CART) return alert('缺少 cart token');
  const body = {
    cart_token: CART,
    payment_method: document.getElementById('pm').value,
    shipping_info: {
      name:  document.getElementById('name').value,
      phone: document.getElementById('phone').value,
      email: document.getElementById('email').value,
      store: document.getElementById('store').value
    }
  };
  const r = await fetch(API+'/checkout',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body)});
  if(!r.ok){ const t=await r.text(); return alert(t||'送出失敗'); }
  const d = await r.json();
  document.getElementById('oid').textContent = d.order_id||'';
  document.getElementById('amt').textContent = 'NT$ ' + (d.total_amount||0);
  document.getElementById('done').style.display='';
};
</script>
</body>
</html>
