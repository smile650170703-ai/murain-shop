<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MURAIN - Checkout (自動導向金流)</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;margin:24px;color:#222}
    .card{max-width:820px;margin:0 auto;padding:18px;border:1px solid #eee;border-radius:8px;background:#fff}
    input,select,button,textarea{font-size:14px;padding:8px;margin:6px 0;width:100%;box-sizing:border-box}
    label{font-weight:600;margin-top:8px;display:block}
    pre{background:#f7f7f7;padding:10px;border-radius:6px;overflow:auto}
    .muted{color:#666;font-size:13px}
    .ok{color:green}
    .err{color:#b22222}
  </style>
</head>
<body>
  <div class="card">
    <h2>結帳（自動導向金流）</h2>
    <p class="muted">說明：此頁會呼叫後端 <code>/checkout</code> API（POST {cart_token, payment_method}），
       取得金流回傳的 <code>submit_to</code> 與 <code>fields</code>，然後自動建立隱藏表單並送出給金流（PayUni / ECPay 等）。</p>

    <label>Cart Token（可從建立 cart 的回傳取得）</label>
    <input id="cartToken" placeholder="例如：4ce150d8..." />

    <label>付款方式 (payment_method)</label>
    <select id="paymentMethod">
      <option value="PAYUNI_CREDIT">PAYUNI_CREDIT（信用卡）</option>
      <option value="PAYUNI_CVS">PAYUNI_CVS（超商代碼）</option>
      <option value="ECPAY_CVS">ECPAY_CVS（綠界超取/超商）</option>
      <option value="COD">COD（貨到付款）</option>
    </select>

    <button id="goBtn">開始結帳並自動導向金流</button>
    <div id="status" class="muted" style="margin-top:10px"></div>

    <h3>回傳與備援</h3>
    <p class="muted">若自動導向失敗，下面會顯示後端回傳及一個手動提交表單供你按下。</p>
    <pre id="raw" style="height:160px">尚未呼叫 /checkout</pre>
    <div id="fallback" style="margin-top:10px"></div>
  </div>

  <script>
    // Helper: 建立並提交隱藏表單到金流端
    function postToGateway(submitTo, fields) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = submitTo;
      form.style.display = 'none';
      for (const k of Object.keys(fields || {})) {
        const value = fields[k] === null || fields[k] === undefined ? '' : String(fields[k]);
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = k;
        input.value = value;
        form.appendChild(input);
      }
      document.body.appendChild(form);
      // For debugging: expose form on window if needed
      window._lastGatewayForm = form;
      try {
        form.submit();
      } catch (err) {
        console.error('form.submit() failed', err);
        // leave fallback UI for manual submission
      }
    }

    // Call backend /checkout to get submit_to and fields, then post
    async function doCheckout(cartToken, paymentMethod) {
      const statusEl = document.getElementById('status');
      const rawEl = document.getElementById('raw');
      const fallbackEl = document.getElementById('fallback');
      statusEl.textContent = '呼叫 /checkout ...';
      fallbackEl.innerHTML = '';
      try {
        const res = await fetch('/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cart_token: cartToken, payment_method: paymentMethod })
        });
        const data = await res.json();
        rawEl.textContent = JSON.stringify(data, null, 2);
        if (!res.ok) {
          statusEl.innerHTML = '<span class="err">/checkout 回傳錯誤 (HTTP '+res.status+')</span>';
          return;
        }
        if (data.error) {
          statusEl.innerHTML = '<span class="err">錯誤：'+data.error+'</span>';
          return;
        }
        // Expected shape: { submit_to: 'https://...', fields: { MerID: '...', EncryptInfo: '...', ... }, order_id, total }
        if (data.submit_to && data.fields) {
          statusEl.innerHTML = '<span class="ok">已取得金流參數，準備導向</span>';
          // small delay so user sees message (and to allow devtools to show network)
          setTimeout(() => postToGateway(data.submit_to, data.fields), 300);
          // Also create fallback manual form
          createFallbackForm(fallbackEl, data.submit_to, data.fields);
        } else {
          // Some backends may return fields under data.fields or different structure; show for debugging
          statusEl.innerHTML = '<span class="err">回傳格式非預期，請查看下方 raw 內容</span>';
        }
      } catch (err) {
        console.error(err);
        statusEl.innerHTML = '<span class="err">呼叫 /checkout 發生例外，請查看 console</span>';
        rawEl.textContent = String(err);
      }
    }

    // Create a visible manual form as fallback so user can click Submit if auto fails
    function createFallbackForm(container, submitTo, fields) {
      container.innerHTML = '';
      const note = document.createElement('div');
      note.className = 'muted';
      note.textContent = '備援：若自動導向失敗，請按下下面按鈕手動送出表單到金流。';
      container.appendChild(note);
      const f = document.createElement('form');
      f.method = 'POST';
      f.action = submitTo;
      for (const k of Object.keys(fields || {})) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = k;
        input.value = fields[k] === null || fields[k] === undefined ? '' : String(fields[k]);
        f.appendChild(input);
      }
      const btn = document.createElement('button');
      btn.type = 'submit';
      btn.textContent = '手動送出到金流';
      btn.style.marginTop = '8px';
      f.appendChild(btn);
      container.appendChild(f);
    }

    // Helpers to read token from query params and auto-run
    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    document.getElementById('goBtn').addEventListener('click', () => {
      const cartToken = document.getElementById('cartToken').value.trim();
      const paymentMethod = document.getElementById('paymentMethod').value;
      if (!cartToken) {
        alert('請填入 cart token');
        return;
      }
      doCheckout(cartToken, paymentMethod);
    });

    // Auto-run if cart_token present in URL (e.g., ?cart_token=...&payment_method=PAYUNI_CREDIT)
    window.addEventListener('DOMContentLoaded', () => {
      const qToken = getParam('cart_token') || getParam('token') || getParam('t');
      const qPm = getParam('payment_method') || getParam('pm');
      if (qToken) {
        document.getElementById('cartToken').value = qToken;
        if (qPm) {
          document.getElementById('paymentMethod').value = qPm;
        }
        // small delay to render page then auto-run
        setTimeout(() => {
          document.getElementById('goBtn').click();
        }, 250);
      }
    });
  </script>
</body>
</html>
