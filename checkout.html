<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MURAIN ??çµå¸³ (v6.2)</title>
    <script>
const API_ENDPOINT = 'https://murain-api.smile650170703.workers.dev';
const urlParams = new URLSearchParams(window.location.search);
const CART_TOKEN = urlParams.get('cart_token');
let CURRENT_ORDER = null;

const status = document.getElementById('status');
const checkoutBtn = document.getElementById('checkoutBtn');
const paymentMethodSelect = document.getElementById('payment_method');

// æ¸…é™¤?¯èƒ½?ºç???shipping linkï¼ˆé¿?é?è¤‡æ??¥ï?
function ensureRemoveShippingLink() {
  const old = document.getElementById('shipping-link');
  if (old) old.remove();
}

// è¼‰å…¥è³¼ç‰©è»Šä¸¦?´æ–° UI
async function loadCart() {
  ensureRemoveShippingLink();
  if (!CART_TOKEN) { status.textContent = '?¯èª¤ï¼šæ‰¾ä¸åˆ°è³¼ç‰©è»?(cart_token)'; checkoutBtn.disabled = true; return; }
  try {
    const res = await fetch(`${API_ENDPOINT}/cart/${CART_TOKEN}`);
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    CURRENT_ORDER = data;
    console.log('[loadCart] cart', data);

    const itemsDiv = document.getElementById('cart-items');
    const totalDiv = document.getElementById('cart-total');
    itemsDiv.innerHTML = '';
    totalDiv.textContent = `ç¸½è?ï¼?${data.total_amount || 0}`;

    const hasItems = Array.isArray(data.items) && data.items.length > 0;
    if (!hasItems) {
      itemsDiv.innerHTML = '<p>?¨ç?è³¼ç‰©è»Šæ˜¯ç©ºç?</p>';
    } else {
      data.items.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'cart-item';
        itemEl.innerHTML = `
          <span>${item.name}</span>
          <span>${item.qty} x $${item.unit_price_final}</span>
          <span style="text-align:right;">$${item.subtotal}</span>
        `;
        itemsDiv.appendChild(itemEl);
      });
    }

    // ?¹æ??€?‹æ±ºå®šæ??•è?ä»˜æ¬¾æ¬„ä??¯å¦?¯ç”¨
    updateUIState(data.status, hasItems);
  } catch (e) {
    console.error('[loadCart error]', e);
    status.textContent = 'è¼‰å…¥è³¼ç‰©è»Šå¤±?? ' + (e.message || e);
    checkoutBtn.disabled = true;
  }
}

// ?´æ–°?‰é?/æ¬„ä??€?‹ç?çµ±ä??½å?
function updateUIState(orderStatus, hasItems) {
  // ?¢å¾©?è¨­é¡¯ç¤º
  paymentMethodSelect.classList.remove('hidden');
  const paymentLabel = document.querySelector('label[for="payment_method"]');
  if (paymentLabel) paymentLabel.classList.remove('hidden');
  ensureRemoveShippingLink();

  const s = String(orderStatus || '').toLowerCase();
  status.textContent = ''; // ?ˆæ?ç©?

  // ?è¨­ï¼šè‹¥?‰å??ä??€?‹å?è¨±ï??‰é??¯æ?
  let allowCheckout = hasItems && (s === 'draft' || s === 'pending' || s === 'awaiting_deposit_proof');

  // ?¹æ??€?‹è???
  if (s === 'awaiting_deposit_proof') {
    // è¨‚é??®ï??±è?ä»˜æ¬¾?¸é?ï¼Œä??¯ä»¥?‰ä?ä¸€æ­?å¡«ç‰©æµ?
    status.textContent = '?€?‹ï??°å®¢è¨‚é??®ï?ç¢ºè??†å??¡èª¤å¾Œè??‰ä?ä¸€æ­¥å¡«å¯«ç‰©æµ?;
    checkoutBtn.textContent = 'ä¸‹ä?æ­¥ï?å¡«å¯«?©æ? (è¨‚é???';
    paymentMethodSelect.classList.add('hidden');
    if (paymentLabel) paymentLabel.classList.add('hidden');
    allowCheckout = true;
  } else if (s === 'awaiting_shipping_info') {
    // å·²ä?æ¬¾ä?å°šæœªå¡«ç‰©æµï?é¡¯ç¤º?å?å¡«å¯«?©æ????ä¸¦é?å®šä?ä¸€æ­?
    status.textContent = '?€?‹ï?å·²ä?æ¬¾ï?è«‹å?å¾€å¡«å¯«?©æ?è³‡è?';
    const link = document.createElement('a');
    link.id = 'shipping-link';
    link.href = `shipping.html?cart_token=${CART_TOKEN}&method=PAID`;
    link.textContent = '???å?å¡«å¯«?©æ?è³‡è?';
    link.style.display = 'block';
    link.style.textAlign = 'center';
    link.style.marginTop = '8px';
    status.insertAdjacentElement('afterend', link);
    allowCheckout = false;
  } else if (['cancelled','expired','deleted','shipped'].includes(s)) {
    status.textContent = `æ­¤è??®å·²?¡æ??ä? (?€?? ${orderStatus})`;
    allowCheckout = false;
  } else {
    // draft / pending ç­‰æ?æ³ï??è¨­è¨Šæ¯
    if (s === 'pending') status.textContent = '?€?‹ï?ç­‰å?ä»˜æ¬¾ï¼Œè??¸æ?ä»˜æ¬¾?¹å?ä¸¦æ?ä¸‹ä?æ­?;
    if (s === 'draft') status.textContent = '?€?‹ï??‰ç¨¿ï¼Œæ‚¨?¯å??¥å??å??ç?å¸?;
    // allowCheckout ä¿æ??¹æ? hasItems æ±ºå?
  }

  // ?€å¾Œè¨­å®šæ??•æ˜¯?¦å¯??
  checkoutBtn.disabled = !allowCheckout;
  // ?¥æ??‰å??ï?ä¸å¯çµå¸³
  if (!hasItems) checkoutBtn.disabled = true;
}

// API helperï¼ˆPOSTï¼?
async function apiPost(endpoint, body) {
  const res = await fetch(`${API_ENDPOINT}${endpoint}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  let data;
  try { data = await res.json(); } catch(e) { data = { error: `ä¼ºæ??¨éŒ¯èª? ${res.status}` }; }
  if (data && data.error) throw new Error(data.error);
  return data;
}

// ?å‡ºè¡¨å–®
function submitForm(actionUrl, fields) {
  const form = document.getElementById('paymentForm');
  form.action = actionUrl;
  form.method = 'POST';
  form.innerHTML = '';
  for (const key in fields) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = key;
    input.value = fields[key];
    form.appendChild(input);
  }
  form.submit();
}

// checkout ?‰é?è¡Œç‚º
checkoutBtn.addEventListener('click', async () => {
  // ?¥æ??•è¢«?–å?ï¼Œç›´?¥è·³??
  if (checkoutBtn.disabled) return;

  let payment_method = paymentMethodSelect.value;
  if (CURRENT_ORDER && String(CURRENT_ORDER.status).toLowerCase() === 'awaiting_deposit_proof') {
    payment_method = 'DEPOSIT_COD';
  }

  if (!payment_method) {
    // å°æ–¼è¨‚é??®æ??‘å·²ç¶“è?å¯?payment_methodï¼Œä??¢å·²?•ç?
    status.textContent = 'è«‹é¸?‡ä?æ¬¾æ–¹å¼?;
    return;
  }

  checkoutBtn.disabled = true;
  status.textContent = 'å»ºç?è¨‚å–®ä¸?..';

  try {
    if (payment_method === 'COD') {
      window.location.href = `shipping.html?cart_token=${CART_TOKEN}&method=COD`;
      return;
    } else if (payment_method === 'DEPOSIT_COD') {
      window.location.href = `shipping.html?cart_token=${CART_TOKEN}&method=DEPOSIT`;
      return;
    }

    const data = await apiPost('/checkout', { cart_token: CART_TOKEN, payment_method: payment_method });
    console.log('[checkout] response', data);

    if (data.submit_to && data.fields) {
      submitForm(data.submit_to, data.fields);
    } else if (data.submit_to && typeof data.submit_to === 'string') {
      // ä¾‹å?èªè??¯ä??´æ¥?å‚³ url
      window.location.href = data.submit_to;
    } else {
      // ?¥æ??‰é??Ÿæ?ä½ï?é¡¯ç¤ºè¨Šæ¯ä¸¦æ”¾è¡Œæ???
      status.textContent = 'ä¼ºæ??¨å??‰ç•°å¸¸ï??¡æ??²è?çµå¸³';
      checkoutBtn.disabled = false;
    }
  } catch (e) {
    console.error('[checkout error]', e);
    status.textContent = 'çµå¸³å¤±æ?: ' + (e.message || e);
    checkoutBtn.disabled = false;
  }
});

// ?å??–è???
document.addEventListener('DOMContentLoaded', () => {
  loadCart();
  // ?¥ä??³è‡ª?•æ›´?°è³¼?©è?ï¼ˆä?å¦‚åº«å­˜è??–ï?ï¼Œå¯?Ÿç”¨ä¸‹é¢?„å??Ÿæ›´??
  // setInterval(loadCart, 10000);
});
</script>

</head>
<body>
    <div class="container">
        <h2>çµå¸³</h2>
        <div id="cart-items">
            </div>
        <div class="total" id="cart-total">
            ç¸½è?ï¼?0
        </div>
        
        <hr style="margin: 2rem 0;">

        <div class="form-group">
            <label for="payment_method">ä»˜æ¬¾?¹å?</label>
            <select id="payment_method">
                <option value="">??è«‹é¸????/option>
                <option value="PAYUNI_ATM">?€è¡ŒåŒ¯æ¬?(?›æ“¬å¸³è??ªå?å°å¸³)</option>
                <option value="COD">7-11 è²¨åˆ°ä»˜æ¬¾ (ä¸€?¬å®¢??</option>
                <option value="PAYUNI_CREDIT">PAYUNi ä¿¡ç”¨??(ä¸€æ¬¡ä?æ¸?</option>
                <option value="PAYUNI_CREDIT_INST">PAYUNi ä¿¡ç”¨??(3/6/9 ??</option>
                <option value="LANGUAGE_INST">?¶è? ä¿¡ç”¨??(3 ??</option>
            </select>
        </div>

        <button id="checkoutBtn">ä¸‹ä?æ­¥ï?å¡«å¯«?©æ?</button>
        <p id="status"></p>

        </div>

    <form id="paymentForm" method="POST" class="hidden"></form>

    <script>
        const API_ENDPOINT = 'https://murain-api.smile650170703.workers.dev';
        const urlParams = new URLSearchParams(window.location.search);
        const CART_TOKEN = urlParams.get('cart_token');
        let CURRENT_ORDER = null;

        const status = document.getElementById('status');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const paymentMethodSelect = document.getElementById('payment_method');
        // (PATCH) ç§»é™¤ bankInfoBox, goToShippingBtn

        // --- 1. è¼‰å…¥è³¼ç‰©è»?---
        async function loadCart() {
            if (!CART_TOKEN) { status.textContent = '?¯èª¤ï¼šæ‰¾ä¸åˆ°è³¼ç‰©è»?; return; }
            try {
                const res = await fetch(`${API_ENDPOINT}/cart/${CART_TOKEN}`);
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                
                CURRENT_ORDER = data;
                const itemsDiv = document.getElementById('cart-items');
                const totalDiv = document.getElementById('cart-total');
                itemsDiv.innerHTML = '';
                
                if (data.items.length === 0) {
                    itemsDiv.innerHTML = '<p>?¨ç?è³¼ç‰©è»Šæ˜¯ç©ºç?</p>';
                    checkoutBtn.disabled = true;
                }
                
                data.items.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'cart-item';
                    itemEl.innerHTML = `
                        <span>${item.name}</span>
                        <span>${item.qty} x $${item.unit_price_final}</span>
                        <span style="text-align:right;">$${item.subtotal}</span>
                    `;
                    itemsDiv.appendChild(itemEl);
                });
                
                totalDiv.textContent = `ç¸½è?ï¼?${data.total_amount}`;
                
                // (v6) Q1/Q5: æª¢æŸ¥è¨‚å–®?€??
                handleStatus(data.status);
                
            } catch (e) {
                status.textContent = 'è¼‰å…¥è³¼ç‰©è»Šå¤±?? ' + e.message;
            }
        }
        
        // (v6) Q1/Q5: ?•ç?è¨‚å–®?€??
        function handleStatus(orderStatus) {
            // (v6.1) Q5: å¦‚æ??¯æ–°å®¢è??‘ï??±è??¸é?
            if (orderStatus === 'awaiting_deposit_proof') {
                status.textContent = '?€?‹ï??°å®¢è¨‚é??®ï?ç¢ºè??†å??¡èª¤å¾Œè??‰ä?ä¸€æ­?;
                paymentMethodSelect.classList.add('hidden');
                document.querySelector('label[for="payment_method"]').classList.add('hidden');
                checkoutBtn.textContent = 'ä¸‹ä?æ­¥ï?å¡«å¯«?©æ? (è¨‚é???';
            }
            // (PATCH) ç§»é™¤ awaiting_payment (?‹å??¯æ¬¾) ?„é?è¼?
            else if (orderStatus === 'awaiting_shipping_info') {
                status.textContent = '?€?‹ï?å·²ä?æ¬¾ï?ç­‰å?å¡«å¯«?©æ?';
                checkoutBtn.disabled = true;
                paymentMethodSelect.disabled = true;
                // (PATCH) ç§»é™¤ bankInfoBox
                const link = document.createElement('a');
                link.href = `shipping.html?cart_token=${CART_TOKEN}&method=PAID`;
                link.textContent = '???å?å¡«å¯«?©æ?è³‡è?';
                link.style.display = 'block';
                link.style.textAlign = 'center';
                status.insertAdjacentElement('afterend', link);
            } else if (orderStatus !== 'pending' && orderStatus !== 'draft') {
                status.textContent = `æ­¤è??®å·²å®Œæ??–å·²å¤±æ? (?€?? ${orderStatus})ï¼Œç„¡æ³•ç?å¸³ã€‚`;
                checkoutBtn.disabled = true;
                paymentMethodSelect.disabled = true;
            }
        }

        // --- 2. çµå¸³?‰é? ---
        checkoutBtn.addEventListener('click', async () => {
            let payment_method = paymentMethodSelect.value;
            
            // (v6.1) Q5: ?°å®¢è¨‚é??®ï?ä»˜æ¬¾?¹å??ºå?
            if (CURRENT_ORDER && CURRENT_ORDER.status === 'awaiting_deposit_proof') {
                payment_method = 'DEPOSIT_COD';
            }

            if (!payment_method) {
                status.textContent = 'è«‹é¸?‡ä?æ¬¾æ–¹å¼?;
                return;
            }

            checkoutBtn.disabled = true;
            status.textContent = 'å»ºç?è¨‚å–®ä¸?..';

            try {
                // (PATCH) ?€è¡ŒåŒ¯æ¬?COD) ???°å®¢(DEPOSIT_COD) ?´æ¥è·³è?
                if (payment_method === 'COD') {
                    window.location.href = `shipping.html?cart_token=${CART_TOKEN}&method=COD`;
                    return;
                }
                else if (payment_method === 'DEPOSIT_COD') {
                    window.location.href = `shipping.html?cart_token=${CART_TOKEN}&method=DEPOSIT`;
                    return;
                }

                // (PATCH) ?¶ä? (PAYUNI_ATM, PAYUNI_CREDIT, LANGUAGE) ?¨éƒ¨èµ?/checkout API
                const data = await apiPost('/checkout', { cart_token: CART_TOKEN, payment_method: payment_method });
                
                if (data.submit_to && data.fields) { // PAYUNi
                    submitForm(data.submit_to, data.fields);
                } 
                else if (data.submit_to) { // L IN G UAGE
                    window.location.href = data.submit_to;
                }
            } catch (e) {
                status.textContent = 'çµå¸³å¤±æ?: ' + e.message;
                checkoutBtn.disabled = false;
            }
        });
        
        // (PATCH) ç§»é™¤ goToShippingBtn ?„ç›£?½å™¨

        // --- 3. è¼”åŠ©?½æ•¸ ---
        async function apiPost(endpoint, body) {
            const res = await fetch(`${API_ENDPOINT}${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            // (PATCH) å¢å¼·?¯èª¤?•ç?
            let data;
            try { data = await res.json(); } catch(e) { data = { error: `ä¼ºæ??¨éŒ¯èª? ${res.status}` }}
            if (data.error) throw new Error(data.error);
            return data;
        }

        function submitForm(actionUrl, fields) {
            const form = document.getElementById('paymentForm');
            form.action = actionUrl;
            form.innerHTML = '';
            for (const key in fields) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = fields[key];
                form.appendChild(input);
            }
            form.submit();
        }

        loadCart();
    </script>
</body>
</html>
