<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>列印小白單</title>
  <script>window.API_BASE="https://murain.tw/api";</script>
  <style>
    @page { size: 80mm auto; margin: 5mm; }
    body{font-family:ui-monospace,Consolas,monospace}
    h2{margin:0 0 8px 0}
    table{width:100%;border-collapse:collapse}
    td{padding:2px 0}
    .right{text-align:right}
    .muted{color:#666}
  </style>
</head>
<body>
<div id="root">Loading...</div>
<script>
const API=(window.API_BASE||'').replace(/\/+$/,'');
const params=new URLSearchParams(location.search);
const order_id=params.get('order_id'); const key=params.get('key');

(async ()=>{
  if(!order_id){ document.getElementById('root').textContent='缺少 order_id'; return; }
  const r = await fetch(API + '/admin/order/' + encodeURIComponent(order_id), { headers:{'Authorization':'Bearer '+key} });
  const d = await r.json();
  if(!r.ok){ document.getElementById('root').textContent = JSON.stringify(d); return; }
  const info = d.shipping_info || {};
  const rows = (d.items||[]).map(i=>`<tr><td>${i.sku}</td><td>${i.name}</td><td class="right">${i.qty} x ${i.price}</td></tr>`).join('');
  document.getElementById('root').innerHTML = `
    <h2>訂單 ${d.order_id}</h2>
    <div>姓名：${info.name||''}</div>
    <div>電話：${info.phone||''}</div>
    <div>地址/門市：${info.store||info.address||''}</div>
    <div class="muted">${(info.note||'').replace(/\\n/g,'<br>')}</div>
    <hr>
    <table>${rows}</table>
    <hr>
    <div class="right">總額：NT$ ${d.total_amount||0}</div>
  `;
  setTimeout(()=>{ window.print(); }, 300);
})();
</script>
</body>
</html>
