<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>XUYUAN | 尾款結帳</title>
  
  <!-- 引入品牌字體 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

  <style>
    /* --- 核心變數 --- */
    :root {
      --bg-color: #050505;
      --card-bg: #111;
      --input-bg: #1a1a1a;
      --text-main: #fff;
      --text-muted: #888;
      --gold-primary: #D4AF37; 
      --gold-light: #F3E5AB;
      --border-color: rgba(255, 255, 255, 0.1);
      --danger: #ef4444;
      --font-serif: 'Playfair Display', serif;
      --font-sans: 'Lato', sans-serif;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      padding-bottom: calc(100px + env(safe-area-inset-bottom));
    }

    .wrap {
      max-width: 640px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    /* --- Header --- */
    .header {
      text-align: center;
      margin-bottom: 40px;
    }
    .brand {
      font-family: var(--font-serif);
      font-size: 24px;
      letter-spacing: 0.15em;
      color: var(--gold-primary);
      margin-bottom: 4px;
    }
    .page-title {
      font-size: 11px;
      letter-spacing: 0.2em;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    /* --- 卡片通用 --- */
    .card {
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 24px;
    }
    .card-header {
      font-size: 12px;
      letter-spacing: 0.1em;
      color: var(--gold-primary);
      text-transform: uppercase;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .badge {
      font-size: 10px; color: var(--text-muted); border: 1px solid var(--border-color);
      padding: 2px 6px; border-radius: 99em; letter-spacing: 0;
    }

    /* --- 表單 --- */
    label {
      display: block; font-size: 12px; color: #666; margin-bottom: 4px; margin-top: 12px;
    }
    label:first-child { margin-top: 0; }

    input, select, textarea {
      width: 100%; padding: 12px;
      border-radius: 2px; border: 1px solid var(--border-color);
      background: var(--input-bg); color: #fff;
      font-family: var(--font-sans); font-size: 14px;
      -webkit-appearance: none;
    }
    /* 唯讀輸入框：做成文字顯示 */
    input[readonly], textarea[readonly] {
      background: transparent; border: none; padding: 0;
      color: #eee; font-family: var(--font-serif); font-size: 15px; letter-spacing: 0.03em;
      pointer-events: none;
    }
    textarea[readonly] {
      font-family: var(--font-sans); font-size: 13px; color: #aaa; line-height: 1.5; resize: none; min-height: auto;
    }

    .row { display: flex; gap: 20px; }
    .row > * { flex: 1; }

    /* --- 尾款金額顯示 --- */
    .money-big {
      font-family: var(--font-serif); font-size: 28px; color: var(--gold-light);
      text-align: right; margin-top: 4px;
    }
    .flex-between { display: flex; justify-content: space-between; align-items: baseline; }

    /* --- 寄送資訊 --- */
    #shipInfoBox {
      font-size: 13px; color: #ccc; line-height: 1.6; font-family: monospace;
    }

    /* --- 付款方式 Tabs (Pill) --- */
    .pill-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
    .pill {
      flex: 1; min-width: 100px;
      background: transparent; border: 1px solid var(--border-color);
      color: var(--text-muted); padding: 10px; text-align: center;
      font-size: 12px; cursor: pointer; transition: all 0.3s;
    }
    .pill.active {
      border-color: var(--gold-primary); color: var(--gold-primary); background: rgba(212, 175, 55, 0.05);
    }
    .pill span.small { display: block; font-size: 10px; opacity: 0.7; margin-top: 2px; transform: scale(0.9); }

    .pay-pane { display: none; margin-top: 16px; animation: fadeIn 0.3s ease; }
    .pay-pane.active { display: block; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }

    /* --- 按鈕 --- */
    .btn-secondary {
      display: inline-block; padding: 8px 16px; border: 1px solid var(--border-color);
      background: transparent; color: var(--text-muted); font-size: 12px; cursor: pointer;
      margin-right: 8px; margin-bottom: 8px; transition: 0.2s;
    }
    .btn-secondary.active-paid {
      border-color: var(--gold-primary); color: var(--gold-primary);
    }
    .btn-sm { padding: 4px 8px; font-size: 10px; margin-left: 8px; }

    .btn-primary {
      width: 100%; padding: 14px;
      background: var(--gold-primary); color: #000;
      border: none; border-radius: 2px;
      font-size: 14px; font-weight: 700; letter-spacing: 0.1em;
      text-transform: uppercase; cursor: pointer; margin-top: 30px;
    }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

    /* --- 其他 --- */
    .hint { font-size: 12px; color: var(--text-muted); line-height: 1.5; margin-top: 8px; }
    .danger { color: var(--danger); font-size: 12px; margin-bottom: 16px; border: 1px solid var(--danger); padding: 10px; }
    .pill-inline { color: #fff; font-family: monospace; }
    .muted { color: #666; font-size: 11px; margin-top: 8px; text-align: center; }

  </style>
  <script>window.API_BASE = "https://api.murain.tw";</script>
</head>
<body>

<div class="wrap">
  
  <div class="header">
    <div class="brand">XUYUAN</div>
    <div class="page-title">尾款結帳</div>
  </div>

  <div id="errorBox" class="danger" style="display:none"></div>

  <!-- 1. 原訂單資訊 -->
  <div class="card">
    <div class="card-header">
      原訂單資訊
      <span class="badge">訂金紀錄</span>
    </div>

    <div class="row">
      <div>
        <label>訂單編號</label>
        <input id="fieldOrderId" readonly />
      </div>
      <div>
        <label>訂單總額</label>
        <input id="fieldTotal" readonly />
      </div>
    </div>

    <div class="row">
      <div>
        <label>已付訂金</label>
        <input id="fieldDeposit" readonly style="color:var(--gold-light);" />
      </div>
      <div>
        <label>保留期限</label>
        <input id="fieldHoldUntil" readonly />
      </div>
    </div>

    <div style="margin-top:16px;">
      <label>商品摘要</label>
      <textarea id="fieldItems" rows="2" readonly></textarea>
    </div>
  </div>

  <!-- 2. 寄送資訊 -->
  <div class="card">
    <div class="card-header">
      收件資訊
      <span class="badge">同原訂單</span>
    </div>
    <div id="shipInfoBox">
      <div id="shipName"></div>
      <div id="shipPhone"></div>
      <div id="shipAddr"></div>
      <div id="shipStore"></div>
    </div>
  </div>

  <!-- 3. 尾款金額 -->
  <div class="card" style="border-color:var(--gold-primary);">
    <div class="flex-between">
      <div style="font-size:12px;letter-spacing:0.1em;color:var(--gold-primary);">剩餘尾款</div>
      <div style="font-size:10px;color:#666;">( 總金額 - 已付訂金 )</div>
    </div>
    <div id="tailAmountView" class="money-big">NT$ 0</div>
  </div>

  <!-- ✅ 3-1. 購物金折抵（共用，不影響任何付款流程） -->
  <div class="card">
    <div class="card-header">
      購物金折抵
      <span class="badge">可選</span>
    </div>

    <label>本次折抵金額</label>
    <input id="creditUsed" type="number" min="0" step="1" value="0" inputmode="numeric" placeholder="0" />
    <div class="hint">* 線上付款 / 無卡分期 需至少支付 1 元（折抵不可 ≥ 尾款）。</div>
  </div>

  <!-- 4. 付款方式 -->
  <div class="card">
    <div class="card-header">付款方式</div>

    <div class="pill-bar" id="payTabs">
      <button type="button" class="pill active" data-pay="COD">7-11 貨到付款</button>
      <button type="button" class="pill" data-pay="PAID">線上付款<span class="small">Card / LINE Pay</span></button>
      <button type="button" class="pill" data-pay="ATM">ATM 匯款</button>
      <button type="button" class="pill" data-pay="ZEROCARD">無卡分期</button>
    </div>

    <!-- COD -->
    <div class="pay-pane active" id="paneCOD">
      <div class="hint">
        尾款將在您到 7-11 取貨時一次收取。<br>
        <span style="opacity:0.6">* 系統將沿用原訂單設定的 7-11 門市。</span>
      </div>
    </div>

    <!-- PAID -->
    <div class="pay-pane" id="panePAID">
      <label>選擇管道</label>
      <div style="margin-top:8px;">
        <button type="button" class="btn-secondary" data-paid="card_once">信用卡一次付清</button>
        <button type="button" class="btn-secondary" data-paid="card_inst">信用卡分期</button>
        <button type="button" class="btn-secondary" data-paid="linepay">LINE Pay</button>
        <button type="button" class="btn-secondary" data-paid="af">AFTEE</button>
      </div>

      <div id="instBox" style="display:none; margin-top:12px;">
        <label>分期期數</label>
        <select id="instMonths">
          <option value="3">3 期 (0 利率)</option>
          <option value="6">6 期 (0 利率)</option>
          <option value="9">9 期 (0 利率)</option>
        </select>
      </div>
    </div>

    <!-- ATM -->
    <div class="pay-pane" id="paneATM">
      <div class="hint">請匯款全額至以下帳戶：</div>
      <div style="background:#111; padding:12px; margin-top:8px; border:1px dashed #444;">
        <div style="font-size:12px; color:#aaa;">郵局 (700)</div>
        <div style="font-size:16px; color:#fff; font-family:monospace; margin-top:4px;">
          <span id="atmAccount">01912890973712</span>
          <button type="button" class="btn-secondary btn-sm" id="btnCopyAtm">複製</button>
        </div>
      </div>
      
      <label>您的帳號後五碼 *</label>
      <input id="atmLast5" type="text" maxlength="5" inputmode="numeric" placeholder="12345" />
    </div>

    <!-- ZEROCARD -->
    <div class="pay-pane" id="paneZEROCARD">
      <label>分期期數</label>
      <select id="zcMonths">
        <option value="3">3 期 (0 利率)</option>
        <option value="6">6 期</option>
        <option value="9">9 期</option>
        <option value="12">12 期</option>
        <option value="18">18 期</option>
        <option value="24">24 期</option>
      </select>
      <div class="hint">* 實際每期金額以中租審核為準。</div>
    </div>

    <button id="submitBtn" class="btn-primary">確認送出尾款</button>
    <div class="muted">安全加密結帳系統</div>
  </div>

</div>

<script>
(function(){
  const API = window.API_BASE || "https://api.murain.tw";
  const $ = s => document.querySelector(s);

  let tailInfo = null;
  let activePay = "COD";
  let paidChannel = "card_once";

  function setError(msg){
    const box = $("#errorBox");
    if(!msg){ box.style.display="none"; box.textContent=""; return; }
    box.textContent = msg;
    box.style.display = "block";
  }

  function money(n){ return "NT$ " + (Number(n)||0).toLocaleString("zh-TW"); }

  function initTabs(){
    const tabs = document.querySelectorAll(".pill");
    tabs.forEach(tab=>{
      tab.addEventListener("click", ()=>{
        tabs.forEach(t=>t.classList.remove("active"));
        tab.classList.add("active");
        activePay = tab.dataset.pay;
        document.querySelectorAll(".pay-pane").forEach(p=>p.classList.remove("active"));
        $("#pane"+activePay).classList.add("active");
      });
    });

    document.querySelectorAll("[data-paid]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll("[data-paid]").forEach(b=>b.classList.remove("active-paid"));
        btn.classList.add("active-paid");
        paidChannel = btn.dataset.paid || "card_once";
        $("#instBox").style.display = (paidChannel==="card_inst") ? "block" : "none";
      });
    });
  }

  async function loadTailInfo(){
    const sp = new URLSearchParams(location.search);
    const orderId = sp.get("order_id") || sp.get("parent_order_id") || "";
    if(!orderId) return setError("缺少訂單編號");

    try{
      const r = await fetch(`${API}/tail/info?order_id=${encodeURIComponent(orderId)}`);
      const j = await r.json();
      if(!r.ok || !j.ok) return setError(j.message || j.error || "讀取失敗");

      tailInfo = j;
      $("#fieldOrderId").value = j.parent_order_id || orderId;
      $("#fieldTotal").value   = money(j.total_amount || 0);
      $("#fieldDeposit").value = money(j.deposit_amount || 0);
      $("#tailAmountView").textContent = money(j.tail_amount || 0);
      
// ✅（可選但安全）限制購物金輸入不超過尾款
const cuEl = document.getElementById("creditUsed");
if (cuEl) cuEl.max = String(Math.max(0, Math.round(Number(j.tail_amount||0)||0)));
      
      $("#fieldHoldUntil").value = (j.shipping_info && j.shipping_info.hold_until) || (j.hold_until || "");
      $("#fieldItems").value = j.items_text || "";

      const ship = (j.shipping_info && j.shipping_info.ship) || {};
      const store = ship.store || {};
      
      if($("#shipName")) $("#shipName").textContent = ship.name ? `姓名: ${ship.name}` : "";
      if($("#shipPhone")) $("#shipPhone").textContent = ship.phone ? `電話: ${ship.phone}` : "";
      if($("#shipAddr")) $("#shipAddr").textContent = store.addr ? `地址: ${store.addr}` : "";
      if($("#shipStore")) $("#shipStore").textContent = store.name ? `門市: ${store.name} (${store.id||''})` : "";

      // Logic: Hide COD if original was not 7-11
      if(ship.type !== "711") {
        const codTab = document.querySelector('.pill[data-pay="COD"]');
        if(codTab) codTab.style.display = "none";
        if(activePay === "COD") {
          activePay = "PAID";
          document.querySelector('.pill[data-pay="PAID"]')?.click();
        }
      }
    }catch(e){ setError("系統錯誤"); }
  }

  async function submitTail(){
  if(!tailInfo) return alert("資料尚未載入");

  const tailAmount = Math.round(Number(tailInfo.tail_amount || 0) || 0);
  if(tailAmount <= 0 && !confirm("尾款金額為 0，是否繼續？")) return;

  // ✅ 讀取本次折抵（若頁面還沒加 input，就當 0）
  const cuEl = document.getElementById("creditUsed");
  let credit_used = cuEl ? Math.floor(Math.max(0, Number(cuEl.value || 0) || 0)) : 0;

  // ✅ 從 shipping_info 抓 line_user_id（後端扣購物金用）
  let line_user_id = "";
  try{
    const si = tailInfo.shipping_info || {};
    const shipInfo = (typeof si === "string") ? JSON.parse(si) : si;
    const line = shipInfo.line || shipInfo.line_profile || {};
    line_user_id = String(
      line.user_id || line.userId || line.LINE_USER_ID || shipInfo.line_user_id || ""
    ).trim();
  }catch(e){ line_user_id = ""; }

  // ✅ 線上支付 / 零卡：必須至少付 1 元（避免 0 元金流）
  // （COD/ATM 你要允許全折抵也可以；這裡只擋線上金流）
  const willPayOnline = (activePay === "PAID" || activePay === "ZEROCARD");
  if (willPayOnline && tailAmount > 0 && credit_used >= tailAmount) {
    return alert("線上支付需至少支付 1 元（購物金折抵不能 >= 尾款金額）");
  }

  let payment_method = "";
  const extra = {};

  if(activePay === "COD") payment_method = "cod_711";
  else if(activePay === "PAID") {
    payment_method = (paidChannel==="card_inst")
      ? `paid_card_inst_${$("#instMonths").value}`
      : `paid_${paidChannel}`;
  }
  else if(activePay === "ATM") {
    const last5 = ($("#atmLast5").value||"").trim();
    if(!/^\d{5}$/.test(last5)) return alert("請輸入 5 位數帳號後五碼");
    payment_method = "atm_full_tail";
    extra.atm_last5 = last5;
  }
  else if(activePay === "ZEROCARD") {
    payment_method = `zero_card_${$("#zcMonths").value}`;
  }

  if(!payment_method) return alert("請選擇付款方式");

  try{
    $("#submitBtn").disabled = true;

    // ✅ items_json 加上「原訂單」前綴（後端可用來防重複建單）
    const prefix = `【原訂單 ${tailInfo.parent_order_id}】\n`;
    const baseItems = String(tailInfo.items_text || "");
    const items_json = baseItems.startsWith(prefix) ? baseItems : (prefix + baseItems);

    const payload = {
      parent_order_id: tailInfo.parent_order_id,
      items_json,
      tail_amount: tailAmount,
      payment_method,
      shipping_info: tailInfo.shipping_info || {},

      // ✅ 新增：尾款折抵購物金
      credit_used,
      line_user_id
    };
    if(extra.atm_last5) payload.atm_last5 = extra.atm_last5;

    const r = await fetch(`${API}/tail/checkout`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    if(!r.ok || !j.ok) throw new Error(j.message || j.error);

    const newOrderId = j.order_id;

    // Redirects
    if(payment_method.startsWith("paid_")){
      const pr = await fetch(`${API}/payuni/start`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ order_id: newOrderId })
      });
      const up = await pr.json();
      if(!up.ok) throw new Error(up.error);

      const f = document.createElement("form");
      f.method="POST";
      f.action=up.url;
      ["MerID","Version","EncryptInfo","HashInfo"].forEach(k=>{
        const i=document.createElement("input");
        i.type="hidden"; i.name=k; i.value=up[k];
        f.appendChild(i);
      });
      document.body.appendChild(f);
      f.submit();
      return;
    }

    if(payment_method.startsWith("zero_card_")){
      const zr = await fetch(`${API}/zero-card/start`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ order_id: newOrderId })
      });
      const zj = await zr.json();
      if(!zj.ok) throw new Error(zj.error);
      location.href = zj.payment_url;
      return;
    }

    alert("尾款訂單已建立！");
    location.href = `/order-result.html?order_id=${encodeURIComponent(newOrderId)}&from=tail`;

  }catch(e){
    alert(e.message || "發生錯誤");
    $("#submitBtn").disabled = false;
  }
}

  document.addEventListener("DOMContentLoaded", ()=>{
    initTabs();
    loadTailInfo();
    $("#submitBtn").addEventListener("click", submitTail);
    
    const btnCopy = $("#btnCopyAtm");
    if(btnCopy) btnCopy.onclick = () => {
      const txt = $("#atmAccount").textContent;
      navigator.clipboard.writeText(txt).then(()=>alert("已複製！")).catch(()=>alert("複製失敗"));
    };
  });
})();
</script>
</body>
</html>
