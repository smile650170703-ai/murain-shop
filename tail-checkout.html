<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Final payment — 尾款結帳</title>
  <style>
    :root{
      --bg:#050816;
      --card:#0f172a;
      --card-soft:#020617;
      --accent:#22d3ee;
      --accent-soft:rgba(34,211,238,.1);
      --accent-weak:rgba(56,189,248,.6);
      --txt:#e5e7eb;
      --muted:#9ca3af;
      --danger:#f97373;
      --border:#1f2937;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC",sans-serif;
      background:radial-gradient(circle at top,#111827 0,#020617 45%,#000 100%);
      color:var(--txt);
    }
    .wrap{
      max-width:860px;
      margin:0 auto;
      padding:20px 16px 40px;
    }
    h1{
      font-size:22px;
      margin:8px 0 16px;
      letter-spacing:.1em;
    }
    .subtitle{
      font-size:13px;
      color:var(--muted);
      margin-bottom:16px;
    }
    .card{
      background:linear-gradient(145deg,#020617,#020617 40%,#020617 60%,#020617);
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:0 24px 60px rgba(15,23,42,.9);
      padding:18px 16px 18px;
      margin-bottom:16px;
    }
    .card-header{
      font-size:15px;
      font-weight:600;
      margin-bottom:10px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      background:var(--accent-soft);
      color:var(--accent);
      margin-left:6px;
    }
    label{
      font-size:13px;
      color:var(--muted);
      display:block;
      margin-bottom:4px;
    }
    input{
      width:100%;
      padding:9px 11px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.9);
      color:var(--txt);
      font-size:14px;
    }
    input[readonly]{opacity:.8;}
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .row>*{flex:1 1 180px;}
    .mt-1{margin-top:4px;}
    .mt-2{margin-top:8px;}
    .mt-3{margin-top:12px;}
    .mt-4{margin-top:16px;}
    .muted{color:var(--muted);font-size:12px;}
    .danger{
      background:rgba(248,113,113,.1);
      border:1px solid rgba(248,113,113,.5);
      color:#fecaca;
      padding:8px 10px;
      border-radius:10px;
      font-size:13px;
      margin-bottom:10px;
    }
    .pill-inline{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.6);
  font-size:13px;
}

.btn-sm{
  font-size:12px;
  padding:4px 10px;
}

.required{
  color:#f97373;
}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;}
    .pill-bar{
      display:flex;
      border-radius:999px;
      background:#020617;
      border:1px solid var(--border);
      padding:4px;
      margin-top:6px;
      gap:4px;
      flex-wrap:wrap;        /* ← 新增這行 */
    }
    .pill{
      flex:1;
      border-radius:999px;
      font-size:13px;
      padding:7px 10px;
      border:none;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      white-space:normal;    /* ← 原本是 nowrap */
    }
    .pill.active{
      background:var(--accent);
      color:#020617;
      font-weight:600;
    }
    .pill span.small{
      font-size:11px;
      opacity:.8;
    }
    .pay-pane{display:none;margin-top:10px;font-size:13px;}
    .pay-pane.active{display:block;}
    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
    }
    .money-big{
      font-size:20px;
      font-weight:600;
    }
    .btn-primary{
      width:100%;
      border-radius:999px;
      border:none;
      padding:11px 12px;
      background:linear-gradient(135deg,#22d3ee,#0ea5e9);
      color:#020617;
      font-size:15px;
      font-weight:600;
      letter-spacing:.1em;
      cursor:pointer;
      margin-top:14px;
    }
    .btn-primary:disabled{
      opacity:.5;
      cursor:default;
    }
    .btn-secondary{
      border-radius:999px;
      border:1px solid var(--border);
      padding:8px 12px;
      background:rgba(15,23,42,.9);
      color:var(--muted);
      font-size:13px;
      cursor:pointer;
    }
    .btn-secondary.active-paid{
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-soft);
      font-weight:600;
    }
    .flex-between{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .right{text-align:right;}
    .small{font-size:11px;}
  </style>
  <script>
    // 和其他頁一樣
    window.API_BASE = "https://api.murain.tw";
  </script>
</head>
<body>
<div class="wrap">
  <div class="mt-2">
    <div class="small muted">Final payment
</div>
    <h1>尾款結帳</h1>
  </div>

  <div id="errorBox" class="danger" style="display:none"></div>

  <!-- 訂單資訊 -->
  <div class="card">
    <div class="card-header">
      訂單資訊
      <span class="badge">原訂金訂單</span>
    </div>

    <div class="row">
      <div>
        <label>原訂單編號</label>
        <input id="fieldOrderId" class="mono" readonly />
      </div>
      <div>
        <label>原訂單總金額</label>
        <input id="fieldTotal" class="mono" readonly />
      </div>
    </div>

    <div class="row mt-2">
      <div>
        <label>已付訂金</label>
        <input id="fieldDeposit" class="mono" readonly />
      </div>
      <div>
        <label>保留到期日</label>
        <input id="fieldHoldUntil" class="mono" readonly />
      </div>
    </div>

    <div class="mt-3">
      <label>商品明細（摘要）</label>
      <textarea id="fieldItems" rows="3" style="width:100%;border-radius:10px;border:1px solid var(--border);background:#020617;color:var(--txt);font-size:13px;padding:8px 10px;" readonly></textarea>
    </div>
  </div>
  <div class="card">
    <div class="card-header">
      寄送資訊
      <span class="badge">沿用原訂單收件資料</span>
    

    <div class="mt-3 small mono" id="shipInfoBox">
      <div id="shipName"></div>
      <div id="shipPhone"></div>
      <div id="shipAddr"></div>
      <div id="shipStore"></div>
    </div>
  </div>

  <!-- 尾款金額 -->
  <div class="card">
    <div class="flex-between">
      <div class="card-header">
        尾款金額
      </div>
      <div class="muted small">此金額會自動依「總金額－訂金」計算。</div>
    </div>
    <div class="flex-between mt-2">
      <div class="muted">需結清尾款</div>
      <div class="money-big mono" id="tailAmountView">NT$ 0</div>
    </div>
  </div>

  <!-- 付款方式 -->
  <div class="card">
    <div class="card-header">
      付款方式
    </div>

    <div class="pill-bar" id="payTabs">
      <button type="button" class="pill active" data-pay="COD">7-11 貨到付款</button>
      <button type="button" class="pill" data-pay="PAID">線上付款<span class="small">（信用卡 / 分期 / LINE Pay / AF）</span></button>
      <button type="button" class="pill" data-pay="ATM">ATM 匯款</button>
      <button type="button" class="pill" data-pay="ZEROCARD">無卡零角</button>
    </div>

    <!-- COD -->
    <div class="pay-pane active" id="paneCOD">
      <div class="mt-2 hint">
        尾款將在您到 7-11 取貨時一次收取。<br>
        <span class="small">※ 此尾款訂單不會再變動收件資料，會沿用原訂單的 7-11 門市。</span>
      </div>
    </div>

    <!-- 線上付款 -->
    <div class="pay-pane" id="panePAID">
      <div class="mt-2">
        <label>付款管道</label>
        <div class="row">
          <button type="button" class="btn-secondary" data-paid="card_once">信用卡一次付清</button>
          <button type="button" class="btn-secondary" data-paid="card_inst">信用卡分期</button>
          <button type="button" class="btn-secondary" data-paid="linepay">LINE Pay</button>
          <button type="button" class="btn-secondary" data-paid="af">AFTEE 先享後付</button>
        </div>
      </div>

      <div class="mt-2" id="instBox" style="display:none">
        <label>分期期數</label>
        <select id="instMonths" style="width:100%;padding:9px 11px;border-radius:10px;border:1px solid var(--border);background:#020617;color:var(--txt);font-size:14px;">
  <option value="3">3 期（零利率）</option>
  <option value="6">6 期（零利率）</option>
  <option value="9">9 期（零利率）</option>
</select>
<div class="hint mt-1 small">實際分期利率與每期金額以刷卡頁面為準。</div>
      </div>
    </div>

    <!-- ATM 匯款 -->
<div class="pay-pane" id="paneATM">
  <div class="hint mt-2">
    尾款將以「匯款全額」方式結清，請於顯示的期限內匯款完成。
  </div>

  <div class="card mt-2">
    <div class="small">
      匯款資訊：
    </div>
    <div class="mt-2 small">
      銀行：
      <span class="pill-inline">郵局（700）</span><br>
      帳號：
      <span id="atmAccount" class="pill-inline">01912890973712</span>
      <button type="button" class="btn-secondary btn-sm" id="btnCopyAtm">
        一鍵複製
      </button>
    </div>
    <div class="muted small mt-1">
      可直接一鍵複製帳號貼到 APP。
    </div>
  </div>

  <div class="mt-3">
    <label>匯款帳號後五碼 <span class="required">*</span></label>
    <input
      id="atmLast5"
      type="text"
      maxlength="5"
      inputmode="numeric"
      pattern="[0-9]*"
      style="width:100%;padding:9px 11px;border-radius:10px;border:1px solid var(--border);background:#020617;color:var(--txt);font-size:14px;"
      placeholder="請輸入匯款帳號後五碼"
    />
  </div>
</div>

    <!-- 無卡零角 -->
    <div class="pay-pane" id="paneZEROCARD">
      <div class="mt-2">
        <label>分期期數</label>
        <select id="zcMonths" style="width:100%;padding:9px 11px;border-radius:10px;border:1px solid var(--border);background:#020617;color:var(--txt);font-size:14px;">
  <option value="3">3 期（零利率）</option>
  <option value="6">6 期</option>
  <option value="9">9 期</option>
  <option value="12">12 期</option>
  <option value="18">18 期</option>
  <option value="24">24 期</option>
</select>
      </div>
       <!-- 新增：備註小字 -->
  <div class="muted small mt-1">
    ※ 每期金額僅供試算，實際金額與期數，以中租零卡分期審核結果為準。
  </div>
    </div>

    <button id="submitBtn" class="btn-primary">送出尾款</button>
    <div class="muted small mt-2">
      按下後若畫面顯示「尾款訂單已建立」，請依指示完成付款；若遇到錯誤，請截圖給管理者協助處理。
    </div>
  </div>

</div>

<script>
(function(){
  const API = window.API_BASE || "https://api.murain.tw";
  const $ = s => document.querySelector(s);

  let tailInfo = null;   // 從 /tail/info 拿到的資料
  let activePay = "COD";
  let paidChannel = "card_once";

  function setError(msg){
    const box = $("#errorBox");
    if(!msg){ box.style.display="none"; box.textContent=""; return; }
    box.textContent = msg;
    box.style.display = "block";
  }

  function money(n){
    n = Number(n) || 0;
    return "NT$ " + n.toLocaleString("zh-TW");
  }

  function initTabs(){
    const tabs = document.querySelectorAll(".pill");
    tabs.forEach(tab=>{
      tab.addEventListener("click", ()=>{
        tabs.forEach(t=>t.classList.remove("active"));
        tab.classList.add("active");
        activePay = tab.dataset.pay;

        document.querySelectorAll(".pay-pane").forEach(p=>p.classList.remove("active"));
        $("#pane"+activePay).classList.add("active");
      });
    });

    // 線上付款管道小按鈕
    document.querySelectorAll("[data-paid]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll("[data-paid]").forEach(b=>b.classList.remove("active-paid"));
        btn.classList.add("active-paid");
        paidChannel = btn.dataset.paid || "card_once";
        $("#instBox").style.display = (paidChannel==="card_inst") ? "block" : "none";
      });
    });
  }

  async function loadTailInfo(){
    const sp = new URLSearchParams(location.search);
    const orderId = sp.get("order_id") || sp.get("parent_order_id") || "";
    if(!orderId){
      setError("缺少訂單編號（order_id），請確認連結是否正確。");
      return;
    }

    try{
      const r = await fetch(`${API}/tail/info?order_id=${encodeURIComponent(orderId)}`,{
        method:"GET",
        headers:{"Content-Type":"application/json"}
      });
      const j = await r.json();
      if(!r.ok || !j.ok){
        const msg = j.message || j.error || "取得原訂單資料失敗，請稍後再試。";
        setError(msg);
        return;
      }

      tailInfo = j;

      $("#fieldOrderId").value = j.parent_order_id || orderId;
      $("#fieldTotal").value   = money(j.total_amount || 0);
      $("#fieldDeposit").value = money(j.deposit_amount || 0);
      $("#tailAmountView").textContent = money(j.tail_amount || 0);
      const hold = (j.shipping_info && j.shipping_info.hold_until) || "";
      $("#fieldHoldUntil").value = hold || (j.hold_until || "");

      $("#fieldItems").value = j.items_text || "(無商品摘要)";
             // === 這一段是「對 shipping_info 欄位」＋畫面顯示 ===
    const ship = (j.shipping_info && j.shipping_info.ship) || {};
    const store = ship.store || {};

    const sName       = ship.name || "";
    const sPhone      = ship.phone || "";
    const sStoreName  = store.name || "";
    const sStoreId    = store.id || "";
    const sStoreAddr  = store.addr || "";

    const elName  = $("#shipName");
    const elPhone = $("#shipPhone");
    const elAddr  = $("#shipAddr");
    const elStore = $("#shipStore");

    if (elName) {
      elName.textContent = sName ? `收件人：${sName}` : "";
    }
    if (elPhone) {
      elPhone.textContent = sPhone ? `電話：${sPhone}` : "";
    }
    if (elAddr) {
      elAddr.textContent = sStoreAddr ? `門市地址：${sStoreAddr}` : "";
    }
    if (elStore) {
      elStore.textContent = sStoreName
        ? `門市：${sStoreName}${sStoreId ? `（${sStoreId}）` : ""}`
        : "";
    }
    // === 到這邊結束 ===

            // 依原出貨方式決定是否可以用「7-11 貨到付款」
      const shipType = ship.type || "";

      // 如果原本不是 7-11（例如郵寄），就隱藏 COD，改成預設用線上付款
      if (shipType !== "711") {
        const codTab  = document.querySelector('.pill[data-pay="COD"]');
        const codPane = document.getElementById("paneCOD");

        // 隱藏上面的「7-11 貨到付款」pill
        if (codTab) {
          codTab.style.display = "none";
        }
        // 隱藏 COD 的說明區塊
        if (codPane) {
          codPane.classList.remove("active");
          codPane.style.display = "none";
        }

        // 如果目前 activePay 還是 COD，就切換成線上付款
        if (activePay === "COD") {
          activePay = "PAID";

          const paidTab = document.querySelector('.pill[data-pay="PAID"]');
          if (paidTab) {
            document.querySelectorAll(".pill").forEach(t=>t.classList.remove("active"));
            paidTab.classList.add("active");
          }

          document.querySelectorAll(".pay-pane").forEach(p=>p.classList.remove("active"));
          const paidPane = document.getElementById("panePAID");
          if (paidPane) {
            paidPane.classList.add("active");
          }
        }
      }


    }catch(e){
      console.error(e);
      setError("系統錯誤：無法載入尾款資訊。");
    }
  }

  async function submitTail(){
    if(!tailInfo){
      alert("尚未載入原訂單資料，請稍候再試一次。");
      return;
    }

    const tailAmount = Number(tailInfo.tail_amount || 0) || 0;
    if(tailAmount <= 0){
      if(!confirm("目前計算尾款為 0 元，仍要建立尾款訂單嗎？")) return;
    }

    let payment_method = "";
const extra = {};  // 額外資料（例如 ATM 匯款後五碼）

if(activePay === "COD"){
  payment_method = "cod_711"; // 尾款用貨到付款
}else if(activePay === "PAID"){
  if(paidChannel === "card_once"){
    payment_method = "paid_card_once";
  }else if(paidChannel === "card_inst"){
    const months = $("#instMonths").value || "3";
    payment_method = `paid_card_inst_${months}`;
  }else if(paidChannel === "linepay"){
    payment_method = "paid_linepay";
  }else if(paidChannel === "af"){
    payment_method = "paid_af";
  }
}else if(activePay === "ATM"){
  const last5Input = $("#atmLast5");
  const last5 = (last5Input && last5Input.value || "").trim();
  if (!/^\d{5}$/.test(last5)) {
    alert("請先輸入匯款帳號後五碼（5 位數字）");
    if (last5Input) last5Input.focus();
    return;
  }
  payment_method = "atm_full_tail"; // 給你辨識是「尾款匯款」
  extra.atm_last5 = last5;
}else if(activePay === "ZEROCARD"){
  const months = $("#zcMonths").value || "3";
  payment_method = `zero_card_${months}`;
}

    if(!payment_method){
  alert("請先選擇尾款付款方式");
  return;
}

try{
  $("#submitBtn").disabled = true;

  const payload = {
    parent_order_id: tailInfo.parent_order_id,
    items_json: tailInfo.items_text || "",
    tail_amount: tailInfo.tail_amount || 0,
    payment_method,
    shipping_info: tailInfo.shipping_info || {}
  };

  if (extra.atm_last5) {
    payload.atm_last5 = extra.atm_last5;
  }

      const r = await fetch(`${API}/tail/checkout`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const j = await r.json();

      if(!r.ok || !j.ok){
        const msg = j.message || j.error || "尾款訂單建立失敗，請再試一次。";
        alert(msg);
        $("#submitBtn").disabled = false;
        return;
      }

      const newOrderId = j.order_id;

      // 1) 線上刷卡類：轉給 PayUNI
      if(payment_method.startsWith("paid_")){
        try{
          const pr = await fetch(`${API}/payuni/start`,{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ order_id: newOrderId })
          });
          const up = await pr.json();
          if(!pr.ok || !up.ok){
            alert("線上刷卡啟動失敗：" + (up.error || up.message || ""));
            $("#submitBtn").disabled = false;
            return;
          }

          const f = document.createElement("form");
          f.method = "POST";
          f.action = up.url;
          ["MerID","Version","EncryptInfo","HashInfo"].forEach(k=>{
            const input = document.createElement("input");
            input.type="hidden";
            input.name=k;
            input.value=up[k];
            f.appendChild(input);
          });
          document.body.appendChild(f);
          f.submit();
          return;
        }catch(e){
          console.error(e);
          alert("線上刷卡啟動失敗（網路或程式錯誤）。");
          $("#submitBtn").disabled = false;
          return;
        }
      }

      // 2) 無卡零角：轉給 /zero-card/start
      if(payment_method.startsWith("zero_card_")){
        try{
          const zr = await fetch(`${API}/zero-card/start`,{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ order_id: newOrderId })
          });
          const zj = await zr.json();
          if(!zr.ok || !zj.ok){
            alert("中租無卡零角啟動失敗：" + (zj.error || zj.message || ""));
            $("#submitBtn").disabled = false;
            return;
          }
          // 後端回 payment_url
          location.href = zj.payment_url;
          return;
        }catch(e){
          console.error(e);
          alert("中租無卡零角啟動失敗（網路或程式錯誤）。");
          $("#submitBtn").disabled = false;
          return;
        }
      }

      // 3) COD / ATM：只建立尾款訂單，不跳外部頁面
      alert("尾款訂單已建立，感謝您！");
      location.href = `/order-result.html?order_id=${encodeURIComponent(newOrderId)}&from=tail`;

    }catch(e){
      console.error(e);
      alert("系統錯誤，請稍後再試。");
      $("#submitBtn").disabled = false;
    }
  }
document.addEventListener("DOMContentLoaded", ()=>{
  initTabs();
  loadTailInfo();
  $("#submitBtn").addEventListener("click", submitTail);

  const btnCopy = $("#btnCopyAtm");
  if (btnCopy) {
    btnCopy.addEventListener("click", ()=>{
      const accEl = $("#atmAccount");
      const acc = (accEl && accEl.textContent || "").replace(/\s+/g,"");
      if (!acc) return;

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(acc).then(()=>{
          alert("匯款帳號已複製");
        }).catch(()=>{
          alert("匯款帳號： " + acc + "\n如無法自動複製，請手動長按複製。");
        });
      } else {
        alert("匯款帳號： " + acc + "\n如無法自動複製，請手動長按複製。");
      }
    });
  }
});

})();
</script>
</body>
</html>
