<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>XUYUAN | å°¾æ¬¾çµå¸³</title>
  
  <!-- å¼•å…¥å“ç‰Œå­—é«” -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

  <style>
    /* --- æ ¸å¿ƒè®Šæ•¸ --- */
    :root {
      --bg-color: #050505;
      --card-bg: #111;
      --input-bg: #1a1a1a;
      --text-main: #fff;
      --text-muted: #888;
      --gold-primary: #D4AF37; 
      --gold-light: #F3E5AB;
      --border-color: rgba(255, 255, 255, 0.1);
      --danger: #ef4444;
      --font-serif: 'Playfair Display', serif; /* ç”¨æ–¼æ¨™é¡Œã€å“ç‰Œå */
      --font-sans: 'Lato', sans-serif;        /* ç”¨æ–¼ä¸€èˆ¬æ–‡å­— */
      /* âœ… æ–°å¢ï¼šå°ˆé–€ç”¨æ–¼æ•¸å­—é¡¯ç¤ºçš„å­—é«” (æ¸…æ™°æ˜“è®€) */
      --font-num: 'Lato', 'Arial', sans-serif; 
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      padding-bottom: calc(100px + env(safe-area-inset-bottom));
    }

    .wrap {
      max-width: 640px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    /* --- Header --- */
    .header {
      text-align: center;
      margin-bottom: 40px;
    }
    .brand {
      font-family: var(--font-serif);
      font-size: 24px;
      letter-spacing: 0.15em;
      color: var(--gold-primary);
      margin-bottom: 4px;
    }
    .page-title {
      font-size: 11px;
      letter-spacing: 0.2em;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    /* --- å¡ç‰‡é€šç”¨ --- */
    .card {
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 24px;
    }
    .card-header {
      font-size: 12px;
      letter-spacing: 0.1em;
      color: var(--gold-primary);
      text-transform: uppercase;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .badge {
      font-size: 10px; color: var(--text-muted); border: 1px solid var(--border-color);
      padding: 2px 6px; border-radius: 99em; letter-spacing: 0;
    }

    /* --- è¡¨å–® --- */
    label {
      display: block; font-size: 12px; color: #666; margin-bottom: 4px; margin-top: 12px;
    }
    label:first-child { margin-top: 0; }

    input, select, textarea {
      width: 100%; padding: 12px;
      border-radius: 2px; border: 1px solid var(--border-color);
      background: var(--input-bg); color: #fff;
      /* âœ… ä¿®æ”¹ï¼šè¼¸å…¥æ¡†çµ±ä¸€ä½¿ç”¨æ¸…æ™°å­—é«” */
      font-family: var(--font-num); 
      font-size: 14px;
      -webkit-appearance: none;
    }
    
    /* å”¯è®€è¼¸å…¥æ¡†ï¼šåšæˆæ–‡å­—é¡¯ç¤º */
    input[readonly], textarea[readonly] {
      background: transparent; border: none; padding: 0;
      color: #eee; 
      /* âœ… ä¿®æ”¹ï¼šå¾ serif æ”¹ç‚º numï¼Œä¸¦åŠ ç²—ä¸€é»å¢åŠ å¯è®€æ€§ */
      font-family: var(--font-num); 
      font-weight: 500;
      font-size: 15px; 
      letter-spacing: 0.03em;
      pointer-events: none;
    }
    textarea[readonly] {
      font-family: var(--font-sans); font-size: 13px; color: #aaa; line-height: 1.5; resize: none; min-height: auto;
    }

    .row { display: flex; gap: 20px; }
    .row > * { flex: 1; }

    /* --- å°¾æ¬¾é‡‘é¡é¡¯ç¤º --- */
    .money-big {
      /* âœ… ä¿®æ”¹ï¼šé‡‘é¡é¡¯ç¤ºæ”¹ç‚ºæ¸…æ™°å­—é«”ï¼Œä¸¦åŠ ç²— */
      font-family: var(--font-num); 
      font-weight: 700;
      font-size: 28px; color: var(--gold-light);
      text-align: right; margin-top: 4px;
    }
    .flex-between { display: flex; justify-content: space-between; align-items: baseline; }

    /* --- å¯„é€è³‡è¨Š --- */
    #shipInfoBox {
      /* âœ… ä¿®æ”¹ï¼šå¯„é€è³‡è¨Šæ”¹ç‚ºæ¸…æ™°å­—é«” (åŸæœ¬æ˜¯ monospace) */
      font-size: 14px; color: #ccc; line-height: 1.6; 
      font-family: var(--font-num);
    }

    /* --- ä»˜æ¬¾æ–¹å¼ Tabs (Pill) --- */
    .pill-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
    .pill {
      flex: 1; min-width: 100px;
      background: transparent; border: 1px solid var(--border-color);
      color: var(--text-muted); padding: 10px; text-align: center;
      font-size: 12px; cursor: pointer; transition: all 0.3s;
    }
    .pill.active {
      border-color: var(--gold-primary); color: var(--gold-primary); background: rgba(212, 175, 55, 0.05);
    }
    .pill span.small { display: block; font-size: 10px; opacity: 0.7; margin-top: 2px; transform: scale(0.9); }

    .pay-pane { display: none; margin-top: 16px; animation: fadeIn 0.3s ease; }
    .pay-pane.active { display: block; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }

    /* --- æŒ‰éˆ• --- */
    .btn-secondary {
      display: inline-block; padding: 8px 16px; border: 1px solid var(--border-color);
      background: transparent; color: var(--text-muted); font-size: 12px; cursor: pointer;
      margin-right: 8px; margin-bottom: 8px; transition: 0.2s;
    }
    .btn-secondary.active-paid {
      border-color: var(--gold-primary); color: var(--gold-primary);
    }
    .btn-sm { padding: 4px 8px; font-size: 10px; margin-left: 8px; }

    .btn-primary {
      width: 100%; padding: 14px;
      background: var(--gold-primary); color: #000;
      border: none; border-radius: 2px;
      font-size: 14px; font-weight: 700; letter-spacing: 0.1em;
      text-transform: uppercase; cursor: pointer; margin-top: 30px;
    }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

    /* --- å…¶ä»– --- */
    .hint { font-size: 12px; color: var(--text-muted); line-height: 1.5; margin-top: 8px; }
    .danger { color: var(--danger); font-size: 12px; margin-bottom: 16px; border: 1px solid var(--danger); padding: 10px; }
    .pill-inline { color: #fff; font-family: monospace; }
    .muted { color: #666; font-size: 11px; margin-top: 8px; text-align: center; }

    /* âœ… ç‰¹åˆ¥é‡å° ATM å¸³è™Ÿé¡¯ç¤º */
    #atmAccount {
      font-family: var(--font-num);
      font-size: 18px; /* ç¨å¾®åŠ å¤§ */
      font-weight: 700;
      letter-spacing: 1px;
    }

  </style>
  <script>window.API_BASE = "https://api.murain.tw";</script>
</head>
<body>

<div class="wrap">
  
  <div class="header">
    <div class="brand">XUYUAN</div>
    <div class="page-title">å°¾æ¬¾çµå¸³</div>
  </div>

  <div id="errorBox" class="danger" style="display:none"></div>

  <!-- 1. åŸè¨‚å–®è³‡è¨Š -->
  <div class="card">
    <div class="card-header">
      åŸè¨‚å–®è³‡è¨Š
      <span class="badge">è¨‚é‡‘ç´€éŒ„</span>
    </div>

    <div class="row">
      <div>
        <label>è¨‚å–®ç·¨è™Ÿ</label>
        <input id="fieldOrderId" readonly />
      </div>
      <div>
        <label>è¨‚å–®ç¸½é¡</label>
        <input id="fieldTotal" readonly />
      </div>
    </div>

    <div class="row">
      <div>
        <label>å·²ä»˜è¨‚é‡‘</label>
        <input id="fieldDeposit" readonly style="color:var(--gold-light);" />
      </div>
      <div>
        <label>ä¿ç•™æœŸé™</label>
        <input id="fieldHoldUntil" readonly />
      </div>
    </div>

    <div style="margin-top:16px;">
      <label>å•†å“æ‘˜è¦</label>
      <textarea id="fieldItems" rows="2" readonly></textarea>
    </div>
  </div>

  <!-- 2. å¯„é€è³‡è¨Š -->
  <div class="card">
    <div class="card-header">
      æ”¶ä»¶è³‡è¨Š
      <span class="badge">åŒåŸè¨‚å–®</span>
    </div>
    <div id="shipInfoBox">
      <div id="shipName"></div>
      <div id="shipPhone"></div>
      <div id="shipAddr"></div>
      <div id="shipStore"></div>
    </div>
  </div>

  <!-- 3. å°¾æ¬¾é‡‘é¡ -->
  <div class="card" style="border-color:var(--gold-primary);">
    <div class="flex-between">
      <div style="font-size:12px;letter-spacing:0.1em;color:var(--gold-primary);">å‰©é¤˜å°¾æ¬¾</div>
      <div style="font-size:10px;color:#666;">( ç¸½é‡‘é¡ - å·²ä»˜è¨‚é‡‘ )</div>
    </div>
    <div id="tailAmountView" class="money-big">NT$ 0</div>
    <div id="tailBreakdown" style="font-size:11px;color:#666;text-align:right;margin-top:6px;"></div>
  </div>

  <!-- âœ… 3-1. è³¼ç‰©é‡‘æŠ˜æŠµï¼ˆå…±ç”¨ï¼Œä¸å½±éŸ¿ä»»ä½•ä»˜æ¬¾æµç¨‹ï¼‰ -->
  <div class="card">
    <div class="card-header">
      è³¼ç‰©é‡‘æŠ˜æŠµ
      <span class="badge">å¯é¸</span>
    </div>

    <label>æœ¬æ¬¡æŠ˜æŠµé‡‘é¡</label>
    <input id="creditUsed" type="number" min="0" step="1" value="0" inputmode="numeric" placeholder="0" />
    <div class="hint" id="creditAvailText">å¯ç”¨é¤˜é¡ï¼šè®€å–ä¸­...</div>
    <div class="hint">* ç·šä¸Šä»˜æ¬¾éœ€è‡³å°‘æ”¯ä»˜ 1 å…ƒï¼ˆæŠ˜æŠµä¸å¯ â‰¥ å°¾æ¬¾ï¼‰ã€‚</div>
  </div>

  <!-- 4. ä»˜æ¬¾æ–¹å¼ -->
  <div class="card">
    <div class="card-header">ä»˜æ¬¾æ–¹å¼</div>

    <div class="pill-bar" id="payTabs">
      <button type="button" class="pill active" data-pay="COD">7-11 è²¨åˆ°ä»˜æ¬¾</button>
      <button type="button" class="pill" data-pay="PAID">ç·šä¸Šä»˜æ¬¾<span class="small">Card / LINE Pay</span></button>
      <button type="button" class="pill" data-pay="ATM">ATM åŒ¯æ¬¾ / å…¨é¡è³¼ç‰©é‡‘</button>
    </div>

    <!-- COD -->
    <div class="pay-pane active" id="paneCOD">
      <div class="hint">
        å°¾æ¬¾å°‡åœ¨æ‚¨åˆ° 7-11 å–è²¨æ™‚ä¸€æ¬¡æ”¶å–ã€‚<br>
        <span style="opacity:0.6">* ç³»çµ±å°‡æ²¿ç”¨åŸè¨‚å–®è¨­å®šçš„ 7-11 é–€å¸‚ã€‚</span>
      </div>
    </div>

    <!-- PAID -->
    <div class="pay-pane" id="panePAID">
      <label>é¸æ“‡ç®¡é“</label>
      <div style="margin-top:8px;">
        <button type="button" class="btn-secondary" data-paid="card_once">ä¿¡ç”¨å¡ä¸€æ¬¡ä»˜æ¸…</button>
        <button type="button" class="btn-secondary" data-paid="card_inst">ä¿¡ç”¨å¡åˆ†æœŸ</button>
        <button type="button" class="btn-secondary" data-paid="linepay">LINE Pay</button>
        <button type="button" class="btn-secondary" data-paid="af">AFTEE</button>
      </div>

      <div id="instBox" style="display:none; margin-top:12px;">
        <label>åˆ†æœŸæœŸæ•¸</label>
        <select id="instMonths">
          <option value="3">3 æœŸ (0 åˆ©ç‡)</option>
          <option value="6">6 æœŸ (0 åˆ©ç‡)</option>
          <option value="9">9 æœŸ (0 åˆ©ç‡)</option>
        </select>
      </div>
    </div>

    <!-- ATM -->
    <div class="pay-pane" id="paneATM">
      <div class="hint">è«‹åŒ¯æ¬¾å…¨é¡è‡³ä»¥ä¸‹å¸³æˆ¶ï¼š</div>
      <div style="background:#111; padding:12px; margin-top:8px; border:1px dashed #444;">
        <div style="font-size:12px; color:#aaa;">éƒµå±€ (700)</div>
        <div style="color:#fff; margin-top:4px;">
          <span id="atmAccount">01912890973712</span>
          <button type="button" class="btn-secondary btn-sm" id="btnCopyAtm">è¤‡è£½</button>
        </div>
      </div>

      <label>å¸³è™Ÿå¾Œäº”ç¢¼ğŸ’¡ å…¨é¡è³¼ç‰©é‡‘æŠµæ‰£è€…ï¼š</strong><br>
        ç„¡é ˆåŒ¯æ¬¾ï¼Œè«‹åœ¨ä¸‹æ–¹æ¬„ä½å¡«å¯«ã€Œ<strong>è³¼ç‰©é‡‘</strong>ã€å³å¯ã€‚</label>
      <input id="atmLast5" type="text" maxlength="5" inputmode="numeric" placeholder="12345" />
    </div> <!-- /paneATM -->

  </div> <!-- /ä»˜æ¬¾æ–¹å¼ card -->

  <button id="submitBtn" class="btn-primary">é€å‡ºå°¾æ¬¾çµå¸³</button>
  <div class="muted">å¦‚æœ‰å•é¡Œè«‹è¯ç¹«å®¢æœ</div>
</div> <!-- /wrap -->

<script>
(function(){
  const API = window.API_BASE || "https://api.murain.tw";
  const $ = s => document.querySelector(s);

  let tailInfo = null;
  let activePay = "COD";
  let paidChannel = "card_once";

  function setError(msg){
    const box = $("#errorBox");
    if(!msg){ box.style.display="none"; box.textContent=""; return; }
    box.textContent = msg;
    box.style.display = "block";
  }

  function money(n){ return "NT$ " + (Number(n)||0).toLocaleString("zh-TW"); }

  let creditBalance = 0;

  function getTailAmount(){
  return Math.max(0, Math.round(Number(tailInfo?.tail_amount || 0) || 0));
}

function getCreditUsedInput(){
  const cuEl = document.getElementById("creditUsed");
  return cuEl ? Math.floor(Math.max(0, Number(cuEl.value || 0) || 0)) : 0;
}

// âœ… åŒæ­¥ï¼šä¾ä»˜æ¬¾æ–¹å¼é™åˆ¶å¯æŠ˜æŠµä¸Šé™ï¼ˆç·šä¸Šä»˜æ¬¾è¦è‡³å°‘ä»˜ 1 å…ƒï¼‰
function calcCreditMaxByPay(tailAmount){
  // COD / ATMï¼šå¯æŠ˜åˆ° 0
  if (activePay !== "PAID") return Math.min(creditBalance, tailAmount);

  // ç·šä¸Šä»˜æ¬¾ï¼šè‡³å°‘è¦ä»˜ 1 å…ƒï¼ˆå°¾æ¬¾ > 0 æ‰éœ€è¦ï¼‰
  if (tailAmount <= 0) return 0;
  return Math.min(creditBalance, Math.max(0, tailAmount - 1));
}

function updateTailAmountUI(){
  const tailAmount = getTailAmount();
  const cuEl = document.getElementById("creditUsed");

  // ä¾ä»˜æ¬¾æ–¹å¼æ›´æ–° max ä¸¦ clamp
  const maxCredit = calcCreditMaxByPay(tailAmount);
  if (cuEl){
    cuEl.max = String(maxCredit);
    let v = getCreditUsedInput();
    if (v > maxCredit){
      v = maxCredit;
      cuEl.value = String(v);
    }
  }

  const creditUsed = getCreditUsedInput();
  const payable = Math.max(0, tailAmount - creditUsed);

  // âœ… å¤§å­—ï¼šé¡¯ç¤ºæŠ˜æŠµå¾Œéœ€æ”¯ä»˜
  const big = document.getElementById("tailAmountView");
  if (big) big.textContent = money(payable);

  // âœ… å°å­—ï¼šé¡¯ç¤ºåŸå°¾æ¬¾/æŠ˜æŠµ
  const bd = document.getElementById("tailBreakdown");
  if (bd) bd.textContent = `åŸå°¾æ¬¾ ${money(tailAmount)}ï½œæœ¬æ¬¡æŠ˜æŠµ ${money(creditUsed)}`;
}

function extractLineUserIdFromShipping(si){
  try {
    const shipInfo = (si && typeof si === "object")
      ? si
      : (typeof si === "string" ? JSON.parse(si) : {});

    // å¸¸è¦‹ä½ç½®ï¼šshipping_info.line / line_profile
    const line = shipInfo.line || shipInfo.line_profile || shipInfo.lineProfile || {};

    // ä¹Ÿæœ‰äººæœƒç›´æ¥æŠŠ userId å¡åœ¨ shipInfo æˆ– shipInfo.ship è£¡
    const ship = shipInfo.ship || {};

    const uid = (
      line.user_id || line.userId || line.LINE_USER_ID ||
      shipInfo.line_user_id || shipInfo.lineUserId ||
      ship.line_user_id || ship.lineUserId ||
      ""
    );

    return String(uid).trim();
  } catch (e) {
    return "";
  }
}

async function fetchCreditBalance(lineUserId){
  try{
    const r = await fetch(`${API}/line/member-info?user_id=${encodeURIComponent(lineUserId)}`);
    const j = await r.json();
    if(r.ok && j && j.ok){
      return Number(j.credit || 0) || 0;
    }
  }catch(e){}
  return 0;
}

function applyCreditUI(balance, tailAmount){
  creditBalance = Math.max(0, Math.round(Number(balance) || 0));

  const t = document.getElementById("creditAvailText");
  if(t) t.textContent = `å¯ç”¨é¤˜é¡ï¼š${money(creditBalance)}`;

  // âœ… max / clamp äº¤çµ¦ updateTailAmountUI()ï¼ˆå®ƒæœƒä¾ activePay åšæ­£ç¢ºè¦å‰‡ï¼‰
  updateTailAmountUI();
}

  function initTabs(){
    const tabs = document.querySelectorAll(".pill");
    tabs.forEach(tab=>{
      tab.addEventListener("click", ()=>{
        tabs.forEach(t=>t.classList.remove("active"));
        tab.classList.add("active");
        activePay = tab.dataset.pay;
        document.querySelectorAll(".pay-pane").forEach(p=>p.classList.remove("active"));
        $("#pane"+activePay).classList.add("active");
        updateTailAmountUI();
      });
    });

    document.querySelectorAll("[data-paid]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll("[data-paid]").forEach(b=>b.classList.remove("active-paid"));
        btn.classList.add("active-paid");
        paidChannel = btn.dataset.paid || "card_once";
        $("#instBox").style.display = (paidChannel==="card_inst") ? "block" : "none";
      });
    });
  }

  function getParamWithLiffState(key){
  const u = new URL(location.href);

  // A) æ­£å¸¸ï¼š?order_id=...
  let v = u.searchParams.get(key);
  if (v) return v;

  // B) LIFF å¸¸è¦‹ï¼š?liff.state=%3Forder_id%3D...
  const st = u.searchParams.get("liff.state");
  if (st) {
    const s = st.startsWith("?") ? st.slice(1) : st;
    const p = new URLSearchParams(s);

    v = p.get(key);
    if (v) return v;

    // C) å°‘æ•¸ï¼šliff.state è£¡é‚„åŒ…ä¸€å±¤ url=ENCODED(https://...?...order_id=...)
    const inner = p.get("url");
    if (inner) {
      try {
        const innerUrl = new URL(inner, location.origin);
        v = innerUrl.searchParams.get(key);
        if (v) return v;
      } catch(e) {}
    }
  }

  return "";
}

  async function loadTailInfo(){
    const orderId = getParamWithLiffState("order_id") || getParamWithLiffState("parent_order_id") || "";
    if(!orderId) return setError("ç¼ºå°‘è¨‚å–®ç·¨è™Ÿ");

    try{
      const r = await fetch(`${API}/tail/info?order_id=${encodeURIComponent(orderId)}`);
      const j = await r.json();
      if(!r.ok || !j.ok) return setError(j.message || j.error || "è®€å–å¤±æ•—");

      tailInfo = j;
      $("#fieldOrderId").value = j.parent_order_id || orderId;
      $("#fieldTotal").value   = money(j.total_amount || 0);
      $("#fieldDeposit").value = money(j.deposit_amount || 0);
      $("#tailAmountView").textContent = money(j.tail_amount || 0);
      updateTailAmountUI();
      $("#fieldItems").value = String(j.items_text || "").trim();
      
      // âœ… shipping_info å¯èƒ½æ˜¯ object æˆ– JSON å­—ä¸²ï¼šçµ±ä¸€è½‰æˆç‰©ä»¶
let shipInfoObj = {};
try {
  shipInfoObj = (typeof j.shipping_info === "string") ? JSON.parse(j.shipping_info) : (j.shipping_info || {});
} catch(e) {
  shipInfoObj = {};
}

// âœ… è®€å–ä¸¦é¡¯ç¤ºå¯ç”¨è³¼ç‰©é‡‘ï¼ˆç”¨ shipInfoObjï¼Œä¸è¦ parse å…©æ¬¡ï¼‰
const uid = extractLineUserIdFromShipping(shipInfoObj);
if (uid) {
  const bal = await fetchCreditBalance(uid);
  applyCreditUI(bal, j.tail_amount || 0);
} else {
  applyCreditUI(0, j.tail_amount || 0);
}

// ä¿ç•™æœŸé™ï¼ˆä½ å¯èƒ½æ”¾åœ¨ shipping_info.hold_until æˆ– j.hold_untilï¼‰
$("#fieldHoldUntil").value = shipInfoObj.hold_until || j.hold_until || "";

// æ”¶ä»¶è³‡è¨Š
const ship = shipInfoObj.ship || {};
const store = ship.store || {};
      
      if($("#shipName")) $("#shipName").textContent = ship.name ? `å§“å: ${ship.name}` : "";
      if($("#shipPhone")) $("#shipPhone").textContent = ship.phone ? `é›»è©±: ${ship.phone}` : "";
      const addr = store.addr || ship.addr || ship.address || "";
if($("#shipAddr")) $("#shipAddr").textContent = addr ? `åœ°å€: ${addr}` : "";
      const storeName = store.name || ship.store_name || "";
const storeId   = store.id || ship.store_id || "";
if($("#shipStore")) $("#shipStore").textContent = storeName ? `é–€å¸‚: ${storeName}${storeId ? ` (${storeId})` : ""}` : "";

      // Logic: Hide COD if original was not 7-11
      if(ship.type !== "711") {
        const codTab = document.querySelector('.pill[data-pay="COD"]');
        if(codTab) codTab.style.display = "none";
        if(activePay === "COD") {
          activePay = "PAID";
          document.querySelector('.pill[data-pay="PAID"]')?.click();
        }
      }
    }catch(e){ setError("ç³»çµ±éŒ¯èª¤"); }
  }

  async function submitTail(){
  if(!tailInfo) return alert("è³‡æ–™å°šæœªè¼‰å…¥");

  const tailAmount = Math.round(Number(tailInfo.tail_amount || 0) || 0);
  if(tailAmount <= 0 && !confirm("å°¾æ¬¾é‡‘é¡ç‚º 0ï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ")) return;

  // âœ… è®€å–æœ¬æ¬¡æŠ˜æŠµï¼ˆè‹¥é é¢é‚„æ²’åŠ  inputï¼Œå°±ç•¶ 0ï¼‰
  const cuEl = document.getElementById("creditUsed");
  let credit_used = cuEl ? Math.floor(Math.max(0, Number(cuEl.value || 0) || 0)) : 0;

    if (credit_used > creditBalance) {
  return alert("è³¼ç‰©é‡‘é¤˜é¡ä¸è¶³");
}

  // âœ… å¾ shipping_info æŠ“ line_user_idï¼ˆå¾Œç«¯æ‰£è³¼ç‰©é‡‘ç”¨ï¼‰
  let line_user_id = "";
  try{
    const si = tailInfo.shipping_info || {};
    const shipInfo = (typeof si === "string") ? JSON.parse(si) : si;
    const line = shipInfo.line || shipInfo.line_profile || {};
    line_user_id = String(
      line.user_id || line.userId || line.LINE_USER_ID || shipInfo.line_user_id || ""
    ).trim();
  }catch(e){ line_user_id = ""; }

    const payable = Math.max(0, tailAmount - credit_used);

  // âœ… ç·šä¸Šä»˜æ¬¾ï¼šæŠ˜æŠµå¾Œä¸€å®šè¦ >= 1 å…ƒï¼ˆé¿å… 0 å…ƒä¹Ÿå»èµ°é‡‘æµï¼‰
  if (activePay === "PAID" && payable < 1) {
    return alert("ç·šä¸Šä»˜æ¬¾éœ€è‡³å°‘æ”¯ä»˜ 1 å…ƒï¼ˆæŠ˜æŠµå¾Œéœ€æ”¯ä»˜é‡‘é¡ä¸èƒ½ç‚º 0ï¼‰");
  }

  let payment_method = "";
  const extra = {};

  if(activePay === "COD") payment_method = "cod_711";
  else if(activePay === "PAID") {
    payment_method = (paidChannel==="card_inst")
      ? `paid_card_inst_${$("#instMonths").value}`
      : `paid_${paidChannel}`;
  }
  else if(activePay === "ATM") {
    const last5 = ($("#atmLast5").value||"").trim();
    if(!/^\d{5}$/.test(last5)) return alert("è«‹è¼¸å…¥ 5 ä½æ•¸å¸³è™Ÿå¾Œäº”ç¢¼");
    payment_method = "atm_full_tail";
    extra.atm_last5 = last5;
  }

  if(!payment_method) return alert("è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼");

  try{
    $("#submitBtn").disabled = true;

    // âœ… items_json åŠ ä¸Šã€ŒåŸè¨‚å–®ã€å‰ç¶´ï¼ˆå¾Œç«¯å¯ç”¨ä¾†é˜²é‡è¤‡å»ºå–®ï¼‰
    const prefix = `ã€åŸè¨‚å–® ${tailInfo.parent_order_id}ã€‘\n`;
    const baseItems = String(tailInfo.items_text || "");
    const items_json = baseItems.startsWith(prefix) ? baseItems : (prefix + baseItems);

    const payload = {
      parent_order_id: tailInfo.parent_order_id,
  items_json,
  tail_amount: tailAmount,      // åŸå°¾æ¬¾ï¼ˆçµ¦ä½ ç´€éŒ„ç”¨ï¼‰
  pay_amount: payable,          // âœ… å»ºè­°ï¼šå¯¦éš›éœ€æ”¯ä»˜ï¼ˆçµ¦é‡‘æµç”¨ï¼‰
  payment_method,
  shipping_info: tailInfo.shipping_info || {},
  credit_used,
  line_user_id
};
    if(extra.atm_last5) payload.atm_last5 = extra.atm_last5;

    const r = await fetch(`${API}/tail/checkout`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    if(!r.ok || !j.ok) throw new Error(j.message || j.error);

    const newOrderId = j.order_id;

    // Redirects
    if(payment_method.startsWith("paid_")){
      const pr = await fetch(`${API}/payuni/start`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ order_id: newOrderId })
      });
      const up = await pr.json();
      if(!up.ok) throw new Error(up.error);

      const f = document.createElement("form");
      f.method="POST";
      f.action=up.url;
      ["MerID","Version","EncryptInfo","HashInfo"].forEach(k=>{
        const i=document.createElement("input");
        i.type="hidden"; i.name=k; i.value=up[k];
        f.appendChild(i);
      });
      document.body.appendChild(f);
      f.submit();
      return;
    }

    alert("å°¾æ¬¾è¨‚å–®å·²å»ºç«‹ï¼");
    location.href = `/order-result.html?order_id=${encodeURIComponent(newOrderId)}&from=tail`;

  }catch(e){
    alert(e.message || "ç™¼ç”ŸéŒ¯èª¤");
    $("#submitBtn").disabled = false;
  }
}

  document.addEventListener("DOMContentLoaded", ()=>{
    initTabs();
    loadTailInfo();
    // âœ… ä»»ä½•æ™‚å€™æ”¹è³¼ç‰©é‡‘ï¼Œéƒ½åŒæ­¥æ›´æ–°å°¾æ¬¾é¡¯ç¤º
  document.getElementById("creditUsed")?.addEventListener("input", updateTailAmountUI);
document.getElementById("creditUsed")?.addEventListener("change", updateTailAmountUI);
    $("#submitBtn").addEventListener("click", submitTail);
    
    const btnCopy = $("#btnCopyAtm");
    if(btnCopy) btnCopy.onclick = () => {
      const txt = $("#atmAccount").textContent;
      navigator.clipboard.writeText(txt).then(()=>alert("å·²è¤‡è£½ï¼")).catch(()=>alert("è¤‡è£½å¤±æ•—"));
    };
  });
})();
</script>
</body>
</html>
