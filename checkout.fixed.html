<!doctype html>
<html lang="zh-Hant">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>結帳</title></head>
<body>
  <h1>結帳</h1>
  <div id="cart-items"></div>
  <div id="cart-total"></div>

  <div>
    <label for="payment_method">付款方式</label>
    <select id="payment_method">
      <option value="">— 請選擇 —</option>
      <option value="PAYUNI_ATM">銀行匯款 (虛擬帳號)</option>
      <option value="COD">7-11 貨到付款</option>
      <option value="PAYUNI_CREDIT">PAYUNi 信用卡 (一次付清)</option>
      <option value="PAYUNI_CREDIT_INST">PAYUNi 分期</option>
      <option value="LANGUAGE_INST">零角 分期</option>
    </select>
  </div>

  <button id="checkoutBtn">下一步：填寫物流</button>
  <p id="status"></p>

  <form id="paymentForm" method="POST" class="hidden" style="display:none;"></form>

<script>
const API_ENDPOINT = 'https://murain-api.smile650170703.workers.dev';
const urlParams = new URLSearchParams(window.location.search);
const CART_TOKEN = urlParams.get('cart_token');
let CURRENT_ORDER = null;

const status = document.getElementById('status');
const checkoutBtn = document.getElementById('checkoutBtn');
const paymentMethodSelect = document.getElementById('payment_method');

async function loadCart() {
  if (!CART_TOKEN) { status.textContent='錯誤：找不到購物車'; checkoutBtn.disabled=true; return; }
  try {
    const res = await fetch(`${API_ENDPOINT}/cart/${CART_TOKEN}`);
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    CURRENT_ORDER = data;
    const itemsDiv = document.getElementById('cart-items');
    const totalDiv = document.getElementById('cart-total');
    itemsDiv.innerHTML = '';
    if (!data.items || data.items.length === 0) {
      itemsDiv.innerHTML = '<p>您的購物車是空的</p>'; checkoutBtn.disabled = true;
    } else {
      data.items.forEach(item => {
        const div = document.createElement('div');
        div.textContent = `${item.name} — ${item.qty} x $${item.price || item.unit_price || 0}`;
        itemsDiv.appendChild(div);
      });
      totalDiv.textContent = `總計: $${data.total_amount || 0}`;
    }
    // allow checkout only for draft/pending/awaiting_deposit_proof
    const orderStatus = data.status;
    if (orderStatus === 'draft' || orderStatus === 'pending' || orderStatus === 'awaiting_deposit_proof') {
      checkoutBtn.disabled = false;
    } else {
      status.textContent = `此訂單無法結帳 (狀態: ${orderStatus})`; checkoutBtn.disabled = true;
    }
  } catch (e) {
    status.textContent = '載入失敗: ' + e.message;
    checkoutBtn.disabled = true;
  }
}

checkoutBtn.addEventListener('click', async () => {
  let payment_method = paymentMethodSelect.value;
  if (CURRENT_ORDER && CURRENT_ORDER.status === 'awaiting_deposit_proof') payment_method = 'DEPOSIT_COD';
  if (!payment_method) { status.textContent='請選擇付款方式'; return; }
  checkoutBtn.disabled = true; status.textContent = '建立訂單中...';
  try {
    if (payment_method === 'COD') {
      window.location.href = `shipping.html?cart_token=${CART_TOKEN}&method=COD`;
      return;
    } else if (payment_method === 'DEPOSIT_COD') {
      window.location.href = `shipping.html?cart_token=${CART_TOKEN}&method=DEPOSIT`;
      return;
    }
    const data = await apiPost('/checkout', { cart_token: CART_TOKEN, payment_method });
    if (data.submit_to && data.fields) {
      submitForm(data.submit_to, data.fields);
    } else if (data.submit_to) {
      window.location.href = data.submit_to;
    } else {
      if (data.order_url) window.location.href = data.order_url;
      else status.textContent = '結帳流程啟動完成，請依後端指引操作';
    }
  } catch (e) {
    status.textContent = '結帳失敗: ' + e.message;
    checkoutBtn.disabled = false;
  }
});

async function apiPost(endpoint, body) {
  const res = await fetch(`${API_ENDPOINT}${endpoint}`, {
    method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)
  });
  let data;
  try { data = await res.json(); } catch (e) { throw new Error(`伺服器錯誤: ${res.status}`); }
  if (data.error) throw new Error(data.error);
  return data;
}

function submitForm(actionUrl, fields) {
  const form = document.getElementById('paymentForm');
  form.action = actionUrl;
  form.innerHTML = '';
  for (const key in fields) {
    const input = document.createElement('input');
    input.type = 'hidden'; input.name = key; input.value = fields[key];
    form.appendChild(input);
  }
  form.style.display = 'block';
  form.submit();
}

loadCart();
</script>
</body>
</html>
