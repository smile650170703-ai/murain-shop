<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç›´æ’­ä¸»é–‹å–®</title>
<style>
  :root { --bg:#f7f7f8; --card:#fff; --txt:#222; --muted:#6b7280; --pri:#111; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Noto Sans TC, sans-serif; background:var(--bg); color:var(--txt); }
  .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
  .card { background:var(--card); border-radius: 12px; box-shadow: 0 10px 20px rgba(0,0,0,.05);
          padding: 20px; margin-bottom: 18px; }
  h2 { margin: 0 0 12px; font-size: 20px; }
  .row { display:flex; gap:10px; flex-wrap:wrap; }
  .row > * { flex: 1 1 220px; }
  input, select, button, textarea {
    width: 100%; box-sizing: border-box; padding: 10px 12px; border-radius: 10px; border:1px solid #e5e7eb; font-size: 15px;
  }
  button { background:#111; color:#fff; cursor:pointer; border:none; }
  button.ghost { background:#fff; color:#111; border:1px solid #e5e7eb; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .muted { color: var(--muted); font-size: 13px; }
  .hidden { display:none !important; }
  .list { margin: 8px 0 0; padding:0; list-style:none; }
  .list li { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #eee; }
  .right { text-align:right; }
  .grid2 { display:grid; grid-template-columns: 1fr auto; gap:10px; align-items: center; }
</style>
<script>window.API_BASE = "https://api.murain.tw";</script>
  <meta name="robots" content="noindex, nofollow">
</head>
<body>
<div class="wrap">

  <!-- ç™»å…¥ -->
  <div class="card" id="card-login">
    <h2>ä¸»æ’­é–‹å–®ç™»å…¥</h2>
    <div class="row">
      <div style="flex:2">
        <label class="muted">OP å¯†ç¢¼</label>
        <input id="op_key" class="mono" placeholder="è¼¸å…¥ OP Key" />
      </div>
      <div style="align-self:end; flex:1">
        <button id="btn-login">ç™»å…¥</button>
      </div>
    </div>
    <div class="muted" style="margin-top:6px">æˆåŠŸå¾Œæœƒç·©å­˜æ–¼æ­¤è£ç½®ï¼Œé—œé–‰è¦–çª—å¾Œéœ€é‡æ–°ç™»å…¥ã€‚</div>
  </div>

  <!-- é–‹å–® -->
  <div class="card hidden" id="card-app">
    <h2>å»ºç«‹è³¼ç‰©è»Š</h2>
    <div class="row">
      <div style="flex:2">
        <label class="muted">ä¸»æ’­åç¨±</label>
        <input id="streamer" placeholder="ä¾‹å¦‚ï¼šå°æ²" />
      </div>
      <div style="flex:1">
        <label class="muted">å®¢ç¾¤</label>
        <select id="customer_type">
          <option value="live">ç›´æ’­</option>
          <option value="regular">ä¸€èˆ¬</option>
        </select>
      </div>
      <div style="flex:1; align-self:end">
        <button id="btn-create">å»ºç«‹</button>
      </div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <div class="muted">CartTokenï¼š<span id="cart_token" class="mono muted">å°šæœªå»ºç«‹</span></div>
      <button class="ghost" id="btn-refresh">é‡æ•´æ¸…å–®</button>
    </div>
  </div>

  <!-- åŠ å•†å“ -->
  <div class="card hidden" id="card-add">
    <h2>åŠ å…¥å•†å“</h2>
    <div class="row">
      <div><label class="muted">SKU</label><input id="sku" class="mono" placeholder="AA001..." /></div>
      <div style="max-width:130px"><label class="muted">æ•¸é‡</label><input id="qty" value="1" /></div>
      <div><label class="muted">æ”¹åƒ¹</label><input id="override_price" placeholder="å¯ç•™ç©º" /></div>
      <div style="align-self:end"><button id="btn-add">åŠ å…¥</button></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="ghost" id="btn-50" style="max-width:120px">-50</button>
      <button class="ghost" id="btn-100" style="max-width:120px">-100</button>
      <button class="ghost" id="btn-999" style="max-width:120px">ç‰¹åƒ¹ 999</button>
    </div>
    <div class="row" style="margin-top:10px">
      <div style="flex:3"><input id="note" placeholder="å‚™è¨» / è´ˆå“èªªæ˜" /></div>
      <div style="flex:1"><button class="ghost" id="btn-note">å„²å­˜å‚™è¨»</button></div>
    </div>
  </div>

   <!-- çµå¸³ & æ¸…å–® -->
  <div class="card hidden" id="card-list">
    <h2>ç”¢ç”Ÿçµå¸³é€£çµ</h2>

    <!-- ä¸Šé¢é€™æ’æŒ‰éˆ•ï¼šåªè™•ç†ä¸»æ’­è‡ªå·±ç”¨çš„è¤‡è£½ -->
    <div class="row">
      <button id="btn-link" class="ghost">è¤‡è£½çµå¸³é€£çµ</button>
    </div>

    <input id="link_out" class="mono" readonly style="margin-top:10px" />

    <!-- æ–°å¢ï¼šè²¼å®¢äººçš„ LineUserId + ä¸€éµç™¼å¡ç‰‡ -->
    <div class="row" style="margin-top:10px">
      <input id="line_user_id" placeholder="è²¼ä¸Šå®¢äººçš„ LineUserIdï¼ˆå¾ LineMembers è¤‡è£½ï¼‰" />
      <button id="btn-send-link" class="ghost">å¾å®˜æ–¹ LINE ç™¼çµå¸³å¡ç‰‡</button>
    </div>
  </div>
    <textarea
      id="line_msg"
      rows="4"
      class="mono"
      readonly
      style="margin-top:8px"
      placeholder="é€™è£¡æœƒè‡ªå‹•ç”¢ç”Ÿè¦è²¼çµ¦å®¢äººçš„è¨Šæ¯"
    ></textarea>

    <ul id="items" class="list"></ul>
    <div class="grid2" style="margin-top:8px">
      <div class="muted">åˆè¨ˆ</div>
      <div class="right mono" id="total">NT$ 0</div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="ghost" id="btn-clear">æ¸…ç©ºè³¼ç‰©è»Šï¼ˆéœ€ OPï¼‰</button>
    </div>
  </div>

</div>

<script>
(async function () {
  const API = window.API_BASE;
  const $  = (s)=>document.querySelector(s);

  let OP = '';
  let CART = '';

  // ---------- helpers ----------
  async function jfetch(url, opt) {
    const r = await fetch(url, Object.assign({headers:{'content-type':'application/json'}}, opt||{}));
    const txt = await r.text();
    try { return JSON.parse(txt); } catch { return {raw:txt}; }
  }
  function money(n){ n = +n||0; return 'NT$ ' + n.toLocaleString(); }
  function guardCart(){ if(!CART){ alert('è«‹å…ˆå»ºç«‹è³¼ç‰©è»Š'); return false; } return true; }
  function setLoginUI(on){
    $('#card-login').classList.toggle('hidden', !!on);
    $('#card-app').classList.toggle('hidden', !on);
    $('#card-add').classList.toggle('hidden', !on);
    $('#card-list').classList.toggle('hidden', !on);
  }
  function setCartToken(t) {
    CART = t||'';
    $('#cart_token').textContent = t||'å°šæœªå»ºç«‹';
    $('#btn-clear').disabled = !OP;
  }

  // ---------- actions ----------
  async function doLogin() {
    const v = ($('#op_key').value||'').trim();
    if(!v) return alert('è«‹è¼¸å…¥ OP Key');
    const res = await jfetch(API+'/op/auth', { method:'POST', body: JSON.stringify({ op_key: v }) });
    if(!res || res.ok!==true) return alert('OP Key éŒ¯èª¤');
    OP = v; localStorage.setItem('OP_KEY', v);
    setLoginUI(true);
  }

  async function createCart() {
    const streamer = ($('#streamer').value||'').trim();
    const customer_type = $('#customer_type').value || 'live';
    const res = await jfetch(API+'/cart/create', { method:'POST', body: JSON.stringify({ streamer_name: streamer||'æœªå‘½å', customer_type }) });
    if(!res.ok) return alert('å»ºç«‹å¤±æ•—ï¼š'+(res.error||''));
    setCartToken(res.cart_token);
    await refreshList();
  }

  async function addItem() {
    if(!guardCart()) return;
    const sku = ($('#sku').value||'').trim();
    const qty = parseInt($('#qty').value||'1',10)||1;
    const price = ($('#override_price').value||'').trim();
    const body = { cart_token: CART, sku, qty };
    if(price) { body.price = parseInt(price,10)||0; body.op_key = OP; }
    const res = await jfetch(API+'/cart/add', { method:'POST', body: JSON.stringify(body) });
    if(!res.ok) return alert('åŠ å…¥å¤±æ•—ï¼š'+(res.error||''));
    $('#sku').value='';
    await refreshList();
  }

  async function saveNote() {
    if(!guardCart()) return;
    const note = $('#note').value||'';
    const res = await jfetch(API+'/cart/note', { method:'POST', body: JSON.stringify({ cart_token: CART, note, op_key: OP })});
    if(!res.ok) return alert('å‚™è¨»å¤±æ•—ï¼š'+(res.error||''));
    alert('å·²å„²å­˜å‚™è¨»');
  }

  async function refreshList() {
    if(!guardCart()) return;
    const res = await jfetch(API+'/cart/'+encodeURIComponent(CART));
    const list = res.items||[];
    const ul = $('#items'); ul.innerHTML='';
    let sum = 0;
    list.forEach(it=>{
      sum += (+it.price||0) * (+it.qty||0);
      const li = document.createElement('li');
      li.innerHTML = `<span class="mono">${it.sku}</span><span class="mono right">${it.qty} Ã— ${money(it.price||0)}</span>`;
      ul.appendChild(li);
    });
    $('#total').textContent = money(sum);
  }

  async function clearCart() {
    if(!guardCart()) return;
    if(!OP) return alert('éœ€è¦ OP æ‰èƒ½æ¸…ç©º');
    if(!confirm('ç¢ºå®šæ¸…ç©ºæ•´å€‹è³¼ç‰©è»Šï¼Ÿ')) return;
    const res = await jfetch(API+'/cart/clear', { method:'POST', body: JSON.stringify({cart_token:CART, op_key:OP}) });
    if(!res.ok) return alert('æ¸…ç©ºå¤±æ•—ï¼š'+(res.error||''));
    await refreshList();
  }

  // å…±ç”¨ï¼šç”¢ç”Ÿé€™ä¸€è»Šçš„çµå¸³ç¶²å€
function buildCheckoutUrl() {
  const LIFF_CHECKOUT_URL = 'https://liff.line.me/2008430261-KLwoQjm4';
  return `${LIFF_CHECKOUT_URL}?cart_token=${encodeURIComponent(CART)}`;
}

async function linkCheckout() {
    if (!guardCart()) return;
    const url = buildCheckoutUrl();
    $('#link_out').value = url;
    $('#link_out').select();
    document.execCommand('copy');
    alert('å·²è¤‡è£½çµå¸³é€£çµ');
  }

  // â˜… æ–°å¢ï¼šå‘¼å«å¾Œç«¯ï¼Œè«‹å®˜æ–¹ LINE å¹«ä½ ç™¼ Flex å¡ç‰‡
  async function sendCheckoutLinkByLine() {
    if (!guardCart()) return;
    if (!OP) return alert('è«‹å…ˆç™»å…¥ OP Key');

    const lineUserId = ($('#line_user_id').value || '').trim();
    if (!lineUserId) return alert('è«‹å…ˆè²¼ä¸Šå®¢äººçš„ LineUserId');

    const res = await jfetch(API + '/op/cart/send-link', {
      method: 'POST',
      body: JSON.stringify({
        op_key: OP,
        cart_token: CART,
        line_user_id: lineUserId
      })
    });

    if (!res || res.ok !== true) {
      console.log('send-link error', res);
      return alert('ç™¼é€å¤±æ•—ï¼š' + (res && res.error || 'unknown'));
    }

    alert('å·²å¾å®˜æ–¹ LINE ç™¼é€çµå¸³å¡ç‰‡');
  }

// æ–°å¢ï¼šè¤‡è£½ä¸€æ•´æ®µè¦è²¼çµ¦å®¢äººçš„ LINE è¨Šæ¯
function copyLineMessage() {
  if (!guardCart()) return;

  const url = buildCheckoutUrl();
  const totalText = $('#total') ? $('#total').textContent.trim() : '';

  const msgLines = [
    'è¦ªæ„›çš„å¯¶å¯¶æ‚¨å¥½ï¼Œé€™æ˜¯æ‚¨çš„å°ˆå±¬çµå¸³é€£çµï¼š',
    url,
    '',
    totalText ? `æœ¬æ¬¡çµå¸³é‡‘é¡ï¼š${totalText}` : '',
    'è«‹åœ¨ 10 åˆ†é˜å…§å®Œæˆå¡«å¯«èˆ‡é€å‡ºï¼Œå¦‚éœ€èª¿æ•´å¯ä»¥ç›´æ¥å›è¦†æ­¤è¨Šæ¯å–”ğŸ’–'
  ].filter(Boolean);

  const msg = msgLines.join('\n');

  const ta = $('#line_msg');
  if (ta) ta.value = msg;

  // ç›´æ¥è¤‡è£½åˆ°å‰ªè²¼ç°¿
  (ta || $('#link_out')).value = msg;
  (ta || $('#link_out')).select();
  document.execCommand('copy');
  alert('å·²è¤‡è£½ LINE è¨Šæ¯');
}


  // ---------- quick-price ----------
  const quick = { '#btn-50': -50, '#btn-100': -100, '#btn-999': 999 };
  function applyQuick(v){
    const cur = parseInt($('#override_price').value||'0',10)||0;
    if(v===999) { $('#override_price').value = '999'; return; }
    $('#override_price').value = String(Math.max(0, cur + v));
  }

  // ---------- init ----------
  window.addEventListener('DOMContentLoaded', async ()=>{
    // ç¶å®šäº‹ä»¶ï¼ˆç¢ºä¿ã€Œç™»å…¥éµæœ‰åæ‡‰ã€ï¼‰
    $('#btn-login').addEventListener('click', doLogin);
    $('#btn-create').addEventListener('click', createCart);
    $('#btn-add').addEventListener('click', addItem);
    $('#btn-note').addEventListener('click', saveNote);
    $('#btn-refresh').addEventListener('click', refreshList);
    $('#btn-clear').addEventListener('click', clearCart);
    $('#btn-link').addEventListener('click', linkCheckout);
     const btnLineMsg = $('#btn-link-msg');
    if (btnLineMsg) btnLineMsg.addEventListener('click', copyLineMessage);
    Object.keys(quick).forEach(sel=>{
      const v = quick[sel];
      document.querySelector(sel).addEventListener('click', ()=>applyQuick(v));
    });

    // è‡ªå‹•å¸¶å› OPï¼ˆè‹¥æœ‰å­˜ï¼‰
    const saved = localStorage.getItem('OP_KEY');
    if(saved) { $('#op_key').value = saved; OP = saved; setLoginUI(true); }
  });
})();
</script>
</body>
</html>
