<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>直播主開單（v5.1）</title>
  <script>window.API_BASE="https://murain.tw/api";</script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f6f7fb;margin:0;color:#111}
    .wrap{max-width:800px;margin:20px auto;padding:0 14px}
    h1{font-size:22px;margin:0 0 12px 0}
    .card{background:#fff;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:16px 16px 18px;margin:12px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,select,button{padding:10px 12px;border-radius:10px;border:1px solid #dcdde3;background:#fff}
    button{background:#0d63ff;color:#fff;border:0;cursor:pointer}
    .btn-dim{background:#111}
    .muted{color:#666}
    .mono{font-family:ui-monospace,Consolas,monospace}
    #op_gate{position:fixed;inset:0;background:#f5f6fa;display:flex;align-items:center;justify-content:center;z-index:9999}
  </style>
</head>
<body>
  <div id="op_gate">
    <div style="background:#fff;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.12);padding:24px; width:min(92vw,380px)">
      <h3 style="margin:0 0 12px 0">主播開單登入</h3>
      <input id="op_gate_key" type="password" placeholder="OP Key" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:10px">
      <button id="op_gate_go" style="margin-top:10px;width:100%;padding:12px;border:0;border-radius:10px;background:#111;color:#fff;cursor:pointer">進入</button>
      <div id="op_gate_msg" style="margin-top:8px;color:#b00;font-size:.9rem"></div>
    </div>
  </div>

  <div class="wrap">
    <h1>直播主開單系統（v5.1）</h1>

    <div class="card">
      <div class="row">
        <input id="streamer" placeholder="輸入直播主名稱（必填）" style="flex:1">
      </div>
      <div class="row">
        <button id="btn-new" class="btn-dim">建立購物車</button>
        <span id="cartinfo" class="muted"></span>
      </div>
    </div>

    <div class="card">
      <h3>1. 加入商品</h3>
      <div class="row">
        <input id="sku" placeholder="商品 Barcode" style="flex:1">
        <input id="qty" type="number" value="1" style="max-width:100px">
        <input id="opkey" placeholder="主播密碼（OP Key）">
      </div>
      <div class="row">
        <button id="btn-add">2. 加入商品</button>
        <button id="btn-50" class="btn-dim">-50</button>
        <button id="btn-100" class="btn-dim">-100</button>
        <button id="btn-999" class="btn-dim">特價999</button>
        <input id="override" type="number" placeholder="改後單價（選填）" style="max-width:140px">
      </div>
      <div class="row">
        <select id="gift">
          <option value="">（選擇常用贈品）</option>
          <option>贈 保養試用包</option><option>贈 眼罩</option><option>贈 免運券</option>
        </select>
        <input id="gift_custom" placeholder="自訂贈品文字">
        <button id="add_gift" class="btn-dim">加入贈品到備註</button>
      </div>
      <div class="row"><textarea id="note" rows="3" placeholder="備註（贈品或其他說明）" style="flex:1;border-radius:10px;border:1px solid #dcdde3;padding:10px"></textarea></div>
      <div class="row"><button id="save_note" class="btn-dim">儲存備註</button></div>
    </div>

    <div class="card">
      <h3>2. 產生結帳連結</h3>
      <div class="row">
        <button id="btn-bank" class="btn-dim">新客匯款</button>
        <button id="btn-cod"  class="btn-dim">老客 7-11 COD / 其他金流</button>
      </div>
      <div class="row">
        <input id="checkout" class="mono" readonly style="flex:1">
        <button id="copy" class="btn-dim">複製連結</button>
      </div>
    </div>

    <div class="card">
      <h3>購物車內容</h3>
      <div id="items" class="mono"></div>
      <div class="muted" id="total"></div>
    </div>
  </div>

<script>
const API = (window.API_BASE || '').replace(/\/+$/,'');
let CART_TOKEN = '';

function setOPKey(v){ try{ localStorage.setItem('OP_KEY', v||''); }catch(_){} }
function getOPKey(){ try{ return localStorage.getItem('OP_KEY')||''; }catch(_){ return '' } }

async function opGateTry(){
  const k = (document.getElementById('op_gate_key').value || '').trim();
  if(!k){ document.getElementById('op_gate_msg').textContent='請輸入 OP Key'; return; }
  const r = await fetch(API + '/op/auth', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ key:k }) });
  if(r.ok){ setOPKey(k); document.getElementById('opkey').value=k; document.getElementById('op_gate').style.display='none'; }
  else{ document.getElementById('op_gate_msg').textContent='OP Key 錯誤'; }
}
document.getElementById('op_gate_go').onclick = opGateTry;
document.getElementById('op_gate_key').addEventListener('keydown', e=>{ if(e.key==='Enter') opGateTry(); });
(async ()=>{ const k=getOPKey(); if(k){ const r=await fetch(API+'/op/auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key:k})}); if(r.ok){ document.getElementById('op_gate').style.display='none'; document.getElementById('opkey').value=k; } } })();

function renderItems(list){
  const el = document.getElementById('items');
  if(!list || !list.length){ el.textContent='（空）'; return; }
  el.innerHTML = list.map(i=>`${i.sku} x${i.qty} — ${i.name} @ ${i.price}`).join('\\n');
}
function setTotal(n){ document.getElementById('total').textContent = '總額：NT$ ' + (n||0); }
async function refresh(){
  if(!CART_TOKEN) return;
  const r = await fetch(API+'/cart/'+CART_TOKEN);
  const d = await r.json();
  renderItems(d.items||[]); setTotal(d.total||0);
}
async function ensureCart(){
  if(CART_TOKEN) return;
  const name = (document.getElementById('streamer').value||'').trim();
  if(!name) return alert('請輸入直播主名稱');
  const r = await fetch(API+'/cart/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({streamer_name:name,customer_type:'live'})});
  const d = await r.json(); CART_TOKEN = d.cart_token; document.getElementById('cartinfo').textContent = '購物車：'+d.order_id;
}
document.getElementById('btn-new').onclick = ensureCart;

async function addItem(withOverride=null){
  await ensureCart();
  if(!CART_TOKEN) return;
  const sku = document.getElementById('sku').value.trim(); if(!sku) return alert('請輸入 Barcode');
  const qty = parseInt(document.getElementById('qty').value||'1',10)||1;
  const opk = document.getElementById('opkey').value.trim();
  const body = { cart_token:CART_TOKEN, sku, qty, op_key: opk };
  if(withOverride!==null) body.price = withOverride;
  const r = await fetch(API+'/cart/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  const d = await r.json();
  if(!r.ok){ alert(JSON.stringify(d)); return; }
  renderItems(d.items||[]); setTotal(d.total||0);
}
document.getElementById('btn-add').onclick = ()=> addItem( document.getElementById('override').value? parseInt(document.getElementById('override').value,10): null );
document.getElementById('btn-50').onclick  = async ()=>{
  const sku = document.getElementById('sku').value.trim(); if(!sku) return alert('先輸入 Barcode');
  const r = await fetch(API+'/product/'+encodeURIComponent(sku)); const d = await r.json();
  const p = (d.product && d.product.price) || 0; document.getElementById('override').value = Math.max(0, p-50); await addItem(parseInt(document.getElementById('override').value,10));
};
document.getElementById('btn-100').onclick  = async ()=>{
  const sku = document.getElementById('sku').value.trim(); if(!sku) return alert('先輸入 Barcode');
  const r = await fetch(API+'/product/'+encodeURIComponent(sku)); const d = await r.json();
  const p = (d.product && d.product.price) || 0; document.getElementById('override').value = Math.max(0, p-100); await addItem(parseInt(document.getElementById('override').value,10));
};
document.getElementById('btn-999').onclick = ()=>{ document.getElementById('override').value=999; addItem(999); };

document.getElementById('add_gift').onclick = ()=>{
  const sel = document.getElementById('gift').value || '';
  const cus = document.getElementById('gift_custom').value || '';
  const txt = (sel && cus) ? (sel + '、' + cus) : (sel || cus);
  document.getElementById('note').value = (document.getElementById('note').value || '') + (txt? ('\\n' + txt):'');
};
document.getElementById('save_note').onclick = async ()=>{
  if(!CART_TOKEN) return alert('請先建立購物車');
  const r = await fetch(API+'/cart/note',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({cart_token:CART_TOKEN,note:document.getElementById('note').value||''})});
  alert(r.ok ? '已儲存' : '失敗');
};

function setCheckoutLink(u){ document.getElementById('checkout').value = u||''; }
async function makeCheckout(type){
  if(!CART_TOKEN) return alert('請先建立購物車');
  const r = await fetch(API+'/checkout',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({cart_token:CART_TOKEN,payment_method:type,shipping:{}})});
  const d = await r.json();
  if(!r.ok){ alert(JSON.stringify(d)); return; }
  const base = location.origin.replace(/\/+$/,''); setCheckoutLink(`${base}/checkout.html?cart_token=${encodeURIComponent(CART_TOKEN)}`);
}
document.getElementById('btn-bank').onclick = ()=> makeCheckout('bank_transfer');
document.getElementById('btn-cod').onclick  = ()=> makeCheckout('cod_711');
document.getElementById('copy').onclick = ()=>{ const el=document.getElementById('checkout'); el.select(); document.execCommand('copy'); };
</script>
</body>
</html>
