<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç›´æ’­ä¸»é–‹å–®</title>
<style>
  :root { --bg:#f7f7f8; --card:#fff; --txt:#222; --muted:#6b7280; --pri:#111; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Noto Sans TC, sans-serif; background:var(--bg); color:var(--txt); }
  .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
  .card { background:var(--card); border-radius: 12px; box-shadow: 0 10px 20px rgba(0,0,0,.05);
          padding: 20px; margin-bottom: 18px; }
  h2 { margin: 0 0 12px; font-size: 20px; }
  .row { display:flex; gap:10px; flex-wrap:wrap; }
  .row > * { flex: 1 1 220px; }
  input, select, button, textarea {
    width: 100%; box-sizing: border-box; padding: 10px 12px; border-radius: 10px; border:1px solid #e5e7eb; font-size: 15px;
  }
  button { background:#111; color:#fff; cursor:pointer; border:none; }
  button.ghost { background:#fff; color:#111; border:1px solid #e5e7eb; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .muted { color: var(--muted); font-size: 13px; }
  .hidden { display:none !important; }
  .list { margin: 8px 0 0; padding:0; list-style:none; }
  .list li { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #eee; }
  .right { text-align:right; }
  .grid2 { display:grid; grid-template-columns: 1fr auto; gap:10px; align-items: center; }
</style>
<script>window.API_BASE = "https://api.murain.tw";</script>
  <meta name="robots" content="noindex, nofollow">
</head>
<body>
<div class="wrap">

  <!-- ç™»å…¥ -->
  <div class="card" id="card-login">
    <h2>ä¸»æ’­é–‹å–®ç™»å…¥</h2>
    <div class="row">
      <div style="flex:2">
        <label class="muted">OP å¯†ç¢¼</label>
        <input id="op_key" class="mono" placeholder="è¼¸å…¥ OP Key" />
      </div>
      <div style="align-self:end; flex:1">
        <button id="btn-login">ç™»å…¥</button>
      </div>
    </div>
    <div class="muted" style="margin-top:6px">æˆåŠŸå¾Œæœƒç·©å­˜æ–¼æ­¤è£ç½®ï¼Œé—œé–‰è¦–çª—å¾Œéœ€é‡æ–°ç™»å…¥ã€‚</div>
  </div>

  <!-- é–‹å–® -->
  <div class="card hidden" id="card-app">
    <h2>å»ºç«‹è³¼ç‰©è»Š</h2>
    <div class="row">
      <div style="flex:2">
        <label class="muted">ä¸»æ’­åç¨±</label>
        <input id="streamer" placeholder="ä¾‹å¦‚ï¼šå°æ²" />
      </div>
      <div style="flex:1">
        <label class="muted">å®¢ç¾¤</label>
        <select id="customer_type">
          <option value="live">ç›´æ’­</option>
          <option value="regular">ä¸€èˆ¬</option>
        </select>
      </div>
      <div style="flex:1; align-self:end">
        <button id="btn-create">å»ºç«‹</button>
      </div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <div class="muted">CartTokenï¼š<span id="cart_token" class="mono muted">å°šæœªå»ºç«‹</span></div>
      <button class="ghost" id="btn-refresh">é‡æ•´æ¸…å–®</button>
    </div>
  </div>

  <!-- åŠ å•†å“ -->
  <div class="card hidden" id="card-add">
    <h2>åŠ å…¥å•†å“</h2>
    <div class="row">
      <div><label class="muted">SKU</label><input id="sku" class="mono" placeholder="AA001..." /></div>
      <div style="max-width:130px"><label class="muted">æ•¸é‡</label><input id="qty" value="1" /></div>
      <div><label class="muted">æ”¹åƒ¹</label><input id="override_price" placeholder="å¯ç•™ç©º" /></div>
      <div style="align-self:end"><button id="btn-add">åŠ å…¥</button></div>
    </div>
    <div class="row hidden" style="margin-top:8px">
      <button class="ghost" id="btn-50" style="max-width:120px">-50</button>
      <button class="ghost" id="btn-100" style="max-width:120px">-100</button>
      <button class="ghost" id="btn-999" style="max-width:120px">ç‰¹åƒ¹ 999</button>
    </div>
    <div class="row hidden" style="margin-top:10px">
      <div style="flex:3"><input id="note" placeholder="å‚™è¨» / è´ˆå“èªªæ˜" /></div>
      <div style="flex:1"><button class="ghost" id="btn-note">å„²å­˜å‚™è¨»</button></div>
    </div>
  </div>

   <!-- çµå¸³ & æ¸…å–® -->
  <div class="card hidden" id="card-list">
    <h2>ç”¢ç”Ÿçµå¸³é€£çµ</h2>

    <!-- ä¸Šé¢é€™æ’æŒ‰éˆ•ï¼šåªè™•ç†ä¸»æ’­è‡ªå·±ç”¨çš„è¤‡è£½ -->
    <div class="row">
      <button id="btn-link" class="ghost">è¤‡è£½çµå¸³é€£çµ</button>
    </div>

    <input id="link_out" class="mono" readonly style="margin-top:10px" />
     <!-- â˜… æ–°å¢ï¼šè¼¸å…¥ LINE åç¨± / æœ¬å ä¾†æœå°‹ -->
    <div class="row" style="margin-top:10px">
      <input
        id="line_search_name"
        placeholder="è¼¸å…¥å®¢äººçš„ LINE åç¨±æˆ–æœ¬åï¼ˆå®Œå…¨ä¸€æ¨£çš„å­—ï¼‰"
      />
      <button id="btn-search-line" class="ghost">æŸ¥è©¢æœƒå“¡</button>
    </div>
    <div class="muted" id="line_search_info" style="margin-top:4px"></div>
    <div class="muted" id="cartmap_info" style="margin-top:4px"></div>

    <!-- æ–°å¢ï¼šè²¼å®¢äººçš„ LineUserId + ä¸€éµç™¼å¡ç‰‡ -->
    <div class="row" style="margin-top:10px">
      <input id="line_user_id" placeholder="è²¼ä¸Šå®¢äººçš„ LineUserIdï¼ˆå¾ LineMembers è¤‡è£½ï¼‰" />
      <button id="btn-send-link" class="ghost">å¾å®˜æ–¹ LINE ç™¼çµå¸³å¡ç‰‡</button>
    </div>
    <textarea
      id="line_msg"
      rows="4"
      class="mono"
      readonly
      style="margin-top:8px; position:absolute; left:-9999px; top:-9999px; width:1px; height:1px; opacity:0;"
      placeholder="é€™è£¡æœƒè‡ªå‹•ç”¢ç”Ÿè¦è²¼çµ¦å®¢äººçš„è¨Šæ¯"
    ></textarea>

    <ul id="items" class="list"></ul>
    <div class="grid2" style="margin-top:8px">
      <div class="muted">åˆè¨ˆ</div>
      <div class="right mono" id="total">NT$ 0</div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="ghost" id="btn-clear">æ¸…ç©ºè³¼ç‰©è»Šï¼ˆéœ€ OPï¼‰</button>
      </div>
      <!-- ====== è³¼ç‰©è»Šç®¡ç†ï¼ˆæœå°‹ / æŸ¥çœ‹ / æ¸…é™¤ï¼‰ ====== -->
<section id="cartAdminBlock" style="margin-top:18px;">
  <div style="display:flex; gap:14px; align-items:flex-start; flex-wrap:wrap;">

    <div style="min-width:280px; flex:0 0 320px;">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
        <div style="flex:1;">
          <div style="font-size:12px; opacity:.8; margin-bottom:6px;">Admin Key</div>
          <input id="adminKey" placeholder="Admin Key" style="width:100%; padding:10px;" />
        </div>
        <div style="flex:1;">
          <div style="font-size:12px; opacity:.8; margin-bottom:6px;">OP Keyï¼ˆåŠ è³¼/ç§»é™¤/æ¸…ç©ºç”¨ï¼‰</div>
          <input id="opKey" type="password" placeholder="OP Key" style="width:100%; padding:10px;" />
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
        <button id="btnListOpen">æœå°‹æœªçµå–®è³¼ç‰©è»Š</button>
        <button id="btnClearCart">æ¸…ç©ºè³¼ç‰©è»Šï¼ˆéœ€OPï¼‰</button>
      </div>

      <div style="margin-top:12px; font-size:12px; opacity:.8;">æœªçµå–®è³¼ç‰©è»Š</div>
      <div id="openCartList" style="margin-top:8px;"></div>
    </div>

    <div style="flex:1; min-width:360px;">
      <div style="font-size:12px; opacity:.8;">ç›®å‰é¸æ“‡ cart_token</div>
      <input id="selectedCartToken" readonly style="width:100%; padding:10px; margin-top:6px;" />

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
        <input id="addSku" placeholder="SKU" style="width:140px; padding:10px;" />
        <input id="addQty" type="number" value="1" min="1" placeholder="Qty" style="width:100px; padding:10px;" />
        <input id="addPrice" type="number" placeholder="Price(å¯ç•™ç©º)" style="width:140px; padding:10px;" />
        <button id="btnAddItem">åŠ è³¼</button>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <input id="rmSku" placeholder="è¦ç§»é™¤çš„ SKU" style="width:220px; padding:10px;" />
        <button id="btnRemoveItem">ç§»é™¤</button>
        <button id="btnReloadCart">é‡æ–°è¼‰å…¥</button>
      </div>

      <div style="margin-top:12px; font-size:12px; opacity:.8;">è³¼ç‰©è»Šå…§å®¹</div>
      <textarea id="cartJsonView" style="width:100%; height:220px; padding:10px; margin-top:6px;"></textarea>
    </div>

  </div>
</section>
<script>
(async function () {
  const API = window.API_BASE;
  const $  = (s)=>document.querySelector(s);

  let OP = '';
  let CART = '';

  // ---------- helpers ----------
  async function jfetch(url, opt) {
    const r = await fetch(url, Object.assign({headers:{'content-type':'application/json'}}, opt||{}));
    const txt = await r.text();
    try { return JSON.parse(txt); } catch { return {raw:txt}; }
  }
  function money(n){ n = +n||0; return 'NT$ ' + n.toLocaleString(); }
  function guardCart(){ if(!CART){ alert('è«‹å…ˆå»ºç«‹è³¼ç‰©è»Š'); return false; } return true; }
  function setLoginUI(on){
    $('#card-login').classList.toggle('hidden', !!on);
    $('#card-app').classList.toggle('hidden', !on);
    $('#card-add').classList.toggle('hidden', !on);
    $('#card-list').classList.toggle('hidden', !on);
  }
  function setCartToken(t) {
    CART = t||'';
    $('#cart_token').textContent = t||'å°šæœªå»ºç«‹';
    $('#btn-clear').disabled = !OP;
    try { rememberCartForUser(CART); } catch(e) {}
  }

  // ====== â˜… å®¢äººè³¼ç‰©è»Šè¨˜æ†¶ï¼ˆåªå­˜åœ¨é€™å° OP è£ç½®çš„ localStorageï¼‰ ======
  const CART_MAP_KEY = 'OP_CART_MAP_V1';
  function loadCartMap() {
    try { return JSON.parse(localStorage.getItem(CART_MAP_KEY) || '{}'); } catch(e) { return {}; }
  }
  function saveCartMap(map) {
    try { localStorage.setItem(CART_MAP_KEY, JSON.stringify(map || {})); } catch(e) {}
  }
  function getLineUserId() {
    return ($('#line_user_id') && ($('#line_user_id').value || '').trim()) || '';
  }
  function getCustomerName() {
  // ä½ ç›®å‰å”¯ä¸€æœ‰ã€Œåå­—è¼¸å…¥ã€çš„æ¬„ä½å°±æ˜¯ #line_search_name
  // ç”¨å®ƒç•¶ customer_nameï¼ˆæœ‰æŸ¥æœƒå“¡æˆåŠŸæ™‚ï¼Œæˆ‘å€‘ç¬¬ 3 æ­¥æœƒè‡ªå‹•æŠŠå®ƒæ”¹æˆæ­£ç¢ºåå­—ï¼‰
  return ($('#line_search_name') && ($('#line_search_name').value || '').trim()) || '';
}
  function setCartMapInfo(txt) {
    const el = $('#cartmap_info');
    if (el) el.textContent = txt || '';
  }
  function rememberCartForUser(cartToken) {
    const uid = getLineUserId();
    if (!uid || !cartToken) return;
    const map = loadCartMap();
    map[uid] = { cart_token: String(cartToken), updatedAt: Date.now() };
    saveCartMap(map);
    setCartMapInfo(`å·²è¨˜ä½æ­¤å®¢äººè³¼ç‰©è»Šï¼š${String(cartToken)}`);
  }
  async function loadCartForUser() {
    const uid = getLineUserId();
    if (!uid) return alert('è«‹å…ˆè²¼ä¸Š/æŸ¥åˆ°å®¢äººçš„ LineUserId');
    const map = loadCartMap();
    const rec = map[uid];
    if (!rec || !rec.cart_token) return alert('é€™ä½å®¢äººç›®å‰æ²’æœ‰è¢«è¨˜ä½çš„è³¼ç‰©è»Šï¼ˆä½ å¯ä»¥å…ˆå»ºç«‹ä¸€å°ï¼Œå†ç™¼é€£çµï¼‰ã€‚');
    setCartToken(rec.cart_token);
    setCartMapInfo(`å·²è¼‰å…¥æ­¤å®¢äººè³¼ç‰©è»Šï¼š${rec.cart_token}`);
    await refreshList();
  }
  function clearCartForUser() {
    const uid = getLineUserId();
    if (!uid) return alert('è«‹å…ˆè²¼ä¸Š/æŸ¥åˆ°å®¢äººçš„ LineUserId');
    const map = loadCartMap();
    delete map[uid];
    saveCartMap(map);
    setCartMapInfo('å·²æ¸…é™¤æ­¤å®¢äººè³¼ç‰©è»Šè¨˜éŒ„');
  }
  function showCartHintIfExists() {
    const uid = getLineUserId();
    if (!uid) { setCartMapInfo(''); return; }
    const map = loadCartMap();
    const rec = map[uid];
    if (rec && rec.cart_token) setCartMapInfo(`é€™ä½å®¢äººä¸Šæ¬¡è³¼ç‰©è»Šï¼š${rec.cart_token}ï¼ˆå¯æŒ‰ã€Œè¼‰å…¥æ­¤å®¢äººè³¼ç‰©è»Šã€ï¼‰`);
    else setCartMapInfo('é€™ä½å®¢äººç›®å‰æ²’æœ‰è¨˜ä½çš„è³¼ç‰©è»Šã€‚');
  }

  // ---------- actions ----------
  async function doLogin() {
    const v = ($('#op_key').value||'').trim();
    if(!v) return alert('è«‹è¼¸å…¥ OP Key');
    const res = await jfetch(API+'/op/auth', { method:'POST', body: JSON.stringify({ op_key: v }) });
    if(!res || res.ok!==true) return alert('OP Key éŒ¯èª¤');
    OP = v; localStorage.setItem('OP_KEY', v);
    setLoginUI(true);
  }

  async function createCart() {
    const streamer = ($('#streamer').value||'').trim();
    const customer_type = $('#customer_type').value || 'live';
    const payload = {
  streamer_name: streamer || 'æœªå‘½å',
  customer_type,
  line_user_id: getLineUserId(),
  customer_name: getCustomerName()
};

const res = await jfetch(API+'/cart/create', {
  method:'POST',
  body: JSON.stringify(payload)
});
    if(!res.ok) return alert('å»ºç«‹å¤±æ•—ï¼š'+(res.error||''));
    setCartToken(res.cart_token);
    try { showCartHintIfExists(); } catch(e) {}
    await refreshList();
  }

  async function addItem() {
    if(!guardCart()) return;
    const sku = ($('#sku').value||'').trim();
    const qty = parseInt($('#qty').value||'1',10)||1;
    const price = ($('#override_price').value||'').trim();
    const body = { 
  cart_token: CART,
  sku,
  qty,
  line_user_id: getLineUserId(),
  customer_name: getCustomerName()
};
    if(price) { body.price = parseInt(price,10)||0; body.op_key = OP; }
    const res = await jfetch(API+'/cart/add', { method:'POST', body: JSON.stringify(body) });
    if(!res.ok) return alert('åŠ å…¥å¤±æ•—ï¼š'+(res.error||''));
    $('#sku').value='';
    await refreshList();
  }

  async function saveNote() {
    if(!guardCart()) return;
    const note = $('#note').value||'';
    const res = await jfetch(API+'/cart/note', { method:'POST', body: JSON.stringify({ cart_token: CART, note, op_key: OP })});
    if(!res.ok) return alert('å‚™è¨»å¤±æ•—ï¼š'+(res.error||''));
    alert('å·²å„²å­˜å‚™è¨»');
  }

  async function refreshList() {
    if(!guardCart()) return;
    const res = await jfetch(API+'/cart/'+encodeURIComponent(CART));
    const list = res.items||[];
    const ul = $('#items'); ul.innerHTML='';
    let sum = 0;
    list.forEach(it=>{
      sum += (+it.price||0) * (+it.qty||0);
      const li = document.createElement('li');
      li.innerHTML = `<span class="mono">${it.sku}</span><span class="mono right">${it.qty} Ã— ${money(it.price||0)}</span>`;
      ul.appendChild(li);
    });
    $('#total').textContent = money(sum);
  }

  async function clearCart() {
    if(!guardCart()) return;
    if(!OP) return alert('éœ€è¦ OP æ‰èƒ½æ¸…ç©º');
    if(!confirm('ç¢ºå®šæ¸…ç©ºæ•´å€‹è³¼ç‰©è»Šï¼Ÿ')) return;
    const res = await jfetch(API+'/cart/clear', { method:'POST', body: JSON.stringify({cart_token:CART, op_key:OP}) });
    if(!res.ok) return alert('æ¸…ç©ºå¤±æ•—ï¼š'+(res.error||''));
    await refreshList();
  }

// å…±ç”¨ï¼šçµ„å‡ºé€™ä¸€è»Šçš„çµå¸³ç¶²å€ï¼ˆâœ… çµ±ä¸€èµ° LIFF + url= é€²å…¥æ­£ç¢º Endpointï¼‰
function buildCheckoutUrl() {
  const LIFF_ID = '2008430261-KLwoQjm4';

  // âœ… 1) å…ˆæŠŠ CART è£¡å¯èƒ½æ··é€²ä¾†çš„ liff.state / ?url=... æ¸…æ‰ï¼ˆåªç•™çœŸæ­£ tokenï¼‰
  const cartToken = String(CART || '').trim();

  // âœ… 2) endpoint çµ±ä¸€ç”¨ã€Œç„¡å‰¯æª”åã€å…¥å£ï¼ˆé…åˆ Pages 308 è¡Œç‚ºï¼‰
  const endpoint = `https://murain.tw/liff-checkout?cart_token=${encodeURIComponent(CART)}&force=1`;

  return `https://liff.line.me/${LIFF_ID}?url=${encodeURIComponent(endpoint)}`;
}

  // åŸæœ¬ã€Œè¤‡è£½çµå¸³é€£çµã€æŒ‰éˆ•ï¼ˆæ›´ç©©ï¼šclipboard å„ªå…ˆï¼‰
async function linkCheckout() {
  if (!guardCart()) return;

  const url = buildCheckoutUrl();
  const out = $('#link_out');
  if (out) out.value = url;

  // âœ… å„ªå…ˆç”¨ clipboard
  try {
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(url);
      alert('å·²è¤‡è£½çµå¸³é€£çµ');
      return;
    }
  } catch (e) {}

  // fallbackï¼šé¸å– + execCommand
  try {
    if (out) {
      out.focus();
      out.select();
      out.setSelectionRange(0, out.value.length);
    }
    document.execCommand('copy');
    alert('å·²è¤‡è£½çµå¸³é€£çµ');
  } catch (e) {
    alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é•·æŒ‰è¤‡è£½é€£çµ');
  }
}


  // â˜… æ–°å¢ï¼šå‘¼å«å¾Œç«¯ï¼Œè«‹å®˜æ–¹ LINE å¹«ä½ ç™¼ Flex å¡ç‰‡
  async function sendCheckoutLinkByLine() {
    if (!guardCart()) return;
    if (!OP) return alert('è«‹å…ˆç™»å…¥ OP Key');

    const lineUserId = ($('#line_user_id').value || '').trim();
    if (!lineUserId) return alert('è«‹å…ˆè²¼ä¸Šå®¢äººçš„ LineUserId');

    const res = await jfetch(API + '/op/cart/send-link', {
      method: 'POST',
      body: JSON.stringify({
        op_key: OP,
        cart_token: CART,
        line_user_id: lineUserId,
  customer_name: getCustomerName()
      })
    });

    if (!res || res.ok !== true) {
      console.log('send-link error', res);
      return alert('ç™¼é€å¤±æ•—ï¼š' + (res && res.error || 'unknown'));
    }

    alert('å·²å¾å®˜æ–¹ LINE ç™¼é€çµå¸³å¡ç‰‡');
    // âœ… ä¿éšªï¼šç™¼é€æˆåŠŸå¾Œå†è¨˜ä¸€æ¬¡ï¼ˆæ­¤æ™‚ä¸€å®šæœ‰ LineUserIdï¼‰
    try { rememberCartForUser(CART); } catch(e) {}
  }
  // â˜… æ–°å¢ï¼šç”¨ LINE åç¨± / æœ¬åæŸ¥è©¢æœƒå“¡ï¼Œæ‰¾åˆ°å°±è‡ªå‹•å¸¶ LineUserId
  async function searchLineMember() {
    if (!OP) {
      alert('è«‹å…ˆç™»å…¥ OP Key');
      return;
    }

    const q = ($('#line_search_name').value || '').trim();
    if (!q) {
      alert('è«‹å…ˆè¼¸å…¥è¦æŸ¥çš„ LINE åç¨±æˆ–æœ¬å');
      return;
    }

    try {
      const res = await jfetch(API + '/op/line-member/search', {
        method: 'POST',
        body: JSON.stringify({
          op_key: OP,
          keyword: q
        })
      });

      if (!res || res.ok !== true) {
        if (res && res.error === 'not_found') {
          alert('æ‰¾ä¸åˆ°ç›¸ç¬¦çš„æœƒå“¡ï¼ˆåç¨±è¦è·Ÿ Airtable ä¸Šçš„ä¸€æ¨¡ä¸€æ¨£ï¼‰');
        } else {
          alert('æœå°‹å¤±æ•—ï¼š' + (res && res.error || 'unknown'));
        }
        return;
      }

      const m = res.member || {};

      // è‡ªå‹•å¸¶å…¥ LineUserId
      $('#line_user_id').value = m.lineUserId || '';
      // âœ… æŠŠæŸ¥åˆ°çš„åå­—å›å¡«ï¼Œè®“ createCart() èƒ½ç›´æ¥æ‹¿ä¾†ç•¶ customer_name
$('#line_search_name').value = (m.displayName || m.name || q || '').trim();
      try { showCartHintIfExists(); } catch(e) {}

      // é¡¯ç¤ºä¸€ä¸‹æ‰¾åˆ°çš„æ˜¯èª°
      const infoEl = $('#line_search_info');
      if (infoEl) {
        const namePart =
          (m.displayName || '') ||
          (m.name || '');
        const phonePart = m.phone ? ` / ${m.phone}` : '';
        infoEl.textContent = `å·²é¸æ“‡ï¼š${namePart}${phonePart}`;
      }
    } catch (e) {
      console.error(e);
      alert('æœå°‹å¤±æ•—ï¼š' + e.message);
    }
  }

// æ–°å¢ï¼šè¤‡è£½ä¸€æ•´æ®µè¦è²¼çµ¦å®¢äººçš„ LINE è¨Šæ¯ï¼ˆæ›´ç©©ï¼šå…ˆç”¨ clipboardï¼Œå¤±æ•—å† fallbackï¼‰
async function copyLineMessage() {
  if (!guardCart()) return;

  const url = buildCheckoutUrl();
  const totalText = $('#total') ? $('#total').textContent.trim() : '';

  const msgLines = [
    'è¦ªæ„›çš„å¯¶å¯¶æ‚¨å¥½ï¼Œé€™æ˜¯æ‚¨çš„å°ˆå±¬çµå¸³é€£çµï¼š',
    url,
    '',
    totalText ? `æœ¬æ¬¡çµå¸³é‡‘é¡ï¼š${totalText}` : '',
    'è«‹åœ¨ 10 åˆ†é˜å…§å®Œæˆå¡«å¯«èˆ‡é€å‡ºï¼Œå¦‚éœ€èª¿æ•´å¯ä»¥ç›´æ¥å›è¦†æ­¤è¨Šæ¯å–”ğŸ’–'
  ].filter(Boolean);

  const msg = msgLines.join('\n');

  const ta = $('#line_msg') || $('#link_out');
  if (ta) ta.value = msg;

  // âœ… å„ªå…ˆï¼šClipboard APIï¼ˆHTTPS + æ–°ç‰ˆç€è¦½å™¨æœ€ç©©ï¼‰
  try {
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(msg);
      alert('å·²è¤‡è£½ LINE è¨Šæ¯');
      return;
    }
  } catch (e) {}

  // âœ… fallbackï¼šé¸å– + execCommandï¼ˆLINE å…§å»ºç€è¦½å™¨/éƒ¨åˆ†æ‰‹æ©Ÿï¼‰
  try {
    if (ta) {
      ta.focus();
      ta.select();
      ta.setSelectionRange(0, ta.value.length);
    } else {
      // å¦‚æœæ²’æœ‰ textarea/inputï¼Œå°±è‡¨æ™‚å»ºä¸€å€‹
      const tmp = document.createElement('textarea');
      tmp.value = msg;
      tmp.style.position = 'fixed';
      tmp.style.opacity = '0';
      document.body.appendChild(tmp);
      tmp.select();
      tmp.setSelectionRange(0, tmp.value.length);
    }

    const ok = document.execCommand('copy');
    if (!ok) throw new Error('execCommand copy failed');
    alert('å·²è¤‡è£½ LINE è¨Šæ¯');
  } catch (e) {
    alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é•·æŒ‰è¤‡è£½è¨Šæ¯');
  }
}

    // ====== è³¼ç‰©è»Šç®¡ç†ï¼ˆAdminï¼‰======
  function escHtml(s){
    return String(s||"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }

  // ====== cartAdminBlockï¼ˆä½ æ–° UI é‚£å€ï¼‰å¯¦ä½œï¼šæœªçµå–®æ¸…å–® / é¸å– / åŠ è³¼ / ç§»é™¤ / æ¸…ç©º / é‡è¼‰ ======
  function v(id){ const el = document.getElementById(id); return el ? (el.value || '').trim() : ''; }
  function setV(id, val){ const el = document.getElementById(id); if (el) el.value = val ?? ''; }
  function showOpenCartHtml(html){ const el = document.getElementById('openCartList'); if (el) el.innerHTML = html || ''; }

  function getAdminKeyUI(){ return v('adminKey'); }   // âœ… ä½ çš„ UI id æ˜¯ adminKey
  function getOpKeyUI(){ return v('opKey') || OP || ''; } // âœ… ä½ çš„ UI id æ˜¯ opKeyï¼ˆä¹Ÿå…è¨±æ²¿ç”¨ä½ å·²ç™»å…¥çš„ OPï¼‰
  function getSelectedCartUI(){ return v('selectedCartToken') || CART || ''; }

  async function safeJsonFetch(url, opt){
    const r = await fetch(url, opt || {});
    const txt = await r.text();
    let j = null;
    try { j = JSON.parse(txt); } catch { j = { ok:false, raw:txt }; }
    return { ok: r.ok, status: r.status, json: j };
  }

  function renderOpenCarts(carts){
    const list = (carts || []).map(c=>{
      const token = escHtml(c.cart_token || c.cartToken || '');
      const name  = escHtml(c.customer_name || c.customerName || '');
      const uid   = escHtml(c.line_user_id || c.lineUserId || '');
      const cnt   = Number(c.item_count || c.itemCount || 0) || 0;
      const up    = escHtml(c.updated_at || c.updatedAt || '');
      const st    = escHtml(c.status || '');

      return `
        <div style="padding:10px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
            <div style="min-width:260px;">
              <div style="font-weight:800;">
                ${name || '(æœªå¡«åå­—)'} <span class="muted">(${cnt} ä»¶)</span>
              </div>
              <div class="muted" style="margin-top:2px;">
                status: <b>${st || '-'}</b> ï½œ updated: ${up || '-'}
              </div>
              <div class="muted mono" style="margin-top:6px;word-break:break-all;">
                cart_token: ${token}<br/>
                line_user_id: ${uid || '-'}
              </div>
            </div>
            <div style="display:flex;gap:8px;align-items:flex-start;">
              <button class="ghost btnPickCart" data-token="${token}" style="max-width:140px;">é¸å–</button>
            </div>
          </div>
        </div>
      `;
    }).join('');

    showOpenCartHtml(list || `<div class="muted">æ²’æœ‰è³‡æ–™</div>`);

    // ç¶å®šã€Œé¸å–ã€
    const root = document.getElementById('openCartList');
    if (root) {
      root.querySelectorAll('.btnPickCart').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const token = (btn.dataset.token || '').trim();
          if (!token) return;
          await adminSelectCart(token);
        });
      });
    }
  }

  async function adminSelectCart(token){
    // âœ… è®“æ•´é éƒ½åˆ‡åˆ°é€™å° cartï¼ˆåŒ…å«ä½ ä¸Šé¢åŸæœ¬çš„ items æ¸…å–®/çµå¸³é€£çµï¼‰
    setCartToken(token);
    setV('selectedCartToken', token);
    await adminReloadCart();
  }

  async function adminReloadCart(){
    const token = getSelectedCartUI();
    if (!token) return alert('è«‹å…ˆé¸ä¸€å°è³¼ç‰©è»Š');

    // ç”¨ä½ æ—¢æœ‰ /cart/:token ç›´æ¥è¼‰ï¼ˆä¸éœ€ admin_keyï¼‰
    const { ok, json } = await safeJsonFetch(API + '/cart/' + encodeURIComponent(token), { method:'GET' });
    if (!ok || !json || json.ok === false) {
      console.log('reload cart fail', ok, json);
      return alert('é‡æ–°è¼‰å…¥å¤±æ•—ï¼š' + (json && (json.error || json.message) || 'unknown'));
    }
    setV('cartJsonView', JSON.stringify(json, null, 2));

    // é †ä¾¿æŠŠä¸Šé¢æ¸…å–®åˆ·æ–°
    try { await refreshList(); } catch(e){}
  }

  async function adminClearCart(){
    const token = getSelectedCartUI();
    if (!token) return alert('è«‹å…ˆé¸ä¸€å°è³¼ç‰©è»Š');

    const opk = getOpKeyUI();
    if (!opk) return alert('è«‹è¼¸å…¥ OP Keyï¼ˆå³é‚Šé‚£æ ¼ï¼‰');

    if (!confirm('ç¢ºå®šæ¸…ç©ºé€™å°è³¼ç‰©è»Šï¼Ÿ\n' + token)) return;

    const { ok, json } = await safeJsonFetch(API + '/cart/clear', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({ cart_token: token, op_key: opk })
    });

    if (!ok || !json || json.ok !== true) {
      console.log('clear fail', ok, json);
      return alert('æ¸…ç©ºå¤±æ•—ï¼š' + (json && (json.error || json.message) || 'unknown'));
    }

    await adminReloadCart();
  }

  async function adminAddItem(){
    const token = getSelectedCartUI();
    if (!token) return alert('è«‹å…ˆé¸ä¸€å°è³¼ç‰©è»Š');

    const opk = getOpKeyUI();
    if (!opk) return alert('è«‹è¼¸å…¥ OP Keyï¼ˆå³é‚Šé‚£æ ¼ï¼‰');

    const sku = v('addSku');
    const qty = Math.max(1, parseInt(v('addQty') || '1', 10) || 1);
    const priceRaw = v('addPrice');

    if (!sku) return alert('è«‹å¡« SKU');

    const body = { cart_token: token, sku, qty, op_key: opk };
    if (priceRaw !== '') body.price = Math.max(0, parseInt(priceRaw, 10) || 0);

    const { ok, json } = await safeJsonFetch(API + '/cart/add', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify(body)
    });

    if (!ok || !json || json.ok !== true) {
      console.log('add fail', ok, json);
      return alert('åŠ è³¼å¤±æ•—ï¼š' + (json && (json.error || json.message) || 'unknown'));
    }

    setV('addSku',''); // æ¸…ä¸€ä¸‹
    await adminReloadCart();
  }

  async function adminRemoveItem(){
    const token = getSelectedCartUI();
    if (!token) return alert('è«‹å…ˆé¸ä¸€å°è³¼ç‰©è»Š');

    const opk = getOpKeyUI();
    if (!opk) return alert('è«‹è¼¸å…¥ OP Keyï¼ˆå³é‚Šé‚£æ ¼ï¼‰');

    const sku = v('rmSku');
    if (!sku) return alert('è«‹å¡«è¦ç§»é™¤çš„ SKU');

    const { ok, json } = await safeJsonFetch(API + '/cart/remove', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({ cart_token: token, sku, op_key: opk })
    });

    if (!ok || !json || json.ok !== true) {
      console.log('remove fail', ok, json);
      return alert('ç§»é™¤å¤±æ•—ï¼š' + (json && (json.error || json.message) || 'unknown'));
    }

    setV('rmSku','');
    await adminReloadCart();
  }

  async function adminListOpenCarts(){
    const ak = getAdminKeyUI();
    if (!ak) return alert('è«‹è¼¸å…¥ Admin Key');

    // â‘  å…ˆå˜—è©¦ä½ å¯èƒ½å·²ç¶“æœ‰çš„ /admin/cart/openï¼ˆå¦‚æœå¾Œç«¯æ²’åšï¼Œæœƒ 404ï¼‰
    let r = await safeJsonFetch(API + '/admin/cart/open?admin_key=' + encodeURIComponent(ak), { method:'GET' });

    // â‘¡ å¦‚æœæ²’æœ‰é€™æ”¯ï¼Œå°±é€€è€Œæ±‚å…¶æ¬¡ï¼šç”¨ searchï¼ˆä½†éœ€è¦ kwï¼‰
    if (!r.ok) {
      const kw =
        (document.getElementById('line_user_id') && v('line_user_id')) ||
        (document.getElementById('line_search_name') && v('line_search_name')) ||
        '';

      if (!kw) {
        showOpenCartHtml(`<div class="muted">å¾Œç«¯æœªæä¾›ã€Œåˆ—å‡ºå…¨éƒ¨æœªçµå–®ã€ç«¯é»ï¼ˆ/admin/cart/openï¼‰ã€‚<br/>ä½ ä¹Ÿæ²’æœ‰è¼¸å…¥é—œéµå­—å¯ç”¨ searchã€‚</div>`);
        return;
      }

      r = await safeJsonFetch(
        API + '/admin/cart/search?kw=' + encodeURIComponent(kw) + '&admin_key=' + encodeURIComponent(ak),
        { method:'GET' }
      );
    }

    if (!r.ok || !r.json || r.json.ok !== true) {
      console.log('list open carts fail', r);
      showOpenCartHtml(`<div class="muted">è®€å–å¤±æ•—ï¼š${escHtml((r.json && (r.json.error || r.json.message)) || 'unknown')}</div>`);
      return;
    }

    const cartsRaw = (r.json.carts || []);

// âœ… æœ‰ item_count æ‰éæ¿¾ï¼›æ²’æœ‰å°±å…¨éƒ¨é¡¯ç¤ºï¼ˆé¿å… /admin/cart/open è¢«ä½ æ¸…ç©ºï¼‰
const hasItemCount = cartsRaw.some(c => c && c.item_count != null);
const carts = hasItemCount
  ? cartsRaw.filter(c => (Number(c.item_count || 0) || 0) > 0)
  : cartsRaw;

renderOpenCarts(carts);
  }

  function getAdminKey(){
    return ($('#admin_key') && ($('#admin_key').value || '').trim()) || '';
  }

  function setCartAdminMsg(txt){
    const el = $('#cart_admin_msg');
    if (el) el.textContent = txt || '';
  }

  function showCartAdminItemsBox(on){
    const box = $('#cart_admin_items_box');
    if (!box) return;
    box.classList.toggle('hidden', !on);
  }

  let ADMIN_SELECTED_CART = '';

  async function cartAdminSearch(){
    if (!OP) return alert('è«‹å…ˆç™»å…¥ OP Key');
    const ak = getAdminKey();
    if (!ak) return alert('è«‹è¼¸å…¥ Admin Key');
    const kw = ($('#cart_admin_kw').value || '').trim();
    if (!kw) return alert('è«‹è¼¸å…¥åå­—æˆ– LineUserId');

    setCartAdminMsg('æœå°‹ä¸­...');
    showCartAdminItemsBox(false);
    ADMIN_SELECTED_CART = '';
    const out = $('#cart_admin_result');
    if (out) out.innerHTML = '';

    const url = API + '/admin/cart/search?kw=' + encodeURIComponent(kw) + '&admin_key=' + encodeURIComponent(ak);
    const res = await jfetch(url, { method:'GET' });

    if (!res || res.ok !== true){
      setCartAdminMsg('æœå°‹å¤±æ•—ï¼š' + (res && (res.error || res.message) || 'unknown'));
      return;
    }

    const carts = (res.carts || []).filter(c => (Number(c.item_count || 0) || 0) > 0);
setCartAdminMsg(`æ‰¾åˆ° ${carts.length} å°è³¼ç‰©è»Šï¼ˆåªé¡¯ç¤ºæœ‰å•†å“ï¼‰`);

    if (!out) return;

    if (!carts.length){
      out.innerHTML = `<div class="muted">æ²’æœ‰æ‰¾åˆ°è³¼ç‰©è»Š</div>`;
      return;
    }

    out.innerHTML = carts.map(c=>{
      const token = escHtml(c.cart_token || '');
      const name  = escHtml(c.customer_name || '');
      const uid   = escHtml(c.line_user_id || '');
      const st    = escHtml(c.status || '');
      const up    = escHtml(c.updated_at || '');
      const cnt   = Number(c.item_count || 0) || 0;

      return `
        <div style="padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
            <div style="min-width:260px;">
              <div style="font-weight:800;">
                ${name || '(æœªå¡«åå­—)'} <span class="muted">(${cnt} ä»¶)</span>
              </div>
              <div class="muted" style="margin-top:2px;">
                status: <b>${st || '-'}</b> ï½œ updated: ${up || '-'}
              </div>
              <div class="muted mono" style="margin-top:6px;word-break:break-all;">
                cart_token: ${token}<br/>
                line_user_id: ${uid || '-'}
              </div>
            </div>
            <div style="display:flex;gap:8px;align-items:flex-start;">
              <button class="ghost btn-cart-admin-view" data-token="${token}" style="max-width:140px;">çœ‹æ˜ç´°</button>
            </div>
          </div>
        </div>
      `;
    }).join('');

    // ç¶å®šã€Œçœ‹æ˜ç´°ã€æŒ‰éˆ•
    out.querySelectorAll('.btn-cart-admin-view').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const token = btn.dataset.token || '';
        if (!token) return;

        const ak2 = getAdminKey();
        if (!ak2) return alert('è«‹è¼¸å…¥ Admin Key');

        setCartAdminMsg('è¼‰å…¥æ˜ç´°ä¸­...');
        showCartAdminItemsBox(false);

        const url2 = API + '/admin/cart/items?cart_token=' + encodeURIComponent(token) + '&admin_key=' + encodeURIComponent(ak2);
        const r2 = await jfetch(url2, { method:'GET' });

        if (!r2 || r2.ok !== true){
          setCartAdminMsg('è®€å–æ˜ç´°å¤±æ•—ï¼š' + (r2 && (r2.error || r2.message) || 'unknown'));
          return;
        }

        ADMIN_SELECTED_CART = token;
        $('#cart_admin_token').textContent = token;
        $('#cart_admin_items').value = JSON.stringify(r2.items || [], null, 2);
        showCartAdminItemsBox(true);
        setCartAdminMsg('');
      });
    });
  }

  async function cartAdminExpire(){
    if (!OP) return alert('è«‹å…ˆç™»å…¥ OP Key');
    const ak = getAdminKey();
    if (!ak) return alert('è«‹è¼¸å…¥ Admin Key');
    if (!ADMIN_SELECTED_CART) return alert('è«‹å…ˆã€Œçœ‹æ˜ç´°ã€é¸ä¸€å°è³¼ç‰©è»Š');

    if (!confirm(`ç¢ºå®šæ¸…é™¤æ­¤è³¼ç‰©è»Šï¼Ÿ\n${ADMIN_SELECTED_CART}\n\næœƒåˆªé™¤ CartItems + æ¨™è¨˜ expiredï¼ˆä¸å½±éŸ¿åº«å­˜ï¼‰`)) return;

    setCartAdminMsg('æ¸…é™¤ä¸­...');

    const url = API + '/admin/cart/expire?admin_key=' + encodeURIComponent(ak);
    const r = await jfetch(url, {
      method:'POST',
      body: JSON.stringify({ cart_token: ADMIN_SELECTED_CART })
    });

    if (!r || r.ok !== true){
      setCartAdminMsg('æ¸…é™¤å¤±æ•—ï¼š' + (r && (r.error || r.message) || 'unknown'));
      return;
    }

    setCartAdminMsg(`å·²æ¸…é™¤ï¼šitems_deleted=${r.items_deleted || 0}ï¼ˆcart=${ADMIN_SELECTED_CART}ï¼‰`);
    showCartAdminItemsBox(false);
    ADMIN_SELECTED_CART = '';
  }


  // ---------- quick-price ----------
  const quick = { '#btn-50': -50, '#btn-100': -100, '#btn-999': 999 };
  function applyQuick(v){
    const cur = parseInt($('#override_price').value||'0',10)||0;
    if(v===999) { $('#override_price').value = '999'; return; }
    $('#override_price').value = String(Math.max(0, cur + v));
  }

    // â˜… æ–°å¢ï¼šæ‰‹å‹•è²¼ä¸Š LineUserId æ™‚ï¼Œå³æ™‚æç¤ºæ˜¯å¦æœ‰è¨˜ä½çš„è³¼ç‰©è»Š
    const lineUserInput = $('#line_user_id');
    if (lineUserInput) {
      lineUserInput.addEventListener('input', () => {
        try { showCartHintIfExists(); } catch(e) {}
      });
    }

  // ---------- init ----------
  window.addEventListener('DOMContentLoaded', async ()=>{
    // ç¶å®šäº‹ä»¶ï¼ˆç¢ºä¿ã€Œç™»å…¥éµæœ‰åæ‡‰ã€ï¼‰
    $('#btn-login').addEventListener('click', doLogin);
    $('#btn-create').addEventListener('click', createCart);
    $('#btn-add').addEventListener('click', addItem);
    $('#btn-note').addEventListener('click', saveNote);
    $('#btn-refresh').addEventListener('click', refreshList);
    $('#btn-clear').addEventListener('click', clearCart);
    $('#btn-link').addEventListener('click', linkCheckout);
    // â˜… æ–°å¢ï¼šæœå°‹æœƒå“¡ï¼ˆç”¨ LINE åç¨± / æœ¬åï¼‰
  const btnSearchLine = $('#btn-search-line');
  if (btnSearchLine) {
    btnSearchLine.addEventListener('click', searchLineMember);
  }
     // â˜… æ–°å¢ï¼šå¾å®˜æ–¹ LINE ç™¼çµå¸³å¡ç‰‡
    const btnSendLink = $('#btn-send-link');
    if (btnSendLink) {
      btnSendLink.addEventListener('click', sendCheckoutLinkByLine);
    }
     // ====== ç¶å®šä½ æ–° UIï¼šcartAdminBlock ======
    const _btnListOpen = document.getElementById('btnListOpen');
    if (_btnListOpen) _btnListOpen.addEventListener('click', adminListOpenCarts);

    const _btnClearCart2 = document.getElementById('btnClearCart');
    if (_btnClearCart2) _btnClearCart2.addEventListener('click', adminClearCart);

    const _btnAddItem2 = document.getElementById('btnAddItem');
    if (_btnAddItem2) _btnAddItem2.addEventListener('click', adminAddItem);

    const _btnRemoveItem2 = document.getElementById('btnRemoveItem');
    if (_btnRemoveItem2) _btnRemoveItem2.addEventListener('click', adminRemoveItem);

    const _btnReloadCart2 = document.getElementById('btnReloadCart');
    if (_btnReloadCart2) _btnReloadCart2.addEventListener('click', adminReloadCart);


    // ======ï¼ˆé€™è£¡é–‹å§‹è²¼ï¼šè³¼ç‰©è»Šç®¡ç† Admin äº‹ä»¶ï¼‰======
    const adminKeyInput = $('#adminKey');
    if (adminKeyInput) {
      // è¨˜ä½ Admin Keyï¼ˆå­˜åœ¨æœ¬æ©Ÿï¼Œä¸å¯«æ­»åœ¨ç¨‹å¼ç¢¼ï¼‰
      const savedAk = localStorage.getItem('ADMIN_KEY') || '';
      if (savedAk) adminKeyInput.value = savedAk;
      adminKeyInput.addEventListener('change', ()=> {
        localStorage.setItem('ADMIN_KEY', adminKeyInput.value || '');
      });
    }

    // ======ï¼ˆé€™è£¡çµæŸè²¼ä¸Šï¼‰======
   
     Object.keys(quick).forEach(sel=>{
      const v = quick[sel];
      document.querySelector(sel).addEventListener('click', ()=>applyQuick(v));
    });
    // è‡ªå‹•å¸¶å› OPï¼ˆè‹¥æœ‰å­˜ï¼‰
    const saved = localStorage.getItem('OP_KEY');
    if(saved) { $('#op_key').value = saved; OP = saved; setLoginUI(true); }
  });
})();
</script>
    </div> <!-- #card-list -->
</div> <!-- .wrap -->
</body>
</html>
