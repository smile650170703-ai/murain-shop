<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MURAIN — 主播開單 (安全版)</title>
  <style>
    :root { --fg:#222; --bg:#f6f7fb; --card:#fff; --pri:#111; --mut:#777; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, 'Noto Sans TC', Arial, sans-serif; color:var(--fg); background:var(--bg);}
    .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    .card { background:var(--card); border-radius:16px; box-shadow:0 6px 26px rgba(0,0,0,.06); padding:20px; margin-bottom:16px; }
    h2 { margin:0 0 12px; }
    label { font-size:.9rem; color:var(--mut); display:block; margin-bottom:6px; }
    input, select, button, textarea { width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:10px; outline:none; }
    textarea { min-height:80px; resize:vertical; }
    .row { display:grid; grid-template-columns: repeat(12, 1fr); gap:10px; }
    .col-3 { grid-column: span 3; } .col-4 { grid-column: span 4; } .col-5 { grid-column: span 5; } .col-6 { grid-column: span 6; }
    .col-7 { grid-column: span 7; } .col-8 { grid-column: span 8; } .col-9 { grid-column: span 9; } .col-12{grid-column: span 12;}
    .btn { cursor:pointer; background:#111; color:#fff; border:none; padding:10px 14px; border-radius:10px; }
    .btn.subtle { background:#444; }
    .my-8 { margin-top:8px; margin-bottom:8px; }
    .mut { color:var(--mut); font-size:.9rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .pill { background:#eee; padding:6px 10px; border-radius:999px; cursor:pointer; display:inline-block; margin-right:6px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; }
    td.right { text-align:right; }
    .danger { background:#b91c1c; }
    .hide { display:none; }
  </style>
  <script>window.API_BASE="https://api.murain.tw";</script>
</head>
<body>
  <div class="wrap">
    <div id="gate" class="card">
      <h2>主播開單登入</h2>
      <div class="row">
        <div class="col-6">
          <label>OP 密碼</label>
          <input id="op_key" type="password" placeholder="請輸入 OP Key (預設 88)" />
        </div>
        <div class="col-3">
          <label>&nbsp;</label>
          <button id="btnLogin" class="btn">登入</button>
        </div>
        <div class="col-12 mut">通過後會儲存在本機，關閉視窗後需重新登入。</div>
      </div>
    </div>

    <div id="app" class="hide">
      <div class="card">
        <h2>建立購物車</h2>
        <div class="row">
          <div class="col-6">
            <label>主播名稱</label>
            <input id="streamer" placeholder="例如：小沐" />
          </div>
          <div class="col-3">
            <label>客戶類型</label>
            <select id="ctype">
              <option value="live" selected>直播單（需 OP 才能清空/移除）</option>
              <option value="web">官網自助單（可自行清空/移除）</option>
            </select>
          </div>
          <div class="col-3">
            <label>&nbsp;</label>
            <button id="btnCreate" class="btn">建立</button>
          </div>
          <div class="col-12 mut">CartToken：<span id="cartToken" class="mono">尚未建立</span></div>
        </div>
      </div>

      <div class="card">
        <h2>加入商品</h2>
        <div class="row">
          <div class="col-4">
            <label>SKU</label>
            <input id="sku" class="mono" placeholder="AA001…" />
          </div>
          <div class="col-2">
            <label>數量</label>
            <input id="qty" type="number" value="1" />
          </div>
          <div class="col-3">
            <label>改價（帶 OP）</label>
            <input id="price" type="number" placeholder="可留空" />
          </div>
          <div class="col-3">
            <label>&nbsp;</label>
            <button id="btnAdd" class="btn">加入</button>
          </div>

          <div class="col-12 my-8">
            <span class="pill" data-d="-50">-50</span>
            <span class="pill" data-d="-100">-100</span>
            <span class="pill" data-p="999">特價 999</span>
          </div>

          <div class="col-4">
            <label>常用贈品</label>
            <select id="gift">
              <option value="">— 選擇 —</option>
              <option>送髮夾</option>
              <option>送旅行組</option>
              <option>送小香水</option>
            </select>
          </div>
          <div class="col-6">
            <label>備註 / 贈品說明</label>
            <input id="note" placeholder="例如：多送一次護髮" />
          </div>
          <div class="col-2">
            <label>&nbsp;</label>
            <button id="btnNote" class="btn subtle">儲存備註</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>產生結帳連結</h2>
        <div class="row">
          <div class="col-3">
            <button id="linkBank" class="btn">新客匯款</button>
          </div>
          <div class="col-5">
            <button id="linkCod" class="btn subtle">老客 7-11 COD / 其他金流示範</button>
          </div>
          <div class="col-12 my-8">
            <input id="share" readonly class="mono" placeholder="結帳連結會顯示在這裡…" />
          </div>
        </div>
      </div>

      <div class="card">
        <h2>購物車清單</h2>
        <div class="row">
          <div class="col-12">
            <table>
              <thead>
                <tr><th>SKU</th><th>品名</th><th class="right">單價</th><th class="right">數量</th><th class="right">小計</th><th></th></tr>
              </thead>
              <tbody id="lines"></tbody>
              <tfoot>
                <tr><td colspan="6" class="right"><b>合計 NT$ <span id="total">0</span></b></td></tr>
              </tfoot>
            </table>
          </div>
          <div class="col-6">
            <button id="btnClear" class="btn danger">清空購物車</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const API = window.API_BASE;
let CART = null;
let OP = "";

function $(q) {{ return document.querySelector(q); }}
function el(tag, attrs, ...kids) {{
  const n = document.createElement(tag);
  (attrs||[]).forEach(([k,v]) => n.setAttribute(k,v));
  kids.forEach(k => typeof k==='string' ? n.appendChild(document.createTextNode(k)) : n.appendChild(k));
  return n;
}}
const fmt = n => (n||0).toLocaleString();

async function authAndShow() {{
  const r = await fetch(API + '/op/auth', {{method:'POST', headers:{{'Content-Type':'application/json'}}, body:JSON.stringify({{key:OP}})}});
  if(!r.ok) throw new Error('OP 驗證失敗');
  $('#gate').classList.add('hide');
  $('#app').classList.remove('hide');
}}

$('#btnLogin').onclick = async () => {{
  try {{
    OP = ($('#op_key').value||'').trim();
    if(!OP) OP='88';
    await authAndShow();
    localStorage.setItem('OP_KEY', OP);
  }} catch(e) {{ alert(e.message||e); }}
}};

window.addEventListener('load', async () => {{
  const cached = localStorage.getItem('OP_KEY');
  if(cached) {{ OP = cached; try {{ await authAndShow(); }} catch {{ /* ignore */ }} }}
  // pills
  document.querySelectorAll('.pill').forEach(p => p.addEventListener('click', () => {{
    const d = p.getAttribute('data-d'); const sp = p.getAttribute('data-p');
    if(d) {{ // -50 / -100 → 直接在價格欄位加上負數調整
      const cur = parseInt($('#price').value||'0',10)||0;
      $('#price').value = String(cur + parseInt(d,10));
    }} else if (sp) {{
      $('#price').value = sp;
    }}
  }}));
}});

$('#btnCreate').onclick = async () => {{
  try {{
    const body = {{ streamer_name: $('#streamer').value.trim()||'主播', customer_type: $('#ctype').value }};
    const r = await fetch(API + '/cart/create', {{method:'POST', headers:{{'Content-Type':'application/json'}}, body:JSON.stringify(body)}});
    const data = await r.json();
    if(!data.ok) throw new Error(data.error||'create failed');
    CART = data.cart_token;
    $('#cartToken').textContent = CART;
    render();
  }} catch(e) {{ alert(e.message||e); }}
}};

$('#btnAdd').onclick = async () => {{
  if(!CART) return alert('請先建立購物車');
  const sku = $('#sku').value.trim();
  const qty = parseInt($('#qty').value||'1',10)||1;
  const price = parseInt($('#price').value||'0',10);
  if(!sku) return alert('請輸入 SKU');
  const body = {{ cart_token:CART, sku, qty }};
  if(!isNaN(price) && $('#price').value) body.price = price;
  body.op_key = OP;
  const r = await fetch(API + '/cart/add', {{method:'POST', headers:{{'Content-Type':'application/json'}}, body:JSON.stringify(body)}});
  const data = await r.json();
  if(!data.ok) return alert(data.error||'加入失敗');
  $('#sku').value=''; $('#qty').value='1'; $('#price').value='';
  render();
}};

$('#btnNote').onclick = async () => {{
  if(!CART) return alert('請先建立購物車');
  const g = $('#gift').value || '';
  const note = (g?'[贈品]'+g+' ':'') + ($('#note').value||'');
  const r = await fetch(API + '/cart/note', {{method:'POST', headers:{{'Content-Type':'application/json'}}, body:JSON.stringify({{cart_token:CART,note}})}});
  const t = await r.text(); alert(/ok/.test(t)?'已儲存':'失敗');
}};

$('#btnClear').onclick = async () => {{
  if(!CART) return;
  if(!confirm('確定要清空購物車？')) return;
  const r = await fetch(API + '/cart/clear', {{method:'POST', headers:{{'Content-Type':'application/json'}}, body:JSON.stringify({{cart_token:CART, op_key:OP}})}});
  if(!r.ok) return alert('清空失敗（權限或其他原因）');
  render();
}};

function toLink(pm) {{
  if(!CART) return alert('請先建立購物車');
  const u = new URL(location.origin + '/checkout.html');
  u.searchParams.set('cart_token', CART);
  u.searchParams.set('pm', pm);
  $('#share').value = u.toString();
}}
$('#linkBank').onclick = () => toLink('bank_transfer');
$('#linkCod').onclick  = () => toLink('cod_711');

async function render() {{
  if(!CART) return;
  const r = await fetch(API + '/cart/' + CART);
  const data = await r.json();
  const tb = $('#lines'); tb.innerHTML='';
  (data.items||[]).forEach(it => {{
    const tr = el('tr',[],
      el('td',[], it.sku || ''),
      el('td',[], it.name || ''),
      el('td',[['class','right']], 'NT$ ' + fmt(it.price)),
      el('td',[['class','right']], String(it.qty||0)),
      el('td',[['class','right']], 'NT$ ' + fmt((it.price||0)*(it.qty||0))),
      el('td',[], (function() {{
        const b = el('button',[['class','btn subtle']], '移除');
        b.onclick = async () => {{
          const r = await fetch(API + '/cart/remove', {{method:'POST', headers:{{'Content-Type':'application/json'}}, body:JSON.stringify({{cart_token:CART, sku: it.sku, op_key:OP}})}});
          if(!r.ok) return alert('移除失敗（權限或其他原因）');
          render();
        }};
        return b;
      }})())
    );
    tb.appendChild(tr);
  }});
  $('#total').textContent = fmt(data.total||0);
}}
</script>
</body>
</html>
