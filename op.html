<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç›´æ’­ä¸»é–‹å–®</title>
<style>
  :root { --bg:#f7f7f8; --card:#fff; --txt:#222; --muted:#6b7280; --pri:#111; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Noto Sans TC, sans-serif; background:var(--bg); color:var(--txt); }
  .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
  .card { background:var(--card); border-radius: 12px; box-shadow: 0 10px 20px rgba(0,0,0,.05);
          padding: 20px; margin-bottom: 18px; }
  h2 { margin: 0 0 12px; font-size: 20px; }
  .row { display:flex; gap:10px; flex-wrap:wrap; }
  .row > * { flex: 1 1 220px; }
  input, select, button, textarea {
    width: 100%; box-sizing: border-box; padding: 10px 12px; border-radius: 10px; border:1px solid #e5e7eb; font-size: 15px;
  }
  button { background:#111; color:#fff; cursor:pointer; border:none; }
  button.ghost { background:#fff; color:#111; border:1px solid #e5e7eb; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .muted { color: var(--muted); font-size: 13px; }
  .hidden { display:none !important; }
  .list { margin: 8px 0 0; padding:0; list-style:none; }
  .list li { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #eee; }
  .right { text-align:right; }
  .grid2 { display:grid; grid-template-columns: 1fr auto; gap:10px; align-items: center; }
</style>
<script>window.API_BASE = "https://api.murain.tw";</script>
  <meta name="robots" content="noindex, nofollow">
</head>
<body>
<div class="wrap">

  <!-- ç™»å…¥ -->
  <div class="card" id="card-login">
    <h2>ä¸»æ’­é–‹å–®ç™»å…¥</h2>
    <div class="row">
      <div style="flex:2">
        <label class="muted">OP å¯†ç¢¼</label>
        <input id="op_key" class="mono" placeholder="è¼¸å…¥ OP Key" />
      </div>
      <div style="align-self:end; flex:1">
        <button id="btn-login">ç™»å…¥</button>
      </div>
    </div>
    <div class="muted" style="margin-top:6px">æˆåŠŸå¾Œæœƒç·©å­˜æ–¼æ­¤è£ç½®ï¼Œé—œé–‰è¦–çª—å¾Œéœ€é‡æ–°ç™»å…¥ã€‚</div>
  </div>

  <!-- é–‹å–® -->
  <div class="card hidden" id="card-app">
    <h2>å»ºç«‹è³¼ç‰©è»Š</h2>
    <div class="row">
      <div style="flex:2">
        <label class="muted">ä¸»æ’­åç¨±</label>
        <input id="streamer" placeholder="ä¾‹å¦‚ï¼šå°æ²" />
      </div>
      <div style="flex:1">
        <label class="muted">å®¢ç¾¤</label>
        <select id="customer_type">
          <option value="live">ç›´æ’­</option>
          <option value="regular">ä¸€èˆ¬</option>
        </select>
      </div>
      <div style="flex:1; align-self:end">
        <button id="btn-create">å»ºç«‹</button>
      </div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <div class="muted">CartTokenï¼š<span id="cart_token" class="mono muted">å°šæœªå»ºç«‹</span></div>
      <button class="ghost" id="btn-refresh">é‡æ•´æ¸…å–®</button>
    </div>
  </div>

  <!-- åŠ å•†å“ -->
  <div class="card hidden" id="card-add">
    <h2>åŠ å…¥å•†å“</h2>
    <div class="row">
      <div><label class="muted">SKU</label><input id="sku" class="mono" placeholder="AA001..." /></div>
      <div style="max-width:130px"><label class="muted">æ•¸é‡</label><input id="qty" value="1" /></div>
      <div><label class="muted">æ”¹åƒ¹</label><input id="override_price" placeholder="å¯ç•™ç©º" /></div>
      <div style="align-self:end"><button id="btn-add">åŠ å…¥</button></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="ghost" id="btn-50" style="max-width:120px">-50</button>
      <button class="ghost" id="btn-100" style="max-width:120px">-100</button>
      <button class="ghost" id="btn-999" style="max-width:120px">ç‰¹åƒ¹ 999</button>
    </div>
    <div class="row" style="margin-top:10px">
      <div style="flex:3"><input id="note" placeholder="å‚™è¨» / è´ˆå“èªªæ˜" /></div>
      <div style="flex:1"><button class="ghost" id="btn-note">å„²å­˜å‚™è¨»</button></div>
    </div>
  </div>

   <!-- çµå¸³ & æ¸…å–® -->
  <div class="card hidden" id="card-list">
    <h2>ç”¢ç”Ÿçµå¸³é€£çµ</h2>

    <!-- ä¸Šé¢é€™æ’æŒ‰éˆ•ï¼šåªè™•ç†ä¸»æ’­è‡ªå·±ç”¨çš„è¤‡è£½ -->
    <div class="row">
      <button id="btn-link" class="ghost">è¤‡è£½çµå¸³é€£çµ</button>
    </div>

    <input id="link_out" class="mono" readonly style="margin-top:10px" />
     <!-- â˜… æ–°å¢ï¼šè¼¸å…¥ LINE åç¨± / æœ¬å ä¾†æœå°‹ -->
    <div class="row" style="margin-top:10px">
      <input
        id="line_search_name"
        placeholder="è¼¸å…¥å®¢äººçš„ LINE åç¨±æˆ–æœ¬åï¼ˆå®Œå…¨ä¸€æ¨£çš„å­—ï¼‰"
      />
      <button id="btn-search-line" class="ghost">æŸ¥è©¢æœƒå“¡</button>
    </div>
    <div class="muted" id="line_search_info" style="margin-top:4px"></div>

    <!-- æ–°å¢ï¼šè²¼å®¢äººçš„ LineUserId + ä¸€éµç™¼å¡ç‰‡ -->
    <div class="row" style="margin-top:10px">
      <input id="line_user_id" placeholder="è²¼ä¸Šå®¢äººçš„ LineUserIdï¼ˆå¾ LineMembers è¤‡è£½ï¼‰" />
      <button id="btn-send-link" class="ghost">å¾å®˜æ–¹ LINE ç™¼çµå¸³å¡ç‰‡</button>
    </div>
    <textarea
      id="line_msg"
      rows="4"
      class="mono"
      readonly
      style="margin-top:8px"
      placeholder="é€™è£¡æœƒè‡ªå‹•ç”¢ç”Ÿè¦è²¼çµ¦å®¢äººçš„è¨Šæ¯"
    ></textarea>

    <ul id="items" class="list"></ul>
    <div class="grid2" style="margin-top:8px">
      <div class="muted">åˆè¨ˆ</div>
      <div class="right mono" id="total">NT$ 0</div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="ghost" id="btn-clear">æ¸…ç©ºè³¼ç‰©è»Šï¼ˆéœ€ OPï¼‰</button>
      <!-- ====== è³¼ç‰©è»Šç®¡ç†ï¼ˆæœå°‹ / æŸ¥çœ‹ / æ¸…é™¤ï¼‰ ====== -->
<hr style="border:none;border-top:1px dashed #e5e7eb;margin:16px 0;" />

<h2 style="font-size:18px;margin:0 0 10px;">ğŸ§¹ è³¼ç‰©è»Šç®¡ç†ï¼ˆæœå°‹å®¢äºº â†’ çœ‹æ˜ç´° â†’ æ¸…é™¤ï¼‰</h2>
<div class="muted" style="margin:-6px 0 10px;">
  åªæœƒæ¸… CartItems + æ¨™è¨˜ CartToken=expiredï¼Œä¸æœƒå½±éŸ¿åº«å­˜ï¼ˆå› ç‚ºè³¼ç‰©è»Šæœ¬ä¾†ä¸æ‰£åº«å­˜ï¼‰ã€‚
</div>

<div class="row">
  <div style="flex:1">
    <label class="muted">Admin Keyï¼ˆä¸è¦å¯«æ­»åœ¨ç¨‹å¼ç¢¼ï¼‰</label>
    <input id="admin_key" class="mono" type="password" placeholder="è¼¸å…¥ 88" />
  </div>
  <div style="flex:2">
    <label class="muted">æœå°‹ï¼ˆåå­— / LineUserIdï¼‰</label>
    <input id="cart_admin_kw" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜ / Uxxxxxxxx" />
  </div>
  <div style="align-self:end; flex:1">
    <button id="btn-cart-admin-search" class="ghost">æœå°‹è³¼ç‰©è»Š</button>
  </div>
</div>

<div class="muted" id="cart_admin_msg" style="margin-top:6px"></div>
<div id="cart_admin_result" style="margin-top:10px"></div>

<div id="cart_admin_items_box" class="hidden" style="margin-top:12px">
  <div class="muted">ç›®å‰é¸æ“‡ cart_tokenï¼š</div>
  <div class="mono" id="cart_admin_token" style="margin:4px 0 8px;"></div>

  <textarea id="cart_admin_items" rows="6" class="mono" readonly></textarea>

  <div class="row" style="margin-top:10px">
    <button id="btn-cart-admin-expire" style="background:#b91c1c;">æ¸…é™¤æ­¤è³¼ç‰©è»Šï¼ˆexpired + åˆª CartItemsï¼‰</button>
    </div>
  </div>

</div>

<script>
(async function () {
  const API = window.API_BASE;
  const $  = (s)=>document.querySelector(s);

  let OP = '';
  let CART = '';

  // ---------- helpers ----------
  async function jfetch(url, opt) {
    const r = await fetch(url, Object.assign({headers:{'content-type':'application/json'}}, opt||{}));
    const txt = await r.text();
    try { return JSON.parse(txt); } catch { return {raw:txt}; }
  }
  function money(n){ n = +n||0; return 'NT$ ' + n.toLocaleString(); }
  function guardCart(){ if(!CART){ alert('è«‹å…ˆå»ºç«‹è³¼ç‰©è»Š'); return false; } return true; }
  function setLoginUI(on){
    $('#card-login').classList.toggle('hidden', !!on);
    $('#card-app').classList.toggle('hidden', !on);
    $('#card-add').classList.toggle('hidden', !on);
    $('#card-list').classList.toggle('hidden', !on);
  }
  function setCartToken(t) {
    CART = t||'';
    $('#cart_token').textContent = t||'å°šæœªå»ºç«‹';
    $('#btn-clear').disabled = !OP;
    try { rememberCartForUser(CART); } catch(e) {}
  }

  // ====== â˜… å®¢äººè³¼ç‰©è»Šè¨˜æ†¶ï¼ˆåªå­˜åœ¨é€™å° OP è£ç½®çš„ localStorageï¼‰ ======
  const CART_MAP_KEY = 'OP_CART_MAP_V1';
  function loadCartMap() {
    try { return JSON.parse(localStorage.getItem(CART_MAP_KEY) || '{}'); } catch(e) { return {}; }
  }
  function saveCartMap(map) {
    try { localStorage.setItem(CART_MAP_KEY, JSON.stringify(map || {})); } catch(e) {}
  }
  function getLineUserId() {
    return ($('#line_user_id') && ($('#line_user_id').value || '').trim()) || '';
  }
  function getCustomerName() {
  // ä½ ç›®å‰å”¯ä¸€æœ‰ã€Œåå­—è¼¸å…¥ã€çš„æ¬„ä½å°±æ˜¯ #line_search_name
  // ç”¨å®ƒç•¶ customer_nameï¼ˆæœ‰æŸ¥æœƒå“¡æˆåŠŸæ™‚ï¼Œæˆ‘å€‘ç¬¬ 3 æ­¥æœƒè‡ªå‹•æŠŠå®ƒæ”¹æˆæ­£ç¢ºåå­—ï¼‰
  return ($('#line_search_name') && ($('#line_search_name').value || '').trim()) || '';
}
  function setCartMapInfo(txt) {
    const el = $('#cartmap_info');
    if (el) el.textContent = txt || '';
  }
  function rememberCartForUser(cartToken) {
    const uid = getLineUserId();
    if (!uid || !cartToken) return;
    const map = loadCartMap();
    map[uid] = { cart_token: String(cartToken), updatedAt: Date.now() };
    saveCartMap(map);
    setCartMapInfo(`å·²è¨˜ä½æ­¤å®¢äººè³¼ç‰©è»Šï¼š${String(cartToken)}`);
  }
  async function loadCartForUser() {
    const uid = getLineUserId();
    if (!uid) return alert('è«‹å…ˆè²¼ä¸Š/æŸ¥åˆ°å®¢äººçš„ LineUserId');
    const map = loadCartMap();
    const rec = map[uid];
    if (!rec || !rec.cart_token) return alert('é€™ä½å®¢äººç›®å‰æ²’æœ‰è¢«è¨˜ä½çš„è³¼ç‰©è»Šï¼ˆä½ å¯ä»¥å…ˆå»ºç«‹ä¸€å°ï¼Œå†ç™¼é€£çµï¼‰ã€‚');
    setCartToken(rec.cart_token);
    setCartMapInfo(`å·²è¼‰å…¥æ­¤å®¢äººè³¼ç‰©è»Šï¼š${rec.cart_token}`);
    await refreshList();
  }
  function clearCartForUser() {
    const uid = getLineUserId();
    if (!uid) return alert('è«‹å…ˆè²¼ä¸Š/æŸ¥åˆ°å®¢äººçš„ LineUserId');
    const map = loadCartMap();
    delete map[uid];
    saveCartMap(map);
    setCartMapInfo('å·²æ¸…é™¤æ­¤å®¢äººè³¼ç‰©è»Šè¨˜éŒ„');
  }
  function showCartHintIfExists() {
    const uid = getLineUserId();
    if (!uid) { setCartMapInfo(''); return; }
    const map = loadCartMap();
    const rec = map[uid];
    if (rec && rec.cart_token) setCartMapInfo(`é€™ä½å®¢äººä¸Šæ¬¡è³¼ç‰©è»Šï¼š${rec.cart_token}ï¼ˆå¯æŒ‰ã€Œè¼‰å…¥æ­¤å®¢äººè³¼ç‰©è»Šã€ï¼‰`);
    else setCartMapInfo('é€™ä½å®¢äººç›®å‰æ²’æœ‰è¨˜ä½çš„è³¼ç‰©è»Šã€‚');
  }

  // ---------- actions ----------
  async function doLogin() {
    const v = ($('#op_key').value||'').trim();
    if(!v) return alert('è«‹è¼¸å…¥ OP Key');
    const res = await jfetch(API+'/op/auth', { method:'POST', body: JSON.stringify({ op_key: v }) });
    if(!res || res.ok!==true) return alert('OP Key éŒ¯èª¤');
    OP = v; localStorage.setItem('OP_KEY', v);
    setLoginUI(true);
  }

  async function createCart() {
    const streamer = ($('#streamer').value||'').trim();
    const customer_type = $('#customer_type').value || 'live';
    const payload = {
  streamer_name: streamer || 'æœªå‘½å',
  customer_type,
  line_user_id: getLineUserId(),
  customer_name: getCustomerName()
};

const res = await jfetch(API+'/cart/create', {
  method:'POST',
  body: JSON.stringify(payload)
});
    if(!res.ok) return alert('å»ºç«‹å¤±æ•—ï¼š'+(res.error||''));
    setCartToken(res.cart_token);
    try { showCartHintIfExists(); } catch(e) {}
    await refreshList();
  }

  async function addItem() {
    if(!guardCart()) return;
    const sku = ($('#sku').value||'').trim();
    const qty = parseInt($('#qty').value||'1',10)||1;
    const price = ($('#override_price').value||'').trim();
    const body = { 
  cart_token: CART,
  sku,
  qty,
  line_user_id: getLineUserId(),
  customer_name: getCustomerName()
};
    if(price) { body.price = parseInt(price,10)||0; body.op_key = OP; }
    const res = await jfetch(API+'/cart/add', { method:'POST', body: JSON.stringify(body) });
    if(!res.ok) return alert('åŠ å…¥å¤±æ•—ï¼š'+(res.error||''));
    $('#sku').value='';
    await refreshList();
  }

  async function saveNote() {
    if(!guardCart()) return;
    const note = $('#note').value||'';
    const res = await jfetch(API+'/cart/note', { method:'POST', body: JSON.stringify({ cart_token: CART, note, op_key: OP })});
    if(!res.ok) return alert('å‚™è¨»å¤±æ•—ï¼š'+(res.error||''));
    alert('å·²å„²å­˜å‚™è¨»');
  }

  async function refreshList() {
    if(!guardCart()) return;
    const res = await jfetch(API+'/cart/'+encodeURIComponent(CART));
    const list = res.items||[];
    const ul = $('#items'); ul.innerHTML='';
    let sum = 0;
    list.forEach(it=>{
      sum += (+it.price||0) * (+it.qty||0);
      const li = document.createElement('li');
      li.innerHTML = `<span class="mono">${it.sku}</span><span class="mono right">${it.qty} Ã— ${money(it.price||0)}</span>`;
      ul.appendChild(li);
    });
    $('#total').textContent = money(sum);
  }

  async function clearCart() {
    if(!guardCart()) return;
    if(!OP) return alert('éœ€è¦ OP æ‰èƒ½æ¸…ç©º');
    if(!confirm('ç¢ºå®šæ¸…ç©ºæ•´å€‹è³¼ç‰©è»Šï¼Ÿ')) return;
    const res = await jfetch(API+'/cart/clear', { method:'POST', body: JSON.stringify({cart_token:CART, op_key:OP}) });
    if(!res.ok) return alert('æ¸…ç©ºå¤±æ•—ï¼š'+(res.error||''));
    await refreshList();
  }

// å…±ç”¨ï¼šçµ„å‡ºé€™ä¸€è»Šçš„çµå¸³ç¶²å€
  function buildCheckoutUrl() {
    // ç”¨ LIFF çš„çµå¸³é  IDï¼ˆè·Ÿä½ ç¾åœ¨çš„ä¸€æ¨£ï¼‰
    const LIFF_CHECKOUT_URL = 'https://liff.line.me/2008430261-KLwoQjm4';
    return `${LIFF_CHECKOUT_URL}?cart_token=${encodeURIComponent(CART)}`;
  }

  // åŸæœ¬ã€Œè¤‡è£½çµå¸³é€£çµã€æŒ‰éˆ•
  function linkCheckout() {
    if (!guardCart()) return;

    const url = buildCheckoutUrl();
    $('#link_out').value = url;
    $('#link_out').select();
    document.execCommand('copy');
    alert('å·²è¤‡è£½çµå¸³é€£çµ');
  }


  // â˜… æ–°å¢ï¼šå‘¼å«å¾Œç«¯ï¼Œè«‹å®˜æ–¹ LINE å¹«ä½ ç™¼ Flex å¡ç‰‡
  async function sendCheckoutLinkByLine() {
    if (!guardCart()) return;
    if (!OP) return alert('è«‹å…ˆç™»å…¥ OP Key');

    const lineUserId = ($('#line_user_id').value || '').trim();
    if (!lineUserId) return alert('è«‹å…ˆè²¼ä¸Šå®¢äººçš„ LineUserId');

    const res = await jfetch(API + '/op/cart/send-link', {
      method: 'POST',
      body: JSON.stringify({
        op_key: OP,
        cart_token: CART,
        line_user_id: lineUserId
      })
    });

    if (!res || res.ok !== true) {
      console.log('send-link error', res);
      return alert('ç™¼é€å¤±æ•—ï¼š' + (res && res.error || 'unknown'));
    }

    alert('å·²å¾å®˜æ–¹ LINE ç™¼é€çµå¸³å¡ç‰‡');
    // âœ… ä¿éšªï¼šç™¼é€æˆåŠŸå¾Œå†è¨˜ä¸€æ¬¡ï¼ˆæ­¤æ™‚ä¸€å®šæœ‰ LineUserIdï¼‰
    try { rememberCartForUser(CART); } catch(e) {}
  }
  // â˜… æ–°å¢ï¼šç”¨ LINE åç¨± / æœ¬åæŸ¥è©¢æœƒå“¡ï¼Œæ‰¾åˆ°å°±è‡ªå‹•å¸¶ LineUserId
  async function searchLineMember() {
    if (!OP) {
      alert('è«‹å…ˆç™»å…¥ OP Key');
      return;
    }

    const q = ($('#line_search_name').value || '').trim();
    if (!q) {
      alert('è«‹å…ˆè¼¸å…¥è¦æŸ¥çš„ LINE åç¨±æˆ–æœ¬å');
      return;
    }

    try {
      const res = await jfetch(API + '/op/line-member/search', {
        method: 'POST',
        body: JSON.stringify({
          op_key: OP,
          keyword: q
        })
      });

      if (!res || res.ok !== true) {
        if (res && res.error === 'not_found') {
          alert('æ‰¾ä¸åˆ°ç›¸ç¬¦çš„æœƒå“¡ï¼ˆåç¨±è¦è·Ÿ Airtable ä¸Šçš„ä¸€æ¨¡ä¸€æ¨£ï¼‰');
        } else {
          alert('æœå°‹å¤±æ•—ï¼š' + (res && res.error || 'unknown'));
        }
        return;
      }

      const m = res.member || {};

      // è‡ªå‹•å¸¶å…¥ LineUserId
      $('#line_user_id').value = m.lineUserId || '';
      // âœ… æŠŠæŸ¥åˆ°çš„åå­—å›å¡«ï¼Œè®“ createCart() èƒ½ç›´æ¥æ‹¿ä¾†ç•¶ customer_name
$('#line_search_name').value = (m.displayName || m.name || q || '').trim();
      try { showCartHintIfExists(); } catch(e) {}

      // é¡¯ç¤ºä¸€ä¸‹æ‰¾åˆ°çš„æ˜¯èª°
      const infoEl = $('#line_search_info');
      if (infoEl) {
        const namePart =
          (m.displayName || '') ||
          (m.name || '');
        const phonePart = m.phone ? ` / ${m.phone}` : '';
        infoEl.textContent = `å·²é¸æ“‡ï¼š${namePart}${phonePart}`;
      }
    } catch (e) {
      console.error(e);
      alert('æœå°‹å¤±æ•—ï¼š' + e.message);
    }
  }

// æ–°å¢ï¼šè¤‡è£½ä¸€æ•´æ®µè¦è²¼çµ¦å®¢äººçš„ LINE è¨Šæ¯
function copyLineMessage() {
  if (!guardCart()) return;

  const url = buildCheckoutUrl();
  const totalText = $('#total') ? $('#total').textContent.trim() : '';

  const msgLines = [
    'è¦ªæ„›çš„å¯¶å¯¶æ‚¨å¥½ï¼Œé€™æ˜¯æ‚¨çš„å°ˆå±¬çµå¸³é€£çµï¼š',
    url,
    '',
    totalText ? `æœ¬æ¬¡çµå¸³é‡‘é¡ï¼š${totalText}` : '',
    'è«‹åœ¨ 10 åˆ†é˜å…§å®Œæˆå¡«å¯«èˆ‡é€å‡ºï¼Œå¦‚éœ€èª¿æ•´å¯ä»¥ç›´æ¥å›è¦†æ­¤è¨Šæ¯å–”ğŸ’–'
  ].filter(Boolean);

  const msg = msgLines.join('\n');

  const ta = $('#line_msg');
  if (ta) ta.value = msg;

  // ç›´æ¥è¤‡è£½åˆ°å‰ªè²¼ç°¿
  (ta || $('#link_out')).value = msg;
  (ta || $('#link_out')).select();
  document.execCommand('copy');
  alert('å·²è¤‡è£½ LINE è¨Šæ¯');
}

    // ====== è³¼ç‰©è»Šç®¡ç†ï¼ˆAdminï¼‰======
  function escHtml(s){
    return String(s||"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }

  function getAdminKey(){
    return ($('#admin_key') && ($('#admin_key').value || '').trim()) || '';
  }

  function setCartAdminMsg(txt){
    const el = $('#cart_admin_msg');
    if (el) el.textContent = txt || '';
  }

  function showCartAdminItemsBox(on){
    const box = $('#cart_admin_items_box');
    if (!box) return;
    box.classList.toggle('hidden', !on);
  }

  let ADMIN_SELECTED_CART = '';

  async function cartAdminSearch(){
    if (!OP) return alert('è«‹å…ˆç™»å…¥ OP Key');
    const ak = getAdminKey();
    if (!ak) return alert('è«‹è¼¸å…¥ Admin Key');
    const kw = ($('#cart_admin_kw').value || '').trim();
    if (!kw) return alert('è«‹è¼¸å…¥åå­—æˆ– LineUserId');

    setCartAdminMsg('æœå°‹ä¸­...');
    showCartAdminItemsBox(false);
    ADMIN_SELECTED_CART = '';
    const out = $('#cart_admin_result');
    if (out) out.innerHTML = '';

    const url = API + '/admin/cart/search?kw=' + encodeURIComponent(kw) + '&admin_key=' + encodeURIComponent(ak);
    const res = await jfetch(url, { method:'GET' });

    if (!res || res.ok !== true){
      setCartAdminMsg('æœå°‹å¤±æ•—ï¼š' + (res && (res.error || res.message) || 'unknown'));
      return;
    }

    const carts = res.carts || [];
    setCartAdminMsg(`æ‰¾åˆ° ${carts.length} å°è³¼ç‰©è»Š`);

    if (!out) return;

    if (!carts.length){
      out.innerHTML = `<div class="muted">æ²’æœ‰æ‰¾åˆ°è³¼ç‰©è»Š</div>`;
      return;
    }

    out.innerHTML = carts.map(c=>{
      const token = escHtml(c.cart_token || '');
      const name  = escHtml(c.customer_name || '');
      const uid   = escHtml(c.line_user_id || '');
      const st    = escHtml(c.status || '');
      const up    = escHtml(c.updated_at || '');
      const cnt   = Number(c.item_count || 0) || 0;

      return `
        <div style="padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
            <div style="min-width:260px;">
              <div style="font-weight:800;">
                ${name || '(æœªå¡«åå­—)'} <span class="muted">(${cnt} ä»¶)</span>
              </div>
              <div class="muted" style="margin-top:2px;">
                status: <b>${st || '-'}</b> ï½œ updated: ${up || '-'}
              </div>
              <div class="muted mono" style="margin-top:6px;word-break:break-all;">
                cart_token: ${token}<br/>
                line_user_id: ${uid || '-'}
              </div>
            </div>
            <div style="display:flex;gap:8px;align-items:flex-start;">
              <button class="ghost btn-cart-admin-view" data-token="${token}" style="max-width:140px;">çœ‹æ˜ç´°</button>
            </div>
          </div>
        </div>
      `;
    }).join('');

    // ç¶å®šã€Œçœ‹æ˜ç´°ã€æŒ‰éˆ•
    out.querySelectorAll('.btn-cart-admin-view').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const token = btn.dataset.token || '';
        if (!token) return;

        const ak2 = getAdminKey();
        if (!ak2) return alert('è«‹è¼¸å…¥ Admin Key');

        setCartAdminMsg('è¼‰å…¥æ˜ç´°ä¸­...');
        showCartAdminItemsBox(false);

        const url2 = API + '/admin/cart/items?cart_token=' + encodeURIComponent(token) + '&admin_key=' + encodeURIComponent(ak2);
        const r2 = await jfetch(url2, { method:'GET' });

        if (!r2 || r2.ok !== true){
          setCartAdminMsg('è®€å–æ˜ç´°å¤±æ•—ï¼š' + (r2 && (r2.error || r2.message) || 'unknown'));
          return;
        }

        ADMIN_SELECTED_CART = token;
        $('#cart_admin_token').textContent = token;
        $('#cart_admin_items').value = JSON.stringify(r2.items || [], null, 2);
        showCartAdminItemsBox(true);
        setCartAdminMsg('');
      });
    });
  }

  async function cartAdminExpire(){
    if (!OP) return alert('è«‹å…ˆç™»å…¥ OP Key');
    const ak = getAdminKey();
    if (!ak) return alert('è«‹è¼¸å…¥ Admin Key');
    if (!ADMIN_SELECTED_CART) return alert('è«‹å…ˆã€Œçœ‹æ˜ç´°ã€é¸ä¸€å°è³¼ç‰©è»Š');

    if (!confirm(`ç¢ºå®šæ¸…é™¤æ­¤è³¼ç‰©è»Šï¼Ÿ\n${ADMIN_SELECTED_CART}\n\næœƒåˆªé™¤ CartItems + æ¨™è¨˜ expiredï¼ˆä¸å½±éŸ¿åº«å­˜ï¼‰`)) return;

    setCartAdminMsg('æ¸…é™¤ä¸­...');

    const url = API + '/admin/cart/expire?admin_key=' + encodeURIComponent(ak);
    const r = await jfetch(url, {
      method:'POST',
      body: JSON.stringify({ cart_token: ADMIN_SELECTED_CART })
    });

    if (!r || r.ok !== true){
      setCartAdminMsg('æ¸…é™¤å¤±æ•—ï¼š' + (r && (r.error || r.message) || 'unknown'));
      return;
    }

    setCartAdminMsg(`å·²æ¸…é™¤ï¼šitems_deleted=${r.items_deleted || 0}ï¼ˆcart=${ADMIN_SELECTED_CART}ï¼‰`);
    showCartAdminItemsBox(false);
    ADMIN_SELECTED_CART = '';
  }


  // ---------- quick-price ----------
  const quick = { '#btn-50': -50, '#btn-100': -100, '#btn-999': 999 };
  function applyQuick(v){
    const cur = parseInt($('#override_price').value||'0',10)||0;
    if(v===999) { $('#override_price').value = '999'; return; }
    $('#override_price').value = String(Math.max(0, cur + v));
  }

  // â˜… æ–°å¢ï¼šè¼‰å…¥/æ¸…é™¤ã€Œæ­¤å®¢äººè³¼ç‰©è»Šã€æŒ‰éˆ•äº‹ä»¶ï¼ˆä½ åŸæœ¬ç¼ºé€™æ®µï¼‰
    const btnLoadCart = $('#btn-load-cart');
    if (btnLoadCart) btnLoadCart.addEventListener('click', loadCartForUser);

    const btnClearCartMap = $('#btn-clear-cartmap');
    if (btnClearCartMap) btnClearCartMap.addEventListener('click', clearCartForUser);

    // â˜… æ–°å¢ï¼šæ‰‹å‹•è²¼ä¸Š LineUserId æ™‚ï¼Œå³æ™‚æç¤ºæ˜¯å¦æœ‰è¨˜ä½çš„è³¼ç‰©è»Š
    const lineUserInput = $('#line_user_id');
    if (lineUserInput) {
      lineUserInput.addEventListener('input', () => {
        try { showCartHintIfExists(); } catch(e) {}
      });
    }

  // ---------- init ----------
  window.addEventListener('DOMContentLoaded', async ()=>{
    // ç¶å®šäº‹ä»¶ï¼ˆç¢ºä¿ã€Œç™»å…¥éµæœ‰åæ‡‰ã€ï¼‰
    $('#btn-login').addEventListener('click', doLogin);
    $('#btn-create').addEventListener('click', createCart);
    $('#btn-add').addEventListener('click', addItem);
    $('#btn-note').addEventListener('click', saveNote);
    $('#btn-refresh').addEventListener('click', refreshList);
    $('#btn-clear').addEventListener('click', clearCart);
    $('#btn-link').addEventListener('click', linkCheckout);
    // â˜… æ–°å¢ï¼šæœå°‹æœƒå“¡ï¼ˆç”¨ LINE åç¨± / æœ¬åï¼‰
  const btnSearchLine = $('#btn-search-line');
  if (btnSearchLine) {
    btnSearchLine.addEventListener('click', searchLineMember);
  }
     // â˜… æ–°å¢ï¼šå¾å®˜æ–¹ LINE ç™¼çµå¸³å¡ç‰‡
    const btnSendLink = $('#btn-send-link');
    if (btnSendLink) {
      btnSendLink.addEventListener('click', sendCheckoutLinkByLine);
    }

    // ======ï¼ˆé€™è£¡é–‹å§‹è²¼ï¼šè³¼ç‰©è»Šç®¡ç† Admin äº‹ä»¶ï¼‰======
    const adminKeyInput = $('#admin_key');
    if (adminKeyInput) {
      // è¨˜ä½ Admin Keyï¼ˆå­˜åœ¨æœ¬æ©Ÿï¼Œä¸å¯«æ­»åœ¨ç¨‹å¼ç¢¼ï¼‰
      const savedAk = localStorage.getItem('ADMIN_KEY') || '';
      if (savedAk) adminKeyInput.value = savedAk;
      adminKeyInput.addEventListener('change', ()=> {
        localStorage.setItem('ADMIN_KEY', adminKeyInput.value || '');
      });
    }

    const btnCartAdminSearch = $('#btn-cart-admin-search');
    if (btnCartAdminSearch) btnCartAdminSearch.addEventListener('click', cartAdminSearch);

    const btnCartAdminExpire = $('#btn-cart-admin-expire');
    if (btnCartAdminExpire) btnCartAdminExpire.addEventListener('click', cartAdminExpire);
    // ======ï¼ˆé€™è£¡çµæŸè²¼ä¸Šï¼‰======
   
     Object.keys(quick).forEach(sel=>{
      const v = quick[sel];
      document.querySelector(sel).addEventListener('click', ()=>applyQuick(v));
    });
    // è‡ªå‹•å¸¶å› OPï¼ˆè‹¥æœ‰å­˜ï¼‰
    const saved = localStorage.getItem('OP_KEY');
    if(saved) { $('#op_key').value = saved; OP = saved; setLoginUI(true); }
  });
})();
</script>
</body>
</html>
