<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MURAIN — 直播主開單</title>
<style>
  :root { --bg:#f7f7f8; --card:#fff; --txt:#222; --muted:#6b7280; --pri:#111; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Noto Sans TC, sans-serif; background:var(--bg); color:var(--txt); }
  .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
  .card { background:var(--card); border-radius: 12px; box-shadow: 0 10px 20px rgba(0,0,0,.05);
          padding: 20px; margin-bottom: 18px; }
  h2 { margin: 0 0 12px; font-size: 20px; }
  .row { display:flex; gap:10px; flex-wrap:wrap; }
  .row > * { flex: 1 1 220px; }
  input, select, button, textarea {
    width: 100%; box-sizing: border-box; padding: 10px 12px; border-radius: 10px; border:1px solid #e5e7eb; font-size: 15px;
  }
  button { background:#111; color:#fff; cursor:pointer; border:none; }
  button.ghost { background:#fff; color:#111; border:1px solid #e5e7eb; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .muted { color: var(--muted); font-size: 13px; }
  .hidden { display:none !important; }
  .list { margin: 8px 0 0; padding:0; list-style:none; }
  .list li { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #eee; }
  .right { text-align:right; }
  .grid2 { display:grid; grid-template-columns: 1fr auto; gap:10px; align-items: center; }
</style>
<script>window.API_BASE = "https://api.murain.tw";</script>
  <meta name="robots" content="noindex, nofollow">
</head>
<body>
<div class="wrap">

  <!-- 登入 -->
  <div class="card" id="card-login">
    <h2>主播開單登入</h2>
    <div class="row">
      <div style="flex:2">
        <label class="muted">OP 密碼</label>
        <input id="op_key" class="mono" placeholder="輸入 OP Key" />
      </div>
      <div style="align-self:end; flex:1">
        <button id="btn-login">登入</button>
      </div>
    </div>
    <div class="muted" style="margin-top:6px">成功後會緩存於此裝置，關閉視窗後需重新登入。</div>
  </div>

  <!-- 開單 -->
  <div class="card hidden" id="card-app">
    <h2>建立購物車</h2>
    <div class="row">
      <div style="flex:2">
        <label class="muted">主播名稱</label>
        <input id="streamer" placeholder="例如：小沐" />
      </div>
      <div style="flex:1">
        <label class="muted">客群</label>
        <select id="customer_type">
          <option value="live">直播</option>
          <option value="regular">一般</option>
        </select>
      </div>
      <div style="flex:1; align-self:end">
        <button id="btn-create">建立</button>
      </div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <div class="muted">CartToken：<span id="cart_token" class="mono muted">尚未建立</span></div>
      <button class="ghost" id="btn-refresh">重整清單</button>
    </div>
  </div>

  <!-- 加商品 -->
  <div class="card hidden" id="card-add">
    <h2>加入商品</h2>
    <div class="row">
      <div><label class="muted">SKU</label><input id="sku" class="mono" placeholder="AA001..." /></div>
      <div style="max-width:130px"><label class="muted">數量</label><input id="qty" value="1" /></div>
      <div><label class="muted">改價</label><input id="override_price" placeholder="可留空" /></div>
      <div style="align-self:end"><button id="btn-add">加入</button></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="ghost" id="btn-50" style="max-width:120px">-50</button>
      <button class="ghost" id="btn-100" style="max-width:120px">-100</button>
      <button class="ghost" id="btn-999" style="max-width:120px">特價 999</button>
    </div>
    <div class="row" style="margin-top:10px">
      <div style="flex:3"><input id="note" placeholder="備註 / 贈品說明" /></div>
      <div style="flex:1"><button class="ghost" id="btn-note">儲存備註</button></div>
    </div>
  </div>

  <!-- 結帳 & 清單 -->
  <div class="card hidden" id="card-list">
  <h2>產生結帳連結</h2>
  <div class="row">
    <button id="btn-link" class="ghost">複製結帳連結</button>
  </div>
  <input id="link_out" class="mono" readonly style="margin-top:10px" />

    <ul id="items" class="list"></ul>
    <div class="grid2" style="margin-top:8px">
      <div class="muted">合計</div>
      <div class="right mono" id="total">NT$ 0</div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="ghost" id="btn-clear">清空購物車（需 OP）</button>
    </div>
  </div>

</div>

<script>
(async function () {
  const API = window.API_BASE;
  const $  = (s)=>document.querySelector(s);

  let OP = '';
  let CART = '';

  // ---------- helpers ----------
  async function jfetch(url, opt) {
    const r = await fetch(url, Object.assign({headers:{'content-type':'application/json'}}, opt||{}));
    const txt = await r.text();
    try { return JSON.parse(txt); } catch { return {raw:txt}; }
  }
  function money(n){ n = +n||0; return 'NT$ ' + n.toLocaleString(); }
  function guardCart(){ if(!CART){ alert('請先建立購物車'); return false; } return true; }
  function setLoginUI(on){
    $('#card-login').classList.toggle('hidden', !!on);
    $('#card-app').classList.toggle('hidden', !on);
    $('#card-add').classList.toggle('hidden', !on);
    $('#card-list').classList.toggle('hidden', !on);
  }
  function setCartToken(t) {
    CART = t||'';
    $('#cart_token').textContent = t||'尚未建立';
    $('#btn-clear').disabled = !OP;
  }

  // ---------- actions ----------
  async function doLogin() {
    const v = ($('#op_key').value||'').trim();
    if(!v) return alert('請輸入 OP Key');
    const res = await jfetch(API+'/op/auth', { method:'POST', body: JSON.stringify({ op_key: v }) });
    if(!res || res.ok!==true) return alert('OP Key 錯誤');
    OP = v; localStorage.setItem('OP_KEY', v);
    setLoginUI(true);
  }

  async function createCart() {
    const streamer = ($('#streamer').value||'').trim();
    const customer_type = $('#customer_type').value || 'live';
    const res = await jfetch(API+'/cart/create', { method:'POST', body: JSON.stringify({ streamer_name: streamer||'未命名', customer_type }) });
    if(!res.ok) return alert('建立失敗：'+(res.error||''));
    setCartToken(res.cart_token);
    await refreshList();
  }

  async function addItem() {
    if(!guardCart()) return;
    const sku = ($('#sku').value||'').trim();
    const qty = parseInt($('#qty').value||'1',10)||1;
    const price = ($('#override_price').value||'').trim();
    const body = { cart_token: CART, sku, qty };
    if(price) { body.price = parseInt(price,10)||0; body.op_key = OP; }
    const res = await jfetch(API+'/cart/add', { method:'POST', body: JSON.stringify(body) });
    if(!res.ok) return alert('加入失敗：'+(res.error||''));
    $('#sku').value='';
    await refreshList();
  }

  async function saveNote() {
    if(!guardCart()) return;
    const note = $('#note').value||'';
    const res = await jfetch(API+'/cart/note', { method:'POST', body: JSON.stringify({ cart_token: CART, note, op_key: OP })});
    if(!res.ok) return alert('備註失敗：'+(res.error||''));
    alert('已儲存備註');
  }

  async function refreshList() {
    if(!guardCart()) return;
    const res = await jfetch(API+'/cart/'+encodeURIComponent(CART));
    const list = res.items||[];
    const ul = $('#items'); ul.innerHTML='';
    let sum = 0;
    list.forEach(it=>{
      sum += (+it.price||0) * (+it.qty||0);
      const li = document.createElement('li');
      li.innerHTML = `<span class="mono">${it.sku}</span><span class="mono right">${it.qty} × ${money(it.price||0)}</span>`;
      ul.appendChild(li);
    });
    $('#total').textContent = money(sum);
  }

  async function clearCart() {
    if(!guardCart()) return;
    if(!OP) return alert('需要 OP 才能清空');
    if(!confirm('確定清空整個購物車？')) return;
    const res = await jfetch(API+'/cart/clear', { method:'POST', body: JSON.stringify({cart_token:CART, op_key:OP}) });
    if(!res.ok) return alert('清空失敗：'+(res.error||''));
    await refreshList();
  }

  function linkCheckout() {
  if (!guardCart()) return;

  // 用 LIFF 的結帳頁 ID
  const LIFF_CHECKOUT_URL = 'https://liff.line.me/2008430261-KLwoQjm4';

  $('#link_out').value = `${LIFF_CHECKOUT_URL}?cart_token=${encodeURIComponent(CART)}`;
  $('#link_out').select();
  document.execCommand('copy');
  alert('已複製結帳連結');
}


  // ---------- quick-price ----------
  const quick = { '#btn-50': -50, '#btn-100': -100, '#btn-999': 999 };
  function applyQuick(v){
    const cur = parseInt($('#override_price').value||'0',10)||0;
    if(v===999) { $('#override_price').value = '999'; return; }
    $('#override_price').value = String(Math.max(0, cur + v));
  }

  // ---------- init ----------
  window.addEventListener('DOMContentLoaded', async ()=>{
    // 綁定事件（確保「登入鍵有反應」）
    $('#btn-login').addEventListener('click', doLogin);
    $('#btn-create').addEventListener('click', createCart);
    $('#btn-add').addEventListener('click', addItem);
    $('#btn-note').addEventListener('click', saveNote);
    $('#btn-refresh').addEventListener('click', refreshList);
    $('#btn-clear').addEventListener('click', clearCart);
    $('#btn-link').addEventListener('click', linkCheckout);
    Object.keys(quick).forEach(sel=>{
      const v = quick[sel];
      document.querySelector(sel).addEventListener('click', ()=>applyQuick(v));
    });

    // 自動帶回 OP（若有存）
    const saved = localStorage.getItem('OP_KEY');
    if(saved) { $('#op_key').value = saved; OP = saved; setLoginUI(true); }
  });
})();
</script>
</body>
</html>
