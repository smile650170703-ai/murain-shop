<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MURAIN — 主播開單 (LIVE)</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#222;--muted:#666;--pri:#111;--btn:#111;--btnfg:#fff;border-radius:12px}
    body{font-family:system-ui,'Segoe UI',PingFang TC,Microsoft JhengHei,sans-serif;background:var(--bg);margin:0}
    .wrap{max-width:960px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.07);padding:20px 20px;margin:16px 0}
    h2{margin:0 0 12px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,select,button{font-size:16px;padding:10px;border:1px solid #ddd;border-radius:10px}
    input:focus,select:focus{outline:none;border-color:#999}
    .mono{font-family:ui-monospace,Consolas,monospace}
    .btn{background:var(--btn);color:var(--btnfg);border:none;padding:10px 18px;border-radius:10px;cursor:pointer}
    .btn.ghost{background:#eee;color:#222}
    .muted{color:var(--muted);font-size:14px}
    .pill{padding:6px 10px;background:#f0f0f0;border-radius:999px;cursor:pointer}
    .bar{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
    .grid{border-top:1px dashed #ddd;margin-top:8px}
    .grid .item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #eee}
  </style>
  <script>window.API_BASE="https://api.murain.tw";</script>
</head>
<body>
<div class="wrap">
  <div class="card" id="loginCard">
    <h2>主播開單登入</h2>
    <div class="row">
      <input id="op_key" placeholder="OP 密碼 (預設 88)" class="mono" style="flex:1">
      <button class="btn" id="btn_login">登入</button>
    </div>
    <p class="muted">登入後會保存在本機（localStorage），重開網頁若要換人再按登出或清瀏覽資料。</p>
  </div>

  <div class="card" id="opCard" style="display:none">
    <div class="bar">
      <h2>建立購物車</h2>
      <button class="btn ghost" id="btn_logout">登出</button>
    </div>
    <div class="row">
      <input id="streamer" placeholder="主播名稱" style="flex:1">
      <select id="ctype">
        <option value="live">直播單（需 OP 才能清空/移除）</option>
      </select>
      <button class="btn" id="btn_create">建立</button>
    </div>
    <div class="muted">CartToken：<span id="cartToken" class="mono">尚未建立</span></div>
  </div>

  <div class="card" id="addCard" style="display:none">
    <h2>加入商品</h2>
    <div class="row">
      <input id="sku" placeholder="SKU" style="flex:1">
      <input id="qty" type="number" min="1" value="1" style="width:90px">
      <input id="price_override" placeholder="改價（需 OP）" style="flex:1">
      <button class="btn" id="btn_add">加入</button>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="pill" data-dv="-50">-50</span>
      <span class="pill" data-dv="-100">-100</span>
      <span class="pill" data-sp="999">特價 999</span>
    </div>
    <div class="row" style="margin-top:8px">
      <select id="gift">
        <option value="">— 常用贈品 —</option>
        <option>小樣旅行包</option>
        <option>髮膜試用包</option>
        <option>下次購物金 100</option>
      </select>
      <input id="note" placeholder="備註 / 贈品說明" style="flex:1">
      <button class="btn ghost" id="btn_note">儲存備註</button>
    </div>
  </div>

  <div class="card" id="linkCard" style="display:none">
    <h2>產生結帳連結</h2>
    <div class="row">
      <button class="btn" id="btn_link_bank">新客匯款</button>
      <button class="btn ghost" id="btn_link_cod">老客 7-11 COD / 其他金流示範</button>
    </div>
    <input id="checkout_link" class="mono" style="width:100%;margin-top:8px" readonly>
  </div>

  <div class="card" id="cartCard" style="display:none">
    <h2>購物車清單</h2>
    <div class="grid" id="cartGrid"></div>
    <div class="bar">
      <div class="muted">合計：<span id="total" class="mono">NT$ 0</span></div>
      <div>
        <button class="btn ghost" id="btn_clear">清空（需 OP）</button>
      </div>
    </div>
  </div>
</div>

<script>
const API = window.API_BASE;
const $ = s => document.querySelector(s);
const LS = {
  get k(){ return localStorage.getItem('M_OP_KEY')||''; },
  set k(v){ localStorage.setItem('M_OP_KEY', v||''); },
};
let CART = '';

function headers(){ const h={'content-type':'application/json'}; if(LS.k) h.authorization='Bearer '+LS.k; return h; }
function alertErr(e){ alert(e?.message||e||'Error'); }

async function opLogin(){
  const r = await fetch(API+'/op/auth',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({op_key:LS.k})});
  if(!r.ok){ throw new Error('OP Key 錯誤'); }
  return true;
}
function ui(){
  const logged = !!LS.k;
  $('#loginCard').style.display = logged ? 'none' : '';
  $('#opCard').style.display = logged ? '' : 'none';
  $('#addCard').style.display = CART ? '' : 'none';
  $('#linkCard').style.display = CART ? '' : 'none';
  $('#cartCard').style.display = CART ? '' : 'none';
}

async function refreshCart(){
  if(!CART) return;
  const r = await fetch(API+'/cart/'+CART);
  if(!r.ok){ $('#cartGrid').innerHTML=''; $('#total').textContent='NT$ 0'; return; }
  const d = await r.json();
  const g = d.items||[];
  $('#cartGrid').innerHTML = g.map(i=>`<div class="item"><div>${i.sku} — ${i.name} x ${i.qty}</div><div class="mono">NT$ ${i.subtotal}</div></div>`).join('') || '<div class="muted">尚無商品</div>';
  $('#total').textContent = 'NT$ ' + (d.total_amount||0);
}

$('#btn_login').onclick = async () => {
  LS.k = $('#op_key').value.trim();
  try{ await opLogin(); ui(); }catch(e){ LS.k=''; alert(e.message||e); }
};

$('#btn_logout').onclick = ()=>{ LS.k=''; CART=''; $('#cartToken').textContent='尚未建立'; ui(); };

$('#btn_create').onclick = async () => {
  try{
    const r = await fetch(API+'/cart/create',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({streamer_name:$('#streamer').value||'',customer_type:'live'})});
    if(!r.ok) throw new Error('Failed to fetch');
    const d = await r.json();
    CART = d.cart_token; $('#cartToken').textContent = CART; ui(); refreshCart();
  }catch(e){ alert('Failed to fetch'); }
};

$('#btn_add').onclick = async () => {
  if(!CART) return alert('請先建立購物車');
  const sku = $('#sku').value.trim(); if(!sku) return alert('請輸入 SKU');
  const qty = parseInt($('#qty').value||'1',10)||1;
  const price = $('#price_override').value.trim();
  const body = { cart_token:CART, sku, qty };
  if(price) body.price = parseInt(price,10)||0;
  body.op_key = LS.k;
  const r = await fetch(API+'/cart/add',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body)});
  if(!r.ok){ const t=await r.text(); return alert(t||'加入失敗'); }
  $('#sku').value=''; $('#qty').value='1'; $('#price_override').value='';
  refreshCart();
};

$('#btn_note').onclick = async () => {
  if(!CART) return;
  const txt = [$('#gift').value,$('#note').value].filter(Boolean).join(' / ');
  await fetch(API+'/cart/note',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({cart_token:CART,note:txt})});
  alert('已儲存');
};

$('#btn_clear').onclick = async () => {
  if(!CART) return;
  if(!confirm('確定清空？')) return;
  const r = await fetch(API+'/cart/clear',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({cart_token:CART,op_key:LS.k})});
  if(!r.ok) return alert('需要 OP');
  refreshCart();
};

// 快捷改價按鈕
document.querySelectorAll('[data-dv]').forEach(el=>el.onclick=()=>{
  const v = parseInt($('#price_override').value||'0',10)||0;
  $('#price_override').value = String(v + parseInt(el.dataset.dv,10));
});
document.querySelectorAll('[data-sp]').forEach(el=>el.onclick=()=>{
  $('#price_override').value = el.dataset.sp;
});

function buildLink(pm){ return location.origin + '/checkout.html?cart_token=' + encodeURIComponent(CART) + '&pm=' + encodeURIComponent(pm); }
$('#btn_link_bank').onclick = ()=>{ if(!CART) return alert('請先建立'); $('#checkout_link').value = buildLink('bank_transfer'); $('#checkout_link').select(); document.execCommand('copy'); };
$('#btn_link_cod').onclick  = ()=>{ if(!CART) return alert('請先建立'); $('#checkout_link').value = buildLink('cod_711'); $('#checkout_link').select(); document.execCommand('copy'); };

// 自動帶入已登入
if(localStorage.getItem('M_OP_KEY')){ $('#op_key').value = LS.k; try{ await opLogin(); }catch(e){} }
ui();
</script>
</body>
</html>
