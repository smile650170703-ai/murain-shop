<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MURAIN — 簡易主播開單</title>
  <style>
    body { margin:0; font-family: system-ui, 'Noto Sans TC', Arial; background:#f6f7fb; }
    .wrap { max-width:900px; margin:24px auto; padding:0 16px; }
    .card { background:#fff; border-radius:14px; box-shadow:0 6px 24px rgba(0,0,0,.06); padding:18px; margin-bottom:14px; }
    .row { display:grid; grid-template-columns: repeat(12,1fr); gap:10px; }
    .col-3{grid-column:span 3} .col-4{grid-column:span 4} .col-6{grid-column:span 6} .col-9{grid-column:span 9} .col-12{grid-column:span 12}
    input, button, select { width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:10px; }
    button.btn { background:#111; color:#fff; border:none; cursor:pointer; }
    table { width:100%; border-collapse: collapse; }
    th,td { padding:10px; border-bottom:1px solid #eee; }
    td.right { text-align:right; }
    .mut { color:#777; font-size:.9rem; }
    .hide { display:none; }
  </style>
  <script>window.API_BASE="https://api.murain.tw";</script>
</head>
<body>
  <div class="wrap">
    <div id="gate" class="card">
      <h3>開單登入</h3>
      <div class="row">
        <div class="col-6">
          <input id="op_key" type="password" placeholder="OP Key（預設 88）" />
        </div>
        <div class="col-3"><button id="btnLogin" class="btn">登入</button></div>
        <div class="col-12 mut">此頁僅內部使用；未登入不可建立/修改購物車。</div>
      </div>
    </div>

    <div id="app" class="hide">
      <div class="card">
        <h3>建立購物車</h3>
        <div class="row">
          <div class="col-6"><input id="streamer" placeholder="主播名稱" /></div>
          <div class="col-3"><button id="btnCreate" class="btn">建立</button></div>
          <div class="col-12 mut">CartToken：<span id="cartToken">尚未建立</span></div>
        </div>
      </div>

      <div class="card">
        <h3>加入商品（無改價）</h3>
        <div class="row">
          <div class="col-4"><input id="sku" placeholder="SKU" /></div>
          <div class="col-3"><input id="qty" type="number" value="1" /></div>
          <div class="col-3"><button id="btnAdd" class="btn">加入</button></div>
        </div>
      </div>

      <div class="card">
        <h3>結帳連結</h3>
        <div class="row">
          <div class="col-3"><button id="linkBank" class="btn">新客匯款</button></div>
          <div class="col-5"><button id="linkCod" class="btn">老客 7-11 COD / 其他</button></div>
          <div class="col-12"><input id="share" readonly /></div>
        </div>
      </div>

      <div class="card">
        <h3>購物車清單</h3>
        <table>
          <thead><tr><th>SKU</th><th>品名</th><th class="right">單價</th><th class="right">數量</th><th class="right">小計</th></tr></thead>
          <tbody id="lines"></tbody>
          <tfoot><tr><td colspan="5" class="right"><b>合計 NT$ <span id="total">0</span></b></td></tr></tfoot>
        </table>
      </div>
    </div>
  </div>

<script>
const API = window.API_BASE;
let CART=null, OP='';

function $(q){return document.querySelector(q);}
const fmt = n => (n||0).toLocaleString();

async function ensureAuth(){
  const r = await fetch(API + '/op/auth', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({key:OP})});
  if(!r.ok) throw new Error('OP 驗證失敗');
  $('#gate').classList.add('hide'); $('#app').classList.remove('hide');
}

$('#btnLogin').onclick = async ()=>{ OP=$('#op_key').value||'88'; try{await ensureAuth(); localStorage.setItem('OP_KEY',OP);}catch(e){alert(e.message)} };
window.addEventListener('load', async ()=>{ const k=localStorage.getItem('OP_KEY'); if(k){OP=k; try{await ensureAuth();}catch{}} });

$('#btnCreate').onclick = async ()=>{
  const r = await fetch(API + '/cart/create', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({streamer_name:$('#streamer').value||'主播', customer_type:'live'})});
  const d = await r.json(); if(!d.ok) return alert('建立失敗');
  CART=d.cart_token; $('#cartToken').textContent=CART; render();
};

$('#btnAdd').onclick = async ()=>{
  if(!CART) return alert('先建立購物車');
  const body = { cart_token:CART, sku:$('#sku').value.trim(), qty:parseInt($('#qty').value||'1',10)||1, op_key:OP };
  const r = await fetch(API + '/cart/add', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
  const d = await r.json(); if(!d.ok) return alert('加入失敗');
  $('#sku').value=''; $('#qty').value='1'; render();
};

function toLink(pm){
  if(!CART) return alert('先建立購物車');
  const u = new URL(location.origin + '/checkout.html');
  u.searchParams.set('cart_token', CART);
  u.searchParams.set('pm', pm);
  $('#share').value=u.toString();
}
$('#linkBank').onclick = ()=>toLink('bank_transfer');
$('#linkCod').onclick  = ()=>toLink('cod_711');

async function render(){
  if(!CART) return; const r = await fetch(API + '/cart/' + CART); const d = await r.json();
  const tb = $('#lines'); tb.innerHTML='';
  (d.items||[]).forEach(i=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i.sku||''}</td><td>${i.name||''}</td><td class="right">NT$ ${(i.price||0).toLocaleString()}</td><td class="right">${i.qty||0}</td><td class="right">NT$ ${((i.price||0)*(i.qty||0)).toLocaleString()}</td>`;
    tb.appendChild(tr);
  });
  $('#total').textContent = (d.total||0).toLocaleString();
}
</script>
</body>
</html>
