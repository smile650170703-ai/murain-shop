<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>XUYUAN | æœƒå“¡ç¶å®š</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  
  <!-- å¼•å…¥å“ç‰Œå­—é«” -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            gold: '#D4AF37',
            goldLight: '#F3E5AB',
            dark: '#050505',
            card: '#111',
          },
          fontFamily: {
            serif: ['"Playfair Display"', 'serif'],
            sans: ['"Lato"', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <style>
    body {
      margin: 0;
      background-color: #050505; /* çµ±ä¸€èƒŒæ™¯è‰² */
      color: #fff;
      font-family: "Lato", sans-serif;
      overscroll-behavior: none;
    }
    .fade-in { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) both; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* é‡‘è‰²å…‰æšˆå‹•ç•« */
    .glow-gold {
      box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
    }
  </style>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-dark text-white h-[100dvh] flex flex-col">
  <div id="root" class="flex-1 flex flex-col"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function App() {
      // ===== è¨­å®š =====
      const LIFF_ID = "2008430261-kOeNLR9x";
      const API_BASE = "https://api.murain.tw";
      const GEMINI_API_KEY = ""; 

      // ===== ç‹€æ…‹ =====
      const [step, setStep] = useState(0); 
      const [isLoading, setIsLoading] = useState(false);
      const [statusMsg, setStatusMsg] = useState("");
      const [lineProfile, setLineProfile] = useState(null);
      const [formData, setFormData] = useState({ phone: "", name: "", email: "" });
      
      const [isCheckingName, setIsCheckingName] = useState(false);
      const [nameAnalysis, setNameAnalysis] = useState(null);
      const [fortune, setFortune] = useState("");
      const [isFortuneLoading, setIsFortuneLoading] = useState(false);

      // ===== LIFF =====
      useEffect(() => {
        const script = document.createElement("script");
        script.src = "https://static.line-scdn.net/liff/edge/2/sdk.js";
        script.onload = () => initLiff();
        document.body.appendChild(script);
      }, []);

      async function initLiff() {
        try {
          if (!window.liff) return;
          setStatusMsg("INITIALIZING...");
          await window.liff.init({ liffId: LIFF_ID });
          
          if (!window.liff.isLoggedIn()) {
            window.liff.login({ scope: "profile openid email" });
            return;
          }

          const profile = await window.liff.getProfile();
          setLineProfile(profile);
          
          let autoEmail = "";
          try {
            const token = window.liff.getDecodedIDToken?.();
            if (token && token.email) autoEmail = token.email;
          } catch (e) {}

          setFormData((prev) => ({ ...prev, email: autoEmail }));
          setStatusMsg("");
        } catch (e) {
          console.error(e);
          setStatusMsg("INIT FAILED");
          // é è¦½æ¨¡å¼
          if (!navigator.userAgent.includes("Line")) {
            setLineProfile({ displayName: "Guest", userId: "U123", pictureUrl: "" });
            setStatusMsg("");
          }
        }
      }

      // ===== Gemini =====
      async function checkNameWithGemini(name) {
        if (!name) return;
        if (!GEMINI_API_KEY) {
          setNameAnalysis({ isValid: true, suggestion: "æ ¼å¼æ­£ç¢º (Demo)" });
          return;
        }
        setIsCheckingName(true);
        setNameAnalysis(null);
        try {
          const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ parts: [{ text: `Check if "${name}" is a valid Chinese name. Return JSON:{"isValid":bool,"suggestion":string}` }] }],
              generationConfig: { responseMimeType: "application/json" }
            })
          });
          const d = await r.json();
          setNameAnalysis(JSON.parse(d.candidates[0].content.parts[0].text));
        } catch (e) {} finally { setIsCheckingName(false); }
      }

      async function generateFortune() {
        if (!GEMINI_API_KEY) {
          setFortune("ä»Šæ—¥é‹å‹¢ï¼šé©åˆè³¼å…¥è³ªæ„Ÿå–®å“ï¼Œå±•ç¾è‡ªä¿¡å…‰å½©ã€‚");
          return;
        }
        setIsFortuneLoading(true);
        try {
          const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ parts: [{ text: `Give a short shopping fortune for "${formData.name}" in Traditional Chinese, max 30 chars, elegant tone.` }] }]
            })
          });
          const d = await r.json();
          setFortune(d.candidates[0].content.parts[0].text);
        } catch (e) {
          setFortune("ä»Šæ—¥é‹å‹¢ï¼šé©åˆè³¼å…¥è³ªæ„Ÿå–®å“ï¼Œå±•ç¾è‡ªä¿¡å…‰å½©ã€‚");
        } finally { setIsFortuneLoading(false); }
      }

      // ===== Handlers =====
      function handleInputChange(e) {
        setFormData({ ...formData, [e.target.name]: e.target.value });
        if (e.target.name === "name") setNameAnalysis(null);
      }

      function handleNext() {
        if (step === 1 && !formData.phone) return alert("è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼");
        setStep((p) => p + 1);
      }

      function handleBack() { if (step > 0) setStep((p) => p - 1); }

      async function handleBind() {
        if (!formData.name || !formData.phone) return alert("è«‹å®Œæ•´å¡«å¯«è³‡æ–™");
        setIsLoading(true);
        setStatusMsg("PROCESSING...");
        
        try {
          const body = {
            line_user_id: lineProfile?.userId,
            display_name: lineProfile?.displayName || "",
            picture_url: lineProfile?.pictureUrl || "",
            phone: formData.phone,
            email: formData.email,
            name: formData.name
          };
          
          const r = await fetch(API_BASE + "/line/bind-member", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });
          const j = await r.json().catch(()=>({}));
          if(!r.ok || !j.ok) throw new Error(j.error);

          setStep(3);
          generateFortune();
          setTimeout(handleClose, 6000);
        } catch (e) {
          alert("ç¶å®šå¤±æ•—ï¼Œè«‹é‡è©¦");
        } finally { setIsLoading(false); }
      }

      function handleClose() {
        if (window.liff?.isInClient()) window.liff.closeWindow();
        else window.location.href = "https://line.me/";
      }

      // ===== UI Components =====
      return (
        <div className="flex-1 flex flex-col items-center px-6 relative overflow-hidden">
          
          {/* èƒŒæ™¯è£é£¾ (æ¥µç°¡å…‰å½±) */}
          <div className="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-white/5 to-transparent pointer-events-none" />
          
          {/* Header */}
          <div className="w-full h-20 flex items-center justify-between z-10">
            {step > 0 && step < 3 ? (
              <button onClick={handleBack} className="text-white/50 hover:text-gold transition text-xl">â†</button>
            ) : <div />}
            <div className="font-serif text-gold tracking-widest font-bold text-lg">XUYUAN</div>
            <div className="w-5" />
          </div>

          {/* Progress Dots */}
          {step < 3 && (
            <div className="flex gap-2 mb-8 z-10">
              {[0, 1, 2].map(s => (
                <div key={s} className={`h-1 rounded-full transition-all duration-500 ${step >= s ? 'w-8 bg-gold' : 'w-2 bg-white/20'}`} />
              ))}
            </div>
          )}

          {/* Main Content Area */}
          <div className="w-full max-w-sm flex-1 flex flex-col justify-center pb-20 z-10">
            
            {/* Step 0: Welcome */}
            {step === 0 && (
              <div className="fade-in text-center">
                <div className="relative w-24 h-24 mx-auto mb-8">
                  <div className="absolute inset-0 border border-gold/30 rounded-full animate-[spin_10s_linear_infinite]" />
                  <div className="w-full h-full rounded-full overflow-hidden border-2 border-gold bg-card flex items-center justify-center shadow-[0_0_30px_rgba(212,175,55,0.15)]">
                    {lineProfile?.pictureUrl ? (
                      <img src={lineProfile.pictureUrl} className="w-full h-full object-cover" />
                    ) : <span className="text-2xl">ğŸ‘¤</span>}
                  </div>
                </div>
                
                <h1 className="font-serif text-3xl mb-2 text-white">Welcome</h1>
                <p className="text-gold mb-6 tracking-widest text-sm uppercase">{lineProfile?.displayName || 'GUEST'}</p>
                <p className="text-white/40 text-xs font-light leading-relaxed mb-10">
                  Join our exclusive membership.<br/>
                  Unlock premium rewards.
                </p>

                <button onClick={handleNext} disabled={!lineProfile} 
                  className="w-full py-4 bg-gold text-black font-bold uppercase tracking-widest text-xs hover:bg-white transition-colors disabled:opacity-50">
                  Start Registration
                </button>
              </div>
            )}

            {/* Step 1: Phone */}
            {step === 1 && (
              <div className="fade-in">
                <div className="mb-8">
                  <div className="text-gold text-xs tracking-widest mb-2 uppercase">Step 01</div>
                  <h2 className="font-serif text-3xl text-white">Mobile Number</h2>
                </div>

                <div className="bg-[#111] border-b border-white/20 focus-within:border-gold transition-colors mb-10">
                  <input 
                    type="tel" name="phone" autoFocus
                    value={formData.phone} onChange={handleInputChange}
                    placeholder="0912-345-678"
                    className="w-full bg-transparent text-white text-xl py-4 px-2 outline-none font-light placeholder:text-white/20"
                  />
                </div>

                <button onClick={handleNext} className="w-full py-4 bg-gold text-black font-bold uppercase tracking-widest text-xs hover:bg-white transition-colors">
                  Next Step
                </button>
              </div>
            )}

            {/* Step 2: Name */}
            {step === 2 && (
              <div className="fade-in">
                <div className="mb-8">
                  <div className="text-gold text-xs tracking-widest mb-2 uppercase">Step 02</div>
                  <h2 className="font-serif text-3xl text-white">Full Name</h2>
                  <p className="text-white/30 text-xs mt-2">Please match your legal ID.</p>
                </div>

                <div className="relative bg-[#111] border-b border-white/20 focus-within:border-gold transition-colors mb-4">
                  <input 
                    type="text" name="name"
                    value={formData.name} onChange={handleInputChange}
                    placeholder="Your Name"
                    className="w-full bg-transparent text-white text-xl py-4 px-2 outline-none font-light placeholder:text-white/20"
                  />
                  <button onClick={() => checkNameWithGemini(formData.name)} disabled={!formData.name || isCheckingName}
                    className="absolute right-0 top-4 text-[10px] text-gold border border-gold/50 px-2 py-1 uppercase tracking-wider hover:bg-gold hover:text-black transition">
                    {isCheckingName ? "Checking..." : "AI Check"}
                  </button>
                </div>

                {nameAnalysis && (
                  <div className={`text-xs mb-8 flex items-center gap-2 ${nameAnalysis.isValid ? 'text-gold' : 'text-red-400'}`}>
                    <span>{nameAnalysis.isValid ? 'âœ¦' : 'info'}</span>
                    {nameAnalysis.suggestion}
                  </div>
                )}

                <div className="text-xs text-white/30 mb-10 font-light">
                  Email: <span className="text-white/60">{formData.email || "Loading..."}</span>
                </div>

                <button onClick={handleBind} disabled={isLoading} className="w-full py-4 bg-gold text-black font-bold uppercase tracking-widest text-xs hover:bg-white transition-colors disabled:opacity-50">
                  {isLoading ? "Processing..." : "Complete Registration"}
                </button>
              </div>
            )}

            {/* Step 3: Success */}
            {step === 3 && (
              <div className="fade-in text-center flex flex-col items-center">
                {/* é‡‘è‰²å‹¾å‹¾å‹•ç•« */}
                <div className="relative w-24 h-24 flex items-center justify-center mb-8">
                  <div className="absolute inset-0 border border-gold rounded-full animate-[ping_2s_infinite_opacity]" />
                  <div className="absolute inset-0 border border-gold/30 rounded-full" />
                  <span className="text-5xl text-gold drop-shadow-[0_0_15px_rgba(212,175,55,0.5)]">âœ“</span>
                </div>

                <h2 className="font-serif text-3xl text-white mb-2">Registration Complete</h2>
                <p className="text-white/40 text-xs tracking-widest uppercase mb-10">Welcome to XUYUAN</p>

                {/* é‹å‹¢å¡ç‰‡ */}
                <div className="w-full bg-[#111] border border-gold/20 p-6 relative overflow-hidden group">
                  <div className="absolute top-0 left-0 w-full h-[1px] bg-gradient-to-r from-transparent via-gold to-transparent opacity-50" />
                  <div className="text-[10px] text-gold uppercase tracking-[0.2em] mb-3 flex items-center justify-center gap-2">
                    <span>âœ¦</span> Gemini Forecast <span>âœ¦</span>
                  </div>
                  {isFortuneLoading ? (
                    <div className="text-white/30 text-xs animate-pulse">Consulting the stars...</div>
                  ) : (
                    <p className="text-white text-sm font-serif leading-relaxed italic opacity-90">
                      "{fortune}"
                    </p>
                  )}
                </div>

                <button onClick={handleClose} className="mt-12 text-white/30 text-xs uppercase tracking-widest hover:text-gold transition-colors">
                  Close Window
                </button>
              </div>
            )}

          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
