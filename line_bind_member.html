<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>Member binding â€” æœƒå“¡ç¶å®š</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      margin: 0;
      background: #020617;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    .fade-in {
      animation: fade-in 0.35s ease-out both;
    }
    @keyframes fade-in {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>

  <!-- React 18 + ReactDOM + Babelï¼ˆè®“æˆ‘å€‘å¯ä»¥åœ¨é€™é ç›´æ¥å¯« JSXï¼‰ -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-950">
  <div id="root"></div>

  <!-- React App -->
  <script type="text/babel">
    const { useState, useEffect } = React;

    function App() {
      // ===== è¨­å®š =====
      const LIFF_ID = "2008430261-kOeNLR9x";
      const API_BASE = "https://api.murain.tw";
      const GEMINI_API_KEY = ""; // æœ‰è¦ç”¨ AI å†å¡«ï¼Œç•™ç©ºå°±ç”¨é è¨­æ–‡æ¡ˆ

      // ===== ç‹€æ…‹ =====
      const [step, setStep] = useState(0); // 0: Welcome, 1: Phone, 2: Name, 3: Success
      const [isLoading, setIsLoading] = useState(false);
      const [statusMsg, setStatusMsg] = useState("");

      const [lineProfile, setLineProfile] = useState(null);
      const [formData, setFormData] = useState({
        phone: "",
        name: "",
        email: ""
      });

      const [isCheckingName, setIsCheckingName] = useState(false);
      const [nameAnalysis, setNameAnalysis] = useState(null);
      const [fortune, setFortune] = useState("");
      const [isFortuneLoading, setIsFortuneLoading] = useState(false);

      // ===== LIFF åˆå§‹åŒ– =====
      useEffect(() => {
        const prevOverscroll = document.body.style.overscrollBehavior;
        document.body.style.overscrollBehavior = "none";

        const script = document.createElement("script");
        script.src = "https://static.line-scdn.net/liff/edge/2/sdk.js";
        script.async = true;
        script.onload = () => initLiff();
        document.body.appendChild(script);

        return () => {
          document.body.style.overscrollBehavior = prevOverscroll;
          document.body.removeChild(script);
        };
      }, []);

      async function initLiff() {
        try {
          if (!window.liff) return;
          setStatusMsg("æ­£åœ¨åˆå§‹åŒ– LINEâ€¦");

          await window.liff.init({ liffId: LIFF_ID });

          if (!window.liff.isLoggedIn()) {
            // è¦æŠ“ emailï¼Œscope è¦æœ‰ openid + email
            window.liff.login({ scope: "profile openid email" });
            return;
          }

          const profile = await window.liff.getProfile();
          setLineProfile(profile);

          // å˜—è©¦å¾ ID Token æŠ“ email
          let autoEmail = "";
          try {
            const token = window.liff.getDecodedIDToken?.();
            if (token && token.email) autoEmail = token.email;
          } catch (e) {
            console.error("getDecodedIDToken error", e);
          }

          setFormData((prev) => ({ ...prev, email: autoEmail }));
          setStatusMsg("");
        } catch (e) {
          console.error("LIFF init error", e);
          setStatusMsg("ç„¡æ³•åœ¨ LINE ä¸­åˆå§‹åŒ–ï¼Œè«‹ç¨å¾Œå†è©¦");

          // é è¦½æ¨¡å¼ï¼ˆé LINE è£¡é–‹ï¼‰
          if (!navigator.userAgent.includes("Line")) {
            setLineProfile({
              displayName: "é è¦½ç”¨æˆ¶",
              userId: "U123456",
              pictureUrl: ""
            });
            setFormData((prev) => ({
              ...prev,
              email: "preview@example.com"
            }));
            setStatusMsg("é è¦½æ¨¡å¼ï¼ˆç€è¦½å™¨ï¼‰");
          }
        }
      }

      // ===== Geminiï¼šæª¢æŸ¥å§“å =====
      async function checkNameWithGemini(name) {
        if (!name) return;

        // æ²’å¡« Key ç”¨ç°¡å–®æç¤ºå°±å¥½
        if (!GEMINI_API_KEY) {
          setNameAnalysis({
            isValid: true,
            suggestion: "ç¤ºç¯„æ¨¡å¼ï¼šæœªè¨­å®š Gemini Keyï¼Œåªæª¢æŸ¥å­—æ•¸æ˜¯å¦åˆç†ã€‚"
          });
          return;
        }

        setIsCheckingName(true);
        setNameAnalysis(null);

        const prompt = `åˆ¤æ–· "${name}" æ˜¯å¦åƒæ˜¯çœŸå¯¦ä¸­æ–‡å§“åï¼ˆéæš±ç¨±ï¼‰ã€‚å›å‚³ JSON:{"isValid":bool,"suggestion":string}`;

        try {
          const r = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
              })
            }
          );
          const d = await r.json();
          const result = JSON.parse(d.candidates[0].content.parts[0].text);
          setNameAnalysis(result);
        } catch (e) {
          console.error(e);
        } finally {
          setIsCheckingName(false);
        }
      }

      // ===== Geminiï¼šè³¼ç‰©é‹å‹¢ =====
      async function generateFortune() {
        if (!GEMINI_API_KEY) {
          setFortune("åŒ…è£¹é‹å‹¢æ»¿é»ï¼ä»Šå¤©é ˜çš„åŒ…è£¹è£¡ï¼Œè—è‘—ä½ æƒ³è¦çš„è¶…èƒ½åŠ›ï¼");
          return;
        }
        setIsFortuneLoading(true);
        try {
          const r = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [
                      {
                        text: `ç‚º "${formData.name}" ç”Ÿå‡ºä¸€å¥è¼•é¬†çš„ã€Œä»Šæ—¥ç¶²è³¼é‹å‹¢ã€ï¼Œç¹é«”ä¸­æ–‡ï¼Œ30å­—å…§ã€‚`
                      }
                    ]
                  }
                ]
              })
            }
          );
          const d = await r.json();
          setFortune(d.candidates[0].content.parts[0].text);
        } catch (e) {
          console.error(e);
          setFortune("ä»Šå¤©æ˜¯è£œè²¨çš„å¥½æ—¥å­ï¼ŒæŠŠæƒ³è²·çš„å¯¦ç”¨å“ä¸€æ¬¡å¸¶å›å®¶ã€‚");
        } finally {
          setIsFortuneLoading(false);
        }
      }

      // ===== è¡¨å–® & API =====
      function handleInputChange(e) {
        setFormData({ ...formData, [e.target.name]: e.target.value });
        if (e.target.name === "name") setNameAnalysis(null);
      }

      function handleNext() {
        if (step === 1 && !formData.phone) {
          alert("è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼");
          return;
        }
        if (document.activeElement) document.activeElement.blur();
        setStep((prev) => prev + 1);
      }

      function handleBack() {
        if (step > 0) setStep((prev) => prev - 1);
      }

      async function handleBind() {
        if (!formData.name || !formData.phone) {
          alert("è«‹å¡«å¯«å§“åèˆ‡æ‰‹æ©Ÿ");
          return;
        }

        setIsLoading(true);
        setStatusMsg("è³‡æ–™é€å‡ºä¸­â€¦");

        try {
          const body = {
            line_user_id: lineProfile?.userId,
            display_name: lineProfile?.displayName || "",
            picture_url: lineProfile?.pictureUrl || "",
            status_message: lineProfile?.statusMessage || "",
            phone: formData.phone,
            email: formData.email,
            name: formData.name
          };

          const r = await fetch(API_BASE + "/line/bind-member", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });

          const j = await r.json().catch(() => ({}));
          if (!r.ok || !j.ok) throw new Error(j.error || "bind_failed");

          setStatusMsg("");
          setStep(3);
          generateFortune();

          // 5 ç§’å¾Œè‡ªå‹•é—œé–‰
          setTimeout(handleClose, 5000);
        } catch (e) {
          console.error(e);
          alert("ç¶å®šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
        } finally {
          setIsLoading(false);
        }
      }

      function handleClose() {
        if (window.liff?.isInClient()) {
          window.liff.closeWindow();
        } else {
          // é€€å›å®˜æ–¹ LINE
          window.location.href = "https://line.me/R/ti/p/@cc0857";
        }
      }

      // ===== UI =====
      return (
        <div className="min-h-[100dvh] w-full bg-slate-950 text-white flex flex-col items-center p-4 relative overflow-x-hidden overflow-y-auto">
          {/* èƒŒæ™¯å…‰æšˆ */}
          <div className="fixed top-[-10%] left-[-10%] w-[80vw] h-[80vw] bg-emerald-500/10 rounded-full blur-[80px] pointer-events-none mix-blend-screen" />
          <div className="fixed bottom-[-10%] right-[-10%] w-[80vw] h-[80vw] bg-blue-600/10 rounded-full blur-[80px] pointer-events-none mix-blend-screen" />

          {/* ä¸Šæ–¹ï¼šè¿”å›ï¼‹é€²åº¦ */}
          <div className="w-full max-w-md h-16 flex justify-between items-center z-20 shrink-0">
            {step > 0 && step < 3 ? (
              <button
                onClick={handleBack}
                className="p-2 -ml-2 text-slate-400 active:text-white active:bg-slate-800/50 rounded-full"
              >
                <span className="text-lg">â†</span>
              </button>
            ) : (
              <div className="w-10" />
            )}

            {step < 3 && (
              <div className="flex gap-1.5">
                {[0, 1, 2].map((s) => (
                  <div
                    key={s}
                    className={
                      "h-1 rounded-full transition-all duration-500 " +
                      (step >= s
                        ? "w-8 bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]"
                        : "w-2 bg-slate-800")
                    }
                  />
                ))}
              </div>
            )}
            <div className="w-10" />
          </div>

          {/* ä¸­å¤®å…§å®¹ */}
          <div
  className={
    "z-10 w-full max-w-md flex-1 flex flex-col items-center py-4 min-h-[400px] " +
    (step === 1 || step === 2 ? "justify-start pt-4" : "justify-center")
  }
>

            {/* Step 0: æ­¡è¿ */}
            {step === 0 && (
              <div className="flex flex-col items-center text-center space-y-8 fade-in w-full">
                <div className="relative mt-4">
                  <div className="absolute -inset-1 bg-gradient-to-r from-green-400 to-emerald-600 rounded-full blur opacity-40" />
                  <div className="relative w-28 h-28 bg-slate-900 rounded-full border-4 border-slate-800 flex items-center justify-center shadow-2xl overflow-hidden">
                    {lineProfile?.pictureUrl ? (
                      <img
                        src={lineProfile.pictureUrl}
                        alt="User"
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      <div className="w-12 h-12 rounded-full border border-slate-600 flex items-center justify-center text-slate-500 text-2xl">
                        ğŸ™‚
                      </div>
                    )}
                  </div>
                </div>

                <div className="space-y-2">
                  <h1 className="text-3xl font-bold tracking-tight">
                    æ­¡è¿å›ä¾†ï¼Œ
                    <span className="text-emerald-400 ml-1">
                      {lineProfile?.displayName || "ç”¨æˆ¶"}
                    </span>
                  </h1>
                  <p className="text-slate-400 text-sm leading-relaxed">
                    é¦–æ¬¡çµå¸³åƒ…éœ€é€²è¡Œä¸€æ¬¡æ€§è¨­å®šï¼Œ<br /> åªè¦ 30 ç§’ å³å¯å®Œæˆ
                  </p>
                </div>

                <button
                  onClick={handleNext}
                  disabled={!lineProfile}
                  className="w-full max-w-[240px] h-14 bg-white text-slate-900 rounded-full font-bold text-lg flex items-center justify-center gap-2 shadow-lg active:bg-slate-200 active:scale-[0.98] disabled:opacity-40"
                >
                  é–‹å§‹è¨­å®š
                  <span className="text-lg">â†’</span>
                </button>

                <p className="text-[10px] text-slate-600 font-mono opacity-60">
                  ID: {lineProfile?.userId?.slice(0, 6) || "------"}****
                </p>
              </div>
            )}

            {/* Step 1: æ‰‹æ©Ÿè™Ÿç¢¼ */}
            {step === 1 && (
              <div className="w-full space-y-8 fade-in">
                <div className="space-y-2 ml-1">
                  <span className="text-[10px] font-bold text-emerald-400 uppercase tracking-[0.25em]">
                    STEP 01
                  </span>
                  <h2 className="text-3xl font-bold">æ‚¨çš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼Ÿ</h2>
                  <p className="text-slate-500 text-sm">
                    å–è²¨èˆ‡é€šçŸ¥éƒ½æœƒä½¿ç”¨æ­¤è™Ÿç¢¼ã€‚
                  </p>
                </div>

                <div className="relative bg-slate-900 rounded-2xl flex items-center border border-slate-800 focus-within:border-emerald-500/60 transition-colors">
                  <span className="absolute left-4 text-slate-500 text-lg">
                    ğŸ“±
                  </span>
                  <input
                    type="tel"
                    name="phone"
                    inputMode="numeric"
                    autoComplete="tel"
                    value={formData.phone}
                    onChange={handleInputChange}
                    placeholder="0912-345-678"
                    autoFocus
                    className="w-full bg-transparent text-white text-xl placeholder:text-slate-700 py-5 pl-12 pr-4 focus:outline-none rounded-2xl font-mono"
                  />
                </div>

                <button
                  onClick={handleNext}
                  className="w-full h-14 bg-emerald-500 hover:bg-emerald-400 text-white rounded-2xl font-bold text-lg flex items-center justify-center gap-2 shadow-lg shadow-emerald-900/40 active:scale-[0.98]"
                >
                  ä¸‹ä¸€æ­¥
                  <span className="text-lg">â†’</span>
                </button>
              </div>
            )}

            {/* Step 2: å§“åï¼ˆEmail è‡ªå‹•å¸¶å…¥ï¼‰ */}
            {step === 2 && (
              <div className="w-full space-y-7 fade-in">
                <div className="space-y-2 ml-1">
                  <span className="text-[10px] font-bold text-emerald-400 uppercase tracking-[0.25em]">
                    STEP 02
                  </span>
                  <h2 className="text-3xl font-bold">å¡«å¯«çœŸå¯¦å§“å</h2>
                  <p className="text-slate-500 text-sm">
                    éœ€èˆ‡è­‰ä»¶ä¸€è‡´ï¼Œä»¥å…ç„¡æ³•å–è²¨ã€‚
                  </p>
                </div>

                <div className="space-y-2">
                  <div className="relative bg-slate-900 rounded-2xl flex items-center border border-slate-800 focus-within:border-emerald-500/60">
                    <span className="absolute left-4 text-slate-500 text-lg">
                      ğŸ‘¤
                    </span>
                    <input
                      type="text"
                      name="name"
                      autoComplete="name"
                      value={formData.name}
                      onChange={handleInputChange}
                      placeholder="ä¾‹å¦‚ï¼šç‹å°é›¨"
                      className="w-full bg-transparent text-white text-lg placeholder:text-slate-700 py-4 pl-12 pr-24 focus:outline-none rounded-2xl"
                    />
                    <button
                      type="button"
                      onClick={() => checkNameWithGemini(formData.name)}
                      disabled={!formData.name || isCheckingName}
                      className="absolute right-2 top-2 bottom-2 px-3 rounded-xl bg-slate-800 text-emerald-400 text-[10px] font-bold flex items-center gap-1 border border-slate-700 disabled:opacity-40"
                    >
                      {isCheckingName ? (
                        <span className="w-3 h-3 rounded-full bg-emerald-400 animate-pulse" />
                      ) : (
                        "AI æª¢æŸ¥"
                      )}
                    </button>
                  </div>

                  {nameAnalysis && (
                    <div
                      className={
                        "text-[10px] p-2 rounded-lg flex gap-2 " +
                        (nameAnalysis.isValid
                          ? "bg-emerald-500/10 text-emerald-400"
                          : "bg-orange-500/10 text-orange-400")
                      }
                    >
                      <span>âœ“</span>
                      <span>{nameAnalysis.suggestion}</span>
                    </div>
                  )}
                </div>

                <p className="text-[11px] text-slate-500">
                  Email å°‡è‡ªå‹•å¸¶å…¥ LINE å¸³è™Ÿä¿¡ç®±ï¼š
                  <span className="font-mono text-emerald-400">
                    {formData.email || "è¼‰å…¥ä¸­â€¦"}
                  </span>
                </p>

                <button
                  onClick={handleBind}
                  disabled={isLoading}
                  className="w-full h-14 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-2xl font-bold text-lg flex items-center justify-center gap-2 shadow-[0_0_15px_rgba(16,185,129,0.3)] active:scale-[0.98] disabled:opacity-50"
                >
                  {isLoading ? (
                    <span className="w-5 h-5 rounded-full border-2 border-white border-t-transparent animate-spin" />
                  ) : (
                    <>
                      å®Œæˆç¶å®š <span>âœ“</span>
                    </>
                  )}
                </button>
              </div>
            )}

            {/* Step 3: æˆåŠŸ */}
{step === 3 && (
  <div className="text-center w-full max-w-sm fade-in flex flex-col items-center justify-center">
    {/* âœ… ç¶ è‰²ç™¼å…‰å‹¾å‹¾åœˆåœˆ */}
    <div className="relative mb-8">
      {/* å¤–åœˆå…‰æšˆ */}
      <div className="absolute inset-0 rounded-full bg-emerald-500/25 blur-2xl opacity-80" />
      {/* å…§åœˆ */}
      <div className="relative inline-flex items-center justify-center w-32 h-32 rounded-full border border-emerald-400/80 bg-emerald-500/15">
        <span className="text-5xl text-emerald-300 drop-shadow-[0_0_18px_rgba(52,211,153,0.9)]">
          âœ“
        </span>
      </div>
    </div>

    <h2 className="text-3xl font-bold mb-3">æˆåŠŸå®Œæˆç¶å®š</h2>

                <div className="w-full bg-slate-900 rounded-2xl p-4 border border-slate-800 mb-8">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-xs font-bold text-emerald-400 flex items-center gap-1">
                      âœ¨ ä»Šæ—¥è³¼ç‰©é‹å‹¢
                    </span>
                    <span className="text-[10px] text-slate-600">Gemini AI</span>
                  </div>
                  {isFortuneLoading ? (
                    <div className="flex gap-1 items-center justify-center py-2">
                      <span className="w-1.5 h-1.5 bg-slate-600 rounded-full animate-bounce" />
                      <span className="w-1.5 h-1.5 bg-slate-600 rounded-full animate-bounce delay-75" />
                      <span className="w-1.5 h-1.5 bg-slate-600 rounded-full animate-bounce delay-150" />
                    </div>
                  ) : (
                    <p className="text-sm text-white font-medium leading-relaxed">
                      "{fortune}"
                    </p>
                  )}
                </div>

                <p className="text-[11px] text-slate-500 mb-3">
                  ç³»çµ±å°‡è‡ªå‹•é—œé–‰è¦–çª—ï¼Œæˆ–å¯æ‰‹å‹•é—œé–‰ã€‚
                </p>

                <button
                  onClick={handleClose}
                  className="w-full py-3 rounded-full bg-slate-800 text-slate-400 text-xs active:bg-slate-700 active:text-white"
                >
                  ç«‹å³é—œé–‰è¦–çª—
                </button>
              </div>
            )}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
