<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>XUYUAN | æœƒå“¡ç¶å®š</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            gold: '#D4AF37',
            goldDark: '#AA8C2C',
            goldLight: '#F9E5B3',
            dark: '#080808',
            card: '#121212',
          },
          fontFamily: {
            serif: ['"Playfair Display"', 'serif'],
            sans: ['"Noto Sans TC"', 'sans-serif'],
          },
          animation: {
            'fade-in': 'fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) both',
            'float': 'float 6s ease-in-out infinite',
            'shimmer': 'shimmer 2s linear infinite',
          },
          keyframes: {
            fadeIn: { from: { opacity: 0, transform: 'translateY(10px)' }, to: { opacity: 1, transform: 'translateY(0)' } },
            float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
            shimmer: { from: { backgroundPosition: '0 0' }, to: { backgroundPosition: '-200% 0' } }
          }
        }
      }
    }
  </script>

  <style>
    body {
      margin: 0;
      background-color: #050505;
      color: #e5e5e5;
      font-family: "Noto Sans TC", sans-serif;
      overflow: hidden; /* é˜²æ­¢æ»¾å‹• */
    }
    
    /* é‡‘å±¬æ¼¸å±¤æ–‡å­— */
    .text-gradient-gold {
      background: linear-gradient(135deg, #F9E5B3 0%, #D4AF37 50%, #AA8C2C 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* é‡‘å±¬æµå…‰æŒ‰éˆ• */
    .btn-gold {
      background: linear-gradient(90deg, #AA8C2C, #D4AF37, #F9E5B3, #D4AF37);
      background-size: 200% auto;
      color: #000;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
    }
    .btn-gold:hover {
      background-position: right center;
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.5);
    }
    .btn-gold:disabled {
      background: #333; color: #666; box-shadow: none; cursor: not-allowed;
    }

    /* è¼¸å…¥æ¡†èšç„¦å…‰æšˆ */
    .input-group:focus-within {
      border-color: #D4AF37;
      box-shadow: 0 0 15px rgba(212, 175, 55, 0.15);
    }
  </style>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-dark h-[100dvh] w-full flex flex-col items-center justify-center relative">
  
  <div id="root" class="w-full max-w-md h-full flex flex-col relative z-10"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function App() {
      // ===== è¨­å®š =====
      const LIFF_ID = "2008430261-kOeNLR9x";
      const API_BASE = "https://api.murain.tw";
      const GEMINI_API_KEY = ""; 

      // ===== ç‹€æ…‹ =====
      const [step, setStep] = useState(0); 
      const [isLoading, setIsLoading] = useState(false);
      const [statusMsg, setStatusMsg] = useState("");
      const [lineProfile, setLineProfile] = useState(null);
      const [formData, setFormData] = useState({ phone: "", name: "", email: "" });
      
      const [isCheckingName, setIsCheckingName] = useState(false);
      const [nameAnalysis, setNameAnalysis] = useState(null);
      const [fortune, setFortune] = useState("");
      const [isFortuneLoading, setIsFortuneLoading] = useState(false);

      // ===== LIFF =====
      useEffect(() => {
        const script = document.createElement("script");
        script.src = "https://static.line-scdn.net/liff/edge/2/sdk.js";
        script.onload = () => initLiff();
        document.body.appendChild(script);
      }, []);

      async function initLiff() {
        try {
          if (!window.liff) return;
          setStatusMsg("ç³»çµ±è¼‰å…¥ä¸­...");
          await window.liff.init({ liffId: LIFF_ID });
          
          if (!window.liff.isLoggedIn()) {
            window.liff.login({ scope: "profile openid email" });
            return;
          }

          const profile = await window.liff.getProfile();
          setLineProfile(profile);
          
          let autoEmail = "";
          try {
            const token = window.liff.getDecodedIDToken?.();
            if (token && token.email) autoEmail = token.email;
          } catch (e) {}

          setFormData((prev) => ({ ...prev, email: autoEmail }));
          setStatusMsg("");
        } catch (e) {
          console.error(e);
          setStatusMsg("åˆå§‹åŒ–å¤±æ•—");
          // é è¦½æ¨¡å¼
          if (!navigator.userAgent.includes("Line")) {
            setLineProfile({ displayName: "é è¦½ç”¨æˆ¶", userId: "U123", pictureUrl: "" });
            setStatusMsg("");
          }
        }
      }

      // ===== Gemini AI æª¢æŸ¥èˆ‡é‹å‹¢ =====
      async function checkNameWithGemini(name) {
        if (!name) return;
        if (!GEMINI_API_KEY) {
          setNameAnalysis({ isValid: true, suggestion: "æ ¼å¼æ­£ç¢º (æ¼”ç¤ºæ¨¡å¼)" });
          return;
        }
        setIsCheckingName(true);
        setNameAnalysis(null);
        try {
          const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ parts: [{ text: `åˆ¤æ–·ä¸­æ–‡å§“å "${name}" æ˜¯å¦åˆç†ã€‚å›å‚³ JSON:{"isValid":bool,"suggestion":string}` }] }],
              generationConfig: { responseMimeType: "application/json" }
            })
          });
          const d = await r.json();
          setNameAnalysis(JSON.parse(d.candidates[0].content.parts[0].text));
        } catch (e) {} finally { setIsCheckingName(false); }
      }

      async function generateFortune() {
        if (!GEMINI_API_KEY) {
          setFortune("ä»Šæ—¥é‹å‹¢ï¼šé©åˆè³¼å…¥è³ªæ„Ÿå–®å“ï¼Œå±•ç¾è‡ªä¿¡å…‰å½©ã€‚");
          return;
        }
        setIsFortuneLoading(true);
        try {
          const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ parts: [{ text: `ç‚º "${formData.name}" ç”Ÿæˆä¸€å¥å„ªé›…çš„ç¹é«”ä¸­æ–‡è³¼ç‰©é‹å‹¢ï¼Œ30å­—å…§ï¼Œèªæ°£é«˜ç´šã€‚` }] }]
            })
          });
          const d = await r.json();
          setFortune(d.candidates[0].content.parts[0].text);
        } catch (e) {
          setFortune("ä»Šæ—¥é‹å‹¢ï¼šé©åˆè³¼å…¥è³ªæ„Ÿå–®å“ï¼Œå±•ç¾è‡ªä¿¡å…‰å½©ã€‚");
        } finally { setIsFortuneLoading(false); }
      }

      // ===== Handlers =====
      function handleInputChange(e) {
        setFormData({ ...formData, [e.target.name]: e.target.value });
        if (e.target.name === "name") setNameAnalysis(null);
      }

      function handleNext() {
        if (step === 1 && !formData.phone) return alert("è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼");
        setStep((p) => p + 1);
      }

      function handleBack() { if (step > 0) setStep((p) => p - 1); }

      async function handleBind() {
        if (!formData.name || !formData.phone) return alert("è«‹å®Œæ•´å¡«å¯«è³‡æ–™");
        setIsLoading(true);
        setStatusMsg("è³‡æ–™è™•ç†ä¸­...");
        
        try {
          const body = {
            line_user_id: lineProfile?.userId,
            display_name: lineProfile?.displayName || "",
            picture_url: lineProfile?.pictureUrl || "",
            phone: formData.phone,
            email: formData.email,
            name: formData.name
          };
          
          const r = await fetch(API_BASE + "/line/bind-member", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });
          const j = await r.json().catch(()=>({}));
          if(!r.ok || !j.ok) throw new Error(j.error);

          setStep(3);
          generateFortune();
          // æˆåŠŸå¾Œå€’æ•¸é—œé–‰
          setTimeout(handleClose, 8000);
        } catch (e) {
          alert("ç¶å®šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        } finally { setIsLoading(false); }
      }

      function handleClose() {
        if (window.liff?.isInClient()) window.liff.closeWindow();
        else window.location.href = "https://line.me/";
      }

      // ===== UI Components =====
      return (
        <div className="flex-1 flex flex-col items-center px-8 relative overflow-hidden bg-gradient-to-b from-[#0a0a0a] to-[#000]">
          
          {/* èƒŒæ™¯å…‰å½±è£é£¾ */}
          <div className="absolute top-[-10%] left-[-20%] w-[500px] h-[500px] bg-gold/5 rounded-full blur-[100px] pointer-events-none" />
          <div className="absolute bottom-[-10%] right-[-20%] w-[400px] h-[400px] bg-white/5 rounded-full blur-[80px] pointer-events-none" />

          {/* Header å°èˆªæ¬„ */}
          <div className="w-full h-24 flex items-center justify-between z-20">
            {step > 0 && step < 3 ? (
              <button onClick={handleBack} className="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 text-white/60 hover:text-gold hover:bg-white/10 transition">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
              </button>
            ) : <div className="w-10" />}
            
            <div className="text-center">
              <div className="font-serif text-gold text-lg tracking-[0.2em] font-bold">XUYUAN</div>
              <div className="text-[10px] text-white/30 uppercase tracking-[0.3em] mt-1">æœƒå“¡ä¸­å¿ƒ</div>
            </div>
            
            <div className="w-10" />
          </div>

          {/* é€²åº¦æŒ‡ç¤ºå™¨ */}
          {step < 3 && (
            <div className="flex gap-2 mb-10 z-10">
              {[0, 1, 2].map(s => (
                <div key={s} className={`h-1 rounded-full transition-all duration-700 ease-out ${step >= s ? 'w-8 bg-gradient-to-r from-gold to-goldLight shadow-[0_0_10px_rgba(212,175,55,0.4)]' : 'w-2 bg-white/10'}`} />
              ))}
            </div>
          )}

          {/* ä¸»è¦å…§å®¹å€ */}
          <div className="w-full max-w-sm flex-1 flex flex-col justify-center pb-20 z-10">
            
            {/* Step 0: æ­¡è¿é  */}
            {step === 0 && (
              <div className="animate-fade-in text-center">
                <div className="relative w-28 h-28 mx-auto mb-8 group">
                  {/* é ­åƒå¤–æ¡†å…‰åœˆ */}
                  <div className="absolute inset-[-4px] rounded-full bg-gradient-to-tr from-goldDark via-gold to-goldLight opacity-70 blur-sm group-hover:opacity-100 transition-opacity duration-700" />
                  
                  <div className="relative w-full h-full rounded-full overflow-hidden border-2 border-black bg-card flex items-center justify-center">
                    {lineProfile?.pictureUrl ? (
                      <img src={lineProfile.pictureUrl} className="w-full h-full object-cover" />
                    ) : <span className="text-3xl text-gold">ğŸ‘¤</span>}
                  </div>
                </div>
                
                <h1 className="text-4xl mb-3 text-white tracking-wide font-medium">æ­¡è¿è’è‡¨</h1>
                <p className="text-gradient-gold mb-8 tracking-widest text-sm uppercase font-bold">
                  {lineProfile?.displayName || 'è²´è³“'}
                </p>
                <p className="text-white/50 text-xs font-light leading-loose mb-12 tracking-wider">
                  èª æ‘¯é‚€è«‹æ‚¨å•Ÿç”¨ XUYUAN æœƒå“¡è³‡æ ¼<br/>
                  å³åˆ»äº«æœ‰å°ˆå±¬ç¦®é‡èˆ‡ç©åˆ†å›é¥‹
                </p>

                <button onClick={handleNext} disabled={!lineProfile} 
                  className="btn-gold w-full py-4 rounded-sm font-bold text-xs tracking-[0.2em] uppercase">
                  ç«‹å³å•Ÿç”¨
                </button>
              </div>
            )}

            {/* Step 1: è¼¸å…¥æ‰‹æ©Ÿ */}
            {step === 1 && (
              <div className="animate-fade-in">
                <div className="mb-10">
                  <div className="text-gold text-[10px] tracking-[0.3em] mb-3 uppercase font-bold opacity-80">Step 01</div>
                  <h2 className="text-3xl text-white mb-2 font-medium">æ‰‹æ©Ÿè™Ÿç¢¼</h2>
                  <p className="text-white/40 text-xs font-light">è«‹è¼¸å…¥æ‚¨çš„æ‰‹æ©Ÿè™Ÿç¢¼ä»¥å»ºç«‹é€£çµ</p>
                </div>

                <div className="input-group relative bg-[#111] border border-white/10 rounded-sm transition-all duration-300 mb-12 group">
                  <span className="absolute left-4 top-1/2 -translate-y-1/2 text-white/30 text-lg group-focus-within:text-gold transition-colors">ğŸ“±</span>
                  <input 
                    type="tel" name="phone" autoFocus
                    value={formData.phone} onChange={handleInputChange}
                    placeholder="0912-345-678"
                    className="w-full bg-transparent text-white text-xl py-5 pl-14 pr-4 outline-none font-light placeholder:text-white/10 tracking-widest"
                  />
                </div>

                <button onClick={handleNext} className="btn-gold w-full py-4 rounded-sm font-bold text-xs tracking-[0.2em] uppercase">
                  ä¸‹ä¸€æ­¥
                </button>
              </div>
            )}

            {/* Step 2: è¼¸å…¥å§“å */}
            {step === 2 && (
              <div className="animate-fade-in">
                <div className="mb-8">
                  <div className="text-gold text-[10px] tracking-[0.3em] mb-3 uppercase font-bold opacity-80">Step 02</div>
                  <h2 className="text-3xl text-white mb-2 font-medium">æœƒå“¡å§“å</h2>
                  <p className="text-white/40 text-xs font-light">è«‹å¡«å¯«çœŸå¯¦å§“åï¼Œä»¥åˆ©è¨‚å–®æ ¸å°</p>
                </div>

                <div className="input-group relative bg-[#111] border border-white/10 rounded-sm transition-all duration-300 mb-4 group">
                  <span className="absolute left-4 top-1/2 -translate-y-1/2 text-white/30 text-lg group-focus-within:text-gold transition-colors">âœ</span>
                  <input 
                    type="text" name="name"
                    value={formData.name} onChange={handleInputChange}
                    placeholder="è«‹è¼¸å…¥å§“å"
                    className="w-full bg-transparent text-white text-xl py-5 pl-14 pr-24 outline-none font-light placeholder:text-white/10 tracking-wide"
                  />
                  
                  {/* AI æª¢æŸ¥æŒ‰éˆ• */}
                  <button onClick={() => checkNameWithGemini(formData.name)} disabled={!formData.name || isCheckingName}
                    className="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-gold/80 border border-gold/30 px-3 py-1.5 hover:bg-gold hover:text-black transition uppercase tracking-wider">
                    {isCheckingName ? "æª¢æŸ¥ä¸­..." : "AI æª¢æŸ¥"}
                  </button>
                </div>

                {/* AI æç¤ºå€å¡Š */}
                <div className={`text-xs mb-8 flex items-center gap-2 h-6 transition-opacity ${nameAnalysis ? 'opacity-100' : 'opacity-0'}`}>
                  {nameAnalysis && (
                    <>
                      <span className={nameAnalysis.isValid ? 'text-gold' : 'text-red-400'}>
                        {nameAnalysis.isValid ? 'âœ“' : '!'}
                      </span>
                      <span className="text-white/60">{nameAnalysis.suggestion}</span>
                    </>
                  )}
                </div>

                <div className="text-[10px] text-white/30 mb-10 font-light flex items-center justify-between border-t border-white/5 pt-4">
                  <span>ç¶å®š Email</span>
                  <span className="text-gold/80 font-mono">{formData.email || "è®€å–ä¸­..."}</span>
                </div>

                <button onClick={handleBind} disabled={isLoading} className="btn-gold w-full py-4 rounded-sm font-bold text-xs tracking-[0.2em] uppercase">
                  {isLoading ? "ç¶å®šè³‡æ–™ä¸­..." : "å®Œæˆç¶å®š"}
                </button>
              </div>
            )}

            {/* Step 3: æˆåŠŸç•«é¢ */}
            {step === 3 && (
              <div className="animate-fade-in text-center flex flex-col items-center">
                
                {/* æˆåŠŸå‹•ç•« */}
                <div className="relative w-28 h-28 flex items-center justify-center mb-8">
                  <div className="absolute inset-0 border border-gold/40 rounded-full animate-[ping_2s_infinite]" />
                  <div className="absolute inset-2 border border-gold/20 rounded-full" />
                  <span className="text-5xl text-gold drop-shadow-[0_0_20px_rgba(212,175,55,0.6)] animate-float">âœ“</span>
                </div>

                <h2 className="text-3xl text-white mb-2 tracking-wide font-medium">ç¶å®šæˆåŠŸ</h2>
                <p className="text-white/40 text-xs tracking-[0.2em] uppercase mb-12">
                  æ­¡è¿åŠ å…¥ XUYUAN
                </p>

                {/* é‹å‹¢å¡ç‰‡ (é»‘é‡‘å¡è³ªæ„Ÿ) */}
                <div className="w-full bg-gradient-to-br from-[#1a1a1a] to-black border border-white/10 p-8 relative overflow-hidden group shadow-2xl">
                  {/* é‡‘å±¬é‚Šæ¡†æµå…‰ */}
                  <div className="absolute top-0 left-0 w-full h-[1px] bg-gradient-to-r from-transparent via-gold to-transparent opacity-50 animate-shimmer" />
                  
                  <div className="text-[10px] text-gold uppercase tracking-[0.3em] mb-4 flex items-center justify-center gap-3 opacity-80">
                    <span className="w-8 h-[1px] bg-gold/30"></span>
                    <span>å°ˆå±¬é‹å‹¢</span>
                    <span className="w-8 h-[1px] bg-gold/30"></span>
                  </div>
                  
                  {isFortuneLoading ? (
                    <div className="text-white/30 text-xs animate-pulse font-light tracking-wider">æ­£åœ¨è§£è®€æ˜Ÿè±¡...</div>
                  ) : (
                    <p className="text-white text-sm font-serif leading-relaxed tracking-wide opacity-90 text-shadow-sm">
                      {fortune}
                    </p>
                  )}
                </div>

                <button onClick={handleClose} className="mt-12 text-white/30 text-[10px] uppercase tracking-[0.2em] hover:text-gold transition-colors py-2 border-b border-transparent hover:border-gold/50">
                  é—œé–‰è¦–çª—
                </button>
              </div>
            )}

          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
