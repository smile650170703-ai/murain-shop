<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Member binding â€” æœƒå“¡ç¶å®š</title>
  <style>
    *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC",Roboto}
    body{
      margin:0;
      background:#020617;
      color:#e5e7eb;
    }
    .page{
      min-height:100vh;
      min-height:100dvh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .bg-glow{
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 0% 0%,rgba(16,185,129,.28),transparent 60%),
        radial-gradient(circle at 100% 100%,rgba(37,99,235,.22),transparent 60%);
      pointer-events:none;
      opacity:.9;
    }
    .shell{
      position:relative;
      width:100%;
      max-width:420px;
      z-index:1;
    }
    .top-nav{
      height:40px;
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:8px;
    }
    .progress{
      display:flex;
      gap:6px;
    }
    .prog-dot{
      width:20px;
      height:4px;
      border-radius:999px;
      background:rgba(30,64,175,.6);
      opacity:.4;
      transition:.3s;
    }
    .prog-dot.on{
      width:30px;
      background:linear-gradient(90deg,#22c55e,#14b8a6);
      box-shadow:0 0 10px rgba(45,212,191,.7);
      opacity:1;
    }
    .card{
      background:rgba(15,23,42,.96);
      border-radius:22px;
      padding:20px 18px 20px;
      border:1px solid rgba(148,163,184,.4);
      box-shadow:0 20px 60px rgba(15,23,42,.9);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at 0 0,rgba(16,185,129,.25),transparent 60%);
      opacity:.95;
      pointer-events:none;
    }
    .card-inner{
      position:relative;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(15,23,42,1);
      border:1px solid rgba(45,212,191,.45);
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:#5eead4;
      margin-bottom:10px;
    }
    .tag-dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:radial-gradient(circle,#22c55e,#16a34a);
      box-shadow:0 0 10px rgba(34,197,94,.8);
      margin-right:6px;
    }
    h1{
      margin:0 0 6px;
      font-size:22px;
    }
    h1 span{
      color:#4ade80;
    }
    .sub{
      font-size:13px;
      color:#9ca3af;
      line-height:1.6;
      margin-bottom:16px;
    }
    .avatar-wrap{
      display:flex;
      align-items:center;
      gap:14px;
      margin-bottom:14px;
    }
    .avatar{
      width:68px;
      height:68px;
      border-radius:999px;
      border:2px solid rgba(34,197,94,.9);
      background:radial-gradient(circle at 30% 0,rgba(34,197,94,.5),#020617);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 0 22px rgba(16,185,129,.6);
      position:relative;
    }
    .avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .avatar-badge{
      position:absolute;
      right:-2px;
      bottom:-2px;
      width:18px;
      height:18px;
      border-radius:999px;
      background:radial-gradient(circle,#22c55e,#15803d);
      display:flex;
      align-items:center;
      justify-content:center;
      border:2px solid #020617;
      font-size:11px;
      color:#ecfdf5;
      box-shadow:0 0 12px rgba(34,197,94,.9);
    }
    .welcome-en{
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:#6b7280;
      margin-bottom:4px;
    }
    .welcome-name{
      font-size:17px;
      font-weight:700;
      margin-bottom:2px;
    }
    .line-id{
      font-size:11px;
      color:#9ca3af;
      margin-bottom:4px;
    }
    .bullet{
      font-size:12px;
      color:#9ca3af;
      line-height:1.5;
    }
    .bullet span{color:#a5b4fc}
    .hint-box{
      margin-top:10px;
      padding:8px 10px;
      border-radius:12px;
      border:1px dashed rgba(148,163,184,.5);
      background:rgba(15,23,42,.95);
      font-size:11px;
      color:#9ca3af;
      line-height:1.5;
    }
    .hint-box b{color:#e5e7eb}
    .btn-main{
      width:100%;
      margin-top:18px;
      border-radius:999px;
      border:none;
      padding:13px 16px;
      background:linear-gradient(90deg,#f9fafb,#e5e7eb);
      color:#020617;
      font-weight:700;
      font-size:15px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      box-shadow:0 14px 35px rgba(15,23,42,.9);
      cursor:pointer;
    }
    .btn-main:disabled{
      opacity:.5;
      cursor:not-allowed;
      box-shadow:none;
    }
    .btn-main.color{
      background:linear-gradient(90deg,#22c55e,#14b8a6);
      color:#0f172a;
      box-shadow:0 14px 40px rgba(16,185,129,.55);
    }
    .btn-main.small{
      margin-top:14px;
      padding:11px 14px;
      font-size:14px;
    }
    .footer-txt{
      margin-top:10px;
      text-align:center;
      font-size:10px;
      color:#64748b;
    }
    .steps{
      margin-top:8px;
    }
    .step{
      display:none;
    }
    .step.active{
      display:block;
    }
    .step-title{
      font-size:22px;
      font-weight:700;
      margin-bottom:4px;
    }
    .step-sub{
      font-size:13px;
      color:#9ca3af;
      margin-bottom:18px;
    }
    .step-label{
      font-size:11px;
      letter-spacing:.22em;
      text-transform:uppercase;
      color:#22c55e;
      margin-bottom:6px;
    }
    .field{
      margin-bottom:16px;
    }
    .f-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      margin-bottom:4px;
      font-size:12px;
    }
    .f-main{font-weight:600;color:#e5e7eb}
    .f-sub{font-size:11px;color:#9ca3af}
    .input-wrap{
      position:relative;
    }
    .input{
      width:100%;
      padding:13px 14px 12px 40px;
      border-radius:999px;
      border:1px solid rgba(75,85,99,.95);
      background:radial-gradient(circle at 0 0,rgba(15,23,42,.9),#020617);
      color:#e5e7eb;
      font-size:15px;
      outline:none;
      box-shadow:0 0 0 1px rgba(15,23,42,1);
    }
    .input:focus{
      border-color:#22c55e;
      box-shadow:0 0 0 1px rgba(16,185,129,.7),0 0 24px rgba(16,185,129,.4);
    }
    .input::placeholder{color:#4b5563}
    .i-icon{
      position:absolute;
      left:14px;
      top:50%;
      transform:translateY(-50%);
      width:18px;
      height:18px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      color:#9ca3af;
      background:radial-gradient(circle at 0 0,rgba(30,64,175,.5),rgba(15,23,42,1));
      box-shadow:0 0 10px rgba(59,130,246,.5);
    }
    .i-icon::before{content:"";}
    .i-phone::before{content:"ğŸ“±"}
    .i-user::before{content:"ğŸ‘¤"}
    .i-mail::before{content:"âœ‰"}
    .ai-badge{
      position:absolute;
      right:4px;
      top:4px;
      bottom:4px;
      padding:0 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.95);
      font-size:10px;
      color:#a5b4fc;
      display:flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
    }
    .ai-dot{
      width:6px;height:6px;
      border-radius:999px;
      background:radial-gradient(circle,#a5b4fc,#6366f1);
    }
    .ai-tip{
      font-size:11px;
      padding:7px 9px;
      border-radius:10px;
      background:rgba(15,23,42,.95);
      border:1px solid rgba(148,163,184,.5);
      color:#cbd5f5;
      margin-top:6px;
      display:none;
    }
    .ai-tip.on{display:flex;gap:6px}
    .ai-tip span{font-size:12px}
    .ai-tip small{font-size:10px;color:#9ca3af}
    .warn{
      margin-top:10px;
      padding:8px 10px;
      border-radius:12px;
      background:rgba(15,23,42,.98);
      border:1px solid rgba(75,85,99,.9);
      font-size:11px;
      color:#9ca3af;
      line-height:1.6;
      display:flex;
      gap:8px;
    }
    .warn-icon{
      width:16px;height:16px;
      border-radius:999px;
      border:1px solid rgba(248,250,252,.2);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      color:#e5e7eb;
      background:rgba(30,64,175,.8);
      flex-shrink:0;
    }
    .status{
      margin-top:8px;
      font-size:12px;
      min-height:16px;
      color:#a5b4fc;
    }
    .status.error{color:#fecaca}
    .btn-row{
      margin-top:10px;
      display:flex;
      gap:8px;
    }
    .btn-secondary{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(51,65,85,1);
      background:rgba(15,23,42,1);
      color:#9ca3af;
      padding:11px 12px;
      font-size:13px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      cursor:pointer;
    }
    .btn-secondary span.icon{
      font-size:14px;
    }
    .btn-secondary.main{
      border-color:transparent;
      background:linear-gradient(90deg,#22c55e,#14b8a6);
      color:#020617;
      font-weight:600;
      box-shadow:0 12px 32px rgba(16,185,129,.55);
    }
    /* æˆåŠŸé  */
    .success-icon-wrap{
      width:88px;
      height:88px;
      border-radius:999px;
      background:rgba(22,163,74,.16);
      border:1px solid rgba(74,222,128,.7);
      display:flex;
      align-items:center;
      justify-content:center;
      margin:0 auto 16px;
      position:relative;
      box-shadow:0 0 22px rgba(34,197,94,.75);
    }
    .success-icon-wrap::before{
      content:"";
      position:absolute;
      inset:-8px;
      border-radius:999px;
      border:1px dashed rgba(74,222,128,.5);
      opacity:.7;
    }
    .success-check{
      width:32px;
      height:32px;
      border-radius:999px;
      background:radial-gradient(circle,#22c55e,#16a34a);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#ecfdf5;
      font-size:20px;
      box-shadow:0 0 16px rgba(34,197,94,.9);
    }
    .fortune-card{
      margin-top:14px;
      padding:10px 11px;
      border-radius:16px;
      background:rgba(15,23,42,.96);
      border:1px solid rgba(148,163,184,.6);
      font-size:12px;
      color:#e5e7eb;
      line-height:1.5;
      position:relative;
      overflow:hidden;
    }
    .fortune-card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at 0 0,rgba(34,197,94,.22),transparent 60%);
      opacity:.9;
      pointer-events:none;
    }
    .fortune-tag{
      font-size:11px;
      color:#a5b4fc;
      margin-bottom:4px;
    }
    .fortune-src{
      font-size:10px;
      color:#9ca3af;
    }
    .fortune-text{
      margin-top:4px;
      position:relative;
      z-index:1;
    }
    .close-note{
      margin-top:10px;
      font-size:11px;
      color:#94a3b8;
      text-align:center;
    }
    @media (max-width:480px){
      .card{padding:18px 16px 18px}
      h1{font-size:21px}
      .step-title{font-size:20px}
    }
  </style>
</head>
<body>
<div class="page">
  <div class="bg-glow"></div>

  <div class="shell">
    <!-- é€²åº¦åˆ— -->
    <div class="top-nav">
      <div class="progress" id="progressDots">
        <div class="prog-dot on" data-step="0"></div>
        <div class="prog-dot" data-step="1"></div>
        <div class="prog-dot" data-step="2"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-inner">

        <!-- Step 0: Welcome -->
        <div class="step active" id="step0">
          <div class="tag"><span class="tag-dot"></span>LINE å‡ºè²¨é€šçŸ¥ç¶å®š</div>
          <h1>æ­¡è¿å›ä¾†ï¼Œ<span id="welcomeName">ç”¨æˆ¶</span></h1>
          <p class="sub">
            åªè¦ 30 ç§’ï¼Œå®Œæˆä¸€æ¬¡ç¶å®šï¼Œä¹‹å¾Œæ¯ä¸€ç­†å‡ºè²¨ã€åˆ°åº—å–ä»¶ï¼Œ<br>
            éƒ½æœƒå„ªå…ˆç”¨ LINE æé†’ä½ ã€‚
          </p>

          <div class="avatar-wrap">
            <div class="avatar" id="avatarBox">
              <div class="avatar-badge">âœ”</div>
            </div>
            <div>
              <div class="welcome-en">WELCOME BACK</div>
              <div class="welcome-name" id="welcomeName2">LINE ç”¨æˆ¶</div>
              <div class="line-id" id="lineIdShort">userIdï¼šâ€”</div>
              <div class="bullet">
                ç¶å®šå¾Œï¼Œç³»çµ±æœƒè‡ªå‹•å°‡ä½ çš„ LINE å¸³è™Ÿèˆ‡ <span>æ”¶ä»¶äººå§“åã€æ‰‹æ©Ÿã€Email</span> åšé—œè¯ï¼Œ
                ä¹‹å¾Œç”¨åŒä¸€çµ„è³‡æ–™ä¸‹å–®å°±èƒ½è‡ªå‹•å°æ‡‰ã€‚
              </div>
            </div>
          </div>

          <div class="hint-box">
            <b>å°æé†’ï¼š</b>ç¬¬ä¸€æ¬¡ä½¿ç”¨è³¼ç‰©è»Šçµå¸³å‰ï¼Œéƒ½éœ€è¦å…ˆå®Œæˆæ­¤è¨­å®šï¼Œä»¥ä¿éšœä½ çš„å‡ºè²¨èˆ‡å”®å¾Œæ¬Šç›Šã€‚
          </div>

          <button class="btn-main" id="startBtn" disabled>
            é–‹å§‹è¨­å®š
          </button>
          <div class="footer-txt">å·²å¾ LINE å–å¾—ç™»å…¥èº«åˆ†å¾Œï¼Œå³å¯é–‹å§‹è¨­å®šé€šçŸ¥ã€‚</div>
        </div>

        <!-- Step 1: æ‰‹æ©Ÿ -->
        <div class="step" id="step1">
          <div class="step-label">STEP 01</div>
          <div class="step-title">æ‚¨çš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼Ÿ</div>
          <div class="step-sub">å–è²¨æ ¸å°èˆ‡è¨‚å–®æŸ¥è©¢éƒ½æœƒç”¨åˆ°ï¼Œè«‹å¡«å¯«å¸¸ç”¨æ‰‹æ©Ÿã€‚</div>

          <div class="field">
            <div class="f-head">
              <div class="f-main">æ‰‹æ©Ÿè™Ÿç¢¼</div>
              <div class="f-sub">è«‹è¼¸å…¥ 09 é–‹é ­ä¹‹æ‰‹æ©Ÿ</div>
            </div>
            <div class="input-wrap">
              <div class="i-icon i-phone"></div>
              <input id="phoneInput" class="input" type="tel" inputmode="numeric"
                     placeholder="0912-345-678" />
            </div>
          </div>

          <div class="warn">
            <div class="warn-icon">!</div>
            <div>è‹¥æ‰‹æ©Ÿè™Ÿç¢¼èˆ‡åŸè¨‚å–®ä¸ç¬¦ï¼Œç³»çµ±å°‡ç„¡æ³•æ­£ç¢ºå°æ‡‰ï¼Œå¯èƒ½æœƒå½±éŸ¿å‡ºè²¨é€šçŸ¥èˆ‡å–ä»¶æ¬Šç›Šã€‚</div>
          </div>

          <div class="btn-row">
            <button class="btn-secondary" id="backFrom1"><span class="icon">â†</span> ä¸Šä¸€æ­¥</button>
            <button class="btn-secondary main" id="nextFrom1">ä¸‹ä¸€æ­¥ â†’</button>
          </div>
        </div>

        <!-- Step 2: å§“å + Email -->
        <div class="step" id="step2">
          <div class="step-label">STEP 02</div>
          <div class="step-title">ç¢ºèªæ”¶ä»¶è³‡æ–™</div>
          <div class="step-sub">è«‹å¡«å¯«çœŸå¯¦å§“åï¼ŒEmail å°‡è‡ªå‹•å¸¶å…¥ LINE å¸³è™Ÿä¿¡ç®±ï¼Œå¯è¦–æƒ…æ³ä¿®æ”¹ã€‚</div>

          <div class="field">
            <div class="f-head">
              <div class="f-main">æ”¶ä»¶äººå§“å</div>
              <div class="f-sub">éœ€èˆ‡èº«åˆ†è­‰ä»¶ä¸€è‡´ï¼Œä»¥å…å–è²¨æ™‚è¢«æ‹’æ”¶</div>
            </div>
            <div class="input-wrap">
              <div class="i-icon i-user"></div>
              <input id="nameInput" class="input" type="text"
                     placeholder="çœŸå¯¦å§“åï¼ˆä¾‹ï¼šç‹å°é›¨ï¼‰" />
              <div class="ai-badge" id="aiNameBadge">
                <span class="ai-dot"></span>AI æª¢æŸ¥
              </div>
            </div>
            <div class="ai-tip" id="aiTip">
              <span>âš¡</span>
              <div>
                <span>è«‹é¿å…æš±ç¨±ï¼emojiï¼Œç›¡é‡ä½¿ç”¨èˆ‡è­‰ä»¶ä¸€è‡´çš„å§“åã€‚</span><br>
                <small>ï¼ˆä¾‹å¦‚ï¼šä¸è¦å¡«ã€Œå°é›¨å¯¶è²ã€ã€ã€ŒLumiâœ¨ã€ï¼‰</small>
              </div>
            </div>
          </div>

          <div class="field">
            <div class="f-head">
              <div class="f-main">Emailï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰</div>
              <div class="f-sub">ç”¨æ–¼æŸ¥è©¢è¨‚å–®èˆ‡ä¿¡ä»¶é€šçŸ¥</div>
            </div>
            <div class="input-wrap">
              <div class="i-icon i-mail"></div>
              <input id="emailInput" class="input" type="email"
                     placeholder="å°‡è‡ªå‹•å¸¶å…¥ LINE Emailï¼Œå¯è‡ªè¡Œä¿®æ”¹" />
            </div>
          </div>

          <div class="warn">
            <div class="warn-icon">!</div>
            <div>è‹¥å§“åã€æ‰‹æ©Ÿæˆ– Email èˆ‡åŸè¨‚å–®ä¸ç¬¦ï¼Œç³»çµ±å°‡ç„¡æ³•å°æ‡‰ä½ çš„è¨‚å–®ï¼Œå¯èƒ½æœƒå½±éŸ¿å‡ºè²¨é€šçŸ¥èˆ‡å”®å¾Œæ¬Šç›Šã€‚</div>
          </div>

          <div class="btn-row">
            <button class="btn-secondary" id="backFrom2"><span class="icon">â†</span> ä¸Šä¸€æ­¥</button>
            <button class="btn-secondary main" id="bindBtn">å®Œæˆç¶å®š âœ“</button>
          </div>

          <div class="status" id="statusText"></div>
        </div>

        <!-- Step 3: æˆåŠŸ -->
        <div class="step" id="step3">
          <div class="success-icon-wrap">
            <div class="success-check">âœ“</div>
          </div>
          <div class="step-title" style="text-align:center;margin-bottom:6px;">ç¶å®šæˆåŠŸ</div>
          <div class="step-sub" style="text-align:center;margin-bottom:10px;">
            å¾€å¾Œçš„å‡ºè²¨é€²åº¦ã€åˆ°åº—å–ä»¶æé†’ï¼Œéƒ½æœƒè‡ªå‹•é€é LINE å‘Šè¨´ä½ ã€‚
          </div>

          <div class="fortune-card">
            <div class="fortune-tag">âœ¨ ä»Šæ—¥è³¼ç‰©é‹å‹¢</div>
            <div class="fortune-src">ç³»çµ±å°å åœ</div>
            <div class="fortune-text" id="fortuneText">
              åŒ…è£¹é‹å‹¢æ»¿é»ï¼ä»Šå¤©é ˜çš„åŒ…è£¹è£¡ï¼Œè—è‘—ä½ æƒ³è¦çš„è¶…èƒ½åŠ›ï¼
            </div>
          </div>

          <div class="close-note">
            è¦–çª—å°‡åœ¨ 5 ç§’å¾Œè‡ªå‹•é—œé–‰ï¼Œæˆ–ä½ ä¹Ÿå¯ä»¥ç›´æ¥é—œé–‰æœ¬é ä¸¦è¿”å› LINE èŠå¤©å®¤ã€‚
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  const LIFF_ID = '2008430261-kOeNLR9x';
  const API = (window.API_BASE || 'https://api.murain.tw').replace(/\/$/,'');
  const OFFICIAL_LINE_ID = '@cc0857'; // é€™è£¡å¦‚éœ€æ›´æ”¹å®˜æ–¹å¸³è™Ÿï¼Œå°±æ”¹é€™ä¸€è¡Œ

  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));

  let LINE_PROFILE = null;
  let currentStep = 0;

  const stepEls = {
    0: $('#step0'),
    1: $('#step1'),
    2: $('#step2'),
    3: $('#step3'),
  };
  const progressDots = $$('#progressDots .prog-dot');

  const startBtn   = $('#startBtn');
  const phoneInput = $('#phoneInput');
  const nameInput  = $('#nameInput');
  const emailInput = $('#emailInput');
  const statusEl   = $('#statusText');

  const backFrom1 = $('#backFrom1');
  const nextFrom1 = $('#nextFrom1');
  const backFrom2 = $('#backFrom2');
  const bindBtn   = $('#bindBtn');
  const aiBadge   = $('#aiNameBadge');
  const aiTip     = $('#aiTip');

  const avatarBox   = $('#avatarBox');
  const welcomeName = $('#welcomeName');
  const welcomeName2= $('#welcomeName2');
  const lineIdShort = $('#lineIdShort');
  const fortuneText = $('#fortuneText');

  function setStatus(msg,isError){
    statusEl.textContent = msg || '';
    if (isError) statusEl.classList.add('error');
    else statusEl.classList.remove('error');
  }

  function setStep(n){
    currentStep = n;
    Object.keys(stepEls).forEach(k=>{
      stepEls[k].classList.toggle('active', Number(k)===n);
    });
    // é€²åº¦ï¼šæˆåŠŸé ä¸é¡¯ç¤ºé«˜äº®
    progressDots.forEach(dot=>{
      const s = Number(dot.dataset.step);
      dot.classList.toggle('on', n>=s && n<=2);
    });
  }

  function randomFortune(){
    const list = [
      'ä»Šå¤©æ˜¯è£œè²¨çš„å¥½æ—¥å­ï¼ŒæŠŠæƒ³è²·çš„å¯¦ç”¨å“ä¸€æ¬¡å¸¶å›å®¶ã€‚',
      'ç‰©æµå°å¤©ä½¿æ­£åœ¨åŠ ç­æ¬è²¨ï¼Œä½ çš„åŒ…è£¹å¾ˆå¿«å°±è¦å‡ºç™¼äº†ï¼',
      'è·åŒ…ç†æ™ºç·šç©©å®šï¼Œé©åˆä¸‹å–®è£œè²¨ä½†ä¸è¦äº‚å¤±æ§å”·ã€‚',
      'å¦‚æœåŒ…è£¹é²åˆ°ä¸€é»é»ï¼Œé‚£åªæ˜¯ç‚ºäº†è®“ä½ æ›´æœ‰æœŸå¾…æ„Ÿã€‚',
      'ä»Šå¤©æŸ¥è²¨è™Ÿç‰¹åˆ¥é †åˆ©ï¼Œä¸‹æ¬¡è¨˜å¾—å¤šç•™æ„æ¨æ’­é€šçŸ¥ã€‚'
    ];
    return list[Math.floor(Math.random()*list.length)];
  }

  async function initLiff(){
    try{
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()) {
        liff.login({ scope:'openid profile email' });
        return;
      }

      // å…ˆå– ID Token è©¦è‘—æ‹¿ email
      let user = null;
      try{
        if (typeof liff.getDecodedIDToken === 'function'){
          user = liff.getDecodedIDToken();
        }
      }catch(e){
        console.log('getDecodedIDToken error', e);
      }

      if (!user || !user.email){
        // å¯èƒ½æ˜¯èˆŠ tokenï¼Œå¼·åˆ¶é‡æ–°ç™»å…¥ä¸€æ¬¡è¦æ±‚ email scope
        try{ liff.logout(); }catch(e){}
        liff.login({ scope:'openid profile email' });
        return;
      }

      if (user.email && !emailInput.value){
        emailInput.value = user.email;
      }

      const profile = await liff.getProfile();
      LINE_PROFILE = profile;

      const displayName = profile.displayName || 'ç”¨æˆ¶';
      welcomeName.textContent  = displayName;
      welcomeName2.textContent = displayName;

      if (profile.userId){
        const uid = profile.userId;
        lineIdShort.textContent = 'userIdï¼š' + uid.slice(0,6) + '****' + uid.slice(-4);
      }else{
        lineIdShort.textContent = '';
      }

      if (profile.pictureUrl){
        const img = document.createElement('img');
        img.src = profile.pictureUrl;
        avatarBox.innerHTML = '';
        avatarBox.appendChild(img);
        const badge = document.createElement('div');
        badge.className = 'avatar-badge';
        badge.textContent = 'âœ”';
        avatarBox.appendChild(badge);
      }

      startBtn.disabled = false;
    }catch(e){
      console.error('LIFF init error', e);
      // å¦‚æœä¸æ˜¯åœ¨ LINE å…§ï¼Œçµ¦ä¸€å€‹é è¦½ç”¨å‡è³‡æ–™
      if (!navigator.userAgent.includes('Line')){
        LINE_PROFILE = {
          userId:'U12345678',
          displayName:'é è¦½ç”¨å¸³è™Ÿ',
          pictureUrl:''
        };
        welcomeName.textContent = 'é è¦½ç”¨å¸³è™Ÿ';
        welcomeName2.textContent = 'é è¦½ç”¨å¸³è™Ÿ';
        lineIdShort.textContent = 'userIdï¼šU1234****5678';
        startBtn.disabled = false;
      }
    }
  }

  // â”€â”€â”€ äº‹ä»¶ç¶å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  startBtn.addEventListener('click', ()=> setStep(1));
  backFrom1.addEventListener('click', ()=> setStep(0));
  backFrom2.addEventListener('click', ()=> setStep(1));

  nextFrom1.addEventListener('click', ()=>{
    const phone = (phoneInput.value||'').trim();
    if (!phone){
      alert('è«‹å…ˆå¡«å¯«æ‰‹æ©Ÿè™Ÿç¢¼');
      return;
    }
    setStep(2);
  });

  aiBadge.addEventListener('click', ()=>{
    aiTip.classList.toggle('on');
  });

  bindBtn.addEventListener('click', async ()=>{
    const name  = (nameInput.value || '').trim();
    const phone = (phoneInput.value || '').trim();
    const email = (emailInput.value || '').trim();

    if (!LINE_PROFILE || !LINE_PROFILE.userId){
      alert('å°šæœªå–å¾— LINE å¸³è™Ÿè³‡è¨Šï¼Œè«‹é‡æ–°æ•´ç†é é¢å¾Œå†è©¦ä¸€æ¬¡ã€‚');
      return;
    }
    if (!phone){
      alert('è«‹å…ˆå¡«å¯«æ‰‹æ©Ÿè™Ÿç¢¼');
      return;
    }
    // å§“åå¯ä»¥ç•™ç©ºï¼ˆä¾‹å¦‚ç”¨é›»è©±+email å°æ‡‰ï¼‰ï¼Œä½†å»ºè­°å¡«
    bindBtn.disabled = true;
    setStatus('è³‡æ–™é€å‡ºä¸­ï¼Œè«‹ç¨å€™â€¦', false);

    try{
      const body = {
        line_user_id: LINE_PROFILE.userId,
        display_name: LINE_PROFILE.displayName || '',
        picture_url: LINE_PROFILE.pictureUrl || '',
        status_message: LINE_PROFILE.statusMessage || '',
        phone,
        email,
        name
      };

      const res = await fetch(API + '/line/bind-member', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });
      const j = await res.json().catch(()=>({}));

      if (!res.ok || !j.ok){
        console.error('bind-member error', j);
        throw new Error(j.error || 'bind_member_failed');
      }

      // æˆåŠŸ
      setStatus('', false);
      fortuneText.textContent = randomFortune();
      setStep(3);

      setTimeout(()=>{
        try{
          if (liff.isInClient()){
            liff.closeWindow();
          }else{
            window.location.href = 'https://line.me/R/ti/p/' + OFFICIAL_LINE_ID;
          }
        }catch(e){}
      }, 5000);
    }catch(e){
      console.error(e);
      setStatus('ç¶å®šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ï¼Œæˆ–æˆªåœ–çµ¦å°å¹«æ‰‹æŸ¥çœ‹ã€‚', true);
      bindBtn.disabled = false;
    }
  });

  document.addEventListener('DOMContentLoaded', initLiff);
</script>
</body>
</html>
