<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>ç¶å®š LINE å‡ºè²¨é€šçŸ¥</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    :root {
      color-scheme: dark;
      --bg-main: #020617;
      --bg-card: #020617;
      --bg-field: #020617;
      --border-subtle: #0f172a;
      --border-strong: #22c55e;
      --text-main: #e5e7eb;
      --text-sub: #64748b;
      --accent: #22c55e;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100dvh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at 0 0, #22c55e22, transparent 55%),
        radial-gradient(circle at 100% 100%, #2563eb22, transparent 55%),
        #020617;
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: stretch;
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
    }

    .app {
      width: 100%;
      max-width: 480px;
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
      display: flex;
      flex-direction: column;
    }

    header {
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .step-dots {
      display: flex;
      gap: 6px;
      justify-content: center;
      align-items: center;
      flex: 1;
    }

    .dot {
      height: 4px;
      border-radius: 999px;
      background: #0f172a;
      width: 8px;
      transition: all 0.25s ease;
    }

    .dot.active {
      width: 32px;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.7);
    }

    .step-back-btn {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      cursor: pointer;
    }

    .step-back-btn:active {
      background: #020617;
      color: #e5e7eb;
    }

    main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      width: 100%;
      background: radial-gradient(circle at 0 0, #22c55e22, transparent 65%),
        #020617ee;
      border-radius: 24px;
      border: 1px solid rgba(15, 23, 42, 0.95);
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.9);
      padding: 20px 18px 18px;
      position: relative;
      overflow: hidden;
    }

    .badge-line {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(22, 163, 74, 0.8);
      font-size: 11px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: #a5f3fc;
      margin-bottom: 12px;
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 6px rgba(34, 197, 94, 0.8);
    }

    .welcome-row {
      display: flex;
      gap: 14px;
      align-items: center;
      margin-bottom: 16px;
    }

    .avatar-wrap {
      position: relative;
      width: 64px;
      height: 64px;
      border-radius: 999px;
      border: 2px solid rgba(15, 23, 42, 1);
      background: radial-gradient(circle at 0 0, #22c55e44, #020617);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      flex-shrink: 0;
    }

    .avatar-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .avatar-placeholder {
      font-size: 30px;
      color: #475569;
    }

    .welcome-text h1 {
      font-size: 20px;
      margin: 0 0 4px;
      letter-spacing: 1px;
    }

    .welcome-text h1 span {
      color: var(--accent);
      font-weight: 700;
    }

    .welcome-text p {
      margin: 0;
      font-size: 12px;
      color: var(--text-sub);
      line-height: 1.5;
    }

    .hint-box {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(248, 250, 252, 0.02);
      border: 1px dashed rgba(148, 163, 184, 0.6);
      font-size: 11px;
      color: #e5e7eb;
      line-height: 1.6;
    }

    .hint-title {
      font-size: 11px;
      font-weight: 600;
      color: #facc15;
      margin-bottom: 4px;
    }

    .field-group {
      margin-top: 14px;
    }

    .field-label-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
      font-size: 12px;
    }

    .field-label {
      color: #e5e7eb;
      font-weight: 600;
    }

    .field-note {
      font-size: 11px;
      color: var(--text-sub);
      text-align: right;
    }

    .field {
      position: relative;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      border: 1px solid rgba(30, 64, 175, 0.3);
      padding: 10px 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .field input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: #e5e7eb;
      font-size: 14px;
      font-family: inherit;
    }

    .field input::placeholder {
      color: #475569;
    }

    .field-icon {
      width: 20px;
      text-align: center;
      font-size: 14px;
      color: #64748b;
    }

    .email-hint {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-sub);
    }

    .warning-box {
      margin-top: 12px;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(248, 250, 252, 0.06);
      background: rgba(15, 23, 42, 0.8);
      font-size: 11px;
      color: #cbd5f5;
      line-height: 1.6;
      display: flex;
      gap: 8px;
    }

    .warning-icon {
      font-size: 14px;
      margin-top: 2px;
      color: #facc15;
      flex-shrink: 0;
    }

    .btn-primary {
      margin-top: 18px;
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 12px 16px;
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 1px;
      background: linear-gradient(90deg, #22c55e, #14b8a6);
      color: #020617;
      cursor: pointer;
      box-shadow: 0 12px 35px rgba(8, 47, 18, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 6px 22px rgba(8, 47, 18, 0.8);
    }

    .btn-primary[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn-outline {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: transparent;
      color: #94a3b8;
      font-size: 11px;
      padding: 8px 14px;
      margin-top: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .status-toast {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(30, 64, 175, 0.6);
      font-size: 11px;
      color: #e5e7eb;
      display: none;
      align-items: center;
      gap: 6px;
      z-index: 20;
      backdrop-filter: blur(8px);
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 2px solid rgba(125, 211, 252, 0.9);
      border-top-color: transparent;
      animation: spin 0.9s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .step {
      display: none;
      animation: fadeIn 0.35s ease-out;
    }

    .step.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .success-icon-wrap {
      width: 104px;
      height: 104px;
      border-radius: 999px;
      margin: 8px auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 0, #4ade8033, #064e3b),
        #022c22;
      border: 1px solid rgba(34, 197, 94, 0.7);
      box-shadow: 0 0 35px rgba(34, 197, 94, 0.8);
      position: relative;
    }

    .success-icon-wrap::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border: 1px solid rgba(34, 197, 94, 0.4);
      opacity: 0.6;
      filter: blur(2px);
    }

    .success-icon {
      font-size: 42px;
      color: #bbf7d0;
    }

    .fortune-card {
      margin-top: 16px;
      padding: 12px 12px 11px;
      border-radius: 16px;
      border: 1px solid rgba(15, 23, 42, 0.9);
      background: radial-gradient(circle at 0 0, #22c55e22, transparent 60%),
        #020617;
      font-size: 12px;
    }

    .fortune-title {
      font-size: 11px;
      color: #4ade80;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .fortune-title span:last-child {
      font-size: 10px;
      color: #64748b;
    }

    .fortune-text {
      color: #e5e7eb;
      line-height: 1.6;
    }

    .footer-tip {
      margin-top: 10px;
      font-size: 11px;
      color: #64748b;
      text-align: center;
    }

    @media (max-width: 360px) {
      .card {
        padding: 18px 14px 16px;
      }
      .welcome-row {
        align-items: flex-start;
      }
    }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="app">
    <header>
      <button class="step-back-btn" id="btnBack" aria-label="è¿”å›">
        â†
      </button>
      <div class="step-dots">
        <div class="dot active" data-dot="0"></div>
        <div class="dot" data-dot="1"></div>
        <div class="dot" data-dot="2"></div>
      </div>
      <div style="width:40px;"></div>
    </header>

    <main>
      <div class="card">
        <div class="badge-line">
          <span class="badge-dot"></span>
          <span>LINE å‡ºè²¨é€šçŸ¥ç¶å®š</span>
        </div>

        <!-- Step 0: Welcome -->
        <section class="step active" id="step0">
          <div class="welcome-row">
            <div class="avatar-wrap">
              <img id="avatar" alt="" style="display:none;" />
              <div id="avatarPlaceholder" class="avatar-placeholder">ğŸ™‚</div>
            </div>
            <div class="welcome-text">
              <h1>
                æ­¡è¿å›ä¾†ï¼Œ
                <span id="displayName">ç”¨æˆ¶</span>
              </h1>
              <p id="userIdShort">æ­£åœ¨å–å¾—ä½ çš„ LINE è³‡è¨Š...</p>
            </div>
          </div>

          <div class="hint-box">
            <div class="hint-title">é¦–æ¬¡çµå¸³å‰è«‹å…ˆç¶å®š</div>
            <div>
              ç‚ºäº†ç¢ºä¿ä½ çš„å‡ºè²¨æ¬Šç›Šï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨è³¼ç‰©è»Šçµå¸³å‰ï¼Œéœ€å…ˆå®Œæˆæœ¬æ¬¡ç¶å®šã€‚
              ä¹‹å¾Œæ¯ä¸€ç­†å‡ºè²¨ã€åˆ°åº—å–ä»¶éƒ½æœƒå„ªå…ˆç”¨ LINE æé†’ä½ ã€‚
            </div>
          </div>

          <p style="margin-top:10px;font-size:11px;color:#94a3b8;">
            ç¶å®šåªéœ€ç´„ 30 ç§’ï¼Œç³»çµ±æœƒè‡ªå‹•å°‡ä½ çš„ LINE å¸³è™Ÿèˆ‡ã€Œæ”¶ä»¶äººå§“åã€æ‰‹æ©Ÿã€Emailã€é€£åœ¨ä¸€èµ·ã€‚
          </p>

          <button class="btn-primary" id="btnStart">
            é–‹å§‹è¨­å®š
            <span style="font-size:16px;">â†’</span>
          </button>

          <button class="btn-outline" id="btnPreviewNote" type="button">
            <span style="font-size:10px;">i</span> è‹¥æœªé¡¯ç¤ºé ­åƒ / æš±ç¨±ï¼Œè«‹ç¢ºèªæ˜¯å¾ LINE ä¸­é–‹å•Ÿé é¢
          </button>
        </section>

        <!-- Step 1: Phone -->
        <section class="step" id="step1">
          <div class="field-group">
            <div class="field-label-row">
              <div class="field-label">æ‰‹æ©Ÿè™Ÿç¢¼</div>
              <div class="field-note">å–è²¨æ™‚æœƒç”¨ä¾†æ ¸å°èˆ‡æŸ¥è©¢è¨‚å–®</div>
            </div>
            <div class="field">
              <div class="field-icon">ğŸ“±</div>
              <input
                id="inputPhone"
                type="tel"
                inputmode="numeric"
                autocomplete="tel"
                placeholder="è«‹è¼¸å…¥ 09 é–‹é ­çš„æ‰‹æ©Ÿè™Ÿç¢¼"
              />
            </div>
          </div>

          <div class="warning-box">
            <div class="warning-icon">!</div>
            <div>
              è«‹å¡«å¯«ä½ å¹³å¸¸åœ¨è¶…å•†å–è²¨æœƒç•™çš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼›è‹¥èˆ‡åŸè¨‚å–®ä¸åŒï¼Œç³»çµ±å°‡ç„¡æ³•è‡ªå‹•å°æ‡‰ã€‚
            </div>
          </div>

          <button class="btn-primary" id="btnToStep2">
            ä¸‹ä¸€æ­¥
            <span style="font-size:16px;">â†’</span>
          </button>
        </section>

        <!-- Step 2: Name + Email -->
        <section class="step" id="step2">
          <div class="field-group">
            <div class="field-label-row">
              <div class="field-label">æ”¶ä»¶äººå§“å</div>
              <div class="field-note">éœ€èˆ‡èº«åˆ†è­‰ä»¶ä¸€è‡´ï¼Œä»¥å…å–è²¨è¢«æ‹’æ”¶</div>
            </div>
            <div class="field">
              <div class="field-icon">ğŸ§¾</div>
              <input
                id="inputName"
                type="text"
                autocomplete="name"
                placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“åï¼ˆä¾‹ï¼šç‹å°é›¨ï¼‰"
              />
            </div>
          </div>

          <div class="field-group">
            <div class="field-label-row">
              <div class="field-label">Emailï¼ˆè‡ªå‹•å¸¶å…¥ï¼Œå¯ä¿®æ”¹ï¼‰</div>
              <div class="field-note">ç”¨æ–¼è¨‚å–®é€šçŸ¥èˆ‡é›»å­ç™¼ç¥¨</div>
            </div>
            <div class="field">
              <div class="field-icon">âœ‰ï¸</div>
              <input
                id="inputEmail"
                type="email"
                autocomplete="email"
                placeholder="ç¨å¾Œå°‡è‡ªå‹•å¸¶å…¥ä½ çš„ LINE Email"
              />
            </div>
            <div class="email-hint" id="emailHint">
              æ­£åœ¨è®€å–ä½ çš„ LINE Email...
            </div>
          </div>

          <div class="warning-box">
            <div class="warning-icon">!</div>
            <div>
              è«‹å¡«å¯«çœŸå¯¦ä¸”èˆ‡è¨‚å–®ç›¸ç¬¦çš„è³‡æ–™ã€‚
              è‹¥æ‰‹æ©Ÿæˆ– Email èˆ‡åŸè¨‚å–®ä¸ç¬¦ï¼Œç³»çµ±å¯èƒ½ç„¡æ³•å°æ‡‰ï¼Œå°‡å½±éŸ¿å‡ºè²¨é€šçŸ¥èˆ‡å”®å¾Œæ¬Šç›Šã€‚
            </div>
          </div>

          <button class="btn-primary" id="btnBind">
            ç¢ºèªç¶å®š
            <span style="font-size:18px;">âœ“</span>
          </button>
        </section>

        <!-- Step 3: Success -->
        <section class="step" id="step3">
          <div class="success-icon-wrap">
            <div class="success-icon">âœ“</div>
          </div>

          <h2
            style="
              text-align: center;
              margin: 0 0 6px;
              font-size: 22px;
              letter-spacing: 2px;
            "
          >
            ç¶å®šæˆåŠŸ
          </h2>

          <p
            style="
              text-align: center;
              font-size: 12px;
              color: #94a3b8;
              line-height: 1.6;
              margin: 0 0 6px;
            "
          >
            ä¹‹å¾Œæ¯ä¸€ç­†å‡ºè²¨èˆ‡åˆ°åº—å–ä»¶ï¼Œéƒ½æœƒç¬¬ä¸€æ™‚é–“é€é LINE é€šçŸ¥ä½ ã€‚
          </p>

          <div class="fortune-card">
            <div class="fortune-title">
              <span>ä»Šæ—¥è³¼ç‰©é‹å‹¢</span>
              <span>ç”±ç³»çµ±éš¨æ©Ÿå åœ</span>
            </div>
            <div class="fortune-text" id="fortuneText">
              åŒ…è£¹é‹å‹¢æ»¿é»ï¼ä»Šå¤©é ˜çš„åŒ…è£¹è£¡ï¼Œè—è‘—ä½ æƒ³è¦çš„è¶…èƒ½åŠ›ï¼
            </div>
          </div>

          <button class="btn-outline" id="btnCloseNow">
            ç«‹å³é—œé–‰è¦–çª—
          </button>

          <div class="footer-tip" id="autoCloseTip">
            ç³»çµ±å°‡åœ¨ 5 ç§’å¾Œè‡ªå‹•é—œé–‰â€¦
          </div>
        </section>
      </div>
    </main>

    <div class="footer-tip" id="previewTip" style="display:none;">
      ğŸ” ç›®å‰ç‚ºé è¦½æ¨¡å¼ï¼ˆéå¾ LINE é–‹å•Ÿï¼‰ï¼Œå¯¦éš›ç¶å®šè«‹å¾å®˜æ–¹å¸³è™Ÿè¨Šæ¯ä¸­é»é–‹ã€‚
    </div>
  </div>

  <!-- ç‹€æ…‹æç¤º -->
  <div class="status-toast" id="statusToast">
    <div class="status-dot"></div>
    <span id="statusText">è¼‰å…¥ä¸­â€¦</span>
  </div>

  <script>
    // ==== åŸºæœ¬è¨­å®š ====
    const LIFF_ID = "2008430261-kOeNLR9x";
    const API_BASE = "https://api.murain.tw";

    let currentStep = 0;
    let lineProfile = null;
    let autoCloseTimer = null;

    const steps = [
      document.getElementById("step0"),
      document.getElementById("step1"),
      document.getElementById("step2"),
      document.getElementById("step3")
    ];
    const dots = Array.from(document.querySelectorAll(".dot[data-dot]"));

    const btnBack = document.getElementById("btnBack");
    const btnStart = document.getElementById("btnStart");
    const btnToStep2 = document.getElementById("btnToStep2");
    const btnBind = document.getElementById("btnBind");
    const btnCloseNow = document.getElementById("btnCloseNow");

    const inputPhone = document.getElementById("inputPhone");
    const inputName = document.getElementById("inputName");
    const inputEmail = document.getElementById("inputEmail");

    const statusToast = document.getElementById("statusToast");
    const statusText = document.getElementById("statusText");
    const previewTip = document.getElementById("previewTip");

    const displayNameEl = document.getElementById("displayName");
    const userIdShortEl = document.getElementById("userIdShort");
    const avatarImg = document.getElementById("avatar");
    const avatarPlaceholder = document.getElementById("avatarPlaceholder");
    const emailHint = document.getElementById("emailHint");
    const fortuneTextEl = document.getElementById("fortuneText");
    const autoCloseTip = document.getElementById("autoCloseTip");

    function showToast(msg) {
      statusText.textContent = msg;
      statusToast.style.display = "flex";
    }
    function hideToast() {
      statusToast.style.display = "none";
    }

    function setStep(step) {
      currentStep = step;
      steps.forEach((s, i) => {
        s.classList.toggle("active", i === step);
      });
      dots.forEach((d, i) => {
        d.classList.toggle("active", i <= step && step < 3 ? true : false);
      });
      // è¿”å›æŒ‰éˆ•é¡¯ç¤ºé‚è¼¯
      if (step === 0 || step === 3) {
        btnBack.style.visibility = "hidden";
      } else {
        btnBack.style.visibility = "visible";
      }
    }

    function randomFortune(name) {
      const n = name || "ä»Šå¤©";
      const list = [
        n + "çš„åŒ…è£¹æ°£å ´è¶…å¼·ï¼Œé©åˆä¸€æ¬¡æŠŠç¼ºçš„æ—¥ç”¨å“è£œé½Šã€‚",
        "ç‰©æµå°å¤©ä½¿ä»Šå¤©ç‰¹åˆ¥é—œç…§ä½ ï¼ŒåŒ…è£¹å¹¾ä¹éƒ½æœƒæº–æ™‚å ±åˆ°ã€‚",
        n + "åªè¦è¨˜å¾—å–è²¨ï¼Œä»Šå¤©å°±ç®—å®Œæˆä¸€ä»¶äººç”Ÿå¤§äº‹ã€‚",
        "ä»Šå¤©æ˜¯è£œè²¨å¥½æ—¥å­ï¼ŒæŠŠæƒ³è¦çš„å¯¦ç”¨å“ä¸€æ¬¡å¸¶å›å®¶ã€‚",
        n + "çš„è³¼ç‰©é›·é”å…¨é–‹ï¼Œå®¹æ˜“æ’¿åˆ°è¶…å€¼å¥½è²¨ã€‚"
      ];
      const idx = Math.floor(Math.random() * list.length);
      return list[idx];
    }

    // ==== LIFF åˆå§‹åŒ– ====
    async function initLiff() {
      if (!window.liff) {
        console.warn("liff not found, preview mode.");
        previewModeFallback();
        return;
      }
      try {
        showToast("æ­£åœ¨åˆå§‹åŒ– LINE...");
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          // è¦æ±‚ openid + email
          liff.login({ scope: "openid profile email" });
          return;
        }

        lineProfile = await liff.getProfile();
        const decoded = liff.getDecodedIDToken && liff.getDecodedIDToken();
        const emailFromLine = decoded && decoded.email ? decoded.email : "";

        // æ›´æ–° UI
        if (lineProfile.displayName) {
          displayNameEl.textContent = lineProfile.displayName;
        }
        if (lineProfile.userId) {
          const uid = lineProfile.userId;
          userIdShortEl.textContent =
            "userIdï¼š" + uid.slice(0, 4) + "****" + uid.slice(-3);
        } else {
          userIdShortEl.textContent = "";
        }

        if (lineProfile.pictureUrl) {
          avatarImg.src = lineProfile.pictureUrl;
          avatarImg.style.display = "block";
          avatarPlaceholder.style.display = "none";
        }

        if (emailFromLine) {
          inputEmail.value = emailFromLine;
          emailHint.textContent = "å·²è‡ªå‹•å¸¶å…¥ LINE Emailï¼Œå¯è¦–éœ€è¦èª¿æ•´ã€‚";
        } else {
          emailHint.textContent =
            "æœªå–å¾— LINE Emailï¼Œè«‹æ‰‹å‹•è¼¸å…¥å¸¸ç”¨æ”¶ä»¶ Emailã€‚";
        }
        hideToast();
      } catch (e) {
        console.error("LIFF Init Error", e);
        hideToast();
        previewModeFallback();
      }
    }

    function previewModeFallback() {
      previewTip.style.display = "block";
      displayNameEl.textContent = "é è¦½ç”¨æˆ¶";
      userIdShortEl.textContent = "ç›®å‰ç‚ºé è¦½æ¨¡å¼";
      avatarPlaceholder.textContent = "ğŸ‘€";
      emailHint.textContent =
        "é è¦½æ¨¡å¼ä¸‹ç„¡æ³•è®€å– LINE Emailï¼Œå¯¦éš›ç¶å®šè«‹åœ¨ LINE ä¸­é–‹å•Ÿã€‚";
    }

    // ==== ç¶å®šæµç¨‹ ====
    btnStart.addEventListener("click", function () {
      setStep(1);
      setTimeout(() => inputPhone.focus(), 50);
    });

    btnToStep2.addEventListener("click", function () {
      const phone = inputPhone.value.trim();
      if (!phone || !/^09\d{8}$/.test(phone)) {
        alert("è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆ09 é–‹é ­å…± 10 ç¢¼ï¼‰");
        inputPhone.focus();
        return;
      }
      setStep(2);
      setTimeout(() => inputName.focus(), 50);
    });

    btnBack.addEventListener("click", function () {
      if (currentStep === 1) {
        setStep(0);
      } else if (currentStep === 2) {
        setStep(1);
      }
    });

    btnBind.addEventListener("click", async function () {
      const phone = inputPhone.value.trim();
      const name = inputName.value.trim();
      const email = inputEmail.value.trim();

      if (!phone || !name) {
        alert("è«‹å…ˆå¡«å¯«æ‰‹æ©Ÿèˆ‡æ”¶ä»¶äººå§“åã€‚");
        return;
      }
      if (!email) {
        if (!confirm("å°šæœªå¡«å¯« Emailï¼Œç¢ºå®šè¦ç¹¼çºŒç¶å®šå—ï¼Ÿ")) return;
      }

      showToast("è³‡æ–™é€å‡ºä¸­...");
      btnBind.disabled = true;

      try {
        const body = {
          line_user_id: lineProfile && lineProfile.userId
            ? lineProfile.userId
            : "preview_uid",
          display_name:
            (lineProfile && lineProfile.displayName) || "é è¦½ç”¨æˆ¶",
          picture_url:
            (lineProfile && lineProfile.pictureUrl) || "",
          status_message:
            (lineProfile && lineProfile.statusMessage) || "",
          phone,
          email,
          name
        };

        const res = await fetch(API_BASE + "/line/bind-member", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const j = await res.json().catch(() => ({}));
        if (!res.ok || !j.ok) {
          console.error("bind-member error:", j);
          throw new Error(j.error || "bind_failed");
        }

        hideToast();
        setStep(3);
        fortuneTextEl.textContent = randomFortune(name);
        startAutoClose();
      } catch (err) {
        console.error(err);
        hideToast();
        alert("ç¶å®šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
      } finally {
        btnBind.disabled = false;
      }
    });

    function startAutoClose() {
      let countdown = 5;
      autoCloseTip.textContent = "ç³»çµ±å°‡åœ¨ " + countdown + " ç§’å¾Œè‡ªå‹•é—œé–‰â€¦";

      autoCloseTimer = setInterval(() => {
        countdown -= 1;
        if (countdown <= 0) {
          clearInterval(autoCloseTimer);
          closeWindow();
        } else {
          autoCloseTip.textContent =
            "ç³»çµ±å°‡åœ¨ " + countdown + " ç§’å¾Œè‡ªå‹•é—œé–‰â€¦";
        }
      }, 1000);
    }

    function closeWindow() {
      try {
        if (window.liff && liff.isInClient()) {
          liff.closeWindow();
          return;
        }
      } catch (e) {
        console.warn("closeWindow error", e);
      }
      // ä¸åœ¨ LINE å…§ï¼Œå°±å°å›å®˜æ–¹å¸³è™Ÿ
      window.location.href = "https://line.me/R/ti/p/@cc0857";
    }

    btnCloseNow.addEventListener("click", function () {
      if (autoCloseTimer) clearInterval(autoCloseTimer);
      closeWindow();
    });

    // åˆå§‹åŒ–
    window.addEventListener("DOMContentLoaded", initLiff);
  </script>
</body>
</html>
