<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MURAIN â€” æœƒå“¡ç¶å®š LINE é€šçŸ¥</title>
  <style>
    *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC",Roboto}
    body{
      margin:0;
      background:#0b1222;
      color:#e2e8f0;
    }
    .wrap{
      max-width:720px;
      margin:0 auto;
      padding:20px 16px calc(env(safe-area-inset-bottom,0) + 40px);
    }
    h1{
      margin:0 0 4px;
      font-size:22px;
    }
    .subtitle{
      font-size:13px;
      color:#9ca3af;
      margin-bottom:12px;
    }
    .card{
      background:rgba(15,23,42,.9);
      border-radius:16px;
      border:1px solid rgba(148,163,184,.4);
      padding:16px;
      box-shadow:0 12px 40px rgba(0,0,0,.5);
      margin-top:12px;
    }
    label{
      display:block;
      font-size:14px;
      margin:10px 2px 4px;
    }
    input{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      font-size:14px;
    }
    input[readonly]{
      opacity:.7;
      background:rgba(15,23,42,.6);
    }
    .row{
      display:grid;
      grid-template-columns:1.2fr 1fr;
      gap:10px;
    }
    @media(max-width:520px){
      .row{grid-template-columns:1fr}
    }
    .btn{
      margin-top:20px;
      width:100%;
      padding:14px 14px;
      border-radius:999px;
      border:none;
      background:#22d3ee;
      color:#0f172a;
      font-size:16px;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 16px 45px rgba(34,211,238,.4);
    }
    .btn:disabled{
      opacity:.5;
      cursor:not-allowed;
      box-shadow:none;
    }
    .hint{font-size:12px;color:#9ca3af;margin-top:4px;line-height:1.4}
    .status{
      font-size:13px;
      margin-top:8px;
      color:#cbd5f5;
    }
    .status.error{color:#fca5a5}
    .avatarRow{
      display:flex;
      align-items:center;
      gap:10px;
      margin:8px 0 4px;
    }
    .avatar{
      width:40px;
      height:40px;
      border-radius:999px;
      background:#1f2937;
      overflow:hidden;
      flex-shrink:0;
    }
    .avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .pill{
      display:inline-block;
      padding:4px 9px;
      border-radius:999px;
      background:rgba(34,197,94,.16);
      color:#bbf7d0;
      font-size:11px;
      margin-top:4px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>ç¶å®š LINE å‡ºè²¨é€šçŸ¥</h1>
  <div class="subtitle">
    ä¸€æ¬¡ç¶å®šå¾Œï¼Œä»¥å¾Œç”¨åŒä¸€æ”¯æ‰‹æ©Ÿ / Email ä¸‹å–®ï¼Œ<br>
    å‡ºè²¨å°±æœƒè‡ªå‹•ç”¨å®˜æ–¹ LINE é€šçŸ¥ä½ ã€‚
  </div>

  <div class="card">
    <div class="section-title">1. ç¢ºèªä½ çš„ LINE å¸³è™Ÿ</div>
    <div class="avatarRow">
      <div class="avatar" id="avatarBox"></div>
      <div>
        <div id="lineName" style="font-weight:600;">è®€å–ä¸­...</div>
        <div id="lineIdShort" style="font-size:12px;color:#9ca3af;"></div>
        <div class="pill">å·²å¾ LINE å–å¾—ç™»å…¥èº«åˆ†</div>
      </div>
    </div>
    <div class="hint">
      è«‹å‹™å¿…åœ¨ã€Œå®˜æ–¹ LINE å°è©±å…§ã€é»é–‹é€™å€‹é é¢ï¼Œç³»çµ±æ‰æŠ“å¾—åˆ°ä½ çš„ LINE å¸³è™Ÿã€‚
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <div class="section-title">2. å¡«å¯«è¯çµ¡è³‡è¨Šï¼ˆå°æ‡‰è¨‚å–®ï¼‰</div>

    <label>å§“åï¼ˆæ”¶ä»¶äººï¼‰</label>
    <input id="name" placeholder="ä¾‹ï¼šç‹å°é›¨" />

    <label style="margin-top:10px;">æ‰‹æ©Ÿï¼ˆæ”¶è²¨ / è¨‚å–®é›»è©±ï¼‰ *</label>
    <input id="phone" placeholder="ä¾‹ï¼š0912-345-678" />

    <label style="margin-top:10px;">Emailï¼ˆé¸å¡«ï¼Œä¹‹å¾Œä¸‹å–®æ™‚ä¹Ÿå¯ä»¥å°æ‡‰ï¼‰</label>
    <input id="email" placeholder="ä¾‹ï¼šexample@gmail.com" type="email" />

    <div class="hint">
      æ‰‹æ©Ÿ / Email å»ºè­°å¡«è·Ÿä½ ä¸‹å–®æ™‚ä¸€æ¨£çš„ï¼Œ<br>
      ä¹‹å¾Œæˆ‘å€‘æœƒç”¨é€™äº›è³‡è¨Šï¼Œå¹«ä½ è‡ªå‹•å°æ‡‰è¨‚å–®ã€‚
    </div>
  </div>

  <button class="btn" id="bindBtn" disabled>ç¶å®šé€™å€‹ LINE å¸³è™Ÿ</button>
  <div class="status" id="statusText"></div>
</div>

<!-- LINE LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  // ===== è¨­å®š =====
  // é€™è£¡æ›æˆä½ åœ¨ LINE Official å¾Œå°å»ºç«‹çš„ LIFF ID
  const LIFF_ID = '2008430261-kOeNLR9x';
  const API = (window.API_BASE || 'https://api.murain.tw').replace(/\/$/, '');

  const $ = (s,r=document)=>r.querySelector(s);

  let LINE_PROFILE = null;

  const statusEl = $('#statusText');
  const bindBtn = $('#bindBtn');
  const nameInput = $('#name');
  const phoneInput = $('#phone');
  const emailInput = $('#email');
  const avatarBox = $('#avatarBox');
  const lineNameEl = $('#lineName');
  const lineIdShortEl = $('#lineIdShort');

  function setStatus(msg, isError){
    statusEl.textContent = msg || '';
    statusEl.className = 'status' + (isError ? ' error' : '');
  }

  async function initLiff(){
    try{
      setStatus('æ­£åœ¨å¾ LINE å–å¾—ç™»å…¥è³‡è¨Š...', false);
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()) {
        // æœªç™»å…¥å°±å…ˆè¦æ±‚ç™»å…¥
        liff.login();
        return;
      }

      const profile = await liff.getProfile();
      LINE_PROFILE = profile;

      lineNameEl.textContent = profile.displayName || 'ï¼ˆæœªå–å¾—æš±ç¨±ï¼‰';

      if (profile.userId) {
        const uid = profile.userId;
        lineIdShortEl.textContent = 'userIdï¼š' + uid.slice(0,6) + '****' + uid.slice(-4);
      } else {
        lineIdShortEl.textContent = '';
      }

      if (profile.pictureUrl) {
        const img = document.createElement('img');
        img.src = profile.pictureUrl;
        avatarBox.innerHTML = '';
        avatarBox.appendChild(img);
      } else {
        avatarBox.innerHTML = '';
      }

      setStatus('å·²å¾ LINE å–å¾—å¸³è™Ÿï¼Œè«‹å†å¡«å¯«æ‰‹æ©Ÿ / Email å¾ŒæŒ‰ä¸‹ã€Œç¶å®šã€ã€‚', false);
      bindBtn.disabled = false;
    }catch(e){
      console.error('LIFF init error', e);
      setStatus('ç„¡æ³•å¾ LINE å–å¾—ç™»å…¥è³‡è¨Šï¼Œè«‹ç¢ºèªæ˜¯å¾å®˜æ–¹ LINE å°è©±ä¸­é–‹å•Ÿæ­¤é é¢ã€‚', true);
    }
  }

  bindBtn.addEventListener('click', async ()=>{
    if (!LINE_PROFILE || !LINE_PROFILE.userId) {
      alert('å°šæœªå–å¾— LINE å¸³è™Ÿï¼Œè«‹é‡æ–°æ•´ç†é é¢å¾Œå†è©¦ä¸€æ¬¡ã€‚');
      return;
    }

    const name = (nameInput.value || '').trim();
    const phone = (phoneInput.value || '').trim();
    const email = (emailInput.value || '').trim();

    if (!phone) {
      alert('è«‹å…ˆå¡«å¯«æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆä¹‹å¾Œæœƒç”¨ä¾†å°æ‡‰è¨‚å–®ï¼‰ã€‚');
      return;
    }

    bindBtn.disabled = true;
    setStatus('é€å‡ºä¸­ï¼Œè«‹ç¨å€™...', false);

    try{
      const body = {
        line_user_id: LINE_PROFILE.userId,
        display_name: LINE_PROFILE.displayName || '',
        picture_url: LINE_PROFILE.pictureUrl || '',
        status_message: LINE_PROFILE.statusMessage || '',
        phone,
        email,
        name
      };

      const r = await fetch(API + '/line/bind-member', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });

      const j = await r.json().catch(()=>({}));

      if (!r.ok || !j.ok) {
        console.error('bind-member error', j);
        throw new Error(j.error || 'bind_member_failed');
      }

      setStatus('ç¶å®šæˆåŠŸï¼ä¹‹å¾Œä½¿ç”¨åŒä¸€æ”¯æ‰‹æ©Ÿ / Email ä¸‹å–®ï¼Œå‡ºè²¨å°±æœƒè‡ªå‹•ç”¨ LINE é€šçŸ¥ä½  ğŸ˜Š', false);

      // å¦‚æœæ˜¯åœ¨ LINE å…§é–‹å•Ÿï¼Œå¯ä»¥é †ä¾¿é—œé–‰è¦–çª—
      setTimeout(()=>{
        try{ liff.closeWindow(); }catch(e){}
      }, 1500);
    }catch(e){
      console.error(e);
      setStatus('ç¶å®šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ï¼Œæˆ–æˆªåœ–çµ¦å°å¹«æ‰‹æŸ¥çœ‹ã€‚', true);
      bindBtn.disabled = false;
    }
  });

  // åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', initLiff);
</script>
</body>
</html>
