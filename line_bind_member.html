import React, { useState, useEffect } from 'react';
import { 
  ArrowRight, ArrowLeft, Smartphone, User, Check, 
  Sparkles, IdCard, Loader2, AlertCircle, AlertTriangle, Mail, ShoppingCart
} from 'lucide-react';

export default function App() {
  // ==========================================
  // 1. ç‹€æ…‹ç®¡ç†
  // ==========================================
  const [step, setStep] = useState(0); 
  const [isLoading, setIsLoading] = useState(false);
  const [statusMsg, setStatusMsg] = useState('');
  
  // LIFF è³‡æ–™
  const [lineProfile, setLineProfile] = useState(null); 
  
  // è¡¨å–®è³‡æ–™
  const [formData, setFormData] = useState({
    phone: '',
    name: '',
    email: '' 
  });

  // AI ç‹€æ…‹
  const [isCheckingName, setIsCheckingName] = useState(false);
  const [nameAnalysis, setNameAnalysis] = useState(null);
  const [fortune, setFortune] = useState('');
  const [isFortuneLoading, setIsFortuneLoading] = useState(false);

  const LIFF_ID = '2008430261-kOeNLR9x'; 
  const API_BASE = 'https://api.murain.tw';
  const apiKey = ""; // API Key

  // ==========================================
  // 2. LIFF åˆå§‹åŒ–
  // ==========================================
  useEffect(() => {
    document.body.style.overscrollBehavior = 'none';

    const script = document.createElement('script');
    script.src = 'https://static.line-scdn.net/liff/edge/2/sdk.js';
    script.async = true;
    script.onload = () => initLiff();
    document.body.appendChild(script);

    return () => document.body.removeChild(script);
  }, []);

  const initLiff = async () => {
    try {
      if (!window.liff) return;
      await window.liff.init({ liffId: LIFF_ID });

      if (!window.liff.isLoggedIn()) {
        window.liff.login();
        return;
      }
      const profile = await window.liff.getProfile();
      
      const profile = await window.liff.getProfile();
setLineProfile(profile);

let autoEmail = '';
try {
  const user = window.liff.getDecodedIDToken?.();
  if (user && user.email) autoEmail = user.email;
} catch (e) {
  console.log('getDecodedIDToken error', e);
}

// âœ… é è¨­å¸¶å…¥ã€ŒLINE æš±ç¨±ã€ç•¶å§“åï¼ˆä½¿ç”¨è€…å¯ä»¥æ”¹ï¼‰
// âœ… Email åªæœ‰åœ¨ LINE æœ‰æä¾›æ™‚æ‰è‡ªå‹•å¡«ï¼Œæ²’æœ‰å°±ç•™ç©º
setFormData(prev => ({
  ...prev,
  name: prev.name || profile.displayName || '',
  email: prev.email || autoEmail
}));


   
  };

  // ==========================================
  // 3. Gemini AI
  // ==========================================
  const checkNameWithGemini = async (name) => {
    if (!name || !apiKey) return;
    setIsCheckingName(true);
    setNameAnalysis(null);
    const prompt = `åˆ¤æ–· "${name}" æ˜¯å¦ç‚ºçœŸå¯¦ä¸­æ–‡å§“åã€‚å›å‚³JSON:{"isValid":bool,"suggestion":string}`;
    try {
      const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
      });
      const d = await r.json();
      setNameAnalysis(JSON.parse(d.candidates[0].content.parts[0].text));
    } catch (e) {} finally { setIsCheckingName(false); }
  };

  const generateFortune = async () => {
    if (!apiKey) { setFortune("åŒ…è£¹é‹å‹¢æ»¿é»ï¼ä»Šå¤©é ˜çš„åŒ…è£¹è£¡ï¼Œè—è‘—ä½ æƒ³è¦çš„è¶…èƒ½åŠ›ï¼"); return; }
    setIsFortuneLoading(true);
    try {
      const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: `ç‚º "${formData.name}" ç”Ÿæˆä¸€å¥å¹½é»˜ç¶²è³¼é‹å‹¢ï¼Œç¹é«”ä¸­æ–‡ï¼Œ30å­—å…§ã€‚` }] }] })
      });
      const d = await r.json();
      setFortune(d.candidates[0].content.parts[0].text);
    } catch (e) { setFortune("ä»Šå¤©æ˜¯è£œè²¨çš„å¥½æ—¥å­ï¼ŒæŠŠæƒ³è²·çš„å¯¦ç”¨å“ä¸€æ¬¡å¸¶å›å®¶ã€‚"); } 
    finally { setIsFortuneLoading(false); }
  };

  // ==========================================
  // 4. é‚è¼¯è™•ç†
  // ==========================================
  const handleInputChange = (e) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
    if (e.target.name === 'name') setNameAnalysis(null);
  };

  const handleNext = () => {
    if (step === 1 && !formData.phone) return alert('è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼');
    if (document.activeElement) document.activeElement.blur();
    setStep(prev => prev + 1);
  };
  const handleBack = () => step > 0 && setStep(prev => prev - 1);

  const handleBind = async () => {
    if (!formData.name || !formData.phone) return alert('è«‹å¡«å¯«å§“åèˆ‡æ‰‹æ©Ÿ');
    setIsLoading(true); setStatusMsg('è³‡æ–™é€å‡ºä¸­...');
    
    setTimeout(async () => {
        try {
            const body = {
                line_user_id: lineProfile?.userId || 'test_uid',
                display_name: lineProfile?.displayName || 'test_name',
                picture_url: lineProfile?.pictureUrl || '',
                phone: formData.phone,
                email: formData.email,
                name: formData.name
            };
            // é€™è£¡å‘¼å«æ‚¨çš„ API
            // const r = await fetch(API_BASE + '/line/bind-member', ...);
            
            setStatusMsg('');
            setStep(3);
            generateFortune();
        } catch(e) { alert('ç¶å®šå¤±æ•—'); } 
        finally { setIsLoading(false); }
    }, 1500);
  };

  const handleClose = () => {
    if (window.liff?.isInClient()) window.liff.closeWindow();
    else window.location.href = 'https://line.me/R/ti/p/@cc0857';
  };

  // ==========================================
  // 5. UI æ¸²æŸ“
  // ==========================================
  return (
    <div className="min-h-[100dvh] w-full bg-slate-950 text-white font-sans flex flex-col items-center p-4 relative overflow-x-hidden overflow-y-auto">
      
      {/* èƒŒæ™¯å…‰æšˆ */}
      <div className="fixed top-[-10%] left-[-10%] w-[80vw] h-[80vw] bg-emerald-500/10 rounded-full blur-[80px] pointer-events-none mix-blend-screen animate-pulse"></div>
      <div className="fixed bottom-[-10%] right-[-10%] w-[80vw] h-[80vw] bg-blue-600/10 rounded-full blur-[80px] pointer-events-none mix-blend-screen"></div>

      {/* é ‚éƒ¨å°èˆª */}
      <div className="w-full max-w-md h-16 flex justify-between items-center z-20 shrink-0">
        {step > 0 && step < 3 ? (
          <button onClick={handleBack} className="p-2 -ml-2 text-slate-400 active:text-white active:bg-slate-800/50 rounded-full transition-colors">
            <ArrowLeft className="w-6 h-6" />
          </button>
        ) : <div className="w-10" />}
        
        {step < 3 && (
          <div className="flex gap-1.5">
            {[0, 1, 2].map((s) => (
              <div key={s} className={`h-1 rounded-full transition-all duration-500 ${step >= s ? 'w-8 bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]' : 'w-2 bg-slate-800'}`} />
            ))}
          </div>
        )}
        <div className="w-10" />
      </div>

      {/* å…§å®¹å€ */}
      <div className="z-10 w-full max-w-md flex-1 flex flex-col items-center justify-center py-4 min-h-[400px]">
        
        {statusMsg && (
          <div className="absolute top-16 bg-slate-800/90 px-4 py-2 rounded-full text-xs text-slate-200 backdrop-blur-md flex items-center gap-2 shadow-lg z-50">
            <Loader2 className="w-3 h-3 animate-spin text-emerald-400" /> {statusMsg}
          </div>
        )}

        {/* Step 0: Welcome (æ–°å¢é¦–è³¼æç¤º) */}
        {step === 0 && (
          <div className="flex flex-col items-center text-center space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 w-full">
            
            <div className="relative group mt-2">
              <div className="absolute -inset-1 bg-gradient-to-r from-green-400 to-emerald-600 rounded-full blur opacity-40"></div>
              <div className="relative w-20 h-20 bg-slate-900 rounded-full border-[3px] border-slate-800 flex items-center justify-center shadow-2xl overflow-hidden">
                {lineProfile?.pictureUrl ? (
                  <img src={lineProfile.pictureUrl} alt="User" className="w-full h-full object-cover" />
                ) : (
                  <User className="w-10 h-10 text-slate-600" />
                )}
              </div>
            </div>
            
            <div className="space-y-1">
              <h1 className="text-xl font-bold tracking-tight text-slate-200">
                æ­¡è¿å›ä¾†ï¼Œ
                <span className="text-emerald-400 font-bold ml-1">
                  {lineProfile?.displayName || 'ç”¨æˆ¶'}
                </span>
              </h1>
            </div>

            {/* ğŸ”¥ æ–°å¢ï¼šé¦–è³¼å¿…å¡«æç¤ºå€å¡Š ğŸ”¥ */}
            <div className="w-full bg-amber-500/10 border border-amber-500/20 rounded-2xl p-4 flex items-start gap-3 text-left animate-pulse">
               <div className="p-2 bg-amber-500/20 rounded-full shrink-0">
                 <ShoppingCart className="w-5 h-5 text-amber-400" />
               </div>
               <div>
                 <h3 className="text-amber-400 font-bold text-sm mb-0.5">é¦–æ¬¡çµå¸³å‰è«‹å…ˆç¶å®š</h3>
                 <p className="text-amber-100/70 text-xs leading-relaxed">
                   ç‚ºäº†ç¢ºä¿æ‚¨çš„å‡ºè²¨æ¬Šç›Šï¼Œ<br/>ç¬¬ä¸€æ¬¡ä½¿ç”¨è³¼ç‰©è»Šçµå¸³çš†éœ€å®Œæˆæ­¤è¨­å®šã€‚
                 </p>
               </div>
            </div>

            <p className="text-slate-400 text-xs leading-relaxed max-w-[280px] mx-auto opacity-80">
               å®Œæˆå¾Œç³»çµ±å°‡è‡ªå‹•é€£çµæ‚¨çš„è¨‚å–®è³‡æ–™<br/>åªéœ€ 30 ç§’å³å¯å®Œæˆ
            </p>

            <div className="pt-4 w-full">
              <button 
                onClick={() => handleNext()}
                disabled={!lineProfile}
                className="w-full h-14 bg-white active:bg-slate-200 active:scale-[0.98] text-slate-900 rounded-2xl font-bold text-lg transition-all flex items-center justify-center gap-2 shadow-lg disabled:opacity-50"
              >
                é–‹å§‹è¨­å®š <ArrowRight className="w-5 h-5" />
              </button>
              <p className="text-[10px] text-slate-600 font-mono mt-3 opacity-50">LINE ID: {lineProfile?.userId?.slice(0,6)}****</p>
            </div>
          </div>
        )}

        {/* Step 1: æ‰‹æ©Ÿ */}
        {step === 1 && (
          <div className="w-full space-y-6 animate-in fade-in slide-in-from-right-8 duration-500">
            <div className="space-y-1 ml-1">
              <label className="text-[10px] font-bold text-emerald-500 uppercase tracking-widest block">STEP 01</label>
              <h2 className="text-3xl font-bold text-white">æ‚¨çš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼Ÿ</h2>
              <p className="text-slate-500 text-sm">å–è²¨æ ¸å°èˆ‡è¨‚å–®æŸ¥è©¢ä½¿ç”¨</p>
            </div>

            <div className="relative group">
              <div className="relative bg-slate-900 rounded-2xl flex items-center border border-slate-800 focus-within:border-emerald-500/50 transition-colors">
                <Smartphone className="absolute left-4 w-5 h-5 text-slate-500 group-focus-within:text-emerald-400" />
                <input 
                  type="tel" 
                  name="phone"
                  inputMode="numeric"
                  autoComplete="tel"
                  value={formData.phone}
                  onChange={handleInputChange}
                  placeholder="0912-345-678"
                  autoFocus
                  className="w-full bg-transparent text-white text-xl placeholder:text-slate-700 py-5 pl-12 pr-4 focus:outline-none rounded-2xl font-mono"
                />
              </div>
            </div>

            <button 
              onClick={handleNext}
              className="w-full h-14 bg-emerald-600 active:bg-emerald-700 active:scale-[0.98] text-white rounded-2xl font-bold text-lg transition-all flex items-center justify-center gap-2 shadow-lg shadow-emerald-900/40 mt-4"
            >
              ä¸‹ä¸€æ­¥ <ArrowRight className="w-5 h-5" />
            </button>
          </div>
        )}

        {/* Step 2: å§“å (è‡ªå‹•å¸¶å…¥ Email) */}
        {step === 2 && (
          <div className="w-full space-y-5 animate-in fade-in slide-in-from-right-8 duration-500">
             <div className="space-y-1 ml-1">
              <label className="text-[10px] font-bold text-emerald-500 uppercase tracking-widest block">STEP 02</label>
              <h2 className="text-2xl font-bold text-white">ç¢ºèªå§“å</h2>
              <p className="text-slate-500 text-xs">è«‹å¡«å¯«çœŸå¯¦å§“åä»¥ä¾›å–è²¨æ ¸å°</p>
            </div>

            <div className="space-y-2">
              <div className="relative bg-slate-900 rounded-2xl flex items-center border border-slate-800 focus-within:border-emerald-500/50">
                <IdCard className="absolute left-4 w-5 h-5 text-slate-500" />
                <input 
                  type="text" 
                  name="name"
                  autoComplete="name"
                  value={formData.name}
                  onChange={handleInputChange}
                  placeholder="çœŸå¯¦å§“å (ä¾‹: ç‹å°é›¨)"
                  className="w-full bg-transparent text-white text-lg placeholder:text-slate-700 py-4 pl-12 pr-24 focus:outline-none rounded-2xl"
                />
                <button
                  onClick={() => checkNameWithGemini(formData.name)}
                  disabled={!formData.name || isCheckingName}
                  className="absolute right-2 top-2 bottom-2 px-3 rounded-xl bg-slate-800 text-emerald-400 text-[10px] font-bold flex items-center gap-1 active:bg-slate-700 disabled:opacity-30 border border-slate-700"
                >
                  {isCheckingName ? <Loader2 className="w-3 h-3 animate-spin" /> : <Sparkles className="w-3 h-3" />} AI æª¢æ¸¬
                </button>
              </div>
              {nameAnalysis && (
                <div className={`text-[10px] p-2 rounded-lg flex gap-2 ${nameAnalysis.isValid ? 'bg-emerald-500/10 text-emerald-400' : 'bg-orange-500/10 text-orange-400'}`}>
                  {nameAnalysis.isValid ? <Check className="w-3 h-3 shrink-0" /> : <AlertTriangle className="w-3 h-3 shrink-0" />}
                  {nameAnalysis.suggestion}
                </div>
              )}
            </div>

            <div className="flex gap-2 items-center p-2 px-3 bg-slate-900/40 rounded-xl border border-dashed border-slate-800/50">
               <Mail className="w-3.5 h-3.5 text-emerald-500/70" />
               <span className="text-[10px] text-slate-500">
                 é—œè¯ä¿¡ç®±ï¼š<span className="font-mono text-emerald-500/70">{formData.email}</span> (è‡ªå‹•å¸¶å…¥)
               </span>
            </div>

            <div className="flex gap-2 items-start p-3 bg-slate-800/50 rounded-xl border border-slate-700/50">
               <AlertCircle className="w-4 h-4 text-slate-500 flex-shrink-0 mt-0.5" />
               <p className="text-[10px] text-slate-400 leading-relaxed">
                 è‹¥å§“åèˆ‡åŸè¨‚å–®ä¸ç¬¦ï¼Œé–€å¸‚äººå“¡å¯èƒ½æœƒæ‹’çµ•å–è²¨ã€‚
               </p>
            </div>

            <button 
              onClick={handleBind}
              disabled={isLoading}
              className="w-full h-14 bg-gradient-to-r from-emerald-500 to-teal-500 active:scale-[0.98] text-white rounded-2xl font-bold text-lg transition-all flex items-center justify-center gap-2 shadow-[0_0_15px_rgba(16,185,129,0.3)] disabled:opacity-50 mt-2"
            >
              {isLoading ? <Loader2 className="w-5 h-5 animate-spin" /> : <>å®Œæˆç¶å®š <Check className="w-5 h-5" /></>}
            </button>
          </div>
        )}

        {/* Step 3: æˆåŠŸ */}
        {step === 3 && (
          <div className="text-center w-full max-w-sm animate-in zoom-in-95 duration-500 flex flex-col items-center justify-center">
            
            <div className="inline-flex items-center justify-center w-28 h-28 rounded-full bg-emerald-500/10 text-emerald-400 mb-6 ring-1 ring-emerald-500/50 relative">
              <div className="absolute inset-0 rounded-full bg-emerald-500/20 animate-ping duration-[2000ms]"></div>
              <Check className="w-14 h-14 drop-shadow-[0_0_15px_rgba(52,211,153,0.8)]" />
            </div>
            
            <h2 className="text-2xl font-bold text-white tracking-tight mb-2">ç¶å®šæˆåŠŸ</h2>
            <p className="text-slate-400 text-xs mb-8 leading-relaxed">
               æ—¥å¾Œå‡ºè²¨èˆ‡å–ä»¶æé†’<br/>éƒ½æœƒè‡ªå‹•é€é LINE é€šçŸ¥æ‚¨
            </p>

            {/* AI é‹å‹¢å¡ç‰‡ */}
            <div className="w-full bg-slate-900 rounded-2xl p-4 border border-slate-800 relative overflow-hidden group">
               <div className="absolute inset-0 bg-gradient-to-r from-emerald-500/10 to-blue-500/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
               <div className="flex items-center justify-between mb-2">
                 <span className="text-xs font-bold text-emerald-400 flex items-center gap-1"><Sparkles className="w-3 h-3" /> ä»Šæ—¥è³¼ç‰©é‹å‹¢</span>
                 <span className="text-[10px] text-slate-600 bg-slate-800 px-1.5 py-0.5 rounded">Gemini AI</span>
               </div>
               {isFortuneLoading ? (
                 <div className="flex gap-1 items-center justify-center py-2">
                    <span className="w-1.5 h-1.5 bg-slate-600 rounded-full animate-bounce"></span>
                    <span className="w-1.5 h-1.5 bg-slate-600 rounded-full animate-bounce delay-75"></span>
                    <span className="w-1.5 h-1.5 bg-slate-600 rounded-full animate-bounce delay-150"></span>
                 </div>
               ) : (
                 <p className="text-sm text-white font-medium leading-relaxed">"{fortune}"</p>
               )}
            </div>

            <button 
              onClick={handleClose}
              className="mt-8 w-full py-3 rounded-2xl bg-slate-800 text-slate-400 text-xs active:bg-slate-700 active:text-white transition-colors"
            >
              é—œé–‰è¦–çª— (5ç§’å¾Œè‡ªå‹•é—œé–‰)
            </button>
          </div>
        )}
      </div>

    </div>
  );
}
