<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MURAIN — 訂單後台（整合版）</title>
<style>
  *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC",Roboto}
  body{margin:0;background:#020617;color:#e2e8f0}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  h1{margin:0 0 6px;font-size:24px}

  /* 新版上方工具列（含快速 filter + 日期/狀態 + 匯出） */
  .toolbar-main{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:12px}
  .toolbar-left{flex:1;display:flex;flex-direction:column;gap:6px}
  .filter-group{display:flex;flex-wrap:wrap;gap:6px}
  .filter-btn{padding:7px 12px;border-radius:999px;border:1px solid rgba(148,163,184,.7);background:rgba(15,23,42,.9);color:#e5e7eb;font-size:13px;cursor:pointer}
  .filter-btn.active{background:#22d3ee;color:#0f172a;border-color:#22d3ee;box-shadow:0 8px 20px rgba(34,211,238,.35)}
  .small-btn{padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.7);background:transparent;color:#e5e7eb;font-size:12px;cursor:pointer}

  .filter-row{display:flex;flex-wrap:wrap;gap:6px;font-size:12px;align-items:flex-end;margin-top:2px}
  .filter-row .field{min-width:140px;flex:0 0 auto}
  .filter-row label{display:block;font-size:11px;margin:0 0 2px;color:#94a3b8}
  .filter-row input,
  .filter-row select{width:100%;padding:5px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.6);background:#020617;color:#e2e8f0;font-size:12px}

  .summary-row{font-size:12px;color:#cbd5f5;display:flex;flex-wrap:wrap;gap:10px;margin-top:2px}
  .summary-row span{white-space:nowrap}
  #msg{font-size:12px;color:#94a3b8;margin-top:2px}

  .layout{display:grid;grid-template-columns:minmax(0,0.9fr) minmax(0,1.1fr);gap:12px}
  @media (max-width:900px){.layout{grid-template-columns:1fr;}}

  .card{background:rgba(15,23,42,.95);border-radius:16px;border:1px solid rgba(148,163,184,.3);padding:10px;min-height:120px}
  #orderList{max-height:calc(100vh - 190px);overflow:auto}

  .order-row{padding:8px 10px;border-radius:12px;cursor:pointer;border:1px solid transparent;margin-bottom:6px;background:rgba(15,23,42,.95)}
  .order-row:hover{border-color:rgba(148,163,184,.8);background:rgba(15,23,42,1)}
  .order-row.active{border-color:#22d3ee;background:rgba(15,23,42,1);box-shadow:0 8px 20px rgba(34,211,238,.25)}

  .ord-top{display:flex;justify-content:space-between;align-items:center;gap:6px;font-size:13px}
  .ord-id{font-weight:600}
  .ord-amount{font-weight:600}
  .ord-sub{font-size:12px;color:#94a3b8;margin-top:3px}
  .badges{display:flex;flex-wrap:wrap;gap:4px;font-size:11px;margin-top:4px}
  .badge{padding:2px 7px;border-radius:999px;border:1px solid rgba(148,163,184,.7);background:rgba(15,23,42,1)}
  .badge.green{border-color:#22c55e;color:#bbf7d0;background:rgba(22,163,74,.2)}
  .badge.yellow{border-color:#eab308;color:#facc15;background:rgba(234,179,8,.15)}
  .badge.red{border-color:#f97373;color:#fecaca;background:rgba(220,38,38,.2)}
  .badge.blue{border-color:#38bdf8;color:#bae6fd;background:rgba(56,189,248,.2)}
  .muted{font-size:13px;color:#94a3b8}

  .detail-grid{display:grid;grid-template-columns:1.1fr 0.9fr;gap:10px}
  @media (max-width:900px){.detail-grid{grid-template-columns:1fr}}

  label{display:block;font-size:12px;margin:6px 0 3px;color:#cbd5f5}
  input,select,textarea{width:100%;padding:8px 9px;border-radius:10px;border:1px solid rgba(148,163,184,.6);background:#020617;color:#e2e8f0;font-size:13px}
  textarea{min-height:70px;resize:vertical}
  input:focus,select:focus,textarea:focus{outline:2px solid #38bdf8;outline-offset:1px;border-color:#38bdf8}
  .row{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
  .mt-2{margin-top:8px}
  .mt-3{margin-top:12px}
  .mt-4{margin-top:16px}
  .btn-primary{margin-top:8px;padding:10px 14px;border-radius:999px;border:none;background:#22d3ee;color:#0f172a;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 10px 30px rgba(34,211,238,.35)}
  .btn-secondary{margin-top:8px;padding:8px 12px;border-radius:999px;border:1px solid rgba(148,163,184,.7);background:transparent;color:#e5e7eb;font-size:13px;cursor:pointer}
  .section-title{font-size:13px;font-weight:600;color:#e5e7eb;margin-top:4px;margin-bottom:2px}
  .pill{display:inline-block;padding:3px 7px;border-radius:999px;background:rgba(15,23,42,1);border:1px solid rgba(148,163,184,.6);font-size:11px;color:#cbd5f5;margin-right:4px;margin-top:2px}
  .tag-small{font-size:11px;color:#94a3b8}
  .label-inline{display:flex;align-items:center;gap:5px;font-size:12px;margin-top:4px}
  .label-inline input[type="checkbox"]{width:auto}
  .error{color:#fecaca;font-size:13px;margin-top:4px}
 /* 上方「今日尾款提醒」旁的快捷操作列 */
  .top-order-actions{
    margin-top:6px;
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }
  .top-order-actions > button{
    margin-top:0; /* 不要再往下推一格，看起來才會平整 */
  }
 #orderDetail #btnSaveAndShip,
  #orderDetail #btnConfirmPayOk,
  #orderDetail #btnMarkZcFail,
  #orderDetail #btnPrintOrder,
  #orderDetail #btnSendTailLink,
  #orderDetail #btnCancelOrder,
  #orderDetail #btnMeetupNotify{
    display:none;
  }
</style>
</head>
<body>
  <div class="container" style="padding: 16px;">
    <h1>匯出中心（含日期篩選）</h1>

    <!-- 日期篩選區 -->
    <div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
      <label>起始日期：
        <input id="dateFrom" type="date" />
      </label>
      <label>結束日期：
        <input id="dateTo" type="date" />
      </label>
      <label>預覽類型：
        <select id="previewKind">
          <option value="orders">總訂單</option>
          <option value="accounting">會計師</option>
          <option value="ship">出貨明細／賣貨便</option>
          <option value="zero">0 元包裹明細</option>
        </select>
      </label>
      <button id="btnPreview">查詢（只預覽，不下載）</button>
    </div>

    <!-- 下載區：用同一個日期條件下載 4 種檔案 -->
    <div style="margin-top: 16px;">
      <div style="margin-bottom: 4px;">依上方日期，下載不同類型：</div>
      <div style="display: flex; flex-wrap: wrap; gap: 8px;">
        <button id="btnDownloadOrders">下載「總訂單」檔案</button>
        <button id="btnDownloadAccounting">下載「會計師」檔案</button>
        <button id="btnDownloadShip">下載「出貨明細／賣貨便」檔案</button>
        <button id="btnDownloadZero">下載「0 元包裹明細」檔案</button>
      </div>
    </div>

    <!-- 預覽結果區 -->
    <div style="margin-top: 24px;">
      <h2 id="previewTitle" style="margin-bottom: 8px;">預覽結果</h2>
      <div id="previewInfo" style="margin-bottom: 8px; font-size: 14px; color: #555;"></div>
      <div style="overflow: auto; max-height: 480px; border: 1px solid #ddd;">
        <table id="previewTable" style="width: 100%; border-collapse: collapse; font-size: 13px;">
          <thead id="previewThead"></thead>
          <tbody id="previewTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);

    function getDateParams() {
      const from = $('#dateFrom')?.value || '';
      const to   = $('#dateTo')?.value || '';
      const params = [];
      if (from) params.push(`date_from=${encodeURIComponent(from)}`);
      if (to)   params.push(`date_to=${encodeURIComponent(to)}`);
      return params.length ? '&' + params.join('&') : '';
    }

    // 預覽：用 format=json 把資料抓回來，塞到下面的表格
    async function preview(kind) {
      const queryDates = getDateParams();
      const url = `${API_ORIGIN}/admin/export-view?key=${
        encodeURIComponent(OP_KEY)
      }&kind=${encodeURIComponent(kind)}&format=json${queryDates}`;

      $('#previewInfo').textContent = '載入中…';
      $('#previewThead').innerHTML = '';
      $('#previewTbody').innerHTML = '';

      try {
        const res = await fetch(url);
        if (!res.ok) {
          const txt = await res.text();
          $('#previewInfo').textContent = `讀取失敗（${res.status}）：${txt}`;
          return;
        }
        const data = await res.json();
        const records = data.records || [];
        $('#previewTitle').textContent = `預覽結果（類型：${kind}）`;
        $('#previewInfo').textContent = `共有 ${records.length} 筆（只顯示前 100 筆）`;

        if (!records.length) {
          return;
        }

        const firstFields = records[0].fields || {};
        const fieldNames = Object.keys(firstFields);

        // 建表頭
        const theadTr = document.createElement('tr');
        fieldNames.forEach((name) => {
          const th = document.createElement('th');
          th.textContent = name;
          th.style.border = '1px solid #ddd';
          th.style.padding = '4px';
          th.style.position = 'sticky';
          th.style.top = '0';
          th.style.background = '#f7f7f7';
          theadTr.appendChild(th);
        });
        $('#previewThead').appendChild(theadTr);

        // 建資料列（最多 100 筆）
        const maxRows = Math.min(records.length, 100);
        for (let i = 0; i < maxRows; i++) {
          const rec = records[i];
          const f = rec.fields || {};
          const tr = document.createElement('tr');
          fieldNames.forEach((name) => {
            const td = document.createElement('td');
            let v = f[name];
            if (Array.isArray(v)) {
              v = v.join(', ');
            }
            td.textContent = v == null ? '' : String(v);
            td.style.border = '1px solid #eee';
            td.style.padding = '3px 4px';
            tr.appendChild(td);
          });
          $('#previewTbody').appendChild(tr);
        }
      } catch (err) {
        console.error(err);
        $('#previewInfo').textContent = '讀取時發生錯誤：' + err.message;
      }
    }

    // 下載：直接打 CSV 版
    function downloadKind(kind) {
      const queryDates = getDateParams();
      const url = `${API_ORIGIN}/admin/export-view?key=${
        encodeURIComponent(OP_KEY)
      }&kind=${encodeURIComponent(kind)}${queryDates}`;
      window.location.href = url; // 觸發下載
    }

    document.addEventListener('DOMContentLoaded', async () => {
  // ① 先跑原本後台的密碼機制
  if (typeof ensureOpKey === 'function') {
    await ensureOpKey();   // 跟 admin_orders.html 一樣：沒輸入密碼就卡在這裡
  }

  // ② 再綁定匯出中心的按鈕
  const btnPreview = $('#btnPreview');
  const selKind    = $('#previewKind');

  if (btnPreview && selKind) {
    btnPreview.addEventListener('click', () => {
      const kind = selKind.value || 'orders';
      preview(kind);
    });
  }

  $('#btnDownloadOrders')?.addEventListener('click',     () => downloadKind('orders'));
  $('#btnDownloadAccounting')?.addEventListener('click', () => downloadKind('accounting'));
  $('#btnDownloadShip')?.addEventListener('click',       () => downloadKind('ship'));
  $('#btnDownloadZero')?.addEventListener('click',       () => downloadKind('zero'));
});
  </script>
</body>
</html>
