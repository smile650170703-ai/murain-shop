<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MURAIN — 匯出中心</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #111827;
      color: #f9fafb;
    }
    .container {
      padding: 16px 20px 32px;
    }
    h1, h2 {
      margin: 0;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    h2 {
      font-size: 16px;
      margin-top: 24px;
      margin-bottom: 4px;
    }
    label {
      font-size: 14px;
      margin-right: 8px;
    }
    input[type="date"],
    select {
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #f9fafb;
    }
    button {
      padding: 4px 10px;
      border-radius: 4px;
      border: 1px solid #6b7280;
      background: #0f172a;
      color: #f9fafb;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
    }
    button:hover {
      background: #1f2937;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    
    #previewBox {
  /* 讓高度依螢幕調整，保留上面控制區的空間 */
  height: calc(100vh - 220px);
  max-height: none;
  overflow: auto;
  border: 1px solid #374151;
  border-radius: 4px;
}
    table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}

/* 邊框稍微粗一點 */
#previewTable th,
#previewTable td {
  border: 1px solid #4b5563;
  padding: 4px 6px;
}

/* 標題列固定在上面 */
#previewTable th {
  position: sticky;
  top: 0;
  background: #111827;
  z-index: 1;
}

/* 每一列深淺交錯（斑馬線） */
#previewTable tbody tr:nth-child(odd) {
  background: #020617;
}
#previewTable tbody tr:nth-child(even) {
  background: #0b1120;
}

/* 滑鼠移上去整列變亮 */
#previewTable tbody tr:hover {
  background: #1f2937;
}

  </style>
</head>
<body>
  <div class="container">
    <h1>匯出中心（含日期篩選）</h1>

    <!-- 日期篩選區 -->
    <div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
      <label>起始日期：
        <input id="dateFrom" type="date" />
      </label>
      <label>結束日期：
        <input id="dateTo" type="date" />
      </label>
      <label>預覽類型：
        <select id="previewKind">
          <option value="orders">出貨明細</option>
          <option value="accounting">會計師</option>
          <option value="ship">出貨明細／賣貨便</option>
          <option value="zero">0 元包裹明細</option>
          <option value="streamer">直播主結算單</option>  <!-- ★ 新增 -->
          <option value="net">淨利結算</option>
        </select>
      </label>
      <button id="btnPreview">查詢（只預覽，不下載）</button>
    </div>

    <!-- 下載區：用同一組日期下載 4 種檔案 -->
    <div style="margin-top: 16px;">
      <div style="margin-bottom: 4px;">依上方日期，下載或列印不同類型：</div>
  <div style="display: flex; flex-wrap: wrap; gap: 8px;">
    <!-- ✅ 出貨明細改成列印熱感出貨單 -->
    <button id="btnPrintOrders">列印「出貨明細」熱感出貨單</button>

    <button id="btnDownloadAccounting">下載「會計師」檔案</button>
    <button id="btnDownloadShip">下載「出貨明細／賣貨便」檔案</button>
        <button id="btnDownloadZero">下載「0 元包裹明細」檔案</button>
        <button id="btnDownloadStreamer">下載「直播主結算單」檔案</button> <!-- ★ 新增 -->
        <button id="btnDownloadNet">下載「淨利結算」檔案</button>
      </div>
    </div>

    <!-- 預覽結果區 -->
    <h2 id="previewTitle">預覽結果</h2>
    <div id="previewInfo" style="margin-bottom: 8px; font-size: 13px; color: #e5e7eb;">
      尚未查詢。
    </div>
    <div id="previewBox">
      <table id="previewTable">
        <thead id="previewThead"></thead>
        <tbody id="previewTbody"></tbody>
      </table>
    </div>
  </div>

 <script>
  const $ = (sel) => document.querySelector(sel);

  // 跟「訂單後台」同一個 API 設定
  const API = (window.API_BASE || 'https://api.murain.tw').replace(/\/$/,'');
  const STORAGE_KEY = 'MURAIN_ADMIN_OP_KEY';
  let OP_KEY = localStorage.getItem(STORAGE_KEY) || '';

     // 各類型在「預覽」時要顯示的欄位順序
  const PREVIEW_FIELDS = {
    // 出貨明細
    orders: [
      "結單完成時間",
      "訂單編號",
      "LINE名稱",
      "付款方式",
      "應付金額",
      "商品編號",
      "商品明細",
      "客戶備註",
      "出貨方式",
      "備註",
      "郵遞區號",
      "收件地址",
      "收件人姓名",
      "收件人電話",
      "超商店名",
    ],

    // 淨利結算（跟 Worker 的 EXPORT_FIELDS.net 一樣）
    net: [
      "出貨完成",
      "直播主",
      "應付金額",
      "本單_商品總成本",
      "付款方式",
      "付款手續費率",
      "付款手續費額",
      "出貨方式",
      "物流成本",
      "發票號碼",
      "發票_營業稅額",
      "總淨利(含發票稅)",
    ],
  };


  // 跟訂單後台一樣的 OP_KEY 驗證
  async function ensureOpKey(){
    const label = document.querySelector('#opLabel');
    if (label) label.textContent = OP_KEY ? '已登入後台' : '尚未登入';

    while(!OP_KEY){
      const k = prompt('請輸入管理密碼 (OP_KEY)');
      if(!k){ alert('沒有密碼就無法進入後台喔'); continue; }
      try{
        const r = await fetch(`${API}/op/auth`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ op_key:k })
        });
        const j = await r.json();
        if(!r.ok || !j.ok){
          alert('密碼錯誤，請再試一次');
          continue;
        }
        OP_KEY = k;
        localStorage.setItem(STORAGE_KEY, OP_KEY);
        if (label) label.textContent = '已登入後台';
        break;
      }catch(e){
        console.error(e);
        alert('驗證失敗，請稍後再試');
      }
    }
  }

  // 日期參數
  function getDateParams() {
    const from = $('#dateFrom')?.value || '';
    const to   = $('#dateTo')?.value || '';
    const params = [];
    if (from) params.push(`date_from=${encodeURIComponent(from)}`);
    if (to)   params.push(`date_to=${encodeURIComponent(to)}`);
    return params.length ? '&' + params.join('&') : '';
  }

  // 預覽：打 /admin/export-view?format=json
  async function preview(kind) {
    const queryDates = getDateParams();
    const url = `${API}/admin/export-view?key=${
      encodeURIComponent(OP_KEY)
    }&kind=${encodeURIComponent(kind)}&format=json${queryDates}`;

    $('#previewInfo').textContent = '載入中…';
    $('#previewThead').innerHTML = '';
    $('#previewTbody').innerHTML = '';

    try {
      const res = await fetch(url);
      if (!res.ok) {
        const txt = await res.text();
        $('#previewInfo').textContent = `讀取失敗（${res.status}）：${txt}`;
        return;
      }
      const data = await res.json();
      const records = data.records || [];
      $('#previewTitle').textContent = `預覽結果（類型：${kind}）`;
      $('#previewInfo').textContent = `共有 ${records.length} 筆（只顯示前 100 筆）`;

      if (!records.length) return;

      const firstFields = records[0].fields || {};
      // 先看 PREVIEW_FIELDS 有沒有設定固定順序，沒有才用 Object.keys
      let fieldNames = PREVIEW_FIELDS[kind] && PREVIEW_FIELDS[kind].length
        ? PREVIEW_FIELDS[kind]
        : Object.keys(firstFields);

      const theadTr = document.createElement('tr');
      fieldNames.forEach((name) => {
        const th = document.createElement('th');
        th.textContent = name;
        theadTr.appendChild(th);
      });
      $('#previewThead').appendChild(theadTr);

      const maxRows = Math.min(records.length, 100);
      for (let i = 0; i < maxRows; i++) {
        const rec = records[i];
        const f   = rec.fields || {};
        const tr  = document.createElement('tr');
        fieldNames.forEach((name) => {
          const td = document.createElement('td');
          let v = f[name];
          if (Array.isArray(v)) v = v.join(', ');
          td.textContent = v == null ? '' : String(v);
          tr.appendChild(td);
        });
        $('#previewTbody').appendChild(tr);
      }
    } catch (err) {
      console.error(err);
      $('#previewInfo').textContent = '讀取時發生錯誤：' + err.message;
    }
  }

  // 下載 CSV：打 /admin/export-view（預設就是 csv）
  function downloadKind(kind) {
    const queryDates = getDateParams();
    const url = `${API}/admin/export-view?key=${
      encodeURIComponent(OP_KEY)
    }&kind=${encodeURIComponent(kind)}${queryDates}`;
    window.location.href = url;
  }
  // 列印「出貨明細」：抓 JSON → 開新視窗 → 80mm 熱感版面
  async function printOrders() {
    const queryDates = getDateParams();
    const url = `${API}/admin/export-view?key=${
      encodeURIComponent(OP_KEY)
    }&kind=orders&format=json${queryDates}`;

    try {
      const res = await fetch(url);
      if (!res.ok) {
        const txt = await res.text();
        alert(`讀取出貨明細失敗（${res.status}）：${txt}`);
        return;
      }

      const data    = await res.json();
      const records = data.records || [];
      if (!records.length) {
        alert('目前日期區間沒有訂單可以列印');
        return;
      }

      const win = window.open('', '_blank');
      const doc = win.document;

      const slipsHtml = records.map((rec) => {
        const f = rec.fields || {};
        const orderId   = f['訂單編號'] || '';
        const doneAt    = f['結單完成時間'] || '';
        const name      = f['收件人姓名'] || '';
        const phone     = f['收件人電話'] || '';
        const zip       = f['郵遞區號'] || '';
        const addr      = f['收件地址'] || '';
        const storeName = f['超商店名'] || '';
        const payMethod = f['付款方式'] || '';
        const amount    = f['應付金額'] || '';

        return `
          <div class="slip">
            <div class="line big">${name}</div>
            <div class="line">電話：${phone}</div>
            <div class="line">地址：${zip} ${addr}</div>
            ${storeName ? `<div class="line">門市：${storeName}</div>` : ''}
            <div class="line">訂單：${orderId}</div>
            <div class="line">金額：${amount}　(${payMethod})</div>
            <div class="line small">結單時間：${doneAt}</div>
          </div>
        `;
      }).join('<div class="page-break"></div>');

      doc.write(`<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>出貨明細列印</title>
<style>
  @page {
    size: 80mm auto;      /* TP809 3" 熱感紙 */
    margin: 3mm;
  }
  body {
    margin: 0;
    padding: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    font-size: 12px;
  }
  .slip {
    width: 72mm;
    padding: 2mm 2mm 4mm;
    box-sizing: border-box;
  }
  .line {
    margin-bottom: 2px;
    white-space: pre-wrap;
    word-break: break-all;
  }
  .line.big {
    font-size: 14px;
    font-weight: 600;
  }
  .line.small {
    font-size: 11px;
    color: #555;
  }
  .page-break {
    page-break-after: always;
  }
</style>
</head>
<body>
${slipsHtml}
</body>
</html>`);
      doc.close();
      win.focus();
      win.print();
    } catch (err) {
      console.error(err);
      alert('列印出貨明細時發生錯誤：' + err.message);
    }
  }

  // 初始化
  document.addEventListener('DOMContentLoaded', async () => {
    await ensureOpKey();

    // 預設日期：本月 1 號 ~ 今天
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm   = String(today.getMonth() + 1).padStart(2, '0');
    const dd   = String(today.getDate()).padStart(2, '0');
    const first    = `${yyyy}-${mm}-01`;
    const todayStr = `${yyyy}-${mm}-${dd}`;
    if ($('#dateFrom') && !$('#dateFrom').value) $('#dateFrom').value = first;
    if ($('#dateTo')   && !$('#dateTo').value)   $('#dateTo').value   = todayStr;

    const btnPreview = $('#btnPreview');
    const selKind    = $('#previewKind');
    if (btnPreview && selKind) {
      btnPreview.addEventListener('click', () => {
        const kind = selKind.value || 'orders';
        preview(kind);
      });
    }

    $('#btnPrintOrders')?.addEventListener('click',        () => printOrders());
    $('#btnDownloadAccounting')?.addEventListener('click', () => downloadKind('accounting'));
    $('#btnDownloadShip')?.addEventListener('click',       () => downloadKind('ship'));
    $('#btnDownloadZero')?.addEventListener('click',       () => downloadKind('zero'));
    $('#btnDownloadStreamer')?.addEventListener('click',   () => downloadKind('streamer'));
    $('#btnDownloadNet')?.addEventListener('click',        () => downloadKind('net'));
  });
</script>

</body>
</html>
