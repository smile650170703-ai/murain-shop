<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MURAIN — 訂單後台（整合版）</title>
 <script>
    const $ = (sel) => document.querySelector(sel);

    // ==== 後台密碼（跟原本 Orders 後台用同一組） ====
    const API_ORIGIN  = location.origin;
    const STORAGE_KEY = 'murain_admin_op_key';   // 可以跟原本後台一樣
    let OP_KEY        = localStorage.getItem(STORAGE_KEY) || '';

    async function ensureOpKey() {
      while (!OP_KEY) {
        const v = window.prompt('請輸入後台密碼（OP_KEY）：', '');
        if (v === null) break;       // 按取消就停
        OP_KEY = v.trim();
        if (OP_KEY) {
          localStorage.setItem(STORAGE_KEY, OP_KEY);
        }
      }
    }

    // 日期參數
    function getDateParams() {
      const from = $('#dateFrom')?.value || '';
      const to   = $('#dateTo')?.value || '';
      const params = [];
      if (from) params.push(`date_from=${encodeURIComponent(from)}`);
      if (to)   params.push(`date_to=${encodeURIComponent(to)}`);
      return params.length ? '&' + params.join('&') : '';
    }

    // 預覽：用 format=json 把資料抓回來，塞到下面的表格
    async function preview(kind) {
      const queryDates = getDateParams();
      const url = `${API_ORIGIN}/admin/export-view?key=${
        encodeURIComponent(OP_KEY)
      }&kind=${encodeURIComponent(kind)}&format=json${queryDates}`;

      $('#previewInfo').textContent = '載入中…';
      $('#previewThead').innerHTML = '';
      $('#previewTbody').innerHTML = '';

      try {
        const res = await fetch(url);
        if (!res.ok) {
          const txt = await res.text();
          $('#previewInfo').textContent = `讀取失敗（${res.status}）：${txt}`;
          return;
        }
        const data = await res.json();
        const records = data.records || [];
        $('#previewTitle').textContent = `預覽結果（類型：${kind}）`;
        $('#previewInfo').textContent = `共有 ${records.length} 筆（只顯示前 100 筆）`;

        if (!records.length) {
          return;
        }

        const firstFields = records[0].fields || {};
        const fieldNames = Object.keys(firstFields);

        // 表頭
        const theadTr = document.createElement('tr');
        fieldNames.forEach((name) => {
          const th = document.createElement('th');
          th.textContent = name;
          th.style.border = '1px solid #ddd';
          th.style.padding = '4px';
          th.style.position = 'sticky';
          th.style.top = '0';
          th.style.background = '#f7f7f7';
          theadTr.appendChild(th);
        });
        $('#previewThead').appendChild(theadTr);

        // 資料列（最多 100 筆）
        const maxRows = Math.min(records.length, 100);
        for (let i = 0; i < maxRows; i++) {
          const rec = records[i];
          const f = rec.fields || {};
          const tr = document.createElement('tr');
          fieldNames.forEach((name) => {
            const td = document.createElement('td');
            let v = f[name];
            if (Array.isArray(v)) {
              v = v.join(', ');
            }
            td.textContent = v == null ? '' : String(v);
            td.style.border = '1px solid #eee';
            td.style.padding = '3px 4px';
            tr.appendChild(td);
          });
          $('#previewTbody').appendChild(tr);
        }
      } catch (err) {
        console.error(err);
        $('#previewInfo').textContent = '讀取時發生錯誤：' + err.message;
      }
    }

    // 下載：直接打 CSV 版
    function downloadKind(kind) {
      const queryDates = getDateParams();
      const url = `${API_ORIGIN}/admin/export-view?key=${
        encodeURIComponent(OP_KEY)
      }&kind=${encodeURIComponent(kind)}${queryDates}`;
      window.location.href = url; // 觸發下載
    }

    // 頁面初始化
    document.addEventListener('DOMContentLoaded', async () => {
      // 1) 先要密碼
      await ensureOpKey();

      // 2) 預設日期：本月 1 號 ~ 今天
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm   = String(today.getMonth() + 1).padStart(2, '0');
      const dd   = String(today.getDate()).padStart(2, '0');
      const first     = `${yyyy}-${mm}-01`;
      const todayStr  = `${yyyy}-${mm}-${dd}`;
      if ($('#dateFrom') && !$('#dateFrom').value) $('#dateFrom').value = first;
      if ($('#dateTo')   && !$('#dateTo').value)   $('#dateTo').value   = todayStr;

      // 3) 綁定按鈕
      const btnPreview = $('#btnPreview');
      const selKind    = $('#previewKind');

      if (btnPreview && selKind) {
        btnPreview.addEventListener('click', () => {
          const kind = selKind.value || 'orders';
          preview(kind);
        });
      }

      $('#btnDownloadOrders')?.addEventListener('click',     () => downloadKind('orders'));
      $('#btnDownloadAccounting')?.addEventListener('click', () => downloadKind('accounting'));
      $('#btnDownloadShip')?.addEventListener('click',       () => downloadKind('ship'));
      $('#btnDownloadZero')?.addEventListener('click',       () => downloadKind('zero'));
    });
  </script>
</body>
</html>
