<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>XUYUAN | 會員中心</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #050505;
      --card: #111;
      --text: #fff;
      --sub-text: #888;
      --gold: #D4AF37;
      --border: rgba(255, 255, 255, 0.1);
      --font-serif: 'Playfair Display', serif;
      --font-sans: 'Lato', sans-serif;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg);
      color: var(--text);
      /* 極簡純黑背景，去除紋理 */
    }

    .page {
      max-width: 600px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    /* --- Header 極簡化 --- */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    .brand {
      font-family: var(--font-serif);
      font-size: 20px;
      letter-spacing: 0.15em;
      color: var(--gold);
    }
    .refresh-btn {
      background: none; border: none;
      color: var(--sub-text); font-size: 13px;
      cursor: pointer; letter-spacing: 0.05em;
    }

    /* --- 會員卡片 (極簡黑金版) --- */
    .member-info {
      margin-bottom: 40px;
      text-align: center;
    }
    .avatar {
      width: 60px; height: 60px;
      border-radius: 50%;
      background: #1a1a1a;
      margin: 0 auto 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 24px; color: var(--gold);
      border: 1px solid var(--border);
    }
    .welcome { font-size: 14px; color: var(--sub-text); margin-bottom: 4px; }
    .username { font-size: 18px; font-weight: 600; color: #fff; margin-bottom: 20px; }

    /* 購物金顯示 (大數字) */
    .credit-block {
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      padding: 20px 0;
      display: flex; flex-direction: column; gap: 4px;
    }
    .credit-label { font-size: 11px; letter-spacing: 0.15em; color: var(--gold); text-transform: uppercase; }
    .credit-val { font-family: var(--font-serif); font-size: 32px; color: #fff; }

    /* --- 分頁 Tabs (文字型) --- */
    .tabs {
      display: flex;
      gap: 24px;
      margin-bottom: 24px;
      overflow-x: auto;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }
    .tab {
      background: none; border: none;
      color: var(--sub-text);
      font-size: 13px;
      white-space: nowrap;
      cursor: pointer;
      padding: 0;
      transition: 0.2s;
      position: relative;
    }
    .tab.active {
      color: #fff;
      font-weight: 600;
    }
    /* 作用中底線 */
    .tab.active::after {
      content: ''; position: absolute;
      bottom: -13px; left: 0; right: 0;
      height: 2px; background: var(--gold);
    }

    /* --- 列表容器 --- */
    .msg { font-size: 12px; color: var(--sub-text); text-align: center; margin: 20px 0; }
    .empty { font-size: 13px; color: #444; text-align: center; margin-top: 40px; letter-spacing: 1px; }

    /* --- 訂單卡片 (極簡線條) --- */
    .order-list, .credits-list { display: flex; flex-direction: column; gap: 20px; }

    .card-item {
      background: transparent; /* 透明背景 */
      border: 1px solid var(--border);
      padding: 16px;
      border-radius: 4px; /* 稍微方正一點 */
    }
    .card-top {
      display: flex; justify-content: space-between; margin-bottom: 12px;
      font-size: 12px; color: var(--sub-text);
    }
    .status { color: var(--gold); }
    
    .card-main {
      display: flex; justify-content: space-between; align-items: flex-end;
    }
    .card-info { font-size: 13px; color: #ccc; line-height: 1.6; }
    .amount { font-family: var(--font-serif); font-size: 16px; color: #fff; }

    /* --- 紅利列表樣式 --- */
    .credit-row {
      display: flex; justify-content: space-between; align-items: center;
      padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .c-reason { font-size: 14px; color: #eee; margin-bottom: 2px; }
    .c-date { font-size: 11px; color: #666; }
    .c-amt { font-family: var(--font-serif); font-size: 15px; }
    .pos { color: #fff; } .neg { color: #888; }

  </style>
</head>
<body>

  <div class="page">
    
    <!-- 1. Header -->
    <div class="header">
      <div class="brand">XUYUAN</div>
      <button class="refresh-btn" id="reloadBtn">重新整理</button>
    </div>

    <!-- 2. 會員資訊區 -->
    <div class="member-info">
      <div class="avatar">X</div>
      <div class="welcome" id="statusText">Welcome</div>
      <div class="username" id="userName">Guest</div>
      
      <!-- 購物金 (重點展示) -->
      <div class="credit-block">
        <span class="credit-label">Current Balance</span>
        <span class="credit-val" id="creditValue">NT$ --</span>
      </div>
    </div>

    <!-- 3. 選單 Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="all">全部訂單</button>
      <button class="tab" data-tab="live">直播訂單</button>
      <button class="tab" data-tab="web">官網訂單</button>
      <button class="tab" data-tab="credits">點數紀錄</button>
    </div>

    <div class="msg" id="infoMsg">讀取資料中...</div>

    <!-- 4. 內容區 -->
    <div id="orderList" class="order-list"></div>
    <div id="creditsList" class="credits-list" style="display:none;"></div>
    
    <div id="emptyText" class="empty" style="display:none;">NO RECORDS FOUND</div>

  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<script>
  /* --- 邏輯完全保留 --- */
  const API_BASE    = "https://api.murain.tw";
  const MEMBER_API  = API_BASE + "/member/orders";
  const CREDITS_API = API_BASE + "/member/credits";
  const MEMBER_INFO_API = API_BASE + "/line/member-info";
  const LIFF_ID     = "2008430261-EGZPg3Qp";

  let currentUserId = null;
  let orders = [];
  let memberInfo = null;
  let credits = [];
  let currentFilter = "all";

  // Elements
  const statusText  = document.getElementById("statusText");
  const userName    = document.getElementById("userName");
  const infoMsg     = document.getElementById("infoMsg");
  const orderList   = document.getElementById("orderList");
  const creditsList = document.getElementById("creditsList");
  const emptyText   = document.getElementById("emptyText");
  const creditValue = document.getElementById("creditValue");

  document.getElementById("reloadBtn").onclick = () => {
    if (currentUserId) {
      infoMsg.textContent = "更新中...";
      loadMemberInfo();
      loadOrders();
    } else {
      initLiff();
    }
  };

  /* --- 顯示邏輯 (配合新樣式) --- */
  function formatDate(s) {
    if (!s) return "";
    const d = new Date(s);
    return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
  }

  function displayStatus(st) {
    const map = { 'submitted':'已送出', 'paid':'已付款', 'shipped':'已出貨', 'cancelled':'已取消' };
    return map[st] || st || "處理中";
  }

  function renderOrders() {
    orderList.style.display   = "flex";
    creditsList.style.display = "none";
    emptyText.style.display   = "none";
    orderList.innerHTML       = "";

    let list = orders.slice();
    if (currentFilter === "live") list = list.filter(o => !!o.streamer_name);
    else if (currentFilter === "web") list = list.filter(o => !o.streamer_name);

    if (!list.length) {
      emptyText.style.display = "block";
      return;
    }

    list.forEach(o => {
      const div = document.createElement("div");
      div.className = "card-item";
      // 寄送方式
      const shipMethod = o.ship && o.ship.method ? o.ship.method : "配送中";
      
      div.innerHTML = `
        <div class="card-top">
          <span>#${o.order_id}</span>
          <span class="status">${displayStatus(o.status)}</span>
        </div>
        <div class="card-main">
          <div class="card-info">
            <div>${formatDate(o.created_at)}</div>
            <div>${shipMethod}</div>
          </div>
          <div class="amount">NT$ ${(o.total_amount||0).toLocaleString()}</div>
        </div>
      `;
      orderList.appendChild(div);
    });
  }

  function renderCredits() {
    orderList.style.display   = "none";
    creditsList.style.display = "flex";
    emptyText.style.display   = "none";
    creditsList.innerHTML     = "";

    if (!credits.length) {
      emptyText.style.display = "block";
      return;
    }

    credits.forEach(c => {
      const div = document.createElement("div");
      div.className = "credit-row";
      const amt = Number(c.amount||0);
      const sign = amt > 0 ? '+' : '';
      const cls = amt > 0 ? 'pos' : 'neg';
      
      div.innerHTML = `
        <div>
          <div class="c-reason">${c.reason || (c.type==='use'?'使用折抵':'獲得點數')}</div>
          <div class="c-date">${formatDate(c.created_at)}</div>
        </div>
        <div class="c-amt ${cls}">${sign}${amt.toLocaleString()}</div>
      `;
      creditsList.appendChild(div);
    });
  }

  /* --- API Functions --- */
  async function loadMemberInfo() {
    if (!currentUserId) return;
    try {
      const res = await fetch(MEMBER_INFO_API + "?user_id=" + encodeURIComponent(currentUserId));
      const json = await res.json();
      if (res.ok && json.ok) {
        memberInfo = json;
        const c = memberInfo.credit || 0;
        creditValue.textContent = "NT$ " + c.toLocaleString();
      }
    } catch(e){}
  }

  async function loadCredits() {
    if(!currentUserId) return;
    infoMsg.textContent = "Loading...";
    try {
      const res = await fetch(CREDITS_API + "?line_user_id=" + encodeURIComponent(currentUserId));
      const json = await res.json();
      if(res.ok && json.ok) {
        credits = json.items || [];
        if(currentFilter === 'credits') renderCredits();
      }
    } catch(e){}
    infoMsg.textContent = "";
  }

  async function loadOrders() {
    if(!currentUserId) return;
    infoMsg.textContent = "Loading...";
    try {
      const res = await fetch(MEMBER_API + "?line_user_id=" + encodeURIComponent(currentUserId));
      const json = await res.json();
      if(res.ok && json.ok) {
        orders = json.orders || [];
        if(currentFilter !== 'credits') renderOrders();
      }
    } catch(e){}
    infoMsg.textContent = "";
  }

  async function initLiff() {
    if (!window.liff) return;
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) {
        liff.login(); return;
      }
      const profile = await liff.getProfile();
      currentUserId = profile.userId;
      userName.textContent = profile.displayName;
      statusText.textContent = "Welcome Back";
      
      // Load Data
      loadMemberInfo();
      loadOrders();
    } catch (e) {
      infoMsg.textContent = "Please open in LINE app.";
    }
  }

  /* --- Tabs --- */
  document.querySelectorAll(".tab").forEach(btn => {
    btn.onclick = () => {
      // UI Toggle
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      btn.classList.add("active");
      
      currentFilter = btn.dataset.tab;
      if (currentFilter === "credits") {
        renderCredits();
        loadCredits();
      } else {
        renderOrders();
      }
    };
  });

  // Init
  initLiff();
</script>
</body>
</html>
