<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>XUYUAN | 會員中心</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    /* --- 核心變數 & 高級感調色盤 --- */
    :root {
      --bg-color: #050505; 
      --card-bg: rgba(20, 20, 20, 0.65);
      --border-color: rgba(255, 255, 255, 0.08);
      --text-main: #fcfcfc;
      --text-sub: #a0a0a0;
      --text-muted: #666666;
      --gold-primary: #cfc09f; 
      --gold-gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
      --gold-text-gradient: linear-gradient(to bottom, #cfc09f, #ffecb3);
      --success: #5eb37e;
      --success-bg: rgba(94, 179, 126, 0.1);
      --danger: #d45d5d;
      --danger-bg: rgba(212, 93, 93, 0.1);
      --font-serif: 'Playfair Display', 'Noto Sans TC', serif;
      --font-sans: 'Lato', 'Noto Sans TC', sans-serif;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      background-image: 
        radial-gradient(circle at 50% -10%, rgba(50, 50, 50, 0.4) 0%, transparent 60%),
        linear-gradient(to bottom, #050505 0%, #000000 100%);
      background-attachment: fixed;
    }

    .page {
      max-width: 600px;
      margin: 0 auto;
      padding: 30px 20px 80px;
      animation: fadeIn 0.8s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* --- Header --- */
    .header-area {
      text-align: center;
      margin-bottom: 32px;
      position: relative;
      padding-top: 10px;
    }
    
    .brand-title {
      font-family: var(--font-serif);
      font-size: 28px;
      letter-spacing: 0.15em;
      background: var(--gold-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
      font-weight: 700;
      text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    
    .page-title {
      font-size: 13px;
      letter-spacing: 0.2em;
      color: var(--text-muted);
      text-transform: uppercase;
      font-weight: 400;
      padding-left: 0.2em;
    }

    .refresh-btn, .clear-focus-btn {
      position: absolute;
      top: 0;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-color);
      color: var(--text-sub);
      width: 36px; height: 36px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      backdrop-filter: blur(4px);
    }
    .refresh-btn { right: 0; }
    .clear-focus-btn { right: 48px; }

    .refresh-btn:hover, .clear-focus-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--text-sub);
      color: #fff;
    }
    .refresh-btn:active, .clear-focus-btn:active { transform: scale(0.95); }

    /* --- Member Card --- */
    .member-card {
      background: rgba(20, 20, 20, 0.4);
      backdrop-filter: blur(15px); 
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 20px;
      padding: 28px;
      margin-bottom: 32px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0,0,0,0.6);
    }
    
    .member-card::after {
      content: '';
      position: absolute;
      top: 0; left: -100%;
      width: 50%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
      transform: skewX(-25deg);
      animation: shine 6s infinite;
      pointer-events: none;
    }
    
    @keyframes shine {
      0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; }
    }
    
    .member-card::before {
      content: ''; position: absolute;
      top: -50%; right: -20%;
      width: 250px; height: 250px;
      background: radial-gradient(circle, rgba(191, 149, 63, 0.15), transparent 70%);
      filter: blur(40px);
      z-index: 0;
    }

    .user-info {
      display: flex; align-items: center; gap: 18px;
      margin-bottom: 30px;
      position: relative; z-index: 2;
    }
    
    .user-avatar {
      width: 56px; height: 56px;
      background: #0f0f0f; 
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: #cfc09f; 
      font-size: 22px;
      box-shadow: 0 0 0 1px rgba(191, 149, 63, 0.3), 0 0 0 4px rgba(0,0,0,0.5);
      overflow: hidden;
    }
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; }

    .user-name { 
      font-family: var(--font-serif); font-size: 20px; font-weight: 500; color: #fff; letter-spacing: 0.05em; 
    }
    .user-status { 
      font-family: var(--font-sans); font-size: 12px; color: var(--gold-primary); margin-top: 4px; letter-spacing: 0.1em; opacity: 0.8;
    }

    .credit-row {
      display: flex; justify-content: space-between; align-items: flex-end;
      position: relative; z-index: 2;
      border-top: 1px solid rgba(255,255,255,0.08);
      padding-top: 20px;
    }
    .credit-label { font-size: 13px; color: var(--text-sub); letter-spacing: 0.05em; margin-bottom: 6px; }
    .credit-amount {
      font-family: var(--font-sans); font-size: 24px;
      background: var(--gold-text-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      font-weight: 700; line-height: 1; font-variant-numeric: tabular-nums;
      letter-spacing: 0.05em; text-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    
    /* --- Tabs --- */
    .tabs {
      display: flex; background: #111; padding: 4px;
      border-radius: 99em; margin-bottom: 28px;
      border: 1px solid var(--border-color);
      position: relative;
    }
    .tab {
      flex: 1; padding: 10px 0; border: none; background: transparent;
      color: var(--text-muted); font-size: 13px; border-radius: 99em;
      cursor: pointer; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      font-family: var(--font-sans); font-weight: 500; letter-spacing: 0.05em;
      position: relative; z-index: 2;
    }
    .tab.active {
      background: #252525; color: #fff; font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
    }

    .msg { font-size: 12px; color: var(--text-sub); text-align: center; margin: 20px 0; letter-spacing: 0.05em; }
    .msg.error { color: var(--danger); }
    .empty-state {
      padding: 60px 0; text-align: center; color: var(--text-muted); font-size: 13px;
      border: 1px dashed var(--border-color); border-radius: 16px;
      background: rgba(255,255,255,0.01); letter-spacing: 0.05em;
    }

    /* --- [修改] 訂單卡片 (Order Card) --- */
    .order-list { display: flex; flex-direction: column; gap: 16px; }
    
    .order-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 0; /* 內距改由內部元素控制 */
      border: 1px solid var(--border-color);
      position: relative;
      overflow: hidden; 
      transition: all 0.3s ease;
      animation: fadeIn 0.5s ease-out;
      cursor: pointer;
    }
    .order-card:active { transform: scale(0.99); }
    
    /* 標頭：常駐顯示 */
    .card-header {
      padding: 20px;
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid transparent;
      margin-bottom: 0;
      background: rgba(255,255,255,0.01);
      transition: background 0.3s;
    }
    .order-card.expanded .card-header {
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    /* ✅ 方案A：先隱藏四段進度條（不影響 JS，不會噴錯） */
.p-steps{
  display: none !important;
}
    
    .order-info-main { display: flex; flex-direction: column; gap: 4px; }
    .order-id { 
      font-family: 'Lato', monospace; font-size: 15px; color: #fff; 
      letter-spacing: 0.05em; font-weight: 600;
    }
    .order-date { 
      font-size: 11px; color: var(--text-muted); font-family: var(--font-sans);
    }
    
    /* 狀態 Badge */
    .status-badge {
      font-size: 11px; padding: 4px 10px; border-radius: 4px;
      font-weight: 500; white-space: nowrap; backdrop-filter: blur(4px);
    }
    .st-paid { background: var(--success-bg); color: var(--success); border: 1px solid rgba(94, 179, 126, 0.2); }
    .st-unpaid { background: var(--danger-bg); color: var(--danger); border: 1px solid rgba(212, 93, 93, 0.2); }
    .st-waitpay {
      background: linear-gradient(135deg, rgba(124, 92, 255, 0.16), rgba(64, 129, 255, 0.10));
      color: #d9d3ff; border: 1px solid rgba(124, 92, 255, 0.25);
    }
    .st-pending {
      background: linear-gradient(135deg, rgba(255, 168, 76, 0.18), rgba(210, 122, 44, 0.10));
      color: #ffd9ad; border: 1px solid rgba(255, 168, 76, 0.25);
    }

    /* 箭頭 Icon */
    .toggle-icon {
      margin-left: 10px; width: 20px; height: 20px;
      display: flex; align-items: center; justify-content: center;
      transition: transform 0.3s ease; opacity: 0.5;
    }
    .toggle-icon::after {
      content: ''; display: block; width: 8px; height: 8px;
      border-right: 2px solid var(--text-sub); border-bottom: 2px solid var(--text-sub);
      transform: rotate(45deg);
    }
    .order-card.expanded .toggle-icon { transform: rotate(-180deg); }

    /* 隱藏區塊：內容明細 */
    .card-body { 
      display: none; 
      padding: 20px;
      background: rgba(0,0,0,0.2);
      animation: slideDown 0.3s ease-out;
    }
    .order-card.expanded .card-body { display: block; }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .info-group { display: flex; flex-direction: column; gap: 12px; font-size: 13px; color: var(--text-sub); margin-bottom: 20px; }
    .info-row {
      display: flex; flex-direction: column; gap: 6px;
      border-bottom: 1px solid rgba(255,255,255,0.03); padding-bottom: 12px;
    }
    .info-row:last-child { border-bottom: none; }
    
    .info-label { 
      font-size: 11px; color: var(--gold-primary); font-family: var(--font-serif);
      margin-bottom: 2px; display: inline-block; letter-spacing: 0.05em;
    }

    .items-box{
      margin-top: 5px; padding: 10px; border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.05); background: rgba(255,255,255,0.02);
    }
    .items-title{ font-size: 11px; color: var(--text-muted); margin-bottom: 6px; }
    .items-text{ font-size: 12px; color: #fff; line-height: 1.6; }

    .amount-display { 
      display: flex; justify-content: flex-end; align-items: center; gap: 10px;
      border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;
    }
    .amount-label { font-size: 11px; color: var(--text-muted); letter-spacing: 0.05em; }
    .amount-val {
      font-family: var(--font-sans); font-size: 16px; color: #ffffff; 
      font-weight: 700; font-variant-numeric: tabular-nums;
      letter-spacing: 0.05em; text-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }

    /* ===== Amount Breakdown + Progress + Actions ===== */
.amount-breakdown{
  margin-top: 14px;
  padding: 12px 12px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.06);
  background: rgba(255,255,255,0.02);
}
.amount-line{
  display:flex;
  justify-content: space-between;
  align-items: baseline;
  gap: 10px;
  padding: 6px 0;
  border-bottom: 1px solid rgba(255,255,255,0.04);
}
.amount-line:last-child{ border-bottom:none; }
.amount-line .k{
  font-size: 11px;
  color: var(--text-muted);
  letter-spacing: .06em;
}
.amount-line .v{
  font-size: 13px;
  color: #fff;
  font-variant-numeric: tabular-nums;
  font-weight: 600;
}
.tag{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding: 2px 6px;
  margin-left: 8px;
  border-radius: 999px;
  font-size: 10px;
  letter-spacing: .08em;
  border: 1px solid rgba(255,255,255,0.12);
  opacity: .9;
}
.tag-ok{ background: rgba(94,179,126,0.10); color: var(--success); border-color: rgba(94,179,126,0.22); }
.tag-pending{ background: rgba(255,168,76,0.10); color: #ffd9ad; border-color: rgba(255,168,76,0.22); }

.progress{
  margin-top: 12px;
  padding: 12px 12px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.06);
  background: rgba(0,0,0,0.18);
}
.p-steps{
  display:flex;
  align-items:flex-start;
  gap: 10px;
}
.p-step{
  flex: 1;
  display:flex;
  flex-direction: column;
  gap: 6px;
  position: relative;
}
.p-step .dot{
  width: 10px;
  height: 10px;
  border-radius: 50%;
  border: 1px solid rgba(255,255,255,0.25);
  background: rgba(255,255,255,0.06);
}
.p-step.done .dot{
  border-color: rgba(191,149,63,0.55);
  background: rgba(191,149,63,0.25);
}
.p-step.current .dot{
  box-shadow: 0 0 0 4px rgba(191,149,63,0.12);
}
.p-step .lbl{
  font-size: 10px;
  color: var(--text-sub);
  line-height: 1.35;
  letter-spacing: .05em;
}
.p-step.done .lbl{ color: #fff; }
.p-step:after{
  content:'';
  position:absolute;
  top: 5px;
  right: -5px;
  width: calc(100% + 10px);
  height: 1px;
  background: rgba(255,255,255,0.10);
  z-index: 0;
}
.p-step:last-child:after{ display:none; }

.microcopy{
  margin-top: 10px;
  font-size: 12px;
  color: var(--text-sub);
  line-height: 1.55;
  letter-spacing: .03em;
}

.action-row{
  display:flex;
  gap: 10px;
  margin-top: 12px;
}
.btn-mini{
  flex: 1;
  border: 1px solid rgba(255,255,255,0.10);
  background: rgba(255,255,255,0.03);
  color: #fff;
  padding: 10px 10px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 12px;
  letter-spacing: .06em;
  transition: transform .12s ease, background .2s ease, border-color .2s ease;
}
.btn-mini:active{ transform: scale(0.98); }
.btn-ghost:hover{ background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.18); }
.btn-gold{
  background: var(--gold-gradient);
  color: #111;
  border-color: rgba(255,255,255,0.12);
  font-weight: 700;
}

    /* --- Credits List --- */
    .credits-list { display: flex; flex-direction: column; gap: 0; }
    .credit-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 20px 10px; background: transparent;
      border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.2s;
    }
    .credit-item:last-child { border-bottom: none; }
    .credit-item:hover { background: rgba(255,255,255,0.02); }

    .c-info { display: flex; flex-direction: column; gap: 6px; }
    .c-reason { font-size: 14px; color: #ececec; font-weight: 400; letter-spacing: 0.03em; }
    .c-date { font-size: 11px; color: #666; font-family: monospace; }
    
    .c-amount {
      font-family: var(--font-sans); font-size: 18px; font-weight: 600; text-align: right;
      font-variant-numeric: tabular-nums; letter-spacing: 0.02em;
    }
    .c-amount.pos { color: var(--success); }
    .c-amount.neg { color: var(--danger); }
    .c-balance { font-size: 10px; color: #555; text-align: right; margin-top: 4px; font-family: var(--font-sans); }
  </style>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

  <div class="page">
    <div class="header-area">
      <div class="brand-title">XUYUAN</div>
      <div class="page-title">會員中心</div>
      <button class="refresh-btn" id="reloadBtn" title="重新整理">↻</button>
      <button class="clear-focus-btn" id="clearFocusBtn" title="取消定位" style="display:none;">✕</button>
    </div>

    <div class="member-card">
      <div class="user-info">
        <div class="user-avatar">
          <span id="defaultAvatar">X</span>
          <img id="userAvatarImg" style="display:none;" />
        </div>
        <div>
          <div class="user-name" id="userName">貴賓</div>
          <div class="user-status" id="statusText">歡迎回來</div>
        </div>
      </div>
      <div class="credit-row">
        <div>
          <div class="credit-label">可用購物金</div>
        </div>
        <div class="credit-amount" id="creditValue">NT$ --</div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="history">歷史訂單</button>
      <button class="tab" data-tab="deposit">定金保留</button>
      <button class="tab" data-tab="credits">購物金明細</button>
    </div>

    <div class="msg" id="infoMsg">資料讀取中...</div>
    <div class="order-list" id="orderList"></div>
    <div class="credits-list" id="creditsList" style="display:none;"></div>
    <div class="empty-state" id="emptyText" style="display:none;">尚無資料紀錄</div>
  </div>

<script>
  const API_BASE    = "https://api.murain.tw";
  const MEMBER_API  = API_BASE + "/member/orders";
  const CREDITS_API = API_BASE + "/member/credits";
  const MEMBER_INFO_API = API_BASE + "/line/member-info";
  const LIFF_ID     = "2008430261-EGZPg3Qp";

  let currentUserId = null;
  let orders = [];
  let memberInfo = null;
  let credits = [];
  let currentFilter = "history";

  const urlParams = new URLSearchParams(window.location.search || "");
  let focusOrderId = urlParams.get("order_id") || "";
  let hasScrolledToInitialOrder = false;

  // DOM Elements
  const statusText  = document.getElementById("statusText");
  const userName    = document.getElementById("userName");
  const userAvatarImg = document.getElementById("userAvatarImg");
  const defaultAvatar = document.getElementById("defaultAvatar");
  const infoMsg     = document.getElementById("infoMsg");
  const orderList   = document.getElementById("orderList");
  const creditsList = document.getElementById("creditsList");
  const emptyText   = document.getElementById("emptyText");
  const creditValue = document.getElementById("creditValue");
  const clearFocusBtn = document.getElementById("clearFocusBtn");

  document.getElementById("reloadBtn").addEventListener("click", () => {
    if (currentUserId) {
      infoMsg.textContent = "更新資料中...";
      infoMsg.style.display = "block";
      loadMemberInfo();
      loadOrders();
      loadCredits();
    } else {
      initLiff();
    }
  })

  if (clearFocusBtn) {
    if (focusOrderId) clearFocusBtn.style.display = "flex";
    clearFocusBtn.addEventListener("click", () => {
      focusOrderId = "";
      hasScrolledToInitialOrder = true;
      try {
        const u = new URL(window.location.href);
        u.searchParams.delete("order_id");
        history.replaceState({}, "", u.toString());
      } catch (e) {}
      if (currentFilter === "credits") renderCredits();
      else renderOrders();
      clearFocusBtn.style.display = "none";
    });
  };

  /* --- Helper Functions --- */
  function formatDate(input) {
  if (!input) return "";
  const d = (input instanceof Date) ? input : new Date(input);
  if (isNaN(d.getTime())) return String(input || "");
  return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
}

  function getShippingInfoObj(o){
  const ship = o?.ship || {};
  const raw =
    o?.shipping_info || o?.shippingInfo ||
    ship?.shipping_info || ship?.shippingInfo ||
    {};
  if (!raw) return {};
  if (typeof raw === "object") return raw;
  try { return JSON.parse(String(raw)); } catch (e) { return {}; }
}

// ✅ 定金保留：抓「保留到期日」(有值就顯示；沒有就回 null)
// ✅ 定金保留：抓「保留到期日」(回傳原字串；讓 formatDate 自己格式化)
function getDepositHoldExpireAt(o){
  const si = getShippingInfoObj(o);

  const v =
    o?.deposit_expire_at || o?.depositExpireAt ||
    si?.deposit_expire_at || si?.depositExpireAt ||
    si?.deposit_due_at || si?.depositDueAt ||
    si?.deposit_deadline || si?.depositDeadline ||
    si?.hold_until || si?.holdUntil ||
    si?.deposit_hold_until || si?.depositHoldUntil ||
    si?.deposit?.expire_at || si?.deposit?.expireAt ||
    si?.deposit?.due_at || si?.deposit?.dueAt ||
    "";

  // ✅ 直接回傳字串（例如 "2026年1月5日" / "2026-01-05" 都能顯示）
  return String(v || "").trim();
}

  function toInt(v){
    const n = Number(v);
    if (!Number.isFinite(n)) return 0;
    return Math.round(n);
  }
  function pickNum(...vals){
    for (const v of vals){
      const x = toInt(v);
      if (x > 0) return x;
    }
    return 0;
  }
  function money(v){
    return "NT$ " + toInt(v).toLocaleString("zh-TW");
  }
  // ✅ 新增：判斷已付款
function isPaidOk(ps){
  const s = String(ps || "").toLowerCase();
  return (s === "paid" || s === "paid_ok");
}

// ✅ 新增：尾款已付金額（尾款單通常 paid_ok 時就用 total_amount）
function getTailPaidAmount(t){
  if (!t) return 0;
  if (isPaidOk(t.pay_status)) return toInt(t.total_amount || 0);

  // 若你未來 tail 也會回 paid_amount，這裡也吃得到
  return pickNum(
    t.paid_amount, t.paidAmount,
    t.deposit_paid, t.depositPaid,
    t.deposit_amount, t.depositAmount
  );
}

  function getPaidAmount(o){
  const total = toInt(o?.total_amount || 0);
  const ps = String(o?.pay_status || "").toLowerCase();

  // 若主單已全額付款，直接視為已付=總額
  if (ps === "paid" || ps === "paid_ok") return total;

  const ship = o?.ship || {};
  const si = o?.shipping_info || o?.shippingInfo || ship?.shipping_info || ship?.shippingInfo || {};

  // 主單已付（訂金/已付款）
  let paid = pickNum(
    o?.paid_amount, o?.paidAmount,
    o?.deposit_paid, o?.depositPaid,
    o?.deposit_amount, o?.depositAmount,

    si?.paid_amount, si?.paidAmount,
    si?.deposit_paid, si?.depositPaid,
    si?.deposit_amount, si?.depositAmount,
    si?.deposit?.paid, si?.deposit?.amount,

    ship?.paid_amount, ship?.paidAmount,
    ship?.deposit_paid, ship?.depositPaid,
    ship?.deposit_amount, ship?.depositAmount,
    ship?.deposit?.paid, ship?.deposit?.amount
  );

  // ✅ 把尾款單已付加進來（這就是讓後台/會員中心一致的關鍵）
  const tail = o?.tail_order || null;
  if (tail) paid += getTailPaidAmount(tail);

  return Math.min(total, paid);
}

function getRemainingAmount(o){
  const total = toInt(o?.total_amount || 0);
  return Math.max(0, total - getPaidAmount(o));
}

  function safeObj(v){
  if (!v) return {};
  if (typeof v === "object") return v;
  try { return JSON.parse(String(v)); } catch(e){ return {}; }
}

// ✅ 保留到期日：優先吃你的 Airtable 欄位 deposit_expire_at
function getDepositExpireAt(o){
  const ship = o?.ship || {};
  const siRaw = o?.shipping_info || o?.shippingInfo || ship?.shipping_info || ship?.shippingInfo || {};
  const si = safeObj(siRaw);
  const dep = si?.deposit || {};

  const v =
    o?.deposit_expire_at || o?.depositExpireAt ||
    ship?.deposit_expire_at || ship?.depositExpireAt ||
    si?.deposit_expire_at || si?.depositExpireAt ||
    dep?.expire_at || dep?.expireAt ||
    // 兼容你另一個欄位（以防 API 回的是 hold_until）
    o?.hold_until || o?.holdUntil ||
    ship?.hold_until || ship?.holdUntil ||
    si?.hold_until || si?.holdUntil ||
    dep?.hold_until || dep?.holdUntil ||
    "";

  return String(v || "").trim();
}

  function getTrackingNo(o){
  const ship = o?.ship || {};
  const si = o?.shipping_info || o?.shippingInfo || ship?.shipping_info || ship?.shippingInfo || {};
  const v = String(
    ship?.tracking_no || ship?.trackingNo ||
    ship?.tracking_number || ship?.trackingNumber ||
    ship?.ship_no || ship?.shipNo ||
    ship?.waybill || ship?.waybill_no || ship?.waybillNo ||
    ship?.logistics_no || ship?.logisticsNo ||
    si?.tracking_no || si?.trackingNo ||
    si?.tracking_number || si?.trackingNumber ||
    si?.ship_no || si?.shipNo ||
    o?.tracking_no || o?.trackingNo ||
    o?.tracking_number || o?.trackingNumber ||
    ""
  ).trim();
  return v;
}

  function isDepositConfirmed(o){
    const ps = String(o?.pay_status || "").toLowerCase();
    const st = String(o?.status || "").toLowerCase();
    const ss = String(o?.ship_status || "").toLowerCase();
    return (ps === "deposit_ok" || st === "deposit_ok" || ss === "deposit_ok");
  }
  function isDepositChecking(o){
    const ps = String(o?.pay_status || "").toLowerCase();
    const st = String(o?.status || "").toLowerCase();
    const ss = String(o?.ship_status || "").toLowerCase();
    return (st.includes("deposit_hold") || ps.includes("deposit_hold") || ss.includes("deposit_hold"));
  }

  // ✅ history 用：下單 - 付款狀態 - 出貨狀態（3 段）
function progressStageHistory3(o){
  const st = String(o?.status || "").toLowerCase();
  const ss = String(o?.ship_status || "").toLowerCase();
  const ps = String(o?.pay_status || "").toLowerCase();
  const pm = String(o?.payment_method || "").toLowerCase();

  const shipped = (
    ss === "shipped" || st === "shipped" ||
    ss === "arrived" ||
    ss === "picked_up" || st === "picked_up" ||
    ss === "returned" || st === "returned"
  );
  if (shipped) return 2;

  // COD：視為已進入「付款狀態」這一段（貨到付款）
  if (pm.includes("cod")) return 1;

  const paidLike = (ps === "paid" || ps === "paid_ok" || ps === "deposit_ok" || st === "deposit_ok" || ss === "deposit_ok");
  if (paidLike) return 1;

  return 0; // 只在下單
}

  // ✅ 定金/尾款用：下單 -> 訂金/保留 -> 付清尾款 -> 出貨/服務開始（4 段）
function progressStage(o){
  const st = String(o?.status || "").toLowerCase();
  const ss = String(o?.ship_status || "").toLowerCase();
  const ps = String(o?.pay_status || "").toLowerCase();
  const pm = String(o?.payment_method || "").toLowerCase();

  // 3：已出貨/服務開始
  const shipped =
    ss === "shipped" || st === "shipped" ||
    ss === "arrived" ||
    ss === "picked_up" || st === "picked_up" ||
    ss === "returned" || st === "returned";
  if (shipped) return 3;

  // 2：付清尾款（paid / paid_ok 或剩餘尾款=0）
  if (ps === "paid" || ps === "paid_ok") return 2;
  try {
    if (getRemainingAmount(o) === 0 && (ps || st || ss)) return 2;
  } catch (e) {}

  // 1：已付訂金/保留中（deposit_hold / deposit_ok）
  if (ps === "deposit_ok" || st === "deposit_ok") return 1;
  if (st.includes("deposit_hold") || ps.includes("deposit_hold") || ss.includes("deposit_hold")) return 1;

  // 0：下單
  return 0;
}

  async function copyText(text){
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch (e) {
      // fallback
      try{
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        return true;
      } catch (e2) {}
    }
    return false;
  }

  // ✅ 方案 A：直接用 tail-checkout.html（前提：你已經有這頁且吃 parent_order_id）
  function buildTailCheckoutLiffUrl(parentOrderId){
    const endpoint = `https://murain.tw/tail-checkout.html?parent_order_id=${encodeURIComponent(parentOrderId)}&force=1`;
    return `https://liff.line.me/${LIFF_ID}?url=${encodeURIComponent(endpoint)}`;
  }

  function displayPaymentMethod(pm) {
    const k = String(pm || "").toLowerCase();
    const map = {
      cod_711: "7-11 貨到付款",
      cod_post: "宅配 / 貨到付款",
      meetup_cash: "面交付款",
      paid_af: "AFTEE先享後付",
      paid_linepay: "LINE Pay",
      paid_card_once: "信用卡一次付清",
      paid_card_inst_3: "信用卡分 3 期",
      paid_card_inst_6: "信用卡分 6 期",
      paid_card_inst_9: "信用卡分 9 期",
      zero_card_3: "零卡分 3 期",
      zero_card_6: "零卡分 6 期",
      zero_card_9: "零卡分 9 期",
      zero_card_12: "零卡分 12 期",
      zero_card_18: "零卡分 18 期",
      zero_card_24: "零卡分 24 期",
      yufu_inst_3: "裕富 3 期",
      yufu_inst_6: "裕富 6 期",
      yufu_inst_9: "裕富 9 期",
      yufu_inst_12: "裕富 12 期",
      yufu_inst_24: "裕富 24 期",
      yufu_inst_36: "裕富 36 期",
      paid_aftee_direct: "AF 先享後付",
      atm_full: "全額匯款",
      atm_deposit: "定金匯款",
      deposit_new_full_meetup: "匯款全額 - 面交",
      meetup_cash: "面交付現",
      deposit_old: "定金匯款",
      deposit_new_full: "全額匯款",
      deposit_new_full_711: "定金匯款",
      deposit_new_full_post: "定金匯款",
      deposit_new_partial_711: "定金匯款",
      deposit_new_partial_post: "定金匯款",
      deposit_old_partial: "定金匯款"
    };
    return map[k] || pm || "—";
  }

  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, (c) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;",
    }[c]));
  }

  function shippedLike(order){
  const st = String(order?.status || "").toLowerCase();
  const ss = String(order?.ship_status || "").toLowerCase();
  return (
    ss === "shipped" || st === "shipped" ||
    ss === "arrived" ||
    ss === "picked_up" || st === "picked_up" ||
    ss === "returned" || st === "returned"
  );
}

function tailPaidLike(tail){
  const ps = String(tail?.pay_status || "").toLowerCase();
  return (ps === "paid" || ps === "paid_ok");
}

// ✅ 取得「用來顯示給客人看的狀態來源」：有 tail 就優先 tail
function getDisplayOrder(o){
  const tail = o?.tail_order || null;
  if (!tail) return { src: o, tail: null };

  // 1) 尾款已出貨：整筆訂單就是已出貨（用 tail 當來源）
  if (shippedLike(tail)) return { src: tail, tail };

  // 2) 尾款已付款未出貨：顯示「尾款已付，待出貨」（仍用主單資料，但狀態要看 tail）
  if (tailPaidLike(tail)) return { src: o, tail, tail_paid: true };

  // 3) 有尾款單但未付款：顯示「待付尾款」
  return { src: o, tail, tail_unpaid: true };
}

  function isTailOrder(o){
  const t = String(o?.order_type || "").toLowerCase();
  const pid = String(o?.parent_order_id || "").trim();
  const oid = String(o?.order_id || "").trim().toUpperCase();
  return t === "tail" || !!pid || oid.startsWith("TL");
}

function normalizeOrdersWithTail(raw){
  const tails = {};
  const normals = [];

  for (const o of (raw || [])) {
    if (isTailOrder(o)) {
      const pid = String(o.parent_order_id || "").trim();
      if (pid) tails[pid] = o;
      continue;
    }
    normals.push(o);
  }

  // 掛回主單
  for (const n of normals) {
    const pid = String(n.order_id || "").trim();
    n.tail_order = tails[pid] || null;
  }

  return normals;
}

  function isDepositHoldOrder(o) {
  const st = String(o?.status || o?.order_status || o?.orderStatus || "").toLowerCase();
  const ps = String(o?.pay_status || "").toLowerCase();
  const ss = String(o?.ship_status || "").toLowerCase();
  const pm = String(o?.payment_method || "").toLowerCase();

  // ✅ 視為「定金保留」tab 的 payment_method 都集中在這裡
if (
  pm === "deposit_old" ||
  pm === "deposit_old_partial" ||
  pm.includes("deposit_old") ||

  // 你 map 裡有：atm_deposit = 定金匯款
  pm === "atm_deposit" ||

  // 你 map 裡有：deposit_new_partial_711 / deposit_new_partial_post
  pm === "deposit_new_partial_711" ||
  pm === "deposit_new_partial_post" ||
  pm.includes("deposit_new_partial")
) return true;

  // ✅ 原本的判斷：後端有些會用 deposit_hold / deposit_ok
  if (st.includes("deposit_hold") || ps.includes("deposit_hold") || ss.includes("deposit_hold")) return true;
  if (ps === "deposit_ok" || st === "deposit_ok" || ss === "deposit_ok") return true;

  // ✅ 兼容：如果後端塞在 ship / shipping_info
  const ship = o?.ship || {};
  const shipFlag = String(ship?.deposit_status || ship?.deposit || "").toLowerCase();
  if (shipFlag.includes("deposit_hold") || shipFlag.includes("deposit_ok")) return true;

  return false;
}

  function isBankDepositPM(pm) {
    //（保留：若你未來要用 payment_method 判斷匯款類型）
    const k = String(pm || "").toLowerCase();
    return (
      k.includes("deposit") ||
      k === "atm_deposit"
    );
  }

  function getMeetupTime(ship) {
    return String(ship?.meetup_time || ship?.meet_time || ship?.meetupTime || ship?.meetTime || ship?.meetup?.time || "").trim();
  }
  function getMeetupPlace(ship) {
    return String(ship?.meetup_place || ship?.meet_place || ship?.meetupPlace || ship?.meetPlace || ship?.meetup?.place || "").trim();
  }

  function isMeetupOrder(ship, paymentMethod) {
    const methodRaw = String(ship?.method || ship?.type || ship?.ship_type || "");
    const method = methodRaw.toLowerCase();
    const pm = String(paymentMethod || "").toLowerCase();
    const t = getMeetupTime(ship);
    const p = getMeetupPlace(ship);

    if (method.includes("面交") || method.includes("meetup") || pm.includes("meetup") || !!t || !!p) return true;

    const hasTarget = !!ship?.address || !!ship?.addr || !!ship?.store_id || !!ship?.store_name || !!ship?.store_address || method.length > 0;
    const hasContact = !!String(ship?.name || "").trim() || !!String(ship?.phone || "").trim();
    const looksOnlinePay = pm.startsWith("paid_") || pm.startsWith("zero_card_") || pm.startsWith("yufu_") || pm.includes("linepay") || pm === "atm_full";

    if (!hasTarget && hasContact && looksOnlinePay) return true;
    return false;
  }

  function isTailPaid(tail){
  const ps = String(tail?.pay_status || "").toLowerCase();
  const st = String(tail?.status || "").toLowerCase();
  return (ps === "paid" || ps === "paid_ok" || st === "paid" || st === "paid_ok");
}

 function shipBadgeText(o) {
  const d = getDisplayOrder(o);
  const src = d.src || o;       // ✅ 真正用來判斷狀態的來源（有 tail 就是 tail）
  const tail = d.tail || null;

  // ✅ 有尾款單且尾款已付但未出貨
  if (tail && tailPaidLike(tail) && !shippedLike(tail)) return "待出貨";

  // ✅ 有尾款單但尾款未付
  if (tail && !tailPaidLike(tail) && !shippedLike(tail)) return "待付款";

  const st = String(src?.status || "").toLowerCase();
  const ps = String(src?.pay_status || "").toLowerCase();
  const ss = String(src?.ship_status || "").toLowerCase();
  const pm = String(o?.payment_method || src?.payment_method || "").toLowerCase();

  // 1) 取消 / 付款失敗（最高優先）
  if (st.includes("cancel") || ps.includes("cancel") || ss.includes("cancel")) return "已取消";
  if (ps === "failed") return "付款失敗";

  // 2) 定金流程
  if (st.includes("deposit_hold") || ps.includes("deposit_hold") || ss.includes("deposit_hold")) return "核對中";
  if (ps === "deposit_ok") return "已付定金";

  // 3) 中租 / 裕富（分期）審核中：要放在 pending 前面
  const looksInstallment =
    pm.startsWith("zero_card_") || pm.startsWith("yufu_") ||
    pm.includes("zerocard") || pm.includes("yufu");

  const reviewingToken = (st + " " + ps).toLowerCase();
  const isReviewing =
    ps === "submitted" || ps === "reviewing" || ps === "auditing" ||
    reviewingToken.includes("review") || reviewingToken.includes("audit") ||
    reviewingToken.includes("check") || reviewingToken.includes("verify") ||
    reviewingToken.includes("approve");

  if (looksInstallment && isReviewing) return "審核中";

  // 4) 物流狀態
  if (ss === "shipped" || st === "shipped") return "已出貨";
  if (ss === "arrived") return "已送達";
  if (ss === "picked_up" || st === "picked_up") return "已取貨";
  if (ss === "returned" || st === "returned") return "已退回";

  // 5) 已付款
  if (ps === "paid_ok" || ps === "paid") return "待出貨中";

  // 6) 待付款 / COD 例外
  if (ps === "pending") {
    if (pm.includes("cod")) return "訂單確認中";
    return "核對中";
  }

  return "處理中";
}

  function shipBadgeClass(o) {
  const txt = shipBadgeText(o);

  if (txt === "已取消" || txt === "付款失敗" || txt === "已退回") return "st-unpaid";

  // 你把「已付款」改成「待出貨中」了，所以這裡要把「待出貨中」算進已付款那類
if (txt === "已出貨" || txt === "已送達" || txt === "已取貨" || txt === "待出貨中" || txt === "尾款已付完待出貨") return "st-paid";

  // 需要客人處理 / 等待中的狀態
  if (txt === "待付款" || txt === "核對中" || txt === "待匯定金" || txt === "待付尾款") return "st-waitpay";

  // 分期審核中、其他處理中
  if (txt === "審核中") return "st-pending";

  return "st-pending";
}

  function deliveryPlaceText(ship, receiver, paymentMethod) {
    const methodRaw = String(ship?.method || ship?.type || ship?.ship_type || "");
    const method = methodRaw.toLowerCase();
    const pm = String(paymentMethod || "").toLowerCase();

    if (method.includes("7-11") || method.includes("711") || method.includes("超商") || ship?.store_id || ship?.store_name) {
      const sname = ship.store_name || "";
      const sid = ship.store_id ? `（${ship.store_id}）` : "";
      const saddr = ship.store_address ? ` ${ship.store_address}` : "";
      const txt = `7-11 ${sname}${sid}${saddr}`.trim();
      return txt || "7-11 門市";
    }

    const isMeetup = isMeetupOrder(ship, paymentMethod);
    if (isMeetup) {
      const t = getMeetupTime(ship);
      const p = getMeetupPlace(ship);
      if (t && p) return `面交 ${t} @ ${p}`;
      if (t) return `面交 ${t}`;
      if (p) return `面交 @ ${p}`;
      return "面交";
    }

    if (receiver?.address) return String(receiver.address);
    if (ship?.address) return String(ship.address);
    if (ship?.addr) return String(ship.addr);
    if (methodRaw) return methodRaw;

    return "尚未填寫";
  }

  function receiverFullText(receiver, ship, paymentMethod) {
    const name = String(receiver?.name || ship?.name || "").trim();
    const phone = String(receiver?.phone || ship?.phone || "").trim();
    const head = [name, phone].filter(Boolean).join(" / ");
    const isMeetup = isMeetupOrder(ship, paymentMethod);

    if (isMeetup) {
      const t = getMeetupTime(ship);
      const p = getMeetupPlace(ship);
      const lines = [];
      if (head) lines.push(head);
      if (t) lines.push(`面交時間：${t}`);
      if (p) lines.push(`面交地點：${p}`);
      if (!t && !p) lines.push("面交");
      return lines.join("\n");
    }
    const place = deliveryPlaceText(ship || {}, receiver || {}, paymentMethod);
    return (head ? head + "\n" : "") + place;
  }

  function getOrderCreatedAt(o){
  const v =
    o?.created_at || o?.createdAt ||
    o?.created_time || o?.createdTime ||
    o?.created || o?.created_date || o?.createdDate ||
    o?.order_date || o?.orderDate;
  const d = v ? new Date(v) : null;
  return (d && !isNaN(d.getTime())) ? d : null;
}

  /* --- Tabs & Render Logic --- */
  function updateTabsUI() {
    document.querySelectorAll(".tab").forEach(btn => {
      if (btn.dataset.tab === currentFilter) btn.classList.add("active");
      else btn.classList.remove("active");
    });
  }
  function renderOrders() {
    orderList.style.display = "flex";
    creditsList.style.display = "none";
    emptyText.style.display = "none";
    orderList.innerHTML = "";

    let list = orders.slice();
    const now = new Date();

    if (currentFilter === "history") {
      // 15 天前
      const halfMonthAgo = new Date(now.getTime() - 15 * 24 * 60 * 60 * 1000);
      list = list.filter(o => {
        if (focusOrderId && o.order_id === focusOrderId) return true;
        const pm = String(o.payment_method || "").toLowerCase();
        // 排除「定金保留」(deposit_hold)
        if (isDepositHoldOrder(o)) return false;
        
        const createdAt = getOrderCreatedAt(o);
if (!createdAt) return true;
        return createdAt >= halfMonthAgo;
      });
    } else if (currentFilter === "deposit") {
      // 45 天前
      const oneAndHalfMonthAgo = new Date(now.getTime() - 45 * 24 * 60 * 60 * 1000);
      list = list.filter(o => {
        if (focusOrderId && o.order_id === focusOrderId) return true;
        const pm = String(o.payment_method || "").toLowerCase();
        // 必須是「定金保留」(deposit_hold)
        if (!isDepositHoldOrder(o)) return false;

        const createdAt = getOrderCreatedAt(o);
// ✅ 有些單如果後端沒回 created_at，不要整張被濾掉
if (!createdAt) return true;
return createdAt >= oneAndHalfMonthAgo;
      });
    }
    if (!list.length) {
      emptyText.style.display = "block";
      return;
    }

    for (const o of list) {
  try {
    const wrap = document.createElement("div");
    wrap.className = "order-card"; // 預設收合

    // 若指定單號，預設展開
    if (focusOrderId && o.order_id === focusOrderId) {
      wrap.classList.add("highlight");
      wrap.classList.add("expanded");
      if (!hasScrolledToInitialOrder) {
        hasScrolledToInitialOrder = true;
        setTimeout(() => {
          wrap.scrollIntoView({ behavior: "smooth", block: "center" });
        }, 150);
      }
    }

    // 點卡片收合（點到 button 不要觸發）
    wrap.onclick = function (e) {
      if (e.target && (e.target.tagName === "BUTTON" || e.target.tagName === "A")) return;
      this.classList.toggle("expanded");
    };

    const statusCls = shipBadgeClass(o);
    const payTxt = shipBadgeText(o);
    const d = getDisplayOrder(o);
const shipObj = (d.src && d.src.ship) ? d.src.ship : (o.ship || {});
const tail = (!isTailOrder(o) && String(o?.order_id || "").toUpperCase().startsWith("OD")) ? (d.tail || null) : null;
    const receiverObj = o.receiver || {};
    const total = Number(o.total_amount || 0);
    const itemsTextRaw = String(o.items_text || o.itemsText || o.items || "").trim();
    const pmTxt = displayPaymentMethod(o.payment_method);

    const receiverTxt = receiverFullText(receiverObj, shipObj, o.payment_method).replace(/\n/g, "<br>");
    const itemsHtml = itemsTextRaw
      ? `<div class="items-box">
           <div class="items-title">商品明細</div>
           <div class="items-text">${escapeHtml(itemsTextRaw).replace(/\n/g, "<br>")}</div>
         </div>`
      : "";

    // ✅ 安全抓貨單號（不用 getTrackingNo，避免你沒定義就爆）
    const trackingNo = String(
      shipObj.tracking_no ||
      shipObj.trackingNo ||
      o.tracking_no ||
      o.trackingNo ||
      ""
    ).trim();

    // ✅ History：按鈕只留一個（有貨單號→複製貨單號；沒有→複製單號）
    const copyLabel = (currentFilter === "history" && trackingNo) ? "複製貨單號" : "複製單號";
    const copyValue = (currentFilter === "history" && trackingNo) ? trackingNo : (o.order_id || "");

    wrap.innerHTML = `
      <div class="card-header">
        <div class="order-info-main">
          <div class="order-id">#${escapeHtml(o.order_id || "")}</div>
          <div class="order-date">${formatDate(getOrderCreatedAt(o) || o.created_at || o.createdTime || o.createdAt || "")}</div>
        </div>
        <div style="display:flex; align-items:center;">
          <div class="status-badge ${statusCls}">${escapeHtml(payTxt)}</div>
          <div class="toggle-icon"></div>
        </div>
      </div>

      <div class="card-body">
        <div class="info-group">
          <div class="info-row">
            <span class="info-label">收件資料</span>
            <span style="color:#fff; line-height:1.5;">${receiverTxt}</span>
          </div>
          <div class="info-row">
            <span class="info-label">付款方式</span>
            <span style="color:#ddd;">${escapeHtml(pmTxt)}</span>
          </div>
          ${itemsHtml}
        </div>

        <div class="amount-breakdown">
          <div class="amount-line">
            <span class="k">訂單金額</span>
            <span class="v">NT$ ${total.toLocaleString("zh-TW")}</span>
          </div>

          ${
  (currentFilter === "deposit" && isDepositHoldOrder(o))
    ? `
      <div class="amount-line">
        <span class="k">保留到期日</span>
        <span class="v">${formatDate(getDepositExpireAt(o)) || "—"}</span>
      </div>
    `
    : ``
}

          ${
  (tail && tail.order_id && currentFilter !== "history")
    ? `
      <div class="amount-line">
        <span class="k">尾款單號</span>
        <span class="v" style="font-family: monospace;">${escapeHtml(tail.order_id)}</span>
      </div>
    `
    : ``
}
${
  (tail && currentFilter !== "history")
    ? `
      <div class="amount-line">
        <span class="k">尾款狀態</span>
        <span class="v">
          ${isPaidOk(tail.pay_status) ? '尾款已付' : '尾款待付款'}
        </span>
      </div>
    `
    : ``
}

          <div class="amount-line">
            <span class="k">${(String(o.payment_method||"").toLowerCase().includes("deposit") || isDepositHoldOrder(o)) ? "已付定金" : "已付款"}</span>
            <span class="v">
              ${money(getPaidAmount(o))}
              ${
                (String(o.payment_method||"").toLowerCase().includes("deposit") || isDepositHoldOrder(o))
                  ? (isDepositConfirmed(o) ? `<span class="tag tag-ok">已確認</span>` : (isDepositChecking(o) ? `<span class="tag tag-pending">核對中</span>` : ``))
                  : ((String(o?.pay_status||"").toLowerCase()==="paid" || String(o?.pay_status||"").toLowerCase()==="paid_ok") ? `<span class="tag tag-ok">完成</span>` : ``)
              }
            </span>
          </div>

          ${
            (currentFilter === "history")
              ? ``
              : `
                <div class="amount-line">
                  <span class="k">剩餘尾款</span>
                  <span class="v">${money(getRemainingAmount(o))}</span>
                </div>
              `
          }
        </div>

        <div class="progress">
          ${
            (currentFilter === "history")
              ? `
                <div class="amount-line">
                  <span class="k">出貨狀態</span>
                  <span class="v">${escapeHtml(shipBadgeText(o))}</span>
                </div>
                <div class="amount-line" style="border-bottom:none;">
                  <span class="k">貨單號</span>
                  <span class="v" style="font-family: monospace;">
                    ${trackingNo ? escapeHtml(trackingNo) : "—"}
                  </span>
                </div>
              `
              : `
                <div class="p-steps">
                  <div class="p-step ${progressStage(o) >= 0 ? "done" : ""} ${progressStage(o)===0 ? "current" : ""}">
                    <div class="dot"></div><div class="lbl">下單</div>
                  </div>
                  <div class="p-step ${progressStage(o) >= 1 ? "done" : ""} ${progressStage(o)===1 ? "current" : ""}">
                    <div class="dot"></div><div class="lbl">已付定金/保留中</div>
                  </div>
                  <div class="p-step ${progressStage(o) >= 2 ? "done" : ""} ${progressStage(o)===2 ? "current" : ""}">
                    <div class="dot"></div><div class="lbl">付清尾款</div>
                  </div>
                  <div class="p-step ${progressStage(o) >= 3 ? "done" : ""} ${progressStage(o)===3 ? "current" : ""}">
                    <div class="dot"></div><div class="lbl">出貨/服務開始</div>
                  </div>
                </div>
              `
          }

          <div class="microcopy">
            若訂單有任何問題請複製單號告知小編唷。
          </div>

          <div class="action-row">
            <button class="btn-mini btn-gold js-copy-primary" data-copy="${escapeHtml(copyValue)}">${copyLabel}</button>
          </div>
        </div>
      </div>
    `;

    const btn = wrap.querySelector(".js-copy-primary");
    if (btn) {
      btn.addEventListener("click", async (e) => {
        e.preventDefault();
        e.stopPropagation();
        const v = btn.getAttribute("data-copy") || "";
        const ok = await copyText(v);
        alert(ok ? "已複製：" + v : "複製失敗，請手動選取");
      });
    }

    orderList.appendChild(wrap);
  } catch (err) {
    console.error("[renderOrders] card error", o, err);
    infoMsg.textContent = "載入失敗（render error）： " + (err?.message || String(err));
    infoMsg.classList.add("error");
    infoMsg.style.display = "block";
  }
}
}  // ✅✅ 補這個：結束 renderOrders()
  function renderCredits() {
    orderList.style.display = "none";
    creditsList.style.display = "flex";
    emptyText.style.display = "none";
    creditsList.innerHTML = "";

    if (!credits.length) {
      emptyText.style.display = "block";
      return;
    }
    credits.forEach(item => {
      const el = document.createElement("div");
      el.className = "credit-item";
      const amt = Number(item.amount || 0);
      const isPositive = amt >= 0;
      const amtClass = isPositive ? "pos" : "neg";
      const sign = isPositive ? "+" : "";
      const title =
  item.DisplayName || item.display_name || item.displayName ||
  item.Reason || item.reason ||
  item.Type || item.type ||
  "購物金異動";
      const bal = (item.balance !== undefined && item.balance !== null) ? Number(item.balance) : null;

      el.innerHTML = `
        <div class="c-info">
          <div class="c-reason">${escapeHtml(title)}</div>
          <div class="c-date">${formatDate(item.created_at)}</div>
        </div>
        <div>
          <div class="c-amount ${amtClass}">${sign}NT$ ${Math.abs(amt).toLocaleString("zh-TW")}</div>
          ${bal !== null ? `<div class="c-balance">餘額: NT$ ${bal.toLocaleString("zh-TW")}</div>` : ''}
        </div>
      `;
      creditsList.appendChild(el);
    });
  }

  /* --- API Calls --- */
    // ===== Credits：載入購物金明細 =====
async function loadCredits() {
  if (!currentUserId) return;

  try {
    const url = CREDITS_API + "?line_user_id=" + encodeURIComponent(currentUserId);
    const res = await fetch(url);

    // 用 text 先吃，避免 JSON 失敗整個進 catch
    const text = await res.text();
    let json = null;
    try { json = JSON.parse(text); } catch (e) {}

    if (res.ok && json && json.ok) {
      // 你的後端可能回 credits / items / ledger，這裡做容錯
      credits = json.credits || json.items || json.ledger || [];

      // 可選：時間新到舊
      credits.sort((a,b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));

      // 若後端有回餘額（可有可無）
      const balRaw = (json.balance ?? json.credit ?? json.credit_balance ?? null);
      const bal = (balRaw === null) ? null : Number(balRaw);
      if (bal !== null && !Number.isNaN(bal)) {
        creditValue.textContent = "NT$ " + bal.toLocaleString("zh-TW");
      }

      if (currentFilter === "credits") renderCredits();
      return;
    }

    console.error("[loadCredits] API not ok", res.status, json || text.slice(0, 200));
    if (currentFilter === "credits") {
      emptyText.style.display = "block";
    }
  } catch (e) {
    console.error("[loadCredits] fetch fail", e);
    if (currentFilter === "credits") {
      emptyText.style.display = "block";
    }
  }
}
  async function loadMemberInfo() {
    if (!currentUserId) return;
    try {
      const res = await fetch(MEMBER_INFO_API + "?user_id=" + encodeURIComponent(currentUserId));
      const json = await res.json();
      if (res.ok && json.ok) {
        memberInfo = json;
        const c = Number(memberInfo.credit || 0);
        creditValue.textContent = "NT$ " + c.toLocaleString("zh-TW");
      }
    } catch (e) { console.error(e); }
  }

  async function loadOrders() {
  if (!currentUserId) {
    console.log("[loadOrders] no currentUserId");
    return;
  }

  if (currentFilter !== "credits") {
    infoMsg.textContent = "更新資料中...";
    infoMsg.classList.remove("error");
    infoMsg.style.display = "block";
  }

  console.log("[loadOrders] start", { currentFilter, currentUserId, MEMBER_API });

  try {
    const url = MEMBER_API + "?line_user_id=" + encodeURIComponent(currentUserId);
    const res = await fetch(url);
    console.log("[loadOrders] res", res.status, res.ok);

    let json = null;
    try {
      json = await res.json();
    } catch (e) {
      console.error("[loadOrders] json parse fail", e);
    }

    console.log("[loadOrders] json.ok", json?.ok, "orders.len", (json?.orders || []).length);
    console.log("[loadOrders] sample", (json?.orders || []).slice(0, 2));

    if (res.ok && json && json.ok) {
      const raw = json.orders || [];
orders = normalizeOrdersWithTail(raw); // ✅ 列表只剩主單，每張主單有 o.tail_order

      const deps = orders.filter(isDepositHoldOrder);
      console.log("[deposit_hold_count]", deps.length, deps.slice(0, 3).map(x => ({
        order_id: x.order_id,
        payment_method: x.payment_method,
        created_at: x.created_at,
        createdTime: x.createdTime,
        createdAt: x.createdAt
      })));

      if (currentFilter !== "credits") renderOrders();

      // ✅ 只有成功才清掉 loading
      if (currentFilter !== "credits") {
        infoMsg.textContent = "";
        infoMsg.style.display = "none";
      }
      return;
    }

    // ❌ API 回來不是 ok
    infoMsg.textContent = "載入失敗（API 回傳非 ok）";
    infoMsg.classList.add("error");
    infoMsg.style.display = "block";
  } catch (e) {
    console.error("[loadOrders] fetch fail", e);
    infoMsg.textContent = "載入失敗（fetch error）";
    infoMsg.classList.add("error");
    infoMsg.style.display = "block";
  }
}

  async function initLiff() {
    if (!window.liff) return;
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) {
        liff.login(); return;
      }
      const profile = await liff.getProfile();
      currentUserId = profile.userId;
      userName.textContent = profile.displayName;
      if(profile.pictureUrl){
        defaultAvatar.style.display = "none";
        userAvatarImg.style.display = "block";
        userAvatarImg.src = profile.pictureUrl;
      }
      statusText.textContent = "歡迎回來";
      loadMemberInfo();
      loadOrders();
      loadCredits();
    } catch (e) {
      infoMsg.textContent = "請從 LINE 官方帳號開啟";
      infoMsg.style.display = "block";
    }
  }

  /* --- Init --- */
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".tab").forEach(btn => {
      btn.addEventListener("click", () => {
        currentFilter = btn.dataset.tab || "history";
        updateTabsUI();
        if (currentFilter === "credits") {
          if(credits.length === 0) loadCredits();
          else renderCredits();
        } else {
          renderOrders();
        }
      });
    });
    updateTabsUI();
    initLiff();
  });
</script>

</body>
</html>
