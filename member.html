<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>XUYUAN | æœƒå“¡ä¸­å¿ƒ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            gold: '#D4AF37',
            goldDark: '#AA8C2C',
            goldLight: '#F9E5B3',
            dark: '#080808',
            card: '#121212',
          },
          fontFamily: {
            serif: ['"Playfair Display"', 'serif'],
            sans: ['"Noto Sans TC"', 'sans-serif'],
          },
          animation: {
            'fade-in': 'fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) both',
            'shimmer': 'shimmer 3s linear infinite',
          },
          keyframes: {
            fadeIn: { from: { opacity: 0, transform: 'translateY(10px)' }, to: { opacity: 1, transform: 'translateY(0)' } },
            shimmer: { from: { backgroundPosition: '200% 0' }, to: { backgroundPosition: '-200% 0' } }
          }
        }
      }
    }
  </script>

  <style>
    body {
      margin: 0;
      background-color: #050505;
      color: #e5e5e5;
      font-family: "Noto Sans TC", sans-serif;
      /* æ¥µç°¡èƒŒæ™¯ç´‹ç† */
      background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #050505 60%);
      background-attachment: fixed;
    }

    /* é‡‘å±¬æ–‡å­— */
    .text-gold-gradient {
      background: linear-gradient(135deg, #F9E5B3 0%, #D4AF37 50%, #AA8C2C 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* é»‘é‡‘å¡ç‰‡è³ªæ„Ÿ */
    .card-premium {
      background: linear-gradient(145deg, #1a1a1a, #0a0a0a);
      border: 1px solid rgba(212, 175, 55, 0.2);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    /* æ¨™ç±¤åˆ‡æ› */
    .tab-item {
      position: relative;
      color: #666;
      transition: all 0.3s;
    }
    .tab-item.active {
      color: #D4AF37;
      font-weight: 500;
    }
    .tab-item.active::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: #D4AF37;
      box-shadow: 0 0 8px #D4AF37;
    }
  </style>
</head>
<body>

  <div class="page max-w-lg mx-auto p-5 pb-20 min-h-screen flex flex-col">
    
    <!-- 1. Header -->
    <div class="flex justify-between items-center mb-8 fade-in">
      <div>
        <div class="font-serif text-gold text-lg tracking-[0.2em] font-bold">XUYUAN</div>
        <div class="text-[10px] text-white/30 uppercase tracking-[0.2em]">Member Center</div>
      </div>
      <button id="reloadBtn" class="text-white/40 hover:text-gold transition text-xl p-2">
        â†»
      </button>
    </div>

    <!-- 2. æ•¸ä½æœƒå“¡å¡ (Digital Card) -->
    <div class="card-premium relative rounded-xl p-6 mb-10 overflow-hidden group fade-in" style="animation-delay: 0.1s;">
      
      <!-- å…‰æ¾¤æµå‹•æ•ˆæœ -->
      <div class="absolute top-0 left-0 w-[200%] h-full bg-gradient-to-r from-transparent via-white/5 to-transparent pointer-events-none animate-shimmer" />

      <div class="relative z-10 flex items-center gap-4 mb-8">
        <div class="w-14 h-14 rounded-full border border-gold/30 bg-black flex items-center justify-center text-2xl overflow-hidden shadow-lg">
          <div id="userAvatarText" class="text-gold">ğŸ‘¤</div>
          <img id="userAvatarImg" class="w-full h-full object-cover hidden" />
        </div>
        <div>
          <div class="text-[10px] text-gold uppercase tracking-[0.2em] mb-1">Welcome</div>
          <div class="text-xl font-serif text-white tracking-wide" id="userName">å°Šæ¦®è²´è³“</div>
        </div>
      </div>

      <div class="relative z-10 border-t border-white/10 pt-4 flex justify-between items-end">
        <div>
          <div class="text-[10px] text-white/40 uppercase tracking-[0.1em] mb-1">Available Credits</div>
          <div class="text-xs text-gold/80">å¯ç”¨è³¼ç‰©é‡‘</div>
        </div>
        <div class="font-serif text-3xl text-gold-gradient" id="creditValue">NT$ --</div>
      </div>
    </div>

    <!-- 3. é¸å–® Tabs -->
    <div class="flex justify-between mb-8 border-b border-white/5 pb-3 px-2 fade-in" style="animation-delay: 0.2s;">
      <button class="tab-item active text-xs tracking-widest" data-tab="all">å…¨éƒ¨è¨‚å–®</button>
      <button class="tab-item text-xs tracking-widest" data-tab="live">ç›´æ’­è¨‚å–®</button>
      <button class="tab-item text-xs tracking-widest" data-tab="web">å®˜ç¶²è¨‚å–®</button>
      <button class="tab-item text-xs tracking-widest" data-tab="credits">é»æ•¸ç´€éŒ„</button>
    </div>

    <div id="infoMsg" class="text-center text-xs text-white/30 py-4 hidden">è¼‰å…¥è³‡æ–™ä¸­...</div>

    <!-- 4. å…§å®¹åˆ—è¡¨ -->
    <div id="orderList" class="flex flex-col gap-4 fade-in" style="animation-delay: 0.3s;"></div>
    <div id="creditsList" class="flex flex-col gap-4 hidden fade-in" style="animation-delay: 0.3s;"></div>
    
    <!-- ç©ºç‹€æ…‹ -->
    <div id="emptyText" class="hidden text-center py-20">
      <div class="text-2xl text-white/10 mb-2">âœ¦</div>
      <div class="text-xs text-white/30 tracking-widest uppercase">å°šç„¡ç´€éŒ„</div>
    </div>

  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<script>
  const API_BASE    = "https://api.murain.tw";
  const MEMBER_API  = API_BASE + "/member/orders";
  const CREDITS_API = API_BASE + "/member/credits";
  const MEMBER_INFO_API = API_BASE + "/line/member-info";
  const LIFF_ID     = "2008430261-EGZPg3Qp";

  let currentUserId = null;
  let orders = [];
  let memberInfo = null;
  let credits = [];
  let currentFilter = "all";

  // Elements
  const userName    = document.getElementById("userName");
  const userAvatarText = document.getElementById("userAvatarText");
  const userAvatarImg = document.getElementById("userAvatarImg");
  const infoMsg     = document.getElementById("infoMsg");
  const orderList   = document.getElementById("orderList");
  const creditsList = document.getElementById("creditsList");
  const emptyText   = document.getElementById("emptyText");
  const creditValue = document.getElementById("creditValue");

  document.getElementById("reloadBtn").onclick = () => {
    if (currentUserId) {
      infoMsg.textContent = "æ›´æ–°ä¸­...";
      infoMsg.style.display = "block";
      loadMemberInfo();
      loadOrders();
    } else {
      initLiff();
    }
  };

  /* --- é¡¯ç¤ºé‚è¼¯ --- */
  function formatDate(s) {
    if (!s) return "";
    const d = new Date(s);
    // æ ¼å¼ï¼š2023.10.25
    return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
  }

  function displayStatus(st) {
    const map = { 'submitted':'å·²é€å‡º', 'paid':'å·²ä»˜æ¬¾', 'shipped':'å·²å‡ºè²¨', 'cancelled':'å·²å–æ¶ˆ' };
    return map[st] || st || "è™•ç†ä¸­";
  }

  function renderOrders() {
    orderList.style.display   = "flex";
    creditsList.style.display = "none";
    emptyText.style.display   = "none";
    orderList.innerHTML       = "";

    let list = orders.slice();
    if (currentFilter === "live") list = list.filter(o => !!o.streamer_name);
    else if (currentFilter === "web") list = list.filter(o => !o.streamer_name);

    if (!list.length) {
      emptyText.style.display = "block";
      return;
    }

    list.forEach(o => {
      const div = document.createElement("div");
      // æ¥µç°¡ç·šæ¢å¡ç‰‡
      div.className = "group relative border-b border-white/5 pb-4 last:border-0";
      
      const shipMethod = o.ship && o.ship.method ? o.ship.method : "é…é€ä¸­";
      const isPaid = (o.pay_status === 'paid_ok' || o.pay_status === 'deposit_ok');
      
      div.innerHTML = `
        <div class="flex justify-between items-start mb-2">
          <div class="flex flex-col">
            <span class="font-serif text-gold text-sm tracking-wider">#${o.order_id}</span>
            <span class="text-[10px] text-white/40 mt-1">${formatDate(o.created_at)}</span>
          </div>
          <div class="text-right">
            <div class="text-[10px] uppercase tracking-widest ${isPaid ? 'text-emerald-400' : 'text-white/40'} border ${isPaid ? 'border-emerald-400/30' : 'border-white/10'} px-2 py-0.5 rounded-full mb-1">
              ${displayStatus(o.status)}
            </div>
          </div>
        </div>
        
        <div class="flex justify-between items-end">
          <div class="text-xs text-white/60 font-light">
            ${shipMethod}
          </div>
          <div class="font-serif text-lg text-white">
            <span class="text-xs text-white/30 mr-1 align-top">NT$</span>${(o.total_amount||0).toLocaleString()}
          </div>
        </div>
      `;
      orderList.appendChild(div);
    });
  }

  function renderCredits() {
    orderList.style.display   = "none";
    creditsList.style.display = "flex";
    emptyText.style.display   = "none";
    creditsList.innerHTML     = "";

    if (!credits.length) {
      emptyText.style.display = "block";
      return;
    }

    credits.forEach(c => {
      const div = document.createElement("div");
      div.className = "flex justify-between items-center py-4 border-b border-white/5 last:border-0";
      
      const amt = Number(c.amount||0);
      const sign = amt > 0 ? '+' : '';
      const colorClass = amt > 0 ? 'text-white' : 'text-white/40';
      
      div.innerHTML = `
        <div>
          <div class="text-sm text-white/90 mb-1">${c.reason || (c.type==='use'?'æŠ˜æŠµæ¶ˆè²»':'ç²å¾—é»æ•¸')}</div>
          <div class="text-[10px] text-white/40 font-mono">${formatDate(c.created_at)}</div>
        </div>
        <div class="font-serif text-lg ${colorClass}">
          ${sign}${amt.toLocaleString()}
        </div>
      `;
      creditsList.appendChild(div);
    });
  }

  /* --- API Functions --- */
  async function loadMemberInfo() {
    if (!currentUserId) return;
    try {
      const res = await fetch(MEMBER_INFO_API + "?user_id=" + encodeURIComponent(currentUserId));
      const json = await res.json();
      if (res.ok && json.ok) {
        memberInfo = json;
        const c = memberInfo.credit || 0;
        creditValue.textContent = "NT$ " + c.toLocaleString();
      }
    } catch(e){}
  }

  async function loadCredits() {
    if(!currentUserId) return;
    try {
      const res = await fetch(CREDITS_API + "?line_user_id=" + encodeURIComponent(currentUserId));
      const json = await res.json();
      if(res.ok && json.ok) {
        credits = json.items || [];
        if(currentFilter === 'credits') renderCredits();
      }
    } catch(e){}
  }

  async function loadOrders() {
    if(!currentUserId) return;
    infoMsg.style.display = "block";
    try {
      const res = await fetch(MEMBER_API + "?line_user_id=" + encodeURIComponent(currentUserId));
      const json = await res.json();
      if(res.ok && json.ok) {
        orders = json.orders || [];
        if(currentFilter !== 'credits') renderOrders();
      }
    } catch(e){}
    infoMsg.style.display = "none";
  }

  async function initLiff() {
    if (!window.liff) return;
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) {
        liff.login(); return;
      }
      const profile = await liff.getProfile();
      currentUserId = profile.userId;
      userName.textContent = profile.displayName;
      
      // è¨­å®šé ­åƒ
      if(profile.pictureUrl){
        userAvatarText.classList.add('hidden');
        userAvatarImg.classList.remove('hidden');
        userAvatarImg.src = profile.pictureUrl;
      }
      
      // Load Data
      loadMemberInfo();
      loadOrders();
    } catch (e) {
      infoMsg.textContent = "è«‹å¾ LINE å®˜æ–¹å¸³è™Ÿé–‹å•Ÿ";
      infoMsg.style.display = "block";
    }
  }

  /* --- Tabs --- */
  document.querySelectorAll(".tab-item").forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll(".tab-item").forEach(t => t.classList.remove("active"));
      btn.classList.add("active");
      
      currentFilter = btn.dataset.tab;
      if (currentFilter === "credits") {
        renderCredits();
        loadCredits();
      } else {
        renderOrders();
      }
    };
  });

  // Init
  initLiff();
</script>
</body>
</html>
