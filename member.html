<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>XUYUAN | 會員中心</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  
  <!-- 引入高級字體 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    /* --- 核心變數 & 高級感調色盤 --- */
    :root {
      /* 背景色：更深邃的黑色，帶有一點點冷色調 */
      --bg-color: #050505; 
      
      /* 卡片背景：使用半透明黑，配合毛玻璃特效 */
      --card-bg: rgba(20, 20, 20, 0.65);
      
      /* 邊框：極細微的白光，模擬光照 */
      --border-color: rgba(255, 255, 255, 0.08);
      --border-highlight: rgba(255, 255, 255, 0.15);

      /* 字體顏色 */
      --text-main: #fcfcfc;
      --text-sub: #a0a0a0;
      --text-muted: #666666;

      /* 高級金屬金 (漸層定義) */
      --gold-primary: #cfc09f; 
      --gold-gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
      --gold-text-gradient: linear-gradient(to bottom, #cfc09f, #ffecb3);
      
      /* 狀態色：降低飽和度，更有質感 */
      --success: #5eb37e;
      --success-bg: rgba(94, 179, 126, 0.1);
      --danger: #d45d5d;
      --danger-bg: rgba(212, 93, 93, 0.1);
      
      /* 字體 */
      --font-serif: 'Playfair Display', 'Noto Sans TC', serif;
      --font-sans: 'Lato', 'Noto Sans TC', sans-serif;
    }

    /* 全局設定 */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      /* 背景材質：極致深黑加上微弱的噪點或光暈 */
      background-image: 
        radial-gradient(circle at 50% -10%, rgba(50, 50, 50, 0.4) 0%, transparent 60%),
        linear-gradient(to bottom, #050505 0%, #000000 100%);
      background-attachment: fixed;
    }

    /* 頁面容器 */
    .page {
      max-width: 600px;
      margin: 0 auto;
      padding: 30px 20px 80px; /* 增加呼吸感 */
      animation: fadeIn 0.8s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* --- 頂部 Header --- */
    .header-area {
      text-align: center;
      margin-bottom: 32px;
      position: relative;
      padding-top: 10px;
    }
    
    .brand-title {
      font-family: var(--font-serif);
      font-size: 28px; /* 加大 */
      letter-spacing: 0.15em; /* 調整字距適配中文/英文 */
      /* 文字金屬光澤 */
      background: var(--gold-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
      font-weight: 700;
      text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    
    .page-title {
      font-size: 13px;
      letter-spacing: 0.2em;
      color: var(--text-muted);
      text-transform: uppercase;
      font-weight: 400;
      padding-left: 0.2em; /* 視覺修正置中 */
    }

    /* 重新整理按鈕 & 取消定位按鈕 */
    .refresh-btn, .clear-focus-btn {
      position: absolute;
      top: 0;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-color);
      color: var(--text-sub);
      width: 36px; height: 36px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      backdrop-filter: blur(4px);
    }
    .refresh-btn { right: 0; }
    .clear-focus-btn { right: 48px; } /* 調整間距 */

    .refresh-btn:hover, .clear-focus-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--text-sub);
      color: #fff;
    }
    .refresh-btn:active, .clear-focus-btn:active {
      transform: scale(0.95);
    }

    /* --- 數位會員卡 (Premium Card) --- */
    .member-card {
      background: rgba(20, 20, 20, 0.4);
      /* 毛玻璃特效 */
      backdrop-filter: blur(15px); 
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 20px;
      padding: 28px;
      margin-bottom: 32px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0,0,0,0.6);
    }
    
    /* 卡片光影流動特效 */
    .member-card::after {
      content: '';
      position: absolute;
      top: 0; left: -100%;
      width: 50%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
      transform: skewX(-25deg);
      animation: shine 6s infinite;
      pointer-events: none;
    }
    
    @keyframes shine {
      0% { left: -100%; }
      20% { left: 200%; }
      100% { left: 200%; }
    }
    
    .member-card::before {
      content: ''; position: absolute;
      top: -50%; right: -20%;
      width: 250px; height: 250px;
      background: radial-gradient(circle, rgba(191, 149, 63, 0.15), transparent 70%);
      filter: blur(40px);
      z-index: 0;
    }

    .user-info {
      display: flex; align-items: center; gap: 18px;
      margin-bottom: 30px;
      position: relative; z-index: 2;
    }
    
    .user-avatar {
      width: 56px; height: 56px;
      background: #0f0f0f; 
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: #cfc09f; 
      font-size: 22px;
      /* 雙層邊框質感 */
      box-shadow: 0 0 0 1px rgba(191, 149, 63, 0.3), 0 0 0 4px rgba(0,0,0,0.5);
      overflow: hidden;
    }
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; }

    .user-name { 
      font-family: var(--font-serif);
      font-size: 20px; 
      font-weight: 500; 
      color: #fff; 
      letter-spacing: 0.05em; 
    }
    .user-status { 
      font-family: var(--font-sans);
      font-size: 12px; 
      color: var(--gold-primary); 
      margin-top: 4px; 
      letter-spacing: 0.1em;
      opacity: 0.8;
    }

    .credit-row {
      display: flex; justify-content: space-between; align-items: flex-end;
      position: relative; z-index: 2;
      border-top: 1px solid rgba(255,255,255,0.08);
      padding-top: 20px;
    }
    
    .credit-label { 
      font-size: 13px; 
      color: var(--text-sub); 
      letter-spacing: 0.05em; 
      margin-bottom: 6px; 
    }

    /* --- [修改] 金額顯示優化：更清晰易讀 --- */
    .credit-amount {
      font-family: var(--font-sans); /* 改用無襯線體，數字更清楚 */
      font-size: 24px; /* 稍微加大 */
      /* 金屬漸層字保留 */
      background: var(--gold-text-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700; /* 加粗 */
      line-height: 1;
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.05em; /* 增加字距 */
      text-shadow: 0 4px 10px rgba(0,0,0,0.3); /* 增加陰影對比 */
    }
    
    /* --- 頁籤 Tabs (Segmented Control 風格) --- */
    .tabs {
      display: flex;
      background: #111;
      padding: 4px;
      border-radius: 99em; /* 膠囊狀 */
      margin-bottom: 28px;
      border: 1px solid var(--border-color);
      position: relative;
    }
    
    .tab {
      flex: 1;
      padding: 10px 0;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 13px;
      border-radius: 99em;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      font-family: var(--font-sans);
      font-weight: 500;
      letter-spacing: 0.05em;
      position: relative;
      z-index: 2;
    }
    
    .tab.active {
      background: #252525;
      color: #fff;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }

    /* --- 訊息提示 --- */
    .msg { 
      font-size: 12px; 
      color: var(--text-sub); 
      text-align: center; 
      margin: 20px 0; 
      letter-spacing: 0.05em;
    }
    .msg.error { color: var(--danger); }
    
    .empty-state {
      padding: 60px 0; 
      text-align: center; 
      color: var(--text-muted); 
      font-size: 13px;
      border: 1px dashed var(--border-color); 
      border-radius: 16px;
      background: rgba(255,255,255,0.01);
      letter-spacing: 0.05em;
    }

    /* --- 訂單卡片 (Order Card) --- */
    .order-list { display: flex; flex-direction: column; gap: 20px; }
    
    .order-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px; /* 增加內距 */
      border: 1px solid var(--border-color);
      position: relative;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      /* 卡片淡入 */
      animation: fadeIn 0.5s ease-out;
    }

    .items-box{
  margin-top: 10px;
  padding: 12px 12px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.08);
  background: rgba(255,255,255,0.02);
}
.items-title{
  font-size: 11px;
  color: var(--text-muted);
  letter-spacing: 0.05em;
  margin-bottom: 6px;
}
.items-text{
  font-size: 12px;
  color: #fff;
  line-height: 1.6;
}
    
    .order-card:active {
      transform: scale(0.98);
    }
    
    .order-card.highlight {
      border-color: rgba(191, 149, 63, 0.4);
      box-shadow: 0 0 20px rgba(191, 149, 63, 0.1);
    }

    .card-header {
      display: flex; justify-content: space-between; align-items: flex-start;
      margin-bottom: 16px; 
      border-bottom: 1px solid rgba(255,255,255,0.06);
      padding-bottom: 16px;
    }
    
    .order-id { 
      font-family: 'Lato', monospace; 
      font-size: 14px; 
      color: #fff; 
      letter-spacing: 0.08em; 
      font-weight: 600;
    }
    .order-date { 
      font-size: 11px; 
      color: var(--text-muted); 
      margin-top: 6px; 
      font-family: var(--font-sans);
    }
    
    .status-badge {
      font-size: 11px; 
      padding: 5px 12px; 
      border-radius: 4px; /* 改為微圓角矩形，更俐落 */
      font-weight: 500; 
      letter-spacing: 0.05em;
      backdrop-filter: blur(4px);
    }
    /* 狀態顏色優化 */
    .st-paid { 
      background: var(--success-bg); 
      color: var(--success); 
      border: 1px solid rgba(94, 179, 126, 0.2); 
    }
    .st-unpaid { 
      background: var(--danger-bg); 
      color: var(--danger); 
      border: 1px solid rgba(212, 93, 93, 0.2); 
    }
    .st-pending {
      /* 高級橘：偏琥珀/金橘，黑底上很有質感 */
      background: linear-gradient(
        135deg,
        rgba(255, 168, 76, 0.18),
        rgba(210, 122, 44, 0.10)
      );
      color: #ffd9ad; /* 柔和金橘字 */
      border: 1px solid rgba(255, 168, 76, 0.25);
      box-shadow: 0 0 18px rgba(255, 168, 76, 0.08);
    }
    /* ✅ 待付款 / 待確認：高級藍紫 */
    .st-waitpay {
      background: linear-gradient(
        135deg,
        rgba(124, 92, 255, 0.16),
        rgba(64, 129, 255, 0.10)
      );
      color: #d9d3ff;
      border: 1px solid rgba(124, 92, 255, 0.25);
      box-shadow: 0 0 18px rgba(124, 92, 255, 0.08);
    }

    .card-body { 
      display: flex; 
      justify-content: space-between; 
      align-items: flex-end; 
    }
    
    
    /* --- 訂單明細下拉（預設只顯示：單號 / 日期 / 貨況） --- */
    .order-details{
      margin-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.06);
      padding-top: 12px;
    }
    .order-summary{
      list-style: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-sub);
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      background: rgba(255,255,255,0.02);
      letter-spacing: 0.05em;
    }
    .order-summary::-webkit-details-marker{ display:none; }
    .order-summary::marker{ content:""; }
    .order-summary:after{
      content: "▾";
      opacity: 0.8;
    }
    .order-details[open] .order-summary:after{
      content: "▴";
    }
    .details-body{ margin-top: 12px; }
.info-group { 
      display: flex; flex-direction: column; gap: 8px; 
      font-size: 13px; color: var(--text-sub); 
    }
    
    /* --- [修改] 標籤樣式：精緻化 --- */
    .info-label { 
      font-size: 11px; 
      color: var(--gold-primary); /* 改為金色文字 */
      font-family: var(--font-serif); /* 使用襯線體增添氣質 */
      margin-right: 8px; 
      border: 1px solid rgba(191, 149, 63, 0.25); /* 改為細緻金框 */
      background: rgba(191, 149, 63, 0.05); /* 極淡的金色背景 */
      padding: 3px 8px; /* 調整內距 */
      border-radius: 2px; /* 方正微圓角 */
      display: inline-block;
      min-width: 60px; /* 稍微加寬 */
      text-align: center;
      letter-spacing: 0.05em;
    }
    
    .amount-display { text-align: right; }
    
    .amount-label { 
      font-size: 11px; 
      color: var(--text-muted); 
      margin-bottom: 4px; 
      letter-spacing: 0.05em; 
    }

    /* --- [修改] 訂單金額顯示：更清晰易讀 --- */
    .amount-val {
      font-family: var(--font-sans); /* 改用無襯線體，一目了然 */
      font-size: 16px; /* 加大字號 */
      color: #ffffff; 
      font-weight: 700; /* 加粗 */
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.05em;
      text-shadow: 0 2px 8px rgba(0,0,0,0.5); /* 提升文字立體感 */
    }

    /* --- 紅利明細列表 (Credits) --- */
    .credits-list { display: flex; flex-direction: column; gap: 0; /* 連續列表 */ }
    
    .credit-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 20px 10px;
      background: transparent;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      transition: background 0.2s;
    }
    .credit-item:last-child { border-bottom: none; }
    .credit-item:hover {
      background: rgba(255,255,255,0.02);
    }

    .c-info { display: flex; flex-direction: column; gap: 6px; }
    
    .c-reason { 
      font-size: 14px; 
      color: #ececec; 
      font-weight: 400; 
      letter-spacing: 0.03em;
    }
    .c-date { 
      font-size: 11px; 
      color: #666; 
      font-family: monospace;
    }
    
    /* --- [修改] 列表金額顯示：更清晰易讀 --- */
    .c-amount {
      font-family: var(--font-sans); /* 改用無襯線體 */
      font-size: 18px;
      font-weight: 600; /* 加粗 */
      text-align: right;
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.02em;
    }
    .c-amount.pos { color: var(--success); }
    .c-amount.neg { color: var(--danger); }
    
    .c-balance { 
      font-size: 10px; 
      color: #555; 
      text-align: right; 
      margin-top: 4px;
      font-family: var(--font-sans);
    }
  </style>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

  <div class="page">
    <!-- 1. Header -->
    <div class="header-area">
      <div class="brand-title">XUYUAN</div>
      <div class="page-title">會員中心</div>
      <button class="refresh-btn" id="reloadBtn" title="重新整理">↻</button>
      <button class="clear-focus-btn" id="clearFocusBtn" title="取消定位" style="display:none;">✕</button>
    </div>

    <!-- 2. 數位會員卡 -->
    <div class="member-card">
      <div class="user-info">
        <div class="user-avatar">
          <span id="defaultAvatar">X</span>
          <img id="userAvatarImg" style="display:none;" />
        </div>
        <div>
          <div class="user-name" id="userName">貴賓</div>
          <div class="user-status" id="statusText">歡迎回來</div>
        </div>
      </div>
      <div class="credit-row">
        <div>
          <div class="credit-label">可用購物金</div>
        </div>
        <div class="credit-amount" id="creditValue">NT$ --</div>
      </div>
    </div>

    <!-- 3. 導航頁籤 -->
    <div class="tabs">
      <button class="tab active" data-tab="history">歷史訂單</button>
      <button class="tab" data-tab="deposit">定金保留</button>
      <button class="tab" data-tab="credits">購物金明細</button>
    </div>

    <!-- 訊息提示 -->
    <div class="msg" id="infoMsg">資料讀取中...</div>

    <!-- 內容區域：訂單列表 -->
    <div class="order-list" id="orderList"></div>
    
    <!-- 內容區域：紅利列表 -->
    <div class="credits-list" id="creditsList" style="display:none;"></div>

    <!-- 空狀態 -->
    <div class="empty-state" id="emptyText" style="display:none;">
      尚無資料紀錄
    </div>
  </div>

<script>
  

  const API_BASE    = "https://api.murain.tw";
  const MEMBER_API  = API_BASE + "/member/orders";
  const CREDITS_API = API_BASE + "/member/credits";
  const MEMBER_INFO_API = API_BASE + "/line/member-info";
  const LIFF_ID     = "2008430261-EGZPg3Qp";

  let currentUserId = null;
  let orders = [];
  let memberInfo = null;
  let credits = [];
  let currentFilter = "history";

  const urlParams = new URLSearchParams(window.location.search || "");
  let focusOrderId = urlParams.get("order_id") || "";
  let hasScrolledToInitialOrder = false;

  // DOM Elements
  const statusText  = document.getElementById("statusText");
  const userName    = document.getElementById("userName");
  const userAvatarImg = document.getElementById("userAvatarImg");
  const defaultAvatar = document.getElementById("defaultAvatar");
  const infoMsg     = document.getElementById("infoMsg");
  const orderList   = document.getElementById("orderList");
  const creditsList = document.getElementById("creditsList");
  const emptyText   = document.getElementById("emptyText");
  const creditValue = document.getElementById("creditValue");
  const clearFocusBtn = document.getElementById("clearFocusBtn");

  document.getElementById("reloadBtn").addEventListener("click", () => {
    if (currentUserId) {
      infoMsg.textContent = "更新資料中...";
      infoMsg.style.display = "block";
      loadMemberInfo();
      loadOrders();
      loadCredits();
    } else {
      initLiff();
    }
  })
    // ✅ 有從 LINE 帶 order_id 才顯示「取消定位」
if (clearFocusBtn) {
  if (focusOrderId) clearFocusBtn.style.display = "flex";

  clearFocusBtn.addEventListener("click", () => {
    // 1) 清掉特例狀態
    focusOrderId = "";
    hasScrolledToInitialOrder = true; // 防止又被滾動

    // 2) 清掉網址上的 order_id（不重整頁面）
    try {
      const u = new URL(window.location.href);
      u.searchParams.delete("order_id");
      history.replaceState({}, "", u.toString());
    } catch (e) {}

    // 3) 立刻重畫目前頁籤
    if (currentFilter === "credits") renderCredits();
    else renderOrders();

    // 4) 自己隱藏按鈕
    clearFocusBtn.style.display = "none";
  });
};

  /* --- 工具函式 --- */
  function formatDate(s) {
    if (!s) return "";
    const d = new Date(s);
    if (isNaN(d.getTime())) return s;
    return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
  }

  // ✅ 付款方式（中文）
  function displayPaymentMethod(pm) {
    const k = String(pm || "").toLowerCase();

    const map = {
      cod_711: "7-11 貨到付款",
      cod_post: "宅配 / 貨到付款",
      meetup_cash: "面交付款",
      paid_af: "AFTEE先享後付",

      paid_linepay: "LINE Pay",
      paid_card_once: "信用卡一次付清",
      paid_card_inst_3: "信用卡分 3 期",
      paid_card_inst_6: "信用卡分 6 期",
      paid_card_inst_9: "信用卡分 9 期",

      zero_card_3: "零卡分 3 期",
      zero_card_6: "零卡分 6 期",
      zero_card_9: "零卡分 9 期",
      zero_card_12: "零卡分 12 期",
      zero_card_18: "零卡分 18 期",
      zero_card_24: "零卡分 24 期",

      yufu_inst_3: "裕富 3 期",
      yufu_inst_6: "裕富 6 期",
      yufu_inst_9: "裕富 9 期",
      yufu_inst_12: "裕富 12 期",
      yufu_inst_24: "裕富 24 期",
      yufu_inst_36: "裕富 36 期",
      paid_aftee_direct: "AF 先享後付",

      atm_full: "全額匯款",
      atm_deposit: "定金匯款",
      deposit_new_full_meetup: "匯款全額 - 面交",
      meetup_cash: "面交付現",
      deposit_old: "定金匯款",
      deposit_new_full: "全額匯款",

      deposit_new_full_711: "定金匯款",
      deposit_new_full_post: "定金匯款",
      deposit_new_partial_711: "定金匯款",
      deposit_new_partial_post: "定金匯款",
      deposit_old_partial: "定金匯款"
    };

    return map[k] || pm || "—";
  }

  function escapeHtml(s) {
  return String(s ?? "").replace(/[&<>"']/g, (c) => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;",
  }[c]));
}

  // ✅ 只認「匯款 - 定金」這一群（排除匯款全額 / 面交全額）
function isBankDepositPM(pm) {
  const k = String(pm || "").toLowerCase();
  return (
    k === "atm_deposit" ||
    k === "deposit_old" ||
    k === "deposit_old_partial" ||
    k === "deposit_new_full_711" ||
    k === "deposit_new_full_post" ||
    k === "deposit_new_partial_711" ||
    k === "deposit_new_partial_post"
  );
}

  function getMeetupTime(ship) {
  return String(
    ship?.meetup_time ||
    ship?.meet_time ||
    ship?.meetupTime ||
    ship?.meetTime ||
    ship?.meetup?.time ||
    ""
  ).trim();
}

function getMeetupPlace(ship) {
  return String(
    ship?.meetup_place ||
    ship?.meet_place ||
    ship?.meetupPlace ||
    ship?.meetPlace ||
    ship?.meetup?.place ||
    ""
  ).trim();
}

function isMeetupOrder(ship, paymentMethod) {
  const methodRaw = String(ship?.method || ship?.type || ship?.ship_type || "");
  const method = methodRaw.toLowerCase();
  const pm = String(paymentMethod || "").toLowerCase();

  const t = getMeetupTime(ship);
  const p = getMeetupPlace(ship);

  // ① 明確面交關鍵字 / 已有面交時間地點
  if (
    method.includes("面交") ||
    method.includes("meetup") ||
    pm.includes("meetup") ||
    !!t || !!p
  ) return true;

  // ② ✅ 線上支付但看起來像面交：只有聯絡人，沒有地址/門市/物流方式
  const hasTarget =
    !!ship?.address || !!ship?.addr ||
    !!ship?.store_id || !!ship?.store_name || !!ship?.store_address ||
    method.length > 0;

  const hasContact = !!String(ship?.name || "").trim() || !!String(ship?.phone || "").trim();

  const looksOnlinePay =
    pm.startsWith("paid_") ||
    pm.startsWith("zero_card_") ||
    pm.startsWith("yufu_") ||        // ✅ 裕富也算線上
    pm.includes("linepay") ||
    pm === "atm_full";

  if (!hasTarget && hasContact && looksOnlinePay) return true;

  return false;
}

  // ✅ 會員中心：狀態徽章（出貨 + 付款）
function shipBadgeText(o) {
  const ss = String(o?.ship_status || "").toLowerCase();
  const st = String(o?.status || "").toLowerCase();
  const ps = String(o?.pay_status || "").toLowerCase();

  // 1) 取消 / 付款失敗
  if (st.includes("cancel") || ss.includes("cancel") || ps.includes("cancel")) return "取消訂單";
  if (ps === "failed" || ps.includes("failed")) return "付款失敗";

  // 2) 定金保留（只在「定金保留」頁籤會看到）
  if (st.includes("deposit_hold") || ps.includes("deposit_hold")) return "定金保留中";

  // 3) 貨況優先：已出貨 / 已送達
  if (ss === "shipped" || st === "shipped") return "已出貨";
  if (ss.includes("delivered")) return "已送達";

  // 4) 付款狀態
  if (ps === "paid_ok") return "已付款待出貨中";
  if (ps === "pending") return "待確認";

  // 5) 其它：待出貨（保底）
  return "已確認待出貨中";
}

function shipBadgeClass(o) {
  const ss = String(o?.ship_status || "").toLowerCase();
  const st = String(o?.status || "").toLowerCase();
  const ps = String(o?.pay_status || "").toLowerCase();

  // 1) 取消/失敗 → 紅
  if (st.includes("cancel") || ss.includes("cancel") || ps.includes("cancel") || ps === "failed" || ps.includes("failed")) {
    return "st-unpaid";
  }

  // 2) 已出貨/送達 → 綠
  if (ss === "shipped" || st === "shipped" || ss.includes("delivered")) return "st-paid";

  // 3) 待確認 → 藍紫
  if (ps === "pending") return "st-waitpay";

  // 4) 已付款 → 綠
  if (ps === "paid_ok") return "st-paid";

  // 5) 其它 → 灰
  return "st-pending";
}

  // ✅ 依照你 API 回傳的 ship.method / ship.store_name / ship.address 來判斷
  function deliveryPlaceText(ship, receiver, paymentMethod) {
  const methodRaw = String(ship?.method || ship?.type || ship?.ship_type || "");
  const method = methodRaw.toLowerCase();
  const pm = String(paymentMethod || "").toLowerCase();

  // 7-11 門市
  if (
    method.includes("7-11") ||
    method.includes("711") ||
    method.includes("超商") ||
    ship?.store_id ||
    ship?.store_name
  ) {
    const sname = ship.store_name || "";
    const sid   = ship.store_id ? `（${ship.store_id}）` : "";
    const saddr = ship.store_address ? ` ${ship.store_address}` : "";
    const txt = `7-11 ${sname}${sid}${saddr}`.trim();
    return txt || "7-11 門市";
  }

  // ✅ 面交：顯示客人自己預定的時間/地點（支援 meet_* 與 meetup_*）
const isMeetup = isMeetupOrder(ship, paymentMethod);
if (isMeetup) {
  const t = getMeetupTime(ship);
  const p = getMeetupPlace(ship);

  if (t && p) return `面交 ${t} @ ${p}`;
  if (t)      return `面交 ${t}`;
  if (p)      return `面交 @ ${p}`;
  return "面交";
}


  // 宅配/郵寄：地址可能在 ship 或 receiver
  if (receiver?.address) return String(receiver.address);
  if (ship?.address) return String(ship.address);
  if (ship?.addr) return String(ship.addr);

  // method 顯示（例如：郵寄 / 宅配）
  if (methodRaw) return methodRaw;

  // ✅ 線上支付但面交：常見狀況是只有 name/phone，沒有 store/address，也沒有 method
  const hasTarget =
    !!receiver?.address ||
    !!ship?.address || !!ship?.addr ||
    !!ship?.store_id || !!ship?.store_name || !!ship?.store_address;

  const hasContact = !!(receiver?.name || receiver?.phone || ship?.name || ship?.phone);

  const looksOnlinePay =
    pm.startsWith("paid_") ||
    pm.startsWith("zero_card_") ||
    pm.includes("linepay") ||        // paid_linepay
    pm === "atm_full";              // 匯款全額（有些人也會面交）

  if (!methodRaw && hasContact && !hasTarget && looksOnlinePay) {
    return "面交";
  }

  return "尚未填寫";
}

function receiverFullText(receiver, ship, paymentMethod) {
  const name  = String(receiver?.name  || ship?.name  || "").trim();
  const phone = String(receiver?.phone || ship?.phone || "").trim();
  const head  = [name, phone].filter(Boolean).join(" / ");

  const isMeetup = isMeetupOrder(ship, paymentMethod);

  // ✅ 面交：拆成兩行（時間/地點）
  if (isMeetup) {
    const t = getMeetupTime(ship);
    const p = getMeetupPlace(ship);

    const lines = [];
    if (head) lines.push(head);
    if (t) lines.push(`面交時間：${t}`);
    if (p) lines.push(`面交地點：${p}`);
    if (!t && !p) lines.push("面交");

    return lines.join("\n");
  }

  // 其他配送方式照舊
  const place = deliveryPlaceText(ship || {}, receiver || {}, paymentMethod);
  return (head ? head + "\n" : "") + place;
}

    /* --- 頁籤切換 --- */
  function updateTabsUI() {
    document.querySelectorAll(".tab").forEach(btn => {
      if (btn.dataset.tab === currentFilter) btn.classList.add("active");
      else btn.classList.remove("active");
    });
  }

  // 渲染訂單列表
  function renderOrders() {
    orderList.style.display   = "flex";
    creditsList.style.display = "none";
    emptyText.style.display   = "none";
    orderList.innerHTML       = "";

    let list = orders.slice();

    if (currentFilter === "history") {
      const now = new Date();
      const halfMonthAgo = new Date(now);
      halfMonthAgo.setDate(halfMonthAgo.getDate() - 15);

list = list.filter(o => {
  // ✅ 特例：從 LINE 帶 order_id 進來，永遠保留那筆
  if (focusOrderId && o.order_id === focusOrderId) return true;

  // ✅ 隱藏：付款失敗 / 已取消
  const st = String(o.status || "").toLowerCase();
  const ps = String(o.pay_status || "").toLowerCase();
  const ss = String(o.ship_status || "").toLowerCase();
  const isBad =
    st.includes("cancel") || ss.includes("cancel") ||
    ps.includes("cancel") || ps === "failed" || ps.includes("failed");
  if (isBad) return false;

  // ✅ 不包含：定金保留（請到「定金保留」頁籤查看）
  const pm = String(o.payment_method || "").toLowerCase();
  if (isBankDepositPM(pm) || st.includes("deposit_hold") || ps.includes("deposit_hold")) return false;

  // ✅ 只留近半個月（15 天）
  const createdAt = o.created_at ? new Date(o.created_at) : null;
  if (!createdAt || isNaN(createdAt.getTime())) return false;
  return createdAt >= halfMonthAgo;
});
    }
   else if (currentFilter === "deposit") {
  // ✅ 定金保留訂單：保留 1 個半月（45 天）
  const now = new Date();
  const oneAndHalfMonthAgo = new Date(now);
  oneAndHalfMonthAgo.setDate(oneAndHalfMonthAgo.getDate() - 45);

list = list.filter(o => {
    // 仍保留「從 Flex 帶 order_id 進來」時能看到那一筆
    if (focusOrderId && o.order_id === focusOrderId) return true;

    // 半年內
    const createdAt = o.created_at ? new Date(o.created_at) : null;
    if (!createdAt || isNaN(createdAt.getTime())) return false;
    if (createdAt < oneAndHalfMonthAgo) return false;

    // ✅ 只保留「匯款 - 定金」= atm_deposit
    const pm = String(o.payment_method || "").toLowerCase();
const isDeposit = isBankDepositPM(pm);

    // 排除已出貨/取消/失敗
    const status    = String(o.status || "").toLowerCase();
    const payStatus = String(o.pay_status || "").toLowerCase();
    const shipStatus = String(o.ship_status || "").toLowerCase();

    const notFinished =
      shipStatus !== "shipped" &&
      status !== "shipped" &&
      !status.includes("cancel") &&
      !payStatus.includes("cancel") &&
      payStatus !== "failed";

    return isDeposit && notFinished;
  });
}

    if (!list.length) {
      emptyText.style.display = "block";
      return;
    }

    for (const o of list) {
      // 需要 debug 時可打開
      // console.log("order sample", o);

      const wrap = document.createElement("div");
      wrap.className = "order-card";

      if (focusOrderId && o.order_id === focusOrderId) {
        wrap.classList.add("highlight");
        if (!hasScrolledToInitialOrder) {
          hasScrolledToInitialOrder = true;
          setTimeout(() => {
            wrap.scrollIntoView({ behavior: "smooth", block: "center" });
          }, 150);
        }
      }

      const statusCls = shipBadgeClass(o);
      const payTxt    = shipBadgeText(o);

      // ✅ 你的 API：收件資訊在 o.ship
      const shipObj = o.ship || {};
const receiverObj = o.receiver || {}; // 目前多半沒有，但保留擴充

const pmLower = String(o.payment_method || "").toLowerCase();
const mLower  = String(shipObj?.method || shipObj?.type || shipObj?.ship_type || "").toLowerCase();
const isMeetup = isMeetupOrder(shipObj, o.payment_method);
const receiverLabel = isMeetup ? "面交資訊" : "收件資料";

const receiverTxt = receiverFullText(receiverObj, shipObj, o.payment_method).replace(/\n/g, "<br>");
      const payMethodTxt = displayPaymentMethod(o.payment_method);

      const depositAmt = Number(o.deposit_amount || 0) || 0;
      const depositLine = depositAmt > 0
        ? `<div><span class="info-label">訂金</span> NT$ ${depositAmt.toLocaleString("zh-TW")}</div>`
        : "";

      const meetupTime  = getMeetupTime(shipObj);
const meetupPlace = getMeetupPlace(shipObj);

const meetupLine = isMeetup
  ? `
    ${meetupTime ? `<div><span class="info-label">面交時間</span> ${String(meetupTime)}</div>` : ""}
    ${meetupPlace ? `<div><span class="info-label">面交地點</span> ${String(meetupPlace)}</div>` : ""}
  `
  : "";
      // ✅ 商品明細（後端若有回傳 items_text 就顯示）
const itemsTextRaw = String(
  o.items_text || o.itemsText || o.items || ""
).trim();

const itemsHtml = itemsTextRaw
  ? `
    <div class="items-box">
      <div class="items-title">商品明細</div>
      <div class="items-text">${escapeHtml(itemsTextRaw).replace(/\n/g, "<br>")}</div>
    </div>
  `
  : "";

      const total = Number(o.total_amount || 0);

      wrap.innerHTML = `
        <div class="card-header">
          <div>
            <div class="order-id">#${o.order_id}</div>
            <div class="order-date">${formatDate(o.created_at)}</div>
          </div>
          <div class="status-badge ${statusCls}">${payTxt}</div>
        </div>
        
        <div class="card-body">
          <div class="info-group">
            <div><span class="info-label">${receiverLabel}</span> ${receiverTxt}</div>
            <div><span class="info-label">付款方式</span> ${payMethodTxt}</div>
            ${depositLine}
  ${meetupLine}
   ${itemsHtml}
          </div>
          
          <div class="amount-display">
            <div class="amount-label">總金額</div>
            <div class="amount-val">NT$ ${total.toLocaleString("zh-TW")}</div>
          </div>
        </div>
      `;
      orderList.appendChild(wrap);
    }
  }

  // 渲染購物金明細
  function renderCredits() {
    orderList.style.display   = "none";
    creditsList.style.display = "flex";
    emptyText.style.display   = "none";
    creditsList.innerHTML     = "";

    if (!credits.length) {
      emptyText.style.display = "block";
      return;
    }

    credits.forEach(item => {
      const el = document.createElement("div");
      el.className = "credit-item";

      const amt = Number(item.amount || 0);
      const isPositive = amt >= 0;
      const amtClass = isPositive ? "pos" : "neg";
      const sign = isPositive ? "+" : "";

      const reason = item.reason || "購物金異動";
      const bal = (item.balance !== undefined && item.balance !== null) ? Number(item.balance) : null;

      el.innerHTML = `
        <div class="c-info">
          <div class="c-reason">${reason}</div>
          <div class="c-date">${formatDate(item.created_at)}</div>
        </div>
        <div>
          <div class="c-amount ${amtClass}">${sign}NT$ ${Math.abs(amt).toLocaleString("zh-TW")}</div>
          ${bal !== null ? `<div class="c-balance">餘額: NT$ ${bal.toLocaleString("zh-TW")}</div>` : ''}
        </div>
      `;
      creditsList.appendChild(el);
    });
  }

  /* --- API 邏輯 --- */
  async function loadMemberInfo() {
    if (!currentUserId) return;
    try {
      const res = await fetch(MEMBER_INFO_API + "?user_id=" + encodeURIComponent(currentUserId));
      const json = await res.json();
      if (res.ok && json.ok) {
        memberInfo = json;
        const c = Number(memberInfo.credit || 0);
        creditValue.textContent = "NT$ " + c.toLocaleString("zh-TW");
      }
    } catch (e) { console.error(e); }
  }

  async function loadCredits() {
    if (!currentUserId) return;

    if (currentFilter === "credits") {
      infoMsg.textContent = "載入明細中...";
      infoMsg.style.display = "block";
    }

    try {
      const res = await fetch(CREDITS_API + "?line_user_id=" + encodeURIComponent(currentUserId));
      const json = await res.json();
      if (res.ok && json.ok) {
        credits = json.items || [];
        if (currentFilter === "credits") renderCredits();
      }
    } catch (e) { console.error(e); }
    
    if (currentFilter === "credits") {
      infoMsg.textContent = "";
      infoMsg.style.display = "none";
    }
  }

  async function loadOrders() {
    if (!currentUserId) return;

    if (currentFilter !== "credits") {
      infoMsg.textContent = "更新資料中...";
      infoMsg.style.display = "block";
    }

    try {
      const res = await fetch(MEMBER_API + "?line_user_id=" + encodeURIComponent(currentUserId));
      const json = await res.json();
      if (res.ok && json.ok) {
        orders = json.orders || [];
        if (currentFilter !== "credits") renderOrders();
      }
    } catch (e) { 
      infoMsg.textContent = "載入失敗"; 
      infoMsg.classList.add("error");
    }

    if (currentFilter !== "credits") {
      infoMsg.textContent = "";
      infoMsg.style.display = "none";
    }
  }

  async function initLiff() {
    if (!window.liff) return;
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) {
        liff.login(); return;
      }
      
      const profile = await liff.getProfile();
      currentUserId = profile.userId;
      userName.textContent = profile.displayName;
      
      if(profile.pictureUrl){
        defaultAvatar.style.display = "none";
        userAvatarImg.style.display = "block";
        userAvatarImg.src = profile.pictureUrl;
      }
      
      statusText.textContent = "歡迎回來"; // 配合高級感改英文，您可改回歡迎回來
      
      loadMemberInfo();
      loadOrders();
      loadCredits();
    } catch (e) {
      infoMsg.textContent = "請從 LINE 官方帳號開啟";
      infoMsg.style.display = "block";
    }
  }

  /* --- Init --- */
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".tab").forEach(btn => {
      btn.addEventListener("click", () => {
        currentFilter = btn.dataset.tab || "history";
        updateTabsUI();
        
        if (currentFilter === "credits") {
          if(credits.length === 0) loadCredits();
          else renderCredits();
        } else {
          renderOrders();
        }
      });
    });
    
    updateTabsUI();
    initLiff();
  });
</script>

</body>
</html>
