<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>MURAIN 會員中心</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: #050505;
      color: #f7f7f7;
    }
    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px 12px 40px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .brand {
      font-size: 20px;
      letter-spacing: 0.2em;
    }
    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.3);
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin: 8px 0 12px;
    }
    .tab-btn {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.3);
      background: transparent;
      color: #f7f7f7;
      font-size: 12px;
      padding: 6px 8px;
      cursor: pointer;
    }
    .tab-btn-active {
      background: linear-gradient(135deg, #f5e2a0, #d4af37);
      color: #111;
      border-color: transparent;
      font-weight: 600;
    }
    .order-card {
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.7);
      padding: 10px 12px;
      margin-bottom: 8px;
      font-size: 12px;
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }
    .order-id {
      font-weight: 600;
      font-size: 12px;
    }
    .order-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.25);
    }
    .order-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 2px;
    }
    .muted {
      color: #aaa;
    }
    .amount {
      color: #f5e2a0;
      font-weight: 600;
    }
    .section-title {
      font-size: 13px;
      margin: 8px 0 4px;
    }
    #status {
      font-size: 12px;
      margin-bottom: 8px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <div>
        <div class="brand">MURAIN</div>
        <div style="font-size:11px;color:#aaa;margin-top:2px;">會員中心｜查詢直播 & 官網訂單</div>
      </div>
      <div class="badge" id="userNameBadge">登入中…</div>
    </header>

    <div id="status">正在連線到 LINE，請稍候…</div>

    <div class="tabs">
      <button class="tab-btn tab-btn-active" data-filter="all">全部訂單</button>
      <button class="tab-btn" data-filter="live">直播訂單</button>
      <button class="tab-btn" data-filter="web">官網訂單</button>
    </div>

    <div id="orderList"></div>
    <div id="emptyTip" class="muted" style="margin-top:12px;display:none;">
      尚無訂單紀錄。
    </div>
  </div>

  <script>
    const LIFF_ID = '2008430261-EGZPg3Qp';
    const API_BASE = 'https://api.murain.tw';
    const MEMBER_API = API_BASE + '/member/orders';

    let allOrders = [];

    async function initLiff(){
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        const userId = profile.userId;
        document.getElementById('userNameBadge').textContent = profile.displayName || '會員';

        document.getElementById('status').textContent = '載入訂單中…';

        const res = await fetch(MEMBER_API + '?line_user_id=' + encodeURIComponent(userId));
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || 'error');

        allOrders = json.orders || [];
        document.getElementById('status').style.display = 'none';
        renderOrders('all');

      } catch (err) {
        console.error(err);
        document.getElementById('status').textContent = '載入失敗，請稍後再試。';
      }
    }

    function renderOrders(filter){
      const listEl = document.getElementById('orderList');
      const emptyEl = document.getElementById('emptyTip');
      if (!listEl || !emptyEl) return;

      let orders = allOrders;
      if (filter === 'live') {
        orders = allOrders.filter(o => (o.customer_type || '').toLowerCase() === 'live');
      } else if (filter === 'web') {
        orders = allOrders.filter(o => (o.customer_type || '').toLowerCase() === 'web');
      }

      if (!orders.length){
        listEl.innerHTML = '';
        emptyEl.style.display = 'block';
        emptyEl.textContent = '這個分類目前沒有訂單。';
        return;
      }

      emptyEl.style.display = 'none';

      const html = orders.map(o => {
        const created = o.created_at ? o.created_at.replace('T',' ').replace('Z','') : '';
        const paid = (o.pay_status || '').includes('paid');
        const statusText = paid ? '已付款' : (o.pay_status || '');
        const channel = (o.customer_type || '').toLowerCase() === 'live' ? '直播' : '官網';

        return `
          <div class="order-card">
            <div class="order-header">
              <div class="order-id">${o.order_id || ''}</div>
              <div class="order-badge">${channel}</div>
            </div>
            <div class="order-row">
              <div class="muted">${created}</div>
              <div class="amount">NT$ ${(o.total_amount || 0).toLocaleString()}</div>
            </div>
            <div class="order-row">
              <div class="muted">${o.payment_method || ''}</div>
              <div class="muted">${statusText}</div>
            </div>
            ${o.streamer_name ? `<div class="order-row"><div class="muted">直播主：${o.streamer_name}</div></div>` : ''}
          </div>
        `;
      }).join('');

      listEl.innerHTML = html;
    }

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const filter = btn.dataset.filter || 'all';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-btn-active'));
        btn.classList.add('tab-btn-active');
        renderOrders(filter);
      });
    });

    initLiff();
  </script>
</body>
</html>
