<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>XUYUAN | 會員中心</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  
  <!-- 引入高級字體 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    /* --- 核心變數 --- */
    :root {
      --bg-color: #0a0a0a;
      --card-bg: #141414;
      --text-main: #f0f0f0;
      --text-muted: #888888;
      --gold-primary: #D4AF37; 
      --gold-light: #F3E5AB;
      --border-color: rgba(255, 255, 255, 0.1);
      --success: #4ade80;
      --danger: #ef4444;
      --font-serif: 'Playfair Display', serif;
      --font-sans: 'Lato', 'Noto Sans TC', sans-serif; /* 加入中文字體支援 */
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      background-image: 
        radial-gradient(circle at 50% 0%, #222 0%, transparent 70%),
        linear-gradient(to bottom, #0a0a0a, #000);
    }

    .page {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px 16px 60px;
    }

    /* --- 頂部 Header --- */
    .header-area {
      text-align: center;
      margin-bottom: 24px;
      position: relative;
    }
    
    .brand-title {
      font-family: var(--font-serif);
      font-size: 24px;
      letter-spacing: 0.15em;
      color: var(--gold-light);
      margin-bottom: 4px;
      font-weight: 600;
    }
    
    .page-title {
      font-size: 13px;
      letter-spacing: 0.2em;
      color: var(--text-muted);
      text-transform: uppercase;
      font-weight: 500;
    }

    /* 重新整理按鈕 (右上角) */
    .refresh-btn {
      position: absolute;
      top: 0; right: 0;
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-muted);
      width: 32px; height: 32px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .refresh-btn:active {
      border-color: var(--gold-primary);
      color: var(--gold-primary);
    }

    /* --- 數位會員卡 (Premium Card) --- */
    .member-card {
      background: linear-gradient(135deg, #1f1f1f, #0f0f0f);
      border: 1px solid rgba(212, 175, 55, 0.3);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    
    .member-card::before {
      content: ''; position: absolute;
      top: -50%; right: -50%;
      width: 200px; height: 200px;
      background: radial-gradient(circle, rgba(212,175,55,0.15), transparent 70%);
      filter: blur(20px);
    }

    .user-info {
      display: flex; align-items: center; gap: 16px;
      margin-bottom: 24px;
      position: relative; z-index: 2;
    }
    .user-avatar {
      width: 48px; height: 48px;
      background: #000; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: var(--gold-primary); font-size: 20px;
      border: 1px solid rgba(212, 175, 55, 0.5);
      overflow: hidden;
    }
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; }

    .user-name { font-size: 16px; font-weight: 600; color: #fff; letter-spacing: 0.05em; }
    .user-status { font-size: 12px; color: var(--gold-primary); margin-top: 2px; }

    .credit-row {
      display: flex; justify-content: space-between; align-items: flex-end;
      position: relative; z-index: 2;
      border-top: 1px solid rgba(255,255,255,0.1);
      padding-top: 16px;
    }
    .credit-label { font-size: 12px; color: #888; letter-spacing: 0.1em; margin-bottom: 4px; }

    /* ✅ 數字改回 Sans-serif（清晰正式） */
    .credit-amount{
      font-family: var(--font-sans);
      font-size: 32px;
      color: var(--gold-light);
      font-weight: 800;
      line-height: 1;
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.02em;
      background: none;
      -webkit-background-clip: initial;
      -webkit-text-fill-color: initial;
    }
    
    /* --- 頁籤 Tabs --- */
    .tabs {
      display: flex;
      background: rgba(255,255,255,0.03);
      padding: 4px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }
    .tab {
      flex: 1;
      padding: 10px 0;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 13px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: var(--font-sans);
    }
    .tab.active {
      background: var(--card-bg);
      color: var(--gold-primary);
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      font-weight: 700;
    }

    /* --- 列表容器 --- */
    .msg { font-size: 13px; color: var(--text-muted); text-align: center; margin: 20px 0; }
    .msg.error { color: var(--danger); }
    
    .empty-state {
      padding: 40px 0; text-align: center; color: #666; font-size: 13px;
      border: 1px dashed var(--border-color); border-radius: 12px;
    }

    /* --- 訂單卡片 (Order Card) --- */
    .order-list { display: flex; flex-direction: column; gap: 16px; }
    
    .order-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid var(--border-color);
      position: relative;
      transition: transform 0.2s;
    }
    .order-card.highlight {
      border-color: var(--gold-primary);
      box-shadow: 0 0 0 1px rgba(212,175,55,0.3);
    }

    .card-header {
      display: flex; justify-content: space-between; align-items: flex-start;
      margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);
      padding-bottom: 12px;
    }
    .order-id { font-family: monospace; font-size: 13px; color: #fff; letter-spacing: 0.05em; }
    .order-date { font-size: 11px; color: #666; margin-top: 4px; }
    
    .status-badge {
      font-size: 11px; padding: 4px 10px; border-radius: 99em;
      font-weight: 600; letter-spacing: 0.05em;
    }
    /* 狀態顏色 */
    .st-paid { background: rgba(74, 222, 128, 0.1); color: #4ade80; border: 1px solid rgba(74, 222, 128, 0.2); }
    .st-unpaid { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); }
    .st-pending { background: rgba(255, 255, 255, 0.1); color: #aaa; border: 1px solid rgba(255, 255, 255, 0.1); }

    .card-body { display: flex; justify-content: space-between; align-items: flex-end; }
    
    .info-group { display: flex; flex-direction: column; gap: 6px; font-size: 13px; color: #ccc; }
    .info-label { font-size: 11px; color: #666; margin-right: 4px; border: 1px solid #333; padding: 1px 4px; border-radius: 4px; }
    
    .amount-display { text-align: right; }
    .amount-label { font-size: 11px; color: #666; margin-bottom: 2px; letter-spacing: 0.1em; }

    /* ✅ 訂單金額數字 Sans-serif */
    .amount-val{
      font-family: var(--font-sans);
      font-size: 20px;
      color: var(--gold-light);
      font-weight: 800;
      font-variant-numeric: tabular-nums;
    }

    /* --- 紅利明細列表 (Credits) --- */
    .credits-list { display: flex; flex-direction: column; gap: 12px; }
    .credit-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px;
      border-radius: 8px;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.05);
    }
    .c-info { display: flex; flex-direction: column; gap: 4px; }
    .c-reason { font-size: 14px; color: #eee; font-weight: 500; }
    .c-date { font-size: 11px; color: #666; }
    
    /* ✅ 明細金額數字 Sans-serif */
    .c-amount{
      font-family: var(--font-sans);
      font-size: 18px;
      font-weight: 800;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .c-amount.pos { color: var(--success); }
    .c-amount.neg { color: var(--danger); }
    .c-balance { font-size: 10px; color: #555; text-align: right; margin-top: 2px;}
  </style>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

  <div class="page">
    <!-- 1. Header -->
    <div class="header-area">
      <div class="brand-title">XUYUAN</div>
      <div class="page-title">會員中心</div>
      <button class="refresh-btn" id="reloadBtn" title="重新整理">↻</button>
    </div>

    <!-- 2. 數位會員卡 -->
    <div class="member-card">
      <div class="user-info">
        <div class="user-avatar">
          <span id="defaultAvatar">X</span>
          <img id="userAvatarImg" style="display:none;" />
        </div>
        <div>
          <div class="user-name" id="userName">貴賓</div>
          <div class="user-status" id="statusText">歡迎回來</div>
        </div>
      </div>
      <div class="credit-row">
        <div>
          <div class="credit-label">可用購物金</div>
        </div>
        <div class="credit-amount" id="creditValue">NT$ --</div>
      </div>
    </div>

    <!-- 3. 導航頁籤 -->
    <div class="tabs">
      <button class="tab active" data-tab="history">歷史訂單</button>
      <button class="tab" data-tab="deposit">定金保留訂單</button>
      <button class="tab" data-tab="credits">購物金明細</button>
    </div>

    <!-- 訊息提示 -->
    <div class="msg" id="infoMsg">資料讀取中...</div>

    <!-- 內容區域：訂單列表 -->
    <div class="order-list" id="orderList"></div>
    
    <!-- 內容區域：紅利列表 -->
    <div class="credits-list" id="creditsList" style="display:none;"></div>

    <!-- 空狀態 -->
    <div class="empty-state" id="emptyText" style="display:none;">
      尚無資料紀錄
    </div>
  </div>

<script>
  // ✅ 重要：如果有人用 /member 開，先跳到 /member.html，避免 LIFF endpoint 警告
  (function enforceMemberHtml(){
    const p = (location.pathname || "").replace(/\/+$/, "");
    if (p === "/member") {
      location.replace("/member.html" + (location.search || "") + (location.hash || ""));
    }
  })();

  const API_BASE    = "https://api.murain.tw";
  const MEMBER_API  = API_BASE + "/member/orders";
  const CREDITS_API = API_BASE + "/member/credits";
  const MEMBER_INFO_API = API_BASE + "/line/member-info";
  const LIFF_ID     = "2008430261-EGZPg3Qp";

  let currentUserId = null;
  let orders = [];
  let memberInfo = null;
  let credits = [];
  let currentFilter = "history";

  const urlParams = new URLSearchParams(window.location.search || "");
  const initialOrderId = urlParams.get("order_id") || "";
  let hasScrolledToInitialOrder = false;

  // DOM Elements
  const statusText  = document.getElementById("statusText");
  const userName    = document.getElementById("userName");
  const userAvatarImg = document.getElementById("userAvatarImg");
  const defaultAvatar = document.getElementById("defaultAvatar");
  const infoMsg     = document.getElementById("infoMsg");
  const orderList   = document.getElementById("orderList");
  const creditsList = document.getElementById("creditsList");
  const emptyText   = document.getElementById("emptyText");
  const creditValue = document.getElementById("creditValue");

  document.getElementById("reloadBtn").addEventListener("click", () => {
    if (currentUserId) {
      infoMsg.textContent = "更新資料中...";
      infoMsg.style.display = "block";
      loadMemberInfo();
      loadOrders();
      loadCredits();
    } else {
      initLiff();
    }
  });

  /* --- 工具函式 --- */
  function formatDate(s) {
    if (!s) return "";
    const d = new Date(s);
    if (isNaN(d.getTime())) return s;
    return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
  }

  // ✅ 付款方式（中文）
  function displayPaymentMethod(pm) {
    const k = String(pm || "").toLowerCase();

    const map = {
      cod_711: "7-11 取貨付款",
      cod_post: "宅配 / 貨到付款",
      meetup_cash: "面交付款",

      paid_linepay: "LINE Pay",
      paid_card_once: "信用卡一次付清",
      paid_card_inst_3: "信用卡分 3 期",
      paid_card_inst_6: "信用卡分 6 期",
      paid_card_inst_9: "信用卡分 9 期",

      zero_card_3: "零卡分 3 期",
      zero_card_6: "零卡分 6 期",
      zero_card_9: "零卡分 9 期",
      zero_card_12: "零卡分 12 期",
      zero_card_18: "零卡分 18 期",
      zero_card_24: "零卡分 24 期",

      atm_full: "ATM 轉帳（全額）",
      atm_deposit: "ATM 轉帳（訂金）",

      deposit_new_full_711: "訂金（新制 / 全額 / 7-11）",
      deposit_new_full_post: "訂金（新制 / 全額 / 宅配）",
      deposit_new_partial_711: "訂金（新制 / 部分 / 7-11）",
      deposit_new_partial_post: "訂金（新制 / 部分 / 宅配）",
      deposit_old_partial: "訂金（舊制 / 部分）"
    };

    return map[k] || pm || "—";
  }

  // ✅ 會員中心：只顯示「出貨狀態」
  function shipBadgeText(o) {
    const ss = String(o?.ship_status || "");
    const st = String(o?.status || "");
    if (ss === "shipped" || st === "shipped") return "已出貨";
    return "待出貨";
  }

  function shipBadgeClass(o) {
    const ss = String(o?.ship_status || "");
    const st = String(o?.status || "");
    if (ss === "shipped" || st === "shipped") return "st-paid";
    return "st-pending";
  }

// === 會員中心：付款狀態顯示（只影響前台顯示，不改後端狀態） ===
function isCODorMeetup(o){
  const pm = String(o && o.payment_method || "").toLowerCase();
  if (pm === "cod_711" || pm === "cod_post" || pm === "meetup_cash") return true;
  // 兼容：有些資料可能沒有 payment_method，改從 ship.type 判斷
  try {
    const ship = getShipFromOrder(o) || {};
    const t = String(ship.type || "").toLowerCase();
    if (t === "meetup" && !pm) return true;
  } catch(e){}
  return false;
}

function displayPayStatusForMember(o){
  if (!o) return "-";
  if (isCODorMeetup(o)) return "待付款";

  const ps = String(o.pay_status || o.status || "").toLowerCase();
  switch (ps) {
    case "paid":
    case "paid_ok":
    case "pay_ok":
      return "已付款";
    case "unpaid":
    case "pending":
    case "submitted":
      return "待付款";
    case "deposit_hold":
      return "訂金保留";
    case "deposit_ok":
      return "訂金已收";
    case "shipped":
      return "已出貨";
    case "cancelled":
    case "canceled":
      return "已取消";
    case "refunded":
      return "已退款";
    default:
      return o.pay_status || o.status || "處理中";
  }
}

function payStatusClassForMember(o){
  if (isCODorMeetup(o)) return "st-unpaid";
  const ps = String(o && (o.pay_status || o.status) || "").toLowerCase();
  if (ps === "paid" || ps === "paid_ok" || ps === "pay_ok") return "st-paid";
  if (ps === "deposit_hold" || ps === "deposit_ok") return "st-pending";
  if (ps === "cancelled" || ps === "canceled" || ps === "refunded") return "st-unpaid";
  if (ps === "pending" || ps === "submitted") return "st-pending";
  return "st-unpaid";
}

function shipBadgeHTMLForMember(o){
  const txt = shipBadgeText(o);
  const cls = shipBadgeClass(o);
  return `<span class="status-badge ${cls}">${txt}</span>`;
}


  // ✅ 依照你 API 回傳的 ship.method / ship.store_name / ship.address 來判斷
  function deliveryPlaceText(ship, receiver) {
    const methodRaw = String(ship?.method || ship?.type || ship?.ship_type || "");
    const method = methodRaw.toLowerCase();

    // 7-11 門市
    if (
      method.includes("7-11") ||
      method.includes("711") ||
      method.includes("超商") ||
      ship?.store_id ||
      ship?.store_name
    ) {
      const sname = ship.store_name || "";
      const sid   = ship.store_id ? `（${ship.store_id}）` : "";
      const saddr = ship.store_address ? ` ${ship.store_address}` : "";
      const txt = `7-11 ${sname}${sid}${saddr}`.trim();
      return txt || "7-11 門市";
    }

    // 宅配/郵寄：地址可能在 ship 或 receiver
    if (receiver?.address) return String(receiver.address);
    if (ship?.address) return String(ship.address);
    if (ship?.addr) return String(ship.addr);

    // 面交
    if (method.includes("面交") || method.includes("meetup")) return "面交";

    // method 顯示（例如：郵寄 / 宅配）
    if (methodRaw) return methodRaw;

    return "尚未填寫";
  }

  // ✅ 收件資料：就算 receiver 沒資料，也會從 ship.name/phone 補上
  function receiverFullText(receiver, ship) {
    const name  = String(receiver?.name  || ship?.name  || "").trim();
    const phone = String(receiver?.phone || ship?.phone || "").trim();
    const place = deliveryPlaceText(ship || {}, receiver || {});
    const head  = [name, phone].filter(Boolean).join(" / ");
    return (head ? head + "\n" : "") + place;
  }

  /* --- 頁籤切換 --- */
  function updateTabsUI() {
    document.querySelectorAll(".tab").forEach(btn => {
      if (btn.dataset.tab === currentFilter) btn.classList.add("active");
      else btn.classList.remove("active");
    });
  }

  // 渲染訂單列表
  function renderOrders(){
  orderList.innerHTML = "";

  // 一律先排序（新→舊）
  let base = (orders || []).slice().sort((a,b)=>{
    const ta = new Date(a.created_at || a.createdAt || a.created || 0).getTime();
    const tb = new Date(b.created_at || b.createdAt || b.created || 0).getTime();
    return tb - ta;
  });

  // 分頁籤：歷史/定金保留
  if (currentFilter === "history") {
    // ✅ 預設顯示近 90 天（避免太舊也避免「完全看不到訂單」）
    const days = 90;
    const since = new Date(Date.now() - days*24*60*60*1000);
    base = base.filter(o => {
      const t = new Date(o.created_at || o.createdAt || o.created || 0);
      return !isNaN(t.getTime()) && t >= since;
    });
  } else if (currentFilter === "deposit") {
    base = base.filter(o => {
      const ps = String(o.pay_status || o.status || "").toLowerCase();
      const pm = String(o.payment_method || "").toLowerCase();
      return ps === "deposit_hold" || pm === "deposit_old" || ps === "deposit_ok";
    });
  }

  if (!base.length) {
    orderList.innerHTML = `<div class="empty">目前沒有可顯示的訂單</div>`;
    return;
  }

  base.forEach(o => {
    const wrap = document.createElement("div");
    wrap.className = "order-card";

    const orderId = String(o.order_id || o.OrderID || o.id || "-");
    const dateStr = formatDate(o.created_at || o.createdAt || o.created || "");
    const pmLabel = displayPaymentMethod(o.payment_method || "");

    // 金額：優先顯示折抵後 net_amount（若後端有給）
    const amount = Number(
      (o.net_amount !== undefined ? o.net_amount : (o.total_amount !== undefined ? o.total_amount : 0))
    ) || 0;

    const payTxt = displayPayStatusForMember(o);
    const payCls = payStatusClassForMember(o);
    const shipBadge = shipBadgeHTMLForMember(o);

    // 額外：購物金提示（若有）
    const creditUsed = Number(o.credit_used || (o.shipping_info && o.shipping_info.credit_used) || 0) || 0;
    const creditHint = creditUsed > 0
      ? `<div class="order-row"><span class="key">購物金折抵</span><span class="value">- NT$ ${creditUsed.toLocaleString("zh-TW")}</span></div>`
      : "";

    wrap.innerHTML = `
      <div class="order-top">
        <div class="order-id">訂單 ${orderId}</div>
        <div class="status-wrap">
          <span class="status-badge ${payCls}">${payTxt}</span>
          ${shipBadge}
        </div>
      </div>
      <div class="order-row">
        <span class="key">下單時間</span>
        <span class="value">${dateStr}</span>
      </div>
      <div class="order-row">
        <span class="key">付款方式</span>
        <span class="value">${pmLabel}</span>
      </div>
      ${creditHint}
      <div class="order-row">
        <span class="key">訂單金額</span>
        <span class="value">NT$ ${amount.toLocaleString("zh-TW")}</span>
      </div>
      <div class="order-actions">
        <button class="btn btn-outline" data-act="detail" data-order="${orderId}">查看明細</button>
      </div>
    `;

    wrap.querySelector('[data-act="detail"]')?.addEventListener("click", ()=>{
      openOrderDetail(orderId);
    });

    orderList.appendChild(wrap);
  });
}

function renderCredits() {
    orderList.style.display   = "none";
    creditsList.style.display = "flex";
    emptyText.style.display   = "none";
    creditsList.innerHTML     = "";

    if (!credits.length) {
      emptyText.style.display = "block";
      return;
    }

    credits.forEach(item => {
      const el = document.createElement("div");
      el.className = "credit-item";

      const amt = Number(item.amount || 0);
      const isPositive = amt >= 0;
      const amtClass = isPositive ? "pos" : "neg";
      const sign = isPositive ? "+" : "";

      const reason = item.reason || "購物金異動";
      const bal = (item.balance !== undefined && item.balance !== null) ? Number(item.balance) : null;

      el.innerHTML = `
        <div class="c-info">
          <div class="c-reason">${reason}</div>
          <div class="c-date">${formatDate(item.created_at)}</div>
        </div>
        <div>
          <div class="c-amount ${amtClass}">${sign}NT$ ${Math.abs(amt).toLocaleString("zh-TW")}</div>
          ${bal !== null ? `<div class="c-balance">餘額: NT$ ${bal.toLocaleString("zh-TW")}</div>` : ''}
        </div>
      `;
      creditsList.appendChild(el);
    });
  }

  /* --- API 邏輯 --- */
  async function loadMemberInfo() {
    if (!currentUserId) return;
    try {
      const res = await fetch(MEMBER_INFO_API + "?user_id=" + encodeURIComponent(currentUserId));
      const json = await res.json();
      if (res.ok && json.ok) {
        memberInfo = json;
        const c = Number(memberInfo.credit || 0);
        creditValue.textContent = "NT$ " + c.toLocaleString("zh-TW");
      }
    } catch (e) { console.error(e); }
  }

  async function loadCredits() {
    if (!currentUserId) return;

    if (currentFilter === "credits") {
      infoMsg.textContent = "載入明細中...";
      infoMsg.style.display = "block";
    }

    try {
      const res = await fetch(CREDITS_API + "?line_user_id=" + encodeURIComponent(currentUserId));
      const json = await res.json();
      if (res.ok && json.ok) {
        credits = json.items || [];
        if (currentFilter === "credits") renderCredits();
      }
    } catch (e) { console.error(e); }
    
    if (currentFilter === "credits") {
      infoMsg.textContent = "";
      infoMsg.style.display = "none";
    }
  }

  async function loadOrders() {
    if (!currentUserId) return;

    if (currentFilter !== "credits") {
      infoMsg.textContent = "更新資料中...";
      infoMsg.style.display = "block";
    }

    try {
      const res = await fetch(MEMBER_API + "?line_user_id=" + encodeURIComponent(currentUserId));
      const json = await res.json();
      if (res.ok && json.ok) {
        orders = json.orders || [];
        if (currentFilter !== "credits") renderOrders();
      }
    } catch (e) { 
      infoMsg.textContent = "載入失敗"; 
      infoMsg.classList.add("error");
    }

    if (currentFilter !== "credits") {
      infoMsg.textContent = "";
      infoMsg.style.display = "none";
    }
  }

  async function initLiff() {
    if (!window.liff) return;
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) {
        liff.login(); return;
      }
      
      const profile = await liff.getProfile();
      currentUserId = profile.userId;
      userName.textContent = profile.displayName;
      
      if(profile.pictureUrl){
        defaultAvatar.style.display = "none";
        userAvatarImg.style.display = "block";
        userAvatarImg.src = profile.pictureUrl;
      }
      
      statusText.textContent = "歡迎回來";
      
      loadMemberInfo();
      loadOrders();
      loadCredits();
    } catch (e) {
      infoMsg.textContent = "請從 LINE 官方帳號開啟";
      infoMsg.style.display = "block";
    }
  }

  /* --- Init --- */
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".tab").forEach(btn => {
      btn.addEventListener("click", () => {
        currentFilter = btn.dataset.tab || "history";
        updateTabsUI();
        
        if (currentFilter === "credits") {
          if(credits.length === 0) loadCredits();
          else renderCredits();
        } else {
          renderOrders();
        }
      });
    });
    
    updateTabsUI();
    initLiff();
  });
</script>

</body>
</html>
