<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>MURAIN 會員中心</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #000000;
      --card-bg: #151515;
      --accent: #e0b15a;
      --accent-soft: #332410;
      --text: #f7f7f7;
      --muted: #999;
      --border: #333;
      --danger: #ff6b6b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system,BlinkMacSystemFont,"Noto Sans TC",system-ui,sans-serif;
      background: radial-gradient(circle at top,#222 0,#000 55%);
      color: var(--text);
      min-height: 100vh;
    }
    .page {
      max-width: 640px;
      margin: 0 auto;
      padding: 16px 16px 40px;
    }
    .brand {
      margin-top: 8px;
      margin-bottom: 16px;
    }
    .brand-title {
      font-size: 24px;
      letter-spacing: 0.18em;
      font-weight: 600;
    }
    .brand-sub {
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      font-size: 13px;
    }
    .status-left {
      color: var(--muted);
    }
    .status-right button {
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 13px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .tab {
      flex: 1;
      padding: 10px 0;
      border-radius: 999px;
      border: 1px solid var(--border);
      text-align: center;
      font-size: 14px;
      background: rgba(255,255,255,0.02);
      color: var(--muted);
    }
    .tab.active {
      background: linear-gradient(135deg,#f6d57a,#e0b15a);
      border-color: transparent;
      color: #000;
      font-weight: 600;
    }
    .msg {
      font-size: 13px;
      color: var(--muted);
      margin: 12px 0;
    }
    .msg.error {
      color: var(--danger);
    }

    .orders-empty {
      margin-top: 32px;
      text-align: center;
      font-size: 14px;
      color: var(--muted);
    }

    .order-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 4px;
    }
    .order-card {
      background: radial-gradient(circle at top left,#26211a 0,#111 65%);
      border-radius: 16px;
      padding: 12px 14px;
      border: 1px solid #27201a;
    }
    .order-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 13px;
    }
    .order-badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(255,255,255,0.18);
    }
    .badge-live {
      background: rgba(217,172,104,0.14);
      border-color: rgba(217,172,104,0.6);
      color: #f7e2b2;
    }
    .badge-web {
      background: rgba(143,197,255,0.12);
      border-color: rgba(143,197,255,0.7);
      color: #c9e5ff;
    }
    .badge-status {
      margin-left: 6px;
    }
    .badge-status.paid {
      background: rgba(110,199,135,0.12);
      border-color: rgba(110,199,135,0.7);
      color: #b6f0c6;
    }
    .badge-status.unpaid {
      background: rgba(255,153,102,0.12);
      border-color: rgba(255,153,102,0.7);
      color: #ffd2b8;
    }
    .order-line {
      font-size: 13px;
      margin-top: 2px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    .order-line span {
      white-space: nowrap;
    }
    .order-line .right {
      text-align: right;
      flex-shrink: 0;
    }
    .order-amount {
      font-size: 15px;
      font-weight: 600;
      color: var(--accent);
    }
    .order-meta {
      margin-top: 4px;
      font-size: 11px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    .order-meta div {
      white-space: nowrap;
    }

    @media (max-width: 380px) {
      .brand-title { font-size: 20px; }
      .order-line { flex-direction: column; align-items: flex-start; }
      .order-line .right { text-align: left; }
      .order-meta { flex-direction: column; align-items: flex-start; }
    }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="page">
    <div class="brand">
      <div class="brand-title">MURAIN</div>
      <div class="brand-sub">會員中心 | 查詢直播 & 官網訂單</div>
    </div>

    <div class="status-bar">
      <div class="status-left" id="statusText">登入中…</div>
      <div class="status-right">
        <button type="button" id="reloadBtn">重新整理</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="all">全部訂單</button>
      <button class="tab" data-tab="live">直播訂單</button>
      <button class="tab" data-tab="web">官網訂單</button>
    </div>

    <div class="msg" id="infoMsg">載入中…</div>

    <div class="order-list" id="orderList"></div>
    <div class="orders-empty" id="emptyText" style="display:none;">
      這個分類目前沒有訂單。
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  const API_BASE   = "https://api.murain.tw";
  const MEMBER_API = API_BASE + "/member/orders";
  const LIFF_ID    = "2008430261-EGZPg3Qp";   // ★ 新增這行

  let currentUserId = null;
  let orders = [];
  let currentTab = "all";

  const statusText = document.getElementById("statusText");
  const infoMsg    = document.getElementById("infoMsg");
  const orderList  = document.getElementById("orderList");
  const emptyText  = document.getElementById("emptyText");

  document.getElementById("reloadBtn").addEventListener("click", () => {
    if (currentUserId) {
      loadOrders();
    } else {
      initLiff();
    }
  });

  document.querySelectorAll(".tab").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentTab = btn.dataset.tab;
      renderOrders();
    });
  });

  function formatDate(s) {
    if (!s) return "";
    const d = new Date(s);
    if (isNaN(d.getTime())) return s;
    const y  = d.getFullYear();
    const m  = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${y}/${m}/${dd} ${hh}:${mm}`;
  }

  function displayStatus(st) {
    switch (st) {
      case "submitted": return "已送出（未付款）";
      case "paid":      return "已付款（待出貨）";
      case "shipped":   return "已出貨";
      case "cancelled": return "已取消";
      default:          return st || "";
    }
  }

  function displayPayStatus(ps) {
    switch (ps) {
      case "unpaid":     return "未收款";
      case "pending":    return "待確認";
      case "paid_ok":    return "已收款";
      case "deposit_ok": return "已收到訂金";
      case "failed":     return "失敗 / 作廢";
      default:           return ps || "";
    }
  }

  function displayShipMethod(m) {
    if (!m) return "";
    const t = String(m).toLowerCase();
    if (t.includes("711") || t.includes("7-11")) return "7-11 超商";
    if (t.includes("post") || t.includes("宅配")) return "郵寄 / 宅配";
    return m;
  }

  function renderOrders() {
    orderList.innerHTML = "";
    emptyText.style.display = "none";

    let list = orders.slice();
    if (currentTab === "live") {
      list = list.filter(o => (o.customer_type || "").toLowerCase() === "live");
    } else if (currentTab === "web") {
      list = list.filter(o => (o.customer_type || "").toLowerCase() === "web");
    }

    if (!list.length) {
      emptyText.style.display = "block";
      return;
    }

    for (const o of list) {
      const ct   = (o.customer_type || "").toLowerCase();
      const paid = o.pay_status === "paid_ok";

      const wrap = document.createElement("div");
      wrap.className = "order-card";

      const head = document.createElement("div");
      head.className = "order-head";

      const left = document.createElement("div");
      const badge = document.createElement("span");
      badge.className = "order-badge " + (ct === "live" ? "badge-live" : "badge-web");
      badge.textContent = ct === "live" ? "直播訂單" : "官網訂單";

      const badge2 = document.createElement("span");
      badge2.className = "order-badge badge-status " + (paid ? "paid" : "unpaid");
      badge2.textContent = displayPayStatus(o.pay_status);

      left.appendChild(badge);
      left.appendChild(badge2);

      const right = document.createElement("div");
      right.style.fontSize = "12px";
      right.textContent = o.order_id || "";

      head.appendChild(left);
      head.appendChild(right);
      wrap.appendChild(head);

      const line1 = document.createElement("div");
      line1.className = "order-line";
      const l1Left = document.createElement("span");
      l1Left.textContent = displayStatus(o.status);
      const l1Right = document.createElement("span");
      l1Right.className = "right order-amount";
      l1Right.textContent = "NT$ " + (o.total_amount || 0);
      line1.appendChild(l1Left);
      line1.appendChild(l1Right);
      wrap.appendChild(line1);

      const line2 = document.createElement("div");
      line2.className = "order-line";
      const shipMethod = displayShipMethod(o.ship && (o.ship.method || ""));
      const l2Left = document.createElement("span");
      l2Left.textContent = shipMethod ? ("寄送方式：" + shipMethod) : "";
      const l2Right = document.createElement("span");
      l2Right.className = "right";
      l2Right.textContent = formatDate(o.created_at);
      line2.appendChild(l2Left);
      line2.appendChild(l2Right);
      wrap.appendChild(line2);

      const meta = document.createElement("div");
      meta.className = "order-meta";
      const m1 = document.createElement("div");
      m1.textContent = o.ship && o.ship.name ? ("收件人：" + o.ship.name) : "";
      const m2 = document.createElement("div");
      if (o.streamer_name) {
        m2.textContent = "直播主：" + o.streamer_name;
      }
      meta.appendChild(m1);
      meta.appendChild(m2);
      wrap.appendChild(meta);

      orderList.appendChild(wrap);
    }
  }

  async function loadOrders() {
    if (!currentUserId) return;
    infoMsg.classList.remove("error");
    infoMsg.textContent = "載入中…";

    try {
      const url = MEMBER_API + "?line_user_id=" + encodeURIComponent(currentUserId);
      const res = await fetch(url, { credentials: "omit" });
      const json = await res.json();
      if (!res.ok || !json.ok) {
        throw new Error(json && json.error || "load_failed");
      }
      orders = json.orders || [];
      infoMsg.textContent = "";
      renderOrders();
    } catch (e) {
      console.error(e);
      infoMsg.classList.add("error");
      infoMsg.textContent = "載入失敗，請稍後再試。";
      orderList.innerHTML = "";
      emptyText.style.display = "none";
    }
  }

    async function initLiff() {
    if (!window.liff) {
      statusText.textContent = "找不到 LIFF SDK，請稍後再試。";
      return;
    }

    try {
      // 只允許從 LINE 官方帳號裡面打開
      if (!liff.isInClient()) {
        statusText.textContent = "請從 LINE 官方帳號打開會員中心。";
        infoMsg.textContent = "";
        return;
      }

      // 在 LIFF 內：用會員中心這顆 LIFF ID
      await liff.init({ liffId: LIFF_ID });

      // 用 ID Token 拿 userId，不需要 profile 權限
      const idToken = liff.getDecodedIDToken();
      if (!idToken || !idToken.sub) {
        throw new Error("no_user_id");
      }
      currentUserId = idToken.sub;

      // 盡量拿一下暱稱，有錯就忽略，不要影響訂單載入
      let name = "";
      try {
        const profile = await liff.getProfile();
        name = profile.displayName || "";
      } catch (e2) {
        console.log("getProfile failed (ignored)", e2);
      }

      statusText.textContent = name ? (name + " 您好") : "已登入";

      // 開始載入訂單
      loadOrders();
    } catch (e) {
      console.error(e);
      statusText.textContent = "登入失敗，請稍後再試。";
      infoMsg.classList.add("error");
      infoMsg.textContent = "載入失敗，請稍後再試。";
    }
  }


  document.addEventListener("DOMContentLoaded", () => {
    initLiff();
  });
</script>

</body>
</html>
