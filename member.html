<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>MURAIN | æœƒå“¡ä¸­å¿ƒ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  
  <!-- å¼•å…¥èˆ‡å®˜ç¶²ä¸€è‡´çš„é«˜ç´šå­—é«” -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

  <style>
    /* --- æ ¸å¿ƒè®Šæ•¸ (èˆ‡å®˜ç¶²çµ±ä¸€) --- */
    :root {
      --bg-color: #0a0a0a;
      --card-bg: #141414;
      --text-main: #f0f0f0;
      --text-muted: #888888;
      --gold-primary: #D4AF37; 
      --gold-light: #F3E5AB;
      --border-color: rgba(255, 255, 255, 0.1);
      --success: #4ade80;
      --danger: #ef4444;
      --font-serif: 'Playfair Display', serif;
      --font-sans: 'Lato', sans-serif;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      /* èƒŒæ™¯åœ–ç´‹ç† */
      background-image: 
        radial-gradient(circle at 50% 0%, #222 0%, transparent 70%),
        linear-gradient(to bottom, #0a0a0a, #000);
    }

    .page {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px 16px 60px;
    }

    /* --- é ‚éƒ¨ Header --- */
    .header-area {
      text-align: center;
      margin-bottom: 24px;
      position: relative;
    }
    
    .brand-title {
      font-family: var(--font-serif);
      font-size: 24px;
      letter-spacing: 0.1em;
      color: var(--gold-light);
      margin-bottom: 4px;
    }
    
    .page-title {
      font-size: 12px;
      letter-spacing: 0.2em;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    /* é‡æ–°æ•´ç†æŒ‰éˆ• (å³ä¸Šè§’) */
    .refresh-btn {
      position: absolute;
      top: 0; right: 0;
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-muted);
      width: 32px; height: 32px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .refresh-btn:active {
      border-color: var(--gold-primary);
      color: var(--gold-primary);
    }

    /* --- æ•¸ä½æœƒå“¡å¡ (Credit Bar å‡ç´š) --- */
    .member-card {
      background: linear-gradient(135deg, #1f1f1f, #0f0f0f);
      border: 1px solid rgba(212, 175, 55, 0.3);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    
    /* é‡‘è‰²å…‰æ¾¤è£é£¾ */
    .member-card::before {
      content: ''; position: absolute;
      top: -50%; right: -50%;
      width: 200px; height: 200px;
      background: radial-gradient(circle, rgba(212,175,55,0.15), transparent 70%);
      filter: blur(20px);
    }

    .user-info {
      display: flex; align-items: center; gap: 12px;
      margin-bottom: 20px;
      position: relative; z-index: 2;
    }
    .user-avatar {
      width: 40px; height: 40px;
      background: #333; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: var(--gold-primary); font-size: 18px;
      border: 1px solid var(--border-color);
    }
    .user-name { font-size: 14px; font-weight: 600; color: #fff; }
    .user-status { font-size: 11px; color: var(--gold-primary); letter-spacing: 0.05em; }

    .credit-row {
      display: flex; justify-content: space-between; align-items: flex-end;
      position: relative; z-index: 2;
    }
    .credit-label { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 4px; }
    .credit-amount {
      font-family: var(--font-serif);
      font-size: 28px;
      background: linear-gradient(135deg, #fff, #ccc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 500;
    }
    
    /* --- é ç±¤ Tabs --- */
    .tabs {
      display: flex;
      background: rgba(255,255,255,0.03);
      padding: 4px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }
    .tab {
      flex: 1;
      padding: 10px 0;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 13px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: var(--font-sans);
    }
    .tab.active {
      background: var(--card-bg);
      color: var(--gold-primary);
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      font-weight: 700;
    }

    /* --- åˆ—è¡¨å®¹å™¨ --- */
    .msg { font-size: 13px; color: var(--text-muted); text-align: center; margin: 20px 0; }
    .msg.error { color: var(--danger); }
    
    .empty-state {
      padding: 40px 0; text-align: center; color: #666; font-size: 13px;
      border: 1px dashed var(--border-color); border-radius: 12px;
    }

    /* --- è¨‚å–®å¡ç‰‡ (Order Card) --- */
    .order-list { display: flex; flex-direction: column; gap: 16px; }
    
    .order-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid var(--border-color);
      position: relative;
      transition: transform 0.2s;
    }
    .order-card.highlight {
      border-color: var(--gold-primary);
      box-shadow: 0 0 0 1px rgba(212,175,55,0.3);
    }

    .card-header {
      display: flex; justify-content: space-between; align-items: flex-start;
      margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);
      padding-bottom: 12px;
    }
    .order-id { font-family: monospace; font-size: 12px; color: #666; letter-spacing: 0.05em; }
    .order-date { font-size: 11px; color: #555; margin-top: 2px; }
    
    .status-badge {
      font-size: 11px; padding: 4px 10px; border-radius: 99em;
      font-weight: 600; letter-spacing: 0.05em;
    }
    /* ç‹€æ…‹é¡è‰² */
    .st-paid { background: rgba(74, 222, 128, 0.1); color: #4ade80; border: 1px solid rgba(74, 222, 128, 0.2); }
    .st-unpaid { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); }
    .st-pending { background: rgba(255, 255, 255, 0.1); color: #aaa; border: 1px solid rgba(255, 255, 255, 0.1); }

    .card-body { display: flex; justify-content: space-between; align-items: flex-end; }
    
    .info-group { display: flex; flex-direction: column; gap: 4px; font-size: 13px; color: #ccc; }
    .info-label { font-size: 11px; color: #666; margin-right: 4px; }
    
    .amount-display { text-align: right; }
    .amount-label { font-size: 10px; color: #666; text-transform: uppercase; margin-bottom: 2px; }
    .amount-val { font-family: var(--font-serif); font-size: 18px; color: var(--gold-light); }

    /* --- ç´…åˆ©æ˜ç´°åˆ—è¡¨ (Credits) --- */
    .credits-list { display: flex; flex-direction: column; gap: 12px; }
    .credit-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .c-info { display: flex; flex-direction: column; gap: 4px; }
    .c-reason { font-size: 14px; color: #eee; }
    .c-date { font-size: 11px; color: #666; font-family: monospace; }
    
    .c-amount { font-family: var(--font-serif); font-size: 16px; font-weight: 600; }
    .c-amount.pos { color: var(--success); }
    .c-amount.neg { color: var(--danger); }

  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

  <div class="page">
    
    <!-- é ‚éƒ¨ Header -->
    <div class="header-area">
      <div class="brand-title">MURAIN</div>
      <div class="page-title">MEMBER CENTER</div>
      <button class="refresh-btn" id="reloadBtn" title="é‡æ–°æ•´ç†">â†»</button>
    </div>

    <!-- æ•¸ä½æœƒå“¡å¡ -->
    <div class="member-card">
      <div class="user-info">
        <div class="user-avatar">ğŸ‘¤</div>
        <div>
          <div class="user-name" id="userName">Guest</div>
          <div class="user-status" id="statusText">æ­£åœ¨é€£æ¥...</div>
        </div>
      </div>
      <div class="credit-row">
        <div>
          <div class="credit-label">Available Credits</div>
          <div class="credit-label">å¯ç”¨è³¼ç‰©é‡‘</div>
        </div>
        <div class="credit-amount" id="creditValue">NT$ --</div>
      </div>
    </div>

    <!-- å°èˆªé ç±¤ -->
    <div class="tabs">
      <button class="tab active" data-tab="all">å…¨éƒ¨è¨‚å–®</button>
      <button class="tab" data-tab="live">ç›´æ’­è¨‚å–®</button>
      <button class="tab" data-tab="web">å®˜ç¶²è¨‚å–®</button>
      <button class="tab" data-tab="credits">é»æ•¸æ˜ç´°</button>
    </div>

    <!-- è¨Šæ¯æç¤º -->
    <div class="msg" id="infoMsg">è¼‰å…¥ä¸­â€¦</div>

    <!-- å…§å®¹å€åŸŸï¼šè¨‚å–®åˆ—è¡¨ -->
    <div class="order-list" id="orderList"></div>
    
    <!-- å…§å®¹å€åŸŸï¼šç´…åˆ©åˆ—è¡¨ -->
    <div class="credits-list" id="creditsList" style="display:none;"></div>

    <!-- ç©ºç‹€æ…‹ -->
    <div class="empty-state" id="emptyText" style="display:none;">
      å°šç„¡è³‡æ–™ / No Records
    </div>

  </div>

<script>
  /* --- æ‚¨çš„æ ¸å¿ƒé‚è¼¯ä¿æŒä¸è®Š --- */
  const API_BASE    = "https://api.murain.tw";
  const MEMBER_API  = API_BASE + "/member/orders";
  const CREDITS_API = API_BASE + "/member/credits";
  const MEMBER_INFO_API = API_BASE + "/line/member-info";
  const LIFF_ID     = "2008430261-EGZPg3Qp";

  let currentUserId = null;
  let orders = [];
  let memberInfo = null;
  let credits = [];
  let currentFilter = "all";

  const urlParams = new URLSearchParams(window.location.search || "");
  const initialOrderId = urlParams.get("order_id") || "";
  let hasScrolledToInitialOrder = false;

  // DOM Elements
  const statusText  = document.getElementById("statusText");
  const userName    = document.getElementById("userName"); // æ–°å¢
  const infoMsg     = document.getElementById("infoMsg");
  const orderList   = document.getElementById("orderList");
  const creditsList = document.getElementById("creditsList");
  const emptyText   = document.getElementById("emptyText");
  const creditValue = document.getElementById("creditValue");

  document.getElementById("reloadBtn").addEventListener("click", () => {
    if (currentUserId) {
      statusText.textContent = "é‡æ–°æ•´ç†ä¸­...";
      loadMemberInfo();
      loadOrders();
    } else {
      initLiff();
    }
  });

  /* --- å·¥å…·å‡½å¼ --- */
  function formatDate(s) {
    if (!s) return "";
    const d = new Date(s);
    if (isNaN(d.getTime())) return s;
    return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }

  function displayStatus(st) {
    switch (st) {
      case "submitted": return "å·²é€å‡º";
      case "paid":      return "å·²ä»˜æ¬¾";
      case "shipped":   return "å·²å‡ºè²¨";
      case "cancelled": return "å·²å–æ¶ˆ";
      default:          return st || "è™•ç†ä¸­";
    }
  }

  function getStatusClass(payStatus) {
    // ç°¡å–®åˆ¤æ–·é¡¯ç¤ºé¡è‰²
    if(payStatus === 'paid_ok' || payStatus === 'deposit_ok') return 'st-paid';
    if(payStatus === 'failed') return 'st-unpaid';
    return 'st-pending';
  }

  function displayPayStatus(ps) {
    switch (ps) {
      case "unpaid":     return "æœªæ”¶æ¬¾";
      case "pending":    return "å¾…ç¢ºèª";
      case "paid_ok":    return "å·²æ”¶æ¬¾";
      case "deposit_ok": return "å·²æ”¶è¨‚é‡‘";
      case "failed":     return "ä»˜æ¬¾å¤±æ•—";
      default:           return ps || "æœªä»˜æ¬¾";
    }
  }

  /* --- é ç±¤åˆ‡æ› --- */
  function updateTabsUI() {
    document.querySelectorAll(".tab").forEach(btn => {
      if (btn.dataset.tab === currentFilter) btn.classList.add("active");
      else btn.classList.remove("active");
    });
  }

  /* --- æ¸²æŸ“è¨‚å–® (ä½¿ç”¨æ–°ç‰ˆå¡ç‰‡æ¨£å¼) --- */
  function renderOrders() {
    orderList.style.display   = "flex";
    creditsList.style.display = "none";
    emptyText.style.display   = "none";
    orderList.innerHTML       = "";

    let list = orders.slice();
    if (currentFilter === "live") list = list.filter(o => !!o.streamer_name);
    else if (currentFilter === "web") list = list.filter(o => !o.streamer_name);

    if (!list.length) {
      emptyText.style.display = "block";
      return;
    }

    for (const o of list) {
      const wrap = document.createElement("div");
      wrap.className = "order-card";
      if (initialOrderId && o.order_id === initialOrderId) {
        wrap.classList.add("highlight");
        if (!hasScrolledToInitialOrder) {
          hasScrolledToInitialOrder = true;
          setTimeout(() => wrap.scrollIntoView({ behavior: "smooth", block: "center" }), 150);
        }
      }

      // æ§‹å»ºå¡ç‰‡ HTML
      const statusCls = getStatusClass(o.pay_status);
      const payTxt = displayPayStatus(o.pay_status);
      const shipTxt = o.ship && o.ship.method ? o.ship.method : "å°šæœªé…é€";
      const trackNo = o.ship && o.ship.tracking_no ? o.ship.tracking_no : "";
      
      wrap.innerHTML = `
        <div class="card-header">
          <div>
            <div class="order-id">#${o.order_id}</div>
            <div class="order-date">${formatDate(o.created_at)}</div>
          </div>
          <div class="status-badge ${statusCls}">${payTxt}</div>
        </div>
        
        <div class="card-body">
          <div class="info-group">
            <div><span class="info-label">ç‹€æ…‹</span> ${displayStatus(o.status)}</div>
            <div><span class="info-label">é…é€</span> ${shipTxt} ${trackNo ? `(${trackNo})` : ''}</div>
            ${o.ship && o.ship.name ? `<div><span class="info-label">æ”¶ä»¶</span> ${o.ship.name}</div>` : ''}
          </div>
          
          <div class="amount-display">
            <div class="amount-label">Total</div>
            <div class="amount-val">NT$ ${(o.total_amount || 0).toLocaleString()}</div>
          </div>
        </div>
      `;
      
      orderList.appendChild(wrap);
    }
  }

  /* --- æ¸²æŸ“ç´…åˆ© (Credits) --- */
  function renderCredits() {
    orderList.style.display   = "none";
    creditsList.style.display = "flex";
    emptyText.style.display   = "none";
    creditsList.innerHTML     = "";

    if (!credits.length) {
      emptyText.style.display = "block";
      return;
    }

    for (const item of credits) {
      const wrap = document.createElement("div");
      wrap.className = "credit-item";
      
      const amount = Number(item.amount || 0);
      const isPos = amount > 0;
      
      wrap.innerHTML = `
        <div class="c-info">
          <div class="c-reason">${item.reason || (item.type === 'use' ? 'æŠ˜æŠµä½¿ç”¨' : 'ç²å¾—é»æ•¸')}</div>
          <div class="c-date">${formatDate(item.created_at)} ${item.order_id ? '| è¨‚å–® ' + item.order_id : ''}</div>
        </div>
        <div class="c-amount ${isPos ? 'pos' : 'neg'}">
          ${isPos ? '+' : ''}${amount.toLocaleString()}
        </div>
      `;
      creditsList.appendChild(wrap);
    }
  }

  /* --- API é‚è¼¯ --- */
  async function loadMemberInfo() {
    if (!currentUserId || !MEMBER_INFO_API) return;
    try {
      const res = await fetch(MEMBER_INFO_API + "?user_id=" + encodeURIComponent(currentUserId));
      const json = await res.json();
      if (res.ok && json.ok) {
        memberInfo = json;
        const c = (memberInfo && typeof memberInfo.credit === 'number') ? memberInfo.credit : 0;
        creditValue.textContent = "NT$ " + c.toLocaleString();
      }
    } catch (e) { console.error(e); }
  }

  async function loadCredits() {
    if (!currentUserId) return;
    infoMsg.textContent = "è¼‰å…¥æ˜ç´°ä¸­...";
    try {
      const res = await fetch(CREDITS_API + "?line_user_id=" + encodeURIComponent(currentUserId));
      const json = await res.json();
      if (res.ok && json.ok) {
        credits = json.items || [];
        if (currentFilter === "credits") renderCredits();
      }
    } catch (e) { console.error(e); }
    infoMsg.textContent = "";
  }

  async function loadOrders() {
    if (!currentUserId) return;
    infoMsg.textContent = "æ›´æ–°è³‡æ–™ä¸­...";
    try {
      const res = await fetch(MEMBER_API + "?line_user_id=" + encodeURIComponent(currentUserId));
      const json = await res.json();
      if (res.ok && json.ok) {
        orders = json.orders || [];
        if (initialOrderId) {
          const t = orders.find(o => o.order_id === initialOrderId);
          if (t) {
            currentFilter = t.streamer_name ? "live" : "web";
            updateTabsUI();
          }
        }
        if (currentFilter !== "credits") renderOrders();
      }
    } catch (e) { 
      infoMsg.textContent = "è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦"; 
      infoMsg.classList.add("error");
    }
    infoMsg.textContent = "";
  }

  async function initLiff() {
    if (!window.liff) {
      statusText.textContent = "LIFF SDK Error";
      return;
    }
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }
      
      const profile = await liff.getProfile();
      currentUserId = profile.userId;
      userName.textContent = profile.displayName;
      statusText.textContent = "å·²é€£çµ LINE å¸³è™Ÿ";
      
      loadMemberInfo();
      loadOrders();
    } catch (e) {
      console.error(e);
      statusText.textContent = "é€£çµå¤±æ•—";
      infoMsg.textContent = "è«‹ç¢ºèªç¶²è·¯é€£ç·šæˆ–å¾ LINE å®˜æ–¹å¸³è™Ÿé–‹å•Ÿ";
    }
  }

  /* --- Init --- */
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".tab").forEach(btn => {
      btn.addEventListener("click", () => {
        currentFilter = btn.dataset.tab || "all";
        updateTabsUI();
        if (currentFilter === "credits") {
          renderCredits();
          loadCredits();
        } else {
          renderOrders();
        }
      });
    });
    
    updateTabsUI();
    initLiff();
  });
</script>

</body>
</html>
