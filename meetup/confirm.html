<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>面交預約確認</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .text-gold-custom { color: #9e8a6b; }
        .bg-gold-custom { background-color: #9e8a6b; }
        .bg-gold-custom:hover { background-color: #8c7a5e; }
        .border-gold-custom { border-color: #9e8a6b; }
        /* 讓輸入框被選取時有金色光暈 */
        .focus-ring-gold:focus {
            --tw-ring-color: #9e8a6b;
            border-color: #9e8a6b;
            outline: none;
            box-shadow: 0 0 0 2px rgba(158, 138, 107, 0.2);
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white rounded-[20px] shadow-lg border border-gray-100 p-8 w-full max-w-[400px]">
        
        <!-- 標題 -->
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-gray-900 tracking-wide mb-4">面交預約確認</h1>
            <div class="h-px bg-gray-200 w-full"></div>
        </div>

        <!-- 歡迎語 -->
        <div class="text-center mb-6">
            <p class="text-gray-600 mb-2 text-[15px]">親愛的 <span id="customerName" class="font-bold text-gray-800">貴賓</span> 您好：</p>
            <p class="text-gray-600 leading-relaxed text-[15px]">
                您的商品已準備就緒，請選擇您預計取貨的日期與時間，並傳送至官方 LINE 確認。
            </p>
        </div>

        <!-- 面交資訊表單 -->
        <div class="bg-gray-50 rounded-xl p-5 mb-6 border border-gray-100 text-left space-y-4">
            
            <!-- 地點 -->
            <div class="flex items-start">
                <i data-lucide="map-pin" class="w-5 h-5 text-gold-custom mt-0.5 flex-shrink-0 mr-3"></i>
                <div>
                    <p class="text-xs text-gray-500 font-medium mb-1">面交地點</p>
                    <a id="meetPlaceLink" href="https://maps.google.com/?q=%E5%8F%B0%E5%8D%97%E5%B8%82%E4%BD%B3%E9%87%8C%E5%8D%80%E7%BE%A9%E6%B0%91%E8%A1%97339%E8%99%9F%E4%B8%80%E6%A8%93" target="_blank" class="text-gray-800 text-[15px] font-medium hover:text-gold-custom transition-colors underline decoration-gray-300 underline-offset-4"><span id="meetPlaceText">台南市佳里區義民街339號一樓
                    </span></a>
                </div>
            </div>

            <div class="h-px bg-gray-200 w-full"></div>

            <!-- 日期選擇 (新增) -->
            <div class="flex items-start">
                <i data-lucide="calendar" class="w-5 h-5 text-gold-custom mt-2.5 flex-shrink-0 mr-3"></i>
                <div class="w-full">
                    <p class="text-xs text-gray-500 font-medium mb-1">選擇面交日期</p>
                    <input type="date" id="dateSelect" class="block w-full px-3 py-2 text-base border-gray-300 focus-ring-gold rounded-md sm:text-sm bg-white border cursor-pointer h-10 text-gray-700">
                </div>
            </div>

            <!-- 時間選擇 -->
            <div class="flex items-start">
                <i data-lucide="clock" class="w-5 h-5 text-gold-custom mt-2.5 flex-shrink-0 mr-3"></i>
                <div class="w-full">
                    <p class="text-xs text-gray-500 font-medium mb-1">預計抵達時間 (9:00-16:00)</p>
                    <div class="relative">
                        <select id="timeSelect" class="block w-full px-3 py-2 text-base border-gray-300 focus-ring-gold rounded-md sm:text-sm bg-white border cursor-pointer h-10 text-gray-700">
                            <option value="" disabled selected>請選擇時間...</option>
                            <!-- JS 自動產生選項 -->
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- 訂單資訊 -->
        <div class="space-y-4 mb-8 px-2">
            <div class="flex justify-between items-center border-b border-gray-100 pb-2">
                <span class="text-gold-custom text-sm font-medium tracking-wide">訂單編號</span>
                <span id="orderNo" class="text-gray-800 font-medium tracking-wide">-</span>
            </div>
            
            <div class="flex justify-between items-center border-b border-gray-100 pb-2">
                <span class="text-gold-custom text-sm font-medium tracking-wide">付款方式</span>
                <span id="paymentBadge" class="bg-orange-100 text-orange-700 px-2.5 py-1 rounded-md text-xs font-bold tracking-wide">-</span>
            </div>

            <div class="flex justify-between items-center pt-1">
                <span class="text-gold-custom text-sm font-medium tracking-wide">訂單金額</span>
                <span class="text-gray-900 font-bold text-lg tracking-wide">NT$ <span id="totalAmount">-</span></span>
            </div>
        </div>

        <!-- 按鈕 -->
        <button onclick="sendToLine()" class="w-full bg-[#06C755] hover:bg-[#05b54d] text-white py-3.5 rounded-lg font-medium text-lg tracking-wide transition-colors duration-200 shadow-sm flex items-center justify-center gap-2">
            <!-- 使用 LINE 的 LOGO 顏色 -->
            <i data-lucide="message-circle" class="w-5 h-5 fill-current"></i>
            傳送至官方 LINE 預約
        </button>

    </div>

    <script>
        lucide.createIcons();
        const API = "https://api.murain.tw";
        // 0. 讀取 URL 參數（oid）
        const qs = new URLSearchParams(location.search);
        const oid = qs.get('oid') || qs.get('order_id') || '';
        if (oid) {
            document.getElementById('orderNo').innerText = oid;
        }

        // 0-1. 盡量把頁面資訊自動帶入（不影響流程，失敗就略過）
        // 需要後端提供 GET /order/info?order_id=ODxxxx
        (async () => {
            if (!oid) return;
            try {
                const resp = await fetch(`${API}/order/info?order_id=${encodeURIComponent(oid)}`, { method: 'GET' });
                const data = await resp.json();
                if (!data || !data.ok) return;

                // 客人姓名
                if (data.customerName) {
                    const el = document.getElementById('customerName');
                    if (el) el.innerText = String(data.customerName);
                }

                if (data.amount !== undefined && data.amount !== null) {
  const n = Number(data.amount) || 0;
  const el = document.getElementById('totalAmount');
  if (el) el.innerText = n.toLocaleString('zh-TW');
}

                // 付款方式 Badge
                if (data.payMethodLabel) {
                    const el = document.getElementById('paymentBadge');
                    if (el) el.innerText = String(data.payMethodLabel);
                }

                // 面交地點
                if (data.meetPlace) {
                    const t = document.getElementById('meetPlaceText');
                    if (t) t.innerText = String(data.meetPlace);

                    const a = document.getElementById('meetPlaceLink');
                    if (a) a.href = `https://maps.google.com/?q=${encodeURIComponent(String(data.meetPlace))}`;
                }
            } catch (e) {
                console.log("order/info fetch failed", e);
            }
        })();


        // 1. 初始化日期選擇器 (設定最小值為今天，避免選到過去)
        const dateInput = document.getElementById('dateSelect');
        const today = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD（本地時區）
        dateInput.min = today;

        // 2. 初始化時間選擇器
        // 2. 初始化時間選擇器
const select = document.getElementById('timeSelect');
const startHour = 9;
const endHour = 16;

for (let hour = startHour; hour <= endHour; hour++) {
  const hourStr = hour.toString().padStart(2, '0');
  const option1 = document.createElement('option');
  option1.value = `${hourStr}:00`;
  option1.text = `${hourStr}:00`;
  select.appendChild(option1);

  if (hour < endHour) {
    const option2 = document.createElement('option');
    option2.value = `${hourStr}:30`;
    option2.text = `${hourStr}:30`;
    select.appendChild(option2);
  }
}

// ✅ 預設選今天 + 下一個半小時（要放在「選項產生完」之後）
if (!dateInput.value) dateInput.value = today;

(function presetTime() {
  const now = new Date();
  let h = now.getHours();
  let m = now.getMinutes();

  m = m < 30 ? 30 : 0;
  if (m === 0) h += 1;

  if (h < 9) { h = 9; m = 0; }
  if (h > 16 || (h === 16 && m > 0)) { h = 16; m = 0; }

  const hh = String(h).padStart(2,'0');
  const mm = String(m).padStart(2,'0');
  const val = `${hh}:${mm}`;

  if ([...select.options].some(o => o.value === val)) {
    select.value = val;
  } else {
    const first = [...select.options].find(o => o.value);
    if (first) select.value = first.value;
  }
})();
        // 3. 發送 LINE 功能
        function sendToLine() {
  const YOUR_LINE_ID = "@cc0857";

  const date = dateInput.value;
  const time = select.value;
  const orderNo = document.getElementById('orderNo').innerText;

  if (!date || !time) {
    alert('請先選擇完整的「日期」與「時間」喔！');
    return;
  }

  const meetPlace = (document.getElementById('meetPlaceText')?.innerText || '').trim();
  const message =
    `你好，訂單：${orderNo}\n` +
    `我確認於【${date} ${time}】前往面交` +
    `${meetPlace ? `（地點：${meetPlace}）` : ''}，謝謝！`;

  const encodedMessage = encodeURIComponent(message);

  // ✅ 組 LINE URL（oaMessage 需要把 @ encode）
  let url = "";
  if (YOUR_LINE_ID) {
    const oa = encodeURIComponent(
      YOUR_LINE_ID.startsWith('@') ? YOUR_LINE_ID : ('@' + YOUR_LINE_ID)
    );
    url = `https://line.me/R/oaMessage/${oa}/?${encodedMessage}`;
  } else {
    url = `https://line.me/R/msg/text/?${encodedMessage}`;
  }

  // ✅ LINE 內建瀏覽器常擋 window.open，用 location.href
  location.href = url;
}
    </script>
</body>
</html>
